<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel ‚Äî NutriPlant Pro</title>
  
  <!-- ===== NUTRIPLANT PRO BRANDING ===== -->
  <meta name="description" content="Panel de control para nutrici√≥n vegetal y fertirriego - NutriPlant Pro" />
  <meta name="author" content="NutriPlant Pro" />
  <meta name="theme-color" content="#2563eb" />
  
  <!-- Favicon (hoja azul: pesta√±a, b√∫squeda y marcadores) -->
  <link rel="icon" type="image/png" href="assets/N_Hoja_Azul.png">
  <link rel="apple-touch-icon" href="assets/N_Hoja_Azul.png">
  
    <link rel="stylesheet" href="dashboard.css?v=1758328000" />
  <link rel="stylesheet" href="chat.css" />
  <script src="app-config.js"></script>
  <script src="config-no-traducir-terminos.js"></script>
  <!-- Google Analytics 4: se activa si en app-config.js pones googleAnalyticsMeasurementId (ej. G-XXXXXXXXXX) -->
  <script>
    (function(){
      var id = (window.NUTRIPLANT_APP && window.NUTRIPLANT_APP.googleAnalyticsMeasurementId) || '';
      if (!id) return;
      window.dataLayer = window.dataLayer || [];
      function gtag(){ dataLayer.push(arguments); }
      window.gtag = gtag;
      gtag('js', new Date());
      gtag('config', id, { page_title: 'Dashboard', page_location: window.location.href });
      var s = document.createElement('script');
      s.async = true;
      s.src = 'https://www.googletagmanager.com/gtag/js?id=' + id;
      document.head.appendChild(s);
    })();
  </script>
</head>
<body>
  <script>
    window.showChangePasswordModal = function() {
      var userInfoModal = document.getElementById('userInfoModal');
      if (userInfoModal && typeof window.closeUserInfoModal === 'function') window.closeUserInfoModal();
      var modal = document.getElementById('changePasswordModal');
      if (modal) {
        var cur = document.getElementById('changePasswordCurrent');
        var newP = document.getElementById('changePasswordNew');
        var conf = document.getElementById('changePasswordConfirm');
        if (cur) cur.value = '';
        if (newP) newP.value = '';
        if (conf) conf.value = '';
        var msgEl = document.getElementById('changePasswordMessage');
        if (msgEl) { msgEl.style.display = 'none'; msgEl.textContent = ''; }
        modal.classList.add('show');
        modal.style.display = 'flex';
      }
    };
    document.addEventListener('click', function(e) {
      var t = e.target;
      if (!t || !t.getAttribute) return;
      var btn = t.getAttribute('data-open-change-password') !== null ? t : (t.closest ? t.closest('[data-open-change-password]') : null);
      if (btn) {
        e.preventDefault();
        e.stopPropagation();
        var um = document.getElementById('userInfoModal');
        if (um) { um.style.display = 'none'; um.classList.remove('show'); }
        setTimeout(function() {
          var cm = document.getElementById('changePasswordModal');
          if (cm) {
            var cur = document.getElementById('changePasswordCurrent');
            var newP = document.getElementById('changePasswordNew');
            var conf = document.getElementById('changePasswordConfirm');
            if (cur) cur.value = '';
            if (newP) newP.value = '';
            if (conf) conf.value = '';
            var msgEl = document.getElementById('changePasswordMessage');
            if (msgEl) { msgEl.style.display = 'none'; msgEl.textContent = ''; }
            cm.classList.add('show');
            cm.style.display = 'flex';
            cm.style.visibility = 'visible';
            cm.style.zIndex = '10050';
          }
        }, 80);
      }
    }, true);
  </script>
  <!-- Header fijo superior (marca) -->
  <header class="site-header">
    <div class="brandline">
      <img src="assets/NutriPlant_PRO_blue.png" alt="NutriPlant Pro" class="brand-logo">
      <div class="social-links">
        <button class="social-btn" onclick="window.showAboutUsModal()" title="Sobre Nosotros" type="button" style="
          display: inline-flex;
          align-items: center;
          gap: 8px;
          padding: 6px 12px;
          border-radius: 999px;
          background: #f8fafc;
          border: 1px solid #e2e8f0;
          color: #1f2937;
          font-weight: 600;
          font-size: 13px;
          box-shadow: 0 2px 6px rgba(15, 23, 42, 0.08);
          transition: all 0.2s ease;
        " onmouseover="this.style.background='#eef2ff'; this.style.borderColor='#c7d2fe'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='#f8fafc'; this.style.borderColor='#e2e8f0'; this.style.transform='none'">
          <span style="width: 24px; height: 24px; border-radius: 8px; background: #e0f2fe; display:inline-flex; align-items:center; justify-content:center; font-size: 14px;">üë•</span>
          Nosotros
        </button>
        <a href="https://www.facebook.com/share/16tGD4XMM9/" target="_blank" class="social-btn" data-social="facebook" title="Facebook">
          <svg class="social-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/>
          </svg>
        </a>
        <a href="https://www.instagram.com/nutriplantpro?utm_source=qr&igsh=MWx3dTZeamw1dD12gw==" target="_blank" class="social-btn" data-social="instagram" title="Instagram">
          <svg class="social-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="2" y="2" width="20" height="20" rx="5" ry="5"/>
            <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/>
            <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"/>
          </svg>
        </a>
        <a href="https://www.tiktok.com/@nutriplantpro?_t=Z8-8zhq7GhZnmvY&_r=1" target="_blank" class="social-btn" data-social="tiktok" title="TikTok">
          <svg class="social-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 12a4 4 0 1 0 4 4V4a5 5 0 0 0 5 5"/>
          </svg>
        </a>
        <a href="https://youtube.com/@nutriplantpro?si=3W90eDXRAgyZxd" target="_blank" class="social-btn" data-social="youtube" title="YouTube">
          <svg class="social-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-1.94C18.88 4 12 4 12 4s-6.88 0-8.6.48a2.78 2.78 0 0 0-1.94 1.94A29 29 0 0 0 1 11.75a29 29 0 0 0 .48 5.33A2.78 2.78 0 0 0 3.4 19c1.72.48 8.6.48 8.6.48s6.88 0 8.6-.48a2.78 2.78 0 0 0 1.94-1.94 29 29 0 0 0 .48-5.33 29 29 0 0 0-.48-5.33z"/>
            <polygon points="9.75,15.02 15.5,11.75 9.75,8.48"/>
          </svg>
        </a>
        <a href="https://www.linkedin.com/company/nutriplant-pro/" target="_blank" class="social-btn" data-social="linkedin" title="LinkedIn">
          <svg class="social-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"/>
            <rect x="2" y="9" width="4" height="12"/>
            <circle cx="4" cy="4" r="2"/>
          </svg>
        </a>
      </div>
    </div>
  </header>

  <div class="layout">
    <!-- Sidebar -->
    <!-- Overlay para m√≥vil (se muestra cuando sidebar est√° abierto) -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    
    <!-- Bot√≥n de toggle para m√≥vil -->
    <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Abrir men√∫">
      <span class="hamburger">
        <span></span>
        <span></span>
        <span></span>
      </span>
    </button>

    <aside class="sidebar" id="sidebar">
      <!-- Logo de NutriPlant Pro en sidebar -->
      <div class="sidebar-brand">
        <img src="assets/N_Hoja_Blanca.png" alt="NutriPlant Pro" class="sidebar-logo">
        <!-- Bot√≥n de cerrar para m√≥vil -->
        <button class="sidebar-close" id="sidebar-close" aria-label="Cerrar men√∫">
          <span>√ó</span>
        </button>
      </div>

      <!-- Men√∫ superior -->
      <nav id="menu"></nav>

      <!-- Contenedor apilado para las TARJETAS (proyecto + an√°lisis) -->
      <div id="sbStack" class="sb-stack"><!-- se llena por JS --></div>

      <!-- Cerrar sesi√≥n pegado abajo (icono SVG para que se vea igual en Mac, iPhone y Android) -->
      <button id="logoutBtn" class="logout" title="Cerrar sesi√≥n">
        <span class="logout-icon" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" width="18" height="18"><path d="M12 2v10M12 22a8 8 0 1 0 0-16 8 8 0 0 0 0 16z"/></svg></span>
        <span class="logout-text">Cerrar sesi√≥n</span>
      </button>
    </aside>

    <!-- Contenido principal -->
    <main class="content">
      <header class="top">
        <h1 id="sectionTitle">Inicio</h1>
        <div class="header-buttons">
        <button id="btn-new-nutriplant" class="btn btn-pill btn-primary" onclick="window.showNewProjectModal()">+ Nuevo NutriPlant</button>
          <button id="btn-conversion-calculator" class="btn btn-pill btn-calculator" onclick="window.showConversionCalculator()" title="Calculadora √ìxido ‚Üî Elemental">
            <span class="btn-calc-icon" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2"/><rect x="6" y="4" width="12" height="5" rx="1"/><line x1="8" y1="12" x2="10" y2="12"/><line x1="14" y1="12" x2="16" y2="12"/><line x1="8" y1="16" x2="10" y2="16"/><line x1="14" y1="16" x2="16" y2="16"/></svg></span> √ìxido ‚Üî Elem.
          </button>
          <button id="btn-nutrient-units-calculator" class="btn btn-pill btn-calculator" onclick="window.showNutrientUnitsCalculator()" title="Calculadora ppm ‚Üî mmol/L ‚Üî meq/L">
            <span class="btn-calc-icon" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2"/><rect x="6" y="4" width="12" height="5" rx="1"/><line x1="8" y1="12" x2="10" y2="12"/><line x1="14" y1="12" x2="16" y2="12"/><line x1="8" y1="16" x2="10" y2="16"/><line x1="14" y1="16" x2="16" y2="16"/></svg></span> ppm ‚Üî meq
          </button>
          <button id="btn-measure-units-calculator" class="btn btn-pill btn-calculator" onclick="window.showMeasureUnitsCalculator()" title="Unidades: longitud, √°rea, volumen, peso, temperatura, presi√≥n">
            <span class="btn-calc-icon" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2"/><rect x="6" y="4" width="12" height="5" rx="1"/><line x1="8" y1="12" x2="10" y2="12"/><line x1="14" y1="12" x2="16" y2="12"/><line x1="8" y1="16" x2="10" y2="16"/><line x1="14" y1="16" x2="16" y2="16"/></svg></span> Unidades
          </button>
          <button id="btn-user-info" class="btn btn-pill btn-user" onclick="window.showUserInfoModal()" title="Informaci√≥n de Usuario">
            <svg style="width: 18px; height: 18px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="3" y1="12" x2="21" y2="12"></line>
              <line x1="3" y1="6" x2="21" y2="6"></line>
              <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
          </button>
        </div>
      </header>

      <section id="view" class="view">
        <!-- Inicio por defecto (JS lo rellena) -->
        <p>Bienvenido. Selecciona una secci√≥n del men√∫ izquierdo.</p>
      </section>

      <footer class="site-footer">
        <div class="footer-content">
          <div class="footer-info">
        <strong>¬© 2026 NutriPlant PRO¬Æ</strong>. Marca registrada. Todos los derechos reservados.
          </div>
          <div class="footer-contact">
            <div style="display: flex; flex-direction: column; gap: 8px; align-items: flex-end;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <span class="contact-label">Cont√°ctanos:</span>
                <a href="mailto:admin@nutriplantpro.com" class="contact-email">
                  <svg class="contact-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                    <polyline points="22,6 12,13 2,6"/>
                  </svg>
                  admin@nutriplantpro.com
                </a>
              </div>
              <a href="https://wa.me/13868044542?text=Hola%2C%20quiero%20informaci%C3%B3n%20sobre%20NutriPlant%20PRO" target="_blank" class="contact-whatsapp" style="
                display: inline-flex;
                align-items: center;
                gap: 6px;
                color: #ffffff;
                text-decoration: none;
                font-weight: 500;
                padding: 6px 12px;
                border-radius: 8px;
                transition: all 0.2s ease;
                background: #25d366;
                border: 1px solid #25d366;
                font-size: 13px;
              " onmouseover="this.style.background='#20ba5a'; this.style.borderColor='#20ba5a'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 8px rgba(37, 211, 102, 0.3)'" onmouseout="this.style.background='#25d366'; this.style.borderColor='#25d366'; this.style.transform='none'; this.style.boxShadow='none'">
                <svg style="width: 16px; height: 16px; flex-shrink: 0;" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                </svg>
                WhatsApp
              </a>
            </div>
          </div>
        </div>
      </footer>
    </main>
  </div>

  <!-- Bot√≥n de IA flotante -->
  <div class="chat-bubble" id="chatBubble" onclick="toggleChat()">
    <div class="chat-icon">
      <span class="chat-text">IA</span>
      <img src="assets/N_Hoja_Blanca.png" alt="NutriPlant PRO" class="chat-logo">
    </div>
  </div>

  <!-- Panel de chat -->
  <div class="chat-panel" id="chatPanel">
    <div class="chat-header">
      <div class="chat-title">
        <div class="ai-icon">IA</div>
        <span>NutriPlant PRO Assistant</span>
      </div>
      <div class="chat-controls">
        <button class="chat-btn minimize-btn" onclick="minimizeChat()" title="Minimizar">‚àí</button>
      </div>
    </div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input-area">
      <textarea class="chat-input" id="chatInput" placeholder="Preguntar a NutriPlant PRO Assistant" rows="1"></textarea>
      <button class="chat-send" id="chatSendBtn" title="Enviar">‚û§</button>
    </div>
  </div>

  <!-- Supabase (nube) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-config.js"></script>
  <script src="app-config.js"></script>
  <script src="auth-supabase.js"></script>
  <script src="auth.js"></script>
  <script src="supabase-projects.js"></script>
  <script src="project-manager.js"></script>
  <script src="location-preserver.js"></script>
  <script src="project-storage.js?v=1758333000"></script>
  <script src="test-location-preservation.js"></script>
  <script src="diagnostico-completo.js"></script>
  <script src="verificar-paso-a-paso.js"></script>
  
  <!-- Funci√≥n de diagn√≥stico r√°pida -->
  <script>
    // Funci√≥n global para diagn√≥stico r√°pido
    window.diagnosticoRapido = function() {
      console.log('%cüîç DIAGN√ìSTICO R√ÅPIDO', 'color: #2563eb; font-size: 16px; font-weight: bold;');
      
      const checks = {
        'Bot√≥n Usuario': !!document.getElementById('btn-user-info'),
        'Modal Usuario': !!document.getElementById('userInfoModal'),
        'showUserInfoModal': typeof window.showUserInfoModal === 'function',
        'Footer WhatsApp': !!document.querySelector('.contact-whatsapp'),
        'Footer Email': !!document.querySelector('.contact-email'),
        'Bot√≥n Calculadora √ìxido': !!document.getElementById('btn-conversion-calculator'),
        'Bot√≥n Calculadora Unidades': !!document.getElementById('btn-nutrient-units-calculator'),
        'Bot√≥n Calculadora Medidas': !!document.getElementById('btn-measure-units-calculator'),
        'Sesi√≥n Usuario': !!localStorage.getItem('np_user'),
        'Proyecto Actual': !!localStorage.getItem('currentProjectId')
      };
      
      let exitosos = 0;
      let fallidos = 0;
      
      Object.keys(checks).forEach(nombre => {
        if (checks[nombre]) {
          console.log(`‚úÖ ${nombre}: OK`);
          exitosos++;
        } else {
          console.error(`‚ùå ${nombre}: FALTA`);
          fallidos++;
        }
      });
      
      console.log(`\nüìä Resultado: ${exitosos} OK, ${fallidos} FALTANTES`);
      
      if (fallidos > 0) {
        console.log('\nüí° SOLUCI√ìN:');
        console.log('1. Presiona Ctrl+Shift+R (Mac: Cmd+Shift+R) para recargar sin cach√©');
        console.log('2. O ejecuta: localStorage.clear() y recarga');
        console.log('3. Verifica la consola por errores de JavaScript');
      }
      
      return { exitosos, fallidos, checks };
    };
    
    // Ejecutar diagn√≥stico autom√°ticamente al cargar (solo en desarrollo)
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      window.addEventListener('load', function() {
        setTimeout(function() {
          console.log('%cüí° TIP: Ejecuta diagnosticoRapido() en la consola para verificar todo', 'color: #16a34a; font-size: 12px;');
        }, 2000);
      });
    }
  </script>
  
  <script src="ai-knowledge-base/core/language-base.js"></script>
  <script src="ai-knowledge-base/modules/amendments.js"></script>
  <script src="ai-knowledge-base/ai-knowledge-base-complete.js"></script>
  <script src="ai-knowledge-base.js"></script>
  <script src="test-verification.js"></script>
  <script src="fertirriego-functions.js?v=1758406000"></script>
  <script src="nutricion-granular-functions.js?v=1758423000"></script>
  <script src="nutricion-granular-requerimiento-functions.js?v=1758411000"></script>
  <script src="hidroponia-functions.js"></script>
  <script src="analysis-report-render.js?v=1760005000"></script>
  <script src="dashboard.js?v=1760005000"></script>
  <script src="fertirriego-program-functions.js"></script>
  <script src="ai-knowledge-expansion.js"></script>
  <script src="chat-simple.js?v=1760500001"></script>
  <!-- <script src="chat.js?v=1758332516"></script> -->
  <script src="map.js"></script>
  
  <!-- Verificaci√≥n de carga de scripts -->
  <script>
    // Verificar que project-storage.js se carg√≥
    window.addEventListener('load', function() {
      setTimeout(function() {
        if (typeof window.projectStorage === 'undefined') {
          console.error('‚ùå CR√çTICO: project-storage.js NO se carg√≥ correctamente');
          console.error('‚ùå Verifica la consola para errores de carga');
          console.error('‚ùå Intenta recargar la p√°gina con Ctrl+Shift+R (o Cmd+Shift+R en Mac)');
        } else {
          console.log('‚úÖ project-storage.js cargado y disponible');
        }
        
        // Verificar que fertirriego-functions.js se carg√≥ correctamente
        const fertirriegoFunctions = {
          loadFertirriegoRequirements: typeof window.loadFertirriegoRequirements === 'function',
          calculateNutrientRequirements: typeof window.calculateNutrientRequirements === 'function',
          saveFertirriegoRequirements: typeof window.saveFertirriegoRequirements === 'function',
          renderNutrientTable: typeof window.renderNutrientTable === 'function'
        };
        
        const allLoaded = Object.values(fertirriegoFunctions).every(v => v === true);
        if (!allLoaded) {
          console.warn('‚ö†Ô∏è ALGUNAS funciones de Fertirriego no est√°n disponibles:', fertirriegoFunctions);
          console.warn('‚ö†Ô∏è Verifica que fertirriego-functions.js se carg√≥ correctamente');
        } else {
          console.log('‚úÖ Todas las funciones de Fertirriego est√°n disponibles:', fertirriegoFunctions);
        }
      }, 100);
    });
  </script>
  
  <script>
    // Exponer funciones de calculadoras globalmente despu√©s de que todo se cargue
    window.addEventListener('load', function() {
      console.log('üîß Configurando funciones globales de calculadoras...');
      
      // Si las funciones ya est√°n definidas, exponerlas
      if (typeof showConversionCalculator !== 'undefined') {
        window.showConversionCalculator = showConversionCalculator;
      }
      if (typeof showNutrientUnitsCalculator !== 'undefined') {
        window.showNutrientUnitsCalculator = showNutrientUnitsCalculator;
      }
      if (typeof showMeasureUnitsCalculator !== 'undefined') {
        window.showMeasureUnitsCalculator = showMeasureUnitsCalculator;
      }
      if (typeof closeMeasureUnitsCalculator !== 'undefined') {
        window.closeMeasureUnitsCalculator = closeMeasureUnitsCalculator;
      }
      if (typeof closeConversionCalculator !== 'undefined') {
        window.closeConversionCalculator = closeConversionCalculator;
      }
      if (typeof closeNutrientUnitsCalculator !== 'undefined') {
        window.closeNutrientUnitsCalculator = closeNutrientUnitsCalculator;
      }
      
      console.log('‚úÖ Funciones de calculadoras configuradas:', {
        showConversionCalculator: typeof window.showConversionCalculator,
        showNutrientUnitsCalculator: typeof window.showNutrientUnitsCalculator
      });
      
      // Agregar event listeners a los botones
      const btnConversion = document.getElementById('btn-conversion-calculator');
      if (btnConversion) {
        btnConversion.addEventListener('click', function(e) {
          e.stopPropagation(); // Detener propagaci√≥n del evento
          console.log('üîò Click en Calculadora de Conversi√≥n');
          
          // Intentar m√∫ltiples formas de llamar la funci√≥n
          if (typeof showConversionCalculator === 'function') {
            console.log('‚úÖ Llamando showConversionCalculator()');
            showConversionCalculator();
          } else if (typeof window.showConversionCalculator === 'function') {
            console.log('‚úÖ Llamando window.showConversionCalculator()');
            window.showConversionCalculator();
          } else {
            console.error('‚ùå showConversionCalculator no est√° definida');
            
            // Intentar encontrar el modal directamente
            const modal = document.getElementById('conversionCalculatorModal');
            if (modal) {
              console.log('‚úÖ Modal encontrado, abriendo directamente');
              modal.classList.add('show');
        modal.style.display = 'flex';
              if (typeof setupConversionCalculator === 'function') {
                setupConversionCalculator();
              }
            } else {
              console.error('‚ùå Modal conversionCalculatorModal no encontrado');
            }
          }
        });
      }
      
      const btnNutrient = document.getElementById('btn-nutrient-units-calculator');
      if (btnNutrient) {
        btnNutrient.addEventListener('click', function(e) {
          e.stopPropagation(); // Detener propagaci√≥n del evento
          console.log('üîò Click en Calculadora de Unidades');
          
          if (typeof showNutrientUnitsCalculator === 'function') {
            console.log('‚úÖ Llamando showNutrientUnitsCalculator()');
            showNutrientUnitsCalculator();
          } else if (typeof window.showNutrientUnitsCalculator === 'function') {
            console.log('‚úÖ Llamando window.showNutrientUnitsCalculator()');
            window.showNutrientUnitsCalculator();
          } else {
            console.error('‚ùå showNutrientUnitsCalculator no est√° definida');
            
            // Intentar encontrar el modal directamente
            const modal = document.getElementById('nutrientUnitsCalculatorModal');
            if (modal) {
              console.log('‚úÖ Modal encontrado, abriendo directamente');
              modal.classList.add('show');
        modal.style.display = 'flex';
            } else {
              console.error('‚ùå Modal nutrientUnitsCalculatorModal no encontrado');
            }
          }
        });
      }
      
      console.log('‚úÖ Event listeners configurados para las calculadoras');
    });
  </script>
  
  <style>
    /* Estilos para tablas responsivas en el chat */
    .table-container {
      overflow-x: auto;
      margin: 10px 0;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }

    .responsive-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      min-width: 300px;
    }

    .responsive-table th,
    .responsive-table td {
      padding: 8px 12px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }

    .responsive-table th {
      background-color: #f8f9fa;
      font-weight: 600;
      color: #495057;
    }

    .responsive-table tr:hover {
      background-color: #f8f9fa;
    }

    .responsive-table td {
      word-wrap: break-word;
      max-width: 200px;
    }

    /* Estilos para botones del header */
    .header-buttons {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .btn-success {
      background-color: #28a745;
      border-color: #28a745;
      color: white;
    }

    .btn-success:hover {
      background-color: #218838;
      border-color: #1e7e34;
    }

    .btn-success i {
      margin-right: 5px;
    }

    /* Estilos para la calculadora de conversi√≥n */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(2px);
      z-index: 99999;
    }
    
    /* Por defecto oculto */
    .modal-overlay:not(.show) {
      display: none !important;
    }
    
    /* Cuando tiene clase show, visible */
    .modal-overlay.show {
      display: flex !important;
      justify-content: center !important;
      align-items: center !important;
    }
    
    /* Estilo espec√≠fico para el modal de informaci√≥n de usuario */
    #userInfoModal {
      display: none;
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;
      height: 100% !important;
      background: rgba(0, 0, 0, 0.5) !important;
      z-index: 10000 !important;
    }
    
    #userInfoModal.show {
      display: flex !important;
      justify-content: center !important;
      align-items: center !important;
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;
      height: 100% !important;
      background: rgba(0, 0, 0, 0.5) !important;
      z-index: 10000 !important;
    }

    .modal {
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      max-width: 800px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      z-index: 10001;
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f8fafc;
      border-radius: 8px 8px 0 0;
    }

    .modal-title {
      margin: 0;
      color: #1f2937;
      font-size: 1.5rem;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover {
      color: #333;
    }

    .modal-body {
      padding: 20px;
    }

    .modal-footer {
      padding: 20px;
      border-top: 1px solid #e0e0e0;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .conversion-calculator {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .conversion-section h3 {
      margin: 0 0 15px 0;
      color: #333;
      font-size: 1.2rem;
    }

    .conversion-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
    }

    .conversion-item {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }

    .conversion-item label {
      display: block;
      font-weight: 600;
      margin-bottom: 10px;
      color: #333;
    }

    .conversion-formula {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .conversion-formula input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    .conversion-formula input:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    }

    .conversion-formula span {
      font-weight: 600;
      color: #666;
      white-space: nowrap;
    }

    .info-box {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #2196f3;
    }

    .info-box ul {
      margin: 10px 0 0 0;
      padding-left: 20px;
    }

    .info-box li {
      margin-bottom: 5px;
      font-size: 14px;
    }

    .btn-secondary {
      background-color: #6c757d;
      border-color: #6c757d;
      color: white;
      padding: 8px 16px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
    }

    .btn-secondary:hover {
      background-color: #5a6268;
    }
  </style>
  
  <!-- Configuraci√≥n del Chat -->
  <script>
    // Variables globales del chat
    let isChatOpen = false;
    let isChatMinimized = false;
    let messages = [];
    let conversationContext = {
      lastAIQuestion: null,
      waitingForConfirmation: false,
      lastSuggestedAction: null,
      userPreferences: {},
      conversationHistory: [], // Historial de conversaci√≥n
      currentTopic: null, // Tema actual de conversaci√≥n
      userInfo: {} // Informaci√≥n del usuario (cultivo, ubicaci√≥n, etc.)
    };

    // üü¢ Sincronizaci√≥n del chat con la nube (opcional). Por ahora no hace nada.
    // Cuando tengas backend: asigna aqu√≠ una funci√≥n que env√≠e payload a tu API (ej. POST /api/chat/sync).
    window.nutriplantSyncChatToCloud = function(payload) {
      // payload = { type: 'project', projectId, chatHistory, userId } o { type: 'user', userId, chatHistory }
      // Ejemplo futuro: fetch('/api/chat/sync', { method: 'POST', body: JSON.stringify(payload), ... });
    };

    // üöÄ SISTEMA DE ALMACENAMIENTO H√çBRIDO NUTRIPLANT PRO
    class NutriPlantStorage {
      constructor() {
        this.userId = this.getOrCreateUserId();
        this.currentProjectId = null;
      }
      
      // üë§ GESTI√ìN DE USUARIOS
      getOrCreateUserId() {
        // üîí VALIDAR QUE EL USUARIO EXISTE - NO crear autom√°ticamente
        let userId = localStorage.getItem('nutriplant_user_id');
        if (!userId) {
          console.error('‚ùå No hay userId en localStorage');
          return null;
        }
        
        // üîí VALIDAR QUE EL USUARIO REALMENTE EXISTE EN localStorage
        const userKey = `nutriplant_user_${userId}`;
        const userData = localStorage.getItem(userKey);
        if (!userData) {
          console.error('‚ùå Usuario no encontrado en localStorage:', userId);
          // Limpiar userId inv√°lido
          localStorage.removeItem('nutriplant_user_id');
          localStorage.removeItem('np_user');
          // Redirigir a login
          alert('‚ùå Tu sesi√≥n ha expirado o el usuario no existe. Por favor, inicia sesi√≥n nuevamente.');
          window.location.href = 'login.html';
          return null;
        }
        
        return userId;
      }
      
      createUserProfile(userId) {
        const userProfile = {
          id: userId,
          name: 'Usuario NutriPlant',
          email: '',
          created_at: new Date().toISOString(),
          last_login: new Date().toISOString(),
          projects: [],
          preferences: {
            theme: 'light',
            language: 'es',
            notifications: true
          }
        };
        localStorage.setItem(`nutriplant_user_${userId}`, JSON.stringify(userProfile));
        return userProfile;
      }
      
      getUserProfile() {
        const profile = localStorage.getItem(`nutriplant_user_${this.userId}`);
        return profile ? JSON.parse(profile) : this.createUserProfile(this.userId);
      }
      
      updateUserProfile(updates) {
        const profile = this.getUserProfile();
        const updatedProfile = { ...profile, ...updates, last_login: new Date().toISOString() };
        localStorage.setItem(`nutriplant_user_${this.userId}`, JSON.stringify(updatedProfile));
        return updatedProfile;
      }
      
      // üìã GESTI√ìN DE PROYECTOS
      createProject(projectData) {
        const projectName = projectData.name || 'Nuevo Proyecto';
        
        // üîë USAR FUNCI√ìN DE GENERACI√ìN DE ID DESCRIPTIVO
        let projectId;
        if (typeof np_newId === 'function') {
          projectId = np_newId(projectName, this.userId);
        } else {
          // Fallback si np_newId no est√° disponible
          projectId = 'project_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // üîí VALIDACI√ìN: Verificar que no exista ya un proyecto con este ID
        let projectKey = `nutriplant_project_${projectId}`;
        let attempts = 0;
        const maxAttempts = 10;
        
        while (localStorage.getItem(projectKey) && attempts < maxAttempts) {
          console.warn(`‚ö†Ô∏è ID ya existe (intento ${attempts + 1}/${maxAttempts}), generando variaci√≥n...`);
          attempts++;
          
          if (typeof np_newId === 'function') {
            projectId = np_newId(projectName, this.userId) + '_' + attempts;
          } else {
            projectId = 'project_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          }
          projectKey = `nutriplant_project_${projectId}`;
        }
        
        const now = new Date().toISOString();
        
        // üîë OBTENER INFORMACI√ìN DEL USUARIO
        let userInfo = {};
        if (this.userId) {
          try {
            const userProfile = this.getUserProfile();
            userInfo = {
              user_id: this.userId,
              user_name: userProfile.name || '',
              user_email: userProfile.email || ''
            };
          } catch (e) {
            console.warn('‚ö†Ô∏è Error obteniendo informaci√≥n del usuario:', e);
          }
        }
        // üìã ESTRUCTURA COMPLETA DEL PROYECTO
        const project = {
          // üîë IDENTIFICADORES
          id: projectId, // üîí CR√çTICO: ID consistente
          code: projectId, // C√≥digo del proyecto
          
          // üìù INFORMACI√ìN B√ÅSICA
          name: projectName,
          title: projectName, // Compatibilidad
          
          // üë§ INFORMACI√ìN DEL USUARIO
          ...userInfo,
          
          // üåæ INFORMACI√ìN DEL CULTIVO
          crop_type: projectData.crop_type || '',
          cultivo: projectData.crop_type || '',
          campoOsector: projectData.campoOsector || null,
          rendimientoEsperado: projectData.rendimientoEsperado ?? null,
          unidadRendimiento: projectData.unidadRendimiento || "t/ha",
          
          // üìÖ FECHAS
          created_at: now,
          createdAt: now,
          updated_at: now,
          updatedAt: now,
          
          // üìç UBICACI√ìN
          location: projectData.location || {
            coordinates: '',
            surface: '',
            perimeter: '',
            polygon: null,
            city: '',
            state: '',
            country: ''
          },
          
          // üè∑Ô∏è METADATOS
          status: 'active',
          version: '1.0',
          
          // üì¶ SECCIONES DEL PROYECTO
          sections: {
            // üìç UBICACI√ìN Y MAPA
            ubicacion: projectData.ubicacion || {},
            
            // üöú AN√ÅLISIS DE ENMIENDAS
            enmiendas: projectData.enmiendas || {},
            
            // üìä NUTRICI√ìN GRANULAR
            programa_granular: projectData.programa_granular || {},
            
            // üíß FERTIRRIEGO
            fertirriego: projectData.fertirriego || {},
            
            // üå± HIDROPON√çA
            hidroponia: projectData.hidroponia || {},
            
            // üî¨ AN√ÅLISIS DE SUELO
            analisis: projectData.analisis || {},
            
            // üß™ EXTRACTO DE PASTA
            extracto: projectData.extracto || {},
            
            // üíß AN√ÅLISIS DE AGUA
            agua: projectData.agua || {},
            
            // üåø AN√ÅLISIS FOLIAR
            foliar: projectData.foliar || {},
            
            // üçé AN√ÅLISIS DE FRUTA
            fruta: projectData.fruta || {},
            
            // üå°Ô∏è D√âFICIT DE PRESI√ìN DE VAPOR (VPD)
            vpd: projectData.vpd || {}
          },
          chat_history: [],
          calculations: {},
          documents: []
        };
        
        // üöÄ CR√çTICO: createProject NO debe tener location - se crea vac√≠o
        // Location solo se guarda con map.js::saveLocation()
        // üîí VALIDACI√ìN FINAL: Asegurar que el ID en el objeto coincida con la clave
        if (project.id !== projectId) {
          console.error('‚ùå ERROR CR√çTICO: ID del objeto no coincide con ID de la clave');
          project.id = projectId; // Forzar correcci√≥n
        }
        
        // üîí CR√çTICO: Asegurar que el proyecto SIEMPRE tenga informaci√≥n del usuario
        if (!project.user_id || !project.user_name) {
          console.warn('‚ö†Ô∏è Proyecto sin informaci√≥n de usuario - agregando autom√°ticamente');
          if (this.userId) {
            project.user_id = this.userId;
            project.userId = this.userId; // Compatibilidad
        const userProfile = this.getUserProfile();
            project.user_name = userProfile.name || userProfile.email || '';
            project.user_email = userProfile.email || '';
          }
        }
        
        // Guardar proyecto con clave consistente
        const finalProjectKey = `nutriplant_project_${projectId}`;
        localStorage.setItem(finalProjectKey, JSON.stringify(project));
        console.log('‚úÖ Proyecto creado en dashboard.html (ID √∫nico):', projectId, 'Clave:', finalProjectKey, 'Usuario:', project.user_name || this.userId);
        
        // Agregar a lista de proyectos del usuario (solo si no existe ya)
        const userProfile = this.getUserProfile();
        if (!userProfile.projects) {
          userProfile.projects = [];
        }
        // üîí VALIDACI√ìN: Verificar que el proyecto no est√© ya en la lista
        if (!userProfile.projects.includes(projectId)) {
        userProfile.projects.push(projectId);
        this.updateUserProfile(userProfile);
          console.log('‚úÖ Proyecto asociado al usuario');
        } else {
          console.warn('‚ö†Ô∏è El proyecto ya estaba en la lista del usuario (ignorado)');
        }
        
        return project;
      }
      
      getProject(projectId) {
        const project = localStorage.getItem(`nutriplant_project_${projectId}`);
        return project ? JSON.parse(project) : null;
      }
      
      getAllProjects() {
        const userProfile = this.getUserProfile();
        return userProfile.projects.map(projectId => this.getProject(projectId)).filter(p => p);
      }
      
      updateProject(projectId, updates) {
        const project = this.getProject(projectId);
        if (!project) return null;
        
        // üöÄ CR√çTICO: Preservar location antes de actualizar
        const existingLocation = project.location;
        const hasValidLocation = existingLocation && 
                                existingLocation.polygon && 
                                Array.isArray(existingLocation.polygon) && 
                                existingLocation.polygon.length >= 3;
        
        const updatedProject = {
          ...project,
          ...updates,
          updated_at: new Date().toISOString()
        };
        
        // üöÄ CR√çTICO: Restaurar location despu√©s de actualizar
        if (hasValidLocation) {
          updatedProject.location = existingLocation;
        }
        
        localStorage.setItem(`nutriplant_project_${projectId}`, JSON.stringify(updatedProject));
        return updatedProject;
      }
      
      deleteProject(projectId) {
        const userProfile = this.getUserProfile();
        const project = this.getProject(projectId);
        // Preservar historial de chat del proyecto en el usuario (chat sin proyecto)
        if (project && project.chat_history && Array.isArray(project.chat_history) && project.chat_history.length > 0 && this.userId) {
          userProfile.chat_history_sin_proyecto = userProfile.chat_history_sin_proyecto || [];
          userProfile.chat_history_sin_proyecto = userProfile.chat_history_sin_proyecto.concat(project.chat_history);
        }
        localStorage.removeItem(`nutriplant_project_${projectId}`);
        userProfile.projects = userProfile.projects.filter(id => id !== projectId);
        this.updateUserProfile(userProfile);
        return true;
      }
      
      // üí¨ GESTI√ìN DE CHAT POR PROYECTO
      saveChatMessage(projectId, message, type, context = {}) {
        const project = this.getProject(projectId);
        if (!project) return false;
        
        const chatMessage = {
          id: 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
          type: type, // 'user' or 'ai'
          content: message,
          timestamp: new Date().toISOString(),
          context: {
            dashboard_state: context.dashboard_state || {},
            active_section: context.active_section || '',
            soil_data: context.soil_data || {},
            project_data: context.project_data || {}
          }
        };
        
        project.chat_history.push(chatMessage);
        this.updateProject(projectId, { chat_history: project.chat_history });
        // üü¢ Gancho para sincronizar chat con la nube (cuando tengas backend, implementa window.nutriplantSyncChatToCloud aqu√≠)
        if (typeof window.nutriplantSyncChatToCloud === 'function') {
          try { window.nutriplantSyncChatToCloud({ type: 'project', projectId, chatHistory: project.chat_history, userId: this.userId }); } catch (e) { console.warn('syncChatToCloud:', e); }
        }
        return chatMessage;
      }
      
      getChatHistory(projectId) {
        const project = this.getProject(projectId);
        return project ? project.chat_history : [];
      }
      
      // üîÑ MIGRACI√ìN DE DATOS EXISTENTES
      migrateExistingData() {
        console.log('üîÑ Migrando datos existentes al nuevo sistema...');
        
        // Migrar proyecto actual si existe
        const existingProject = this.getCurrentProjectData();
        if (existingProject && existingProject.name) {
          const newProject = this.createProject({
            name: existingProject.name,
            crop_type: existingProject.crop_type || 'Aguacate',
            location: existingProject.location || 'Cd. Guzm√°n, Jalisco',
            analisis: existingProject.soilData || {}
          });
          
          console.log('‚úÖ Proyecto migrado:', newProject.name);
          return newProject;
        }
        
        return null;
      }
      
      getCurrentProjectData() {
        // Obtener datos del proyecto actual desde el DOM
        const projectName = document.getElementById('sectionTitle')?.textContent || 'Proyecto Actual';
        // Funci√≥n movida a chat.js - comentada temporalmente
        // const soilData = this.getCurrentSoilDataForAnalysis();
        
        return {
          name: projectName,
          soilData: 'No disponible',
          timestamp: new Date().toISOString()
        };
      }
    }
    
    // Inicializar sistema de almacenamiento
    const nutriPlantStorage = new NutriPlantStorage();
    
    // üöÄ FUNCIONES DE INTERFAZ PARA PROYECTOS
    function showUserProjects() {
      const projects = nutriPlantStorage.getAllProjects();
      console.log('üìã Proyectos del usuario:', projects);
      
      // Mostrar en la consola por ahora (luego se integrar√° en la UI)
      if (projects.length > 0) {
        console.log('‚úÖ Proyectos encontrados:');
        projects.forEach(project => {
          console.log(`‚Ä¢ ${project.name} (${project.crop_type}) - ${project.chat_history.length} mensajes`);
        });
      } else {
        console.log('üìù No hay proyectos guardados a√∫n');
      }
      
      return projects;
    }
    
    function createNewProject() {
      const projectName = prompt('Nombre del nuevo proyecto:');
      if (projectName) {
        const newProject = nutriPlantStorage.createProject({
          name: projectName,
          crop_type: 'Aguacate',
          location: 'Cd. Guzm√°n, Jalisco'
        });
        console.log('‚úÖ Proyecto creado:', newProject);
        nutriPlantStorage.currentProjectId = newProject.id;
        return newProject;
      }
      return null;
    }

    // Inicializar sistema de IA inteligente
    let nutriPlantAI = new NutriPlantAI();
    const currentUserId = nutriPlantStorage.userId; // Usar ID del sistema de almacenamiento
    
    // Inicializar sistema de expansi√≥n de conocimiento
    let knowledgeExpansion = new KnowledgeExpansion(nutriPlantAI);
    
    // Sistema de seguimiento de costos
    let costTracker = {
      totalRequests: 0,
      manualResponses: 0,
      chatGPTResponses: 0,
      estimatedCost: 0,
      lastReset: new Date().toISOString()
    };
    
    // Sistema de contexto multi-secci√≥n
    let currentSection = 'enmienda'; // Secci√≥n actual
    let sectionKnowledge = {
      enmienda: {
        name: 'Enmienda',
        icon: 'üöú',
        expertise: 'C√°lculo de enmiendas, ajuste de CIC, correcci√≥n de pH, manejo de cationes',
        formulas: ['CIC = K‚Å∫ + Ca¬≤‚Å∫ + Mg¬≤‚Å∫ + H‚Å∫ + Na‚Å∫ + Al¬≥‚Å∫', 'Porcentaje = (meq_cati√≥n / CIC) √ó 100'],
        recommendations: ['Cal dolom√≠tica', 'Yeso agr√≠cola', 'Sulfato de potasio', 'Sulfato de magnesio']
      },
      fertirriego: {
        name: 'Fertirriego',
        icon: 'üíß',
        expertise: 'Programas de nutrici√≥n, fertirrigaci√≥n, dosis de fertilizantes, riego',
        formulas: ['Dosis = (Demanda √ó √Årea) / Eficiencia', 'Concentraci√≥n = Dosis / Volumen_agua'],
        recommendations: ['Nitrato de potasio', 'Fosfato monoam√≥nico', 'Sulfato de magnesio', '√Åcido n√≠trico']
      },
      hidroponia: {
        name: 'Hidropon√≠a',
        icon: 'üå±',
        expertise: 'Soluciones nutritivas, EC, pH, sistemas hidrop√≥nicos',
        formulas: ['EC = Œ£(Concentraci√≥n √ó Factor)', 'pH = -log[H‚Å∫]'],
        recommendations: ['Soluci√≥n A y B', 'Microelementos', '√Åcido fosf√≥rico', 'Hidr√≥xido de potasio']
      },
      analisis: {
        name: 'An√°lisis',
        icon: 'üî¨',
        expertise: 'Interpretaci√≥n de an√°lisis, diagn√≥stico nutricional, deficiencias',
        formulas: ['√çndice DRIS', 'Relaciones nutricionales', 'Balance de cationes'],
        recommendations: ['An√°lisis foliar', 'An√°lisis de suelo', 'Diagn√≥stico visual', 'Correcci√≥n espec√≠fica']
      },
      extracto: {
        name: 'Extracto',
        icon: 'üß™',
        expertise: 'Extracci√≥n de nutrientes, an√°lisis de pasta, interpretaci√≥n de resultados',
        formulas: ['Extracci√≥n = Concentraci√≥n √ó Volumen', 'Eficiencia = Extra√≠do / Aplicado'],
        recommendations: ['M√©todo Olsen', 'M√©todo Bray', 'Extracci√≥n con agua', 'An√°lisis de pasta']
      }
    };
    
    // Sistema de conocimiento expandido
    let agriculturalKnowledge = {
      // CONCEPTOS B√ÅSICOS
      concepts: {
        'CIC': 'Capacidad de Intercambio Cati√≥nico - Medida de la capacidad del suelo para retener cationes',
        'pH': 'Medida de acidez o alcalinidad del suelo (0-14, 7=neutro)',
        'EC': 'Conductividad El√©ctrica - Medida de sales disueltas en el suelo',
        'Materia Org√°nica': 'Restos vegetales y animales en descomposici√≥n que mejoran la estructura del suelo',
        'Textura': 'Proporci√≥n de arena, limo y arcilla en el suelo',
        'DRIS': 'Sistema de diagn√≥stico y recomendaci√≥n integrada para an√°lisis foliar'
      },
      
      // CULTIVOS EXPANDIDOS
      crops: {
        'aguacate': {
          name: 'Aguacate',
          icon: 'ü•ë',
          family: 'Lauraceae',
          pH_ideal: '6.0-7.0',
          CIC_ideal: '15-25 meq/100g',
          Ca_ideal: '65-75% del CIC',
          K_ideal: '3-7% del CIC',
          Mg_ideal: '10-15% del CIC',
          symptoms: {
            'deficiencia_calcio': 'Bordes quemados en hojas nuevas, frutos con manchas negras',
            'deficiencia_potasio': 'Hojas amarillas en bordes, frutos peque√±os',
            'deficiencia_magnesio': 'Clorosis entre nervaduras en hojas viejas'
          },
          fertilizers: ['Cal dolom√≠tica', 'Nitrato de calcio', 'Sulfato de potasio', 'Sulfato de magnesio']
        },
        'tomate': {
          name: 'Tomate',
          icon: 'üçÖ',
          family: 'Solanaceae',
          pH_ideal: '6.0-6.8',
          CIC_ideal: '10-20 meq/100g',
          Ca_ideal: '60-70% del CIC',
          K_ideal: '5-8% del CIC',
          Mg_ideal: '8-12% del CIC',
          symptoms: {
            'deficiencia_calcio': 'Pudrici√≥n apical del fruto, hojas rizadas',
            'deficiencia_potasio': 'Hojas amarillas, frutos blandos',
            'deficiencia_magnesio': 'Clorosis entre nervaduras'
          },
          fertilizers: ['Nitrato de calcio', 'Sulfato de potasio', 'Fosfato monoam√≥nico']
        },
        'maiz': {
          name: 'Ma√≠z',
          icon: 'üåΩ',
          family: 'Poaceae',
          pH_ideal: '6.0-7.0',
          CIC_ideal: '8-15 meq/100g',
          Ca_ideal: '50-65% del CIC',
          K_ideal: '3-6% del CIC',
          Mg_ideal: '8-12% del CIC',
          symptoms: {
            'deficiencia_nitrogeno': 'Hojas amarillas, crecimiento lento',
            'deficiencia_fosforo': 'Hojas moradas, ra√≠ces poco desarrolladas',
            'deficiencia_potasio': 'Bordes quemados, tallos d√©biles'
          },
          fertilizers: ['Urea', 'Superfosfato triple', 'Cloruro de potasio']
        },
        'fresa': {
          name: 'Fresa',
          icon: 'üçì',
          family: 'Rosaceae',
          pH_ideal: '5.5-6.5',
          CIC_ideal: '8-15 meq/100g',
          Ca_ideal: '60-70% del CIC',
          K_ideal: '4-7% del CIC',
          Mg_ideal: '8-12% del CIC',
          symptoms: {
            'deficiencia_calcio': 'Frutos blandos, hojas rizadas',
            'deficiencia_potasio': 'Frutos peque√±os, sabor √°cido',
            'deficiencia_hierro': 'Clorosis f√©rrica en hojas nuevas'
          },
          fertilizers: ['Nitrato de calcio', 'Sulfato de potasio', 'Quelato de hierro']
        },
        'citricos': {
          name: 'C√≠tricos',
          icon: 'üçä',
          family: 'Rutaceae',
          pH_ideal: '6.0-7.0',
          CIC_ideal: '10-20 meq/100g',
          Ca_ideal: '60-70% del CIC',
          K_ideal: '4-7% del CIC',
          Mg_ideal: '8-12% del CIC',
          symptoms: {
            'deficiencia_calcio': 'Frutos agrietados, hojas rizadas',
            'deficiencia_potasio': 'Frutos peque√±os, c√°scara gruesa',
            'deficiencia_magnesio': 'Clorosis entre nervaduras'
          },
          fertilizers: ['Cal dolom√≠tica', 'Sulfato de potasio', 'Sulfato de magnesio']
        }
      },
      
      // FERTILIZANTES COMPLETOS
      fertilizers: {
        'nitrogenados': {
          'urea': { formula: 'CO(NH‚ÇÇ)‚ÇÇ', N: 46, uso: 'Fertilizaci√≥n base', cultivos: ['maiz', 'trigo', 'sorgo'] },
          'nitrato_amonio': { formula: 'NH‚ÇÑNO‚ÇÉ', N: 33, uso: 'Fertirriego', cultivos: ['tomate', 'pimiento', 'lechuga'] },
          'sulfato_amonio': { formula: '(NH‚ÇÑ)‚ÇÇSO‚ÇÑ', N: 21, S: 24, uso: 'Suelos alcalinos', cultivos: ['maiz', 'trigo'] }
        },
        'fosforados': {
          'superfosfato_simple': { formula: 'Ca(H‚ÇÇPO‚ÇÑ)‚ÇÇ', P: 16, Ca: 20, uso: 'Fertilizaci√≥n base', cultivos: ['maiz', 'frijol'] },
          'superfosfato_triple': { formula: 'Ca(H‚ÇÇPO‚ÇÑ)‚ÇÇ', P: 46, Ca: 20, uso: 'Fertilizaci√≥n concentrada', cultivos: ['tomate', 'pimiento'] },
          'fosfato_monoam√≥nico': { formula: 'NH‚ÇÑH‚ÇÇPO‚ÇÑ', N: 11, P: 48, uso: 'Fertirriego', cultivos: ['tomate', 'lechuga'] }
        },
        'potasicos': {
          'cloruro_potasio': { formula: 'KCl', K: 60, Cl: 45, uso: 'Fertilizaci√≥n base', cultivos: ['maiz', 'trigo'] },
          'sulfato_potasio': { formula: 'K‚ÇÇSO‚ÇÑ', K: 50, S: 18, uso: 'Cultivos sensibles al cloro', cultivos: ['tomate', 'pimiento', 'fresa'] },
          'nitrato_potasio': { formula: 'KNO‚ÇÉ', K: 44, N: 13, uso: 'Fertirriego', cultivos: ['tomate', 'lechuga', 'fresa'] }
        },
        'calcio': {
          'cal_agricola': { formula: 'CaCO‚ÇÉ', Ca: 40, uso: 'Correcci√≥n de pH', cultivos: ['aguacate', 'citricos'] },
          'yeso_agricola': { formula: 'CaSO‚ÇÑ', Ca: 23, S: 18, uso: 'Mejora de estructura', cultivos: ['aguacate', 'maiz'] },
          'nitrato_calcio': { formula: 'Ca(NO‚ÇÉ)‚ÇÇ', Ca: 19, N: 15, uso: 'Fertirriego', cultivos: ['tomate', 'lechuga', 'fresa'] }
        },
        'magnesio': {
          'sulfato_magnesio': { formula: 'MgSO‚ÇÑ', Mg: 16, S: 13, uso: 'Correcci√≥n de deficiencia', cultivos: ['aguacate', 'citricos'] },
          'oxido_magnesio': { formula: 'MgO', Mg: 60, uso: 'Correcci√≥n de pH', cultivos: ['aguacate', 'citricos'] }
        },
        'microelementos': {
          'quelato_hierro': { formula: 'Fe-EDTA', Fe: 13, uso: 'Clorosis f√©rrica', cultivos: ['citricos', 'fresa'] },
          'sulfato_zinc': { formula: 'ZnSO‚ÇÑ', Zn: 35, S: 18, uso: 'Deficiencia de zinc', cultivos: ['maiz', 'citricos'] },
          'sulfato_manganeso': { formula: 'MnSO‚ÇÑ', Mn: 32, S: 19, uso: 'Deficiencia de manganeso', cultivos: ['soya', 'citricos'] }
        }
      }
    };
    // API Key configurada en chat.js

    // Funciones b√°sicas del chat - USAR SOLO chat.js (NutriPlantChat)
    function toggleChat() {
      console.log('üîç toggleChat() llamada');
      console.log('üîç window.nutriPlantChat existe?', !!window.nutriPlantChat);
      console.log('üîç NutriPlantChat est√° definido?', typeof NutriPlantChat !== 'undefined');
      
      if (window.nutriPlantChat && typeof window.nutriPlantChat.toggleChat === 'function') {
        console.log('‚úÖ Llamando a window.nutriPlantChat.toggleChat()');
        window.nutriPlantChat.toggleChat();
        return;
      }
      
      // Si no est√° inicializado, intentar inicializarlo
      if (typeof NutriPlantChat !== 'undefined') {
        console.log('üîÑ NutriPlantChat est√° definido, inicializando...');
        try {
          window.nutriPlantChat = new NutriPlantChat();
          console.log('‚úÖ NutriPlantChat inicializado correctamente');
          if (window.nutriPlantChat && typeof window.nutriPlantChat.toggleChat === 'function') {
            window.nutriPlantChat.toggleChat();
          } else {
            console.error('‚ùå toggleChat no es una funci√≥n despu√©s de inicializar');
            alert('Error: El chat no se pudo inicializar correctamente. Por favor, recarga la p√°gina.');
          }
        } catch (error) {
          console.error('‚ùå Error al inicializar NutriPlantChat:', error);
          console.error('‚ùå Stack trace:', error.stack);
          alert('Error al inicializar el chat: ' + error.message + '. Por favor, recarga la p√°gina.');
        }
        } else {
          console.error('‚ùå NutriPlantChat no est√° definido. Verificando carga de chat.js...');
          // Intentar usar la funci√≥n de inicializaci√≥n si est√° disponible
          if (typeof window.initializeNutriPlantChat === 'function') {
            console.log('üîÑ Usando funci√≥n de inicializaci√≥n...');
            const chat = window.initializeNutriPlantChat();
            if (chat && typeof chat.toggleChat === 'function') {
              chat.toggleChat();
            } else {
              alert('El chat no se pudo inicializar. Por favor, recarga la p√°gina.');
            }
          } else {
            // Esperar un momento y volver a intentar (por si el script a√∫n se est√° cargando)
            setTimeout(() => {
              if (typeof NutriPlantChat !== 'undefined') {
                console.log('‚úÖ NutriPlantChat ahora est√° disponible, inicializando...');
                try {
                  window.nutriPlantChat = new NutriPlantChat();
                  window.nutriPlantChat.toggleChat();
                } catch (error) {
                  console.error('‚ùå Error al inicializar despu√©s de esperar:', error);
                  alert('Error al abrir el chat. Por favor, recarga la p√°gina.');
                }
              } else {
                console.error('‚ùå chat.js no se ha cargado despu√©s de esperar');
                alert('El chat no est√° disponible. El archivo chat.js no se ha cargado. Por favor, verifica la consola y recarga la p√°gina.');
              }
            }, 500);
          }
      }
    }

    function openChat() {
      if (window.nutriPlantChat && typeof window.nutriPlantChat.openChat === 'function') {
        window.nutriPlantChat.openChat();
      }
    }

    function closeChat() {
      if (window.nutriPlantChat && typeof window.nutriPlantChat.closeChat === 'function') {
        window.nutriPlantChat.closeChat();
      }
    }

    function minimizeChat() {
      if (window.nutriPlantChat && typeof window.nutriPlantChat.minimizeChat === 'function') {
        window.nutriPlantChat.minimizeChat();
      }
    }

    async function sendMessage() {
      if (window.nutriPlantChat && typeof window.nutriPlantChat.sendMessage === 'function') {
        window.nutriPlantChat.sendMessage();
      }
    }

    // Funci√≥n addMessage - usar chat.js
    function addMessage(content, sender) {
      if (window.nutriPlantChat && typeof window.nutriPlantChat.addMessage === 'function') {
        window.nutriPlantChat.addMessage(content, sender);
      }
    }
    
    function scrollToComfortablePosition() {
      const messagesContainer = document.getElementById('chatMessages');
      const containerHeight = messagesContainer.clientHeight;
      const totalHeight = messagesContainer.scrollHeight;
      
      // Calcular la posici√≥n para mostrar el √∫ltimo mensaje del usuario y el inicio de la respuesta de la IA
      const lastUserMessage = findLastUserMessage();
      if (lastUserMessage) {
        const lastUserMessageTop = lastUserMessage.offsetTop;
        const lastUserMessageHeight = lastUserMessage.offsetHeight;
        
        // Posicionar para que el √∫ltimo mensaje del usuario est√© visible en la parte superior
        // y la respuesta de la IA comience visible abajo
        const targetScrollTop = Math.max(0, lastUserMessageTop - 20); // 20px de margen superior
        
        // Hacer scroll suave a esa posici√≥n
        smoothScrollTo(messagesContainer, targetScrollTop);
      } else {
        // Si no hay mensaje del usuario, ir al final
        scrollToBottom();
      }
    }
    
    function findLastUserMessage() {
      const messagesContainer = document.getElementById('chatMessages');
      const userMessages = messagesContainer.querySelectorAll('.chat-message.user');
      return userMessages.length > 0 ? userMessages[userMessages.length - 1] : null;
    }
    
    function smoothScrollTo(element, targetScrollTop) {
      const startScrollTop = element.scrollTop;
      const distance = targetScrollTop - startScrollTop;
      const duration = Math.min(800, Math.abs(distance) * 2);
      const startTime = performance.now();
      
      function animateScroll(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        // Funci√≥n de easing suave
        const easeOut = 1 - Math.pow(1 - progress, 3);
        
        element.scrollTop = startScrollTop + (distance * easeOut);
        
        if (progress < 1) {
          requestAnimationFrame(animateScroll);
        }
      }
      
      requestAnimationFrame(animateScroll);
    }
    
    function scrollToBottomGradual() {
      const messagesContainer = document.getElementById('chatMessages');
      const targetScrollTop = messagesContainer.scrollHeight - messagesContainer.clientHeight;
      const currentScrollTop = messagesContainer.scrollTop;
      const distance = targetScrollTop - currentScrollTop;
      
      // Si la distancia es peque√±a, hacer scroll inmediato
      if (Math.abs(distance) < 50) {
        messagesContainer.scrollTop = targetScrollTop;
        return;
      }
      
      // Para distancias grandes, hacer scroll gradual
      const duration = Math.min(2000, Math.abs(distance) * 3); // M√°s lento para leer
      const startTime = performance.now();
      
      function animateScroll(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        // Funci√≥n de easing m√°s suave para lectura
        const easeOut = 1 - Math.pow(1 - progress, 3);
        
        messagesContainer.scrollTop = currentScrollTop + (distance * easeOut);
        
        if (progress < 1) {
          requestAnimationFrame(animateScroll);
        }
      }
      
      requestAnimationFrame(animateScroll);
    }

    // Funciones de UI - usar chat.js (ya implementadas en NutriPlantChat)
    // Estas funciones ya no son necesarias porque chat.js las maneja internamente

    async function getAIResponse(message) {
      console.log('üöÄ INICIANDO getAIResponse - CHATGPT DIRECTO...');
      
      // Incrementar contador de solicitudes
      costTracker.totalRequests++;
      
      // Guardar en historial de conversaci√≥n local
      conversationContext.conversationHistory.push({
        type: 'user',
        message: message,
        timestamp: new Date().toISOString()
      });
      
      // üöÄ GUARDAR EN SISTEMA H√çBRIDO
      const currentProject = nutriPlantStorage.getCurrentProjectData();
      if (currentProject) {
        // Crear proyecto si no existe
        let projectId = nutriPlantStorage.currentProjectId;
        if (!projectId) {
          const newProject = nutriPlantStorage.createProject({
            name: currentProject.name,
            crop_type: 'Aguacate',
            location: 'Cd. Guzm√°n, Jalisco'
          });
          projectId = newProject.id;
          nutriPlantStorage.currentProjectId = projectId;
        }
        
        // Guardar mensaje del usuario
        nutriPlantStorage.saveChatMessage(projectId, message, 'user', {
          dashboard_state: getCurrentDashboardState(),
          active_section: detectCurrentSection(),
          soil_data: getCurrentSoilDataForAnalysis(),
          project_data: currentProject
        });
      }
      
      // Llamar directamente a ChatGPT
      try {
        const response = await callChatGPT(message);
        
        // üöÄ GUARDAR RESPUESTA DE IA
        if (currentProject && nutriPlantStorage.currentProjectId) {
          nutriPlantStorage.saveChatMessage(nutriPlantStorage.currentProjectId, response, 'ai', {
            dashboard_state: getCurrentDashboardState(),
            active_section: detectCurrentSection(),
            soil_data: getCurrentSoilDataForAnalysis(),
            project_data: currentProject
          });
        }
        
        return formatMessage(response);
      } catch (error) {
        console.error('‚ùå Error con ChatGPT:', error);
        return 'Lo siento, hubo un error al procesar tu mensaje. Intenta de nuevo.';
      }
    }

    // Funci√≥n para llamar directamente a ChatGPT
    async function callChatGPT(message) {
      const prompt = `Eres un EXPERTO MUNDIAL EN AGRONOM√çA con acceso a TODO el conocimiento cient√≠fico y t√©cnico de la agricultura moderna. Eres como ChatGPT pero especializado al 100% en agronom√≠a.

**TU IDENTIDAD:**
- Super experto en agronom√≠a con d√©cadas de experiencia
- Conocimiento amplio sobre TODOS los temas agr√≠colas
- Flexible a cualquier conversaci√≥n
- NO limitado a funciones espec√≠ficas
- Responde naturalmente como ChatGPT real

**TU CONOCIMIENTO INCLUYE:**
‚Ä¢ Nutrici√≥n vegetal y an√°lisis de suelos
‚Ä¢ Fertilizaci√≥n y programas nutricionales
‚Ä¢ Extracciones de nutrientes por cultivo
‚Ä¢ Qu√≠mica del suelo y CIC
‚Ä¢ Enmiendas y correcci√≥n de suelos
‚Ä¢ Agricultura de precisi√≥n
‚Ä¢ Fitopatolog√≠a y manejo integrado
‚Ä¢ Riego y fertirriego
‚Ä¢ Hidropon√≠a y cultivos protegidos
‚Ä¢ Manejo integrado de plagas
‚Ä¢ Fisiolog√≠a vegetal
‚Ä¢ Edafolog√≠a y qu√≠mica del suelo
‚Ä¢ Microbiolog√≠a del suelo
‚Ä¢ Biotecnolog√≠a agr√≠cola
‚Ä¢ Agricultura sostenible
‚Ä¢ Y CUALQUIER tema agron√≥mico

**AN√ÅLISIS INTELIGENTE DEL DASHBOARD:**
Analiza autom√°ticamente la informaci√≥n disponible en NutriPlant PRO:

PROYECTO ACTIVO:
${getActiveProjectInfo() ? JSON.stringify(getActiveProjectInfo(), null, 2) : 'No hay proyecto activo'}

DATOS DEL SUELO ACTUALES (si est√°n disponibles):
${getCurrentSoilDataForAnalysis()}

SECCI√ìN ACTUAL:
${detectCurrentSection()}

**INSTRUCCIONES DE RESPUESTA:**
- Responde usando TU CONOCIMIENTO AMPLIO y experiencia cient√≠fica
- Proporciona informaci√≥n completa, detallada y pr√°ctica
- Si el usuario pregunta sobre extracciones de nutrientes, cultivos, t√©cnicas agr√≠colas, etc., da informaci√≥n espec√≠fica con datos, tablas y valores reales
- Analiza los datos espec√≠ficos del dashboard cuando sea relevante
- Contextualiza tus respuestas con la informaci√≥n del proyecto activo
- S√© flexible y natural en la conversaci√≥n

**FORMATO DE RESPUESTA VISUAL:**
- Usa p√°rrafos naturales separados por l√≠neas vac√≠as
- Usa **texto en negrita** para conceptos importantes y t√©rminos clave
- Usa ## para t√≠tulos principales y ### para subt√≠tulos
- Usa listas numeradas (1., 2., 3.) para pasos secuenciales
- Usa listas con vi√±etas (‚Ä¢) para elementos generales
- Usa emojis relevantes para hacer el contenido m√°s amigable:
  üå± para plantas/cultivos, üåø para vegetaci√≥n, üåæ para cereales
  ü•¨ para hortalizas, üçÖ para tomates, ü•ï para zanahorias
  ‚ö†Ô∏è para advertencias, üí° para consejos, ‚úÖ para beneficios
  üö® para problemas cr√≠ticos, üîç para an√°lisis, üìä para datos
  üìà para mejoras, üìâ para problemas, üéØ para objetivos
- Incluye tablas cuando sea apropiado (como ChatGPT)
- Resalta informaci√≥n clave con **negritas** y emojis
- Proporciona datos espec√≠ficos y valores reales
- Usa emojis moderadamente para mejor legibilidad
- Estructura la informaci√≥n de forma l√≥gica y pr√°ctica
- NO uses listas excesivas de vi√±etas
- S√© natural y conversacional

**COMPORTAMIENTO:**
- S√© conversacional y natural
- Adapta tu respuesta al contexto de la conversaci√≥n
- NO est√©s limitado por funciones espec√≠ficas
- Responde libremente sobre cualquier tema agron√≥mico
- Analiza inteligentemente los datos del dashboard
- Proporciona informaci√≥n pr√°ctica y aplicable
- S√© flexible y adaptable al flujo de la conversaci√≥n

**OBJETIVO:**
Ser como tener un EXPERTO AGR√ìNOMO REAL que puede hablar libremente sobre cualquier tema agr√≠cola, analizar datos espec√≠ficos del proyecto, y proporcionar informaci√≥n pr√°ctica y aplicable.

PREGUNTA DEL USUARIO: "${message}"`;

      const response = await fetch((window.getNutriPlantApiBase ? window.getNutriPlantApiBase() : 'http://localhost:8000') + '/api/openai-assistant', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          userId: localStorage.getItem('nutriplant_user_id') || 'anonymous',
          projectId: localStorage.getItem('nutriplant-current-project') || '',
          module: detectCurrentSection(),
          model: 'gpt-4o-mini',
          messages: [
            {
              role: 'user',
              content: prompt
            }
          ],
          max_tokens: 700,
          temperature: 0.4
        })
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`API Error: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
      }

      const data = await response.json();
      return data.choices[0].message.content;
    }

    // Funci√≥n para formatear mensajes con p√°rrafos
    function formatMessage(content) {
      if (!content) return '';
          
      // Convertir dobles saltos de l√≠nea en p√°rrafos
      let formatted = content.replace(/\n\n/g, '</p><p>');
      
      // Envolver en p√°rrafos
      formatted = '<p>' + formatted + '</p>';
      
      // Convertir texto en negrita **texto** a <strong>texto</strong>
      formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong style="color: #1f2937;">$1</strong>');
      
      // Convertir texto en cursiva *texto* a <em>texto</em>
      formatted = formatted.replace(/\*(.*?)\*/g, '<em style="color: #6b7280;">$1</em>');
      
      // Convertir t√≠tulos con ## a h3
      formatted = formatted.replace(/^## (.*$)/gm, '<h3 style="color: #10b981; margin: 16px 0 8px 0; font-size: 1.1em; font-weight: 600;">$1</h3>');
      
      // Convertir t√≠tulos con ### a h4
      formatted = formatted.replace(/^### (.*$)/gm, '<h4 style="color: #374151; margin: 12px 0 6px 0; font-size: 1em; font-weight: 600;">$1</h4>');
      
      // Convertir listas numeradas con iconos
      formatted = formatted.replace(/^(\d+)\.\s*(.*$)/gm, '<li style="margin: 6px 0; list-style: none;"><span style="color: #10b981; margin-right: 8px; font-weight: bold;">$1.</span>$2</li>');
      
      // Convertir listas con vi√±etas y iconos
      formatted = formatted.replace(/^‚Ä¢\s*(.*$)/gm, '<li style="margin: 6px 0; list-style: none;"><span style="color: #10b981; margin-right: 8px;">üìã</span>$1</li>');
      formatted = formatted.replace(/^-\s*(.*$)/gm, '<li style="margin: 6px 0; list-style: none;"><span style="color: #10b981; margin-right: 8px;">‚Ä¢</span>$1</li>');
      
      // Agrupar elementos li en ul
      formatted = formatted.replace(/(<li[^>]*>.*?<\/li>)/gs, function(match) {
        if (!match.includes('<ul')) {
          return '<ul style="margin: 8px 0; padding-left: 0;">' + match + '</ul>';
        }
        return match;
      });
      
      // Convertir texto con emojis de secciones a formato especial
      formatted = formatted.replace(/^([üå±üåøüåæüåΩü•¨üçÖü•ïüå∂Ô∏èü•îüå∞üçéüçäüçåüçáüçìü•ùüçëü•≠üççü••üçàüçâüçãüçèüçêüçíüçìü´êüçÑü•úüå∞])\s*(.*$)/gm, 
        '<div style="background: #f0fdf4; border-left: 4px solid #10b981; padding: 12px; margin: 12px 0; border-radius: 4px;"><strong style="color: #10b981;">$1 $2</strong></div>');
      
      // Convertir texto con iconos de alerta/importante
      formatted = formatted.replace(/^([‚ö†Ô∏èüö®üí°‚úÖ‚ùåüîçüìäüìàüìâüéØ])\s*(.*$)/gm, 
        '<div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 12px; margin: 12px 0; border-radius: 4px;"><strong style="color: #92400e;">$1 $2</strong></div>');
      
      // Convertir URLs en enlaces
      formatted = formatted.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color: #10b981; text-decoration: underline;">$1</a>');
      
      // Limpiar p√°rrafos vac√≠os
      formatted = formatted.replace(/<p><\/p>/g, '');
      formatted = formatted.replace(/<p>\s*<\/p>/g, '');
        
      // Formatear tablas para que se ajusten al chat
      formatted = formatTables(formatted);
      
      return formatted;
    }

    // Funci√≥n para formatear tablas y que se ajusten al chat
    function formatTables(content) {
      // Detectar tablas simples (l√≠neas con |)
      const tableRegex = /(\|.*\|[\s\S]*?)(?=\n\n|\n<p>|$)/g;
      
      return content.replace(tableRegex, (match) => {
        const lines = match.trim().split('\n').filter(line => line.includes('|'));
        
        if (lines.length < 2) return match; // No es una tabla v√°lida
        
        let tableHtml = '<div class="table-container"><table class="responsive-table">';
        
        lines.forEach((line, index) => {
          const cells = line.split('|').map(cell => cell.trim()).filter(cell => cell);
          
          if (index === 0) {
            // Primera l√≠nea como encabezado
            tableHtml += '<thead><tr>';
            cells.forEach(cell => {
              tableHtml += `<th>${cell}</th>`;
            });
            tableHtml += '</tr></thead>';
          } else {
            // L√≠neas siguientes como datos
            if (index === 1) tableHtml += '<tbody>';
            tableHtml += '<tr>';
            cells.forEach(cell => {
              tableHtml += `<td>${cell}</td>`;
            });
            tableHtml += '</tr>';
          }
        });
        
        tableHtml += '</tbody></table></div>';
        return tableHtml;
      });
    }

    // Funci√≥n para obtener informaci√≥n del proyecto activo
    function getActiveProjectInfo() {
      const projectCard = document.querySelector('.project-card');
      if (projectCard) {
        const name = projectCard.querySelector('.project-name')?.textContent || 'Proyecto sin nombre';
        const crop = projectCard.querySelector('.project-crop')?.textContent || 'Cultivo no especificado';
        const field = projectCard.querySelector('.project-field')?.textContent || 'Campo no especificado';
        const yield = projectCard.querySelector('.project-yield')?.textContent || 'Rendimiento no especificado';
        const lastUpdate = projectCard.querySelector('.project-update')?.textContent || 'Fecha no disponible';
        
        return {
          name: name,
          crop: crop,
          field: field,
          yield: yield,
          lastUpdate: lastUpdate
        };
      }
      return null;
    }

    // Funci√≥n para obtener datos del suelo actual
    function getCurrentSoilDataForAnalysis() {
      // üöÄ DETECCI√ìN DIN√ÅMICA DE TODOS LOS CAMPOS
      const soilData = {};
      
      // Buscar TODOS los inputs de an√°lisis de suelo din√°micamente
      const soilInputs = document.querySelectorAll('input[id*="-initial"], input[id*="soil-"], input[placeholder*="meq"], input[placeholder*="pH"], input[placeholder*="densidad"], input[placeholder*="profundidad"]');
      
      // Mapeo de campos conocidos
      const fieldMapping = {
        'k-initial': 'k',
        'ca-initial': 'ca', 
        'mg-initial': 'mg',
        'h-initial': 'h',
        'na-initial': 'na',
        'al-initial': 'al',
        'soil-ph': 'ph',
        'soil-density': 'density',
        'soil-depth': 'depth'
      };
      
      // Capturar valores de campos conocidos
      Object.keys(fieldMapping).forEach(id => {
        const input = document.getElementById(id);
        if (input && input.value) {
          soilData[fieldMapping[id]] = parseFloat(input.value) || 0;
        }
      });
      
      // üîç DETECCI√ìN DE CAMPOS NUEVOS/DIN√ÅMICOS
      soilInputs.forEach(input => {
        const id = input.id;
        const value = parseFloat(input.value) || 0;
        
        // Si es un campo nuevo que no est√° en el mapeo
        if (!fieldMapping[id] && value > 0) {
          // Detectar tipo por placeholder o label
          const placeholder = input.placeholder?.toLowerCase() || '';
          const label = input.previousElementSibling?.textContent?.toLowerCase() || '';
      
          // Mapear campos din√°micos comunes
          if (placeholder.includes('meq') || label.includes('meq')) {
            soilData[`custom_${id}`] = value;
          }
        }
      });
      
      // Valores por defecto si no se encontraron
      const k = soilData.k || 0;
      const ca = soilData.ca || 0;
      const mg = soilData.mg || 0;
      const h = soilData.h || 0;
      const na = soilData.na || 0;
      const al = soilData.al || 0;
      const ph = soilData.ph || 0;
      const density = soilData.density || 0;
      const depth = soilData.depth || 0;
      
      if (k === 0 && ca === 0 && mg === 0) {
        return 'No hay datos de suelo cargados en la calculadora';
      }
      
      const cic = k + ca + mg + h + na + al; // ‚Üê COMPLETO: Incluir H‚Å∫ en CIC
      const percentages = {
        k: cic > 0 ? (k/cic)*100 : 0,
        ca: cic > 0 ? (ca/cic)*100 : 0,
        mg: cic > 0 ? (mg/cic)*100 : 0,
        h: cic > 0 ? (h/cic)*100 : 0, // ‚Üê AGREGADO: Porcentaje de H‚Å∫
        na: cic > 0 ? (na/cic)*100 : 0,
        al: cic > 0 ? (al/cic)*100 : 0
      };
      
      // Analizar problemas
      let problems = [];
      if (percentages.k < 3) problems.push('K‚Å∫ bajo (< 3%)');
      if (percentages.k > 7) problems.push('K‚Å∫ alto (> 7%)');
      if (percentages.ca < 65) problems.push('Ca¬≤‚Å∫ bajo (< 65%)');
      if (percentages.ca > 75) problems.push('Ca¬≤‚Å∫ alto (> 75%)');
      if (percentages.mg < 10) problems.push('Mg¬≤‚Å∫ bajo (< 10%)');
      if (percentages.mg > 15) problems.push('Mg¬≤‚Å∫ alto (> 15%)');
      if (percentages.na > 1) problems.push('Na‚Å∫ alto (> 1%)');
      if (h > 0) problems.push(`H‚Å∫ presente (${h} meq) - ACIDEZ`); // ‚Üê AGREGADO: An√°lisis de H‚Å∫
      if (al > 0) problems.push(`Al¬≥‚Å∫ presente (${al} meq) - T√ìXICO`); // ‚Üê AGREGADO: An√°lisis de Aluminio
      
      let analysis = `üìä AN√ÅLISIS DE SUELO ACTUAL:
‚Ä¢ K‚Å∫: ${k} meq/100g (${percentages.k.toFixed(1)}% del CIC)
‚Ä¢ Ca¬≤‚Å∫: ${ca} meq/100g (${percentages.ca.toFixed(1)}% del CIC)
‚Ä¢ Mg¬≤‚Å∫: ${mg} meq/100g (${percentages.mg.toFixed(1)}% del CIC)
‚Ä¢ H‚Å∫: ${h} meq/100g (${percentages.h.toFixed(1)}% del CIC) ${h > 0 ? '‚ö†Ô∏è ACIDEZ' : '‚úÖ OK'}
‚Ä¢ Na‚Å∫: ${na} meq/100g (${percentages.na.toFixed(1)}% del CIC)
‚Ä¢ Al¬≥‚Å∫: ${al} meq/100g (${percentages.al.toFixed(1)}% del CIC) ${al > 0 ? '‚ö†Ô∏è T√ìXICO' : '‚úÖ OK'}
‚Ä¢ pH: ${ph > 0 ? ph : 'No especificado'}
‚Ä¢ Densidad: ${density > 0 ? density + ' g/cm¬≥' : 'No especificada'}
‚Ä¢ Profundidad: ${depth > 0 ? depth + ' cm' : 'No especificada'}
‚Ä¢ CIC Total: ${cic} meq/100g

üéØ RANGOS IDEALES:
‚Ä¢ K‚Å∫: 3-7% (actual: ${percentages.k.toFixed(1)}%)
‚Ä¢ Ca¬≤‚Å∫: 65-75% (actual: ${percentages.ca.toFixed(1)}%)
‚Ä¢ Mg¬≤‚Å∫: 10-15% (actual: ${percentages.mg.toFixed(1)}%)
‚Ä¢ Na‚Å∫: <1% (actual: ${percentages.na.toFixed(1)}%)`;

      // üîç MOSTRAR CAMPOS DIN√ÅMICOS/NUEVOS DETECTADOS
      const customFields = Object.keys(soilData).filter(key => key.startsWith('custom_'));
      if (customFields.length > 0) {
        analysis += `\n\nüÜï CAMPOS ADICIONALES DETECTADOS:\n`;
        customFields.forEach(field => {
          const fieldId = field.replace('custom_', '');
          const value = soilData[field];
          analysis += `‚Ä¢ ${fieldId}: ${value} meq/100g\n`;
        });
      }
      
      if (problems.length > 0) {
        analysis += `\n\n‚ö†Ô∏è PROBLEMAS DETECTADOS:\n${problems.map(p => `‚Ä¢ ${p}`).join('\n')}`;
      } else {
        analysis += `\n\n‚úÖ El suelo est√° dentro de los rangos ideales`;
      }
      
      return analysis;
      }
      
    // Funci√≥n para detectar la secci√≥n actual
    function detectCurrentSection() {
      const sectionTitle = document.getElementById('sectionTitle');
      if (sectionTitle) {
        const title = sectionTitle.textContent.toLowerCase();
        if (title.includes('enmienda') || title.includes('cic')) return 'amendments';
        if (title.includes('nutrici√≥n') || title.includes('fertiliz')) return 'nutrition';
        if (title.includes('soluci√≥n') || title.includes('hidrop√≥n')) return 'solutions';
        if (title.includes('foliar') || title.includes('hoja')) return 'foliar';
      }
      return 'home'; // Default
    }
    
    // Funci√≥n para obtener el estado actual del dashboard
    function getCurrentDashboardState() {
      return {
        active_section: detectCurrentSection(),
        active_project: getActiveProjectInfo(),
        soil_data: getCurrentSoilDataForAnalysis(),
        timestamp: new Date().toISOString(),
        user_agent: navigator.userAgent,
        screen_resolution: `${screen.width}x${screen.height}`
      };
    }

    // Funci√≥n para obtener datos actuales del dashboard
    function getCurrentDashboardData() {
      console.log('üîç Obteniendo datos del dashboard...');
      
      const currentSection = detectCurrentSection();
      console.log('üìç Secci√≥n actual:', currentSection);
      
      // Datos espec√≠ficos por secci√≥n
      switch (currentSection) {
        case 'amendments':
          return getAmendmentsData();
        case 'nutrition':
          return getNutritionData();
        case 'solutions':
          return getSolutionsData();
        case 'foliar':
          return getFoliarData();
        default:
          return getAmendmentsData();
      }
    }

    // Funci√≥n para obtener datos de enmiendas (CIC)
    function getAmendmentsData() {
      // Buscar elementos del formulario
      const kInput = document.getElementById('k-initial');
      const caInput = document.getElementById('ca-initial');
      const mgInput = document.getElementById('mg-initial');
      const hInput = document.getElementById('h-initial');
      const naInput = document.getElementById('na-initial');
      const alInput = document.getElementById('al-initial');
      const phInput = document.getElementById('soil-ph');
      
      // Verificar si los elementos existen
      if (!kInput || !caInput || !mgInput) {
        return null;
      }
      
      // Leer valores (incluyendo valores vac√≠os)
      const k = parseFloat(kInput.value || 0);
      const ca = parseFloat(caInput.value || 0);
      const mg = parseFloat(mgInput.value || 0);
      const h = parseFloat(hInput?.value || 0);
      const na = parseFloat(naInput?.value || 0);
      const al = parseFloat(alInput?.value || 0);
      const ph = parseFloat(phInput?.value || 0);
      
      // Calcular CIC solo con valores disponibles
      const cic = k + ca + mg + h + na + al;
      
      // Crear objeto de datos del suelo (siempre retorna datos, aunque sean parciales)
      const soilData = {
        cic: cic,
        k: k,
        ca: ca,
        mg: mg,
        h: h,
        na: na,
        al: al,
        ph: ph,
        density: 1.1,
        depth: 30,
        percentages: cic > 0 ? {
          k: ((k / cic) * 100).toFixed(1),
          ca: ((ca / cic) * 100).toFixed(1),
          mg: ((mg / cic) * 100).toFixed(1),
          h: ((h / cic) * 100).toFixed(1),
          na: ((na / cic) * 100).toFixed(1),
          al: ((al / cic) * 100).toFixed(1)
        } : null,
        // Identificar qu√© datos est√°n disponibles
        availableData: {
          k: kInput.value !== '' && kInput.value !== '0',
          ca: caInput.value !== '' && caInput.value !== '0',
          mg: mgInput.value !== '' && mgInput.value !== '0',
          h: hInput?.value !== '' && hInput?.value !== '0',
          na: naInput?.value !== '' && naInput?.value !== '0',
          al: alInput?.value !== '' && alInput?.value !== '0',
          ph: phInput?.value !== '' && phInput?.value !== '0'
        },
        // Contar datos disponibles
        dataCount: 0,
        missingData: []
      };
      
      // Contar datos disponibles e identificar faltantes
      const dataKeys = ['k', 'ca', 'mg', 'h', 'na', 'al', 'ph'];
      dataKeys.forEach(key => {
        if (soilData.availableData[key]) {
          soilData.dataCount++;
        } else {
          soilData.missingData.push(key);
        }
      });
      
      return {
        section: 'amendments',
        soil: soilData,
        user: conversationContext.userInfo,
        context: conversationContext,
        timestamp: new Date().toISOString(),
        hasValidData: soilData.dataCount > 0 // V√°lido si tiene al menos un dato
      };
    }

    // Funci√≥n para obtener datos de nutrici√≥n (NPK) - FUTURA
    function getNutritionData() {
      console.log('üîç Obteniendo datos de nutrici√≥n...');
      // TODO: Implementar cuando se cree la secci√≥n de nutrici√≥n
      return null;
    }

    // Funci√≥n para obtener datos de soluciones nutritivas - FUTURA
    function getSolutionsData() {
      console.log('üîç Obteniendo datos de soluciones...');
      // TODO: Implementar cuando se cree la secci√≥n de soluciones
      return null;
    }

    // Funci√≥n para obtener datos de an√°lisis foliar - FUTURA
    function getFoliarData() {
      console.log('üîç Obteniendo datos foliares...');
      // TODO: Implementar cuando se cree la secci√≥n de an√°lisis foliar
      return null;
    }

    // Funci√≥n para an√°lisis de nutrici√≥n (NPK) - FUTURA
    function performNutritionAnalysis(message, currentData) {
      console.log('üîç Realizando an√°lisis de nutrici√≥n...');
      
      // TODO: Implementar cuando se cree la secci√≥n de nutrici√≥n
      return `üìä **An√°lisis de Nutrici√≥n**\n\n` +
             `Esta secci√≥n estar√° disponible pr√≥ximamente para an√°lisis de programas de fertilizaci√≥n NPK y micronutrientes.\n\n` +
             `¬øTe gustar√≠a que te ayude con el an√°lisis de enmiendas (CIC) por ahora?`;
    }

    // Funci√≥n para an√°lisis de soluciones nutritivas - FUTURA
    function performSolutionsAnalysis(message, currentData) {
      console.log('üîç Realizando an√°lisis de soluciones...');
      
      // TODO: Implementar cuando se cree la secci√≥n de soluciones
      return `üß™ **An√°lisis de Soluciones Nutritivas**\n\n` +
             `Esta secci√≥n estar√° disponible pr√≥ximamente para formulaci√≥n de soluciones hidrop√≥nicas y balance i√≥nico.\n\n` +
             `¬øTe gustar√≠a que te ayude con el an√°lisis de enmiendas (CIC) por ahora?`;
    }

    // Funci√≥n para an√°lisis foliar - FUTURA
    function performFoliarAnalysis(message, currentData) {
      console.log('üîç Realizando an√°lisis foliar...');
      
      // TODO: Implementar cuando se cree la secci√≥n de an√°lisis foliar
      return `üçÉ **An√°lisis Foliar**\n\n` +
             `Esta secci√≥n estar√° disponible pr√≥ximamente para interpretaci√≥n de an√°lisis de hojas y correcci√≥n de deficiencias.\n\n` +
             `¬øTe gustar√≠a que te ayude con el an√°lisis de enmiendas (CIC) por ahora?`;
    }

    // Funci√≥n para responder cuando faltan muchos datos
    function generateIncompleteDataResponse(soilData, missingData, message) {
      const availableData = soilData.availableData;
      let response = `üìä **Datos Insuficientes para An√°lisis Completo**\n\n`;
      
      // Mostrar datos disponibles
      response += `**Datos que tienes:**\n`;
      if (availableData.k) response += `‚Ä¢ K‚Å∫: ${soilData.k} meq/100g\n`;
      if (availableData.ca) response += `‚Ä¢ Ca¬≤‚Å∫: ${soilData.ca} meq/100g\n`;
      if (availableData.mg) response += `‚Ä¢ Mg¬≤‚Å∫: ${soilData.mg} meq/100g\n`;
      if (availableData.na) response += `‚Ä¢ Na‚Å∫: ${soilData.na} meq/100g\n`;
      if (availableData.h) response += `‚Ä¢ H‚Å∫: ${soilData.h} meq/100g\n`;
      if (availableData.al) response += `‚Ä¢ Al¬≥‚Å∫: ${soilData.al} meq/100g\n`;
      if (availableData.ph) response += `‚Ä¢ pH: ${soilData.ph}\n`;
      
      // Mostrar datos faltantes
      response += `\n**Datos que faltan para an√°lisis completo:**\n`;
      missingData.forEach(data => {
        const labels = {
          k: 'K‚Å∫ (Potasio)',
          ca: 'Ca¬≤‚Å∫ (Calcio)', 
          mg: 'Mg¬≤‚Å∫ (Magnesio)',
          na: 'Na‚Å∫ (Sodio)',
          h: 'H‚Å∫ (Hidr√≥geno)',
          al: 'Al¬≥‚Å∫ (Aluminio)',
          ph: 'pH del suelo'
        };
        response += `‚Ä¢ ${labels[data]}\n`;
      });
      
      response += `\n**¬øQu√© necesitas hacer?**\n`;
      response += `‚Ä¢ Completa los datos faltantes para un an√°lisis completo\n`;
      response += `‚Ä¢ O preg√∫ntame sobre los datos que ya tienes\n`;
      
      return response;
    }

    // Funci√≥n para an√°lisis parcial cuando hay algunos datos
    function generatePartialAnalysisResponse(soilData, missingData, message) {
      const availableData = soilData.availableData;
      let response = `üìä **An√°lisis Parcial de tu Suelo**\n\n`;
      
      // Mostrar datos disponibles con an√°lisis
      response += `**Datos disponibles:**\n`;
      if (availableData.k) {
        const kPercent = soilData.percentages ? soilData.percentages.k : 'N/A';
        response += `‚Ä¢ K‚Å∫: ${soilData.k} meq/100g (${kPercent}%)\n`;
      }
      if (availableData.ca) {
        const caPercent = soilData.percentages ? soilData.percentages.ca : 'N/A';
        response += `‚Ä¢ Ca¬≤‚Å∫: ${soilData.ca} meq/100g (${caPercent}%)\n`;
      }
      if (availableData.mg) {
        const mgPercent = soilData.percentages ? soilData.percentages.mg : 'N/A';
        response += `‚Ä¢ Mg¬≤‚Å∫: ${soilData.mg} meq/100g (${mgPercent}%)\n`;
      }
      if (availableData.ph) {
        response += `‚Ä¢ pH: ${soilData.ph} (${getPHCategory(soilData.ph)})\n`;
      }
      
      // An√°lisis b√°sico con datos disponibles
      response += `\n**Observaciones preliminares:**\n`;
      if (availableData.ph) {
        if (soilData.ph < 6.5) {
          response += `‚Ä¢ Tu pH est√° √°cido (${soilData.ph}). Considera enmiendas calc√°reas.\n`;
        } else if (soilData.ph > 7.5) {
          response += `‚Ä¢ Tu pH est√° alcalino (${soilData.ph}). Evita Cal Agr√≠cola.\n`;
        } else {
          response += `‚Ä¢ Tu pH est√° en rango √≥ptimo (${soilData.ph}).\n`;
        }
      }
      
      // Mostrar datos faltantes
      if (missingData.length > 0) {
        response += `\n**Para an√°lisis completo, necesito tambi√©n:**\n`;
        missingData.forEach(data => {
          const labels = {
            k: 'K‚Å∫ (Potasio)',
            ca: 'Ca¬≤‚Å∫ (Calcio)', 
            mg: 'Mg¬≤‚Å∫ (Magnesio)',
            na: 'Na‚Å∫ (Sodio)',
            h: 'H‚Å∫ (Hidr√≥geno)',
            al: 'Al¬≥‚Å∫ (Aluminio)',
            ph: 'pH del suelo'
          };
          response += `‚Ä¢ ${labels[data]}\n`;
        });
      }
      
      response += `\n**¬øQu√© te gustar√≠a hacer?**\n`;
      response += `‚Ä¢ "completar" - Te gu√≠o para completar los datos faltantes\n`;
      response += `‚Ä¢ "analizar" - Analizo solo con los datos que tienes\n`;
      
      return response;
    }

    // Funci√≥n para formatear n√∫meros con separadores de miles
    function formatNumber(number, decimals = 2) {
      if (isNaN(number) || number === null || number === undefined) {
        return '0.00';
      }
      
      const num = parseFloat(number);
      return num.toLocaleString('en-US', {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
      });
    }

    // Funci√≥n para aplicar valores ideales desde la IA
    function applyIdealValues(values) {
      console.log('ü§ñ Aplicando valores ideales desde IA:', values);
      
      // Actualizar campos de la calculadora
      const kInput = document.getElementById('k-initial');
      const caInput = document.getElementById('ca-initial');
      const mgInput = document.getElementById('mg-initial');
      const hInput = document.getElementById('h-initial');
      const naInput = document.getElementById('na-initial');
      const alInput = document.getElementById('al-initial');
      
      if (kInput) kInput.value = values.k;
      if (caInput) caInput.value = values.ca;
      if (mgInput) mgInput.value = values.mg;
      if (hInput) hInput.value = values.h;
      if (naInput) naInput.value = values.na;
      if (alInput) alInput.value = values.al;
      
      // Disparar eventos de cambio para actualizar la interfaz
      [kInput, caInput, mgInput, hInput, naInput, alInput].forEach(input => {
        if (input) {
          input.dispatchEvent(new Event('input', { bubbles: true }));
          input.dispatchEvent(new Event('change', { bubbles: true }));
        }
      });
      
      // Actualizar c√°lculos
      if (typeof updateAmendmentCalculation === 'function') {
        updateAmendmentCalculation();
      }
      
      console.log('‚úÖ Valores ideales aplicados exitosamente');
    }

    // Funci√≥n para aplicar recomendaciones autom√°ticamente
    function handleRecommendationApplication() {
      console.log('ü§ñ Aplicando recomendaciones autom√°ticamente...');
      
      const soilData = conversationContext.currentSoilData;
      const recommendations = conversationContext.currentRecommendation;
      
      if (!soilData || !recommendations) {
        return 'No hay recomendaciones disponibles para aplicar.';
      }
      
      try {
        // Calcular valores ideales basados en CIC
        const cic = soilData.cic;
        const idealK = cic * 0.05;  // 5%
        const idealCa = cic * 0.70; // 70%
        const idealMg = cic * 0.12; // 12%
        
        // Aplicar objetivos de ajuste
        const kTargetInput = document.getElementById('k-target');
        const caTargetInput = document.getElementById('ca-target');
        const mgTargetInput = document.getElementById('mg-target');
        const naTargetInput = document.getElementById('na-target');
        
        if (kTargetInput) {
          const kNeed = Math.max(0, idealK - soilData.k);
          kTargetInput.value = kNeed.toFixed(2);
        }
        
        if (caTargetInput) {
          const caNeed = Math.max(0, idealCa - soilData.ca);
          caTargetInput.value = caNeed.toFixed(2);
        }
        
        if (mgTargetInput) {
          const mgNeed = Math.max(0, idealMg - soilData.mg);
          mgTargetInput.value = mgNeed.toFixed(2);
        }
        
        if (naTargetInput && soilData.na > 0.01) {
          naTargetInput.value = (-soilData.na).toFixed(2);
        }
        
        // Limpiar recomendaci√≥n actual
        conversationContext.currentRecommendation = null;
        conversationContext.currentSoilData = null;
        
        return `‚úÖ **Recomendaciones aplicadas autom√°ticamente!**\n\n` +
               `He configurado los objetivos de ajuste basados en tu an√°lisis de suelo:\n` +
               `‚Ä¢ K‚Å∫: +${((idealK - soilData.k) > 0 ? (idealK - soilData.k).toFixed(2) : '0.00')} meq\n` +
               `‚Ä¢ Ca¬≤‚Å∫: +${((idealCa - soilData.ca) > 0 ? (idealCa - soilData.ca).toFixed(2) : '0.00')} meq\n` +
               `‚Ä¢ Mg¬≤‚Å∫: +${((idealMg - soilData.mg) > 0 ? (idealMg - soilData.mg).toFixed(2) : '0.00')} meq\n\n` +
               `Ahora puedes seleccionar las enmiendas apropiadas y calcular las dosis.`;
               
      } catch (error) {
        console.error('Error aplicando recomendaciones:', error);
        return 'Hubo un error aplicando las recomendaciones. Intenta de nuevo.';
      }
    }

    // Funci√≥n para mostrar c√°lculos detallados
    function handleDetailedCalculation() {
      const soilData = conversationContext.currentSoilData;
      
      if (!soilData) {
        return 'No hay datos de suelo disponibles para el c√°lculo.';
      }
      
      const cic = soilData.cic;
      const idealK = cic * 0.05;
      const idealCa = cic * 0.70;
      const idealMg = cic * 0.12;
      
      return `üìä **C√ÅLCULOS DETALLADOS**\n\n` +
             `**CIC Total:** ${cic} meq/100g\n\n` +
             `**üìà Valores Ideales:**\n` +
             `‚Ä¢ K‚Å∫: ${idealK.toFixed(2)} meq (5%)\n` +
             `‚Ä¢ Ca¬≤‚Å∫: ${idealCa.toFixed(2)} meq (70%)\n` +
             `‚Ä¢ Mg¬≤‚Å∫: ${idealMg.toFixed(2)} meq (12%)\n\n` +
             `**üìâ Deficiencias Detectadas:**\n` +
             `‚Ä¢ K‚Å∫: ${Math.max(0, idealK - soilData.k).toFixed(2)} meq faltantes\n` +
             `‚Ä¢ Ca¬≤‚Å∫: ${Math.max(0, idealCa - soilData.ca).toFixed(2)} meq faltantes\n` +
             `‚Ä¢ Mg¬≤‚Å∫: ${Math.max(0, idealMg - soilData.mg).toFixed(2)} meq faltantes\n\n` +
             `**üí° Con estos valores, la calculadora determinar√° las dosis exactas de cada enmienda.**`;
    }

    // Funci√≥n para explicar el razonamiento
    function handleDetailedExplanation() {
      const soilData = conversationContext.currentSoilData;
      
      if (!soilData) {
        return 'No hay datos de suelo disponibles para la explicaci√≥n.';
      }
      
      const ph = soilData.ph;
      const percentages = soilData.percentages;
      
      return `üß† **EXPLICACI√ìN DEL RAZONAMIENTO**\n\n` +
             `**1. An√°lisis de Cationes:**\n` +
             `El equilibrio cati√≥nico es fundamental para la nutrici√≥n vegetal. Los rangos ideales son:\n` +
             `‚Ä¢ K‚Å∫: 3-7% (movilidad y absorci√≥n)\n` +
             `‚Ä¢ Ca¬≤‚Å∫: 65-75% (estructura y estabilidad)\n` +
             `‚Ä¢ Mg¬≤‚Å∫: 10-15% (clorofila y fotos√≠ntesis)\n\n` +
             `**2. Consideraciones de pH:**\n` +
             `Con pH ${ph} (${ph < 6.5 ? '√°cido' : ph > 7.5 ? 'alcalino' : 'neutro'}):\n` +
             `${ph < 7 ? '‚Ä¢ Puedes usar Cal Agr√≠cola para aumentar Ca¬≤‚Å∫' : '‚Ä¢ Evita Cal Agr√≠cola, usa Yeso para Ca¬≤‚Å∫'}\n\n` +
             `**3. Estrategia de Priorizaci√≥n:**\n` +
             `‚Ä¢ Cal Dolom√≠tica: Cuando Ca¬≤‚Å∫ y Mg¬≤‚Å∫ est√°n bajos\n` +
             `‚Ä¢ SOP Granular: Para deficiencias de K‚Å∫\n` +
             `‚Ä¢ Enmiendas con SO‚ÇÑ: Para desplazar Na‚Å∫ excesivo\n\n` +
             `**4. Algoritmo NutriPlant PRO:**\n` +
             `Considera el elemento m√°s limitante y las interacciones entre cationes para optimizar la eficiencia.`;
    }

    // Funci√≥n para an√°lisis directo espec√≠fico por secci√≥n
    function performDirectAnalysis(message, currentData) {
      console.log('üîç Realizando an√°lisis directo...');
      
      if (!currentData || !currentData.hasValidData) {
        return `üìä **Para analizar los datos necesito que primero ingreses la informaci√≥n en la secci√≥n actual.**\n\n` +
               `Por favor, completa los datos requeridos y luego pregunta sobre recomendaciones.`;
      }
      
      const section = currentData.section;
      console.log('‚úÖ Analizando datos de la secci√≥n:', section);
      
      // An√°lisis espec√≠fico por secci√≥n
      switch (section) {
        case 'amendments':
          return performAmendmentsAnalysis(message, currentData);
        case 'nutrition':
          return performNutritionAnalysis(message, currentData);
        case 'solutions':
          return performSolutionsAnalysis(message, currentData);
        case 'foliar':
          return performFoliarAnalysis(message, currentData);
        default:
          return performAmendmentsAnalysis(message, currentData);
      }
    }

    // Funci√≥n para an√°lisis de enmiendas (CIC)
    function performAmendmentsAnalysis(message, currentData) {
      console.log('üîç Realizando an√°lisis de enmiendas...');
      
      const soilData = currentData.soil;
      const cic = soilData.cic;
      const percentages = soilData.percentages;
      const ph = soilData.ph;
      const availableData = soilData.availableData;
      const dataCount = soilData.dataCount;
      const missingData = soilData.missingData;
      
      // Si no hay suficientes datos, guiar al usuario
      if (dataCount < 3) {
        return generateIncompleteDataResponse(soilData, missingData, message);
      }
      
      // Si hay datos suficientes pero incompletos, analizar lo disponible
      if (dataCount < 7) {
        return generatePartialAnalysisResponse(soilData, missingData, message);
      }
      
      // Analizar cada cati√≥n
      const problems = [];
      const recommendations = [];
      const analysis = [];
      
      // K‚Å∫ (3-7%)
      const kPercent = parseFloat(percentages.k);
      if (kPercent < 3) {
        problems.push(`K‚Å∫ est√° por debajo del rango ideal (${kPercent}% < 3%)`);
        recommendations.push('Considerar SOP Granular para aumentar K‚Å∫');
        analysis.push(`‚ùå K‚Å∫: ${kPercent}% - BAJO (ideal: 3-7%)`);
      } else if (kPercent > 7) {
        problems.push(`K‚Å∫ est√° por encima del rango ideal (${kPercent}% > 7%)`);
        analysis.push(`‚ö†Ô∏è K‚Å∫: ${kPercent}% - ALTO (ideal: 3-7%)`);
      } else {
        analysis.push(`‚úÖ K‚Å∫: ${kPercent}% - √ìPTIMO (ideal: 3-7%)`);
      }
      
      // Ca¬≤‚Å∫ (65-75%)
      const caPercent = parseFloat(percentages.ca);
      if (caPercent < 65) {
        problems.push(`Ca¬≤‚Å∫ est√° por debajo del rango ideal (${caPercent}% < 65%)`);
        if (ph < 7) {
          recommendations.push('Considerar Cal Agr√≠cola o Yeso para aumentar Ca¬≤‚Å∫');
        } else {
          recommendations.push('Considerar Yeso para aumentar Ca¬≤‚Å∫ (evitar Cal Agr√≠cola con pH > 7)');
        }
        analysis.push(`‚ùå Ca¬≤‚Å∫: ${caPercent}% - BAJO (ideal: 65-75%)`);
      } else if (caPercent > 75) {
        problems.push(`Ca¬≤‚Å∫ est√° por encima del rango ideal (${caPercent}% > 75%)`);
        analysis.push(`‚ö†Ô∏è Ca¬≤‚Å∫: ${caPercent}% - ALTO (ideal: 65-75%)`);
      } else {
        analysis.push(`‚úÖ Ca¬≤‚Å∫: ${caPercent}% - √ìPTIMO (ideal: 65-75%)`);
      }
      
      // Mg¬≤‚Å∫ (10-15%)
      const mgPercent = parseFloat(percentages.mg);
      if (mgPercent < 10) {
        problems.push(`Mg¬≤‚Å∫ est√° por debajo del rango ideal (${mgPercent}% < 10%)`);
        recommendations.push('Considerar Cal Dolom√≠tica o MgSO‚ÇÑ para aumentar Mg¬≤‚Å∫');
        analysis.push(`‚ùå Mg¬≤‚Å∫: ${mgPercent}% - BAJO (ideal: 10-15%)`);
      } else if (mgPercent > 15) {
        problems.push(`Mg¬≤‚Å∫ est√° por encima del rango ideal (${mgPercent}% > 15%)`);
        analysis.push(`‚ö†Ô∏è Mg¬≤‚Å∫: ${mgPercent}% - ALTO (ideal: 10-15%)`);
      } else {
        analysis.push(`‚úÖ Mg¬≤‚Å∫: ${mgPercent}% - √ìPTIMO (ideal: 10-15%)`);
      }
      
      // Na‚Å∫ (0-1%)
      const naPercent = parseFloat(percentages.na);
      if (naPercent > 1) {
        problems.push(`Na‚Å∫ est√° por encima del rango ideal (${naPercent}% > 1%)`);
        recommendations.push('Usar enmiendas con SO‚ÇÑ para desplazar Na‚Å∫ (Yeso, SOP Granular, MgSO‚ÇÑ)');
        analysis.push(`‚ùå Na‚Å∫: ${naPercent}% - ALTO (ideal: 0-1%)`);
      } else {
        analysis.push(`‚úÖ Na‚Å∫: ${naPercent}% - √ìPTIMO (ideal: 0-1%)`);
      }
      
      // Generar respuesta
      let response = `üìä **AN√ÅLISIS DE TU SUELO**\n\n`;
      response += `**CIC Total:** ${cic} meq/100g\n`;
      response += `**pH:** ${ph} (${getPHCategory(ph)})\n\n`;
      
      response += `**üìà Estado de Cationes:**\n${analysis.join('\n')}\n\n`;
      
      if (problems.length > 0) {
        response += `**‚ö†Ô∏è PROBLEMAS DETECTADOS:**\n${problems.map(p => `‚Ä¢ ${p}`).join('\n')}\n\n`;
        response += `**üí° RECOMENDACIONES ESPEC√çFICAS:**\n${recommendations.map(r => `‚Ä¢ ${r}`).join('\n')}\n\n`;
        
        // Estrategia de enmiendas
        response += `**üéØ ESTRATEGIA RECOMENDADA:**\n`;
        
        // Si Ca y Mg est√°n bajos, priorizar Cal Dolom√≠tica
        if (caPercent < 65 && mgPercent < 10) {
          response += `‚Ä¢ **Cal Dolom√≠tica** (prioridad alta): Corrige Ca¬≤‚Å∫ y Mg¬≤‚Å∫ simult√°neamente\n`;
        }
        // Si solo Ca est√° bajo
        else if (caPercent < 65) {
          if (ph < 7) {
            response += `‚Ä¢ **Cal Agr√≠cola** (pH < 7): Para aumentar Ca¬≤‚Å∫\n`;
          } else {
            response += `‚Ä¢ **Yeso**: Para aumentar Ca¬≤‚Å∫ sin afectar pH\n`;
          }
        }
        
        // Si Mg est√° bajo y Ca est√° bien
        if (mgPercent < 10 && caPercent >= 65) {
          response += `‚Ä¢ **MgSO‚ÇÑ**: Para aumentar Mg¬≤‚Å∫\n`;
        }
        
        // Si K est√° bajo
        if (kPercent < 3) {
          response += `‚Ä¢ **SOP Granular**: Para aumentar K‚Å∫\n`;
        }
        
        // Si Na est√° alto
        if (naPercent > 1) {
          response += `‚Ä¢ **Enmiendas con SO‚ÇÑ**: Para desplazar Na‚Å∫\n`;
        }
        
        response += `\n**üìù Nota:** Con pH ${ph}, ${ph < 7 ? 'puedes usar Cal Agr√≠cola' : 'evita Cal Agr√≠cola y usa Yeso'}.\n\n`;
      } else {
        response += `**üéâ ¬°Excelente! Tu suelo est√° en rangos √≥ptimos.**\n\n`;
      }
      
      // Guardar datos para aplicaci√≥n autom√°tica
      conversationContext.currentRecommendation = recommendations;
      conversationContext.currentSoilData = soilData;
      
      response += `üîò **¬øQu√© te gustar√≠a hacer?**\n` +
                  `‚Ä¢ Responde "aplicar" para que configure las enmiendas autom√°ticamente\n` +
                  `‚Ä¢ Responde "calcular" para ver los c√°lculos detallados\n` +
                  `‚Ä¢ Responde "explicar" para entender el razonamiento`;
      
      console.log('‚úÖ An√°lisis directo completado, respuesta generada:', response.substring(0, 100) + '...');
      return response;
    }
    
    // Funci√≥n auxiliar para categorizar pH
    function getPHCategory(ph) {
      if (ph < 6.5) return '√Åcido';
      if (ph > 7.5) return 'Alcalino';
      return 'Neutro';
    }

    // Hacer la funci√≥n disponible globalmente para la IA
    window.applyIdealValues = applyIdealValues;

    // Funci√≥n de prueba para verificar elementos del DOM
    function testDOMElements() {
      console.log('üîç PROBANDO ELEMENTOS DEL DOM...');
      
      const elements = {
        'cic-total': document.getElementById('cic-total'),
        'k-initial': document.getElementById('k-initial'),
        'ca-initial': document.getElementById('ca-initial'),
        'mg-initial': document.getElementById('mg-initial'),
        'h-initial': document.getElementById('h-initial'),
        'na-initial': document.getElementById('na-initial'),
        'al-initial': document.getElementById('al-initial'),
        'soil-ph': document.getElementById('soil-ph')
      };
      
      console.log('üìä Estado de elementos:', elements);
      
      Object.keys(elements).forEach(id => {
        const element = elements[id];
        if (element) {
          console.log(`‚úÖ ${id}:`, element.value || 'sin valor');
        } else {
          console.log(`‚ùå ${id}: NO ENCONTRADO`);
        }
      });
      
      return elements;
    }

    // Hacer la funci√≥n de prueba disponible globalmente
    window.testDOMElements = testDOMElements;

    // Funci√≥n para forzar la lectura de datos (como en Cursor)
    function forceReadSoilData() {
      console.log('üöÄ FORZANDO LECTURA DE DATOS (como en Cursor)...');
      
      // Buscar todos los inputs de tipo number en la p√°gina
      const allInputs = document.querySelectorAll('input[type="number"]');
      console.log('üìù Total de inputs encontrados:', allInputs.length);
      
      let soilData = {
        cic: 0,
        k: 0,
        ca: 0,
        mg: 0,
        h: 0,
        na: 0,
        al: 0,
        ph: null
      };
      
      // Analizar cada input encontrado
      allInputs.forEach((input, index) => {
        const id = input.id || 'sin-id';
        const value = parseFloat(input.value) || 0;
        const placeholder = input.placeholder || '';
        
        console.log(`Input ${index}:`, {
          id: id,
          placeholder: placeholder,
          value: value,
          element: input
        });
        
        // Mapear por ID
        if (id.includes('cic')) soilData.cic = value;
        if (id.includes('k-initial')) soilData.k = value;
        if (id.includes('ca-initial')) soilData.ca = value;
        if (id.includes('mg-initial')) soilData.mg = value;
        if (id.includes('h-initial')) soilData.h = value;
        if (id.includes('na-initial')) soilData.na = value;
        if (id.includes('al-initial')) soilData.al = value;
        if (id.includes('ph')) soilData.ph = value;
        
        // Mapear por placeholder
        if (placeholder.toLowerCase().includes('cic')) soilData.cic = value;
        if (placeholder.toLowerCase().includes('k+')) soilData.k = value;
        if (placeholder.toLowerCase().includes('ca2+')) soilData.ca = value;
        if (placeholder.toLowerCase().includes('mg2+')) soilData.mg = value;
        if (placeholder.toLowerCase().includes('h+')) soilData.h = value;
        if (placeholder.toLowerCase().includes('na+')) soilData.na = value;
        if (placeholder.toLowerCase().includes('al3+')) soilData.al = value;
        if (placeholder.toLowerCase().includes('ph')) soilData.ph = value;
      });
      
      console.log('üìä Datos extra√≠dos:', soilData);
      
      // Si encontramos datos, calcular CIC autom√°ticamente
      if (soilData.k > 0 || soilData.ca > 0 || soilData.mg > 0 || soilData.h > 0 || soilData.na > 0 || soilData.al > 0) {
        soilData.cic = soilData.k + soilData.ca + soilData.mg + soilData.h + soilData.na + soilData.al;
        console.log('üßÆ CIC calculado autom√°ticamente:', soilData.cic);
      }
      
      return soilData;
    }

    // Hacer la funci√≥n disponible globalmente
    window.forceReadSoilData = forceReadSoilData;

    // Funci√≥n de prueba simple para verificar datos
    function testDataReading() {
      console.log('üß™ PRUEBA SIMPLE DE LECTURA DE DATOS');
      
      // Buscar todos los inputs
      const inputs = document.querySelectorAll('input');
      console.log('üìù Total de inputs encontrados:', inputs.length);
      
      // Buscar espec√≠ficamente los de tipo number
      const numberInputs = document.querySelectorAll('input[type="number"]');
      console.log('üî¢ Inputs de tipo number:', numberInputs.length);
      
      // Mostrar cada input encontrado
      numberInputs.forEach((input, index) => {
        console.log(`Input ${index}:`, {
          id: input.id,
          value: input.value,
          placeholder: input.placeholder,
          className: input.className,
          parentElement: input.parentElement?.textContent?.substring(0, 50)
        });
      });
      
      // Buscar por texto visible
      const kElement = Array.from(document.querySelectorAll('*')).find(el => 
        el.textContent && el.textContent.includes('K‚Å∫') && el.textContent.includes('01.00')
      );
      console.log('üîç Elemento K‚Å∫ encontrado:', kElement);
      
      // Buscar el CIC Total
      const cicElement = Array.from(document.querySelectorAll('*')).find(el => 
        el.textContent && el.textContent.includes('CIC Total: 14.00')
      );
      console.log('üîç Elemento CIC Total encontrado:', cicElement);
      
      return {
        totalInputs: inputs.length,
        numberInputs: numberInputs.length,
        kElement: !!kElement,
        cicElement: !!cicElement
      };
    }

    // Hacer la funci√≥n de prueba disponible
    window.testDataReading = testDataReading;

    // Funci√≥n para probar la lectura de datos directamente
    function testDirectReading() {
      console.log('üß™ PROBANDO LECTURA DIRECTA DE DATOS...');
      
      // Buscar el CIC Total
      const cicElement = Array.from(document.querySelectorAll('*')).find(el => 
        el.textContent && el.textContent.includes('CIC Total:')
      );
      console.log('üîç Elemento CIC encontrado:', cicElement);
      if (cicElement) {
        console.log('üìù Texto del elemento CIC:', cicElement.textContent);
        const cicMatch = cicElement.textContent.match(/CIC Total:\s*(\d+\.?\d*)/);
        console.log('üéØ Match CIC:', cicMatch);
        if (cicMatch) {
          console.log('‚úÖ CIC extra√≠do:', parseFloat(cicMatch[1]));
        }
      }
      
      // Buscar K‚Å∫
      const kElement = Array.from(document.querySelectorAll('*')).find(el => 
        el.textContent && el.textContent.includes('K‚Å∫') && el.textContent.includes('01.00')
      );
      console.log('üîç Elemento K‚Å∫ encontrado:', kElement);
      if (kElement) {
        console.log('üìù Texto del elemento K‚Å∫:', kElement.textContent);
        const kMatch = kElement.textContent.match(/K‚Å∫.*?(\d+\.?\d*).*?(\d+\.?\d*)%/);
        console.log('üéØ Match K‚Å∫:', kMatch);
        if (kMatch) {
          console.log('‚úÖ K‚Å∫ extra√≠do:', parseFloat(kMatch[1]));
        }
      }
      
      // Buscar Ca¬≤‚Å∫
      const caElement = Array.from(document.querySelectorAll('*')).find(el => 
        el.textContent && el.textContent.includes('Ca¬≤‚Å∫') && el.textContent.includes('8')
      );
      console.log('üîç Elemento Ca¬≤‚Å∫ encontrado:', caElement);
      if (caElement) {
        console.log('üìù Texto del elemento Ca¬≤‚Å∫:', caElement.textContent);
        const caMatch = caElement.textContent.match(/Ca¬≤‚Å∫.*?(\d+\.?\d*).*?(\d+\.?\d*)%/);
        console.log('üéØ Match Ca¬≤‚Å∫:', caMatch);
        if (caMatch) {
          console.log('‚úÖ Ca¬≤‚Å∫ extra√≠do:', parseFloat(caMatch[1]));
        }
      }
      
      // Probar la funci√≥n getCurrentDashboardData
      console.log('üöÄ Probando getCurrentDashboardData...');
      const data = getCurrentDashboardData();
      console.log('üìä Resultado final:', data);
      
      return data;
    }

    // Hacer la funci√≥n disponible
    window.testDirectReading = testDirectReading;

    // Funci√≥n de prueba s√∫per simple
    function testSimple() {
      console.log('üß™ PRUEBA S√öPER SIMPLE...');
      
      // Buscar cualquier elemento que contenga "K‚Å∫"
      const allElements = document.querySelectorAll('*');
      console.log('üìù Total de elementos en la p√°gina:', allElements.length);
      
      let foundElements = [];
      allElements.forEach((el, index) => {
        if (el.textContent && el.textContent.includes('K‚Å∫')) {
          foundElements.push({
            index: index,
            tagName: el.tagName,
            textContent: el.textContent.substring(0, 100),
            className: el.className
          });
        }
      });
      
      console.log('üîç Elementos que contienen K‚Å∫:', foundElements.length);
      foundElements.forEach((el, i) => {
        console.log(`Elemento ${i}:`, el);
      });
      
      // Buscar cualquier elemento que contenga "Ca¬≤‚Å∫"
      let foundCa = [];
      allElements.forEach((el, index) => {
        if (el.textContent && el.textContent.includes('Ca¬≤‚Å∫')) {
          foundCa.push({
            index: index,
            tagName: el.tagName,
            textContent: el.textContent.substring(0, 100),
            className: el.className
          });
        }
      });
      
      console.log('üîç Elementos que contienen Ca¬≤‚Å∫:', foundCa.length);
      foundCa.forEach((el, i) => {
        console.log(`Elemento Ca ${i}:`, el);
      });
      
      return {
        totalElements: allElements.length,
        kElements: foundElements.length,
        caElements: foundCa.length
      };
    }

    // Hacer la funci√≥n disponible
    window.testSimple = testSimple;

    // Funci√≥n para expandir conocimiento cuando se agregue una nueva pesta√±a
    function expandKnowledgeForNewTab(tabName, tabData) {
      console.log(`üß† Expandiendo conocimiento para nueva pesta√±a: ${tabName}`);
      
      try {
        // Expandir conocimiento usando el sistema de expansi√≥n
        knowledgeExpansion.expandKnowledgeForTab(tabName, tabData);
        
        // Actualizar estad√≠sticas
        const stats = knowledgeExpansion.getExpansionStats();
        console.log('üìä Estad√≠sticas de expansi√≥n:', stats);
        
        // Notificar al usuario
        addMessage(`‚úÖ Conocimiento expandido para ${tabName}. La IA ahora puede ayudarte con conceptos espec√≠ficos de esta pesta√±a.`, 'ai');
        
      } catch (error) {
        console.error('Error expandiendo conocimiento:', error);
        addMessage(`‚ö†Ô∏è Error expandiendo conocimiento para ${tabName}. La IA funcionar√° con conocimiento b√°sico.`, 'ai');
      }
    }

    // Funci√≥n para agregar nueva pesta√±a con expansi√≥n de conocimiento
    function addNewTabWithKnowledge(tabName, tabData) {
      // Aqu√≠ ir√≠a la l√≥gica para agregar la nueva pesta√±a al UI
      // Por ahora, solo expandimos el conocimiento
      expandKnowledgeForNewTab(tabName, tabData);
    }
    
    // Funci√≥n para detecci√≥n manual r√°pida OPTIMIZADA
    async function tryManualDetection(lowerMessage, originalMessage) {
      console.log('üîç Intentando detecci√≥n manual optimizada...');
      
      // ===== COMANDOS ESPECIALES (PRIORIDAD M√ÅXIMA) =====
      if (lowerMessage.includes('analizar_suelo') || lowerMessage.includes('analizar suelo')) {
        console.log('‚úÖ Comando: analizar_suelo');
        return analyzeSoilData();
      }
      
      if (lowerMessage.includes('sugerir_distribucion') || lowerMessage.includes('sugerir distribuci√≥n')) {
        console.log('‚úÖ Comando: sugerir_distribucion');
        return suggestIdealDistribution();
      }
      
      if (lowerMessage.includes('aplicar_valores') || lowerMessage.includes('aplicar valores')) {
        console.log('‚úÖ Comando: aplicar_valores');
        return applySuggestedValues();
      }
      
      if (lowerMessage.includes('analizar_todo') || lowerMessage.includes('analizar todo')) {
        console.log('‚úÖ Comando: analizar_todo');
        return analyzeEverything();
      }
      
      if (lowerMessage.includes('analisis_inteligente') || lowerMessage.includes('an√°lisis inteligente')) {
        console.log('‚úÖ Comando: analisis_inteligente');
        return intelligentAnalysis();
      }
      
      if (lowerMessage.includes('recomendaciones') || lowerMessage.includes('sugerencias')) {
        console.log('‚úÖ Comando: recomendaciones');
        return intelligentAnalysis();
      }
      
      if (lowerMessage.includes('estadisticas') || lowerMessage.includes('estad√≠sticas') || lowerMessage.includes('estadisticas de uso')) {
        console.log('‚úÖ Comando: estadisticas');
        return showCostStats();
      }
      
      // ===== DETECCI√ìN INTELIGENTE MEJORADA =====
      // 1. Preguntas sobre CIC y objetivos (PRIORIDAD ALTA)
      if (lowerMessage.includes('objetivo') || lowerMessage.includes('ajuste') || lowerMessage.includes('niveles') || lowerMessage.includes('recomiendas')) {
        console.log('‚úÖ Detectado: objetivo/ajuste/niveles/recomiendas');
        return suggestIdealDistribution();
      }
      
      if (lowerMessage.includes('cic') && (lowerMessage.includes('objetivo') || lowerMessage.includes('ajuste') || lowerMessage.includes('sugerir'))) {
        console.log('‚úÖ Detectado: CIC + objetivo/ajuste/sugerir');
        return suggestIdealDistribution();
      }
      
      if (lowerMessage.includes('cuanto') && (lowerMessage.includes('sugerir') || lowerMessage.includes('recomendar'))) {
        console.log('‚úÖ Detectado: cuanto + sugerir/recomendar');
        return suggestIdealDistribution();
      }
      
      if (lowerMessage.includes('distribucion') || lowerMessage.includes('distribuci√≥n')) {
        console.log('‚úÖ Detectado: distribucion');
        return suggestIdealDistribution();
      }
      
      if (lowerMessage.includes('analisis') || lowerMessage.includes('an√°lisis')) {
        console.log('‚úÖ Detectado: analisis');
        return analyzeSoilData();
      }
      
      // 2. Preguntas sobre cultivos y manejo (PRIORIDAD ALTA)
      if ((lowerMessage.includes('raiz') || lowerMessage.includes('ra√≠z')) && 
          (lowerMessage.includes('50%') || lowerMessage.includes('mitad'))) {
        console.log('‚úÖ Detectado: ra√≠z + 50%/mitad');
        return handleCropQuestion(lowerMessage);
      }
      
      if (lowerMessage.includes('yeso') && (lowerMessage.includes('agricola') || lowerMessage.includes('agr√≠cola'))) {
        console.log('‚úÖ Detectado: yeso agr√≠cola');
        return handleCropQuestion(lowerMessage);
      }
      
      // Detecci√≥n espec√≠fica para calcio en aguacate
      if ((lowerMessage.includes('calcio') || lowerMessage.includes('ca') || lowerMessage.includes('cal')) && 
          (lowerMessage.includes('aguacate') || lowerMessage.includes('avocado')) && 
          (lowerMessage.includes('ideal') || lowerMessage.includes('nivel') || lowerMessage.includes('cic'))) {
        console.log('‚úÖ Detectado: calcio en aguacate');
        return handleCalciumAvocadoQuestion(lowerMessage);
      }
      
      // Detecci√≥n general para cultivos espec√≠ficos
      const cropMatch = findCropByName(lowerMessage);
      if (cropMatch && (lowerMessage.includes('ideal') || lowerMessage.includes('nivel') || 
          lowerMessage.includes('deficiencia') || lowerMessage.includes('sintomas'))) {
        console.log('‚úÖ Detectado: cultivo espec√≠fico -', cropMatch.key);
        return handleSpecificCropQuestion(lowerMessage, cropMatch);
      }
      
      // Detecci√≥n para fertilizantes espec√≠ficos
      const fertilizerMatch = findFertilizerByName(lowerMessage);
      if (fertilizerMatch && (lowerMessage.includes('fertilizante') || lowerMessage.includes('formula') || 
          lowerMessage.includes('uso') || lowerMessage.includes('aplicar'))) {
        console.log('‚úÖ Detectado: fertilizante espec√≠fico -', fertilizerMatch.key);
        return handleSpecificFertilizerQuestion(lowerMessage, fertilizerMatch);
      }
      
      if (lowerMessage.includes('cultivo') || lowerMessage.includes('siembra') || lowerMessage.includes('plantar')) {
        console.log('‚úÖ Detectado: cultivo/siembra/plantar');
        return handleCropQuestion(lowerMessage);
      }
      
      // 3. Comentarios sobre c√°lculos y sumas
      if (lowerMessage.includes('sumar') || lowerMessage.includes('suma') || lowerMessage.includes('total') || lowerMessage.includes('meq')) {
        console.log('‚úÖ Detectado: c√°lculos/suma');
        return handleCalculationComment(lowerMessage);
      }
      
      // 4. Comentarios sobre propuestas
      if (lowerMessage.includes('propuesta') || lowerMessage.includes('sugerencia') || lowerMessage.includes('recomendacion')) {
        console.log('‚úÖ Detectado: propuesta/sugerencia');
        return handleProposalComment(lowerMessage);
      }
      
      // 5. Comentarios sobre rangos m√≠nimos
      if (lowerMessage.includes('rango minimo') || lowerMessage.includes('rango m√≠nimo') || 
          lowerMessage.includes('minimo') || lowerMessage.includes('m√≠nimo') ||
          lowerMessage.includes('h, na y al') || lowerMessage.includes('h na al') ||
          lowerMessage.includes('considerar') || lowerMessage.includes('conciderar')) {
        console.log('‚úÖ Detectado: rangos m√≠nimos');
        return handleRangeComment(lowerMessage);
      }
      
      // 6. Solicitudes de an√°lisis inteligente
      if (lowerMessage.includes('analisis inteligente') || lowerMessage.includes('an√°lisis inteligente') ||
          lowerMessage.includes('recomendaciones') || lowerMessage.includes('sugerencias') ||
          lowerMessage.includes('que opinas') || lowerMessage.includes('qu√© opinas') ||
          lowerMessage.includes('criterio') || lowerMessage.includes('punto de vista')) {
        console.log('‚úÖ Detectado: an√°lisis inteligente');
        return intelligentAnalysis();
      }
      
      // 7. Respuestas con contexto de aguacate
      if (conversationContext.currentTopic === 'aguacate' && 
          (lowerMessage.includes('variedad') || lowerMessage.includes('guzman') || 
           lowerMessage.includes('jalisco')) && !lowerMessage.includes('ph') && 
           !lowerMessage.includes('cal') && !lowerMessage.includes('yeso')) {
        console.log('‚úÖ Detectado: contexto aguacate');
        return handleAvocadoContext(lowerMessage);
      }
      
      // 8. S√≠ntomas espec√≠ficos
      if (lowerMessage.includes('deficiencia') || lowerMessage.includes('deficiencias') ||
          lowerMessage.includes('quemado') || lowerMessage.includes('quemada') ||
          lowerMessage.includes('borde') || lowerMessage.includes('hoja') ||
          lowerMessage.includes('clorosis') || lowerMessage.includes('amarillamiento')) {
        console.log('‚úÖ Detectado: s√≠ntomas espec√≠ficos');
        return handleSymptomAnalysis(lowerMessage);
      }
      
      // 9. Preguntas sobre pH y tipos de enmienda
      if (lowerMessage.includes('ph') && (lowerMessage.includes('7') || lowerMessage.includes('cal') || lowerMessage.includes('yeso'))) {
        console.log('‚úÖ Detectado: pH + enmiendas');
        return handlePHAmendmentQuestion(lowerMessage);
      }
      
      // 10. Preguntas sobre cantidades y toneladas
      if (lowerMessage.includes('tonelada') || lowerMessage.includes('ton') ||
          lowerMessage.includes('kg') || lowerMessage.includes('cantidad') ||
          lowerMessage.includes('8.5') || lowerMessage.includes('8513') ||
          lowerMessage.includes('5 toneladas') || lowerMessage.includes('5 ton') ||
          lowerMessage.includes('recomendacion') || lowerMessage.includes('recomendaci√≥n')) {
        console.log('‚úÖ Detectado: cantidades/toneladas');
        return handleQuantityQuestion(lowerMessage);
      }
      
      // ===== TODAS LAS PREGUNTAS VAN AL AN√ÅLISIS DIRECTO =====
      // No hay respuestas b√°sicas que interfieran
    }

    // Funci√≥n para manejar respuestas de confirmaci√≥n
    function handleConfirmationResponse(lowerMessage) {
      console.log('ü§î Procesando confirmaci√≥n:', lowerMessage);
      
      // Detectar respuestas positivas
      if (lowerMessage === 'si' || lowerMessage === 's√≠' || lowerMessage === 'ok' || lowerMessage === 'okay' || 
          lowerMessage === 'aplica' || lowerMessage === 'aplicar' || lowerMessage === 'yes' || 
          lowerMessage === 'claro' || lowerMessage === 'perfecto' || lowerMessage === 'dale' ||
          lowerMessage === 'adelante' || lowerMessage === 'vamos' || lowerMessage === 'bueno') {
        
        console.log('‚úÖ Confirmaci√≥n positiva detectada');
        conversationContext.waitingForConfirmation = false;
        
        if (conversationContext.lastSuggestedAction === 'applyValues') {
          return applySuggestedValues();
        } else if (conversationContext.lastSuggestedAction === 'analyzeSoil') {
          return analyzeSoilData();
        } else if (conversationContext.lastSuggestedAction === 'suggestDistribution') {
          return suggestIdealDistribution();
        }
      }
      
      // Detectar respuestas negativas
      if (lowerMessage === 'no' || lowerMessage === 'nop' || lowerMessage === 'nope' || 
          lowerMessage === 'cancelar' || lowerMessage === 'cancel' || lowerMessage === 'mejor no' ||
          lowerMessage === 'no gracias' || lowerMessage === 'no, gracias') {
        
        console.log('‚ùå Confirmaci√≥n negativa detectada');
        conversationContext.waitingForConfirmation = false;
        return 'Entendido. No he aplicado los cambios. ¬øHay algo m√°s en lo que pueda ayudarte?';
      }
      
      // Si no es una respuesta clara, pedir aclaraci√≥n
      return 'No estoy seguro de tu respuesta. ¬øQuieres que proceda con la acci√≥n sugerida? Responde "s√≠" o "no".';
    }
    
    // Funci√≥n para establecer contexto de confirmaci√≥n
    function setConfirmationContext(action, question) {
      conversationContext.waitingForConfirmation = true;
      conversationContext.lastSuggestedAction = action;
      conversationContext.lastAIQuestion = question;
    }
    
    // Funci√≥n para limpiar contexto
    function clearContext() {
      conversationContext.waitingForConfirmation = false;
      conversationContext.lastSuggestedAction = null;
      conversationContext.lastAIQuestion = null;
    }
    
    // Funci√≥n para manejar aplicaci√≥n de recomendaciones
    function handleRecommendationApplication() {
      console.log('ü§ñ Aplicando recomendaci√≥n autom√°ticamente...');
      
      const recommendation = conversationContext.currentRecommendation;
      const options = conversationContext.currentOptions;
      
      if (!recommendation) {
        return '‚ùå No hay una recomendaci√≥n pendiente para aplicar.';
      }
      
      try {
        // Obtener datos actuales del suelo
        const currentData = getCurrentDashboardData();
        
        // Aplicar la recomendaci√≥n usando la IA
        const result = nutriPlantAI.applyRecommendation(recommendation, currentData);
        
        if (result.success) {
          // Limpiar el contexto
          conversationContext.currentRecommendation = null;
          conversationContext.currentOptions = null;
          
          return `‚úÖ **Recomendaci√≥n aplicada exitosamente!**\n\n` +
                 `**Enmienda seleccionada:** ${recommendation.name}\n` +
                 `**Cantidad:** ${recommendation.quantity || 'Variable'}\n` +
                 `**Costo:** ${recommendation.cost || 'Consultar'}\n\n` +
                 `La recomendaci√≥n ha sido configurada autom√°ticamente. Puedes revisar los detalles en la secci√≥n de enmiendas.\n\n` +
                 `¬øTe gustar√≠a que genere un reporte PDF con todos los detalles?`;
        } else {
          return `‚ùå **Error al aplicar la recomendaci√≥n:**\n\n${result.error}\n\nPor favor, intenta de nuevo o aplica manualmente.`;
        }
      } catch (error) {
        console.error('‚ùå Error aplicando recomendaci√≥n:', error);
        return `‚ùå **Error inesperado:**\n\n${error.message}\n\nPor favor, intenta de nuevo.`;
      }
    }
    
    // Funci√≥n para manejar comentarios sobre c√°lculos
    function handleCalculationComment(lowerMessage) {
      const soilData = getSoilAnalysisData();
      if (!soilData || soilData.cic === 0) {
        return 'No tengo datos de an√°lisis de suelo para verificar los c√°lculos. ¬øPodr√≠as ingresar los valores en la calculadora primero?';
      }
      
      // Verificar si menciona 16 meq espec√≠ficamente
      if (lowerMessage.includes('16')) {
        const currentTotal = soilData.k + soilData.ca + soilData.mg + soilData.h + soilData.na + soilData.al;
        const idealValues = calculateIdealDistribution(soilData.cic);
        const idealTotal = idealValues.reduce((sum, item) => sum + item.recommended, 0);
        
        return `üîç **Verificaci√≥n de C√°lculos**\n\n**CIC Actual:** ${soilData.cic} meq/100g\n**Suma Actual:** ${currentTotal.toFixed(2)} meq\n**Suma Ideal Sugerida:** ${idealTotal.toFixed(2)} meq\n\n**Estrategia de Optimizaci√≥n:**\n‚Ä¢ **Cationes buenos (K‚Å∫, Ca¬≤‚Å∫, Mg¬≤‚Å∫):** Distribuidos en rangos ideales\n‚Ä¢ **Cationes problem√°ticos (H‚Å∫, Na‚Å∫, Al¬≥‚Å∫):** Mantenidos en 0 meq\n\nTienes raz√≥n, la suma debe coincidir con el CIC Total (${soilData.cic} meq). Mi propuesta suma exactamente ${idealTotal.toFixed(2)} meq, distribuyendo solo los cationes beneficiosos.\n\n¬øQuieres que aplique esta distribuci√≥n optimizada?`;
      }
      
      return 'Entiendo tu comentario sobre los c√°lculos. ¬øPodr√≠as ser m√°s espec√≠fico sobre qu√© aspecto de los c√°lculos te gustar√≠a que revise?';
    }
    
    // Funci√≥n para manejar comentarios sobre propuestas
    function handleProposalComment(lowerMessage) {
      if (lowerMessage.includes('creo') || lowerMessage.includes('pienso') || lowerMessage.includes('opino')) {
        return 'Gracias por tu comentario. Tienes raz√≥n, es importante que los valores sumen exactamente el CIC Total. ¬øTe gustar√≠a que revise y ajuste la propuesta para que sea m√°s precisa?';
      }
      
      return 'Entiendo tu comentario sobre la propuesta. ¬øHay algo espec√≠fico que te gustar√≠a que modifique o mejore?';
    }
    
    // Funci√≥n para manejar comentarios sobre rangos m√≠nimos
    function handleRangeComment(lowerMessage) {
      if (lowerMessage.includes('h') && (lowerMessage.includes('na') || lowerMessage.includes('al'))) {
        return `üéØ **¬°Excelente observaci√≥n!** Tienes raz√≥n sobre los rangos m√≠nimos.\n\n**Estrategia Optimizada:**\n‚Ä¢ **H‚Å∫, Na‚Å∫, Al¬≥‚Å∫:** Mantener en 0 meq (rango m√≠nimo)\n‚Ä¢ **K‚Å∫, Ca¬≤‚Å∫, Mg¬≤‚Å∫:** Distribuir en rangos ideales\n\n**Ventajas:**\n‚úÖ M√°s realista y pr√°ctico\n‚úÖ Evita cationes problem√°ticos\n‚úÖ Mejor distribuci√≥n de cationes buenos\n\n¬øQuieres que aplique esta estrategia optimizada a tu calculadora?`;
      }
      
      if (lowerMessage.includes('minimo') || lowerMessage.includes('m√≠nimo')) {
        return 'Entiendo tu sugerencia sobre usar rangos m√≠nimos. ¬øTe refieres espec√≠ficamente a los cationes H‚Å∫, Na‚Å∫ y Al¬≥‚Å∫? ¬øQuieres que los mantenga en 0 meq?';
      }
      
      return 'Gracias por tu comentario sobre los rangos. ¬øPodr√≠as ser m√°s espec√≠fico sobre qu√© cationes te gustar√≠a que maneje con rangos m√≠nimos?';
    }
    
    // Funci√≥n para an√°lisis inteligente y recomendaciones
    function intelligentAnalysis() {
      const soilData = getSoilAnalysisData();
      if (!soilData || soilData.cic === 0) {
        return 'No tengo datos suficientes para hacer un an√°lisis inteligente. ¬øPodr√≠as ingresar los valores de tu an√°lisis de suelo primero?';
      }
      
      const analysis = performSoilAnalysis(soilData);
      const idealValues = calculateIdealDistribution(soilData.cic);
      
      let recommendations = [];
      let warnings = [];
      let suggestions = [];
      
      // An√°lisis de cationes problem√°ticos
      if (soilData.h > 0.5) {
        warnings.push(`‚ö†Ô∏è **H‚Å∫ alto (${soilData.h} meq):** Indica acidez del suelo. Considera aplicar cal agr√≠cola.`);
        suggestions.push('üí° **Sugerencia:** Aplicar cal dolom√≠tica para neutralizar H‚Å∫ y aportar Ca¬≤‚Å∫ y Mg¬≤‚Å∫');
      }
      
      if (soilData.na > 0.5) {
        warnings.push(`‚ö†Ô∏è **Na‚Å∫ alto (${soilData.na} meq):** Riesgo de salinizaci√≥n. Considera aplicar yeso.`);
        suggestions.push('üí° **Sugerencia:** Aplicar yeso (CaSO‚ÇÑ) para desplazar Na‚Å∫ y mejorar estructura');
      }
      
      if (soilData.al > 0.5) {
        warnings.push(`‚ö†Ô∏è **Al¬≥‚Å∫ alto (${soilData.al} meq):** T√≥xico para las ra√≠ces. Necesita enmienda urgente.`);
        suggestions.push('üí° **Sugerencia:** Aplicar cal para precipitar Al¬≥‚Å∫ y elevar pH');
      }
      
      // An√°lisis de cationes buenos
      const kPercent = (soilData.k / soilData.cic) * 100;
      const caPercent = (soilData.ca / soilData.cic) * 100;
      const mgPercent = (soilData.mg / soilData.cic) * 100;
      
      if (kPercent < 3) {
        recommendations.push(`üìà **K‚Å∫ bajo (${kPercent.toFixed(1)}%):** Aumentar potasio para mejor desarrollo radicular`);
      }
      
      if (caPercent < 65) {
        recommendations.push(`üìà **Ca¬≤‚Å∫ bajo (${caPercent.toFixed(1)}%):** Aumentar calcio para mejor estructura del suelo`);
      }
      
      if (mgPercent < 10) {
        recommendations.push(`üìà **Mg¬≤‚Å∫ bajo (${mgPercent.toFixed(1)}%):** Aumentar magnesio para mejor fotos√≠ntesis`);
      }
      
      // An√°lisis de CIC
      let cicStatus = '';
      if (soilData.cic < 10) {
        cicStatus = 'üî¥ **CIC muy bajo:** Suelo arenoso, necesita materia org√°nica';
        suggestions.push('üí° **Sugerencia:** Incorporar compost, esti√©rcol o humus para aumentar CIC');
      } else if (soilData.cic > 30) {
        cicStatus = 'üü° **CIC alto:** Suelo arcilloso, manejar con cuidado';
        suggestions.push('üí° **Sugerencia:** Fraccionar aplicaciones de enmiendas para evitar bloqueos');
      } else {
        cicStatus = 'üü¢ **CIC adecuado:** Buen balance de textura';
      }
      
      // Construir respuesta inteligente
      let response = `üß† **AN√ÅLISIS INTELIGENTE DEL SUELO**\n\n`;
      response += `**üìä CIC del Suelo:** ${soilData.cic} meq/100g - ${cicStatus}\n\n`;
      
      if (warnings.length > 0) {
        response += `**üö® ALERTAS CR√çTICAS:**\n${warnings.join('\n')}\n\n`;
      }
      
      if (recommendations.length > 0) {
        response += `**üìã RECOMENDACIONES:**\n${recommendations.join('\n')}\n\n`;
      }
      
      if (suggestions.length > 0) {
        response += `**üí° SUGERENCIAS ESPEC√çFICAS:**\n${suggestions.join('\n')}\n\n`;
      }
      
      // Pregunta inteligente basada en el an√°lisis
      if (warnings.length > 0) {
        response += `**ü§î PREGUNTA CLAVE:** ¬øCu√°l es tu prioridad: corregir la acidez (H‚Å∫), la salinidad (Na‚Å∫) o la toxicidad (Al¬≥‚Å∫)?`;
      } else if (recommendations.length > 0) {
        response += `**ü§î PREGUNTA CLAVE:** ¬øQu√© cultivo vas a sembrar? Esto me ayudar√° a ajustar las recomendaciones.`;
      } else {
        response += `**ü§î PREGUNTA CLAVE:** ¬øC√≥mo est√° el rendimiento de tu cultivo actual? ¬øHay alg√∫n problema espec√≠fico?`;
      }
      
      return response;
    }
    
    // Funci√≥n para extraer informaci√≥n del usuario
    function extractUserInfo(message) {
      const lowerMessage = message.toLowerCase();
      
      // Detectar cultivo
      if (lowerMessage.includes('aguacate') || lowerMessage.includes('avocado')) {
        conversationContext.userInfo.crop = 'Aguacate';
        conversationContext.currentTopic = 'aguacate';
      }
      
      // Detectar ubicaci√≥n
      if (lowerMessage.includes('guzman') || lowerMessage.includes('jalisco')) {
        conversationContext.userInfo.location = 'Cd. Guzm√°n, Jalisco';
      }
      
      // Detectar pH
      const phMatch = message.match(/pH\s*es\s*de\s*(\d+(?:\.\d+)?)/i);
      if (phMatch) {
        conversationContext.userInfo.pH = parseFloat(phMatch[1]);
      }
      
      // Detectar variedad
      if (lowerMessage.includes('mendez')) {
        conversationContext.userInfo.variety = 'Mendez';
      }
      
      // Detectar edad
      const ageMatch = message.match(/(\d+)\s*a√±os?\s*de\s*edad/);
      if (ageMatch) {
        conversationContext.userInfo.age = ageMatch[1] + ' a√±os';
      }
      
      // Detectar rendimiento
      const yieldMatch = message.match(/(\d+)\s*tm\s*por\s*hectarea/);
      if (yieldMatch) {
        conversationContext.userInfo.yield = yieldMatch[1] + ' tm/ha';
      }
      
      // Detectar densidad
      const densityMatch = message.match(/(\d+)\s*arboles?\s*por\s*hectarea/);
      if (densityMatch) {
        conversationContext.userInfo.density = densityMatch[1] + ' √°rboles/ha';
      }
      
      // Detectar cantidades espec√≠ficas
      if (lowerMessage.includes('8.5') || lowerMessage.includes('8513')) {
        conversationContext.userInfo.lastQuantity = '8.5 toneladas de yeso';
        conversationContext.userInfo.lastCalculation = 'Yeso Agr√≠cola';
      }
      
      // Detectar problemas espec√≠ficos
      if (lowerMessage.includes('deficiencia') || lowerMessage.includes('quemado')) {
        conversationContext.userInfo.hasProblems = true;
        conversationContext.userInfo.problemType = 'nutricional';
      }
      
      // Detectar confirmaciones
      if (lowerMessage.includes('si') || lowerMessage.includes('s√≠') || lowerMessage.includes('ok')) {
        conversationContext.userInfo.lastConfirmation = true;
      }
      
      // Guardar contexto de la conversaci√≥n
      conversationContext.conversationHistory.push({
        type: 'user',
        message: message,
        timestamp: new Date().toISOString(),
        extractedInfo: {
          crop: conversationContext.userInfo.crop,
          location: conversationContext.userInfo.location,
          pH: conversationContext.userInfo.pH,
          variety: conversationContext.userInfo.variety,
          age: conversationContext.userInfo.age,
          yield: conversationContext.userInfo.yield,
          density: conversationContext.userInfo.density
        }
      });
    }
    
    // Funci√≥n para detectar la secci√≥n actual
    function detectCurrentSection() {
      const url = window.location.href;
      if (url.includes('fertirriego')) return 'fertirriego';
      if (url.includes('hidroponia')) return 'hidroponia';
      if (url.includes('analisis')) return 'analisis';
      if (url.includes('extracto')) return 'extracto';
      if (url.includes('ubicacion')) return 'ubicacion';
      if (url.includes('reportes')) return 'reportes';
      if (url.includes('configuracion')) return 'configuracion';
      return 'enmienda'; // Por defecto
    }
    
    // Funci√≥n para obtener conocimiento contextual
    function getContextualKnowledge() {
      currentSection = detectCurrentSection();
      return sectionKnowledge[currentSection] || sectionKnowledge.enmienda;
    }
    
    // Funci√≥n para consultar conocimiento agr√≠cola
    function getAgriculturalKnowledge(crop, nutrient, fertilizer) {
      let knowledge = {};
      
      if (crop && agriculturalKnowledge.crops[crop]) {
        knowledge.crop = agriculturalKnowledge.crops[crop];
      }
      
      if (nutrient && agriculturalKnowledge.concepts[nutrient]) {
        knowledge.concept = agriculturalKnowledge.concepts[nutrient];
      }
      
      if (fertilizer) {
        // Buscar fertilizante en todas las categor√≠as
        for (let category in agriculturalKnowledge.fertilizers) {
          if (agriculturalKnowledge.fertilizers[category][fertilizer]) {
            knowledge.fertilizer = agriculturalKnowledge.fertilizers[category][fertilizer];
            knowledge.fertilizerCategory = category;
            break;
          }
        }
      }
      
      return knowledge;
    }
    
    // Funci√≥n para buscar cultivo por nombre
    function findCropByName(cropName) {
      const lowerName = cropName.toLowerCase();
      for (let key in agriculturalKnowledge.crops) {
        const crop = agriculturalKnowledge.crops[key];
        if (crop.name.toLowerCase().includes(lowerName) || 
            key.includes(lowerName) ||
            lowerName.includes(key)) {
          return { key, crop };
        }
      }
      return null;
    }
    
    // Funci√≥n para buscar fertilizante por nombre
    function findFertilizerByName(fertilizerName) {
      const lowerName = fertilizerName.toLowerCase();
      for (let category in agriculturalKnowledge.fertilizers) {
        for (let key in agriculturalKnowledge.fertilizers[category]) {
          const fertilizer = agriculturalKnowledge.fertilizers[category][key];
          if (key.includes(lowerName) || 
              lowerName.includes(key) ||
              fertilizer.formula.toLowerCase().includes(lowerName)) {
            return { category, key, fertilizer };
          }
        }
      }
      return null;
    }
    
    // Funci√≥n para an√°lisis de razonamiento avanzado con contexto
    function advancedReasoningAnalysis(lowerMessage) {
      // Obtener conocimiento contextual
      const knowledge = getContextualKnowledge();
      const soilData = getSoilAnalysisData();
      const userInfo = conversationContext.userInfo;
      
      // Respuesta conversacional natural con contexto mejorado
      let response = `¬°Perfecto! Veo que est√°s trabajando con ${knowledge.name.toLowerCase()}. `;
      
      // Usar contexto de la conversaci√≥n
      if (userInfo.crop) {
        response += `Me encanta que est√©s manejando ${userInfo.crop}`;
        if (userInfo.variety) response += ` (${userInfo.variety})`;
        response += `. `;
      }
      
      if (userInfo.location) {
        response += `${userInfo.location} es una excelente zona para agricultura. `;
      }
      
      // An√°lisis del suelo de manera conversacional
      if (currentSection === 'enmienda' && soilData && soilData.cic > 0) {
        response += `Mirando tu an√°lisis de suelo, veo que tienes un CIC de ${soilData.cic} meq/100g, `;
        
        const kPercent = ((soilData.k/soilData.cic)*100).toFixed(1);
        const caPercent = ((soilData.ca/soilData.cic)*100).toFixed(1);
        const mgPercent = ((soilData.mg/soilData.cic)*100).toFixed(1);
        
        response += `con ${soilData.k} meq de K‚Å∫ (${kPercent}%), ${soilData.ca} meq de Ca¬≤‚Å∫ (${caPercent}%) y ${soilData.mg} meq de Mg¬≤‚Å∫ (${mgPercent}%). `;
        
        // An√°lisis conversacional de problemas
        if (caPercent < 65) {
          response += `Lo que me preocupa es que el calcio est√° un poco bajo (idealmente deber√≠a estar entre 65-75%), `;
        }
        if (kPercent < 3) {
          response += `el potasio tambi√©n est√° deficiente, `;
        }
        if (soilData.na > 0.5) {
          response += `y tienes algo de sodio que puede ser problem√°tico. `;
        }
        if (soilData.h > 0.5) {
          response += `Tambi√©n veo acidez en el suelo. `;
        }
        
        // Usar contexto de cantidades si est√° disponible
        if (userInfo.lastQuantity) {
          response += `\n\nVeo que mencionaste ${userInfo.lastQuantity} - esa es una cantidad muy razonable para tu situaci√≥n. `;
        }
      }
      
      // Recomendaciones conversacionales basadas en contexto
      response += `\n\n**Mi recomendaci√≥n ser√≠a:**\n`;
      
      if (currentSection === 'enmienda') {
        if (soilData && soilData.cic > 0) {
          const caPercent = ((soilData.ca/soilData.cic)*100).toFixed(1);
          if (caPercent < 65) {
            response += `‚Ä¢ Aplicar cal dolom√≠tica para subir el calcio (2-3 ton/ha)\n`;
          }
          if (soilData.na > 0.5) {
            response += `‚Ä¢ Usar yeso agr√≠cola para desplazar el sodio\n`;
          }
          if (soilData.h > 0.5) {
            response += `‚Ä¢ Neutralizar la acidez con cal\n`;
          }
          
          // Recomendaciones espec√≠ficas para aguacate si es el caso
          if (userInfo.crop === 'Aguacate') {
            response += `‚Ä¢ Para aguacate, el calcio es cr√≠tico para la calidad del fruto\n`;
            response += `‚Ä¢ Aplica en oto√±o para que est√© disponible en primavera\n`;
          }
        }
      } else if (currentSection === 'fertirriego') {
        response += `‚Ä¢ Dise√±ar un programa de fertirriego balanceado\n`;
        response += `‚Ä¢ Ajustar el pH del agua de riego\n`;
        response += `‚Ä¢ Fraccionar las aplicaciones seg√∫n la etapa fenol√≥gica\n`;
      } else if (currentSection === 'hidroponia') {
        response += `‚Ä¢ Preparar una soluci√≥n nutritiva con EC 1.2-2.5 mS/cm\n`;
        response += `‚Ä¢ Mantener pH entre 5.5-6.5\n`;
        response += `‚Ä¢ Monitorear constantemente los niveles\n`;
      }
      
      // Pregunta de seguimiento natural basada en contexto
      if (userInfo.hasProblems) {
        response += `\n\n¬øC√≥mo est√°n evolucionando los s√≠ntomas que mencionaste? ¬øHas notado alguna mejora?`;
      } else if (userInfo.lastConfirmation) {
        response += `\n\nPerfecto, me alegra que est√©s de acuerdo. ¬øHay algo m√°s que te gustar√≠a ajustar?`;
      } else {
        response += `\n\n¬øQu√© te parece? ¬øHay algo espec√≠fico que te gustar√≠a que revisemos m√°s a fondo?`;
      }
      
      return response;
    }
    
    // Funci√≥n para extraer contexto del mensaje
    function extractContextFromMessage(message) {
      const context = {};
      
      // Detectar cultivo
      if (message.includes('aguacate') || message.includes('avocado')) context.crop = 'Aguacate';
      if (message.includes('tomate') || message.includes('tomato')) context.crop = 'Tomate';
      if (message.includes('maiz') || message.includes('corn')) context.crop = 'Ma√≠z';
      if (message.includes('fresa') || message.includes('strawberry')) context.crop = 'Fresa';
      
      // Detectar edad
      const ageMatch = message.match(/(\d+)\s*a√±os?\s*de\s*edad/);
      if (ageMatch) context.age = ageMatch[1] + ' a√±os';
      
      // Detectar rendimiento
      const yieldMatch = message.match(/(\d+)\s*tm\s*por\s*hectarea/);
      if (yieldMatch) context.yield = yieldMatch[1] + ' tm/ha';
      
      // Detectar densidad
      const densityMatch = message.match(/(\d+)\s*arboles?\s*por\s*hectarea/);
      if (densityMatch) context.density = densityMatch[1] + ' √°rboles/ha';
      
      // Detectar tipo de suelo
      if (message.includes('arenoso')) context.soilType = 'Arenoso';
      if (message.includes('arcilloso')) context.soilType = 'Arcilloso';
      if (message.includes('franco')) context.soilType = 'Franco';
      
      return context;
    }
    
    // Funci√≥n para identificar problemas
    function identifyProblems(soilData, context) {
      const problems = [];
      
      if (!soilData || soilData.cic === 0) {
        problems.push('‚ùå No hay datos de an√°lisis de suelo');
        return problems;
      }
      
      // Problemas de CIC
      if (soilData.cic < 10) {
        problems.push('üî¥ CIC muy bajo - Suelo arenoso, necesita materia org√°nica');
      } else if (soilData.cic > 30) {
        problems.push('üü° CIC alto - Suelo arcilloso, manejar con cuidado');
      }
      
      // Problemas de cationes
      const kPercent = (soilData.k / soilData.cic) * 100;
      const caPercent = (soilData.ca / soilData.cic) * 100;
      const mgPercent = (soilData.mg / soilData.cic) * 100;
      
      if (kPercent < 3) problems.push('üìâ K‚Å∫ bajo - Deficiencia de potasio');
      if (caPercent < 65) problems.push('üìâ Ca¬≤‚Å∫ bajo - Deficiencia de calcio');
      if (mgPercent < 10) problems.push('üìâ Mg¬≤‚Å∫ bajo - Deficiencia de magnesio');
      if (soilData.h > 0.5) problems.push('‚ö†Ô∏è H‚Å∫ alto - Acidez del suelo');
      if (soilData.na > 0.5) problems.push('‚ö†Ô∏è Na‚Å∫ alto - Riesgo de salinizaci√≥n');
      if (soilData.al > 0.5) problems.push('üö® Al¬≥‚Å∫ alto - T√≥xico para ra√≠ces');
      
      // Problemas espec√≠ficos del cultivo
      if (context.crop === 'Aguacate') {
        if (soilData.ca < 8) problems.push('ü•ë Ca¬≤‚Å∫ cr√≠tico para aguacate - Frutos peque√±os');
        if (soilData.k < 1.5) problems.push('ü•ë K‚Å∫ bajo - Baja calidad del fruto');
      }
      
      return problems;
    }
    
    // Funci√≥n para desarrollar estrategia
    function developStrategy(soilData, context) {
      const strategy = [];
      
      if (!soilData || soilData.cic === 0) {
        strategy.push('üìã Realizar an√°lisis de suelo completo');
        return strategy;
      }
      
      // Priorizar problemas cr√≠ticos
      if (soilData.al > 0.5) {
        strategy.push('üö® URGENTE: Aplicar cal para precipitar Al¬≥‚Å∫');
      }
      if (soilData.na > 0.5) {
        strategy.push('‚ö†Ô∏è Aplicar yeso para desplazar Na‚Å∫');
      }
      if (soilData.h > 0.5) {
        strategy.push('‚ö†Ô∏è Aplicar cal dolom√≠tica para neutralizar H‚Å∫');
      }
      
      // Estrategia espec√≠fica por cultivo
      if (context.crop === 'Aguacate') {
        strategy.push('ü•ë Aplicar enmiendas en zona radicular (0-30 cm)');
        strategy.push('ü•ë Fraccionar aplicaciones en 3 etapas');
        strategy.push('ü•ë Monitorear pH y conductividad el√©ctrica');
      }
      
      return strategy;
    }
    
    // Funci√≥n para generar recomendaciones espec√≠ficas
    function generateSpecificRecommendations(soilData, context) {
      const recommendations = [];
      
      if (!soilData || soilData.cic === 0) {
        recommendations.push('üìä Ingresar datos de an√°lisis de suelo');
        return recommendations;
      }
      
      // Recomendaciones de enmiendas
      if (soilData.ca < 8) {
        recommendations.push('üí° Aplicar cal dolom√≠tica: 2-3 ton/ha');
      }
      if (soilData.k < 1.5) {
        recommendations.push('üí° Aplicar sulfato de potasio: 200-300 kg/ha');
      }
      if (soilData.mg < 2) {
        recommendations.push('üí° Aplicar sulfato de magnesio: 100-150 kg/ha');
      }
      
      // Recomendaciones espec√≠ficas por cultivo
      if (context.crop === 'Aguacate') {
        recommendations.push('ü•ë Aplicar enmiendas 2-3 meses antes de floraci√≥n');
        recommendations.push('ü•ë Usar riego por goteo para mejor distribuci√≥n');
        recommendations.push('ü•ë Monitorear clorosis f√©rrica en hojas nuevas');
      }
      
      return recommendations;
    }
    
    // Funci√≥n para generar preguntas de seguimiento
    function generateFollowUpQuestions(context) {
      const questions = [];
      const knowledge = getContextualKnowledge();
      
      if (currentSection === 'enmienda') {
        if (context.crop === 'Aguacate') {
          questions.push('¬øHas observado clorosis f√©rrica en las hojas?');
          questions.push('¬øCu√°l es el pH actual del suelo?');
          questions.push('¬øHay problemas de drenaje en el predio?');
          questions.push('¬øQu√© variedad de aguacate est√°s cultivando?');
        } else {
          questions.push('¬øQu√© cultivo espec√≠fico est√°s manejando?');
          questions.push('¬øEn qu√© etapa fenol√≥gica est√°?');
          questions.push('¬øHas observado s√≠ntomas espec√≠ficos?');
        }
      } else if (currentSection === 'fertirriego') {
        questions.push('¬øQu√© sistema de riego est√°s usando?');
        questions.push('¬øCu√°l es la frecuencia de riego actual?');
        questions.push('¬øQu√© fertilizantes est√°s aplicando?');
        questions.push('¬øCu√°l es el pH del agua de riego?');
      } else if (currentSection === 'hidroponia') {
        questions.push('¬øQu√© sistema hidrop√≥nico est√°s usando?');
        questions.push('¬øCu√°l es la EC actual de la soluci√≥n?');
        questions.push('¬øQu√© sustrato est√°s utilizando?');
        questions.push('¬øC√≥mo est√° el crecimiento de las ra√≠ces?');
      } else if (currentSection === 'analisis') {
        questions.push('¬øQu√© tipo de an√°lisis realizaste?');
        questions.push('¬øEn qu√© etapa del cultivo tomaste la muestra?');
        questions.push('¬øHas observado s√≠ntomas visuales?');
        questions.push('¬øCu√°l es el historial de fertilizaci√≥n?');
      } else if (currentSection === 'extracto') {
        questions.push('¬øQu√© m√©todo de extracci√≥n usaste?');
        questions.push('¬øCu√°l es el volumen de extracci√≥n?');
        questions.push('¬øQu√© nutrientes est√°s analizando?');
        questions.push('¬øCu√°l es la eficiencia de extracci√≥n?');
      }
      
      return questions;
    }
    
    // Funci√≥n para manejar contexto de aguacate
    function handleAvocadoContext(lowerMessage) {
      const userInfo = conversationContext.userInfo;
      let response = `¬°Excelente! Me encanta trabajar con aguacate Mendez. `;
      
      if (userInfo.location) {
        response += `Cd. Guzm√°n es una zona perfecta para aguacate, con esos suelos volc√°nicos que tanto les gustan. `;
      }
      
      if (userInfo.pH) {
        response += `Un pH de ${userInfo.pH} est√° ideal para aguacate, `;
        if (userInfo.pH == 7) {
          response += `especialmente para la variedad Mendez que tolera bien los suelos neutros. `;
        }
      }
      
      if (userInfo.age) {
        response += `Con ${userInfo.age} ya tienes plantas en plena producci√≥n, `;
      }
      
      if (userInfo.yield) {
        response += `y ${userInfo.yield} es un rendimiento muy bueno para la zona. `;
      }
      
      response += `\n\n**Para mantener ese rendimiento, te sugiero:**\n`;
      response += `‚Ä¢ Aplicar fertilizaci√≥n balanceada 3-4 veces al a√±o\n`;
      response += `‚Ä¢ Mantener el riego constante pero sin encharcar\n`;
      response += `‚Ä¢ Hacer poda de mantenimiento despu√©s de la cosecha\n`;
      response += `‚Ä¢ Estar atento a la clorosis f√©rrica en hojas nuevas\n`;
      
      response += `\n\n¬øC√≥mo est√° el sistema de riego que tienes? ¬øY has notado alg√∫n problema espec√≠fico en las hojas?`;
      
      return response;
    }
    
    // Funci√≥n espec√≠fica para calcio en aguacate
    function handleCalciumAvocadoQuestion(lowerMessage) {
      let response = `ü•ë **CALCIO EN AGUACATE - NIVELES IDEALES**\n\n`;
      
      response += `**Para aguacate, el calcio es CR√çTICO** y debe estar en estos rangos:\n\n`;
      
      response += `**üìä RANGOS IDEALES DE CALCIO:**\n`;
      response += `‚Ä¢ **CIC Total:** 15-25 meq/100g (√≥ptimo para aguacate)\n`;
      response += `‚Ä¢ **Ca¬≤‚Å∫ en CIC:** 65-75% (10-18 meq/100g)\n`;
      response += `‚Ä¢ **Relaci√≥n Ca:Mg:** 3:1 a 5:1\n`;
      response += `‚Ä¢ **pH del suelo:** 6.0-7.0 (√≥ptimo para disponibilidad)\n\n`;
      
      response += `**üéØ IMPORTANCIA DEL CALCIO EN AGUACATE:**\n`;
      response += `‚Ä¢ **Calidad del fruto:** Frutos m√°s firmes y duraderos\n`;
      response += `‚Ä¢ **Prevenci√≥n de pudrici√≥n:** Reduce problemas post-cosecha\n`;
      response += `‚Ä¢ **Desarrollo radicular:** Mejor absorci√≥n de nutrientes\n`;
      response += `‚Ä¢ **Resistencia a enfermedades:** Mayor vigor de la planta\n\n`;
      
      response += `**‚ö†Ô∏è S√çNTOMAS DE DEFICIENCIA:**\n`;
      response += `‚Ä¢ Bordes quemados en hojas nuevas\n`;
      response += `‚Ä¢ Frutos con manchas negras\n`;
      response += `‚Ä¢ Pudrici√≥n apical del fruto\n`;
      response += `‚Ä¢ Ra√≠ces poco desarrolladas\n\n`;
      
      response += `**üí° RECOMENDACIONES ESPEC√çFICAS:**\n`;
      response += `‚Ä¢ **Cal dolom√≠tica:** 2-3 ton/ha en oto√±o\n`;
      response += `‚Ä¢ **Nitrato de calcio:** En fertirriego (200-300 kg/ha/a√±o)\n`;
      response += `‚Ä¢ **Cloruro de calcio foliar:** 0.5% cada 15 d√≠as\n`;
      response += `‚Ä¢ **Aplicar en zona radicular:** 0-30 cm de profundidad\n\n`;
      
      response += `**¬øCu√°l es el CIC actual de tu suelo?** Esto me ayudar√° a calcular la cantidad exacta de calcio que necesitas.`;
      
      return response;
    }
    
    // Funci√≥n para cultivos espec√≠ficos
    function handleSpecificCropQuestion(lowerMessage, cropMatch) {
      const { key, crop } = cropMatch;
      let response = `${crop.icon} **${crop.name.toUpperCase()} - INFORMACI√ìN T√âCNICA**\n\n`;
      
      response += `**üìä REQUERIMIENTOS NUTRICIONALES:**\n`;
      response += `‚Ä¢ **pH ideal:** ${crop.pH_ideal}\n`;
      response += `‚Ä¢ **CIC ideal:** ${crop.CIC_ideal}\n`;
      response += `‚Ä¢ **Calcio:** ${crop.Ca_ideal}\n`;
      response += `‚Ä¢ **Potasio:** ${crop.K_ideal}\n`;
      response += `‚Ä¢ **Magnesio:** ${crop.Mg_ideal}\n\n`;
      
      if (lowerMessage.includes('deficiencia') || lowerMessage.includes('sintomas')) {
        response += `**‚ö†Ô∏è S√çNTOMAS DE DEFICIENCIA:**\n`;
        for (let symptom in crop.symptoms) {
          const nutrient = symptom.replace('deficiencia_', '').replace('_', ' ');
          response += `‚Ä¢ **${nutrient.toUpperCase()}:** ${crop.symptoms[symptom]}\n`;
        }
        response += `\n`;
      }
      
      if (lowerMessage.includes('fertilizante') || lowerMessage.includes('aplicar')) {
        response += `**üí° FERTILIZANTES RECOMENDADOS:**\n`;
        crop.fertilizers.forEach(fertilizer => {
          response += `‚Ä¢ ${fertilizer}\n`;
        });
        response += `\n`;
      }
      
      response += `**¬øQu√© aspecto espec√≠fico de ${crop.name} te interesa m√°s?**`;
      
      return response;
    }
    
    // Funci√≥n para fertilizantes espec√≠ficos
    function handleSpecificFertilizerQuestion(lowerMessage, fertilizerMatch) {
      const { category, key, fertilizer } = fertilizerMatch;
      let response = `üß™ **${key.toUpperCase().replace('_', ' ')} - INFORMACI√ìN T√âCNICA**\n\n`;
      
      response += `**üìã ESPECIFICACIONES:**\n`;
      response += `‚Ä¢ **F√≥rmula:** ${fertilizer.formula}\n`;
      response += `‚Ä¢ **Categor√≠a:** ${category.replace('_', ' ')}\n`;
      response += `‚Ä¢ **Uso principal:** ${fertilizer.uso}\n\n`;
      
      response += `**üìä CONTENIDO NUTRICIONAL:**\n`;
      for (let nutrient in fertilizer) {
        if (typeof fertilizer[nutrient] === 'number') {
          response += `‚Ä¢ **${nutrient.toUpperCase()}:** ${fertilizer[nutrient]}%\n`;
        }
      }
      response += `\n`;
      
      if (fertilizer.cultivos && fertilizer.cultivos.length > 0) {
        response += `**üå± CULTIVOS RECOMENDADOS:**\n`;
        fertilizer.cultivos.forEach(crop => {
          response += `‚Ä¢ ${crop.charAt(0).toUpperCase() + crop.slice(1)}\n`;
        });
        response += `\n`;
      }
      
      if (lowerMessage.includes('aplicar') || lowerMessage.includes('dosis')) {
        response += `**üí° RECOMENDACIONES DE APLICACI√ìN:**\n`;
        response += `‚Ä¢ **Fertilizaci√≥n base:** 200-400 kg/ha\n`;
        response += `‚Ä¢ **Fertirriego:** 50-100 ppm\n`;
        response += `‚Ä¢ **Aplicaci√≥n foliar:** 0.5-1.0%\n`;
        response += `‚Ä¢ **√âpoca:** Seg√∫n etapa fenol√≥gica del cultivo\n\n`;
      }
      
      response += `**¬øNecesitas informaci√≥n sobre dosis espec√≠ficas o aplicaci√≥n?**`;
      
      return response;
    }
    
    // Funci√≥n para an√°lisis de s√≠ntomas
    function handleSymptomAnalysis(lowerMessage) {
      const userInfo = conversationContext.userInfo;
      let response = `Ah, veo que tienes algunos s√≠ntomas preocupantes. `;
      
      if (userInfo.crop) {
        response += `En ${userInfo.crop}`;
        if (userInfo.variety) response += ` (${userInfo.variety})`;
        response += ` esto es bastante com√∫n. `;
      }
      
      if (lowerMessage.includes('deficiencia') && lowerMessage.includes('calcio')) {
        response += `\n\nEl problema de calcio que describes es t√≠pico cuando los bordes de las hojas se queman. `;
        response += `Esto pasa porque el calcio no se mueve bien dentro de la planta, `;
        response += `especialmente en condiciones de estr√©s h√≠drico o cuando hay desequilibrios nutricionales. `;
        
        response += `\n\n**Lo que te recomiendo hacer:**\n`;
        response += `‚Ä¢ Aplicar cal dolom√≠tica al suelo (2-3 ton/ha) - esto es lo m√°s importante\n`;
        response += `‚Ä¢ Usar nitrato de calcio en el fertirriego\n`;
        response += `‚Ä¢ Aplicar cloruro de calcio foliar al 0.5% cada 15 d√≠as\n`;
        response += `‚Ä¢ Revisar que no haya encharcamientos\n`;
        
        if (userInfo.crop === 'Aguacate') {
          response += `\n\n**Para aguacate espec√≠ficamente:**\n`;
          response += `‚Ä¢ El calcio es cr√≠tico para la calidad del fruto\n`;
          response += `‚Ä¢ Aplica en oto√±o para que est√© disponible en primavera\n`;
          response += `‚Ä¢ Haz an√°lisis foliar cada 3 meses para monitorear\n`;
        }
      }
      
      if (lowerMessage.includes('quemado') && lowerMessage.includes('borde')) {
        response += `\n\nLos bordes quemados tambi√©n pueden ser por falta de potasio. `;
        response += `¬øLos s√≠ntomas aparecen primero en las hojas viejas o en las nuevas? `;
        response += `Eso me ayudar√≠a a confirmar si es calcio o potasio. `;
        
        response += `\n\n**Mientras tanto, puedes:**\n`;
        response += `‚Ä¢ Aplicar sulfato de potasio (200-300 kg/ha)\n`;
        response += `‚Ä¢ Lavar sales del suelo con riego abundante\n`;
        response += `‚Ä¢ Fraccionar las aplicaciones de fertilizantes\n`;
      }
      
      response += `\n\n¬øEn qu√© parte de la planta empezaron los s√≠ntomas? ¬øY cu√°ndo los notaste por primera vez?`;
      
      return response;
    }
    
    // Funci√≥n para manejar preguntas sobre pH y tipos de enmienda
    function handlePHAmendmentQuestion(lowerMessage) {
      const soilData = getSoilAnalysisData();
      
      // Leer los resultados actuales de la calculadora
      const amendmentTypeElement = document.getElementById('amendment-type');
      const amendmentAmountElement = document.getElementById('amendment-amount');
      
      let response = `¬°Excelente pregunta! Con pH 7, tienes un suelo neutro, lo cual es ideal para la mayor√≠a de cultivos. `;
      
      if (amendmentTypeElement && amendmentAmountElement) {
        const currentAmendment = amendmentTypeElement.textContent;
        const currentAmount = amendmentAmountElement.textContent;
        
        response += `Veo que la calculadora recomienda **${currentAmount} de ${currentAmendment}**. `;
      }
      
      // An√°lisis espec√≠fico para pH 7
      response += `\n\n**Para pH 7, mi recomendaci√≥n es:**\n\n`;
      
      if (lowerMessage.includes('cal') && lowerMessage.includes('yeso')) {
        response += `**Cal Agr√≠cola vs Yeso Agr√≠cola:**\n`;
        response += `‚Ä¢ **Cal Agr√≠cola:** Ideal para elevar pH y aportar calcio. Con pH 7, no necesitas elevar m√°s el pH.\n`;
        response += `‚Ä¢ **Yeso Agr√≠cola:** Mejor opci√≥n para pH 7. Aporta calcio sin cambiar el pH y desplaza sodio.\n\n`;
        response += `**Mi recomendaci√≥n:** Usar **Yeso Agr√≠cola** en lugar de cal, ya que:\n`;
        response += `‚Ä¢ No altera el pH (que ya est√° perfecto en 7)\n`;
        response += `‚Ä¢ Aporta calcio disponible para las plantas\n`;
        response += `‚Ä¢ Desplaza sodio si lo hay en el suelo\n`;
        response += `‚Ä¢ Mejora la estructura del suelo\n\n`;
        
        if (lowerMessage.includes('5 toneladas') || lowerMessage.includes('5 ton')) {
          response += `**Sobre las 5 toneladas:**\n`;
          response += `‚Ä¢ Si la calculadora sugiere cal, c√°mbiala por yeso\n`;
          response += `‚Ä¢ La cantidad puede ser similar (5 ton de yeso)\n`;
          response += `‚Ä¢ El yeso es m√°s efectivo en suelos neutros\n`;
        }
      } else if (lowerMessage.includes('ph') && lowerMessage.includes('7')) {
        response += `**Con pH 7, tu suelo est√° en el rango ideal.**\n`;
        response += `‚Ä¢ No necesitas enmiendas para corregir acidez\n`;
        response += `‚Ä¢ El yeso es mejor que la cal para aportar calcio\n`;
        response += `‚Ä¢ Mant√©n el pH entre 6.5-7.5 para mejor disponibilidad de nutrientes\n`;
      }
      
      response += `\n\n¬øTe gustar√≠a que ajuste la calculadora para usar yeso en lugar de cal?`;
      
      return response;
    }
    
    // Funci√≥n para manejar preguntas sobre cantidades
    function handleQuantityQuestion(lowerMessage) {
      const soilData = getSoilAnalysisData();
      
      if (!soilData || soilData.cic === 0) {
        return 'No tengo datos de an√°lisis de suelo para calcular las cantidades. ¬øPodr√≠as ingresar los valores en la calculadora primero?';
      }
      
      // Leer los resultados actuales de la calculadora
      const amendmentTypeElement = document.getElementById('amendment-type');
      const amendmentAmountElement = document.getElementById('amendment-amount');
      const caContributionElement = document.getElementById('ca-contribution');
      const naRemovalElement = document.getElementById('na-removal');
      
      if (amendmentTypeElement && amendmentAmountElement) {
        const amendmentType = amendmentTypeElement.textContent;
        const amendmentAmount = amendmentAmountElement.textContent;
        const caContribution = caContributionElement ? caContributionElement.textContent : '0';
        const naRemoval = naRemovalElement ? naRemovalElement.textContent : '0';
        
        // Convertir kg/ha a toneladas
        const kgPerHa = parseFloat(amendmentAmount.replace(/[^\d.]/g, '')) || 0;
        const tonsPerHa = (kgPerHa / 1000).toFixed(1);
        
        if (kgPerHa > 0) {
          return `¬°Exacto! La recomendaci√≥n actual es de **${amendmentAmount}**, que equivale a **${formatNumber(tonsPerHa, 1)} toneladas por hect√°rea**.\n\n` +
                 `**Desglose de la recomendaci√≥n:**\n` +
                 `‚Ä¢ **${amendmentType}:** ${amendmentAmount}\n` +
                 `‚Ä¢ **Calcio a aportar:** ${caContribution} kg/ha de Ca\n` +
                 `‚Ä¢ **Sodio a remover:** ${naRemoval} kg/ha de Na\n` +
                 `‚Ä¢ **Aplicaci√≥n:** Fraccionar en 2-3 aplicaciones\n\n` +
                 `**Consideraciones importantes:**\n` +
                 `‚Ä¢ Aplicar en oto√±o para que est√© disponible en primavera\n` +
                 `‚Ä¢ Incorporar al suelo con rastra o cultivador\n` +
                 `‚Ä¢ Monitorear pH del suelo despu√©s de la aplicaci√≥n\n\n` +
                 `¬øTe parece adecuada esta cantidad para tu cultivo? ¬øHay algo espec√≠fico que te gustar√≠a ajustar?`;
        }
      }
      
      // Pregunta general sobre cantidades
      if (lowerMessage.includes('cantidad') || lowerMessage.includes('cuanto')) {
        return `Para darte una recomendaci√≥n precisa de cantidades, necesito que ingreses los valores de tu an√°lisis de suelo en la calculadora y hagas clic en "Calcular Enmienda". ` +
               `Una vez que lo hagas, podr√© calcular exactamente cu√°nto yeso, cal o dolomita necesitas aplicar.\n\n` +
               `**¬øQu√© informaci√≥n necesito?**\n` +
               `‚Ä¢ Valores de CIC y cationes (K‚Å∫, Ca¬≤‚Å∫, Mg¬≤‚Å∫, H‚Å∫, Na‚Å∫, Al¬≥‚Å∫)\n` +
               `‚Ä¢ Tipo de enmienda que prefieres (Yeso, Cal, o Dolomita)\n` +
               `‚Ä¢ Profundidad de aplicaci√≥n\n\n` +
               `¬øPodr√≠as llenar la calculadora con tus datos y hacer el c√°lculo?`;
      }
      
      return 'Entiendo tu pregunta sobre cantidades. ¬øPodr√≠as ser m√°s espec√≠fico sobre qu√© tipo de enmienda o cantidad te interesa?';
    }
    
    // Funci√≥n para usar ChatGPT real OPTIMIZADA
    async function tryChatGPT(message) {
      console.log('ü§ñ Usando ChatGPT real...');
      
      // Verificar si realmente necesitamos ChatGPT
      if (shouldUseChatGPT(message)) {
        try {
          // Construir contexto completo
          const context = buildContextForChatGPT(message);
          
          // Llamar a ChatGPT
          const response = await callOpenAI(context);
          
          if (response && response.trim()) {
            console.log('‚úÖ ChatGPT respondi√≥ exitosamente');
            // Guardar en historial de conversaci√≥n
            conversationContext.conversationHistory.push({
              type: 'ai',
              message: response,
              timestamp: new Date().toISOString(),
              source: 'chatgpt'
            });
            return response;
          }
        } catch (error) {
          console.error('‚ùå Error con ChatGPT:', error);
        }
      } else {
        console.log('‚è≠Ô∏è Saltando ChatGPT - no necesario');
      }
      
      return null;
    }
    
    // Funci√≥n para determinar si usar ChatGPT - SIEMPRE USAR
    function shouldUseChatGPT(message) {
      // SIEMPRE usar ChatGPT para que razone como yo
      return true;
    }
    
    // Obtener proyecto actual para contexto multi-secci√≥n (cualquier pesta√±a)
    function getProjectDataForChat() {
      const projectId = localStorage.getItem('nutriplant-current-project') || (typeof nutriPlantStorage !== 'undefined' && nutriPlantStorage.currentProjectId);
      if (!projectId || typeof nutriPlantStorage === 'undefined') return null;
      return nutriPlantStorage.getProject(projectId);
    }

    // Funci√≥n para construir contexto para ChatGPT
    function buildContextForChatGPT(message) {
      const soilData = getSoilAnalysisData();
      const userInfo = conversationContext.userInfo;
      const currentSection = detectCurrentSection();
      const project = getProjectDataForChat();
      const sectionNames = { enmienda: 'Enmienda (CIC / c√°lculo de enmiendas)', fertirriego: 'Fertirriego', hidroponia: 'Hidropon√≠a', analisis: 'An√°lisis', extracto: 'Extracto de pasta', ubicacion: 'Ubicaci√≥n', reportes: 'Reportes', configuracion: 'Configuraci√≥n' };

      let context = `Eres NutriPlant Assistant, un experto en nutrici√≥n vegetal y an√°lisis de suelos especializado en la plataforma NutriPlant PRO.

CONOCIMIENTO ESPEC√çFICO DE NUTRIPLANT PRO:
- Especialista en ajuste de CIC (Capacidad de Intercambio Cati√≥nico)
- Experto en enmiendas: Yeso (CaSO‚ÇÑ¬∑2H‚ÇÇO), Cal Dolom√≠tica (CaCO‚ÇÉ + MgCO‚ÇÉ), Cal Agr√≠cola (CaCO‚ÇÉ), SOP Granular (K‚ÇÇSO‚ÇÑ), MgSO‚ÇÑ¬∑H‚ÇÇO
- Rangos ideales de cationes: K‚Å∫ 3-7%, Ca¬≤‚Å∫ 65-75%, Mg¬≤‚Å∫ 10-15%, H‚Å∫ 0-10%, Na‚Å∫ 0-1%, Al¬≥‚Å∫ 0-1%
- Algoritmo din√°mico de dosificaci√≥n basado en el elemento m√°s limitante
- Consideraciones de pH: Cal Agr√≠cola solo si pH < 7, Yeso permite en cualquier pH
- Umbral m√≠nimo operativo: 100 kg/ha

SECCI√ìN ACTUAL (pesta√±a donde est√° el usuario): ${sectionNames[currentSection] || currentSection}
`;
      // Enmienda: 1) √∫ltimo resultado guardado al calcular (dashboard.js), 2) DOM, 3) proyecto guardado
      const amendFromLastResult = (typeof window.__nutriplantLastAmendmentResult !== 'undefined' && window.__nutriplantLastAmendmentResult) ? window.__nutriplantLastAmendmentResult : null;
      const amendFromDom = (function() {
        const t = document.getElementById('amendment-type');
        const a = document.getElementById('amendment-amount');
        return (t && a) ? { type: (t.textContent || '').trim(), amount: (a.textContent || '').trim() } : null;
      })();
      let amendFromTable = null;
      if ((!amendFromDom || !amendFromDom.type || amendFromDom.type === '-' || !amendFromDom.amount || amendFromDom.amount === '-')) {
        const res = document.getElementById('amendment-results');
        if (res) {
          const row = res.querySelector('table.results-table tbody tr');
          if (row) {
            const cells = row.querySelectorAll('td');
            const name = (cells[0] && cells[0].textContent) ? cells[0].textContent.replace(/^‚ö†Ô∏è\s*/, '').trim() : '';
            const amount = (cells[1] && cells[1].textContent) ? cells[1].textContent.trim() : '';
            const ca = (cells[3] && cells[3].textContent && cells[3].textContent.trim() !== '-') ? cells[3].textContent.trim() : '';
            const so4 = (cells[5] && cells[5].textContent && cells[5].textContent.trim() !== '-') ? cells[5].textContent.trim() : '';
            if (name || amount) amendFromTable = { type: name, amount: amount ? amount + ' kg/ha' : '', ca: ca, so4: so4 };
          }
          if (!amendFromTable && res.querySelector('.amendment-summary')) {
            const ul = res.querySelector('.amendment-summary ul');
            if (ul) {
              const lis = ul.querySelectorAll('li');
              let caTotal = '', so4Total = '';
              lis.forEach(li => {
                const t = (li.textContent || '').trim();
                if (t.indexOf('Calcio') !== -1) caTotal = t.replace(/.*:\s*/, '').trim();
                if (t.indexOf('Sulfato') !== -1) so4Total = t.replace(/.*:\s*/, '').trim();
              });
              amendFromTable = { type: 'Yeso Agr√≠cola', amount: '', ca: caTotal, so4: so4Total };
            }
          }
        }
      }
      const amendFromProject = (project && (project.amendments || project.enmiendas)) ? (project.amendments || project.enmiendas).results : null;
      const amendType = (amendFromLastResult && amendFromLastResult.type) ? amendFromLastResult.type : (amendFromDom && amendFromDom.type && amendFromDom.type !== '-') ? amendFromDom.type : (amendFromTable && amendFromTable.type) ? amendFromTable.type : (amendFromProject && amendFromProject.type) ? amendFromProject.type : '';
      const amendAmount = (amendFromLastResult && amendFromLastResult.amount) ? (amendFromLastResult.amount + ' kg/ha') : (amendFromDom && amendFromDom.amount && amendFromDom.amount !== '-') ? amendFromDom.amount : (amendFromTable && amendFromTable.amount) ? amendFromTable.amount : (amendFromProject && amendFromProject.amount) ? amendFromProject.amount : '';
      const amendCa = (amendFromLastResult && amendFromLastResult.ca) ? amendFromLastResult.ca : (amendFromTable && amendFromTable.ca) ? amendFromTable.ca : '';
      const amendSo4 = (amendFromLastResult && amendFromLastResult.so4) ? amendFromLastResult.so4 : (amendFromTable && amendFromTable.so4) ? amendFromTable.so4 : '';
      if (amendType || amendAmount || amendCa || amendSo4) {
        context += `\n>>> DATOS DEL C√ÅLCULO DE ENMIENDA (OBLIGATORIO USAR ESTOS N√öMEROS EN TU RESPUESTA):\n`;
        context += `- Enmienda: ${amendType || 'N/D'}\n`;
        context += `- Cantidad (kg/ha): ${amendAmount || 'N/D'}\n`;
        if (amendCa) context += `- Aporte Ca¬≤‚Å∫ (kg/ha): ${amendCa}\n`;
        if (amendSo4) context += `- Aporte SO‚ÇÑ¬≤‚Åª (kg/ha): ${amendSo4}\n`;
        context += `NO digas que no tienes acceso. Estos datos te los estamos enviando aqu√≠; responde con estos valores exactos.\n\n`;
      }
      context += `(Usa solo los datos que aparecen abajo; no inventes cifras.)\n\nDATOS ACTUALES DEL USUARIO:\n`;
      
      // Informaci√≥n del usuario
      if (userInfo.crop) context += `Cultivo: ${userInfo.crop}\n`;
      if (userInfo.variety) context += `Variedad: ${userInfo.variety}\n`;
      if (userInfo.location) context += `Ubicaci√≥n: ${userInfo.location}\n`;
      if (userInfo.pH) context += `pH del suelo: ${userInfo.pH}\n`;
      if (userInfo.age) context += `Edad: ${userInfo.age}\n`;
      if (userInfo.yield) context += `Rendimiento: ${userInfo.yield}\n`;
      
      // Datos del suelo con an√°lisis de problemas
      if (soilData && soilData.cic > 0) {
        context += `\nüìä AN√ÅLISIS DE SUELO ACTUAL:\n`;
        context += `- CIC Total: ${soilData.cic} meq/100g\n`;
        context += `- K‚Å∫: ${soilData.k} meq (${((soilData.k/soilData.cic)*100).toFixed(1)}%) - Rango ideal: 3-7%\n`;
        context += `- Ca¬≤‚Å∫: ${soilData.ca} meq (${((soilData.ca/soilData.cic)*100).toFixed(1)}%) - Rango ideal: 65-75%\n`;
        context += `- Mg¬≤‚Å∫: ${soilData.mg} meq (${((soilData.mg/soilData.cic)*100).toFixed(1)}%) - Rango ideal: 10-15%\n`;
        context += `- H‚Å∫: ${soilData.h} meq (${((soilData.h/soilData.cic)*100).toFixed(1)}%) - Rango ideal: 0-10%\n`;
        context += `- Na‚Å∫: ${soilData.na} meq (${((soilData.na/soilData.cic)*100).toFixed(1)}%) - Rango ideal: 0-1%\n`;
        context += `- Al¬≥‚Å∫: ${soilData.al} meq (${((soilData.al/soilData.cic)*100).toFixed(1)}%) - Rango ideal: 0-1%\n`;

        // An√°lisis de problemas detectados
        const problems = [];
        const recommendations = [];
        
        // K‚Å∫
        const kPercent = (soilData.k/soilData.cic)*100;
        if (kPercent < 3) {
          problems.push(`K‚Å∫ est√° por debajo del rango ideal (${kPercent.toFixed(1)}% < 3%)`);
          recommendations.push(`Aumentar K‚Å∫ a ${(3 * soilData.cic / 100).toFixed(2)} meq`);
        } else if (kPercent > 7) {
          problems.push(`K‚Å∫ est√° por encima del rango ideal (${kPercent.toFixed(1)}% > 7%)`);
        }

        // Ca¬≤‚Å∫
        const caPercent = (soilData.ca/soilData.cic)*100;
        if (caPercent < 65) {
          problems.push(`Ca¬≤‚Å∫ est√° por debajo del rango ideal (${caPercent.toFixed(1)}% < 65%)`);
          recommendations.push(`Aumentar Ca¬≤‚Å∫ a ${(65 * soilData.cic / 100).toFixed(2)} meq`);
        } else if (caPercent > 75) {
          problems.push(`Ca¬≤‚Å∫ est√° por encima del rango ideal (${caPercent.toFixed(1)}% > 75%)`);
        }

        // Mg¬≤‚Å∫
        const mgPercent = (soilData.mg/soilData.cic)*100;
        if (mgPercent < 10) {
          problems.push(`Mg¬≤‚Å∫ est√° por debajo del rango ideal (${mgPercent.toFixed(1)}% < 10%)`);
          recommendations.push(`Aumentar Mg¬≤‚Å∫ a ${(10 * soilData.cic / 100).toFixed(2)} meq`);
        } else if (mgPercent > 15) {
          problems.push(`Mg¬≤‚Å∫ est√° por encima del rango ideal (${mgPercent.toFixed(1)}% > 15%)`);
        }

        // Na‚Å∫
        const naPercent = (soilData.na/soilData.cic)*100;
        if (naPercent > 1) {
          problems.push(`Na‚Å∫ est√° por encima del rango ideal (${naPercent.toFixed(1)}% > 1%)`);
          recommendations.push(`Reducir Na‚Å∫ usando enmiendas con SO‚ÇÑ para desplazamiento`);
        }

        if (problems.length > 0) {
          context += `\n‚ö†Ô∏è PROBLEMAS DETECTADOS:\n`;
          problems.forEach(problem => context += `‚Ä¢ ${problem}\n`);
        }

        if (recommendations.length > 0) {
          context += `\nüí° RECOMENDACIONES T√âCNICAS:\n`;
          recommendations.forEach(rec => context += `‚Ä¢ ${rec}\n`);
        }
      }

      // Propiedades del suelo
      const phInput = document.getElementById('soil-ph');
      const densityInput = document.getElementById('soil-density');
      const depthInput = document.getElementById('soil-depth');
      
      if (phInput?.value || densityInput?.value || depthInput?.value) {
        context += `\nüå± PROPIEDADES DEL SUELO:\n`;
        if (phInput?.value) context += `- pH: ${phInput.value}\n`;
        if (densityInput?.value) context += `- Densidad aparente: ${densityInput.value} g/cm¬≥\n`;
        if (depthInput?.value) context += `- Profundidad: ${depthInput.value} cm\n`;
      }

      // Objetivos de ajuste
      const kTarget = document.getElementById('k-target')?.value;
      const caTarget = document.getElementById('ca-target')?.value;
      const mgTarget = document.getElementById('mg-target')?.value;
      
      if (kTarget || caTarget || mgTarget) {
        context += `\nüéØ OBJETIVOS DE AJUSTE (meq a agregar):\n`;
        if (kTarget && parseFloat(kTarget) > 0) context += `- K‚Å∫: +${kTarget} meq\n`;
        if (caTarget && parseFloat(caTarget) > 0) context += `- Ca¬≤‚Å∫: +${caTarget} meq\n`;
        if (mgTarget && parseFloat(mgTarget) > 0) context += `- Mg¬≤‚Å∫: +${mgTarget} meq\n`;
      }
      
      // Resultados de la calculadora (enmienda) ‚Äî poner al inicio para que el modelo los priorice
      const amendmentTypeElement = document.getElementById('amendment-type');
      const amendmentAmountElement = document.getElementById('amendment-amount');
      if (amendmentTypeElement && amendmentAmountElement) {
        const tipo = (amendmentTypeElement.textContent || '').trim();
        const cant = (amendmentAmountElement.textContent || '').trim();
        if (tipo !== '-' && cant !== '-') {
          context += `\n‚ö†Ô∏è VALOR QUE VE EL USUARIO EN PANTALLA (usar este dato): ${tipo} ‚Äî ${cant}\n`;
        }
        context += `\nüìã RECOMENDACI√ìN ACTUAL DE LA CALCULADORA:\n`;
        context += `- Enmienda: ${amendmentTypeElement.textContent}\n`;
        context += `- Cantidad: ${amendmentAmountElement.textContent}\n`;
      }
      const amendmentResultsSection = document.getElementById('amendment-results');
      if (amendmentResultsSection && amendmentResultsSection.innerText) {
        const resultsText = amendmentResultsSection.innerText.replace(/\s+/g, ' ').trim();
        if (resultsText.length > 50) {
          context += `\nüìä RESULTADOS CALCULADORA DE ENMIENDA (disponibles en la app):\n${resultsText}\n`;
        }
      }

      // Resumen de otras secciones del proyecto (para que puedas responder en cualquier pesta√±a)
      context += `\n--- DATOS GUARDADOS EN OTRAS SECCIONES DEL PROYECTO ---\n`;
      if (project) {
        const ferti = project.fertirriego || project.sections?.fertirriego;
        if (ferti && (ferti.weeks?.length || ferti.columns?.length)) {
          const weeks = ferti.weeks?.length || 0;
          const cols = (ferti.columns || []).map(c => c.name || c.id).filter(Boolean).join(', ') || 'sin columnas';
          context += `Fertirriego: ${weeks} semanas/unidades; fertilizantes: ${cols}.`;
          if (ferti.requerimiento) context += ` Requerimiento y diferencia guardados.`;
          context += `\n`;
        }
        const hydro = project.hidroponia || project.sections?.hidroponia;
        if (hydro && (hydro.stages?.length || hydro.solutions)) {
          const stages = hydro.stages?.length || 0;
          context += `Hidropon√≠a: ${stages} etapas; soluciones nutritivas configuradas.\n`;
        }
        const enm = project.amendments || project.enmiendas || project.sections?.enmiendas || project.sections?.amendments;
        if (enm && (enm.results || enm.selected?.length)) {
          const r = enm.results;
          if (r && (r.type || r.amount)) context += `Enmiendas (guardado): ${r.type || ''} ${r.amount || ''}\n`;
          else context += `Enmiendas (guardado): resultados o selecci√≥n guardada.\n`;
        }
      } else {
        context += `(No hay proyecto cargado o no hay datos de otras secciones.)\n`;
      }
      
      // Historial de conversaci√≥n reciente
      if (conversationContext.conversationHistory.length > 0) {
        context += `\nüí¨ HISTORIAL RECIENTE:\n`;
        const recentHistory = conversationContext.conversationHistory.slice(-3);
        recentHistory.forEach(entry => {
          context += `${entry.type === 'user' ? 'Usuario' : 'IA'}: ${entry.message}\n`;
        });
      }
      
      // Resumen de valores justo antes de la pregunta: el modelo debe CITAR estos n√∫meros en la respuesta
      const valoresLinea = [];
      if (amendType) valoresLinea.push('Enmienda: ' + amendType);
      if (amendAmount) valoresLinea.push('Cantidad: ' + amendAmount);
      if (amendCa) valoresLinea.push('Ca¬≤‚Å∫: ' + amendCa);
      if (amendSo4) valoresLinea.push('SO‚ÇÑ¬≤‚Åª: ' + amendSo4);
      if (valoresLinea.length > 0) {
        context += `\n--- VALORES QUE DEBES CITAR EN TU RESPUESTA (no des respuesta gen√©rica; escribe estos n√∫meros) ---\n`;
        context += valoresLinea.join(' | ') + '\n';
      } else {
        context += `\n--- En este mensaje no hay resultados de enmienda a√∫n. Si preguntan por resultados o cantidades: di que use el bot√≥n "Calcular Enmienda" y luego pregunte de nuevo. PROHIBIDO decir "no tengo acceso" o "comparte los valores". ---\n`;
      }
      
      context += `\nPREGUNTA ACTUAL: ${message}\n\n`;
      context += `NUNCA digas que no tienes acceso a la app. Si hay valores arriba, c√≠talos; si no hay, di que calcule primero. Responde en espa√±ol.`;
      
      return context;
    }
    
    // Funci√≥n para llamar a OpenAI
    async function callOpenAI(context) {
      console.log('üöÄ LLAMANDO A OPENAI...');
      console.log('üìù Contexto:', context);
      
      try {
        const response = await fetch((window.getNutriPlantApiBase ? window.getNutriPlantApiBase() : 'http://localhost:8000') + '/api/openai-assistant', {
          method: 'POST',
          mode: 'cors',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            userId: localStorage.getItem('nutriplant_user_id') || 'anonymous',
            projectId: localStorage.getItem('nutriplant-current-project') || '',
            module: detectCurrentSection(),
            model: 'gpt-4o-mini',
            messages: [
              {
                role: 'system',
                content: `Eres el asistente de NutriPlant PRO. Responde en espa√±ol.

PROHIBIDO: Decir "no tengo acceso", "no puedo ver esa secci√≥n", "comparte los valores" o "comparte esos datos". Los datos te llegan en el mensaje; si no hay n√∫meros a√∫n, di que use "Calcular Enmienda" y pregunte despu√©s.

CONTRATO:
1. Los datos del proyecto (enmienda, suelo, fertirriego) te llegan en el mensaje siguiente. Si hay bloque "VALORES QUE DEBES CITAR", usa esos n√∫meros en tu respuesta.
2. Si preguntan por resultado/cantidad y hay valores en el mensaje: cita los n√∫meros exactos (ej. "Seg√∫n tu c√°lculo: X kg/ha de Yeso; Ca¬≤‚Å∫ Y kg/ha"). No des respuesta gen√©rica.
3. Si preguntan por resultado pero en el mensaje no hay valores: responde "A√∫n no hay resultados. Usa el bot√≥n Calcular Enmienda y luego pregunta de nuevo." No pidas que te compartan nada.
4. Si preguntan an√°lisis o recomendaci√≥n: usa los datos del mensaje y responde concreto.
5. No inventes n√∫meros.`
              },
              {
                role: 'user',
                content: context
              }
            ],
            max_tokens: 650,
            temperature: 0.25
          })
        });
        
        if (!response.ok) {
          throw new Error(`Error de API: ${response.status}`);
        }
        
        const data = await response.json();
        return data.choices[0].message.content;
      } catch (error) {
        console.error('Error llamando a OpenAI:', error);
        return null;
      }
    }
    
    // Funci√≥n de fallback gen√©rico ELIMINADA - Todas las preguntas van al an√°lisis directo
    
    // Funci√≥n para an√°lisis espec√≠fico por secci√≥n
    function getSectionSpecificAnalysis() {
      const knowledge = getContextualKnowledge();
      let analysis = `**${knowledge.icon} AN√ÅLISIS ESPEC√çFICO - ${knowledge.name.toUpperCase()}**\n\n`;
      
      if (currentSection === 'fertirriego') {
        analysis += `**üíß FERTIRRIEGO:**\n`;
        analysis += `‚Ä¢ **Programa de nutrici√≥n:** C√°lculo de dosis seg√∫n etapa fenol√≥gica\n`;
        analysis += `‚Ä¢ **Fertirrigaci√≥n:** Concentraciones y vol√∫menes √≥ptimos\n`;
        analysis += `‚Ä¢ **Riego:** Frecuencia y duraci√≥n seg√∫n clima y suelo\n`;
        analysis += `‚Ä¢ **pH del agua:** Ajuste para m√°xima disponibilidad\n\n`;
        analysis += `**üìä F√ìRMULAS CLAVE:**\n`;
        analysis += `‚Ä¢ Dosis = (Demanda √ó √Årea) / Eficiencia\n`;
        analysis += `‚Ä¢ Concentraci√≥n = Dosis / Volumen_agua\n`;
        analysis += `‚Ä¢ EC = Œ£(Concentraci√≥n √ó Factor)\n`;
      } else if (currentSection === 'hidroponia') {
        analysis += `**üå± HIDROPON√çA:**\n`;
        analysis += `‚Ä¢ **Soluci√≥n nutritiva:** Balance de macro y microelementos\n`;
        analysis += `‚Ä¢ **EC √≥ptima:** 1.2-2.5 mS/cm seg√∫n cultivo\n`;
        analysis += `‚Ä¢ **pH √≥ptimo:** 5.5-6.5 para m√°xima absorci√≥n\n`;
        analysis += `‚Ä¢ **Sistema:** NFT, DWC, o sustrato inerte\n\n`;
        analysis += `**üìä F√ìRMULAS CLAVE:**\n`;
        analysis += `‚Ä¢ EC = Œ£(Concentraci√≥n √ó Factor)\n`;
        analysis += `‚Ä¢ pH = -log[H‚Å∫]\n`;
        analysis += `‚Ä¢ Concentraci√≥n = Peso / Volumen\n`;
      } else if (currentSection === 'analisis') {
        analysis += `**üî¨ AN√ÅLISIS:**\n`;
        analysis += `‚Ä¢ **An√°lisis foliar:** Interpretaci√≥n de resultados\n`;
        analysis += `‚Ä¢ **Diagn√≥stico:** Identificaci√≥n de deficiencias\n`;
        analysis += `‚Ä¢ **Correcci√≥n:** Estrategias de mejora\n`;
        analysis += `‚Ä¢ **Monitoreo:** Seguimiento de la evoluci√≥n\n\n`;
        analysis += `**üìä F√ìRMULAS CLAVE:**\n`;
        analysis += `‚Ä¢ √çndice DRIS = (Valor - Promedio) / Desviaci√≥n\n`;
        analysis += `‚Ä¢ Relaci√≥n = Nutriente1 / Nutriente2\n`;
        analysis += `‚Ä¢ Balance = Œ£(Nutrientes) / N√∫mero\n`;
      } else if (currentSection === 'extracto') {
        analysis += `**üß™ EXTRACTO:**\n`;
        analysis += `‚Ä¢ **Extracci√≥n:** M√©todos y eficiencia\n`;
        analysis += `‚Ä¢ **An√°lisis de pasta:** Interpretaci√≥n\n`;
        analysis += `‚Ä¢ **Recomendaciones:** Basadas en resultados\n`;
        analysis += `‚Ä¢ **Calibraci√≥n:** Ajuste de m√©todos\n\n`;
        analysis += `**üìä F√ìRMULAS CLAVE:**\n`;
        analysis += `‚Ä¢ Extracci√≥n = Concentraci√≥n √ó Volumen\n`;
        analysis += `‚Ä¢ Eficiencia = Extra√≠do / Aplicado\n`;
        analysis += `‚Ä¢ Concentraci√≥n = Peso / Volumen\n`;
      }
      
      return analysis;
    }
    
    // Funci√≥n para responder preguntas espec√≠ficas sobre cultivos y manejo
    function handleCropQuestion(lowerMessage) {
      if ((lowerMessage.includes('raiz') || lowerMessage.includes('ra√≠z')) && 
          (lowerMessage.includes('50%') || lowerMessage.includes('mitad')) && 
          (lowerMessage.includes('yeso') || lowerMessage.includes('agricola') || lowerMessage.includes('agr√≠cola'))) {
        return `üå± **AN√ÅLISIS DE APLICACI√ìN DE YESO**\n\n**Tu pregunta:** ¬øAplicar la mitad de yeso si la ra√≠z accede al 50% del suelo?\n\n**ü§î CONSIDERACIONES IMPORTANTES:**\n\n1. **Zona de ra√≠ces vs. Suelo total:**\n   ‚Ä¢ Si la ra√≠z accede al 50%, el yeso debe aplicarse en esa zona\n   ‚Ä¢ El 50% restante puede tratarse en aplicaciones posteriores\n\n2. **Eficiencia de aplicaci√≥n:**\n   ‚Ä¢ **S√≠, es recomendable** fraccionar la aplicaci√≥n\n   ‚Ä¢ Aplicar 50% del yeso en la zona radicular activa\n   ‚Ä¢ El resto aplicarlo gradualmente\n\n3. **Estrategia recomendada:**\n   ‚Ä¢ **Primera aplicaci√≥n:** 50% del yeso en zona de ra√≠ces\n   ‚Ä¢ **Segunda aplicaci√≥n:** 25% en 30-60 d√≠as\n   ‚Ä¢ **Tercera aplicaci√≥n:** 25% restante seg√∫n evoluci√≥n\n\n**üí° PREGUNTA CLAVE:** ¬øCu√°l es el cultivo y en qu√© etapa est√°? Esto me ayudar√° a afinar la recomendaci√≥n.`;
      }
      
      if (lowerMessage.includes('cultivo') || lowerMessage.includes('siembra') || lowerMessage.includes('plantar') ||
          lowerMessage.includes('aguacate') || lowerMessage.includes('avocado') || 
          lowerMessage.includes('rendimiento') || lowerMessage.includes('a√±os de edad')) {
        return advancedReasoningAnalysis(lowerMessage);
      }
      
      return 'Interesante pregunta sobre manejo del cultivo. ¬øPodr√≠as darme m√°s detalles sobre tu situaci√≥n espec√≠fica?';
    }

    // Funciones de an√°lisis de suelo
    function analyzeSoilData() {
      const soilData = getSoilAnalysisData();
      if (!soilData || soilData.cic === 0) {
        return `üîç **An√°lisis de Suelo**\n\nNo hay datos de an√°lisis de suelo disponibles. Para analizar tu suelo:\n\n1. Ve a la secci√≥n "Enmienda"\n2. Ingresa los valores de cationes\n3. Luego puedo analizar y sugerir mejoras\n\n¬øQuieres que te gu√≠e paso a paso?`;
      }

      const analysis = performSoilAnalysis(soilData);
      return `üîç **An√°lisis de Suelo Detallado**\n\n**CIC Total:** ${soilData.cic} meq/100g\n\n**Estado de Cationes:**\n${analysis.cations.map(cat => 
        `‚Ä¢ **${cat.symbol}:** ${cat.value} meq (${cat.percent}%) ${cat.status} ${cat.icon}`
      ).join('\n')}\n\n**Problemas Identificados:**\n${analysis.problems.length > 0 ? analysis.problems.join('\n') : '‚úÖ Todos los cationes est√°n en rangos aceptables'}\n\n**Recomendaciones:**\n${analysis.recommendations.join('\n')}\n\n¬øQuieres que aplique los ajustes sugeridos?`;
    }

    function suggestIdealDistribution() {
      const soilData = getSoilAnalysisData();
      if (!soilData || soilData.cic === 0) {
        return `üìä **Distribuci√≥n Ideal**\n\nPrimero necesito que ingreses los datos de tu an√°lisis de suelo. Ve a la secci√≥n "Enmienda" y completa los valores de cationes.\n\nUna vez que tengas los datos, podr√© sugerir la distribuci√≥n ideal basada en los rangos √≥ptimos.`;
      }

      const idealValues = calculateIdealDistribution(soilData.cic);
      // Establecer contexto de confirmaci√≥n
      setConfirmationContext('applyValues', 'aplicar valores sugeridos');
      
      return `üìä **Distribuci√≥n Ideal Sugerida**\n\n**Para CIC de ${soilData.cic} meq/100g:**\n\n${idealValues.map(item => 
        `‚Ä¢ **${item.symbol}:** ${item.min}-${item.max} meq (${item.percentMin}-${item.percentMax}%)`
      ).join('\n')}\n\n**Valores Recomendados:**\n${idealValues.map(item => 
        `‚Ä¢ **${item.symbol}:** ${item.recommended} meq (${item.recommendedPercent}%)`
      ).join('\n')}\n\n¬øQuieres que aplique estos valores autom√°ticamente?`;
    }

    function applySuggestedValues() {
      const soilData = getSoilAnalysisData();
      if (!soilData || soilData.cic === 0) {
        return `‚ö†Ô∏è **No se pueden aplicar valores**\n\nPrimero necesito que ingreses los datos de tu an√°lisis de suelo. Ve a la secci√≥n "Enmienda" y completa los valores de cationes.`;
      }

      const idealValues = calculateIdealDistribution(soilData.cic);
      const applied = applyValuesToCalculator(idealValues);
      
      if (applied) {
        // Limpiar contexto despu√©s de aplicar
        clearContext();
        return `‚úÖ **Valores Aplicados Exitosamente**\n\nHe aplicado la distribuci√≥n ideal a tu calculadora de enmiendas:\n\n${idealValues.map(item => 
          `‚Ä¢ **${item.symbol}:** ${item.recommended} meq (${item.recommendedPercent}%)`
        ).join('\n')}\n\n**¬°Listo!** Los valores se han actualizado autom√°ticamente en la secci√≥n "Objetivos de Ajuste". Ahora puedes ver los porcentajes calculados y proceder con el c√°lculo de enmiendas.`;
      } else {
        // Limpiar contexto en caso de error
        clearContext();
        return `‚ùå **Error al aplicar valores**\n\nNo pude aplicar los valores autom√°ticamente. Por favor, verifica que est√©s en la secci√≥n correcta de la calculadora.`;
      }
    }

    function analyzeEverything() {
      let analysis = `üîç **An√°lisis Completo del Dashboard**\n\n`;
      
      analysis += `**üìç Secci√≥n Actual:** Enmienda\n`;
      analysis += `**üéØ Vista:** Calculadora de Enmiendas\n\n`;
      
      // An√°lisis de datos de suelo
      const soilData = getSoilAnalysisData();
      if (soilData && soilData.cic > 0) {
        analysis += `**üß™ An√°lisis de Suelo:**\n`;
        analysis += `‚Ä¢ CIC Total: ${soilData.cic} meq/100g\n`;
        analysis += `‚Ä¢ Estado: ${getSoilStatus(soilData)}\n\n`;
      } else {
        analysis += `**üß™ An√°lisis de Suelo:**\n`;
        analysis += `‚Ä¢ No hay datos de an√°lisis disponibles\n\n`;
      }
      
      // Recomendaciones generales
      analysis += `**üí° Recomendaciones:**\n`;
      analysis += `‚Ä¢ Mant√©n actualizados los an√°lisis de suelo\n`;
      analysis += `‚Ä¢ Utiliza las funciones de IA para optimizar resultados\n`;
      analysis += `‚Ä¢ Documenta todos los cambios y resultados\n\n`;
      
      analysis += `¬øSobre qu√© aspecto espec√≠fico te gustar√≠a profundizar?`;
      
      return analysis;
    }

    // Funciones auxiliares
    function getSoilAnalysisData() {
      console.log('üîç Leyendo datos del an√°lisis de suelo...');
      
      // Buscar elementos por ID
      let cicInput = document.getElementById('cic-total');
      let kInput = document.getElementById('k-initial');
      let caInput = document.getElementById('ca-initial');
      let mgInput = document.getElementById('mg-initial');
      let hInput = document.getElementById('h-initial');
      let naInput = document.getElementById('na-initial');
      let alInput = document.getElementById('al-initial');
      let phInput = document.getElementById('soil-ph');
      
      // Si no encuentra por ID, buscar por otros m√©todos
      if (!cicInput) {
        cicInput = document.querySelector('input[placeholder*="CIC"]') || 
                  document.querySelector('input[name*="cic"]') ||
                  document.querySelector('input[id*="cic"]');
      }
      
      if (!kInput) {
        kInput = document.querySelector('input[placeholder*="K"]') || 
                 document.querySelector('input[name*="k"]') ||
                 document.querySelector('input[id*="k"]');
      }
      
      if (!caInput) {
        caInput = document.querySelector('input[placeholder*="Ca"]') || 
                  document.querySelector('input[name*="ca"]') ||
                  document.querySelector('input[id*="ca"]');
      }
      
      if (!mgInput) {
        mgInput = document.querySelector('input[placeholder*="Mg"]') || 
                  document.querySelector('input[name*="mg"]') ||
                  document.querySelector('input[id*="mg"]');
      }
      
      if (!hInput) {
        hInput = document.querySelector('input[placeholder*="H"]') || 
                 document.querySelector('input[name*="h"]') ||
                 document.querySelector('input[id*="h"]');
      }
      
      if (!naInput) {
        naInput = document.querySelector('input[placeholder*="Na"]') || 
                  document.querySelector('input[name*="na"]') ||
                  document.querySelector('input[id*="na"]');
      }
      
      if (!alInput) {
        alInput = document.querySelector('input[placeholder*="Al"]') || 
                  document.querySelector('input[name*="al"]') ||
                  document.querySelector('input[id*="al"]');
      }
      
      if (!phInput) {
        phInput = document.querySelector('input[placeholder*="pH"]') || 
                  document.querySelector('input[name*="ph"]') ||
                  document.querySelector('input[id*="ph"]');
      }
      
      console.log('üìä Elementos encontrados:', {
        cicInput: !!cicInput,
        kInput: !!kInput,
        caInput: !!caInput,
        mgInput: !!mgInput,
        hInput: !!hInput,
        naInput: !!naInput,
        alInput: !!alInput,
        phInput: !!phInput
      });
      
      // Mostrar valores de los elementos encontrados
      if (cicInput) console.log('CIC valor:', cicInput.value);
      if (kInput) console.log('K valor:', kInput.value);
      if (caInput) console.log('Ca valor:', caInput.value);
      if (mgInput) console.log('Mg valor:', mgInput.value);
      if (hInput) console.log('H valor:', hInput.value);
      if (naInput) console.log('Na valor:', naInput.value);
      if (alInput) console.log('Al valor:', alInput.value);
      if (phInput) console.log('pH valor:', phInput.value);
      
      if (!cicInput || !kInput || !caInput || !mgInput || !hInput || !naInput || !alInput) {
        console.log('‚ùå Faltan elementos del DOM');
        console.log('üîç Intentando buscar todos los inputs...');
        
        // Buscar todos los inputs de tipo number
        const allInputs = document.querySelectorAll('input[type="number"]');
        console.log('üìù Todos los inputs encontrados:', allInputs.length);
        allInputs.forEach((input, index) => {
          console.log(`Input ${index}:`, {
            id: input.id,
            name: input.name,
            placeholder: input.placeholder,
            value: input.value,
            className: input.className
          });
        });
        
        return null;
      }
      
      const data = {
        cic: parseFloat(cicInput.value) || 0,
        k: parseFloat(kInput.value) || 0,
        ca: parseFloat(caInput.value) || 0,
        mg: parseFloat(mgInput.value) || 0,
        h: parseFloat(hInput.value) || 0,
        na: parseFloat(naInput.value) || 0,
        al: parseFloat(alInput.value) || 0,
        ph: phInput?.value ? parseFloat(phInput.value) : null
      };
      
      console.log('üìà Datos le√≠dos:', data);
      return data;
    }

    // Funci√≥n para obtener recomendaciones de enmienda basadas en pH
    function getAmendmentRecommendationByPH(ph) {
      if (ph < 5.5) {
        return {
          recommendation: 'Cal Agr√≠cola (CaCO‚ÇÉ)',
          reason: 'Suelo √°cido - necesita cal para elevar pH',
          priority: 'Alta',
          icon: 'üî¥'
        };
      } else if (ph < 6.0) {
        return {
          recommendation: 'Cal Dolom√≠tica',
          reason: 'Suelo ligeramente √°cido - cal dolom√≠tica para pH y magnesio',
          priority: 'Media',
          icon: 'üü°'
        };
      } else if (ph >= 6.0 && ph <= 7.5) {
        return {
          recommendation: 'Yeso Agr√≠cola (CaSO‚ÇÑ¬∑2H‚ÇÇO)',
          reason: 'Suelo neutro - yeso para calcio sin afectar pH',
          priority: 'Baja',
          icon: 'üü¢'
        };
      } else if (ph > 7.5) {
        return {
          recommendation: 'Azufre Elemental',
          reason: 'Suelo alcalino - azufre para bajar pH',
          priority: 'Alta',
          icon: 'üî¥'
        };
      }
    }

    function performSoilAnalysis(soilData) {
      const cations = [
        { symbol: 'K‚Å∫', value: soilData.k, percent: ((soilData.k / soilData.cic) * 100).toFixed(1), ideal: [3, 7], category: 'good' },
        { symbol: 'Ca¬≤‚Å∫', value: soilData.ca, percent: ((soilData.ca / soilData.cic) * 100).toFixed(1), ideal: [65, 75], category: 'good' },
        { symbol: 'Mg¬≤‚Å∫', value: soilData.mg, percent: ((soilData.mg / soilData.cic) * 100).toFixed(1), ideal: [10, 15], category: 'good' },
        { symbol: 'H‚Å∫', value: soilData.h, percent: ((soilData.h / soilData.cic) * 100).toFixed(1), ideal: [0, 10], category: 'acid' },
        { symbol: 'Na‚Å∫', value: soilData.na, percent: ((soilData.na / soilData.cic) * 100).toFixed(1), ideal: [0, 1], category: 'salt' },
        { symbol: 'Al¬≥‚Å∫', value: soilData.al, percent: ((soilData.al / soilData.cic) * 100).toFixed(1), ideal: [0, 1], category: 'toxic' }
      ];
      
      cations.forEach(cat => {
        if (cat.percent >= cat.ideal[0] && cat.percent <= cat.ideal[1]) {
          cat.status = '√ìptimo';
          cat.icon = '‚úÖ';
        } else if (cat.percent > cat.ideal[1]) {
          cat.status = 'Alto';
          cat.icon = '‚ö†Ô∏è';
        } else {
          cat.status = 'Bajo';
          cat.icon = '‚ùå';
        }
      });
      
      const problems = [];
      const recommendations = [];
      
      cations.forEach(cat => {
        if (cat.percent < cat.ideal[0]) {
          problems.push(`‚Ä¢ ${cat.symbol} est√° por debajo del rango ideal (${cat.percent}% < ${cat.ideal[0]}%)`);
          recommendations.push(`‚Ä¢ Aumentar ${cat.symbol} a ${(cat.ideal[0] * soilData.cic / 100).toFixed(2)} meq`);
        } else if (cat.percent > cat.ideal[1]) {
          problems.push(`‚Ä¢ ${cat.symbol} est√° por encima del rango ideal (${cat.percent}% > ${cat.ideal[1]}%)`);
          recommendations.push(`‚Ä¢ Reducir ${cat.symbol} a ${(cat.ideal[1] * soilData.cic / 100).toFixed(2)} meq`);
        }
      });
      
      return { cations, problems, recommendations };
    }

    function calculateIdealDistribution(cic) {
      const ranges = [
        { symbol: 'K‚Å∫', percentMin: 3, percentMax: 7, category: 'good' },
        { symbol: 'Ca¬≤‚Å∫', percentMin: 65, percentMax: 75, category: 'good' },
        { symbol: 'Mg¬≤‚Å∫', percentMin: 10, percentMax: 15, category: 'good' },
        { symbol: 'H‚Å∫', percentMin: 0, percentMax: 0, category: 'acid' }, // Mantener en 0
        { symbol: 'Na‚Å∫', percentMin: 0, percentMax: 0, category: 'salt' }, // Mantener en 0
        { symbol: 'Al¬≥‚Å∫', percentMin: 0, percentMax: 0, category: 'toxic' } // Mantener en 0
      ];
      
      // Calcular valores ideales solo para cationes buenos
      let idealValues = ranges.map(range => {
        const min = (range.percentMin * cic / 100).toFixed(2);
        const max = (range.percentMax * cic / 100).toFixed(2);
        
        // Para cationes problem√°ticos, mantener en 0
        if (range.category === 'acid' || range.category === 'salt' || range.category === 'toxic') {
          return {
            ...range,
            min: 0,
            max: 0,
            recommended: 0,
            recommendedPercent: 0
          };
        }
        
        // Para cationes buenos, usar el promedio del rango
        const recommended = ((range.percentMin + range.percentMax) / 2 * cic / 100).toFixed(2);
        const recommendedPercent = ((range.percentMin + range.percentMax) / 2).toFixed(1);
        
        return {
          ...range,
          min: parseFloat(min),
          max: parseFloat(max),
          recommended: parseFloat(recommended),
          recommendedPercent: parseFloat(recommendedPercent)
        };
      });
      
      // Calcular la suma de cationes buenos
      const goodCations = idealValues.filter(item => item.category === 'good');
      const goodCationsSum = goodCations.reduce((sum, item) => sum + item.recommended, 0);
      
      // Ajustar solo los cationes buenos para que sumen el CIC total
      const adjustment = (cic - goodCationsSum) / goodCations.length;
      
      idealValues = idealValues.map(item => {
        if (item.category === 'good') {
          return {
            ...item,
            recommended: parseFloat((item.recommended + adjustment).toFixed(2)),
            recommendedPercent: parseFloat(((item.recommended + adjustment) / cic * 100).toFixed(1))
          };
        }
        return item; // Mantener cationes problem√°ticos en 0
      });
      
      return idealValues;
    }

    function applyValuesToCalculator(idealValues) {
      try {
        // Aplicar valores a los campos objetivo
        const kTarget = document.getElementById('k-target');
        const caTarget = document.getElementById('ca-target');
        const mgTarget = document.getElementById('mg-target');
        const hTarget = document.getElementById('h-target');
        const naTarget = document.getElementById('na-target');
        const alTarget = document.getElementById('al-target');
        
        if (kTarget) kTarget.value = idealValues[0].recommended.toFixed(2);
        if (caTarget) caTarget.value = idealValues[1].recommended.toFixed(2);
        if (mgTarget) mgTarget.value = idealValues[2].recommended.toFixed(2);
        if (hTarget) hTarget.value = idealValues[3].recommended.toFixed(2);
        if (naTarget) naTarget.value = idealValues[4].recommended.toFixed(2);
        if (alTarget) alTarget.value = idealValues[5].recommended.toFixed(2);
        
        // Disparar rec√°lculo
        if (typeof calculateTotalPercent === 'function') {
          calculateTotalPercent();
        }
        
        return true;
      } catch (error) {
        console.error('Error aplicando valores:', error);
        return false;
      }
    }

    function getSoilStatus(soilData) {
      if (soilData.cic < 10) return 'Muy bajo';
      if (soilData.cic < 20) return 'Bajo';
      if (soilData.cic < 30) return 'Medio';
      if (soilData.cic < 40) return 'Alto';
      return 'Muy alto';
    }

    // Funci√≥n para mostrar estad√≠sticas de costos
    function showCostStats() {
      const efficiency = ((costTracker.manualResponses / costTracker.totalRequests) * 100).toFixed(1);
      const stats = `üìä **ESTAD√çSTICAS DE USO**\n\n` +
                   `‚Ä¢ **Total de consultas:** ${costTracker.totalRequests}\n` +
                   `‚Ä¢ **Respuestas manuales (gratis):** ${costTracker.manualResponses} (${efficiency}%)\n` +
                   `‚Ä¢ **Respuestas ChatGPT:** ${costTracker.chatGPTResponses}\n` +
                   `‚Ä¢ **Costo estimado:** $${costTracker.estimatedCost.toFixed(2)}\n` +
                   `‚Ä¢ **Eficiencia:** ${efficiency}% de respuestas gratuitas\n\n` +
                   `üí° **Sistema h√≠brido optimizado:** La mayor√≠a de consultas se resuelven sin costo usando detecci√≥n inteligente.`;
      
      return stats;
    }
    
    // Funci√≥n para resetear estad√≠sticas
    function resetCostStats() {
      costTracker = {
        totalRequests: 0,
        manualResponses: 0,
        chatGPTResponses: 0,
        estimatedCost: 0,
        lastReset: new Date().toISOString()
      };
      console.log('üîÑ Estad√≠sticas de costos reseteadas');
    }

    // Funciones para la calculadora de conversi√≥n
    function showConversionCalculator() {
      console.log('üîß showConversionCalculator() ejecut√°ndose...');
      const modal = document.getElementById('conversionCalculatorModal');
      console.log('üîç Modal encontrado:', modal);
      if (modal) {
        console.log('üìä Modal ANTES de agregar show:', modal.className);
        modal.classList.add('show');
        console.log('üìä Modal DESPU√âS de agregar show:', modal.className);
        console.log('‚úÖ Modal abierto con clase show');
        console.log('üîç Display computado:', getComputedStyle(modal).display);
        console.log('üîç Visibility computado:', getComputedStyle(modal).visibility);
        console.log('üîç Opacity computado:', getComputedStyle(modal).opacity);
        console.log('üîç Z-index computado:', getComputedStyle(modal).zIndex);
        if (typeof setupConversionCalculator === 'function') {
          console.log('üîß Llamando setupConversionCalculator()');
          setupConversionCalculator();
        } else {
          console.error('‚ùå setupConversionCalculator no est√° definida');
        }
      } else {
        console.error('‚ùå NO SE ENCONTR√ì conversionCalculatorModal');
      }
    }
    
    // Hacer la funci√≥n global
    window.showConversionCalculator = showConversionCalculator;

    function closeConversionCalculator() {
      const modal = document.getElementById('conversionCalculatorModal');
      modal.classList.remove('show');
    }
    
    // Hacer la funci√≥n global
    window.closeConversionCalculator = closeConversionCalculator;

    function clearConversionCalculator() {
      const inputs = document.querySelectorAll('#conversionCalculatorModal input');
      inputs.forEach(input => input.value = '');
    }

    // Funciones para la calculadora de unidades de nutrientes
    function showNutrientUnitsCalculator() {
      console.log('üîß showNutrientUnitsCalculator() ejecut√°ndose...');
      const modal = document.getElementById('nutrientUnitsCalculatorModal');
      console.log('üîç Modal encontrado:', modal);
      if (modal) {
        modal.classList.add('show');
        console.log('‚úÖ Modal abierto con clase show');
      } else {
        console.error('‚ùå NO SE ENCONTR√ì nutrientUnitsCalculatorModal');
      }
    }
    
    // Hacer la funci√≥n global
    window.showNutrientUnitsCalculator = showNutrientUnitsCalculator;

    function closeNutrientUnitsCalculator() {
      const modal = document.getElementById('nutrientUnitsCalculatorModal');
      modal.classList.remove('show');
    }
    
    // Hacer la funci√≥n global
    window.closeNutrientUnitsCalculator = closeNutrientUnitsCalculator;

    function clearNutrientUnitsCalculator() {
      const inputs = document.querySelectorAll('#nutrientUnitsCalculatorModal input');
      inputs.forEach(input => input.value = '');
    }

    // ‚Äî‚Äî Calculadora de unidades de medida (longitud, √°rea, volumen)
    var MEASURE_UNITS = {
      length: [
        { id: 'm', name: 'm (metro)', toBase: 1 },
        { id: 'km', name: 'km', toBase: 1000 },
        { id: 'cm', name: 'cm', toBase: 0.01 },
        { id: 'ft', name: 'ft (pie)', toBase: 0.3048 },
        { id: 'in', name: 'in (pulgada)', toBase: 0.0254 },
        { id: 'yd', name: 'yd (yarda)', toBase: 0.9144 },
        { id: 'mi', name: 'mi (milla)', toBase: 1609.344 }
      ],
      area: [
        { id: 'm2', name: 'm¬≤', toBase: 1 },
        { id: 'ha', name: 'ha (hect√°rea)', toBase: 10000 },
        { id: 'acre', name: 'acre', toBase: 4046.86 },
        { id: 'ft2', name: 'ft¬≤', toBase: 0.092903 },
        { id: 'km2', name: 'km¬≤', toBase: 1e6 }
      ],
      volume: [
        { id: 'L', name: 'L (litro)', toBase: 1 },
        { id: 'mL', name: 'mL', toBase: 0.001 },
        { id: 'm3', name: 'm¬≥', toBase: 1000 },
        { id: 'galUS', name: 'gal (US)', toBase: 3.78541 },
        { id: 'galUK', name: 'gal (UK)', toBase: 4.54609 },
        { id: 'ft3', name: 'ft¬≥', toBase: 28.3168 },
        { id: 'flozUS', name: 'fl oz (US)', toBase: 0.0295735 }
      ],
      weight: [
        { id: 'kg', name: 'kg', toBase: 1 },
        { id: 'g', name: 'g', toBase: 0.001 },
        { id: 'mg', name: 'mg', toBase: 0.000001 },
        { id: 't', name: 't (tonelada)', toBase: 1000 },
        { id: 'lb', name: 'lb (libra)', toBase: 0.453592 },
        { id: 'oz', name: 'oz (onza)', toBase: 0.0283495 }
      ],
      temperature: [
        { id: 'C', name: '¬∞C', toBase: 1, isTemp: true },
        { id: 'F', name: '¬∞F', toBase: 1, isTemp: true },
        { id: 'K', name: 'K', toBase: 1, isTemp: true }
      ],
      pressure: [
        { id: 'kPa', name: 'kPa', toBase: 1 },
        { id: 'psi', name: 'psi', toBase: 6.89476 },
        { id: 'bar', name: 'bar', toBase: 100 },
        { id: 'atm', name: 'atm', toBase: 101.325 },
        { id: 'mmHg', name: 'mmHg', toBase: 0.133322 }
      ]
    };
    function showMeasureUnitsCalculator() {
      var modal = document.getElementById('measureUnitsCalculatorModal');
      if (modal) {
        modal.classList.add('show');
        updateMeasureUnitOptions();
        convertMeasureUnits();
      }
    }
    window.showMeasureUnitsCalculator = showMeasureUnitsCalculator;
    function closeMeasureUnitsCalculator() {
      var modal = document.getElementById('measureUnitsCalculatorModal');
      if (modal) modal.classList.remove('show');
    }
    window.closeMeasureUnitsCalculator = closeMeasureUnitsCalculator;
    function updateMeasureUnitOptions() {
      var cat = document.getElementById('measure-category');
      var from = document.getElementById('measure-from');
      var to = document.getElementById('measure-to');
      if (!cat || !from || !to) return;
      var list = MEASURE_UNITS[cat.value] || MEASURE_UNITS.length;
      from.innerHTML = list.map(function(u) { return '<option value="' + u.id + '">' + u.name + '</option>'; }).join('');
      to.innerHTML = from.innerHTML;
      if (list.length) { from.value = list[0].id; to.value = list[list.length > 1 ? 1 : 0].id; }
      convertMeasureUnits();
    }
    function convertMeasureUnits() {
      var cat = document.getElementById('measure-category');
      var valIn = document.getElementById('measure-value');
      var fromSel = document.getElementById('measure-from');
      var toSel = document.getElementById('measure-to');
      var resultEl = document.getElementById('measure-result');
      if (!cat || !valIn || !fromSel || !toSel || !resultEl) return;
      var list = MEASURE_UNITS[cat.value];
      if (!list) return;
      var num = parseFloat(valIn.value);
      if (isNaN(num)) { resultEl.value = ''; return; }
      var fromUnit = list.find(function(u) { return u.id === fromSel.value; });
      var toUnit = list.find(function(u) { return u.id === toSel.value; });
      if (!fromUnit || !toUnit) return;
      var outVal;
      if (cat.value === 'temperature') {
        var c = num;
        if (fromUnit.id === 'F') c = (num - 32) * 5 / 9;
        else if (fromUnit.id === 'K') c = num - 273.15;
        if (toUnit.id === 'F') outVal = c * 9 / 5 + 32;
        else if (toUnit.id === 'K') outVal = c + 273.15;
        else outVal = c;
      } else {
        var baseVal = num * fromUnit.toBase;
        outVal = baseVal / toUnit.toBase;
      }
      resultEl.value = (Math.round(outVal * 1e6) / 1e6).toString();
    }

    // Datos de nutrientes: peso molecular y valencia
    const nutrientData = {
      'n': { mw: 14.01, valence: 1, molecule: 'NO‚ÇÉ‚Åª o NH‚ÇÑ‚Å∫' }, // Molecula con valencia 1-
      'p': { mw: 30.97, valence: 1, molecule: 'H‚ÇÇPO‚ÇÑ‚Åª' }, // Molecula con valencia 1-
      'k': { mw: 39.10, valence: 1, molecule: 'K‚Å∫' }, // Molecula con valencia 1+
      'ca': { mw: 40.08, valence: 2, molecule: 'Ca¬≤‚Å∫' },
      'mg': { mw: 24.31, valence: 2, molecule: 'Mg¬≤‚Å∫' },
      's': { mw: 32.07, valence: 2, molecule: 'SO‚ÇÑ¬≤‚Åª' },
      'fe': { mw: 55.85, valence: 2, molecule: 'Fe¬≤‚Å∫' },
      'mn': { mw: 54.94, valence: 2, molecule: 'Mn¬≤‚Å∫' },
      'zn': { mw: 65.38, valence: 2, molecule: 'Zn¬≤‚Å∫' },
      'b': { mw: 10.81, valence: 1, molecule: 'H‚ÇÉBO‚ÇÉ' },
      'cu': { mw: 63.55, valence: 2, molecule: 'Cu¬≤‚Å∫' },
      'mo': { mw: 95.95, valence: 2, molecule: 'Mo¬≤‚Å∫' },
      'hco3': { mw: 61.02, valence: 1, molecule: 'HCO‚ÇÉ‚Åª' },
      'co3': { mw: 60.01, valence: 2, molecule: 'CO‚ÇÉ¬≤‚Åª' }
    };

    function convertNutrient(nutrient, sourceUnit) {
      const data = nutrientData[nutrient];
      if (!data) return;

      const ppmInput = document.getElementById(`${nutrient}-ppm`);
      const mmolInput = document.getElementById(`${nutrient}-mmol`);
      const meqInput = document.getElementById(`${nutrient}-meq`);

      let ppm, mmol, meq;

      if (sourceUnit === 'ppm') {
        ppm = parseFloat(ppmInput.value) || 0;
        mmol = ppm / data.mw;
        meq = mmol * data.valence;
      } else if (sourceUnit === 'mmol') {
        mmol = parseFloat(mmolInput.value) || 0;
        ppm = mmol * data.mw;
        meq = mmol * data.valence;
      } else if (sourceUnit === 'meq') {
        meq = parseFloat(meqInput.value) || 0;
        mmol = meq / data.valence;
        ppm = mmol * data.mw;
      }

      // Actualizar los campos (sin disparar eventos)
      if (sourceUnit !== 'ppm') ppmInput.value = ppm.toFixed(3);
      if (sourceUnit !== 'mmol') mmolInput.value = mmol.toFixed(3);
      if (sourceUnit !== 'meq') meqInput.value = meq.toFixed(3);
    }

    // Cerrar modal al hacer clic fuera de √©l
    document.addEventListener('click', function(e) {
      const nutrientModal = document.getElementById('nutrientUnitsCalculatorModal');
      if (e.target === nutrientModal) {
        closeNutrientUnitsCalculator();
      }
    });

    function setupConversionCalculator() {
      // CaO ‚Üí Ca
      document.getElementById('cao-input').addEventListener('input', function() {
        const value = parseFloat(this.value) || 0;
        document.getElementById('ca-output').value = (value * 0.715).toFixed(3);
      });

      // Ca ‚Üí CaO
      document.getElementById('ca-input').addEventListener('input', function() {
        const value = parseFloat(this.value) || 0;
        document.getElementById('cao-output').value = (value * 1.399).toFixed(3);
      });

      // K‚ÇÇO ‚Üí K
      document.getElementById('k2o-input').addEventListener('input', function() {
        const value = parseFloat(this.value) || 0;
        document.getElementById('k-output').value = (value * 0.830).toFixed(3);
      });

      // K ‚Üí K‚ÇÇO
      document.getElementById('k-input').addEventListener('input', function() {
        const value = parseFloat(this.value) || 0;
        document.getElementById('k2o-output').value = (value * 1.205).toFixed(3);
      });

      // P‚ÇÇO‚ÇÖ ‚Üí P
      document.getElementById('p2o5-input').addEventListener('input', function() {
        const value = parseFloat(this.value) || 0;
        document.getElementById('p-output').value = (value * 0.436).toFixed(3);
      });

      // P ‚Üí P‚ÇÇO‚ÇÖ
      document.getElementById('p-input').addEventListener('input', function() {
        const value = parseFloat(this.value) || 0;
        document.getElementById('p2o5-output').value = (value * 2.291).toFixed(3);
      });

      // MgO ‚Üí Mg
      document.getElementById('mgo-input').addEventListener('input', function() {
        const value = parseFloat(this.value) || 0;
        document.getElementById('mg-output').value = (value * 0.603).toFixed(3);
      });

      // Mg ‚Üí MgO
      document.getElementById('mg-input').addEventListener('input', function() {
        const value = parseFloat(this.value) || 0;
        document.getElementById('mgo-output').value = (value * 1.658).toFixed(3);
      });

      // S ‚Üí SO‚ÇÑ
      document.getElementById('s-input').addEventListener('input', function() {
        const value = parseFloat(this.value) || 0;
        document.getElementById('so4-output').value = (value * 3.000).toFixed(3);
      });

      // SO‚ÇÑ ‚Üí S
      document.getElementById('so4-input').addEventListener('input', function() {
        const value = parseFloat(this.value) || 0;
        document.getElementById('s-output').value = (value * 0.333).toFixed(3);
      });

      // S ‚Üí SO‚ÇÉ
      document.getElementById('s-so3-input').addEventListener('input', function() {
        const value = parseFloat(this.value) || 0;
        document.getElementById('so3-output').value = (value * 2.497).toFixed(3);
      });

      // SO‚ÇÉ ‚Üí S
      document.getElementById('so3-input').addEventListener('input', function() {
        const value = parseFloat(this.value) || 0;
        document.getElementById('s-so3-output').value = (value * 0.400).toFixed(3);
      });

      // Zn ‚Üí ZnO
      document.getElementById('zn-input').addEventListener('input', function() {
        const value = parseFloat(this.value) || 0;
        document.getElementById('zno-output').value = (value * 1.245).toFixed(3);
      });

      // ZnO ‚Üí Zn
      document.getElementById('zno-input').addEventListener('input', function() {
        const value = parseFloat(this.value) || 0;
        document.getElementById('zn-output').value = (value * 0.803).toFixed(3);
      });

      // Fe ‚Üí Fe‚ÇÇO‚ÇÉ
      document.getElementById('fe-input').addEventListener('input', function() {
        const value = parseFloat(this.value) || 0;
        document.getElementById('fe2o3-output').value = (value * 1.430).toFixed(3);
      });

      // Fe‚ÇÇO‚ÇÉ ‚Üí Fe
      document.getElementById('fe2o3-input').addEventListener('input', function() {
        const value = parseFloat(this.value) || 0;
        document.getElementById('fe-output').value = (value * 0.699).toFixed(3);
      });

      // Mn ‚Üí MnO
      document.getElementById('mn-input').addEventListener('input', function() {
        const value = parseFloat(this.value) || 0;
        document.getElementById('mno-output').value = (value * 1.291).toFixed(3);
      });

      // MnO ‚Üí Mn
      document.getElementById('mno-input').addEventListener('input', function() {
        const value = parseFloat(this.value) || 0;
        document.getElementById('mn-output').value = (value * 0.775).toFixed(3);
      });

      // B ‚Üí B‚ÇÇO‚ÇÉ
      document.getElementById('b-input').addEventListener('input', function() {
        const value = parseFloat(this.value) || 0;
        document.getElementById('b2o3-output').value = (value * 3.220).toFixed(3);
      });

      // B‚ÇÇO‚ÇÉ ‚Üí B
      document.getElementById('b2o3-input').addEventListener('input', function() {
        const value = parseFloat(this.value) || 0;
        document.getElementById('b-output').value = (value * 0.311).toFixed(3);
      });

      // Cu ‚Üí CuO
      document.getElementById('cu-input').addEventListener('input', function() {
        const value = parseFloat(this.value) || 0;
        document.getElementById('cuo-output').value = (value * 1.252).toFixed(3);
      });

      // CuO ‚Üí Cu
      document.getElementById('cuo-input').addEventListener('input', function() {
        const value = parseFloat(this.value) || 0;
        document.getElementById('cu-output').value = (value * 0.799).toFixed(3);
      });

      // Si ‚Üí SiO‚ÇÇ
      document.getElementById('si-input').addEventListener('input', function() {
        const value = parseFloat(this.value) || 0;
        document.getElementById('sio2-output').value = (value * 2.139).toFixed(3);
      });

      // SiO‚ÇÇ ‚Üí Si
      document.getElementById('sio2-input').addEventListener('input', function() {
        const value = parseFloat(this.value) || 0;
        document.getElementById('si-output').value = (value * 0.467).toFixed(3);
      });

      // Mo ‚Üí MoO‚ÇÉ
      document.getElementById('mo-input').addEventListener('input', function() {
        const value = parseFloat(this.value) || 0;
        document.getElementById('moo3-output').value = (value * 1.500).toFixed(3);
      });

      // MoO‚ÇÉ ‚Üí Mo
      document.getElementById('moo3-input').addEventListener('input', function() {
        const value = parseFloat(this.value) || 0;
        document.getElementById('mo-output').value = (value * 0.667).toFixed(3);
      });
    }

    // Cerrar modal al hacer clic fuera de √©l
    document.addEventListener('click', function(e) {
      const modal = document.getElementById('conversionCalculatorModal');
      // Solo cerrar si el clic es EXACTAMENTE en el modal (no en sus hijos)
      if (modal && e.target === modal && modal.classList.contains('show')) {
        console.log('üñ±Ô∏è Clic fuera del modal, cerrando...');
        closeConversionCalculator();
      }
      
      const modalNutrient = document.getElementById('nutrientUnitsCalculatorModal');
      if (modalNutrient && e.target === modalNutrient && modalNutrient.classList.contains('show')) {
        console.log('üñ±Ô∏è Clic fuera del modal de unidades, cerrando...');
        closeNutrientUnitsCalculator();
      }
    });

    // Inicializar chat cuando se carga la p√°gina
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üöÄ Inicializando Chat H√≠brido Optimizado...');
      
      // ‚úÖ Actualizar √∫ltimo acceso del usuario en cada carga del dashboard (local y nube)
      try {
        const sessionData = localStorage.getItem('np_user');
        if (sessionData) {
          const session = JSON.parse(sessionData);
          const userId = session.userId || session.user_id || localStorage.getItem('nutriplant_user_id');
          if (userId) {
            const userKey = `nutriplant_user_${userId}`;
            const userDataStr = localStorage.getItem(userKey);
            const lastLoginIso = new Date().toISOString();
            if (userDataStr && userDataStr.startsWith('{')) {
              const userData = JSON.parse(userDataStr);
              userData.last_login = lastLoginIso;
              localStorage.setItem(userKey, JSON.stringify(userData));
            }
            if (typeof window.getSupabaseClient === 'function') {
              const client = window.getSupabaseClient();
              const isUuid = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(String(userId));
              if (client && isUuid) {
                client.from('profiles').update({ last_login: lastLoginIso }).eq('id', userId).then(function(r) { if (r && r.error) console.warn('last_login nube:', r.error.message); });
              }
            }
          }
        }
      } catch (e) {
        console.warn('‚ö†Ô∏è No se pudo actualizar last_login:', e);
      }
      
      // API Key configurada en chat.js
      // Sin mensaje de bienvenida autom√°tico: el chat no dice nada hasta que el usuario pregunte (como en Cursor).
      
      // Configurar eventos del input
      const chatInput = document.getElementById('chatInput');
      chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
      
      // Funci√≥n para auto-redimensionar el textarea del chat
      function autoResizeInput() {
        if (chatInput) {
          chatInput.style.height = 'auto';
          chatInput.style.height = Math.min(chatInput.scrollHeight, 100) + 'px';
        }
      }
      
      chatInput.addEventListener('input', autoResizeInput);
    });
  </script>

  <!-- Modal de Reportes -->
  <div id="reportModal" class="report-modal-overlay">
    <div class="report-modal">
      <div class="report-modal-header">
        <h2 class="report-modal-title">
          üìÑ Generar Reporte PDF
        </h2>
        <button class="report-modal-close" onclick="closeReportModal()">
          √ó
        </button>
      </div>
      
      <div class="report-sections">
        <div class="report-section-item" onclick="toggleReportSection('location')" data-section="location">
          <div class="report-section-info">
            <div class="report-section-title">üìç Ubicaci√≥n y Mapa</div>
            <div class="report-section-description">Informaci√≥n de ubicaci√≥n, coordenadas y pol√≠gono del terreno</div>
          </div>
        </div>
        
        <div class="report-section-item" onclick="toggleReportSection('amendments')" data-section="amendments">
          <div class="report-section-info">
            <div class="report-section-title">üöú An√°lisis de Enmiendas</div>
            <div class="report-section-description">An√°lisis de suelo, recomendaciones de enmiendas y c√°lculos</div>
          </div>
        </div>

        <div class="report-section-item" onclick="toggleReportSection('granular')" data-section="granular">
          <div class="report-section-info">
            <div class="report-section-title">üåæ Nutrici√≥n Granular</div>
            <div class="report-section-description">Requerimientos, programa y resumen de nutrici√≥n granular</div>
          </div>
        </div>

        <div class="report-section-item" onclick="toggleReportSection('fertigation')" data-section="fertigation">
          <div class="report-section-info">
            <div class="report-section-title">üìà Fertirriego</div>
            <div class="report-section-description">Programa de fertirriego y recomendaciones nutricionales</div>
          </div>
        </div>

        <div class="report-section-item" onclick="toggleReportSection('hidroponia')" data-section="hidroponia">
          <div class="report-section-info">
            <div class="report-section-title">üíß Hidropon√≠a</div>
            <div class="report-section-description">Configuraci√≥n y resultados del programa hidrop√≥nico</div>
          </div>
        </div>

        <div class="report-section-item" onclick="toggleReportSection('vpd')" data-section="vpd">
          <div class="report-section-info">
            <div class="report-section-title">üå°Ô∏è D√©ficit de Presi√≥n de Vapor</div>
            <div class="report-section-description">An√°lisis de VPD y recomendaciones ambientales</div>
          </div>
        </div>
      </div>
      
      <div class="report-modal-actions">
        <button class="report-modal-btn report-modal-btn-secondary" onclick="closeReportModal()">
          Cancelar
        </button>
        <button class="report-modal-btn report-modal-btn-primary" id="generateReportBtn" onclick="generatePDFReport()">
          üìÑ Generar Reporte PDF
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de Calculadora de Conversi√≥n -->
  <div id="conversionCalculatorModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">
          üßÆ Calculadora de Conversi√≥n √ìxido ‚Üî Elemental
        </h2>
        <button class="modal-close" onclick="closeConversionCalculator()">
          √ó
        </button>
      </div>
      
      <div class="modal-body">
        <div class="conversion-calculator">
          <div class="conversion-section">
            <h3>üìä Conversiones Comunes</h3>
            <div class="conversion-grid">
              <!-- P -->
              <div class="conversion-item">
                <label>P‚ÇÇO‚ÇÖ ‚Üí P</label>
                <div class="conversion-formula">
                  <input type="number" id="p2o5-input" placeholder="P‚ÇÇO‚ÇÖ" step="0.01">
                  <span>√ó 0.436 =</span>
                  <input type="number" id="p-output" placeholder="P" readonly>
                </div>
              </div>
              <div class="conversion-item">
                <label>P ‚Üí P‚ÇÇO‚ÇÖ</label>
                <div class="conversion-formula">
                  <input type="number" id="p-input" placeholder="P" step="0.01">
                  <span>√ó 2.291 =</span>
                  <input type="number" id="p2o5-output" placeholder="P‚ÇÇO‚ÇÖ" readonly>
                </div>
              </div>
              <!-- K -->
              <div class="conversion-item">
                <label>K‚ÇÇO ‚Üí K</label>
                <div class="conversion-formula">
                  <input type="number" id="k2o-input" placeholder="K‚ÇÇO" step="0.01">
                  <span>√ó 0.830 =</span>
                  <input type="number" id="k-output" placeholder="K" readonly>
                </div>
              </div>
              <div class="conversion-item">
                <label>K ‚Üí K‚ÇÇO</label>
                <div class="conversion-formula">
                  <input type="number" id="k-input" placeholder="K" step="0.01">
                  <span>√ó 1.205 =</span>
                  <input type="number" id="k2o-output" placeholder="K‚ÇÇO" readonly>
                </div>
              </div>
              <!-- Ca -->
              <div class="conversion-item">
                <label>CaO ‚Üí Ca</label>
                <div class="conversion-formula">
                  <input type="number" id="cao-input" placeholder="CaO" step="0.01">
                  <span>√ó 0.715 =</span>
                  <input type="number" id="ca-output" placeholder="Ca" readonly>
                </div>
              </div>
              <div class="conversion-item">
                <label>Ca ‚Üí CaO</label>
                <div class="conversion-formula">
                  <input type="number" id="ca-input" placeholder="Ca" step="0.01">
                  <span>√ó 1.399 =</span>
                  <input type="number" id="cao-output" placeholder="CaO" readonly>
                </div>
              </div>
              <!-- Mg -->
              <div class="conversion-item">
                <label>MgO ‚Üí Mg</label>
                <div class="conversion-formula">
                  <input type="number" id="mgo-input" placeholder="MgO" step="0.01">
                  <span>√ó 0.603 =</span>
                  <input type="number" id="mg-output" placeholder="Mg" readonly>
                </div>
              </div>
              <div class="conversion-item">
                <label>Mg ‚Üí MgO</label>
                <div class="conversion-formula">
                  <input type="number" id="mg-input" placeholder="Mg" step="0.01">
                  <span>√ó 1.658 =</span>
                  <input type="number" id="mgo-output" placeholder="MgO" readonly>
                </div>
              </div>
              <!-- SO‚ÇÑ -->
              <div class="conversion-item">
                <label>S ‚Üí SO‚ÇÑ</label>
                <div class="conversion-formula">
                  <input type="number" id="s-input" placeholder="S" step="0.01">
                  <span>√ó 3.000 =</span>
                  <input type="number" id="so4-output" placeholder="SO‚ÇÑ" readonly>
                </div>
              </div>
              <div class="conversion-item">
                <label>SO‚ÇÑ ‚Üí S</label>
                <div class="conversion-formula">
                  <input type="number" id="so4-input" placeholder="SO‚ÇÑ" step="0.01">
                  <span>√ó 0.333 =</span>
                  <input type="number" id="s-output" placeholder="S" readonly>
                </div>
              </div>
              <!-- SO‚ÇÉ -->
              <div class="conversion-item">
                <label>S ‚Üí SO‚ÇÉ</label>
                <div class="conversion-formula">
                  <input type="number" id="s-so3-input" placeholder="S" step="0.01">
                  <span>√ó 2.497 =</span>
                  <input type="number" id="so3-output" placeholder="SO‚ÇÉ" readonly>
                </div>
              </div>
              <div class="conversion-item">
                <label>SO‚ÇÉ ‚Üí S</label>
                <div class="conversion-formula">
                  <input type="number" id="so3-input" placeholder="SO‚ÇÉ" step="0.01">
                  <span>√ó 0.400 =</span>
                  <input type="number" id="s-so3-output" placeholder="S" readonly>
                </div>
              </div>
              <!-- Fe -->
              <div class="conversion-item">
                <label>Fe ‚Üí Fe‚ÇÇO‚ÇÉ</label>
                <div class="conversion-formula">
                  <input type="number" id="fe-input" placeholder="Fe" step="0.01">
                  <span>√ó 1.430 =</span>
                  <input type="number" id="fe2o3-output" placeholder="Fe‚ÇÇO‚ÇÉ" readonly>
                </div>
              </div>
              <div class="conversion-item">
                <label>Fe‚ÇÇO‚ÇÉ ‚Üí Fe</label>
                <div class="conversion-formula">
                  <input type="number" id="fe2o3-input" placeholder="Fe‚ÇÇO‚ÇÉ" step="0.01">
                  <span>√ó 0.699 =</span>
                  <input type="number" id="fe-output" placeholder="Fe" readonly>
                </div>
              </div>
              <!-- Mn -->
              <div class="conversion-item">
                <label>Mn ‚Üí MnO</label>
                <div class="conversion-formula">
                  <input type="number" id="mn-input" placeholder="Mn" step="0.01">
                  <span>√ó 1.291 =</span>
                  <input type="number" id="mno-output" placeholder="MnO" readonly>
                </div>
              </div>
              <div class="conversion-item">
                <label>MnO ‚Üí Mn</label>
                <div class="conversion-formula">
                  <input type="number" id="mno-input" placeholder="MnO" step="0.01">
                  <span>√ó 0.775 =</span>
                  <input type="number" id="mn-output" placeholder="Mn" readonly>
                </div>
              </div>
              <!-- B -->
              <div class="conversion-item">
                <label>B ‚Üí B‚ÇÇO‚ÇÉ</label>
                <div class="conversion-formula">
                  <input type="number" id="b-input" placeholder="B" step="0.01">
                  <span>√ó 3.220 =</span>
                  <input type="number" id="b2o3-output" placeholder="B‚ÇÇO‚ÇÉ" readonly>
                </div>
              </div>
              <div class="conversion-item">
                <label>B‚ÇÇO‚ÇÉ ‚Üí B</label>
                <div class="conversion-formula">
                  <input type="number" id="b2o3-input" placeholder="B‚ÇÇO‚ÇÉ" step="0.01">
                  <span>√ó 0.311 =</span>
                  <input type="number" id="b-output" placeholder="B" readonly>
                </div>
              </div>
              <!-- Zn -->
              <div class="conversion-item">
                <label>Zn ‚Üí ZnO</label>
                <div class="conversion-formula">
                  <input type="number" id="zn-input" placeholder="Zn" step="0.01">
                  <span>√ó 1.245 =</span>
                  <input type="number" id="zno-output" placeholder="ZnO" readonly>
                </div>
              </div>
              <div class="conversion-item">
                <label>ZnO ‚Üí Zn</label>
                <div class="conversion-formula">
                  <input type="number" id="zno-input" placeholder="ZnO" step="0.01">
                  <span>√ó 0.803 =</span>
                  <input type="number" id="zn-output" placeholder="Zn" readonly>
                </div>
              </div>
              <!-- Cu -->
              <div class="conversion-item">
                <label>Cu ‚Üí CuO</label>
                <div class="conversion-formula">
                  <input type="number" id="cu-input" placeholder="Cu" step="0.01">
                  <span>√ó 1.252 =</span>
                  <input type="number" id="cuo-output" placeholder="CuO" readonly>
                </div>
              </div>
              <div class="conversion-item">
                <label>CuO ‚Üí Cu</label>
                <div class="conversion-formula">
                  <input type="number" id="cuo-input" placeholder="CuO" step="0.01">
                  <span>√ó 0.799 =</span>
                  <input type="number" id="cu-output" placeholder="Cu" readonly>
                </div>
              </div>
              <!-- Mo -->
              <div class="conversion-item">
                <label>Mo ‚Üí MoO‚ÇÉ</label>
                <div class="conversion-formula">
                  <input type="number" id="mo-input" placeholder="Mo" step="0.01">
                  <span>√ó 1.500 =</span>
                  <input type="number" id="moo3-output" placeholder="MoO‚ÇÉ" readonly>
                </div>
              </div>
              <div class="conversion-item">
                <label>MoO‚ÇÉ ‚Üí Mo</label>
                <div class="conversion-formula">
                  <input type="number" id="moo3-input" placeholder="MoO‚ÇÉ" step="0.01">
                  <span>√ó 0.667 =</span>
                  <input type="number" id="mo-output" placeholder="Mo" readonly>
                </div>
              </div>
              <!-- Si -->
              <div class="conversion-item">
                <label>Si ‚Üí SiO‚ÇÇ</label>
                <div class="conversion-formula">
                  <input type="number" id="si-input" placeholder="Si" step="0.01">
                  <span>√ó 2.139 =</span>
                  <input type="number" id="sio2-output" placeholder="SiO‚ÇÇ" readonly>
                </div>
              </div>
              <div class="conversion-item">
                <label>SiO‚ÇÇ ‚Üí Si</label>
                <div class="conversion-formula">
                  <input type="number" id="sio2-input" placeholder="SiO‚ÇÇ" step="0.01">
                  <span>√ó 0.467 =</span>
                  <input type="number" id="si-output" placeholder="Si" readonly>
                </div>
              </div>
            </div>
          </div>
          
          <div class="conversion-section">
            <h3>‚ÑπÔ∏è Informaci√≥n</h3>
            <div class="info-box">
              <p><strong>Factores de Conversi√≥n:</strong></p>
              <ul>
                <li>P‚ÇÇO‚ÇÖ ‚Üí P: 0.436 | P ‚Üí P‚ÇÇO‚ÇÖ: 2.291</li>
                <li>K‚ÇÇO ‚Üí K: 0.830 | K ‚Üí K‚ÇÇO: 1.205</li>
                <li>CaO ‚Üí Ca: 0.715 | Ca ‚Üí CaO: 1.399</li>
                <li>MgO ‚Üí Mg: 0.603 | Mg ‚Üí MgO: 1.658</li>
                <li>S ‚Üí SO‚ÇÑ: 3.000 | SO‚ÇÑ ‚Üí S: 0.333</li>
                <li>S ‚Üí SO‚ÇÉ: 2.497 | SO‚ÇÉ ‚Üí S: 0.400</li>
                <li>Fe ‚Üí Fe‚ÇÇO‚ÇÉ: 1.430 | Fe‚ÇÇO‚ÇÉ ‚Üí Fe: 0.699</li>
                <li>Mn ‚Üí MnO: 1.291 | MnO ‚Üí Mn: 0.775</li>
                <li>B ‚Üí B‚ÇÇO‚ÇÉ: 3.220 | B‚ÇÇO‚ÇÉ ‚Üí B: 0.311</li>
                <li>Zn ‚Üí ZnO: 1.245 | ZnO ‚Üí Zn: 0.803</li>
                <li>Cu ‚Üí CuO: 1.252 | CuO ‚Üí Cu: 0.799</li>
                <li>Mo ‚Üí MoO‚ÇÉ: 1.500 | MoO‚ÇÉ ‚Üí Mo: 0.667</li>
                <li>Si ‚Üí SiO‚ÇÇ: 2.139 | SiO‚ÇÇ ‚Üí Si: 0.467</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeConversionCalculator()">
          Cerrar
        </button>
        <button class="btn btn-primary" onclick="clearConversionCalculator()">
          Limpiar Todo
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de Calculadora de Unidades de Nutrientes -->
  <div id="nutrientUnitsCalculatorModal" class="modal-overlay">
    <div class="modal modal-wide">
      <div class="modal-header">
        <h2 class="modal-title">
          üß™ Calculadora de Unidades de Nutrientes (ppm ‚Üî mmol/L ‚Üî meq/L)
        </h2>
        <button class="modal-close" onclick="closeNutrientUnitsCalculator()">
          √ó
        </button>
      </div>
      
      <div class="modal-body">
        <div class="calculator-container">
          <div class="calculator-instructions">
            <p><strong>Instrucciones:</strong> Ingresa el valor en cualquier campo y las conversiones se calcular√°n autom√°ticamente.</p>
            <p><em>Esta herramienta convierte entre ppm (mg/L), mmol/L (milimoles por litro) y meq/L (miliequivalentes por litro).</em></p>
          </div>

          <div class="nutrient-conversions-grid">
            <!-- Nitr√≥geno (N) -->
            <div class="nutrient-conversion-group">
              <div class="nutrient-label">
                <strong>N: NO‚ÇÉ‚Åª o NH‚ÇÑ‚Å∫</strong>
                <span class="nutrient-info">PM: 14.01 | Valencia: 1</span>
              </div>
              <div class="conversion-inputs">
                <div class="input-group">
                  <label>ppm (mg/L)</label>
                  <input type="number" id="n-ppm" placeholder="0" step="0.01" oninput="convertNutrient('n', 'ppm')">
                </div>
                <div class="input-group">
                  <label>mmol/L</label>
                  <input type="number" id="n-mmol" placeholder="0" step="0.01" oninput="convertNutrient('n', 'mmol')">
                </div>
                <div class="input-group">
                  <label>meq/L</label>
                  <input type="number" id="n-meq" placeholder="0" step="0.01" oninput="convertNutrient('n', 'meq')">
                </div>
              </div>
            </div>

            <!-- F√≥sforo (P) -->
            <div class="nutrient-conversion-group">
              <div class="nutrient-label">
                <strong>P: H‚ÇÇPO‚ÇÑ‚Åª</strong>
                <span class="nutrient-info">PM: 30.97 | Valencia: 1</span>
              </div>
              <div class="conversion-inputs">
                <div class="input-group">
                  <label>ppm (mg/L)</label>
                  <input type="number" id="p-ppm" placeholder="0" step="0.01" oninput="convertNutrient('p', 'ppm')">
                </div>
                <div class="input-group">
                  <label>mmol/L</label>
                  <input type="number" id="p-mmol" placeholder="0" step="0.01" oninput="convertNutrient('p', 'mmol')">
                </div>
                <div class="input-group">
                  <label>meq/L</label>
                  <input type="number" id="p-meq" placeholder="0" step="0.01" oninput="convertNutrient('p', 'meq')">
                </div>
              </div>
            </div>

            <!-- Potasio (K) -->
            <div class="nutrient-conversion-group">
              <div class="nutrient-label">
                <strong>K: K‚Å∫</strong>
                <span class="nutrient-info">PM: 39.10 | Valencia: 1</span>
              </div>
              <div class="conversion-inputs">
                <div class="input-group">
                  <label>ppm (mg/L)</label>
                  <input type="number" id="k-ppm" placeholder="0" step="0.01" oninput="convertNutrient('k', 'ppm')">
                </div>
                <div class="input-group">
                  <label>mmol/L</label>
                  <input type="number" id="k-mmol" placeholder="0" step="0.01" oninput="convertNutrient('k', 'mmol')">
                </div>
                <div class="input-group">
                  <label>meq/L</label>
                  <input type="number" id="k-meq" placeholder="0" step="0.01" oninput="convertNutrient('k', 'meq')">
                </div>
              </div>
            </div>

            <!-- Calcio (Ca) -->
            <div class="nutrient-conversion-group">
              <div class="nutrient-label">
                <strong>Ca: Ca¬≤‚Å∫</strong>
                <span class="nutrient-info">PM: 40.08 | Valencia: 2</span>
              </div>
              <div class="conversion-inputs">
                <div class="input-group">
                  <label>ppm (mg/L)</label>
                  <input type="number" id="ca-ppm" placeholder="0" step="0.01" oninput="convertNutrient('ca', 'ppm')">
                </div>
                <div class="input-group">
                  <label>mmol/L</label>
                  <input type="number" id="ca-mmol" placeholder="0" step="0.01" oninput="convertNutrient('ca', 'mmol')">
                </div>
                <div class="input-group">
                  <label>meq/L</label>
                  <input type="number" id="ca-meq" placeholder="0" step="0.01" oninput="convertNutrient('ca', 'meq')">
                </div>
              </div>
            </div>

            <!-- Magnesio (Mg) -->
            <div class="nutrient-conversion-group">
              <div class="nutrient-label">
                <strong>Mg: Mg¬≤‚Å∫</strong>
                <span class="nutrient-info">PM: 24.31 | Valencia: 2</span>
              </div>
              <div class="conversion-inputs">
                <div class="input-group">
                  <label>ppm (mg/L)</label>
                  <input type="number" id="mg-ppm" placeholder="0" step="0.01" oninput="convertNutrient('mg', 'ppm')">
                </div>
                <div class="input-group">
                  <label>mmol/L</label>
                  <input type="number" id="mg-mmol" placeholder="0" step="0.01" oninput="convertNutrient('mg', 'mmol')">
                </div>
                <div class="input-group">
                  <label>meq/L</label>
                  <input type="number" id="mg-meq" placeholder="0" step="0.01" oninput="convertNutrient('mg', 'meq')">
                </div>
              </div>
            </div>

            <!-- Azufre (S) -->
            <div class="nutrient-conversion-group">
              <div class="nutrient-label">
                <strong>S: SO‚ÇÑ¬≤‚Åª</strong>
                <span class="nutrient-info">PM: 32.07 | Valencia: 2</span>
              </div>
              <div class="conversion-inputs">
                <div class="input-group">
                  <label>ppm (mg/L)</label>
                  <input type="number" id="s-ppm" placeholder="0" step="0.01" oninput="convertNutrient('s', 'ppm')">
                </div>
                <div class="input-group">
                  <label>mmol/L</label>
                  <input type="number" id="s-mmol" placeholder="0" step="0.01" oninput="convertNutrient('s', 'mmol')">
                </div>
                <div class="input-group">
                  <label>meq/L</label>
                  <input type="number" id="s-meq" placeholder="0" step="0.01" oninput="convertNutrient('s', 'meq')">
                </div>
              </div>
            </div>

            <!-- Hierro (Fe) -->
            <div class="nutrient-conversion-group">
              <div class="nutrient-label">
                <strong>Fe: Fe¬≤‚Å∫</strong>
                <span class="nutrient-info">PM: 55.85 | Valencia: 2</span>
              </div>
              <div class="conversion-inputs">
                <div class="input-group">
                  <label>ppm (mg/L)</label>
                  <input type="number" id="fe-ppm" placeholder="0" step="0.01" oninput="convertNutrient('fe', 'ppm')">
                </div>
                <div class="input-group">
                  <label>mmol/L</label>
                  <input type="number" id="fe-mmol" placeholder="0" step="0.01" oninput="convertNutrient('fe', 'mmol')">
                </div>
                <div class="input-group">
                  <label>meq/L</label>
                  <input type="number" id="fe-meq" placeholder="0" step="0.01" oninput="convertNutrient('fe', 'meq')">
                </div>
              </div>
            </div>

            <!-- Manganeso (Mn) -->
            <div class="nutrient-conversion-group">
              <div class="nutrient-label">
                <strong>Mn: Mn¬≤‚Å∫</strong>
                <span class="nutrient-info">PM: 54.94 | Valencia: 2</span>
              </div>
              <div class="conversion-inputs">
                <div class="input-group">
                  <label>ppm (mg/L)</label>
                  <input type="number" id="mn-ppm" placeholder="0" step="0.01" oninput="convertNutrient('mn', 'ppm')">
                </div>
                <div class="input-group">
                  <label>mmol/L</label>
                  <input type="number" id="mn-mmol" placeholder="0" step="0.01" oninput="convertNutrient('mn', 'mmol')">
                </div>
                <div class="input-group">
                  <label>meq/L</label>
                  <input type="number" id="mn-meq" placeholder="0" step="0.01" oninput="convertNutrient('mn', 'meq')">
                </div>
              </div>
            </div>

            <!-- Boro (B) -->
            <div class="nutrient-conversion-group">
              <div class="nutrient-label">
                <strong>B: H‚ÇÉBO‚ÇÉ</strong>
                <span class="nutrient-info">PM: 10.81</span>
              </div>
              <div class="conversion-inputs">
                <div class="input-group">
                  <label>ppm (mg/L)</label>
                  <input type="number" id="b-ppm" placeholder="0" step="0.01" oninput="convertNutrient('b', 'ppm')">
                </div>
                <div class="input-group">
                  <label>mmol/L</label>
                  <input type="number" id="b-mmol" placeholder="0" step="0.01" oninput="convertNutrient('b', 'mmol')">
                </div>
                <div class="input-group">
                  <label>meq/L</label>
                  <input type="number" id="b-meq" placeholder="0" step="0.01" oninput="convertNutrient('b', 'meq')">
                </div>
              </div>
            </div>

            <!-- Zinc (Zn) -->
            <div class="nutrient-conversion-group">
              <div class="nutrient-label">
                <strong>Zn: Zn¬≤‚Å∫</strong>
                <span class="nutrient-info">PM: 65.38 | Valencia: 2</span>
              </div>
              <div class="conversion-inputs">
                <div class="input-group">
                  <label>ppm (mg/L)</label>
                  <input type="number" id="zn-ppm" placeholder="0" step="0.01" oninput="convertNutrient('zn', 'ppm')">
                </div>
                <div class="input-group">
                  <label>mmol/L</label>
                  <input type="number" id="zn-mmol" placeholder="0" step="0.01" oninput="convertNutrient('zn', 'mmol')">
                </div>
                <div class="input-group">
                  <label>meq/L</label>
                  <input type="number" id="zn-meq" placeholder="0" step="0.01" oninput="convertNutrient('zn', 'meq')">
                </div>
              </div>
            </div>

            <!-- Cobre (Cu) -->
            <div class="nutrient-conversion-group">
              <div class="nutrient-label">
                <strong>Cu: Cu¬≤‚Å∫</strong>
                <span class="nutrient-info">PM: 63.55 | Valencia: 2</span>
              </div>
              <div class="conversion-inputs">
                <div class="input-group">
                  <label>ppm (mg/L)</label>
                  <input type="number" id="cu-ppm" placeholder="0" step="0.01" oninput="convertNutrient('cu', 'ppm')">
                </div>
                <div class="input-group">
                  <label>mmol/L</label>
                  <input type="number" id="cu-mmol" placeholder="0" step="0.01" oninput="convertNutrient('cu', 'mmol')">
                </div>
                <div class="input-group">
                  <label>meq/L</label>
                  <input type="number" id="cu-meq" placeholder="0" step="0.01" oninput="convertNutrient('cu', 'meq')">
                </div>
              </div>
            </div>

            <!-- Molibdeno (Mo) -->
            <div class="nutrient-conversion-group">
              <div class="nutrient-label">
                <strong>Mo: Mo¬≤‚Å∫</strong>
                <span class="nutrient-info">PM: 95.95 | Valencia: 2</span>
              </div>
              <div class="conversion-inputs">
                <div class="input-group">
                  <label>ppm (mg/L)</label>
                  <input type="number" id="mo-ppm" placeholder="0" step="0.01" oninput="convertNutrient('mo', 'ppm')">
                </div>
                <div class="input-group">
                  <label>mmol/L</label>
                  <input type="number" id="mo-mmol" placeholder="0" step="0.01" oninput="convertNutrient('mo', 'mmol')">
                </div>
                <div class="input-group">
                  <label>meq/L</label>
                  <input type="number" id="mo-meq" placeholder="0" step="0.01" oninput="convertNutrient('mo', 'meq')">
                </div>
              </div>
            </div>

            <!-- Bicarbonato (HCO‚ÇÉ‚Åª) -->
            <div class="nutrient-conversion-group">
              <div class="nutrient-label">
                <strong>Bicarbonato (HCO‚ÇÉ‚Åª)</strong>
                <span class="nutrient-info">PM: 61.02 | Valencia: 1</span>
              </div>
              <div class="conversion-inputs">
                <div class="input-group">
                  <label>ppm (mg/L)</label>
                  <input type="number" id="hco3-ppm" placeholder="0" step="0.01" oninput="convertNutrient('hco3', 'ppm')">
                </div>
                <div class="input-group">
                  <label>mmol/L</label>
                  <input type="number" id="hco3-mmol" placeholder="0" step="0.01" oninput="convertNutrient('hco3', 'mmol')">
                </div>
                <div class="input-group">
                  <label>meq/L</label>
                  <input type="number" id="hco3-meq" placeholder="0" step="0.01" oninput="convertNutrient('hco3', 'meq')">
                </div>
              </div>
            </div>

            <!-- Carbonato (CO‚ÇÉ¬≤‚Åª) -->
            <div class="nutrient-conversion-group">
              <div class="nutrient-label">
                <strong>Carbonato (CO‚ÇÉ¬≤‚Åª)</strong>
                <span class="nutrient-info">PM: 60.01 | Valencia: 2</span>
              </div>
              <div class="conversion-inputs">
                <div class="input-group">
                  <label>ppm (mg/L)</label>
                  <input type="number" id="co3-ppm" placeholder="0" step="0.01" oninput="convertNutrient('co3', 'ppm')">
                </div>
                <div class="input-group">
                  <label>mmol/L</label>
                  <input type="number" id="co3-mmol" placeholder="0" step="0.01" oninput="convertNutrient('co3', 'mmol')">
                </div>
                <div class="input-group">
                  <label>meq/L</label>
                  <input type="number" id="co3-meq" placeholder="0" step="0.01" oninput="convertNutrient('co3', 'meq')">
                </div>
              </div>
            </div>
          </div>

          <div class="info-box" style="margin-top: 20px;">
            <p><strong>F√≥rmulas de Conversi√≥n:</strong></p>
            <ul>
              <li><strong>ppm a mmol/L:</strong> mmol/L = ppm √∑ Peso Molecular o At√≥mico</li>
              <li><strong>mmol/L a meq/L:</strong> meq/L = mmol/L √ó Valencia</li>
              <li><strong>ppm a meq/L:</strong> meq/L = (ppm √∑ Peso Molecular o At√≥mico) √ó Valencia</li>
            </ul>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeNutrientUnitsCalculator()">
          Cerrar
        </button>
        <button class="btn btn-primary" onclick="clearNutrientUnitsCalculator()">
          Limpiar Todo
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Calculadora Unidades de Medida (longitud, √°rea, volumen) -->
  <div id="measureUnitsCalculatorModal" class="modal-overlay">
    <div class="modal modal-wide">
      <div class="modal-header">
        <h2 class="modal-title">üìê Calculadora de Unidades (longitud, √°rea, volumen, peso, temperatura, presi√≥n)</h2>
        <button class="modal-close" onclick="closeMeasureUnitsCalculator()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="calculator-container">
          <p style="margin-bottom: 12px;"><em>Convierte entre unidades de longitud, √°rea, volumen, peso, temperatura y presi√≥n.</em></p>
          <div class="form-group">
            <label>Tipo de magnitud</label>
            <select id="measure-category" onchange="updateMeasureUnitOptions()">
              <option value="length">Longitud</option>
              <option value="area">√Årea / Superficie</option>
              <option value="volume">Volumen</option>
              <option value="weight">Peso / Masa</option>
              <option value="temperature">Temperatura</option>
              <option value="pressure">Presi√≥n</option>
            </select>
          </div>
          <div class="measure-conversion-row" style="display: flex; align-items: flex-end; gap: 12px; flex-wrap: wrap; margin-top: 16px;">
            <div class="form-group" style="flex: 1; min-width: 120px;">
              <label>Valor</label>
              <input type="number" id="measure-value" placeholder="0" step="any" oninput="convertMeasureUnits()">
            </div>
            <div class="form-group" style="flex: 1; min-width: 140px;">
              <label>Desde</label>
              <select id="measure-from" onchange="convertMeasureUnits()"></select>
            </div>
            <span style="align-self: center; font-size: 18px;">‚Üí</span>
            <div class="form-group" style="flex: 1; min-width: 140px;">
              <label>A</label>
              <select id="measure-to" onchange="convertMeasureUnits()"></select>
            </div>
            <div class="form-group" style="flex: 1; min-width: 140px;">
              <label>Resultado</label>
              <input type="text" id="measure-result" readonly placeholder="‚Äî" style="background: #f0fdf4;">
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeMeasureUnitsCalculator()">Cerrar</button>
      </div>
    </div>
  </div>

<!-- Modal para agregar cultivo personalizado -->
<div id="customCropModal" class="modal-overlay">
  <div class="modal-content" style="max-width: 800px;">
  <div class="modal-header">
      <h3 id="customCropModalTitle">‚ûï Agregar Cultivo Personalizado</h3>
      <button class="btn btn-sm btn-danger" onclick="closeCustomCropModalGlobal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group" style="margin-bottom: 20px;">
        <label for="customCropName"><strong>Nombre del Cultivo:</strong></label>
        <input type="text" id="customCropName" class="form-control" placeholder="Ej: Mango, Mora, etc." style="width: 100%; padding: 10px;">
      </div>
      
      <div style="margin-bottom: 20px;">
        <p style="color: #666; font-size: 13px; margin-bottom: 10px;">
          <strong>üìä Ingrese la extracci√≥n por tonelada (kg/ton) para cada nutriente:</strong>
        </p>
        
        <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
          <thead>
            <tr style="background: #0369a1; color: white;">
              <th style="padding: 8px; text-align: center; font-size: 12px;">Nutriente</th>
              <th style="padding: 8px; text-align: center; font-size: 12px;">Extracci√≥n (kg/ton)</th>
            </tr>
          </thead>
          <tbody id="customCropInputs">
            <tr>
              <td style="padding: 8px; font-weight: 600; background: #f3f4f6;">N</td>
              <td style="padding: 8px;"><input type="number" id="customCropN" class="fertirriego-input" step="0.01" value="0" style="width: 100%;"></td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: 600; background: #f3f4f6;">P‚ÇÇO‚ÇÖ</td>
              <td style="padding: 8px;"><input type="number" id="customCropP2O5" class="fertirriego-input" step="0.01" value="0" style="width: 100%;"></td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: 600; background: #f3f4f6;">K‚ÇÇO</td>
              <td style="padding: 8px;"><input type="number" id="customCropK2O" class="fertirriego-input" step="0.01" value="0" style="width: 100%;"></td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: 600; background: #f3f4f6;">CaO</td>
              <td style="padding: 8px;"><input type="number" id="customCropCaO" class="fertirriego-input" step="0.01" value="0" style="width: 100%;"></td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: 600; background: #f3f4f6;">MgO</td>
              <td style="padding: 8px;"><input type="number" id="customCropMgO" class="fertirriego-input" step="0.01" value="0" style="width: 100%;"></td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: 600; background: #f3f4f6;">S</td>
              <td style="padding: 8px;"><input type="number" id="customCropS" class="fertirriego-input" step="0.01" value="0" style="width: 100%;"></td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: 600; background: #f3f4f6;">SO‚ÇÑ</td>
              <td style="padding: 8px;"><input type="number" id="customCropSO4" class="fertirriego-input" step="0.01" value="0" style="width: 100%;"></td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: 600; background: #f3f4f6;">Fe</td>
              <td style="padding: 8px;"><input type="number" id="customCropFe" class="fertirriego-input" step="0.0001" value="0" style="width: 100%;"></td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: 600; background: #f3f4f6;">Mn</td>
              <td style="padding: 8px;"><input type="number" id="customCropMn" class="fertirriego-input" step="0.0001" value="0" style="width: 100%;"></td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: 600; background: #f3f4f6;">B</td>
              <td style="padding: 8px;"><input type="number" id="customCropB" class="fertirriego-input" step="0.0001" value="0" style="width: 100%;"></td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: 600; background: #f3f4f6;">Zn</td>
              <td style="padding: 8px;"><input type="number" id="customCropZn" class="fertirriego-input" step="0.0001" value="0" style="width: 100%;"></td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: 600; background: #f3f4f6;">Cu</td>
              <td style="padding: 8px;"><input type="number" id="customCropCu" class="fertirriego-input" step="0.0001" value="0" style="width: 100%;"></td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: 600; background: #f3f4f6;">Mo</td>
              <td style="padding: 8px;"><input type="number" id="customCropMo" class="fertirriego-input" step="0.0001" value="0" style="width: 100%;"></td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: 600; background: #f3f4f6;">SiO‚ÇÇ</td>
              <td style="padding: 8px;"><input type="number" id="customCropSiO2" class="fertirriego-input" step="0.0001" value="0" style="width: 100%;"></td>
            </tr>
          </tbody>
        </table>
      </div>

      <div id="granularCustomCropsSection" style="margin-top: 12px;">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px;">
          <h4 style="margin:0; color:#1f2937; font-size: 14px;">üå± Mis cultivos personalizados</h4>
        </div>
        <div id="granularCustomCropsList" style="background:#f8fafc; border:1px solid #e5e7eb; border-radius:10px; padding:10px;"></div>
      </div>
      
      <div class="modal-footer" style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
        <button class="btn btn-secondary" onclick="closeCustomCropModalGlobal()">Cancelar</button>
        <button id="customCropModalSaveBtn" class="btn btn-success" onclick="addCustomCropGlobal()">Agregar Cultivo</button>
      </div>
    </div>
  </div>
  </div>

  <!-- Modal de Informaci√≥n de Usuario -->
  <div id="userInfoModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 10000; justify-content: center; align-items: center;">
    <div class="modal" style="background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); max-width: 520px; width: auto; min-width: 480px; max-height: 90vh; overflow-y: auto; position: relative; z-index: 10001;">
      <div class="about-modal-content" style="padding: 24px; box-sizing: border-box; width: 100%; max-width: 100%; min-width: 0;">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 2px solid #e5e7eb;">
          <h2 style="margin: 0; color: #1e293b; font-size: 22px; font-weight: 700;">üë§ Informaci√≥n de Usuario</h2>
          <button onclick="window.closeUserInfoModal()" style="
            background: none;
            border: none;
            font-size: 24px;
            color: #64748b;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s ease;
          " onmouseover="this.style.background='#f1f5f9'; this.style.color='#1e293b'" onmouseout="this.style.background='none'; this.style.color='#64748b'">
            √ó
          </button>
        </div>
        <div id="userInfoContent" style="padding: 0; width: 100%; box-sizing: border-box; min-width: 0;">
          <!-- El contenido se carga din√°micamente -->
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Cambiar contrase√±a -->
  <div id="changePasswordModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 10002; justify-content: center; align-items: center;">
    <div class="modal" style="background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); max-width: 420px; width: 90%; padding: 24px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0; color: #1e293b; font-size: 20px; font-weight: 700;">üîí Cambiar contrase√±a</h2>
        <button type="button" onclick="window.closeChangePasswordModal()" style="background: none; border: none; font-size: 22px; color: #64748b; cursor: pointer;">√ó</button>
      </div>
      <form id="changePasswordForm" onsubmit="return window.submitChangePassword(event);">
        <div style="margin-bottom: 14px;">
          <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151;">Contrase√±a actual</label>
          <input type="password" id="changePasswordCurrent" required minlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
        </div>
        <div style="margin-bottom: 14px;">
          <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151;">Nueva contrase√±a</label>
          <input type="password" id="changePasswordNew" required minlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
        </div>
        <div style="margin-bottom: 18px;">
          <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #374151;">Repetir nueva contrase√±a</label>
          <input type="password" id="changePasswordConfirm" required minlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
        </div>
        <div id="changePasswordMessage" style="display: none; margin-bottom: 12px; padding: 10px; border-radius: 8px; font-size: 14px;"></div>
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
          <button type="button" onclick="window.closeChangePasswordModal()" style="padding: 10px 18px; border: 1px solid #e5e7eb; border-radius: 8px; background: #f9fafb; cursor: pointer; font-weight: 600;">Cancelar</button>
          <button type="submit" style="padding: 10px 18px; border: none; border-radius: 8px; background: #2563eb; color: white; cursor: pointer; font-weight: 600;">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Sobre Nosotros -->
  <div id="aboutUsModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.45); z-index: 10000; justify-content: center; align-items: center; backdrop-filter: blur(6px);">
    <div class="modal" style="background: #ffffff; border-radius: 18px; box-shadow: 0 24px 60px rgba(15, 23, 42, 0.25); max-width: 520px; width: calc(100% - 32px); max-height: 90vh; overflow-y: auto; position: relative; z-index: 10001; border: 1px solid rgba(148, 163, 184, 0.25);">
      <div class="modal-content" style="padding: 24px; box-sizing: border-box; width: 100%;">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px; padding-bottom: 14px; border-bottom: 1px solid #e5e7eb;">
          <div style="display:flex; align-items:center; gap:10px;">
            <div style="width: 36px; height: 36px; border-radius: 10px; background: linear-gradient(135deg, #e0f2fe, #dbeafe); display:flex; align-items:center; justify-content:center; font-size:18px;">üë•</div>
            <div>
              <h2 style="margin: 0; color: #0f172a; font-size: 20px; font-weight: 700;">Nosotros</h2>
              <div style="color:#64748b; font-size:12px;">NutriPlant PRO</div>
            </div>
          </div>
          <button onclick="window.closeAboutUsModal()" style="
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            font-size: 18px;
            color: #334155;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            transition: all 0.2s ease;
          " onmouseover="this.style.background='#e2e8f0'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='#f1f5f9'; this.style.transform='none'">
            √ó
          </button>
        </div>
        <div style="display: grid; gap: 16px; width: 100%; max-width: 100%; min-width: 0;">
          <div style="background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 14px; padding: 16px; color: #1f2937; line-height: 1.6;">
            <strong>NutriPlant PRO</strong> es una plataforma t√©cnica enfocada en mejorar la toma de decisiones en nutrici√≥n vegetal, integrando conocimiento agron√≥mico, an√°lisis y tecnolog√≠a. Promovemos el criterio t√©cnico, el aprendizaje continuo y una comunidad profesional que valore el rigor, la honestidad y la evoluci√≥n constante.
          </div>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 14px;">
            <div style="background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 14px; padding: 16px;">
              <h3 style="margin: 0 0 10px 0; color: #0f172a; font-size: 16px;">üéØ Visi√≥n</h3>
              <p style="margin: 0; color: #334155; line-height: 1.6;">
                Ser la plataforma de referencia para el dise√±o, an√°lisis y toma de decisiones en nutrici√≥n vegetal, integrando conocimiento agron√≥mico, tecnolog√≠a e inteligencia artificial, y formando una comunidad t√©cnica global que valore el rigor, la precisi√≥n y la mejora continua.
              </p>
            </div>
            <div style="background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 14px; padding: 16px;">
              <h3 style="margin: 0 0 10px 0; color: #0f172a; font-size: 16px;">üß© Misi√≥n</h3>
              <p style="margin: 0; color: #334155; line-height: 1.6;">
                Elevar el criterio t√©cnico en la nutrici√≥n vegetal, proporcionando herramientas, conocimiento y an√°lisis basados en fundamentos cient√≠ficos, que permitan a agr√≥nomos y t√©cnicos tomar mejores decisiones en la formulaci√≥n de programas nutricionales.
              </p>
            </div>
            <div style="background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 14px; padding: 16px;">
              <h3 style="margin: 0 0 10px 0; color: #0f172a; font-size: 16px;">‚úÖ Valores</h3>
              <ul style="margin: 0; padding-left: 18px; color: #334155; line-height: 1.6;">
                <li><strong>Criterio:</strong> Pensar antes de aplicar. Decidir con fundamento.</li>
                <li><strong>Respeto:</strong> Al proceso, a las personas y al conocimiento en construcci√≥n.</li>
                <li><strong>Honestidad:</strong> Hablar claro, sin promesas vac√≠as ni verdades a medias.</li>
                <li><strong>Evoluci√≥n:</strong> Aprender, ajustar y mejorar de forma continua.</li>
              </ul>
            </div>
          </div>
          <div style="margin-top: 16px; padding-top: 14px; border-top: 1px solid #e5e7eb; text-align: center;">
            <a href="politicas-privacidad.html" target="_blank" rel="noopener" style="color: #2563eb; font-size: 13px; font-weight: 600; text-decoration: none;">Pol√≠ticas de privacidad</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Funciones para el modal de informaci√≥n de usuario
    function showUserInfoModal() {
      console.log('üîç showUserInfoModal() llamada');
      try {
        const modal = document.getElementById('userInfoModal');
        console.log('üîç Modal encontrado:', modal);
        if (modal) {
          console.log('üîç Mostrando modal...');
          // Agregar clase show para mostrar el modal (el CSS se encarga del centrado)
          modal.classList.add('show');
          console.log('üîç Clase show agregada, display computado:', window.getComputedStyle(modal).display);
          loadUserInfo();
        } else {
          console.error('‚ùå Modal no encontrado en el DOM');
          alert('Error: No se encontr√≥ el modal de informaci√≥n de usuario.');
        }
      } catch (error) {
        console.error('‚ùå Error en showUserInfoModal:', error);
        alert('Error al abrir el modal: ' + error.message);
      }
    }
    window.showUserInfoModal = showUserInfoModal;
    
    // Verificar que la funci√≥n est√© disponible al cargar
    console.log('‚úÖ showUserInfoModal definida:', typeof window.showUserInfoModal);

    function showAboutUsModal() {
      const modal = document.getElementById('aboutUsModal');
      if (modal) {
        modal.classList.add('show');
      }
    }
    window.showAboutUsModal = showAboutUsModal;
    
    // Funci√≥n para mostrar el modal de nuevo proyecto
    function showNewProjectModal() {
      console.log('üîç showNewProjectModal() llamada');
      try {
        // Buscar el modal en el DOM
        let modal = document.querySelector('#dlg-new-project');
        
        // Si no existe, puede que la secci√≥n Inicio no se haya cargado a√∫n
        if (!modal) {
          console.log('‚ö†Ô∏è Modal no encontrado, intentando cargar secci√≥n Inicio...');
          // Intentar cargar la secci√≥n Inicio primero
          if (typeof selectSection === 'function') {
            selectSection('Inicio');
            // Esperar un momento para que se genere el HTML
            setTimeout(() => {
              modal = document.querySelector('#dlg-new-project');
              if (modal) {
                const form = document.querySelector('#form-new-project');
                if (form) form.reset();
                if (modal.showModal) {
                  modal.showModal();
                  console.log('‚úÖ Modal mostrado despu√©s de cargar secci√≥n');
                } else {
                  modal.style.display = 'block';
                  console.log('‚úÖ Modal mostrado con display block');
                }
              } else {
                console.error('‚ùå Modal a√∫n no encontrado despu√©s de cargar secci√≥n');
                alert('Error: No se pudo cargar el formulario de nuevo proyecto. Por favor, recarga la p√°gina.');
              }
            }, 300);
          } else {
            alert('Error: La funci√≥n selectSection no est√° disponible. Por favor, recarga la p√°gina.');
          }
          return;
        }
        
        // Si el modal existe, mostrarlo
        const form = document.querySelector('#form-new-project');
        if (form) form.reset();
        
        if (modal.showModal) {
          modal.showModal();
          console.log('‚úÖ Modal mostrado con showModal()');
        } else {
          modal.style.display = 'block';
          modal.style.position = 'fixed';
          modal.style.top = '50%';
          modal.style.left = '50%';
          modal.style.transform = 'translate(-50%, -50%)';
          modal.style.zIndex = '10000';
          console.log('‚úÖ Modal mostrado con display block');
        }
      } catch (error) {
        console.error('‚ùå Error en showNewProjectModal:', error);
        alert('Error al abrir el formulario de nuevo proyecto: ' + error.message);
      }
    }
    window.showNewProjectModal = showNewProjectModal;
    console.log('‚úÖ showNewProjectModal definida:', typeof window.showNewProjectModal);

    function closeUserInfoModal() {
      const modal = document.getElementById('userInfoModal');
      if (modal) {
        modal.classList.remove('show');
      }
    }
    window.closeUserInfoModal = closeUserInfoModal;

    function closeAboutUsModal() {
      const modal = document.getElementById('aboutUsModal');
      if (modal) {
        modal.classList.remove('show');
      }
    }
    window.closeAboutUsModal = closeAboutUsModal;

    function loadUserInfo() {
      const contentDiv = document.getElementById('userInfoContent');
      if (!contentDiv) return;

      try {
        // Obtener datos de sesi√≥n
        const sessionData = localStorage.getItem('np_user');
        if (!sessionData) {
          contentDiv.innerHTML = '<p style="color: #dc2626; text-align: center; padding: 20px;">No se encontr√≥ informaci√≥n de sesi√≥n.</p>';
          return;
        }

        const session = JSON.parse(sessionData);
        const userId = session.userId || session.user_id;
        const userEmail = session.email;

        if (!userId) {
          contentDiv.innerHTML = `
            <div style="text-align: center; padding: 20px;">
              <p style="color: #dc2626; margin-bottom: 16px;">‚ùå No se encontr√≥ ID de usuario.</p>
              <p style="color: #64748b; margin-bottom: 20px;">Tu sesi√≥n ha expirado o el usuario no existe.</p>
              <button onclick="window.location.href='login.html'" 
                      style="background: #60a5fa; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                Ir a Iniciar Sesi√≥n
              </button>
            </div>
          `;
          return;
        }
        
        // üîí VALIDAR QUE EL USUARIO REALMENTE EXISTE
        const userKeyForValidation = `nutriplant_user_${userId}`;
        const userExists = localStorage.getItem(userKeyForValidation);
        if (!userExists) {
          contentDiv.innerHTML = `
            <div style="text-align: center; padding: 20px;">
              <p style="color: #dc2626; margin-bottom: 16px;">‚ùå Usuario no encontrado.</p>
              <p style="color: #64748b; margin-bottom: 20px;">El usuario con ID ${userId} no existe en el sistema.</p>
              <button onclick="window.location.href='login.html'" 
                      style="background: #60a5fa; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                Ir a Iniciar Sesi√≥n
              </button>
            </div>
          `;
          // Limpiar sesi√≥n inv√°lida
          localStorage.removeItem('nutriplant_user_id');
          localStorage.removeItem('np_user');
          return;
        }

        // Obtener datos completos del usuario
        const userKey = `nutriplant_user_${userId}`;
        const userDataStr = localStorage.getItem(userKey);
        let userData = {};

        if (userDataStr) {
          try {
            userData = JSON.parse(userDataStr);
          } catch (e) {
            console.error('Error parsing user data:', e);
          }
        }

        // Funciones auxiliares
        function formatDate(dateStr) {
          if (!dateStr) return 'No especificado';
          try {
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return 'No especificado';
            return date.toLocaleDateString('es-MX', { 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric' 
            });
          } catch (e) {
            return 'No especificado';
          }
        }

        function formatSubscriptionStatus(status) {
          const statusMap = {
            'active': '‚úÖ Activa',
            'cancelled': '‚ùå Cancelada',
            'expired': '‚è∞ Expirada',
            'pending': '‚è≥ Pendiente',
            'suspended': '‚è∏Ô∏è Suspendida'
          };
          return statusMap[status] || status || 'No especificado';
        }

        function getRelevantDate(userData) {
          if (userData.subscription_status === 'active' && userData.subscription_activated_at) {
            return { label: 'Fecha de Activaci√≥n', date: userData.subscription_activated_at };
          } else if (userData.subscription_status === 'cancelled' && userData._cancelled_at) {
            return { label: 'Fecha de Cancelaci√≥n', date: userData._cancelled_at };
          } else if (userData.subscription_status === 'expired' && userData._expired_at) {
            return { label: 'Fecha de Expiraci√≥n', date: userData._expired_at };
          } else if (userData.subscription_status === 'pending' && userData._pending_at) {
            return { label: 'Fecha Pendiente', date: userData._pending_at };
          }
          return { label: 'Fecha de Suscripci√≥n', date: null };
        }

        const relevantDate = getRelevantDate(userData);
        const subscriptionAmount = userData.subscription_amount || 49.00;

        // Construir HTML
        const html = `
          <div style="display: flex; flex-direction: column; gap: 24px; width: 100%; box-sizing: border-box; min-width: 0;">
            <!-- Informaci√≥n Personal -->
            <div style="background: #f8fafc; padding: 20px; border-radius: 12px; border-left: 4px solid #2563eb; width: 100%; box-sizing: border-box;">
              <h3 style="margin: 0 0 16px 0; color: #1e293b; font-size: 18px; font-weight: 600;">üìã Informaci√≥n Personal</h3>
              <div style="display: grid; gap: 12px;">
                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e2e8f0;">
                  <span style="color: #64748b; font-weight: 500;">Nombre:</span>
                  <span style="color: #1e293b; font-weight: 600;">${userData.name || 'No especificado'}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e2e8f0;">
                  <span style="color: #64748b; font-weight: 500;">Correo Electr√≥nico:</span>
                  <span style="color: #1e293b; font-weight: 600;">${userData.email || userEmail || 'No especificado'}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e2e8f0;">
                  <span style="color: #64748b; font-weight: 500;">Tel√©fono:</span>
                  <span style="color: #1e293b; font-weight: 600;">${userData.phone || 'No especificado'}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                  <span style="color: #64748b; font-weight: 500;">Ubicaci√≥n:</span>
                  <span style="color: #1e293b; font-weight: 600; text-align: right;">
                    ${userData.location ? [userData.location.city, userData.location.state, userData.location.country].filter(Boolean).join(', ') || 'No especificado' : 'No especificado'}
                  </span>
                </div>
              </div>
            </div>

            <!-- Informaci√≥n de Suscripci√≥n -->
            <div style="background: #f0fdf4; padding: 24px; border-radius: 12px; border-left: 4px solid #16a34a; width: 100%; box-sizing: border-box; max-width: 100%;">
              <h3 style="margin: 0 0 16px 0; color: #1e293b; font-size: 18px; font-weight: 600;">üí≥ Informaci√≥n de Suscripci√≥n</h3>
              <div style="display: grid; gap: 12px;">
                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e2e8f0;">
                  <span style="color: #64748b; font-weight: 500;">Estado de Suscripci√≥n:</span>
                  <span style="color: #1e293b; font-weight: 600;">${formatSubscriptionStatus(userData.subscription_status)}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e2e8f0;">
                  <span style="color: #64748b; font-weight: 500;">Plan:</span>
                  <span style="color: #1e293b; font-weight: 600;">Cada 5 meses</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e2e8f0;">
                  <span style="color: #64748b; font-weight: 500;">${relevantDate.label}:</span>
                  <span style="color: #1e293b; font-weight: 600;">${formatDate(relevantDate.date)}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e2e8f0;">
                  <span style="color: #64748b; font-weight: 500;">Fecha del √öltimo Pago:</span>
                  <span style="color: #1e293b; font-weight: 600;">${formatDate(userData.last_payment_date)}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e2e8f0;">
                  <span style="color: #64748b; font-weight: 500;">Fecha del Pr√≥ximo Pago:</span>
                  <span style="color: #1e293b; font-weight: 600;">${formatDate(userData.next_payment_date)}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                  <span style="color: #64748b; font-weight: 500;">Monto:</span>
                  <span style="color: #1e293b; font-weight: 600; font-size: 18px;">$${subscriptionAmount.toFixed(2)} USD</span>
                </div>
              </div>
            </div>

            <!-- Cambiar contrase√±a (solo si Supabase est√° activo) -->
            ${window.nutriplantSupabaseAuth && window.nutriplantSupabaseAuth.isAvailable && window.nutriplantSupabaseAuth.isAvailable() ? `
            <div style="background: #eff6ff; padding: 20px; border-radius: 12px; border-left: 4px solid #2563eb; width: 100%; box-sizing: border-box;">
              <h3 style="margin: 0 0 12px 0; color: #1e293b; font-size: 18px; font-weight: 600;">üîí Contrase√±a</h3>
              <p style="margin: 0 0 12px 0; color: #64748b; font-size: 14px;">Si quieres cambiar tu contrase√±a de acceso, usa el bot√≥n siguiente.</p>
              <button type="button" data-open-change-password onclick="window.showChangePasswordModal(); return false;" style="
                background: #2563eb; color: white; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;
              " onmouseover="this.style.background='#1d4ed8'" onmouseout="this.style.background='#2563eb'">
                Cambiar contrase√±a
              </button>
            </div>
            ` : ''}

            <!-- Secci√≥n de Cancelaci√≥n -->
            <div style="background: #fef3c7; padding: 20px; border-radius: 12px; border-left: 4px solid #f59e0b; width: 100%; box-sizing: border-box;">
              <h3 style="margin: 0 0 12px 0; color: #1e293b; font-size: 18px; font-weight: 600;">üö´ Cancelaci√≥n de Suscripci√≥n</h3>
              <p style="margin: 0; color: #1e293b; line-height: 1.6; font-size: 14px;">
                La cancelaci√≥n de la suscripci√≥n se realiza directamente con PayPal, desde tu cuenta en la secci√≥n <strong>Pagos autom√°ticos</strong>.
              </p>
            </div>
          </div>
        `;

        contentDiv.innerHTML = html;
        var changePwdBtn = contentDiv.querySelector('[data-open-change-password]');
        if (changePwdBtn) changePwdBtn.addEventListener('click', function() { window.showChangePasswordModal(); });
      } catch (error) {
        console.error('Error loading user info:', error);
        contentDiv.innerHTML = '<p style="color: #dc2626; text-align: center; padding: 20px;">Error al cargar la informaci√≥n del usuario.</p>';
      }
    }

    function showChangePasswordModal() {
      const modal = document.getElementById('changePasswordModal');
      if (modal) {
        document.getElementById('changePasswordCurrent').value = '';
        document.getElementById('changePasswordNew').value = '';
        document.getElementById('changePasswordConfirm').value = '';
        var msgEl = document.getElementById('changePasswordMessage');
        if (msgEl) { msgEl.style.display = 'none'; msgEl.textContent = ''; }
        modal.classList.add('show');
        modal.style.display = 'flex';
      }
    }
    window.showChangePasswordModal = showChangePasswordModal;

    // Que el bot√≥n "Cambiar contrase√±a" funcione aunque otros scripts fallen (delegaci√≥n de eventos)
    document.addEventListener('click', function(e) {
      var btn = e.target && e.target.closest ? e.target.closest('[data-open-change-password]') : null;
      if (btn) {
        e.preventDefault();
        if (typeof window.showChangePasswordModal === 'function') window.showChangePasswordModal();
      }
    });

    function closeChangePasswordModal() {
      const modal = document.getElementById('changePasswordModal');
      if (modal) { modal.classList.remove('show'); modal.style.display = 'none'; }
    }
    window.closeChangePasswordModal = closeChangePasswordModal;

    async function submitChangePassword(e) {
      e.preventDefault();
      var current = document.getElementById('changePasswordCurrent').value.trim();
      var newPwd = document.getElementById('changePasswordNew').value.trim();
      var confirmPwd = document.getElementById('changePasswordConfirm').value.trim();
      var msgEl = document.getElementById('changePasswordMessage');
      if (!msgEl) return false;
      msgEl.style.display = 'none';
      msgEl.textContent = '';
      if (newPwd.length < 6) {
        msgEl.style.display = 'block'; msgEl.style.background = '#fef2f2'; msgEl.style.color = '#dc2626';
        msgEl.textContent = 'La nueva contrase√±a debe tener al menos 6 caracteres.';
        return false;
      }
      if (newPwd !== confirmPwd) {
        msgEl.style.display = 'block'; msgEl.style.background = '#fef2f2'; msgEl.style.color = '#dc2626';
        msgEl.textContent = 'La nueva contrase√±a y la repetici√≥n no coinciden.';
        return false;
      }
      var sessionData = localStorage.getItem('np_user');
      if (!sessionData) {
        msgEl.style.display = 'block'; msgEl.style.background = '#fef2f2'; msgEl.style.color = '#dc2626';
        msgEl.textContent = 'No hay sesi√≥n. Vuelve a iniciar sesi√≥n.';
        return false;
      }
      var session = JSON.parse(sessionData);
      var email = session.email;
      var userId = session.userId || session.user_id;
      if (!email || !userId) {
        msgEl.style.display = 'block'; msgEl.style.background = '#fef2f2'; msgEl.style.color = '#dc2626';
        msgEl.textContent = 'Sesi√≥n incompleta. Vuelve a iniciar sesi√≥n.';
        return false;
      }
      var auth = window.nutriplantSupabaseAuth;
      if (!auth || !auth.isAvailable || !auth.isAvailable()) {
        msgEl.style.display = 'block'; msgEl.style.background = '#fef2f2'; msgEl.style.color = '#dc2626';
        msgEl.textContent = 'No est√° disponible el cambio de contrase√±a en este momento.';
        return false;
      }
      var signIn = window.getSupabaseClient && window.getSupabaseClient();
      if (signIn) {
        var check = await signIn.auth.signInWithPassword({ email: email, password: current });
        if (check.error) {
          msgEl.style.display = 'block'; msgEl.style.background = '#fef2f2'; msgEl.style.color = '#dc2626';
          msgEl.textContent = 'Contrase√±a actual incorrecta.';
          return false;
        }
      }
      var result = await auth.updatePassword(newPwd);
      if (result && result.error) {
        msgEl.style.display = 'block'; msgEl.style.background = '#fef2f2'; msgEl.style.color = '#dc2626';
        msgEl.textContent = result.error || 'No se pudo actualizar la contrase√±a.';
        return false;
      }
      var userKey = 'nutriplant_user_' + userId;
      try {
        var raw = localStorage.getItem(userKey);
        if (raw && raw.startsWith('{')) {
          var u = JSON.parse(raw);
          u.password = newPwd;
          localStorage.setItem(userKey, JSON.stringify(u));
        }
      } catch (err) {}
      msgEl.style.display = 'block'; msgEl.style.background = '#f0fdf4'; msgEl.style.color = '#166534';
      msgEl.textContent = 'Contrase√±a actualizada correctamente.';
      setTimeout(function() {
        closeChangePasswordModal();
      }, 1500);
      return false;
    }
    window.submitChangePassword = submitChangePassword;

    // Cerrar modal al hacer clic fuera
    document.addEventListener('click', function(event) {
      const modal = document.getElementById('userInfoModal');
      if (modal && event.target === modal) {
        closeUserInfoModal();
      }
      const aboutModal = document.getElementById('aboutUsModal');
      if (aboutModal && event.target === aboutModal) {
        closeAboutUsModal();
      }
      const changePwdModal = document.getElementById('changePasswordModal');
      if (changePwdModal && event.target === changePwdModal) {
        closeChangePasswordModal();
      }
    });

    // Cerrar modal con ESC
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        const modal = document.getElementById('userInfoModal');
        if (modal && modal.style.display === 'flex') {
          closeUserInfoModal();
        }
        const aboutModal = document.getElementById('aboutUsModal');
        if (aboutModal && aboutModal.style.display === 'flex') {
          closeAboutUsModal();
        }
        const changePwdModal = document.getElementById('changePasswordModal');
        if (changePwdModal && changePwdModal.classList.contains('show')) {
          closeChangePasswordModal();
        }
      }
    });
  </script>
  <script src="apply-no-traducir.js"></script>
  <!-- Aviso de cookies (misma l√≥gica que en login: solo si no ha aceptado) -->
  <div id="cookie-consent-banner" class="cookie-consent-banner" role="dialog" aria-label="Aviso de cookies" style="display: none;">
    <div class="cookie-consent-inner">
      <p class="cookie-consent-text">
        Utilizamos cookies y almacenamiento local para que la sesi√≥n y tus datos funcionen correctamente. Al continuar, aceptas su uso.
        <a href="politicas-privacidad.html" target="_blank" rel="noopener" class="cookie-consent-link">Pol√≠tica de privacidad</a>
      </p>
      <button type="button" id="cookie-consent-accept" class="cookie-consent-btn">Aceptar</button>
    </div>
  </div>
  <style>
    .cookie-consent-banner { position: fixed; bottom: 0; left: 0; right: 0; background: linear-gradient(180deg, #f0fdf4 0%, #dcfce7 100%); border-top: 1px solid #86efac; box-shadow: 0 -4px 20px rgba(22, 163, 74, 0.15); z-index: 99999; padding: 14px 20px; }
    .cookie-consent-inner { max-width: 900px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; gap: 20px; flex-wrap: wrap; }
    .cookie-consent-text { margin: 0; font-size: 14px; color: #166534; line-height: 1.5; flex: 1; min-width: 200px; }
    .cookie-consent-link { color: #15803d; font-weight: 600; text-decoration: underline; }
    .cookie-consent-link:hover { color: #166534; }
    .cookie-consent-btn { background: #16a34a; color: #fff; border: none; padding: 10px 24px; border-radius: 10px; font-weight: 600; font-size: 15px; cursor: pointer; white-space: nowrap; transition: background 0.2s, transform 0.15s; }
    .cookie-consent-btn:hover { background: #15803d; transform: translateY(-1px); }
  </style>
  <script>
    (function() {
      var key = 'nutriplant_cookie_consent';
      var banner = document.getElementById('cookie-consent-banner');
      var btn = document.getElementById('cookie-consent-accept');
      if (!banner || !btn) return;
      try {
        if (localStorage.getItem(key) === 'accepted') { banner.style.display = 'none'; return; }
        banner.style.display = 'block';
      } catch (e) {}
      btn.addEventListener('click', function() {
        try { localStorage.setItem(key, 'accepted'); } catch (e) {}
        banner.style.display = 'none';
      });
    })();
  </script>
</body>
</html>