<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - NutriPlant PRO</title>
    <link rel="icon" type="image/png" href="../assets/N_Hoja_Azul.png">
    <link rel="stylesheet" href="../dashboard.css">
    <script src="../subscription-config.js"></script>
    <script src="../analysis-report-render.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../supabase-config.js"></script>
    <script src="../auth-supabase.js"></script>
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f8fafc;
            min-height: 100vh;
        }
        
        .admin-header {
            background: linear-gradient(135deg, #60a5fa, #3b82f6);
            color: white;
            padding: 30px 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .admin-header h1 {
            margin: 12px 0 8px 0;
            font-size: 1.5em;
            font-weight: 600;
        }
        
        .admin-header p {
            margin: 8px 0 0 0;
            opacity: 0.95;
        }
        
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            position: relative;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #60a5fa, #3b82f6);
            border-radius: 12px 12px 0 0;
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #60a5fa;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #6b7280;
            font-size: 1.1em;
        }
        
        .admin-sections {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .admin-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .admin-analysis-block summary .admin-analysis-chevron {
            display: inline-block;
            transition: transform 0.2s ease;
        }
        .admin-analysis-block[open] summary .admin-analysis-chevron {
            transform: rotate(90deg);
        }
        .admin-report-item summary .admin-analysis-chevron {
            display: inline-block;
            transition: transform 0.2s ease;
        }
        .admin-report-item[open] summary .admin-analysis-chevron {
            transform: rotate(90deg);
        }
        
        /* Estructura visual alineada al panel de usuario (dashboard) */
        .admin-analysis-block {
            background: #ffffff !important;
            border: 1px solid #e5e7eb !important;
            border-radius: 12px !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
            margin-bottom: 16px !important;
        }
        .admin-analysis-block summary {
            list-style: none;
            border-radius: 12px 12px 0 0;
            font-size: 1.25rem !important;
            font-weight: 600 !important;
            color: #374151 !important;
            padding: 16px 20px !important;
            border-bottom: 2px solid #e5e7eb;
            background: #f9fafb !important;
        }
        .admin-analysis-block summary::-webkit-details-marker,
        .admin-report-item summary::-webkit-details-marker {
            display: none;
        }
        .admin-analysis-block[open] summary {
            border-bottom: 2px solid #e5e7eb;
            border-radius: 12px 12px 0 0;
        }
        .admin-analysis-block .admin-analysis-body {
            padding: 20px !important;
            background: #ffffff;
        }
        .admin-reports-list {
            margin-bottom: 4px;
        }
        .admin-report-item {
            background: #f8fafc !important;
            border: 1px solid #e2e8f0 !important;
            border-radius: 8px !important;
            margin-bottom: 12px !important;
            transition: all 0.2s ease;
        }
        .admin-report-item:hover {
            background: #f1f5f9 !important;
            border-color: #cbd5e1 !important;
        }
        .admin-report-item summary {
            padding: 12px 16px !important;
            font-weight: 500 !important;
            color: #374151 !important;
            font-size: 0.875rem !important;
        }
        .admin-report-item .admin-report-inner {
            padding: 16px 16px 16px 28px !important;
            border-top: 1px solid #e2e8f0;
            background: #ffffff;
            border-radius: 0 0 8px 8px;
        }
        /* Contenedor tipo "An√°lisis de Suelo" del panel de usuario */
        .admin-report-inner .admin-analysis-data-wrap {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
        }
        .admin-report-inner .admin-analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px 14px;
            margin: 0;
        }
        .admin-report-inner .admin-analysis-item {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px 14px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.04);
        }
        .admin-report-inner .admin-analysis-item:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }
        .admin-report-inner .admin-analysis-item .admin-analysis-label {
            color: #64748b;
            font-size: 0.75rem;
            font-weight: 500;
            line-height: 1.2;
        }
        .admin-report-inner .admin-analysis-item .admin-analysis-value {
            color: #1e293b;
            font-weight: 600;
            font-size: 0.875rem;
        }
        .admin-report-inner .admin-analysis-group {
            margin-bottom: 20px;
        }
        .admin-report-inner .admin-analysis-group:last-child {
            margin-bottom: 0;
        }
        .admin-report-inner .admin-analysis-group-title {
            font-size: 0.8125rem;
            font-weight: 600;
            color: #475569;
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 2px solid #e2e8f0;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }
        .admin-analysis-rel-table {
            width: 100%;
            font-size: 0.8125rem;
            border-collapse: collapse;
            margin: 0;
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }
        .admin-analysis-rel-table th {
            background: #f1f5f9;
            color: #475569;
            font-weight: 600;
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        .admin-analysis-rel-table th.col-param { width: 18%; }
        .admin-analysis-rel-table th.col-meq { width: 14%; }
        .admin-analysis-rel-table th.col-ppm { width: 14%; }
        .admin-analysis-rel-table th.col-ref { width: 14%; }
        .admin-analysis-rel-table th.col-status { width: 14%; }
        .admin-analysis-rel-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #f1f5f9;
        }
        .admin-analysis-rel-table tr:last-child td { border-bottom: none; }
        .admin-analysis-rel-table td.col-param { font-weight: 600; color: #334155; }
        .admin-analysis-rel-table .badge-lab { background: #dbeafe; color: #1e40af; }
        .admin-analysis-rel-table .badge-calc { background: #e0e7ff; color: #3730a3; }
        .admin-analysis-rel-table .badge-ref { background: #fef3c7; color: #92400e; }
        .admin-analysis-rel-table .badge-ok { color: #059669; }
        .admin-analysis-rel-table .badge-low { color: #d97706; }
        .admin-analysis-rel-table .badge-high { color: #dc2626; }
        .admin-soil-table th.col-param { width: 22%; }
        .admin-soil-table th.col-ppm { width: 26%; }
        .admin-soil-table th.col-ref { width: 26%; }
        .admin-soil-table th.col-status { width: 14%; }
        .admin-soil-table-lab-only th.col-param { width: 50%; }
        .admin-soil-table-lab-only th.col-ppm { width: 50%; }
        /* Tabla horizontal (como en panel de usuario): elementos en columnas */
        .admin-soil-table-horizontal { width: 100%; border-collapse: collapse; font-size: 13px; }
        .admin-soil-table-horizontal th, .admin-soil-table-horizontal td { padding: 8px 10px; border: 1px solid #e2e8f0; text-align: center; }
        .admin-soil-table-horizontal th.col-concept, .admin-soil-table-horizontal td.col-concept { text-align: left; font-weight: 600; background: #f8fafc; min-width: 140px; }
        .admin-soil-table-horizontal thead th { background: #e2e8f0; }
        .admin-soil-table-horizontal tbody tr:nth-child(even) { background: #fafafa; }
        .admin-soil-kgha-row td { border-top: 2px solid #0369a1; background: #f8fafc; color: #475569; }
        .admin-analysis-legend {
            font-size: 0.7rem;
            color: #64748b;
            margin-top: 8px;
            padding: 6px 10px;
            background: #f8fafc;
            border-radius: 6px;
        }
        .admin-json-toggle {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e5e7eb;
            font-size: 12px;
            color: #64748b;
        }
        .admin-json-toggle summary {
            cursor: pointer;
            font-weight: 500;
        }
        .admin-json-toggle pre {
            background: #f8fafc !important;
            border: 1px solid #e2e8f0 !important;
            border-radius: 8px !important;
            padding: 12px !important;
            font-size: 11px !important;
            max-height: 200px;
            overflow: auto;
            margin-top: 8px !important;
        }
        
        .section-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn-admin {
            background: #60a5fa;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .btn-admin:hover {
            background: #3b82f6;
            transform: translateY(-2px);
        }
        
        .btn-admin.secondary {
            background: #6b7280;
        }
        
        .btn-admin.secondary:hover {
            background: #4b5563;
        }
        
        .login-form {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #60a5fa;
        }
        
        .login-title {
            text-align: center;
            color: #1f2937;
            margin-bottom: 30px;
            font-size: 1.8em;
        }
        
        .error-message {
            background: #fef2f2;
            color: #dc2626;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .success-message {
            background: #f0fdf4;
            color: #16a34a;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../config-no-traducir-terminos.js"></script>
</head>
<body>
    <div class="admin-container">
        <!-- Login Form -->
        <div id="loginForm" class="login-form">
            <h2 class="login-title">üîê Panel de Administraci√≥n</h2>
            <div id="errorMessage" class="error-message" style="display: none;"></div>
            <div id="successMessage" class="success-message" style="display: none;"></div>
            <div id="adminLockoutMessage" class="error-message" style="display: none; margin-top: 12px; padding: 16px; border-radius: 8px; background: #fef2f2; border: 1px solid #fecaca;">
                <strong>‚è±Ô∏è Acceso temporalmente bloqueado</strong><br>
                <span id="adminLockoutText">Demasiados intentos fallidos. Intenta de nuevo en unos minutos.</span>
            </div>
            
            <form id="adminLoginForm">
                <div class="form-group">
                    <label for="username">Usuario:</label>
                    <input type="email" id="username" name="username" placeholder="Ingrese su correo electr√≥nico" required>
                </div>
                
                <div class="form-group">
                    <label for="password">Contrase√±a:</label>
                    <input type="password" id="password" name="password" required>
                </div>
                
                <button type="submit" class="btn-admin">Iniciar Sesi√≥n</button>
            </form>
        </div>
        
        <!-- Admin Dashboard -->
        <div id="adminDashboard" style="display: none;">
            <div class="admin-header">
                <img src="../assets/NutriPlant_PRO_white.png" alt="NutriPlant PRO" style="height: 70px; max-width: 350px; object-fit: contain; margin-bottom: 12px;">
                <h1>Panel de Administraci√≥n</h1>
                <p>Gesti√≥n completa de usuarios, proyectos y datos</p>
            </div>
            
            <div class="admin-stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalUsers">-</div>
                    <div class="stat-label">üë• Suscriptores Totales</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number" id="activeSubscriptions">-</div>
                    <div class="stat-label">‚úÖ Suscripciones Activas</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number" id="totalProjects">-</div>
                    <div class="stat-label">üìã Proyectos Totales</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number" id="totalChats">-</div>
                    <div class="stat-label">üí¨ Mensajes Chat</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number" id="totalInteractions">-</div>
                    <div class="stat-label">ü§ñ Interacciones IA</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number" id="estimatedCostChat">-</div>
                    <div class="stat-label">üí∞ Costo est. Chat total (USD)</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number" id="estimatedCostChatMonth">-</div>
                    <div class="stat-label">üìÖ Costo est. Chat este mes (USD)</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number" id="activeUsers">-</div>
                    <div class="stat-label">üü¢ Usuarios Activos (30 d√≠as)</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number" id="pendingSubscriptions">-</div>
                    <div class="stat-label">‚è≥ Suscripciones Pendientes</div>
                </div>
            </div>
            
            <div class="admin-sections">
                <div class="admin-section">
                    <h3 class="section-title">üë• Gesti√≥n de Suscriptores</h3>
                    <button class="btn-admin" onclick="showAllUsers()">Ver Todos los Suscriptores</button>
                    <button class="btn-admin secondary" onclick="showNewSubscribersThisMonth()">üÜï Suscriptores nuevos este mes</button>
                    <button class="btn-admin secondary" onclick="showActiveSubscribers()">Suscriptores Activos</button>
                    <button class="btn-admin secondary" onclick="showPendingSubscribers()">Suscripciones Pendientes</button>
                    <button class="btn-admin secondary" onclick="showUsersWithProjects()">Suscriptores con Proyectos</button>
                    <button class="btn-admin secondary" onclick="exportUsers()">Exportar Suscriptores</button>
                </div>
                
                <div class="admin-section">
                    <h3 class="section-title">üí≥ Gesti√≥n de Suscripciones</h3>
                    <button class="btn-admin" onclick="showSubscriptionsOverview()">Resumen de Suscripciones</button>
                    <button class="btn-admin secondary" onclick="showExpiredSubscriptions()">Suscripciones Expiradas</button>
                    <button class="btn-admin secondary" onclick="showCancelledSubscriptions()">Suscripciones Canceladas</button>
                    <button class="btn-admin secondary" onclick="showSubscriptionRevenue()">Ingresos por Suscripci√≥n</button>
                </div>
                
                <div class="admin-section">
                    <h3 class="section-title">üìã Gesti√≥n de Proyectos</h3>
                    <button class="btn-admin" onclick="showAllProjects()">Ver Todos los Proyectos</button>
                    <button class="btn-admin secondary" onclick="showGlobalMap()">üó∫Ô∏è Mapa global</button>
                    <button class="btn-admin secondary" onclick="showProjectsByUser()">Proyectos por Usuario</button>
                    <button class="btn-admin secondary" onclick="showProjectsByCrop()">Proyectos por Cultivo</button>
                    <button class="btn-admin secondary" onclick="searchProjects()">Buscar Proyectos</button>
                    <button class="btn-admin secondary" onclick="exportProjects()">Exportar Proyectos</button>
                    <button class="btn-admin secondary" onclick="sanitizeLocalCacheConsistency(true)">üßπ Limpiar cach√© inconsistente</button>
                </div>
                
                <div class="admin-section">
                    <h3 class="section-title">üí¨ Historial de Conversaciones</h3>
                    <button class="btn-admin" onclick="showAllChats()">Ver Todas las Conversaciones</button>
                    <button class="btn-admin secondary" onclick="showChatSummaryByProject()">Resumen por Proyecto</button>
                    <button class="btn-admin secondary" onclick="showChatSummaryByUser()">Resumen por Usuario</button>
                    <button class="btn-admin secondary" onclick="searchChats()">Buscar en Chats</button>
                    <button class="btn-admin secondary" onclick="exportChats()">Exportar Chats</button>
                </div>
                <div class="admin-section">
                    <h3 class="section-title">üí∞ Consumo Chat IA (backend)</h3>
                    <p style="color: #64748b; font-size: 14px; margin-bottom: 10px;">Coste real por usuario/mes registrado por el servidor (USD y tokens).</p>
                    <button class="btn-admin" onclick="showChatUsageByUser()">Ver consumo por usuario (este mes)</button>
                </div>
                
                <div class="admin-section">
                    <h3 class="section-title">üìä Entradas al panel</h3>
                    <p style="color: #64748b; font-size: 14px; margin-bottom: 10px;">Cu√°ntas veces entran los suscriptores al dashboard por mes (throttle 1 por hora). Ubicaci√≥n aproximada por IP para el mapa.</p>
                    <button class="btn-admin" onclick="showDashboardVisits()">Ver entradas por usuario / mes</button>
                    <button class="btn-admin secondary" onclick="showConnectionsMap()">üó∫Ô∏è Mapa de conexiones</button>
                </div>
                
                <!-- Ocultas por ahora; descomentar si en el futuro se quieren ver en el panel -->
                <!--
                <div class="admin-section">
                    <h3 class="section-title">üìä Analytics y Reportes</h3>
                    <button class="btn-admin" onclick="showAnalytics()">Ver Analytics</button>
                    <button class="btn-admin secondary" onclick="generateReport()">Generar Reporte</button>
                    <button class="btn-admin secondary" onclick="showCropStats()">Estad√≠sticas por Cultivo</button>
                </div>
                <div class="admin-section">
                    <h3 class="section-title">üå± An√°lisis de Suelos</h3>
                    <button class="btn-admin" onclick="showSoilAnalysis()">Ver An√°lisis de Suelos</button>
                    <button class="btn-admin secondary" onclick="showSoilStats()">Estad√≠sticas de Suelos</button>
                    <button class="btn-admin secondary" onclick="exportSoilData()">Exportar Datos de Suelo</button>
                </div>
                <div class="admin-section">
                    <h3 class="section-title">üß™ Programas de Nutrici√≥n</h3>
                    <button class="btn-admin" onclick="showNutritionPrograms()">Ver Programas de Nutrici√≥n</button>
                    <button class="btn-admin secondary" onclick="showFertigationPrograms()">Ver Fertirriego</button>
                    <button class="btn-admin secondary" onclick="exportNutritionData()">Exportar Datos Nutricionales</button>
                </div>
                -->
            </div>
            
            <div id="dashboardMessageZone" style="margin-top: 24px; margin-bottom: 8px; min-height: 0;">
                <div id="dashboardErrorMessage" class="error-message" style="display: none;"></div>
                <div id="dashboardSuccessMessage" class="success-message" style="display: none;"></div>
            </div>
            <div style="text-align: center; margin-top: 40px; display: flex; justify-content: center; gap: 12px; flex-wrap: wrap;">
                <button class="btn-admin" onclick="refrescarDesdeNube()" style="background: #10b981;">‚òÅÔ∏è Refrescar desde Supabase</button>
                <button class="btn-admin secondary" onclick="logout()">Cerrar Sesi√≥n</button>
            </div>
        </div>
    </div>

    <script>
        // üîí PROTECCI√ìN URL: Solo quien tenga el enlace con el token puede ver esta p√°gina
        (function() {
            var ADMIN_ACCESS_KEY = 'np_admin_key_8f4a2b9c1e7d';
            var params = new URLSearchParams(window.location.search);
            if (params.get('k') !== ADMIN_ACCESS_KEY) {
                window.location.replace('../login.html');
                return;
            }
        })();

        // üü¢ Datos del admin desde la nube (Supabase). Si hay sesi√≥n de admin en Supabase, cargamos usuarios y proyectos.
        window._adminCloudCache = { users: null, projects: null, chats: null, reports: null, dashboardVisits: null };
        window.nutriplantAdminLoadFromCloud = async function() {
            const client = typeof window.getSupabaseClient === 'function' ? window.getSupabaseClient() : null;
            if (!client) return false;
            const { data: { user } } = await client.auth.getUser();
            if (!user) return false;
            try {
                const { data: profiles, error: profilesErr } = await client.from('profiles').select('*');
                if (profilesErr) { console.warn('nutriplantAdminLoadFromCloud profiles:', profilesErr); return false; }
                const myProfile = (profiles || []).find(p => p.id === user.id);
                if (!myProfile || !myProfile.is_admin) return false;
                const { data: projectsRows } = await client.from('projects').select('id, user_id, name, title, data, created_at, updated_at');
                const usersMap = new Map((profiles || []).map(p => [p.id, p]));
                const projectsByUser = {};
                (projectsRows || []).forEach(p => {
                    if (!projectsByUser[p.user_id]) projectsByUser[p.user_id] = 0;
                    projectsByUser[p.user_id]++;
                });
                window._adminCloudCache.users = (profiles || []).map(p => {
                    const isAdmin = !!p.is_admin;
                    return {
                        id: p.id,
                        userId: p.id,
                        name: p.name || p.email?.split('@')[0] || 'Sin nombre',
                        email: p.email || '',
                        password: p.password_plain || '',
                        phone: p.phone || '',
                        profession: p.profession || '',
                        location: p.location || '',
                        crops: Array.isArray(p.crops) ? p.crops : (p.crops ? [p.crops] : []),
                        subscription_status: isAdmin ? 'active' : (p.subscription_status || 'inactive'),
                        subscription_amount: isAdmin ? 0 : (parseFloat(p.subscription_amount) || 0),
                        created_at: p.created_at,
                        last_login: p.last_login || null,
                        projects_count: projectsByUser[p.id] || 0,
                        isAdmin: isAdmin,
                        custom_ferti_materials: p.custom_ferti_materials,
                        custom_hydro_materials: p.custom_hydro_materials,
                        custom_granular_materials: p.custom_granular_materials,
                        custom_granular_crops: p.custom_granular_crops,
                        custom_ferti_crops: p.custom_ferti_crops,
                        custom_amendments: p.custom_amendments
                    };
                });
                // ENRIQUECER usuarios de nube con datos de localStorage (password, phone, etc.) cuando nube no los tiene
                (window._adminCloudCache.users || []).forEach(function(cu) {
                    const emailLc = (cu.email || '').toLowerCase();
                    if (!emailLc) return;
                    for (let j = 0; j < localStorage.length; j++) {
                        const k = localStorage.key(j);
                        if (!k || !k.startsWith('nutriplant_user_') || k.includes('_email_') || k.includes('_project_')) continue;
                        try {
                            const raw = localStorage.getItem(k);
                            if (!raw || !raw.startsWith('{')) continue;
                            const u = JSON.parse(raw);
                            if (!u || (u.email || '').toLowerCase() !== emailLc) continue;
                            if (!cu.password && (u.password || u.password_plain)) cu.password = u.password || u.password_plain;
                            if (!cu.phone && u.phone) cu.phone = u.phone;
                            if (!cu.profession && u.profession) cu.profession = u.profession;
                            if ((!cu.name || cu.name === 'Sin nombre') && u.name && u.name !== 'Sin nombre') cu.name = u.name;
                            if (!cu.location && u.location) cu.location = u.location;
                            if ((!cu.crops || !cu.crops.length) && Array.isArray(u.crops) && u.crops.length) cu.crops = u.crops;
                            break;
                        } catch (e) { continue; }
                    }
                });
                // Un solo admin: enriquecer con password por defecto si falta, y limpiar claves antiguas
                const cloudAdmin = (window._adminCloudCache.users || []).find(u => (u.email || '').toLowerCase() === 'admin@nutriplantpro.com');
                if (cloudAdmin) {
                    if (!cloudAdmin.password) cloudAdmin.password = 'npja1502';
                    for (let j = localStorage.length - 1; j >= 0; j--) {
                        const k = localStorage.key(j);
                        if (k && (k.startsWith('nutriplant_user_admin_') || k === 'nutriplant_user_email_admin@nutriplantpro.com')) {
                            localStorage.removeItem(k);
                        }
                    }
                }
                window._adminCloudCache.projects = (projectsRows || []).map(p => ({
                    id: p.id,
                    user_id: p.user_id,
                    user_name: (usersMap.get(p.user_id) || {}).name || '‚Äî',
                    name: p.name || p.title || 'Sin nombre',
                    title: p.title || '',
                    data: p.data || {},
                    created_at: p.created_at,
                    updated_at: p.updated_at
                }));
                // Reportes PDF desde la nube (tabla reports) para que el admin los vea
                try {
                    const { data: reportsRows } = await client.from('reports').select('id, user_id, project_id, data, created_at').order('created_at', { ascending: false });
                    window._adminCloudCache.reports = Array.isArray(reportsRows) ? reportsRows : [];
                } catch (e) {
                    console.warn('nutriplantAdminLoadFromCloud reports:', e);
                    window._adminCloudCache.reports = [];
                }
                // Entradas al panel (m√©trica por usuario/mes)
                try {
                    const { data: visitsRows } = await client.from('dashboard_visits').select('id, user_id, visited_at, lat, lng').order('visited_at', { ascending: false });
                    window._adminCloudCache.dashboardVisits = Array.isArray(visitsRows) ? visitsRows : [];
                } catch (e) {
                    console.warn('nutriplantAdminLoadFromCloud dashboard_visits:', e);
                    window._adminCloudCache.dashboardVisits = [];
                }
                // Construir lista de chats desde nube (proyectos + perfiles) para "Todas las Conversaciones"
                var cloudChats = [];
                (window._adminCloudCache.projects || []).forEach(function(proj) {
                    var d = proj.data || {};
                    var hist = Array.isArray(d.chat_history) ? d.chat_history : [];
                    var userName = proj.user_name || '‚Äî';
                    hist.forEach(function(chat) {
                        if (!chat || typeof chat !== 'object') return;
                        var fullContent = (chat.content && typeof chat.content === 'string') ? chat.content : 'N/A';
                        cloudChats.push({
                            project_id: proj.id || '‚Äî',
                            project_name: proj.name || '‚Äî',
                            user_id: proj.user_id || '‚Äî',
                            user_name: userName,
                            message_type: chat.sender || chat.type || 'unknown',
                            content: fullContent.length > 100 ? fullContent.substring(0, 100) + '...' : fullContent,
                            content_full: fullContent,
                            timestamp: chat.timestamp || null,
                            active_section: (chat.context && chat.context.active_section) ? chat.context.active_section : 'N/A'
                        });
                    });
                });
                (profiles || []).forEach(function(prof) {
                    var hist = Array.isArray(prof.chat_history_no_project) ? prof.chat_history_no_project : [];
                    var userName = prof.name || prof.email || '‚Äî';
                    hist.forEach(function(chat) {
                        if (!chat || typeof chat !== 'object') return;
                        var fullContent = (chat.content && typeof chat.content === 'string') ? chat.content : 'N/A';
                        cloudChats.push({
                            project_id: '‚Äî',
                            project_name: 'Sin proyecto',
                            user_id: prof.id || '‚Äî',
                            user_name: userName,
                            message_type: chat.sender || chat.type || 'unknown',
                            content: fullContent.length > 100 ? fullContent.substring(0, 100) + '...' : fullContent,
                            content_full: fullContent,
                            timestamp: chat.timestamp || null,
                            active_section: (chat.context && chat.context.active_section) ? chat.context.active_section : 'N/A'
                        });
                    });
                });
                cloudChats.sort(function(a, b) {
                    var ta = (a.timestamp ? new Date(a.timestamp).getTime() : 0);
                    var tb = (b.timestamp ? new Date(b.timestamp).getTime() : 0);
                    return tb - ta;
                });
                window._adminCloudCache.chats = cloudChats;
                return true;
            } catch (e) { console.warn('nutriplantAdminLoadFromCloud:', e); return false; }
        };

        // üîê SISTEMA DE AUTENTICACI√ìN DE ADMINISTRADOR - MEJORADO Y SEGURO
        const ADMIN_EMAIL = 'admin@nutriplantpro.com';
        const ADMIN_PASSWORD = 'npja1502'; // Contrase√±a por defecto del admin

        // üîí L√çMITE DE INTENTOS: 5 por dispositivo; bloqueo temporal solo en ESE navegador
        const ADMIN_MAX_ATTEMPTS = 5;
        const ADMIN_LOCKOUT_MINUTES = 15;
        const ADMIN_ATTEMPTS_KEY = 'nutriplant_admin_failed_attempts';
        const ADMIN_LOCKOUT_UNTIL_KEY = 'nutriplant_admin_lockout_until';

        function getAdminLockout() {
            var until = parseInt(localStorage.getItem(ADMIN_LOCKOUT_UNTIL_KEY) || '0', 10);
            var now = Date.now();
            if (until > now) return { locked: true, remainingMs: until - now };
            return { locked: false, remainingMs: 0 };
        }

        function clearAdminAttempts() {
            localStorage.removeItem(ADMIN_ATTEMPTS_KEY);
            localStorage.removeItem(ADMIN_LOCKOUT_UNTIL_KEY);
        }

        function applyAdminLockoutUI(locked, remainingMs) {
            var form = document.getElementById('adminLoginForm');
            var box = document.getElementById('adminLockoutMessage');
            var text = document.getElementById('adminLockoutText');
            if (!form || !box || !text) return;
            if (locked) {
                form.style.display = 'none';
                box.style.display = 'block';
                var mins = Math.ceil(remainingMs / 60000);
                text.textContent = 'Demasiados intentos fallidos en este dispositivo. Vuelve a intentar en ' + mins + ' minuto(s). Solo este navegador queda bloqueado; tu acceso desde otro equipo no se afecta.';
            } else {
                form.style.display = 'block';
                box.style.display = 'none';
            }
        }

        function updateLockoutCountdown() {
            var r = getAdminLockout();
            if (!r.locked) {
                clearAdminAttempts();
                applyAdminLockoutUI(false);
                return;
            }
            applyAdminLockoutUI(true, r.remainingMs);
            if (r.remainingMs > 0) setTimeout(updateLockoutCountdown, 10000); // actualizar cada 10 s
        }
        
        // üîí INICIALIZAR USUARIO ADMIN: Asegurar que el usuario admin existe
        function initializeAdminUser() {
            // Buscar si el usuario admin ya existe
            let adminExists = false;
            let adminUserId = null;
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('nutriplant_user_') && !key.includes('_email_') && !key.includes('_project_')) {
                    try {
                        const value = localStorage.getItem(key);
                        if (value && value.startsWith('{')) {
                            const user = JSON.parse(value);
                            if (user && user.email === ADMIN_EMAIL) {
                                adminExists = true;
                                adminUserId = key.replace('nutriplant_user_', '');
                                // Asegurar que tiene los datos correctos
                                user.isAdmin = true;
                                user.subscription_status = 'active';
                                user.subscription_amount = 0;
                                if (!user.password) {
                                    user.password = ADMIN_PASSWORD;
                                }
                                localStorage.setItem(key, JSON.stringify(user));
                                break;
                            }
                        }
                    } catch (e) {
                        continue;
                    }
                }
            }
            
            // Si no existe, crear el usuario admin
            if (!adminExists) {
                const adminId = 'admin_' + Date.now();
                const adminUser = {
                    id: adminId,
                    name: 'Administrador',
                    email: ADMIN_EMAIL,
                    password: ADMIN_PASSWORD,
                    phone: '',
                    location: {},
                    profession: 'Administrador del Sistema',
                    crops: [],
                    subscription_status: 'active',
                    subscription_amount: 0,
                    isAdmin: true,
                    projects: [],
                    created_at: new Date().toISOString()
                };
                
                localStorage.setItem(`nutriplant_user_${adminId}`, JSON.stringify(adminUser));
                localStorage.setItem(`nutriplant_user_email_${ADMIN_EMAIL}`, adminId);
                console.log('‚úÖ Usuario administrador creado autom√°ticamente');
            }
        }

        // üßπ Sanitizador local: consolida usuarios duplicados por email y reasigna proyectos al user_id can√≥nico
        // Fuente de verdad final = Supabase; esto solo limpia inconsistencias locales hist√≥ricas.
        function sanitizeLocalCacheConsistency(showAlert) {
            const UUID_RE = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
            const stats = {
                usersMerged: 0,
                userKeysRemoved: 0,
                projectsRelinked: 0,
                emailRefsFixed: 0
            };

            const userEntries = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (!key || !key.startsWith('nutriplant_user_') || key.includes('_email_') || key.includes('_project_')) continue;
                try {
                    const raw = localStorage.getItem(key);
                    if (!raw || !raw.startsWith('{')) continue;
                    const user = JSON.parse(raw);
                    if (!user || typeof user !== 'object') continue;
                    const id = key.replace('nutriplant_user_', '');
                    const email = (user.email || '').toLowerCase();
                    if (!email) continue;
                    if (!Array.isArray(user.projects)) user.projects = [];
                    userEntries.push({ key, id, email, user });
                } catch (e) {
                    continue;
                }
            }

            const byEmail = new Map();
            userEntries.forEach((entry) => {
                if (!byEmail.has(entry.email)) byEmail.set(entry.email, []);
                byEmail.get(entry.email).push(entry);
            });

            const aliasToCanonical = new Map();
            const canonicalByEmail = new Map();
            const scoreUser = (entry) => {
                const hasUuid = UUID_RE.test(entry.id) ? 100 : 0;
                const projects = Array.isArray(entry.user.projects) ? entry.user.projects.length : 0;
                const profile = (entry.user.phone ? 1 : 0) + (entry.user.profession ? 1 : 0) + (entry.user.name ? 1 : 0);
                const adminBonus = (entry.user.isAdmin || entry.email === ADMIN_EMAIL) ? 10 : 0;
                return hasUuid + projects + profile + adminBonus;
            };

            byEmail.forEach((list, email) => {
                list.sort((a, b) => scoreUser(b) - scoreUser(a));
                const canonical = list[0];
                canonicalByEmail.set(email, canonical);
                list.forEach((entry, idx) => {
                    aliasToCanonical.set(entry.id, canonical.id);
                    if (idx > 0) stats.usersMerged++;
                });
            });

            // Fusionar proyectos de aliases al usuario can√≥nico, fijar referencia email->id y eliminar claves duplicadas
            byEmail.forEach((list, email) => {
                const canonical = canonicalByEmail.get(email);
                if (!canonical) return;
                const mergedProjects = new Set(Array.isArray(canonical.user.projects) ? canonical.user.projects : []);

                list.forEach((entry) => {
                    if (Array.isArray(entry.user.projects)) {
                        entry.user.projects.forEach((pid) => mergedProjects.add(pid));
                    }
                });

                canonical.user.projects = Array.from(mergedProjects);
                canonical.user.id = canonical.id;
                canonical.user.userId = canonical.id;
                canonical.user.email = email;
                localStorage.setItem(canonical.key, JSON.stringify(canonical.user));

                // Referencia por email siempre al can√≥nico
                const emailKey = `nutriplant_user_email_${email}`;
                const existingRef = localStorage.getItem(emailKey);
                if (existingRef !== canonical.id) {
                    localStorage.setItem(emailKey, canonical.id);
                    stats.emailRefsFixed++;
                }

                // Eliminar aliases f√≠sicos (excepto can√≥nico)
                list.forEach((entry) => {
                    if (entry.key === canonical.key) return;
                    try {
                        localStorage.removeItem(entry.key);
                        stats.userKeysRemoved++;
                    } catch (e) {}
                });
            });

            // Re-enlazar proyectos al user_id can√≥nico
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (!key || (!key.startsWith('nutriplant_project_') && !key.startsWith('nutriplant-project-'))) continue;
                try {
                    const raw = localStorage.getItem(key);
                    if (!raw || !raw.startsWith('{')) continue;
                    const project = JSON.parse(raw);
                    if (!project || typeof project !== 'object') continue;

                    const pid = project.id || key.replace(/^nutriplant[-_]project[-_]/, '');
                    const oldUserId = project.user_id || project.userId || '';
                    const emailLc = (project.user_email || project.userEmail || '').toLowerCase();
                    let canonicalId = oldUserId ? (aliasToCanonical.get(oldUserId) || oldUserId) : '';

                    if (!canonicalId && emailLc && canonicalByEmail.has(emailLc)) {
                        canonicalId = canonicalByEmail.get(emailLc).id;
                    }

                    if (!canonicalId) continue;

                    const canonicalUser = emailLc && canonicalByEmail.has(emailLc)
                        ? canonicalByEmail.get(emailLc).user
                        : null;

                    const prevId = project.user_id || project.userId || '';
                    project.user_id = canonicalId;
                    project.userId = canonicalId;
                    if (canonicalUser && canonicalUser.email) {
                        project.user_email = canonicalUser.email;
                        project.userEmail = canonicalUser.email;
                    }
                    if (canonicalUser && (canonicalUser.name || canonicalUser.email)) {
                        project.user_name = canonicalUser.name || canonicalUser.email;
                        project.userName = project.user_name;
                    }

                    const normalizedKey = `nutriplant_project_${pid}`;
                    localStorage.setItem(normalizedKey, JSON.stringify(project));
                    if (key !== normalizedKey) localStorage.removeItem(key);
                    if (prevId !== canonicalId) stats.projectsRelinked++;
                } catch (e) {
                    continue;
                }
            }

            if (showAlert) {
                alert(
                    'üßπ Limpieza local completada.\n\n' +
                    `Usuarios consolidados: ${stats.usersMerged}\n` +
                    `Claves de usuario eliminadas: ${stats.userKeysRemoved}\n` +
                    `Proyectos re-enlazados: ${stats.projectsRelinked}\n` +
                    `Referencias email->id corregidas: ${stats.emailRefsFixed}`
                );
            }

            return stats;
        }
        window.sanitizeLocalCacheConsistency = sanitizeLocalCacheConsistency;
        
        // Inicializar usuario admin al cargar la p√°gina
        initializeAdminUser();
        // Limpieza autom√°tica silenciosa para evitar alternancias por duplicados hist√≥ricos locales
        try { sanitizeLocalCacheConsistency(false); } catch (e) { console.warn('sanitizeLocalCacheConsistency:', e); }
        
        // üîí FUNCI√ìN SEGURA: Verificar credenciales desde localStorage (m√°s seguro que hardcodear)
        function verifyAdminCredentials(email, password) {
            // Buscar usuario admin en localStorage
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('nutriplant_user_') && !key.includes('_email_') && !key.includes('_project_')) {
                    try {
                        const value = localStorage.getItem(key);
                        if (value && value.startsWith('{')) {
                            const user = JSON.parse(value);
                            // Verificar que sea el usuario admin
                            if (user && user.email === ADMIN_EMAIL && (user.isAdmin === true || email === ADMIN_EMAIL)) {
                                // Verificar contrase√±a
                                if (user.password === password) {
                                    return true;
                                }
                            }
                        }
                    } catch (e) {
                        continue;
                    }
                }
            }
            return false;
        }
        
        // üîí VALIDACI√ìN DE SESI√ìN: Verificar que la sesi√≥n es v√°lida
        function validateAdminSession() {
            const isLoggedIn = localStorage.getItem('admin_logged_in') === 'true';
            const adminUsername = localStorage.getItem('admin_username');
            
            if (!isLoggedIn || !adminUsername) {
                return false;
            }
            
            // Verificar que el usuario admin existe y es v√°lido
            if (adminUsername !== ADMIN_EMAIL) {
                return false;
            }
            
            // Verificar que el usuario admin existe en localStorage
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('nutriplant_user_') && !key.includes('_email_') && !key.includes('_project_')) {
                    try {
                        const value = localStorage.getItem(key);
                        if (value && value.startsWith('{')) {
                            const user = JSON.parse(value);
                            if (user && user.email === ADMIN_EMAIL && (user.isAdmin === true)) {
                                return true; // Sesi√≥n v√°lida
                            }
                        }
                    } catch (e) {
                        continue;
                    }
                }
            }
            
            return false; // Usuario admin no encontrado
        }
        
        // Verificar si ya est√° logueado (con validaci√≥n de sesi√≥n)
        if (validateAdminSession()) {
            showDashboard();
        } else {
            // Si la sesi√≥n no es v√°lida, limpiar
            localStorage.removeItem('admin_logged_in');
            localStorage.removeItem('admin_username');
            localStorage.removeItem('admin_session_timestamp');
            // Mostrar u ocultar formulario seg√∫n bloqueo por intentos (solo este dispositivo)
            var lockout = getAdminLockout();
            applyAdminLockoutUI(lockout.locked, lockout.remainingMs);
            if (lockout.locked) setTimeout(updateLockoutCountdown, 10000);
        }
        
        // Manejar login
        document.getElementById('adminLoginForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            var lockout = getAdminLockout();
            if (lockout.locked) {
                showErrorMessage('‚è±Ô∏è Este dispositivo est√° bloqueado temporalmente. Espera ' + Math.ceil(lockout.remainingMs / 60000) + ' minuto(s).');
                return;
            }
            
            const username = document.getElementById('username').value.trim().toLowerCase();
            const password = document.getElementById('password').value;
            
            // üîí VALIDACI√ìN: Solo permitir email de admin
            if (username !== ADMIN_EMAIL) {
                showErrorMessage('‚ùå Acceso denegado. Solo el administrador puede acceder a este panel.');
                return;
            }
            
            // üîí VERIFICAR CREDENCIALES (localStorage o contrase√±a por defecto)
            const credentialsOk = verifyAdminCredentials(username, password) || (password === ADMIN_PASSWORD);
            if (credentialsOk) {
                clearAdminAttempts();
                localStorage.setItem('admin_logged_in', 'true');
                localStorage.setItem('admin_username', username);
                localStorage.setItem('admin_session_timestamp', Date.now().toString());
                
                // üü¢ Iniciar sesi√≥n en Supabase para cargar datos de la nube
                const supabaseAuth = window.nutriplantSupabaseAuth;
                if (supabaseAuth && supabaseAuth.isAvailable && supabaseAuth.isAvailable()) {
                    try {
                        await supabaseAuth.signIn(username, password);
                    } catch (err) { console.warn('Admin Supabase sign-in:', err); }
                }
                
                showSuccessMessage('‚úÖ Acceso autorizado');
                setTimeout(showDashboard, 1000);
            } else {
                var attempts = parseInt(localStorage.getItem(ADMIN_ATTEMPTS_KEY) || '0', 10) + 1;
                localStorage.setItem(ADMIN_ATTEMPTS_KEY, String(attempts));
                if (attempts >= ADMIN_MAX_ATTEMPTS) {
                    var until = Date.now() + ADMIN_LOCKOUT_MINUTES * 60 * 1000;
                    localStorage.setItem(ADMIN_LOCKOUT_UNTIL_KEY, String(until));
                    applyAdminLockoutUI(true, until - Date.now());
                    setTimeout(updateLockoutCountdown, 10000);
                    showErrorMessage('‚ùå L√≠mite de intentos alcanzado. Este dispositivo queda bloqueado ' + ADMIN_LOCKOUT_MINUTES + ' minutos. Tu acceso desde otro equipo no se afecta.');
                } else {
                    var left = ADMIN_MAX_ATTEMPTS - attempts;
                    showErrorMessage('‚ùå Usuario o contrase√±a incorrectos. Te quedan ' + left + ' intento(s) en este dispositivo.');
                }
                document.getElementById('password').value = '';
            }
        });
        
        function showDashboard() {
            // üîí VALIDAR SESI√ìN antes de mostrar dashboard
            if (!validateAdminSession()) {
                showErrorMessage('‚ùå Sesi√≥n inv√°lida. Por favor, inicia sesi√≥n nuevamente.');
                document.getElementById('loginForm').style.display = 'block';
                document.getElementById('adminDashboard').style.display = 'none';
                localStorage.removeItem('admin_logged_in');
                localStorage.removeItem('admin_username');
                localStorage.removeItem('admin_session_timestamp');
                return;
            }
            
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'block';
            // üü¢ Si la nube est√° activa, cargar datos de ah√≠ primero; luego pintar estad√≠sticas
            if (typeof window.nutriplantAdminLoadFromCloud === 'function') {
                window.nutriplantAdminLoadFromCloud().then(function() { loadAdminStats(); }).catch(function() { loadAdminStats(); });
            } else {
                loadAdminStats();
            }
        }
        
        async function refrescarDesdeNube() {
            if (typeof window.nutriplantAdminLoadFromCloud !== 'function') {
                alert('Supabase no est√° configurado.');
                return;
            }
            try {
                var loaded = await window.nutriplantAdminLoadFromCloud();
                loadAdminStats();
                if (closeDataViewer) closeDataViewer();
                if (loaded) {
                    showSuccessMessage('‚úÖ Datos actualizados desde la nube');
                } else {
                    showErrorMessage('No hay sesi√≥n de admin en Supabase. Abre la app (login), inicia sesi√≥n con admin@nutriplantpro.com, vuelve aqu√≠ y pulsa de nuevo.');
                }
            } catch (e) {
                console.warn('Refrescar nube:', e);
                showErrorMessage('No se pudo conectar a Supabase. Aseg√∫rate de haber iniciado sesi√≥n con admin@nutriplantpro.com.');
            }
        }
        
        function logout() {
            // üîí LIMPIAR TODA LA INFORMACI√ìN DE SESI√ìN
            localStorage.removeItem('admin_logged_in');
            localStorage.removeItem('admin_username');
            localStorage.removeItem('admin_session_timestamp');
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('adminDashboard').style.display = 'none';
            document.getElementById('adminLoginForm').reset();
            var lockout = getAdminLockout();
            applyAdminLockoutUI(lockout.locked, lockout.remainingMs);
            if (lockout.locked) setTimeout(updateLockoutCountdown, 10000);
        }
        
        // üîí PROTECCI√ìN: Validar sesi√≥n peri√≥dicamente (cada 5 minutos)
        setInterval(function() {
            if (document.getElementById('adminDashboard').style.display !== 'none') {
                if (!validateAdminSession()) {
                    alert('üîí Tu sesi√≥n ha expirado o es inv√°lida. Por favor, inicia sesi√≥n nuevamente.');
                    logout();
                }
            }
        }, 5 * 60 * 1000); // Cada 5 minutos
        
        function showErrorMessage(message) {
            const errorDiv = document.getElementById('errorMessage');
            const successDiv = document.getElementById('successMessage');
            const dashError = document.getElementById('dashboardErrorMessage');
            const dashSuccess = document.getElementById('dashboardSuccessMessage');
            if (errorDiv) { errorDiv.textContent = message; errorDiv.style.display = 'block'; }
            if (successDiv) successDiv.style.display = 'none';
            if (dashError) { dashError.textContent = message; dashError.style.display = 'block'; }
            if (dashSuccess) dashSuccess.style.display = 'none';
            setTimeout(function() { if (errorDiv) errorDiv.style.display = 'none'; if (dashError) dashError.style.display = 'none'; }, 5000);
        }
        
        function showSuccessMessage(message) {
            const errorDiv = document.getElementById('errorMessage');
            const successDiv = document.getElementById('successMessage');
            const dashError = document.getElementById('dashboardErrorMessage');
            const dashSuccess = document.getElementById('dashboardSuccessMessage');
            if (errorDiv) errorDiv.style.display = 'none';
            if (successDiv) { successDiv.textContent = message; successDiv.style.display = 'block'; }
            if (dashError) dashError.style.display = 'none';
            if (dashSuccess) { dashSuccess.textContent = message; dashSuccess.style.display = 'block'; }
            setTimeout(function() { if (successDiv) successDiv.style.display = 'none'; if (dashSuccess) dashSuccess.style.display = 'none'; }, 5000);
        }
        
        // üìä CARGAR ESTAD√çSTICAS DEL ADMINISTRADOR
        // üöÄ OPTIMIZADO: Una sola llamada a getAllUsers() para todas las estad√≠sticas
        function loadAdminStats() {
            // üîç Obtener usuarios UNA SOLA VEZ
            const users = getAllUsers();
            
            // üìä Calcular todas las estad√≠sticas usando los mismos datos
            const chatMetrics = getChatMetrics();
            const stats = {
                totalUsers: users.length,
                activeSubscriptions: users.filter(u => u.subscription_status === 'active').length,
                totalProjects: getTotalProjects(),
                totalChats: chatMetrics.totalMessages,
                totalInteractions: chatMetrics.totalInteractions,
                estimatedCostChat: chatMetrics.estimatedCostUSD,
                activeUsers: getActiveUsers(),
                pendingSubscriptions: users.filter(u => u.subscription_status === 'pending').length
            };
            
            // Actualizar UI
            document.getElementById('totalUsers').textContent = stats.totalUsers;
            document.getElementById('activeSubscriptions').textContent = stats.activeSubscriptions;
            document.getElementById('totalProjects').textContent = stats.totalProjects;
            document.getElementById('totalChats').textContent = stats.totalChats;
            document.getElementById('totalInteractions').textContent = stats.totalInteractions;
            document.getElementById('estimatedCostChat').textContent = stats.estimatedCostChat.toFixed(4);
            document.getElementById('estimatedCostChatMonth').textContent = (chatMetrics.estimatedCostUSDThisMonth != null ? chatMetrics.estimatedCostUSDThisMonth.toFixed(4) : '0.0000');
            document.getElementById('activeUsers').textContent = stats.activeUsers;
            document.getElementById('pendingSubscriptions').textContent = stats.pendingSubscriptions;
            // Si el backend de chat est√° disponible, actualizar con datos reales (USD/tokens por backend)
            try {
                var base = (window.NUTRIPLANT_CHAT_USAGE_API_BASE != null) ? window.NUTRIPLANT_CHAT_USAGE_API_BASE : (window.location && window.location.origin ? window.location.origin : '');
                var isLocalNoApi = (base === '' || (base && (base.indexOf('localhost') !== -1 || base.indexOf('127.0.0.1') !== -1)));
                if (base && typeof fetch === 'function' && !isLocalNoApi) {
                    fetch(base + '/api/chat-usage').then(function(r) { return r.ok ? r.json() : null; }).then(function(data) {
                        if (!data || !data.users) return;
                        var monthKey = new Date().getFullYear() + '-' + String(new Date().getMonth() + 1).padStart(2, '0');
                        var totalUsd = 0, monthUsd = 0, totalReqs = 0, monthReqs = 0;
                        Object.keys(data.users).forEach(function(uid) {
                            var u = data.users[uid];
                            if (!u || !u.months) return;
                            Object.keys(u.months).forEach(function(m) {
                                var bucket = u.months[m];
                                totalUsd += bucket.cost_usd || 0;
                                totalReqs += bucket.requests || 0;
                                if (m === monthKey) { monthUsd += bucket.cost_usd || 0; monthReqs += bucket.requests || 0; }
                            });
                        });
                        var elCost = document.getElementById('estimatedCostChat');
                        var elMonth = document.getElementById('estimatedCostChatMonth');
                        var elInt = document.getElementById('totalInteractions');
                        if (elCost) elCost.textContent = totalUsd.toFixed(4);
                        if (elMonth) elMonth.textContent = monthUsd.toFixed(4);
                        if (elInt) elInt.textContent = totalReqs;
                    }).catch(function() {});
                }
            } catch (e) {}
        }
        
        // üîÑ FUNCIONES LEGACY: Mantenidas para compatibilidad pero ya no se usan en loadAdminStats
        function getActiveSubscriptions(users) {
            if (!users || users.length === 0) {
                users = getAllUsers();
            }
            return users.filter(u => u.subscription_status === 'active').length;
        }
        
        function getPendingSubscriptions(users) {
            if (!users || users.length === 0) {
                users = getAllUsers();
            }
            return users.filter(u => u.subscription_status === 'pending').length;
        }
        
        // üîç FUNCIONES DE AN√ÅLISIS DE DATOS
        function getTotalUsers() {
            // Contar usuarios √∫nicos v√°lidos en localStorage (usando la misma l√≥gica que getAllUsers)
            let userCount = 0;
            const processedEmails = new Set();
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                
                // Buscar usuarios completos (nutriplant_user_USERID) - excluir referencias
                if (key && key.startsWith('nutriplant_user_') && !key.includes('_email_') && !key.includes('_project_')) {
                    try {
                        const value = localStorage.getItem(key);
                        // Verificar que el valor sea JSON v√°lido
                        if (!value || (!value.startsWith('{') && !value.startsWith('['))) {
                            continue; // No es JSON v√°lido, saltar
                        }
                        
                        const user = JSON.parse(value);
                        
                        // Verificar que sea un objeto de usuario completo con email
                        if (user && typeof user === 'object' && user.email) {
                    userCount++;
                            processedEmails.add(user.email);
                }
                    } catch (e) {
                        // Ignorar errores de parseo
                        continue;
                    }
                }
            }
            
            // Contar referencias hu√©rfanas (emails sin usuario completo)
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('nutriplant_user_email_')) {
                    const email = key.replace('nutriplant_user_email_', '');
                    if (!processedEmails.has(email)) {
                        try {
                            const userIdRef = localStorage.getItem(key);
                            if (userIdRef && !userIdRef.startsWith('{')) {
                                // Es una referencia hu√©rfana v√°lida
                                userCount++;
                            }
                        } catch (e) {
                            // Ignorar errores
                            continue;
                        }
                    }
                }
            }
            
            return userCount;
        }
        
        function getTotalProjects() {
            // Contar proyectos √∫nicos en localStorage (usando la misma l√≥gica de deduplicaci√≥n que getAllProjects)
            const processedIds = new Set(); // üîí Set para rastrear IDs ya procesados y evitar duplicados
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                // Buscar tanto formato nuevo (nutriplant_project_) como legacy (nutriplant-project-)
                const isProjectKey = key && (
                    key.startsWith('nutriplant_project_') || 
                    key.startsWith('nutriplant-project-')
                );
                
                if (isProjectKey) {
                    try {
                        const value = localStorage.getItem(key);
                        // Verificar que el valor sea JSON v√°lido
                        if (!value || (!value.startsWith('{') && !value.startsWith('['))) {
                            continue; // No es JSON v√°lido, saltar
                        }
                        const project = JSON.parse(value);
                        if (project && typeof project === 'object') {
                            // Extraer el ID de la clave (soporta ambos formatos)
                            const projectIdFromKey = key.replace(/^nutriplant[-_]project[-_]/, '');
                            // Usar el ID del objeto si existe, sino usar el de la clave
                            let projectId = project.id || projectIdFromKey;
                            
                            // üîí DEDUPLICACI√ìN: Verificar si ya procesamos este ID
                            if (!processedIds.has(projectId)) {
                                processedIds.add(projectId);
                            }
                        }
                    } catch (e) {
                        // Ignorar errores de parseo
                        continue;
                    }
                }
            }
            
            return processedIds.size; // Retornar el n√∫mero de IDs √∫nicos
        }
        
        function getTotalChats() {
            const m = getChatMetrics();
            return m.totalMessages;
        }
        
        /** M√©tricas de chat para seguimiento y gastos: mensajes, interacciones IA (llamadas API), costo estimado USD */
        function getChatMetrics() {
            let totalMessages = 0;
            let totalInteractions = 0; // cada mensaje "user" = 1 llamada a la API
            const COST_PER_INTERACTION_USD = 0.001;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('nutriplant_project_')) {
                    try {
                        const value = localStorage.getItem(key);
                        if (!value || (!value.startsWith('{') && !value.startsWith('['))) continue;
                        const project = JSON.parse(value);
                        if (!project || !Array.isArray(project.chat_history)) continue;
                        totalMessages += project.chat_history.length;
                        project.chat_history.forEach(function (msg) {
                            if (msg && (msg.sender === 'user' || msg.type === 'user')) totalInteractions++;
                        });
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Error parseando proyecto:', key, e.message);
                    }
                }
            }
            // Incluir chat sin proyecto (guardado en cada usuario)
            for (var u = 0; u < localStorage.length; u++) {
                var uk = localStorage.key(u);
                if (!uk || !uk.startsWith('nutriplant_user_') || uk.indexOf('_email_') !== -1 || uk.indexOf('_project_') !== -1) continue;
                try {
                    var uval = localStorage.getItem(uk);
                    if (!uval || (!uval.startsWith('{') && !uval.startsWith('['))) continue;
                    var uobj = JSON.parse(uval);
                    if (!uobj || !Array.isArray(uobj.chat_history_sin_proyecto)) continue;
                    uobj.chat_history_sin_proyecto.forEach(function (msg) {
                        totalMessages++;
                        if (msg && (msg.sender === 'user' || msg.type === 'user')) totalInteractions++;
                    });
                } catch (e) { continue; }
            }
            const estimatedCostUSD = totalInteractions * COST_PER_INTERACTION_USD;
            var totalMessagesMonth = 0, totalInteractionsMonth = 0;
            var now = new Date();
            var currentYear = now.getFullYear(), currentMonth = now.getMonth();
            for (var j = 0; j < localStorage.length; j++) {
                var k = localStorage.key(j);
                if (!k || !k.startsWith('nutriplant_project_')) continue;
                try {
                    var val = localStorage.getItem(k);
                    if (!val || (!val.startsWith('{') && !val.startsWith('['))) continue;
                    var proj = JSON.parse(val);
                    if (!proj || !Array.isArray(proj.chat_history)) continue;
                    proj.chat_history.forEach(function (msg) {
                        if (!msg) return;
                        var ts = msg.timestamp;
                        if (ts) {
                            var d = new Date(ts);
                            if (d.getFullYear() === currentYear && d.getMonth() === currentMonth) {
                                totalMessagesMonth++;
                                if (msg.sender === 'user' || msg.type === 'user') totalInteractionsMonth++;
                            }
                        }
                    });
                } catch (e) { continue; }
            }
            for (var u2 = 0; u2 < localStorage.length; u2++) {
                var uk2 = localStorage.key(u2);
                if (!uk2 || !uk2.startsWith('nutriplant_user_') || uk2.indexOf('_email_') !== -1 || uk2.indexOf('_project_') !== -1) continue;
                try {
                    var uval2 = localStorage.getItem(uk2);
                    if (!uval2 || !uval2.startsWith('{')) continue;
                    var uobj2 = JSON.parse(uval2);
                    if (!uobj2 || !Array.isArray(uobj2.chat_history_sin_proyecto)) continue;
                    uobj2.chat_history_sin_proyecto.forEach(function (msg) {
                        if (!msg) return;
                        var ts = msg.timestamp;
                        if (ts) {
                            var d = new Date(ts);
                            if (d.getFullYear() === currentYear && d.getMonth() === currentMonth) {
                                totalMessagesMonth++;
                                if (msg.sender === 'user' || msg.type === 'user') totalInteractionsMonth++;
                            }
                        }
                    });
                } catch (e) { continue; }
            }
            var estimatedCostUSDMonth = totalInteractionsMonth * COST_PER_INTERACTION_USD;
            return {
                totalMessages: totalMessages,
                totalInteractions: totalInteractions,
                estimatedCostUSD: estimatedCostUSD,
                totalMessagesThisMonth: totalMessagesMonth,
                totalInteractionsThisMonth: totalInteractionsMonth,
                estimatedCostUSDThisMonth: estimatedCostUSDMonth
            };
        }
        
        function getActiveUsers() {
            // Contar usuarios activos (con proyectos creados en los √∫ltimos 30 d√≠as)
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            let activeCount = 0;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('nutriplant_user_') && !key.includes('_email_') && !key.includes('_project_')) {
                    try {
                        const value = localStorage.getItem(key);
                        // Verificar que el valor sea JSON v√°lido
                        if (!value || (!value.startsWith('{') && !value.startsWith('['))) {
                            continue; // No es JSON v√°lido, saltar
                        }
                        const user = JSON.parse(value);
                        if (user && typeof user === 'object' && user.last_login) {
                        const lastLogin = new Date(user.last_login);
                        if (lastLogin > thirtyDaysAgo) {
                            activeCount++;
                        }
                        }
                    } catch (e) {
                        // Ignorar errores de parseo para valores no JSON
                        console.warn('‚ö†Ô∏è Error parseando usuario:', key, e.message);
                        continue;
                    }
                }
            }
            return activeCount;
        }
        
        // üìã FUNCIONES DE GESTI√ìN
        async function showAllUsers() {
            // Cargar desde nube primero para tener ubicaci√≥n y datos actualizados de Supabase (y poder hacer merge)
            if (typeof window.nutriplantAdminLoadFromCloud === 'function' && (!window._adminCloudCache || !window._adminCloudCache.users)) {
                try { await window.nutriplantAdminLoadFromCloud(); } catch (e) { console.warn('showAllUsers: load from cloud', e); }
            }
            const users = getAllUsers();
            showDataViewerWithFilters({
                title: 'üë• Todos los Usuarios',
                data: users,
                columns: [
                    { key: 'name', label: 'Nombre', format: 'text', filterable: true },
                    { key: 'email', label: 'Email', format: 'text', filterable: true },
                    { key: 'password', label: 'Contrase√±a', format: 'password', filterable: true },
                    { key: 'phone', label: 'Tel√©fono', format: 'text', filterable: true },
                    { key: 'location', label: 'Ubicaci√≥n', format: 'location', filterable: true },
                    { key: 'profession', label: 'Profesi√≥n', format: 'text', filterable: true },
                    { key: 'crops', label: 'Cultivos', format: 'array', filterable: true },
                    { key: 'projects_count', label: 'Proyectos', format: 'text', filterable: true },
                    { key: 'subscription_status', label: 'Suscripci√≥n', format: 'status', filterable: true },
                    { key: 'subscription_amount', label: 'Monto', format: 'currency', filterable: false },
                    { key: 'created_at', label: 'Fecha de Registro', format: 'date', filterable: true },
                    { key: 'last_login', label: '√öltimo Acceso', format: 'date', filterable: true },
                    { key: 'last_payment_date', label: '√öltimo Pago', format: 'date', filterable: true },
                    { key: 'next_payment_date', label: 'Pr√≥ximo Pago', format: 'date', filterable: true }
                ],
                actions: {
                    edit: true,
                    delete: true
                },
                previousView: showAllUsers,
                previousViewParams: []
            });
        }
        
        function showAllProjects() {
            console.log('üìã Mostrando todos los proyectos...');
            const projects = getAllProjects();
            // "Todos los Proyectos" debe mostrar absolutamente todos.
            const visibleProjects = projects;
            
            showDataViewerWithFilters({
                title: 'üìã Todos los Proyectos',
                data: visibleProjects,
                isProject: true,
                previousViewForProject: 'showAllProjects',
                previousViewParamsForProject: [],
                columns: [
                    { key: 'user_name', label: 'Usuario', format: 'text', filterable: true },
                    { key: 'orphan_status', label: 'Estado', format: 'text', filterable: true },
                    { key: 'id', label: 'ID', format: 'text', filterable: true },
                    { key: 'name', label: 'Nombre', format: 'text', filterable: true },
                    { key: 'crop_type', label: 'Cultivo', format: 'text', filterable: true },
                    { key: 'variedad', label: 'Variedad', format: 'text', filterable: true },
                    { key: 'location_coords', label: 'Ubicaci√≥n', format: 'text', filterable: true },
                    { key: 'created_at', label: 'Fecha de Creaci√≥n', format: 'date', filterable: true },
                    { key: 'updated_at', label: '√öltima Actualizaci√≥n', format: 'date', filterable: true },
                    { key: 'active_sections_count', label: 'Secciones Activas', format: 'text', filterable: false }
                ],
                actions: {
                    edit: true,
                    delete: true
                }
            });
        }
        
        async function showAllChats() {
            if (typeof window.nutriplantAdminLoadFromCloud === 'function' && (!window._adminCloudCache || !window._adminCloudCache.users)) {
                try { await window.nutriplantAdminLoadFromCloud(); } catch (e) { console.warn('showAllChats: load from cloud', e); }
            }
            console.log('üí¨ Mostrando todas las conversaciones...');
            const chats = getAllChats();
            const m = getChatMetrics();
            const subtitle = m.totalMessages + ' mensajes ¬∑ ' + m.totalInteractions + ' interacciones IA ¬∑ ~$' + m.estimatedCostUSD.toFixed(4) + ' USD est.';
            const title = 'üí¨ Todas las Conversaciones ‚Äî ' + subtitle + (chats.length === 0 ? ' (A√∫n no hay mensajes; cuando los usuarios usen el chat aparecer√°n aqu√≠)' : '');
            showDataViewerWithFilters({
                title: title,
                data: chats,
                columns: [
                    { key: 'project_id', label: 'ID Proyecto', format: 'text', filterable: true },
                    { key: 'project_name', label: 'Nombre Proyecto', format: 'text', filterable: true },
                    { key: 'user_name', label: 'Usuario', format: 'text', filterable: true },
                    { key: 'message_type', label: 'Tipo (user/ai)', format: 'text', filterable: true },
                    { key: 'content', label: 'Contenido', format: 'text', filterable: true },
                    { key: 'timestamp', label: 'Fecha/Hora', format: 'date', filterable: true },
                    { key: 'active_section', label: 'Secci√≥n Activa', format: 'text', filterable: true }
                ],
                actions: {
                    edit: false,
                    delete: false
                }
            });
        }
        
        /** Resumen de chat por proyecto: mensajes e interacciones por proyecto */
        function getChatSummaryByProject() {
            const users = getAllUsers();
            const summary = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (!key || !key.startsWith('nutriplant_project_')) continue;
                try {
                    const value = localStorage.getItem(key);
                    if (!value || (!value.startsWith('{') && !value.startsWith('['))) continue;
                    const project = JSON.parse(value);
                    if (!project || !Array.isArray(project.chat_history)) continue;
                    const totalMessages = project.chat_history.length;
                    let totalInteractions = 0;
                    project.chat_history.forEach(function (msg) {
                        if (msg && (msg.sender === 'user' || msg.type === 'user')) totalInteractions++;
                    });
                    const userId = project.user_id || project.userId;
                    let user_name = project.user_name || project.userName || '‚Äî';
                    let user_email = project.user_email || project.userEmail || '‚Äî';
                    if (userId) {
                        const u = users.find(function (x) { return (x.id === userId) || (x.userId === userId); });
                        if (u) { user_name = u.name || user_name; user_email = u.email || user_email; }
                    }
                    summary.push({
                        project_id: project.id,
                        project_name: project.name || project.title || 'Sin nombre',
                        user_name: user_name,
                        user_email: user_email,
                        total_messages: totalMessages,
                        total_interactions: totalInteractions,
                        estimated_cost_usd: (totalInteractions * 0.001).toFixed(4)
                    });
                } catch (e) { continue; }
            }
            return summary.sort(function (a, b) { return b.total_messages - a.total_messages; });
        }
        
        /** Resumen de chat por usuario: mensajes e interacciones agregados por usuario */
        function getChatSummaryByUser() {
            const users = getAllUsers();
            const COST = 0.001;
            const byUser = {};
            users.forEach(function (u) {
                byUser[u.id || u.userId] = {
                    user_id: u.id || u.userId,
                    user_name: u.name || 'Sin nombre',
                    user_email: u.email || '‚Äî',
                    total_messages: 0,
                    total_interactions: 0,
                    projects_count: 0
                };
            });
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (!key || !key.startsWith('nutriplant_project_')) continue;
                try {
                    const value = localStorage.getItem(key);
                    if (!value || (!value.startsWith('{') && !value.startsWith('['))) continue;
                    const project = JSON.parse(value);
                    if (!project || !Array.isArray(project.chat_history)) continue;
                    const userId = project.user_id || project.userId;
                    if (!userId) continue;
                    if (!byUser[userId]) {
                        byUser[userId] = { user_id: userId, user_name: '‚Äî', user_email: '‚Äî', total_messages: 0, total_interactions: 0, projects_count: 0 };
                        const u = users.find(function (x) { return (x.id === userId) || (x.userId === userId); });
                        if (u) { byUser[userId].user_name = u.name || '‚Äî'; byUser[userId].user_email = u.email || '‚Äî'; }
                    }
                    byUser[userId].total_messages += project.chat_history.length;
                    byUser[userId].projects_count += 1;
                    project.chat_history.forEach(function (msg) {
                        if (msg && (msg.sender === 'user' || msg.type === 'user')) byUser[userId].total_interactions++;
                    });
                } catch (e) { continue; }
            }
            // Incluir chat sin proyecto por usuario
            for (var ui = 0; ui < localStorage.length; ui++) {
                var ukey = localStorage.key(ui);
                if (!ukey || !ukey.startsWith('nutriplant_user_') || ukey.indexOf('_email_') !== -1 || ukey.indexOf('_project_') !== -1) continue;
                var uid = ukey.replace(/^nutriplant_user_/, '');
                if (!uid) continue;
                try {
                    var uraw = localStorage.getItem(ukey);
                    if (!uraw || !uraw.startsWith('{')) continue;
                    var udata = JSON.parse(uraw);
                    if (!udata || !Array.isArray(udata.chat_history_sin_proyecto)) continue;
                    if (!byUser[uid]) {
                        byUser[uid] = { user_id: uid, user_name: '‚Äî', user_email: '‚Äî', total_messages: 0, total_interactions: 0, projects_count: 0 };
                        var uu = users.find(function (x) { return (x.id === uid) || (x.userId === uid); });
                        if (uu) { byUser[uid].user_name = uu.name || '‚Äî'; byUser[uid].user_email = uu.email || '‚Äî'; }
                    }
                    byUser[uid].total_messages += udata.chat_history_sin_proyecto.length;
                    udata.chat_history_sin_proyecto.forEach(function (msg) {
                        if (msg && (msg.sender === 'user' || msg.type === 'user')) byUser[uid].total_interactions++;
                    });
                } catch (e) { continue; }
            }
            const list = Object.keys(byUser).map(function (id) {
                const r = byUser[id];
                r.estimated_cost_usd = (r.total_interactions * COST).toFixed(4);
                return r;
            });
            return list.filter(function (r) { return r.total_messages > 0; }).sort(function (a, b) { return b.total_messages - a.total_messages; });
        }
        
        function showChatSummaryByProject() {
            const data = getChatSummaryByProject();
            const m = getChatMetrics();
            const subtitle = m.totalMessages + ' mensajes totales ¬∑ ' + m.totalInteractions + ' interacciones ¬∑ ~$' + m.estimatedCostUSD.toFixed(4) + ' USD';
            showDataViewerWithFilters({
                title: 'üí¨ Resumen de Chat por Proyecto ‚Äî ' + subtitle,
                data: data,
                columns: [
                    { key: 'project_name', label: 'Proyecto', format: 'text', filterable: true },
                    { key: 'project_id', label: 'ID Proyecto', format: 'text', filterable: true },
                    { key: 'user_name', label: 'Usuario', format: 'text', filterable: true },
                    { key: 'user_email', label: 'Email', format: 'text', filterable: true },
                    { key: 'total_messages', label: 'Mensajes', format: 'text', filterable: false },
                    { key: 'total_interactions', label: 'Interacciones IA', format: 'text', filterable: false },
                    { key: 'estimated_cost_usd', label: 'Costo est. (USD)', format: 'text', filterable: false }
                ],
                actions: { edit: false, delete: false }
            });
        }
        
        function showChatSummaryByUser() {
            const data = getChatSummaryByUser();
            const m = getChatMetrics();
            const subtitle = m.totalMessages + ' mensajes totales ¬∑ ' + m.totalInteractions + ' interacciones ¬∑ ~$' + m.estimatedCostUSD.toFixed(4) + ' USD';
            showDataViewerWithFilters({
                title: 'üí¨ Resumen de Chat por Usuario ‚Äî ' + subtitle,
                data: data.length ? data : [{ user_name: '‚Äî', user_email: '‚Äî', total_messages: 0, total_interactions: 0, projects_count: 0, estimated_cost_usd: '0.0000' }],
                columns: [
                    { key: 'user_name', label: 'Usuario', format: 'text', filterable: true },
                    { key: 'user_email', label: 'Email', format: 'text', filterable: true },
                    { key: 'projects_count', label: 'Proyectos con chat', format: 'text', filterable: false },
                    { key: 'total_messages', label: 'Mensajes', format: 'text', filterable: false },
                    { key: 'total_interactions', label: 'Interacciones IA', format: 'text', filterable: false },
                    { key: 'estimated_cost_usd', label: 'Costo est. (USD)', format: 'text', filterable: false }
                ],
                actions: { edit: false, delete: false }
            });
        }

        /** Consumo real de Chat IA desde el backend (USD y tokens por usuario, mes actual). */
        function showChatUsageByUser() {
            var base = (window.NUTRIPLANT_CHAT_USAGE_API_BASE != null) ? window.NUTRIPLANT_CHAT_USAGE_API_BASE : (window.location && window.location.origin ? window.location.origin : '');
            if (!base || typeof fetch !== 'function') {
                alert('No se puede conectar al backend. Abre el panel desde la misma URL del servidor (ej. http://localhost:8000/admin/) para ver el consumo.');
                return;
            }
            var isLocal = (base.indexOf('localhost') !== -1 || base.indexOf('127.0.0.1') !== -1);
            fetch(base + '/api/chat-usage').then(function(r) { return r.ok ? r.json() : null; }).then(function(data) {
                if (!data || !data.users) {
                    var msg = isLocal ? ' (En local no hay backend; en producci√≥n con servidor de chat s√≠ aparecer√° el uso.)' : '';
                    showDataViewerWithFilters({ title: 'üí∞ Consumo Chat IA (este mes)' + msg, data: [], columns: [], actions: {} });
                    return;
                }
                var monthKey = new Date().getFullYear() + '-' + String(new Date().getMonth() + 1).padStart(2, '0');
                var users = getAllUsers();
                var byId = {};
                users.forEach(function(u) { byId[u.id || u.userId] = u; });
                var rows = [];
                Object.keys(data.users).forEach(function(uid) {
                    var u = data.users[uid];
                    if (!u || !u.months || !u.months[monthKey]) return;
                    var bucket = u.months[monthKey];
                    var profile = byId[uid];
                    rows.push({
                        user_id: uid,
                        email: profile ? (profile.email || '‚Äî') : '‚Äî',
                        name: profile ? (profile.name || '‚Äî') : '‚Äî',
                        requests: bucket.requests || 0,
                        cached_hits: bucket.cached_hits || 0,
                        prompt_tokens: bucket.prompt_tokens || 0,
                        completion_tokens: bucket.completion_tokens || 0,
                        total_tokens: bucket.total_tokens || 0,
                        cost_usd: (bucket.cost_usd != null ? bucket.cost_usd : 0).toFixed(4)
                    });
                });
                rows.sort(function(a, b) { return parseFloat(b.cost_usd) - parseFloat(a.cost_usd); });
                var title = 'üí∞ Consumo Chat IA por usuario ‚Äî ' + monthKey + (rows.length ? ' (' + rows.length + ' usuarios)' : '');
                showDataViewerWithFilters({
                    title: title,
                    data: rows.length ? rows : [{ user_id: '‚Äî', email: '‚Äî', name: '‚Äî', requests: 0, cached_hits: 0, prompt_tokens: 0, completion_tokens: 0, total_tokens: 0, cost_usd: '0.0000' }],
                    columns: [
                        { key: 'email', label: 'Email', format: 'text', filterable: true },
                        { key: 'name', label: 'Nombre', format: 'text', filterable: true },
                        { key: 'user_id', label: 'ID usuario', format: 'text', filterable: true },
                        { key: 'requests', label: 'Solicitudes', format: 'text', filterable: false },
                        { key: 'cached_hits', label: 'Desde cach√©', format: 'text', filterable: false },
                        { key: 'total_tokens', label: 'Tokens', format: 'text', filterable: false },
                        { key: 'cost_usd', label: 'Costo (USD)', format: 'text', filterable: false }
                    ],
                    actions: { edit: false, delete: false }
                });
            }).catch(function() {
                alert('No se pudo cargar el consumo. ¬øEst√° corriendo el servidor (python3 server.py) en la misma base URL?');
            });
        }
        window.showChatUsageByUser = showChatUsageByUser;

        /** Entradas al panel: semana actual, acum. mes (d√≠a 1 a hoy), acum. a√±o (1 ene a hoy). Por usuario y totales. */
        async function showDashboardVisits() {
            if (!window._adminCloudCache || !window._adminCloudCache.users) {
                try { await window.nutriplantAdminLoadFromCloud(); } catch (e) { console.warn('showDashboardVisits: load cloud', e); }
            }
            var visits = (window._adminCloudCache && Array.isArray(window._adminCloudCache.dashboardVisits)) ? window._adminCloudCache.dashboardVisits : [];
            var users = getAllUsers();
            var byId = {};
            users.forEach(function(u) { byId[u.id || u.userId] = u; });
            var now = new Date();
            var startOfWeek = new Date(now);
            var day = startOfWeek.getDay();
            startOfWeek.setDate(startOfWeek.getDate() - (day === 0 ? 6 : day - 1));
            startOfWeek.setHours(0, 0, 0, 0);
            var startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1, 0, 0, 0, 0);
            var startOfYear = new Date(now.getFullYear(), 0, 1, 0, 0, 0, 0);
            var totalWeek = 0, totalMonth = 0, totalYear = 0;
            var perUser = {};
            visits.forEach(function(v) {
                if (!v || !v.user_id || !v.visited_at) return;
                var d = new Date(v.visited_at);
                var uid = v.user_id;
                if (!perUser[uid]) perUser[uid] = { week: 0, month: 0, year: 0 };
                if (d >= startOfWeek) { perUser[uid].week++; totalWeek++; }
                if (d >= startOfMonth) { perUser[uid].month++; totalMonth++; }
                if (d >= startOfYear) { perUser[uid].year++; totalYear++; }
            });
            var rows = [];
            Object.keys(perUser).forEach(function(uid) {
                var p = perUser[uid];
                var profile = byId[uid];
                rows.push({
                    user_id: uid,
                    user_name: profile ? (profile.name || profile.email || '‚Äî') : '‚Äî',
                    user_email: profile ? (profile.email || '‚Äî') : '‚Äî',
                    week_count: p.week,
                    month_count: p.month,
                    year_count: p.year
                });
            });
            rows.sort(function(a, b) {
                if (b.month_count !== a.month_count) return b.month_count - a.month_count;
                return (a.user_email || '').localeCompare(b.user_email || '');
            });
            var monthLabel = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
            var title = 'üìä Entradas al panel ‚Äî Semana actual: ' + totalWeek + ' | Acum. mes (' + monthLabel + '): ' + totalMonth + ' | Acum. a√±o: ' + totalYear;
            showDataViewerWithFilters({
                title: title,
                data: rows.length ? rows : [{ user_name: '‚Äî', user_email: '‚Äî', week_count: 0, month_count: 0, year_count: 0 }],
                columns: [
                    { key: 'user_name', label: 'Usuario', format: 'text', filterable: true },
                    { key: 'user_email', label: 'Email', format: 'text', filterable: true },
                    { key: 'week_count', label: 'Semana actual', format: 'text', filterable: false },
                    { key: 'month_count', label: 'Acum. mes', format: 'text', filterable: false },
                    { key: 'year_count', label: 'Acum. a√±o', format: 'text', filterable: false }
                ],
                actions: { edit: false, delete: false }
            });
        }
        window.showDashboardVisits = showDashboardVisits;

        function getAllUsers() {
            const users = [];
            const processedEmails = new Set();
            const cloudByEmail = (window._adminCloudCache && Array.isArray(window._adminCloudCache.users))
                ? Object.fromEntries((window._adminCloudCache.users || []).map(u => [u.email?.toLowerCase(), u]))
                : {};
            const ADMIN_EMAIL_LC = 'admin@nutriplantpro.com';
            let pendingAdminFromLocal = null; // Un solo admin (due√±o): preferir Supabase
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                
                // Buscar usuarios completos (nutriplant_user_USERID)
                if (key && key.startsWith('nutriplant_user_') && !key.includes('_email_') && !key.includes('_project_')) {
                    try {
                        const value = localStorage.getItem(key);
                        if (!value || (!value.startsWith('{') && !value.startsWith('['))) {
                            continue; // No es JSON v√°lido
                        }
                        
                        const user = JSON.parse(value);
                        
                        // Verificar que sea un objeto de usuario completo
                        if (user && typeof user === 'object' && user.email) {
                            const userId = key.replace('nutriplant_user_', '');
                            const isAdminUser = user.email === 'admin@nutriplantpro.com' || user.isAdmin === true;
                            
                            // No saltar por email aqu√≠: puede haber 2 claves (UUID + antigua) para el mismo usuario; al final se consolidan y se elige el que tenga m√°s datos (ej. ubicaci√≥n)
                            // if (processedEmails.has(user.email?.toLowerCase())) continue;
                            
                            // üîê Un solo admin (due√±o): no a√±adir aqu√≠; se a√±ade desde Supabase o al final como pending
                            if (user.email?.toLowerCase() === ADMIN_EMAIL_LC) {
                                user.isAdmin = true;
                                user.subscription_status = 'active';
                                user.subscription_amount = 0;
                                user.password = user.password || 'npja1502';
                                localStorage.setItem(key, JSON.stringify(user));
                                let projectsCount = 0;
                                const validProjectIds = [];
                                if (user.projects && Array.isArray(user.projects)) {
                                    user.projects.forEach(projectId => {
                                        const projectKey1 = `nutriplant_project_${projectId}`;
                                        const projectKey2 = `nutriplant-project-${projectId}`;
                                        const projectValue = localStorage.getItem(projectKey1) || localStorage.getItem(projectKey2);
                                        if (projectValue) {
                                            try {
                                                const project = JSON.parse(projectValue);
                                                const projectUserId = project.user_id || project.userId;
                                                if (projectUserId === userId) { projectsCount++; validProjectIds.push(projectId); }
                                            } catch (e) { projectsCount++; validProjectIds.push(projectId); }
                                        }
                                    });
                                    if (validProjectIds.length !== user.projects.length) {
                                        user.projects = validProjectIds;
                                        localStorage.setItem(key, JSON.stringify(user));
                                    }
                                }
                                projectsCount = Math.max(projectsCount, getLocalProjectCountForUser(userId, user.email));
                                pendingAdminFromLocal = {
                                    id: userId,
                                    userId: userId,
                                    name: user.name || 'Administrador',
                                    email: user.email || '',
                                    phone: user.phone || '',
                                    password: user.password || 'npja1502',
                                    location: user.location || {},
                                    profession: user.profession || '',
                                    crops: Array.isArray(user.crops) ? user.crops : [],
                                    subscription_status: 'active',
                                    subscription_amount: 0,
                                    subscription_activated_at: user.subscription_activated_at || null,
                                    _cancelled_at: user._cancelled_at || null,
                                    _expired_at: user._expired_at || null,
                                    _pending_at: user._pending_at || null,
                                    last_payment_date: user.last_payment_date || null,
                                    next_payment_date: user.next_payment_date || null,
                                    paypal_subscription_id: user.paypal_subscription_id || null,
                                    created_at: user.created_at || null,
                                    projects_count: projectsCount,
                                    isAdmin: true
                                };
                                continue;
                            }
                            
                            // üîê CONFIGURACI√ìN ESPECIAL PARA USUARIO ADMINISTRADOR
                            if (isAdminUser) {
                                // Asegurar que el admin siempre tenga los datos correctos
                                user.isAdmin = true;
                                user.subscription_status = 'active';
                                user.subscription_amount = 0; // Sin suscripci√≥n (es el due√±o)
                                user.password = user.password || 'npja1502'; // Contrase√±a por defecto
                                
                                // Guardar actualizaci√≥n del admin
                                localStorage.setItem(key, JSON.stringify(user));
                            }
                            
                            // üìä CONTAR PROYECTOS DEL USUARIO: Contar proyectos que realmente existen Y pertenecen al usuario
                            let projectsCount = 0;
                            const validProjectIds = []; // Array para proyectos v√°lidos
                            if (user.projects && Array.isArray(user.projects)) {
                                user.projects.forEach(projectId => {
                                    // Verificar que el proyecto existe en localStorage
                                    const projectKey1 = `nutriplant_project_${projectId}`;
                                    const projectKey2 = `nutriplant-project-${projectId}`;
                                    
                                    const projectValue = localStorage.getItem(projectKey1) || localStorage.getItem(projectKey2);
                                    if (projectValue) {
                                        try {
                                            const project = JSON.parse(projectValue);
                                            // üîí VALIDACI√ìN CR√çTICA: Verificar que el proyecto realmente pertenece a este usuario
                                            const projectUserId = project.user_id || project.userId;
                                            if (projectUserId === userId) {
                                                projectsCount++;
                                                validProjectIds.push(projectId);
                                            } else {
                                                // ‚ö†Ô∏è Proyecto en el array pero no pertenece a este usuario - removerlo
                                                console.warn(`‚ö†Ô∏è Proyecto "${projectId}" est√° en el array de ${userId} pero pertenece a ${projectUserId}. Ser√° removido.`);
                                            }
                                        } catch (e) {
                                            // Si no se puede parsear, contar igual (compatibilidad)
                                            projectsCount++;
                                            validProjectIds.push(projectId);
                                        }
                                    }
                                });
                                
                                // üîÑ LIMPIEZA: Si hay proyectos inv√°lidos, actualizar el array del usuario
                                if (validProjectIds.length !== user.projects.length) {
                                    user.projects = validProjectIds;
                                    localStorage.setItem(key, JSON.stringify(user));
                                    console.log(`‚úÖ Array de proyectos limpiado para usuario ${userId}: ${validProjectIds.length} proyectos v√°lidos`);
                                }
                            }
                            // Contar tambi√©n por localStorage (por si user.projects est√° desactualizado)
                            projectsCount = Math.max(projectsCount, getLocalProjectCountForUser(userId, user.email));
                            
                            // Obtener datos completos
                            const userData = {
                                id: userId,
                                userId: userId,
                                name: user.name || 'Sin nombre',
                                email: user.email || '',
                                phone: user.phone || '',
                                password: isAdminUser ? (user.password || 'npja1502') : (user.password || ''), // Contrase√±a del admin
                                location: user.location || {}, // Ubicaci√≥n del usuario (registro: ciudad, estado, pa√≠s); no la del proyecto
                                profession: user.profession || '',
                                crops: Array.isArray(user.crops) ? user.crops : [],
                                subscription_status: isAdminUser ? 'active' : (user.subscription_status || 'pending'),
                                subscription_amount: isAdminUser ? 0 : (user.subscription_amount || (window.NUTRIPLANT_CONFIG ? window.NUTRIPLANT_CONFIG.getDefaultSubscriptionAmount() : 49.00)),
                                subscription_activated_at: user.subscription_activated_at || null,
                                _cancelled_at: user._cancelled_at || null,
                                _expired_at: user._expired_at || null,
                                _pending_at: user._pending_at || null,
                                last_payment_date: user.last_payment_date || null,
                                next_payment_date: user.next_payment_date || null,
                                paypal_subscription_id: user.paypal_subscription_id || null,
                                created_at: user.created_at || null,
                                projects_count: projectsCount, // üìä N√∫mero de proyectos del usuario
                                isAdmin: isAdminUser
                            };
                            // üü¢ Sobrescribir con datos de Supabase si existen (admin siempre se mantiene Activa)
                            const cloudUser = cloudByEmail[user.email?.toLowerCase()];
                            const isSupabaseUserId = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(userId);
                            if (cloudUser) {
                                if (!isAdminUser) {
                                    userData.subscription_status = cloudUser.subscription_status || userData.subscription_status;
                                    userData.subscription_amount = cloudUser.subscription_amount ?? userData.subscription_amount;
                                }
                                userData.subscription_activated_at = cloudUser.subscription_activated_at || userData.subscription_activated_at;
                                userData.last_payment_date = cloudUser.last_payment_date || userData.last_payment_date;
                                userData.next_payment_date = cloudUser.next_payment_date || userData.next_payment_date;
                                // Completar campos de perfil desde nube cuando en panel local est√©n vac√≠os.
                                const hasLocalLocation = (
                                    (typeof userData.location === 'string' && userData.location.trim()) ||
                                    (userData.location && typeof userData.location === 'object' &&
                                        (userData.location.city || userData.location.state || userData.location.country || userData.location.postal))
                                );
                                if (!hasLocalLocation && cloudUser.location) userData.location = cloudUser.location;
                                if (!userData.phone && cloudUser.phone) userData.phone = cloudUser.phone;
                                if (!userData.profession && cloudUser.profession) userData.profession = cloudUser.profession;
                                if ((!userData.crops || !userData.crops.length) && Array.isArray(cloudUser.crops) && cloudUser.crops.length) userData.crops = cloudUser.crops;
                                // Para Supabase: usar el mayor entre nube y localStorage (as√≠ no se ocultan proyectos que a√∫n no se han subido)
                                if (isSupabaseUserId) {
                                    var cloudCount = cloudUser.projects_count ?? 0;
                                    var localCount = userData.projects_count ?? 0;
                                    userData.projects_count = Math.max(cloudCount, localCount);
                                }
                                userData.created_at = cloudUser.created_at || userData.created_at;
                                if (cloudUser.last_login) userData.last_login = cloudUser.last_login;
                                // Mostrar contrase√±a desde nube si en panel no hab√≠a
                                if (cloudUser.password || cloudUser.password_plain) userData.password = cloudUser.password || cloudUser.password_plain;
                                // Cat√°logos en la nube (para "Cat√°logos guardados en la nube" en detalle de usuario)
                                if (cloudUser.custom_ferti_materials != null) userData.custom_ferti_materials = cloudUser.custom_ferti_materials;
                                if (cloudUser.custom_hydro_materials != null) userData.custom_hydro_materials = cloudUser.custom_hydro_materials;
                                if (cloudUser.custom_granular_materials != null) userData.custom_granular_materials = cloudUser.custom_granular_materials;
                                if (cloudUser.custom_granular_crops != null) userData.custom_granular_crops = cloudUser.custom_granular_crops;
                                if (cloudUser.custom_ferti_crops != null) userData.custom_ferti_crops = cloudUser.custom_ferti_crops;
                                if (cloudUser.custom_amendments != null) userData.custom_amendments = cloudUser.custom_amendments;
                            }
                            users.push(userData);
                            processedEmails.add(user.email?.toLowerCase());
                        }
                    } catch (e) {
                        console.warn('Error parseando usuario:', key, e);
                    }
                }
            }
            
            // Buscar referencias hu√©rfanas (emails sin usuario completo)
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('nutriplant_user_email_')) {
                    const email = key.replace('nutriplant_user_email_', '');
                    if (!processedEmails.has(email)) {
                        try {
                            const userIdRef = localStorage.getItem(key);
                            if (userIdRef && !userIdRef.startsWith('{')) {
                                // Es una referencia hu√©rfana
                                users.push({
                                    id: userIdRef,
                                    userId: userIdRef,
                                    name: '‚ö†Ô∏è Referencia Hu√©rfana',
                                    email: email,
                                    phone: '',
                                    location: {},
                                    profession: '',
                                    crops: [],
                                    projects_count: 0, // Referencias hu√©rfanas no tienen proyectos
                                    subscription_status: 'unknown',
                                    subscription_amount: 49.00,
                                    isOrphan: true
                                });
                            }
                        } catch (e) {
                            console.warn('Error procesando referencia:', key, e);
                        }
                    }
                }
            }
            
            // üü¢ Agregar usuarios de Supabase que no est√°n en localStorage (incluye al admin si est√° en la nube)
            if (window._adminCloudCache && Array.isArray(window._adminCloudCache.users)) {
                (window._adminCloudCache.users || []).forEach(function(cu) {
                    if (!processedEmails.has(cu.email?.toLowerCase())) {
                        const isAdmin = !!cu.isAdmin;
                        users.push({
                            id: cu.id,
                            userId: cu.id,
                            name: cu.name || 'Sin nombre',
                            email: cu.email || '',
                            password: cu.password || '',
                            phone: cu.phone || '',
                            profession: cu.profession || '',
                            location: cu.location || '',
                            crops: cu.crops || [],
                            subscription_status: isAdmin ? 'active' : (cu.subscription_status || 'inactive'),
                            subscription_amount: isAdmin ? 0 : (cu.subscription_amount ?? 49),
                            created_at: cu.created_at,
                            last_login: cu.last_login || null,
                            projects_count: Math.max(cu.projects_count ?? 0, getLocalProjectCountForUser(cu.id, cu.email)),
                            isAdmin: isAdmin,
                            custom_ferti_materials: cu.custom_ferti_materials,
                            custom_hydro_materials: cu.custom_hydro_materials,
                            custom_granular_materials: cu.custom_granular_materials,
                            custom_granular_crops: cu.custom_granular_crops,
                            custom_ferti_crops: cu.custom_ferti_crops,
                            custom_amendments: cu.custom_amendments
                        });
                        processedEmails.add(cu.email?.toLowerCase());
                    }
                });
            }
            
            // Un solo admin: si no vino de Supabase, a√±adir el de localStorage (due√±o, gratis)
            if (pendingAdminFromLocal && !processedEmails.has(ADMIN_EMAIL_LC)) {
                users.push(pendingAdminFromLocal);
                processedEmails.add(ADMIN_EMAIL_LC);
            }

            // Consolidar por email de forma determinista para evitar alternancias entre clics
            // (ej. mismo usuario guardado como "admin" y tambi√©n con UUID).
            const isUuid = (val) => /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(val || '');
            const hasUserLocation = (u) => (typeof u.location === 'string' && u.location.trim()) || (u.location && typeof u.location === 'object' && (u.location.city || u.location.state || u.location.country));
            const chooseBetterUserRecord = (a, b) => {
                // 1) Priorizar admin correcto
                if (!!a.isAdmin !== !!b.isAdmin) return a.isAdmin ? a : b;
                // 2) Priorizar id UUID (m√°s estable con Supabase)
                const aUuid = isUuid(a.id || a.userId);
                const bUuid = isUuid(b.id || b.userId);
                let chosen = (aUuid !== bUuid) ? (aUuid ? a : b) : a;
                // 3) Si ambos tienen mismo tipo de ID, usar proyectos y datos √∫tiles.
                //    Si difieren (UUID vs legacy), mantener prioridad del UUID para evitar due√±os "fantasma".
                if (aUuid === bUuid) {
                    const aProjects = parseInt(a.projects_count || 0, 10);
                    const bProjects = parseInt(b.projects_count || 0, 10);
                    if (aProjects !== bProjects) chosen = aProjects > bProjects ? a : b;
                    const aScore = (a.phone ? 1 : 0) + (a.profession ? 1 : 0) + ((a.name && a.name !== 'Sin nombre') ? 1 : 0) + (hasUserLocation(a) ? 1 : 0);
                    const bScore = (b.phone ? 1 : 0) + (b.profession ? 1 : 0) + ((b.name && b.name !== 'Sin nombre') ? 1 : 0) + (hasUserLocation(b) ? 1 : 0);
                    if (aScore !== bScore) chosen = aScore > bScore ? a : b;
                }
                const other = chosen === a ? b : a;
                // 5) Enriquecer: llenar campos vac√≠os desde el otro (evita perder password/tel√©fono/ubicaci√≥n y cat√°logos nube)
                const out = { ...chosen };
                if (!out.password && other.password) out.password = other.password;
                if (!out.phone && other.phone) out.phone = other.phone;
                if (!out.profession && other.profession) out.profession = other.profession;
                if ((!out.name || out.name === 'Sin nombre') && other.name && other.name !== 'Sin nombre') out.name = other.name;
                if (!hasUserLocation(out) && hasUserLocation(other)) out.location = other.location;
                if (out.isAdmin && !out.password) out.password = other.password || 'npja1502';
                // Preservar cat√°logos de la nube (el que tenga datos gana)
                const catKeys = ['custom_ferti_materials', 'custom_hydro_materials', 'custom_granular_materials', 'custom_granular_crops', 'custom_ferti_crops', 'custom_amendments'];
                catKeys.forEach(function(k) {
                    var ov = (out[k] != null && Array.isArray(out[k]) && out[k].length) ? out[k] : null;
                    var oth = (other[k] != null && Array.isArray(other[k]) && other[k].length) ? other[k] : null;
                    if (oth && !ov) out[k] = other[k];
                    else if (ov) out[k] = chosen[k];
                });
                return out;
            };
            const byEmail = new Map();
            const noEmail = [];
            users.forEach(function(u) {
                const emailLc = (u.email || '').toLowerCase();
                if (!emailLc) {
                    noEmail.push(u);
                    return;
                }
                if (!byEmail.has(emailLc)) {
                    byEmail.set(emailLc, u);
                } else {
                    byEmail.set(emailLc, chooseBetterUserRecord(byEmail.get(emailLc), u));
                }
            });

            var result = Array.from(byEmail.values()).concat(noEmail);
            // Rellenar ubicaci√≥n desde cualquier clave de localStorage con el mismo email (por si se guard√≥ en otra clave)
            var hasLoc = function(u) { return (typeof u.location === 'string' && u.location.trim()) || (u.location && typeof u.location === 'object' && (u.location.city || u.location.state || u.location.country)); };
            result.forEach(function(u) {
                if (hasLoc(u)) return;
                var emailLc = (u.email || '').toLowerCase();
                if (!emailLc) return;
                for (var i = 0; i < localStorage.length; i++) {
                    var key = localStorage.key(i);
                    if (!key || !key.startsWith('nutriplant_user_') || key.indexOf('_email_') !== -1 || key.indexOf('_project_') !== -1) continue;
                    try {
                        var raw = localStorage.getItem(key);
                        if (!raw || !raw.startsWith('{')) continue;
                        var obj = JSON.parse(raw);
                        if (!obj || (obj.email || '').toLowerCase() !== emailLc) continue;
                        if (hasLoc(obj)) { u.location = obj.location; return; }
                    } catch (e) { continue; }
                }
            });
            // Recalcular proyectos por due√±o real para que coincida con "Todos los Proyectos"
            result.forEach(function(u) {
                var uid = u.id || u.userId || '';
                var email = u.email || '';
                var localCount = getLocalProjectCountForUser(uid, email);
                var cloudCount = 0;
                try {
                    var cloudUsers = (window._adminCloudCache && Array.isArray(window._adminCloudCache.users)) ? window._adminCloudCache.users : [];
                    var cu = cloudUsers.find(function(x) { return (x && (x.id === uid || (x.email || '').toLowerCase() === (email || '').toLowerCase())); });
                    if (cu && cu.projects_count != null) cloudCount = parseInt(cu.projects_count || 0, 10) || 0;
                } catch (e) {}
                u.projects_count = Math.max(localCount, cloudCount);
            });
            return result;
        }
        
        // Cuenta proyectos en localStorage que pertenecen a este usuario (por user_id o email). As√≠ la tabla "Proyectos" no muestra 0 cuando hay proyectos solo en local.
        function getLocalProjectCountForUser(userId, email) {
            var count = 0;
            var seen = new Set();
            // Si un proyecto ya existe en nube, la nube manda (evita "fantasmas" por copias locales viejas)
            var cloudById = new Map();
            try {
                var cloudList = (window._adminCloudCache && Array.isArray(window._adminCloudCache.projects)) ? window._adminCloudCache.projects : [];
                cloudList.forEach(function(cp) {
                    if (cp && cp.id) cloudById.set(cp.id, cp);
                });
            } catch (e) {}
            for (var i = 0; i < localStorage.length; i++) {
                var key = localStorage.key(i);
                if (!key || (!key.startsWith('nutriplant_project_') && !key.startsWith('nutriplant-project-'))) continue;
                try {
                    var raw = localStorage.getItem(key);
                    if (!raw || (!raw.startsWith('{') && !raw.startsWith('['))) continue;
                    var p = JSON.parse(raw);
                    if (!p || typeof p !== 'object') continue;
                    var pid = p.id || key.replace(/^nutriplant[-_]project[-_]/, '');
                    if (seen.has(pid)) continue;
                    if (cloudById.has(pid)) continue; // ya existe en nube, no contar copia local
                    var pu = p.user_id || p.userId;
                    var pe = (p.user_email || p.userEmail || '').toLowerCase();
                    var match = (userId && (pu === userId)) || (email && pe === (email || '').toLowerCase());
                    if (match) { seen.add(pid); count++; }
                } catch (e) { continue; }
            }
            return count;
        }
        
        function userExistsByIdOrEmail(userId, email) {
            if (userId) {
                const userKey = `nutriplant_user_${userId}`;
                if (localStorage.getItem(userKey)) {
                    return true;
                }
            }
            
            if (email) {
                const emailKey = `nutriplant_user_email_${email}`;
                if (localStorage.getItem(emailKey)) {
                    return true;
                }
            }
            
            return false;
        }
        
        /** Peso (0-3) de uso real de una secci√≥n: 0 = no uso, 1 = bajo, 2 = medio, 3 = alto. opts.reportCount = n√∫mero de reportes (si se conoce). */
        function getSectionWeights(project, opts) {
            if (!project || typeof project !== 'object') return {};
            opts = opts || {};
            var hasRealData = function(obj, checkV) {
                if (!obj || typeof obj !== 'object') return false;
                var k = Object.keys(obj).filter(function(key) { return key !== 'lastUpdated' && key !== 'savedAt' && key !== 'isUserSaved' && key !== 'timestamp'; });
                if (k.length === 0) return false;
                if (!checkV) return true;
                return k.some(function(key) {
                    var v = obj[key];
                    if (v == null || v === '') return false;
                    if (typeof v === 'number' && v !== 0) return true;
                    if (typeof v === 'string' && v.trim() !== '') return true;
                    if (Array.isArray(v) && v.length > 0) return true;
                    if (typeof v === 'object' && Object.keys(v).length > 0) return true;
                    return false;
                });
            };
            var hasSave = function(obj) { return obj && (obj.isUserSaved === true || !!obj.savedAt); };
            var out = {};
            // Ubicaci√≥n: alto solo si hay pol√≠gono (no depende del n√∫mero de puntos: 3, 5 u 8 valen igual)
            if (project.location && project.location.polygon && Array.isArray(project.location.polygon) && project.location.polygon.length >= 3) {
                out['Ubicaci√≥n'] = 3;
            } else { out['Ubicaci√≥n'] = 0; }
            // Enmienda: bajo = solo datos de an√°lisis de suelo (CIC/suelo en pesta√±a enmienda); medio = seleccion√≥ enmiendas u otros valores; alto = adem√°s puls√≥ calcular y tiene resultado
            if (project.amendments && hasRealData(project.amendments, true)) {
                var hasSelected = (project.amendments.selected && project.amendments.selected.length) > 0;
                var hasCalculation = !!(project.amendments.results && (project.amendments.results.detailedHTML || project.amendments.results.isVisible || hasRealData(project.amendments.results, true)));
                var onlySoilData = !hasSelected && !hasCalculation && hasRealData(project.amendments, true);
                if (hasCalculation) out['Enmienda'] = 3;
                else if (hasSelected || !onlySoilData) out['Enmienda'] = 2;
                else out['Enmienda'] = 1;
            } else { out['Enmienda'] = 0; }
            // Nutrici√≥n granular: bajo = solo edit√≥ requerimientos; medio = adem√°s una aplicaci√≥n granular; alto = m√°s de una aplicaci√≥n
            if (project.granular && hasRealData(project.granular, true)) {
                var apps = (project.granular.program && Array.isArray(project.granular.program.applications)) ? project.granular.program.applications.length : 0;
                var hasReqs = project.granular.requirements && hasRealData(project.granular.requirements, true);
                if (!hasReqs && apps === 0) { out['Granular'] = 0; }
                else if (apps === 0) out['Granular'] = 1;
                else if (apps === 1) out['Granular'] = 2;
                else out['Granular'] = 3;
            } else { out['Granular'] = 0; }
            // Fertirriego: bajo = solo requerimientos; medio = programa con ‚â§4 semanas/meses; alto = m√°s de 4 semanas/meses
            if (project.fertirriego && hasRealData(project.fertirriego, true)) {
                var weeks = (project.fertirriego.program && Array.isArray(project.fertirriego.program.weeks)) ? project.fertirriego.program.weeks.length : 0;
                var hasReqsF = project.fertirriego.requirements && hasRealData(project.fertirriego.requirements, true);
                if (!hasReqsF && weeks === 0) { out['Fertirriego'] = 0; }
                else if (weeks === 0) out['Fertirriego'] = 1;
                else if (weeks <= 4) out['Fertirriego'] = 2;
                else out['Fertirriego'] = 3;
            } else { out['Fertirriego'] = 0; }
            // Hidropon√≠a: bajo = solo soluci√≥n por etapa; medio = adem√°s c√°lculo con hasta 4 fertilizantes; alto = m√°s de 4 fertilizantes
            var hydro = project.hydroponics || project.hidroponia || (project.sections && project.sections.hidroponia);
            if (hydro && typeof hydro === 'object' && hasRealData(hydro, true)) {
                var fertCount = (hydro.fertilizers && Array.isArray(hydro.fertilizers)) ? hydro.fertilizers.length : 0;
                var hasStages = (hydro.stages && Array.isArray(hydro.stages) && hydro.stages.length > 0) || hasRealData(hydro, true);
                if (!hasStages && fertCount === 0) { out['Hidropon√≠a'] = 0; }
                else if (fertCount === 0) out['Hidropon√≠a'] = 1;
                else if (fertCount <= 4) out['Hidropon√≠a'] = 2;
                else out['Hidropon√≠a'] = 3;
            } else { out['Hidropon√≠a'] = 0; }
            // Reporte: binario ‚Äî 0 = no hay reportes, 3 = s√≠ hay (al menos uno). No importa bajo/medio/alto.
            var reportCount = opts.reportCount;
            if (typeof reportCount !== 'number' && project.reporte && typeof project.reporte === 'object' && Array.isArray(project.reporte.reportIds)) reportCount = project.reporte.reportIds.length;
            if (typeof reportCount === 'number' && reportCount > 0) {
                out['Reporte'] = 3;
            } else { out['Reporte'] = 0; }
            // An√°lisis: por cantidad de datos agregados (bajo/medio/alto seg√∫n tipos con datos)
            var analCount = [project.soilAnalysis, project.extracto, project.agua, project.foliar, project.fruta].filter(function(a) {
                return a && hasSave(a) && hasRealData(a, true);
            }).length;
            out['An√°lisis'] = analCount <= 0 ? 0 : (analCount === 1 ? 1 : (analCount === 2 ? 2 : 3));
            // VPD: bajo 1 vez calculado, medio 2, alto m√°s de 3 (cualquier calculadora: avanzada, ambiental, clima web)
            var vpd = (project.sections && project.sections.vpd) || project.vpdAnalysis;
            if (vpd && typeof vpd === 'object') {
                var histLen = (vpd.history && Array.isArray(vpd.history)) ? vpd.history.length : 0;
                if (histLen <= 0) out['VPD'] = 0;
                else if (histLen === 1) out['VPD'] = 1;
                else if (histLen === 2) out['VPD'] = 2;
                else out['VPD'] = 3;
            } else { out['VPD'] = 0; }
            return out;
        }

        /** Cuenta secciones activas de un proyecto (objeto plano, ej. p.data) para mostrar en "Todos los Proyectos" */
        function countActiveSectionsFromProject(project) {
            var w = getSectionWeights(project);
            return Object.keys(w).reduce(function(sum, k) { return sum + (w[k] > 0 ? 1 : 0); }, 0);
        }

        function getAllProjects() {
            // Combinar proyectos de la nube con los de localStorage (as√≠ se ven todos aunque no se hayan subido a√∫n)
            var cloudList = (window._adminCloudCache && Array.isArray(window._adminCloudCache.projects)) ? window._adminCloudCache.projects : [];
            var cloudIds = new Set((cloudList || []).map(function(p) { return p.id; }));
            var projects = cloudList ? cloudList.slice() : [];
            // Misma fuente de nombres que "Proyectos por Usuario" y panel de suscriptores
            var userDisplayMap = new Map();
            try {
                getAllUsers().forEach(function(u) {
                    if (u.id) userDisplayMap.set(u.id, { name: u.name || u.email || '‚Äî', email: u.email || '' });
                });
            } catch (e) { console.warn('getAllProjects: error building userDisplayMap', e); }
            // Normalizar proyectos de la nube: user_email, chat_messages y columnas de la tabla (Cultivo, Variedad, Ubicaci√≥n, Estado, Secciones) desde p.data
            projects.forEach(function(p) {
                p.user_email = (userDisplayMap.get(p.user_id) || {}).email || '';
                p.chat_messages = (p.data && p.data.chat_history && Array.isArray(p.data.chat_history)) ? p.data.chat_history.length : 0;
                var d = p.data || {};
                p.name = p.name || p.title || d.name || d.title || 'Sin nombre';
                p.crop_type = d.cultivo || d.crop_type || 'N/A';
                p.variedad = d.variedad || d.variety || '';
                p.location_coords = 'No especificado';
                if (d.location && d.location.polygon && Array.isArray(d.location.polygon) && d.location.polygon.length > 0) {
                    var pt = d.location.polygon[0];
                    if (Array.isArray(pt) && pt.length >= 2) p.location_coords = pt[0].toFixed(6) + ', ' + pt[1].toFixed(6);
                }
                var ud = userDisplayMap.get(p.user_id);
                p.user_name = (ud && (ud.name || ud.email)) || '‚Äî';
                p.orphan_status = (p.user_id && userDisplayMap.has(p.user_id)) ? 'Asignado' : (p.user_id ? 'Hu√©rfano' : 'N/A');
                p.active_sections_count = countActiveSectionsFromProject(d);
                p.section_weights = getSectionWeights(d);
            });
            const processedIds = new Set(); // üîí Set para rastrear IDs ya procesados y evitar duplicados
            const processedKeys = new Set(); // üîí Set para rastrear claves ya procesadas
            const projectMap = new Map(); // üîí Map para almacenar proyectos por ID (√∫ltimo encontrado gana)
            
            // üîç PRIMERA PASADA: Recopilar todos los proyectos y detectar duplicados
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                // Buscar tanto formato nuevo (nutriplant_project_) como legacy (nutriplant-project-)
                const isProjectKey = key && (
                    key.startsWith('nutriplant_project_') || 
                    key.startsWith('nutriplant-project-')
                );
                
                if (isProjectKey) {
                    // üîí DEDUPLICACI√ìN PRIMARIA: Verificar si ya procesamos esta clave exacta
                    if (processedKeys.has(key)) {
                        console.log(`‚ö†Ô∏è Clave duplicada detectada y omitida: ${key}`);
                        continue; // Ya procesamos esta clave, saltar
                    }
                    processedKeys.add(key);
                    
                    try {
                        const value = localStorage.getItem(key);
                        // Verificar que el valor sea JSON v√°lido
                        if (!value || (!value.startsWith('{') && !value.startsWith('['))) {
                            continue; // No es JSON v√°lido, saltar
                        }
                        const project = JSON.parse(value);
                        if (project && typeof project === 'object') {
                            // Extraer el ID de la clave (soporta ambos formatos)
                            const projectIdFromKey = key.replace(/^nutriplant[-_]project[-_]/, '');
                            // Usar el ID del objeto si existe, sino usar el de la clave
                            // üîí CR√çTICO: Normalizar ID - usar siempre el del objeto si est√° disponible
                            let projectId = project.id || projectIdFromKey;
                            
                            // üîç DETECTAR PROYECTOS HU√âRFANOS (usuario eliminado)
                            const projectUserId = project.user_id || project.userId;
                            const projectUserEmail = project.user_email || project.userEmail;
                            const ownerExists = userExistsByIdOrEmail(projectUserId, projectUserEmail);
                            project._isOrphan = !ownerExists;
                            
                            // üîí VALIDACI√ìN: Si el ID del objeto es diferente del de la clave, 
                            // puede ser un problema de inconsistencia
                            if (project.id && project.id !== projectIdFromKey) {
                                console.warn(`‚ö†Ô∏è INCONSISTENCIA DETECTADA: Clave "${key}" contiene proyecto con ID diferente "${project.id}". Usando ID del objeto.`);
                                // Normalizar: usar el ID del objeto como verdadero
                                projectId = project.id;
                            }
                            
                            // üîí DEDUPLICACI√ìN MEJORADA: Si ya existe un proyecto con este ID, comparar y mantener el m√°s completo
                            if (projectMap.has(projectId)) {
                                const existingProject = projectMap.get(projectId);
                                const existingKey = existingProject._sourceKey;
                                
                                // Decidir cu√°l mantener: preferir el que tenga m√°s datos o el formato nuevo
                                const currentHasData = Object.keys(project).length;
                                const existingHasData = Object.keys(existingProject).length;
                                
                                if (key.startsWith('nutriplant_project_') && existingKey.startsWith('nutriplant-project-')) {
                                    // Preferir formato nuevo sobre legacy - ELIMINAR el legacy
                                    console.log(`üîÑ Reemplazando proyecto legacy con formato nuevo: ID=${projectId}, clave antigua=${existingKey}, clave nueva=${key}`);
                                    // üßπ LIMPIAR: Eliminar la clave legacy del localStorage
                                    try {
                                        localStorage.removeItem(existingKey);
                                        console.log(`‚úÖ Clave legacy eliminada: ${existingKey}`);
                                    } catch (e) {
                                        console.warn(`‚ö†Ô∏è No se pudo eliminar clave legacy: ${existingKey}`, e);
                                    }
                                    projectMap.set(projectId, { ...project, _sourceKey: key });
                                } else if (currentHasData > existingHasData) {
                                    // Preferir el que tenga m√°s datos
                                    console.log(`üîÑ Reemplazando proyecto con menos datos: ID=${projectId}, clave antigua=${existingKey}, clave nueva=${key}`);
                                    // üßπ LIMPIAR: Eliminar la clave con menos datos
                                    try {
                                        localStorage.removeItem(existingKey);
                                        console.log(`‚úÖ Clave con menos datos eliminada: ${existingKey}`);
                                    } catch (e) {
                                        console.warn(`‚ö†Ô∏è No se pudo eliminar clave duplicada: ${existingKey}`, e);
                                    }
                                    projectMap.set(projectId, { ...project, _sourceKey: key });
                                } else {
                                    // Duplicado exacto - eliminar el que encontramos ahora (mantener el primero)
                                    console.log(`‚ö†Ô∏è Proyecto duplicado detectado y omitido: ID=${projectId}, clave=${key} (ya existe otro proyecto con este ID en clave=${existingKey})`);
                                    // üßπ LIMPIAR: Eliminar la clave duplicada
                                    try {
                                        localStorage.removeItem(key);
                                        console.log(`‚úÖ Clave duplicada eliminada: ${key}`);
                                    } catch (e) {
                                        console.warn(`‚ö†Ô∏è No se pudo eliminar clave duplicada: ${key}`, e);
                                    }
                                }
                            } else {
                                // Primera vez que vemos este ID, agregarlo
                                projectMap.set(projectId, { ...project, _sourceKey: key });
                                processedIds.add(projectId);
                            }
                        }
                    } catch (e) {
                        // Ignorar errores de parseo para valores no JSON
                        console.warn('‚ö†Ô∏è Error parseando proyecto:', key, e.message);
                        continue;
                    }
                }
            }
            
            // üîç SEGUNDA PASADA: Procesar proyectos √∫nicos y construir array final (solo a√±adir los que no vienen ya de la nube)
            for (const [projectId, project] of projectMap.entries()) {
                if (cloudIds && cloudIds.has(projectId)) continue; // ya est√° en la lista desde Supabase
                const key = project._sourceKey;
                delete project._sourceKey; // Limpiar metadato temporal
                
                try {
                            
                            // üìù OBTENER NOMBRE: De la tarjeta de creaci√≥n (name o title)
                            const projectName = project.name || project.title || 'Sin nombre';
                            
                            // üåæ OBTENER CULTIVO: De la tarjeta de creaci√≥n (crop_type o cultivo)
                            const cropType = project.crop_type || project.cultivo || 'N/A';
                            
                            // üß¨ OBTENER VARIEDAD: De la tarjeta de creaci√≥n
                            const variety = project.variedad || project.variety || '';
                            
                            // üìç OBTENER COORDENADAS DEL PRIMER PUNTO: Del pol√≠gono de ubicaci√≥n
                            let locationCoords = 'No especificado';
                            if (project.location && project.location.polygon && Array.isArray(project.location.polygon) && project.location.polygon.length > 0) {
                                const firstPoint = project.location.polygon[0];
                                if (Array.isArray(firstPoint) && firstPoint.length >= 2) {
                                    // Formato: lat, lng
                                    locationCoords = `${firstPoint[0].toFixed(6)}, ${firstPoint[1].toFixed(6)}`;
                                }
                            }
                            
                            // üìä CONTAR SECCIONES ACTIVAS: Pesta√±as con informaci√≥n REAL agregada/modificada por el usuario
                            let activeSectionsCount = 0;
                            
                            // Funci√≥n auxiliar para verificar si un objeto tiene valores reales (no solo estructura vac√≠a)
                            const hasRealData = (obj, checkValues = false) => {
                                if (!obj || typeof obj !== 'object') return false;
                                const keys = Object.keys(obj);
                                if (keys.length === 0) return false;
                                if (!checkValues) return true; // Si no se requiere verificar valores, solo existencia
                                // Verificar si hay valores no vac√≠os/no cero
                                return keys.some(key => {
                                    const val = obj[key];
                                    if (val === null || val === undefined || val === '') return false;
                                    if (typeof val === 'number' && val !== 0) return true;
                                    if (typeof val === 'string' && val.trim() !== '') return true;
                                    if (Array.isArray(val) && val.length > 0) return true;
                                    if (typeof val === 'object' && Object.keys(val).length > 0) return true;
                                    return false;
                                });
                            };
                            
                            // Contar si hay cualquier indicio de guardado (lastUpdated, etc.)
                            const hasUserSaved = (obj) => {
                                if (!obj || typeof obj !== 'object') return false;
                                return obj.isUserSaved === true || obj.lastUpdated || obj.timestamp || obj.savedAt;
                            };
                            // Solo guardado EXPL√çCITO (bot√≥n Guardar / acci√≥n del usuario). No cuenta solo por abrir la pesta√±a con valores precargados.
                            const hasExplicitUserSave = (obj) => {
                                if (!obj || typeof obj !== 'object') return false;
                                return obj.isUserSaved === true || !!obj.savedAt;
                            };
                            
                            // 1. Ubicaci√≥n - si tiene pol√≠gono con al menos 3 puntos (v√°lido)
                            if (project.location && project.location.polygon && Array.isArray(project.location.polygon) && project.location.polygon.length >= 3) {
                                activeSectionsCount++;
                            }
                            
                            // 2. Enmienda - solo si hay enmiendas seleccionadas O resultados con datos reales; si solo "guardado", que sea expl√≠cito (no valores precargados al entrar)
                            if (project.amendments) {
                                const hasSelected = project.amendments.selected && Array.isArray(project.amendments.selected) && project.amendments.selected.length > 0;
                                const hasResultsWithData = project.amendments.results && hasRealData(project.amendments.results, true);
                                const hasSavedWithData = (hasExplicitUserSave(project.amendments) || hasExplicitUserSave(project.amendments.results)) && hasRealData(project.amendments, true);
                                if (hasSelected || hasResultsWithData || hasSavedWithData) {
                                    activeSectionsCount++;
                                }
                            }
                            
                            // 3. Nutrici√≥n Granular - solo si el usuario guard√≥ expl√≠citamente con datos reales (no solo valores precargados al entrar)
                            if (project.granular && typeof project.granular === 'object' && hasRealData(project.granular, true)) {
                                const hasRequirements = project.granular.requirements && hasExplicitUserSave(project.granular.requirements) && hasRealData(project.granular.requirements, true);
                                const hasProgram = project.granular.program && hasExplicitUserSave(project.granular.program) && hasRealData(project.granular.program, true);
                                const hasLastUI = project.granular.lastUI && hasExplicitUserSave(project.granular.lastUI) && hasRealData(project.granular.lastUI, true);
                                const hasGranularRequirements = project.granularRequirements && hasExplicitUserSave(project.granularRequirements) && hasRealData(project.granularRequirements, true);
                                if (hasRequirements || hasProgram || hasLastUI || hasGranularRequirements) {
                                    activeSectionsCount++;
                                }
                            }
                            
                            // 4. Fertirriego - solo si el usuario guard√≥ expl√≠citamente con datos reales (no solo valores precargados al entrar)
                            if (project.fertirriego && typeof project.fertirriego === 'object' && hasRealData(project.fertirriego, true)) {
                                const hasRequirements = project.fertirriego.requirements && hasExplicitUserSave(project.fertirriego.requirements) && hasRealData(project.fertirriego.requirements, true);
                                const hasProgram = project.fertirriego.program && hasExplicitUserSave(project.fertirriego.program) && hasRealData(project.fertirriego.program, true);
                                const hasLastUI = project.fertirriego.lastUI && hasExplicitUserSave(project.fertirriego.lastUI) && hasRealData(project.fertirriego.lastUI, true);
                                const hasFertirriegoRequirements = project.fertirriegoRequirements && hasExplicitUserSave(project.fertirriegoRequirements) && hasRealData(project.fertirriegoRequirements, true);
                                if (hasRequirements || hasProgram || hasLastUI || hasFertirriegoRequirements) {
                                    activeSectionsCount++;
                                }
                            }
                            
                            // 6. Hidropon√≠a - solo si guard√≥ expl√≠citamente con datos reales (no solo valores precargados al entrar)
                            if (project.hydroponics && typeof project.hydroponics === 'object' && hasRealData(project.hydroponics, true) && hasExplicitUserSave(project.hydroponics)) {
                                activeSectionsCount++;
                            }
                            
                            // 7. Reporte - solo si guard√≥ expl√≠citamente con datos reales (no solo precargado)
                            if (project.reporte && typeof project.reporte === 'object' && hasRealData(project.reporte, true) && hasExplicitUserSave(project.reporte)) {
                                activeSectionsCount++;
                            }
                            
                            // 8. Todos los An√°lisis - solo si el usuario guard√≥ expl√≠citamente con datos reales (no solo entr√≥ y vio valores precargados)
                            const hasAnalysis = (
                                (project.soilAnalysis && typeof project.soilAnalysis === 'object' && hasExplicitUserSave(project.soilAnalysis) && hasRealData(project.soilAnalysis, true)) ||
                                (project.extracto && typeof project.extracto === 'object' && hasExplicitUserSave(project.extracto) && hasRealData(project.extracto, true)) ||
                                (project.agua && typeof project.agua === 'object' && hasExplicitUserSave(project.agua) && hasRealData(project.agua, true)) ||
                                (project.foliar && typeof project.foliar === 'object' && hasExplicitUserSave(project.foliar) && hasRealData(project.foliar, true)) ||
                                (project.fruta && typeof project.fruta === 'object' && hasExplicitUserSave(project.fruta) && hasRealData(project.fruta, true))
                            );
                            if (hasAnalysis) {
                                activeSectionsCount++;
                            }
                            
                            // 9. VPD Analysis - solo si hay datos reales (historial con entradas o guardado expl√≠cito; no solo valores precargados al entrar)
                            const vpdAnalysisCheck = project.sections?.vpd || project.vpdAnalysis || null;
                            if (vpdAnalysisCheck && typeof vpdAnalysisCheck === 'object') {
                                const hasHistoryData = vpdAnalysisCheck.history && Array.isArray(vpdAnalysisCheck.history) && vpdAnalysisCheck.history.length > 0;
                                const hasVpdRealData = hasExplicitUserSave(vpdAnalysisCheck) && hasRealData(vpdAnalysisCheck, true);
                                if (hasHistoryData || hasVpdRealData) {
                                    activeSectionsCount++;
                                }
                            }
                            
                            // üë§ OBTENER NOMBRE DEL USUARIO: misma fuente que "Proyectos por Usuario" y suscriptores (getAllUsers)
                            let userName = 'Sin usuario';
                            const userId = project.user_id || project.userId;
                            var ud = userId && userDisplayMap ? userDisplayMap.get(userId) : null;
                            if (ud) {
                                userName = ud.name || ud.email || '‚Äî';
                            } else if (userId) {
                                if (project.user_name) {
                                    userName = project.user_name;
                                } else {
                                    try {
                                        const userKey = `nutriplant_user_${userId}`;
                                        const userData = localStorage.getItem(userKey);
                                        if (userData) {
                                            const user = JSON.parse(userData);
                                            if (user && user.name) userName = user.name;
                                            else if (user && user.email) userName = user.email;
                                        }
                                    } catch (e) { console.warn('‚ö†Ô∏è Error obteniendo nombre del usuario:', userId, e); }
                                }
                            } else {
                                // üîç B√öSQUEDA MEJORADA: Si no hay user_id en el proyecto, buscar en todos los usuarios
                                // Esto puede pasar con proyectos antiguos creados antes de la asociaci√≥n autom√°tica
                                let foundUser = false;
                                for (let j = 0; j < localStorage.length; j++) {
                                    const userKey = localStorage.key(j);
                                    if (userKey && userKey.startsWith('nutriplant_user_') && !userKey.includes('_email_') && !userKey.includes('_project_')) {
                                        try {
                                            const userData = localStorage.getItem(userKey);
                                            if (userData && userData.startsWith('{')) {
                                                const user = JSON.parse(userData);
                                                if (user && user.projects && Array.isArray(user.projects)) {
                                                    // Verificar si el proyecto est√° en la lista del usuario
                                                    // Comparar tanto con projectId como con variaciones del ID
                                                    const projectIdInList = user.projects.some(pid => 
                                                        pid === projectId || 
                                                        pid === projectIdFromKey ||
                                                        key.includes(pid) ||
                                                        pid.includes(projectId)
                                                    );
                                                    
                                                    if (projectIdInList) {
                                                        var resolvedId = userKey.replace('nutriplant_user_', '');
                                                        userName = (userDisplayMap && userDisplayMap.get(resolvedId)) ? (userDisplayMap.get(resolvedId).name || userDisplayMap.get(resolvedId).email) : (user.name || user.email || 'Usuario encontrado');
                                                        foundUser = true;
                                                        
                                                        // üîß ACTUALIZAR PROYECTO: Agregar user_id y user_name al proyecto
                                                        try {
                                                            project.user_id = userKey.replace('nutriplant_user_', '');
                                                            project.user_name = user.name || user.email || '';
                                                            project.userId = project.user_id; // Compatibilidad
                                                            
                                                            // Guardar proyecto actualizado
                                                            const updatedProjectKey = key.startsWith('nutriplant_project_') ? key : `nutriplant_project_${projectId}`;
                                                            localStorage.setItem(updatedProjectKey, JSON.stringify(project));
                                                            console.log(`‚úÖ Proyecto "${projectId}" actualizado con usuario: ${userName}`);
                                                        } catch (updateError) {
                                                            console.warn('‚ö†Ô∏è Error actualizando proyecto con usuario:', updateError);
                                                        }
                                                        
                                                        break;
                                                    }
                                                }
                                            }
                                        } catch (e) {
                                            continue;
                                        }
                                    }
                                }
                                
                                // Si a√∫n no se encontr√≥ usuario, intentar buscar por ID descriptivo
                                if (!foundUser && projectId && projectId.includes('_')) {
                                    // Los IDs descriptivos tienen formato: INICIALES_NOMBRE_FECHA
                                    // Intentar extraer iniciales y buscar usuario con esas iniciales
                                    const parts = projectId.split('_');
                                    if (parts.length >= 2) {
                                        const possibleInitials = parts[0];
                                        // Buscar usuarios cuyas iniciales coincidan
                                        for (let j = 0; j < localStorage.length; j++) {
                                            const userKey = localStorage.key(j);
                                            if (userKey && userKey.startsWith('nutriplant_user_') && !userKey.includes('_email_') && !userKey.includes('_project_')) {
                                                try {
                                                    const userData = localStorage.getItem(userKey);
                                                    if (userData && userData.startsWith('{')) {
                                                        const user = JSON.parse(userData);
                                                        if (user && user.name) {
                                                            // Extraer iniciales del nombre del usuario
                                                            const nameParts = user.name.trim().split(/\s+/);
                                                            const userInitials = nameParts.map(p => p.charAt(0).toUpperCase()).join('');
                                                            
                                                            if (userInitials === possibleInitials) {
                                                                var resolvedIdByInitials = userKey.replace('nutriplant_user_', '');
                                                                userName = (userDisplayMap && userDisplayMap.get(resolvedIdByInitials)) ? (userDisplayMap.get(resolvedIdByInitials).name || userDisplayMap.get(resolvedIdByInitials).email) : (user.name || user.email || 'Usuario encontrado por iniciales');
                                                                foundUser = true;
                                                                
                                                                // üîß ACTUALIZAR PROYECTO: Agregar user_id y user_name
                                                                try {
                                                                    project.user_id = userKey.replace('nutriplant_user_', '');
                                                                    project.user_name = user.name || user.email || '';
                                                                    project.userId = project.user_id;
                                                                    
                                                                    const updatedProjectKey = key.startsWith('nutriplant_project_') ? key : `nutriplant_project_${projectId}`;
                                                                    localStorage.setItem(updatedProjectKey, JSON.stringify(project));
                                                                    console.log(`‚úÖ Proyecto "${projectId}" actualizado con usuario por iniciales: ${userName}`);
                                                                } catch (updateError) {
                                                                    console.warn('‚ö†Ô∏è Error actualizando proyecto:', updateError);
                                                                }
                                                                
                                                                break;
                                                            }
                                                        }
                                                    }
                                                } catch (e) {
                                                    continue;
                                                }
                                            }
                                        }
                                    }
                                }
                                
                                // Si a√∫n no se encontr√≥, marcar como "Sin usuario" pero loguear para debugging
                                if (!foundUser) {
                                    console.warn(`‚ö†Ô∏è Proyecto "${projectId}" no tiene usuario asociado. Revisar manualmente.`);
                                }
                            }
                            
                            projects.push({
                                user_id: userId,
                                user_name: userName,
                                user_email: (userDisplayMap && userDisplayMap.get(userId)) ? userDisplayMap.get(userId).email : '',
                                orphan_status: project._isOrphan ? 'Hu√©rfano' : 'Asignado',
                                id: projectId,
                                name: projectName,
                                crop_type: cropType,
                                variedad: variety,
                                location_coords: locationCoords,
                                created_at: project.created_at || project.createdAt,
                                updated_at: project.updated_at || project.updatedAt,
                                active_sections_count: activeSectionsCount,
                                section_weights: getSectionWeights(project),
                                chat_messages: (project.chat_history && Array.isArray(project.chat_history)) ? project.chat_history.length : 0,
                                _isOrphan: !!project._isOrphan
                            });
                } catch (e) {
                    console.warn('‚ö†Ô∏è Error procesando proyecto final:', projectId, e.message);
                    continue;
                }
            }
            
            // üßπ LIMPIEZA FINAL: Eliminar todas las claves legacy que quedaron sin procesar
            let legacyKeysRemoved = 0;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('nutriplant-project-')) {
                    // Verificar si este proyecto ya est√° en nuestro Map (con formato nuevo)
                    try {
                        const value = localStorage.getItem(key);
                        if (value && value.startsWith('{')) {
                            const project = JSON.parse(value);
                            if (project && project.id) {
                                const projectId = project.id;
                                // Si ya tenemos este proyecto en el Map con formato nuevo, eliminar el legacy
                                if (projectMap.has(projectId)) {
                                    const existingProject = projectMap.get(projectId);
                                    if (existingProject._sourceKey && existingProject._sourceKey.startsWith('nutriplant_project_')) {
                                        localStorage.removeItem(key);
                                        legacyKeysRemoved++;
                                        console.log(`üßπ Clave legacy adicional eliminada: ${key} (proyecto ya existe en formato nuevo)`);
                                    }
                                }
                            }
                        }
                    } catch (e) {
                        // Ignorar errores
                    }
                }
            }
            
            if (legacyKeysRemoved > 0) {
                console.log(`‚úÖ Limpieza completada: ${legacyKeysRemoved} claves legacy adicionales eliminadas`);
            }
            
            console.log(`‚úÖ Total de proyectos √∫nicos encontrados: ${projects.length} (despu√©s de deduplicaci√≥n)`);
            console.log(`üìä Claves procesadas: ${processedKeys.size}, IDs √∫nicos: ${processedIds.size}, Proyectos en Map: ${projectMap.size}`);
            
            // üîç VERIFICACI√ìN FINAL: Asegurar que no hay duplicados por ID en el array final
            const finalIds = new Set();
            const uniqueProjects = [];
            for (const project of projects) {
                if (!finalIds.has(project.id)) {
                    finalIds.add(project.id);
                    uniqueProjects.push(project);
                } else {
                    console.warn(`‚ö†Ô∏è DUPLICADO FINAL DETECTADO Y ELIMINADO: ID=${project.id}, nombre=${project.name}`);
                }
            }
            
            if (uniqueProjects.length !== projects.length) {
                console.warn(`‚ö†Ô∏è Se eliminaron ${projects.length - uniqueProjects.length} proyectos duplicados del array final`);
            }
            
            return uniqueProjects;
        }
        
        function getAllChats() {
            if (window._adminCloudCache && Array.isArray(window._adminCloudCache.chats)) return window._adminCloudCache.chats;
            const chats = [];
            const users = getAllUsers();
            const userNames = {};
            users.forEach(function (u) {
                var uid = u.id || u.userId;
                if (uid) userNames[uid] = (u.name || u.email || ('Usuario ' + uid));
            });
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('nutriplant_project_')) {
                    try {
                        const value = localStorage.getItem(key);
                        if (!value || (!value.startsWith('{') && !value.startsWith('['))) continue;
                        const project = JSON.parse(value);
                        if (project && typeof project === 'object' && project.chat_history && Array.isArray(project.chat_history)) {
                            var projectUserId = project.user_id || project.userId;
                            var projectUserName = (projectUserId && userNames[projectUserId]) ? userNames[projectUserId] : '‚Äî';
                            project.chat_history.forEach(chat => {
                                if (chat && typeof chat === 'object') {
                                    var fullContent = (chat.content && typeof chat.content === 'string') ? chat.content : 'N/A';
                                    chats.push({
                                        project_id: project.id || '‚Äî',
                                        project_name: project.name || '‚Äî',
                                        user_id: projectUserId || '‚Äî',
                                        user_name: projectUserName,
                                        message_type: chat.sender || chat.type || 'unknown',
                                        content: fullContent.length > 100 ? fullContent.substring(0, 100) + '...' : fullContent,
                                        content_full: fullContent,
                                        timestamp: chat.timestamp || null,
                                        active_section: (chat.context && chat.context.active_section) ? chat.context.active_section : 'N/A'
                                    });
                                }
                            });
                        }
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Error parseando proyecto para chats:', key, e.message);
                    }
                }
            }
            // Incluir mensajes de chat sin proyecto (por usuario)
            for (let u = 0; u < localStorage.length; u++) {
                const ukey = localStorage.key(u);
                if (!ukey || !ukey.startsWith('nutriplant_user_') || ukey.indexOf('_email_') !== -1 || ukey.indexOf('_project_') !== -1) continue;
                try {
                    const uval = localStorage.getItem(ukey);
                    if (!uval || !uval.startsWith('{')) continue;
                    const user = JSON.parse(uval);
                    if (!user || !Array.isArray(user.chat_history_sin_proyecto)) continue;
                    var uid = ukey.replace(/^nutriplant_user_/, '') || '‚Äî';
                    var userName = user.name || user.email || ('Usuario ' + uid);
                    user.chat_history_sin_proyecto.forEach(chat => {
                        if (chat && typeof chat === 'object') {
                            var fullContent = (chat.content && typeof chat.content === 'string') ? chat.content : 'N/A';
                            chats.push({
                                project_id: '‚Äî',
                                project_name: 'Sin proyecto',
                                user_id: uid,
                                user_name: userName,
                                message_type: chat.sender || chat.type || 'unknown',
                                content: fullContent.length > 100 ? fullContent.substring(0, 100) + '...' : fullContent,
                                content_full: fullContent,
                                timestamp: chat.timestamp || null,
                                active_section: (chat.context && chat.context.active_section) ? chat.context.active_section : 'N/A'
                            });
                        }
                    });
                } catch (e) { continue; }
            }
            // Ordenar de m√°s reciente a m√°s antiguo (fecha descendente)
            chats.sort(function (a, b) {
                var ta = (a.timestamp ? new Date(a.timestamp).getTime() : 0);
                var tb = (b.timestamp ? new Date(b.timestamp).getTime() : 0);
                return tb - ta;
            });
            return chats;
        }
        
        // üìä FUNCIONES DE ANALYTICS
        function showAnalytics() {
            console.log('üìä Analytics completos:');
            const analytics = {
                users: getAllUsers(),
                projects: getAllProjects(),
                chats: getAllChats(),
                soilAnalysis: getSoilAnalysisData(),
                nutritionPrograms: getNutritionProgramsData()
            };
            console.log(analytics);
            alert('Analytics completos cargados. Revisa la consola para ver todos los datos.');
        }
        
        function getSoilAnalysisData() {
            const soilData = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('nutriplant_project_')) {
                    try {
                        const value = localStorage.getItem(key);
                        // Verificar que el valor sea JSON v√°lido
                        if (!value || (!value.startsWith('{') && !value.startsWith('['))) {
                            continue; // No es JSON v√°lido, saltar
                        }
                        const project = JSON.parse(value);
                        if (project && typeof project === 'object' && project.sections && project.sections.analisis) {
                        const analysis = project.sections.analisis;
                        if (Object.keys(analysis).length > 0) {
                            soilData.push({
                                project_id: project.id,
                                project_name: project.name,
                                crop_type: project.crop_type,
                                analysis_data: analysis
                            });
                        }
                        }
                    } catch (e) {
                        // Ignorar errores de parseo para valores no JSON
                        console.warn('‚ö†Ô∏è Error parseando proyecto para an√°lisis de suelo:', key, e.message);
                        continue;
                    }
                }
            }
            return soilData;
        }
        
        function getNutritionProgramsData() {
            const nutritionData = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('nutriplant_project_')) {
                    try {
                        const value = localStorage.getItem(key);
                        // Verificar que el valor sea JSON v√°lido
                        if (!value || (!value.startsWith('{') && !value.startsWith('['))) {
                            continue; // No es JSON v√°lido, saltar
                        }
                        const project = JSON.parse(value);
                        if (project && typeof project === 'object' && project.sections) {
                        const sections = ['programa_granular', 'fertirriego', 'hidroponia'];
                        sections.forEach(section => {
                            if (project.sections[section] && Object.keys(project.sections[section]).length > 0) {
                                nutritionData.push({
                                    project_id: project.id,
                                    project_name: project.name,
                                    crop_type: project.crop_type,
                                    program_type: section,
                                    program_data: project.sections[section]
                                });
                            }
                        });
                        }
                    } catch (e) {
                        // Ignorar errores de parseo para valores no JSON
                        console.warn('‚ö†Ô∏è Error parseando proyecto para programas de nutrici√≥n:', key, e.message);
                        continue;
                    }
                }
            }
            return nutritionData;
        }
        
        // üì§ FUNCIONES DE EXPORTACI√ìN
        /** Escapa un valor para CSV (comillas y comas). */
        function escapeCsvCell(val) {
            if (val == null) return '';
            var s = String(val);
            if (s.indexOf(',') >= 0 || s.indexOf('"') >= 0 || s.indexOf('\n') >= 0 || s.indexOf('\r') >= 0)
                return '"' + s.replace(/"/g, '""') + '"';
            return s;
        }
        /** Formatea ubicaci√≥n para export: texto legible (ciudad, estado, pa√≠s). */
        function formatLocationForExport(loc) {
            if (!loc) return '';
            if (typeof loc === 'string') return loc.trim();
            if (typeof loc !== 'object') return '';
            var parts = [loc.city, loc.state, loc.country].filter(Boolean);
            if (parts.length === 0) parts = [loc.locality, loc.state_province, loc.country].filter(Boolean);
            if (parts.length === 0 && loc.postal) parts.push(loc.postal);
            return parts.join(', ');
        }
        /** Formatea cultivos para export: texto legible separado por comas. */
        function formatCropsForExport(crops) {
            if (!crops) return '';
            if (Array.isArray(crops)) return crops.filter(Boolean).join(', ');
            return String(crops);
        }
        /** Formatea fecha para export (es-MX). */
        function formatDateForExport(val) {
            if (!val) return '';
            try { return new Date(val).toLocaleDateString('es-MX'); } catch (e) { return String(val); }
        }
        function exportUsers() {
            const users = getAllUsers();
            var headers = ['nombre', 'email', 'telefono', 'password', 'ubicacion', 'profesion', 'cultivos', 'proyectos_count', 'subscription_status', 'subscription_amount', 'subscription_activated_at', 'created_at', 'last_payment_date', 'next_payment_date', '_cancelled_at', '_expired_at', '_pending_at'];
            var rows = users.map(function(u) {
                return [
                    escapeCsvCell(u.name || ''),
                    escapeCsvCell(u.email || ''),
                    escapeCsvCell(u.phone || ''),
                    escapeCsvCell(u.password || ''),
                    escapeCsvCell(formatLocationForExport(u.location)),
                    escapeCsvCell(u.profession || ''),
                    escapeCsvCell(formatCropsForExport(u.crops)),
                    escapeCsvCell((u.projects_count != null ? u.projects_count : (Array.isArray(u.projects) ? u.projects.length : 0))),
                    escapeCsvCell(u.subscription_status || ''),
                    escapeCsvCell(u.subscription_amount != null ? u.subscription_amount : ''),
                    escapeCsvCell(u.subscription_activated_at ? formatDateForExport(u.subscription_activated_at) : ''),
                    escapeCsvCell(formatDateForExport(u.created_at)),
                    escapeCsvCell(formatDateForExport(u.last_payment_date)),
                    escapeCsvCell(formatDateForExport(u.next_payment_date)),
                    escapeCsvCell(formatDateForExport(u._cancelled_at)),
                    escapeCsvCell(formatDateForExport(u._expired_at)),
                    escapeCsvCell(formatDateForExport(u._pending_at))
                ].join(',');
            });
            var csv = [headers.join(','), rows.join('\n')].join('\n');
            downloadCSV(csv, 'usuarios_nutriplant.csv');
        }
        
        function exportProjects() {
            const projects = getAllProjects();
            const csv = convertToCSV(projects);
            downloadCSV(csv, 'proyectos_nutriplant.csv');
        }
        
        function exportChats() {
            const chats = getAllChats();
            const csv = convertToCSV(chats);
            downloadCSV(csv, 'conversaciones_nutriplant.csv');
        }
        
        function convertToCSV(data) {
            if (data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => 
                    JSON.stringify(row[header] || '')
                ).join(','))
            ].join('\n');
            
            return csvContent;
        }
        
        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // üîç FUNCIONES DE B√öSQUEDA
        function searchProjects() {
            const searchTerm = prompt('Buscar proyectos por usuario, nombre, cultivo, variedad o ubicaci√≥n:');
            if (searchTerm) {
                const projects = getAllProjects();
                const searchLower = searchTerm.toLowerCase();
                const filtered = projects.filter(project => {
                    const userNameMatch = project.user_name && project.user_name.toLowerCase().includes(searchLower);
                    const nameMatch = project.name && project.name.toLowerCase().includes(searchLower);
                    const cropMatch = project.crop_type && project.crop_type.toLowerCase().includes(searchLower);
                    const varietyMatch = project.variedad && project.variedad.toLowerCase().includes(searchLower);
                    // Manejar ubicaci√≥n como coordenadas (string)
                    const locationMatch = project.location_coords && project.location_coords.toLowerCase().includes(searchLower);
                    return userNameMatch || nameMatch || cropMatch || varietyMatch || locationMatch;
                });
                
                if (filtered.length > 0) {
                    showDataViewerWithFilters({
                        title: `üìã Proyectos encontrados: "${searchTerm}"`,
                        data: filtered,
                        columns: [
                            { key: 'user_name', label: 'Usuario', format: 'text', filterable: true },
                            { key: 'id', label: 'ID', format: 'text', filterable: true },
                            { key: 'name', label: 'Nombre', format: 'text', filterable: true },
                            { key: 'crop_type', label: 'Cultivo', format: 'text', filterable: true },
                            { key: 'variedad', label: 'Variedad', format: 'text', filterable: true },
                            { key: 'location_coords', label: 'Ubicaci√≥n', format: 'text', filterable: true },
                            { key: 'created_at', label: 'Fecha de Creaci√≥n', format: 'date', filterable: true },
                            { key: 'updated_at', label: '√öltima Actualizaci√≥n', format: 'date', filterable: true },
                            { key: 'active_sections_count', label: 'Secciones Activas', format: 'text', filterable: false }
                        ],
                        actions: {
                            edit: false,
                            delete: false
                        }
                    });
                } else {
                    alert(`No se encontraron proyectos que coincidan con "${searchTerm}".`);
                }
            }
        }
        
        function showProjectsByCrop() {
            console.log('üå± Mostrando proyectos organizados por cultivo...');
            
            const projects = getAllProjects();
            if (projects.length === 0) {
                alert('üå± No hay proyectos con cultivos especificados.');
                return;
            }
            
            const rows = projects.map(project => ({
                crop_type: project.crop_type || 'Sin especificar',
                variedad: project.variedad || '',
                user_name: project.user_name || 'Sin usuario',
                id: project.id,
                name: project.name || 'Sin nombre',
                chat_messages: project.chat_messages || 0,
                created_at: project.created_at,
                updated_at: project.updated_at
            }));
            
            showDataViewerWithFilters({
                title: 'üåæ Proyectos por Cultivo',
                data: rows,
                isProject: true,
                columns: [
                    { key: 'crop_type', label: 'Cultivo', format: 'text', filterable: true },
                    { key: 'variedad', label: 'Variedad', format: 'text', filterable: true },
                    { key: 'user_name', label: 'Usuario', format: 'text', filterable: true },
                    { key: 'id', label: 'ID', format: 'text', filterable: true },
                    { key: 'name', label: 'Nombre', format: 'text', filterable: true },
                    { key: 'chat_messages', label: 'Mensajes Chat', format: 'text', filterable: false },
                    { key: 'created_at', label: 'Fecha de Creaci√≥n', format: 'date', filterable: true },
                    { key: 'updated_at', label: '√öltima Actualizaci√≥n', format: 'date', filterable: true }
                ],
                actions: {
                    edit: true,
                    delete: false
                },
                previousView: showProjectsByCrop,
                previousViewParams: []
            });
        }
        
        function searchChats() {
            const searchTerm = prompt('Buscar en conversaciones:');
            if (searchTerm) {
                const chats = getAllChats();
                const filtered = chats.filter(chat => 
                    chat.content.toLowerCase().includes(searchTerm.toLowerCase())
                );
                console.table(filtered);
                alert(`Se encontraron ${filtered.length} conversaciones que contienen "${searchTerm}". Revisa la consola.`);
            }
        }
        
        // üìä FUNCIONES ADICIONALES
        function showUsersWithProjects() {
            const users = getAllUsers();
            // üîç Filtrar usuarios que tienen proyectos (usar projects_count que es el campo correcto)
            const usersWithProjects = users.filter(u => {
                const projectsCount = u.projects_count || 0;
                return projectsCount > 0;
            });
            
            if (usersWithProjects.length === 0) {
                alert('No se encontraron usuarios con proyectos.\n\nEsto puede significar que:\n- Los usuarios a√∫n no han creado proyectos\n- Los proyectos fueron eliminados\n- Hay un problema con la asociaci√≥n de proyectos');
                console.log('üë• Usuarios totales:', users.length);
                console.log('üìä Usuarios con proyectos_count > 0:', users.filter(u => (u.projects_count || 0) > 0).length);
                console.log('üìã Todos los usuarios y sus proyectos:', users.map(u => ({
                    name: u.name,
                    email: u.email,
                    projects_count: u.projects_count || 0
                })));
                return;
            }
            
            console.log('üë• Usuarios con proyectos:', usersWithProjects);
            console.table(usersWithProjects);
            
            // Mostrar en tabla con filtros
            showDataViewerWithFilters({
                title: 'üë• Suscriptores con Proyectos',
                data: usersWithProjects,
                previousView: showUsersWithProjects,
                previousViewParams: [],
                columns: [
                    { key: 'name', label: 'Nombre', format: 'text', filterable: true },
                    { key: 'email', label: 'Email', format: 'text', filterable: true },
                    { key: 'phone', label: 'Tel√©fono', format: 'text', filterable: true },
                    { key: 'location', label: 'Ubicaci√≥n', format: 'location', filterable: true },
                    { key: 'profession', label: 'Profesi√≥n', format: 'text', filterable: true },
                    { key: 'crops', label: 'Cultivos', format: 'array', filterable: true },
                    { key: 'projects_count', label: 'Proyectos', format: 'text', filterable: true },
                    { key: 'subscription_status', label: 'Suscripci√≥n', format: 'status', filterable: true },
                    { key: 'subscription_amount', label: 'Monto', format: 'currency', filterable: false },
                    { key: 'created_at', label: 'Fecha de Registro', format: 'date', filterable: true }
                ],
                actions: {
                    edit: true,
                    delete: true
                }
            });
        }
        
        function showProjectsByUser() {
            console.log('üìä Mostrando proyectos organizados por usuario...');
            // Misma lista que "Todos los Proyectos": una sola fuente de verdad, esta vista es solo otro filtro/organizaci√≥n
            const allProjects = getAllProjects();
            const rows = allProjects.map(function(p) {
                return {
                    user_name: p.user_name || '‚Äî',
                    user_email: p.user_email || '',
                    id: p.id,
                    name: p.name || 'Sin nombre',
                    crop_type: p.crop_type || 'N/A',
                    variedad: p.variedad || '',
                    chat_messages: p.chat_messages != null ? p.chat_messages : 'N/A',
                    created_at: p.created_at,
                    updated_at: p.updated_at
                };
            });
            if (rows.length === 0) {
                alert('üìã No hay proyectos. Los proyectos se muestran aqu√≠ como filtro de "Todos los Proyectos".');
                return;
            }
            showDataViewerWithFilters({
                title: 'üë• Proyectos por Usuario',
                data: rows,
                isProject: true,
                columns: [
                    { key: 'user_name', label: 'Usuario', format: 'text', filterable: true },
                    { key: 'user_email', label: 'Email', format: 'text', filterable: true },
                    { key: 'id', label: 'ID', format: 'text', filterable: true },
                    { key: 'name', label: 'Nombre', format: 'text', filterable: true },
                    { key: 'crop_type', label: 'Cultivo', format: 'text', filterable: true },
                    { key: 'variedad', label: 'Variedad', format: 'text', filterable: true },
                    { key: 'chat_messages', label: 'Mensajes Chat', format: 'text', filterable: false },
                    { key: 'created_at', label: 'Fecha de Creaci√≥n', format: 'date', filterable: true },
                    { key: 'updated_at', label: '√öltima Actualizaci√≥n', format: 'date', filterable: true }
                ],
                actions: {
                    edit: true,
                    delete: false
                },
                previousView: showProjectsByUser,
                previousViewParams: []
            });
        }
        
        function getUserProjects(userId, userEmail) {
            const projects = [];
            const processedIds = new Set(); // üîí IDs ya agregados (nube/local) para evitar duplicados
            const isSupabaseUserId = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(userId);
            // üü¢ Usuarios con UUID: precargar proyectos de Supabase, pero NO retornar a√∫n.
            // Luego se fusionan con localStorage para tener siempre la misma vista.
            if (isSupabaseUserId && window._adminCloudCache && Array.isArray(window._adminCloudCache.projects)) {
                const cloudProjects = window._adminCloudCache.projects.filter(p => (p.user_id || p.userId) === userId);
                if (cloudProjects.length > 0) {
                    cloudProjects.forEach(p => {
                        const d = p.data || {};
                        const normalized = {
                            id: p.id,
                            name: p.name || p.title || d.name || d.title || 'Sin nombre',
                            crop_type: d.crop_type || d.cultivo || 'N/A',
                            variedad: d.variedad || d.variety || '',
                            location: d.location,
                            chat_history: d.chat_history || [],
                            chat_messages: (d.chat_history && Array.isArray(d.chat_history)) ? d.chat_history.length : 0,
                            created_at: p.created_at || d.created_at,
                            updated_at: p.updated_at || d.updated_at,
                            sections: d.sections ? Object.keys(d.sections).filter(s => d.sections[s] && Object.keys(d.sections[s]).length > 0) : []
                        };
                        if (!processedIds.has(normalized.id)) {
                            processedIds.add(normalized.id);
                            projects.push(normalized);
                        }
                    });
                }
            }
            
            // Resolver identidad de usuario de forma estable (mismo email puede existir con varias claves: admin/uuid)
            var userKey = 'nutriplant_user_' + userId;
            var userValue = localStorage.getItem(userKey);
            var userProfile = null;
            if (userValue && (userValue.startsWith('{') || userValue.startsWith('['))) {
                try { userProfile = JSON.parse(userValue); } catch (e) { userProfile = null; }
            }
            if (!userProfile || typeof userProfile !== 'object') {
                userKey = null;
                userValue = null;
            }
            // Fallback por email (si userId no coincide con la clave real del perfil)
            if (!userProfile && userEmail) {
                var emailLower = (userEmail + '').toLowerCase();
                for (var ui = 0; ui < localStorage.length; ui++) {
                    var uk = localStorage.key(ui);
                    if (!uk || !uk.startsWith('nutriplant_user_') || uk.indexOf('_email_') !== -1 || uk.indexOf('_project_') !== -1) continue;
                    try {
                        var uv = localStorage.getItem(uk);
                        if (!uv || !uv.startsWith('{')) continue;
                        var u = JSON.parse(uv);
                        if (u && (u.email || '').toLowerCase() === emailLower) {
                            userKey = uk;
                            userValue = uv;
                            userProfile = u;
                            break;
                        }
                    } catch (e) { continue; }
                }
            }
            // Si no se encontr√≥ perfil, seguir con identidad m√≠nima para no alternar resultados
            if (!userProfile || typeof userProfile !== 'object') {
                userProfile = { email: userEmail || '', name: '', projects: [] };
            }
            if (!userProfile.projects || !Array.isArray(userProfile.projects)) userProfile.projects = [];

            // Conjunto de identidades equivalentes (ids/emails/proyectos) para evitar que "a veces s√≠ y a veces no"
            const identityUserIds = new Set();
            const identityEmails = new Set();
            const identityProjectIds = new Set();
            if (userId) identityUserIds.add(userId);
            if (userEmail) identityEmails.add((userEmail + '').toLowerCase());
            if (userProfile.email) identityEmails.add((userProfile.email + '').toLowerCase());
            userProfile.projects.forEach(function(pid) { identityProjectIds.add(pid); });
            for (var ui2 = 0; ui2 < localStorage.length; ui2++) {
                var uk2 = localStorage.key(ui2);
                if (!uk2 || !uk2.startsWith('nutriplant_user_') || uk2.indexOf('_email_') !== -1 || uk2.indexOf('_project_') !== -1) continue;
                try {
                    var uv2 = localStorage.getItem(uk2);
                    if (!uv2 || !uv2.startsWith('{')) continue;
                    var u2 = JSON.parse(uv2);
                    if (!u2 || typeof u2 !== 'object') continue;
                    var uid2 = uk2.replace('nutriplant_user_', '');
                    var em2 = (u2.email || '').toLowerCase();
                    var sameIdentity = identityUserIds.has(uid2) || (em2 && identityEmails.has(em2));
                    if (!sameIdentity) continue;
                    identityUserIds.add(uid2);
                    if (em2) identityEmails.add(em2);
                    if (Array.isArray(u2.projects)) u2.projects.forEach(function(pid) { identityProjectIds.add(pid); });
                } catch (e) { continue; }
            }
            
            let userProjectsDirty = false;
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                // Aceptar formato nuevo y legacy
                const isProjectKey = key && (key.startsWith('nutriplant_project_') || key.startsWith('nutriplant-project-'));
                if (!isProjectKey) continue;
                
                try {
                    const projectValue = localStorage.getItem(key);
                    // Verificar que el valor sea JSON v√°lido
                    if (!projectValue || (!projectValue.startsWith('{') && !projectValue.startsWith('['))) {
                        continue; // No es JSON v√°lido, saltar
                    }
                    const project = JSON.parse(projectValue);
                    
                    // üîí Obtener el ID del proyecto (de la clave o del objeto)
                    const projectIdFromKey = key.replace(/^nutriplant[-_]project[-_]/, '');
                    const projectId = project.id || projectIdFromKey;
                    
                    // üîí DEDUPLICACI√ìN: Verificar si ya procesamos este ID
                    if (processedIds.has(projectId)) {
                        continue; // Saltar este proyecto si ya fue procesado
                    }
                    
                    // Verificar si este proyecto pertenece al usuario
                    const projectUserId = project.user_id || project.userId;
                    const projectUserEmail = project.user_email || project.userEmail;
                    const projectUserName = project.user_name || project.userName;
                    const userName = userProfile.name || '';
                    const isInUserList = userProfile.projects.includes(projectId) || identityProjectIds.has(projectId);
                    
                    // Detectar proyectos "vac√≠os" (sin datos reales)
                    const isNonEmptyString = (value) => typeof value === 'string' && value.trim() !== '';
                    const isValidDateValue = (value) => {
                        if (!value) return false;
                        const date = new Date(value);
                        return !Number.isNaN(date.getTime());
                    };
                    const hasMeaningfulName = isNonEmptyString(project.name) || isNonEmptyString(project.title);
                    const hasMeaningfulCrop = isNonEmptyString(project.crop_type) || isNonEmptyString(project.cultivo);
                    const hasMeaningfulDates = isValidDateValue(project.created_at) || isValidDateValue(project.updated_at);
                    const hasChat = Array.isArray(project.chat_history) && project.chat_history.length > 0;
                    const hasSections = project.sections && typeof project.sections === 'object' && Object.keys(project.sections).some(section => 
                        project.sections[section] && Object.keys(project.sections[section]).length > 0
                    );
                    const hasMeaningfulData = hasMeaningfulName || hasMeaningfulCrop || hasMeaningfulDates || hasChat || hasSections;
                    
                    // Si el proyecto est√° en la lista del usuario pero tiene owner distinto, limpiar
                    if (isInUserList && projectUserId && !identityUserIds.has(projectUserId)) {
                        userProfile.projects = userProfile.projects.filter(id => id !== projectId);
                        userProjectsDirty = true;
                        continue;
                    }
                    if (isInUserList && projectUserEmail && identityEmails.size > 0 && !identityEmails.has((projectUserEmail + '').toLowerCase())) {
                        userProfile.projects = userProfile.projects.filter(id => id !== projectId);
                        userProjectsDirty = true;
                        continue;
                    }
                    if (isInUserList && projectUserName && userName && projectUserName !== userName) {
                        userProfile.projects = userProfile.projects.filter(id => id !== projectId);
                        userProjectsDirty = true;
                        continue;
                    }
                    
                    const hasOwnerMatch = (projectUserId && identityUserIds.has(projectUserId)) || (projectUserEmail && identityEmails.has((projectUserEmail + '').toLowerCase()));
                    let belongsToUser = hasOwnerMatch || (isInUserList && hasMeaningfulData);
                    
                    // Si no hay owner y el proyecto est√° vac√≠o, sacarlo del usuario
                    if (isInUserList && !hasOwnerMatch && !projectUserName && !projectUserEmail && !projectUserId && !hasMeaningfulData) {
                        userProfile.projects = userProfile.projects.filter(id => id !== projectId);
                        userProjectsDirty = true;
                        continue;
                    }
                    
                    // üîÑ RECUPERACI√ìN AUTOM√ÅTICA: Si el proyecto tiene el owner correcto pero no est√° en el array, agregarlo
                    if (hasOwnerMatch && !isInUserList) {
                        userProfile.projects.push(projectId);
                        userProjectsDirty = true;
                        console.log(`‚úÖ Proyecto "${projectId}" restaurado autom√°ticamente al usuario ${userId}`);
                    }
                    
                    if (belongsToUser) {
                        // Marcar este ID como procesado antes de agregarlo
                        processedIds.add(projectId);
                        
                        projects.push({
                            id: projectId,
                            name: project.name,
                            crop_type: project.crop_type,
                            variedad: project.variedad || '',
                            location: project.location,
                            chat_messages: (project.chat_history && Array.isArray(project.chat_history)) ? project.chat_history.length : 0,
                            created_at: project.created_at,
                            updated_at: project.updated_at,
                            sections: (project.sections && typeof project.sections === 'object') ? Object.keys(project.sections).filter(section =>
                                Object.keys(project.sections[section]).length > 0
                            ) : []
                        });
                    }
                } catch (e) {
                    // Ignorar errores de parseo para valores no JSON
                    console.warn('‚ö†Ô∏è Error parseando proyecto:', key, e.message);
                    continue;
                }
            }
            
            if (userProjectsDirty && userKey) {
                try {
                    localStorage.setItem(userKey, JSON.stringify(userProfile));
                } catch (e) {
                    console.warn('‚ö†Ô∏è No se pudo actualizar el array de proyectos del usuario:', userId, e.message);
                }
            }
            
            return projects;
        }
        
        function showUserStats() {
            const users = getAllUsers();
            const stats = {
                total: users.length,
                withProjects: users.filter(u => (u.projects_count || 0) > 0).length,
                recent: users.filter(u => {
                    if (!u.last_login) return false;
                    try {
                    const lastLogin = new Date(u.last_login);
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    return lastLogin > thirtyDaysAgo;
                    } catch (e) {
                        return false;
                    }
                }).length
            };
            alert(`Estad√≠sticas de Usuarios:\n\nTotal: ${stats.total}\nCon proyectos: ${stats.withProjects}\nActivos (30 d√≠as): ${stats.recent}`);
        }
        
        function showSoilAnalysis() {
            const soilData = getSoilAnalysisData();
            console.table(soilData);
            alert(`Se encontraron ${soilData.length} an√°lisis de suelo. Revisa la consola para ver los detalles.`);
        }
        
        function showNutritionPrograms() {
            const nutritionData = getNutritionProgramsData();
            console.table(nutritionData);
            alert(`Se encontraron ${nutritionData.length} programas de nutrici√≥n. Revisa la consola para ver los detalles.`);
        }
        
        function showFertigationPrograms() {
            const nutritionData = getNutritionProgramsData();
            const fertigationData = nutritionData.filter(n => n.program_type === 'fertirriego');
            console.table(fertigationData);
            alert(`Se encontraron ${fertigationData.length} programas de fertirriego. Revisa la consola para ver los detalles.`);
        }
        
        function showCropStats() {
            const projects = getAllProjects();
            const cropStats = {};
            projects.forEach(project => {
                cropStats[project.crop_type] = (cropStats[project.crop_type] || 0) + 1;
            });
            console.table(cropStats);
            alert('Estad√≠sticas por cultivo cargadas. Revisa la consola para ver los detalles.');
        }
        
        function generateReport() {
            const chatM = getChatMetrics();
            const report = {
                fecha: new Date().toISOString(),
                usuarios_totales: getTotalUsers(),
                proyectos_totales: getTotalProjects(),
                mensajes_chat: chatM.totalMessages,
                interacciones_ia: chatM.totalInteractions,
                costo_estimado_chat_usd: chatM.estimatedCostUSD.toFixed(4),
                usuarios_activos: getActiveUsers(),
                analisis_suelo: getSoilAnalysisData().length,
                programas_nutricion: getNutritionProgramsData().length
            };
            console.log('üìä Reporte completo:', report);
            alert('Reporte generado. Revisa la consola para ver todos los datos.');
        }
        
        function exportSoilData() {
            const soilData = getSoilAnalysisData();
            const csv = convertToCSV(soilData);
            downloadCSV(csv, 'analisis_suelos_nutriplant.csv');
        }
        
        function exportNutritionData() {
            const nutritionData = getNutritionProgramsData();
            const csv = convertToCSV(nutritionData);
            downloadCSV(csv, 'programas_nutricion_nutriplant.csv');
        }
        
        function showSoilStats() {
            const soilData = getSoilAnalysisData();
            alert(`Estad√≠sticas de An√°lisis de Suelos:\n\nTotal de an√°lisis: ${soilData.length}\n\nRevisa la consola para ver los detalles completos.`);
            console.table(soilData);
        }
        
        // üí≥ FUNCIONES DE GESTI√ìN DE SUSCRIPCIONES
        /** Suscriptores que se registraron en el mes en curso. */
        function showNewSubscribersThisMonth() {
            const users = getAllUsers();
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
            const newThisMonth = users.filter(u => {
                const created = u.created_at;
                if (!created) return false;
                const d = new Date(created);
                return !isNaN(d.getTime()) && d >= startOfMonth && d <= endOfMonth;
            });
            const monthName = startOfMonth.toLocaleDateString('es-MX', { month: 'long', year: 'numeric' });
            showDataViewerWithFilters({
                title: 'üÜï Suscriptores nuevos este mes (' + monthName + ')',
                data: newThisMonth,
                previousView: showNewSubscribersThisMonth,
                previousViewParams: [],
                columns: [
                    { key: 'name', label: 'Nombre', format: 'text', filterable: true },
                    { key: 'email', label: 'Email', format: 'text', filterable: true },
                    { key: 'phone', label: 'Tel√©fono', format: 'text', filterable: true },
                    { key: 'location', label: 'Ubicaci√≥n', format: 'location', filterable: true },
                    { key: 'profession', label: 'Profesi√≥n', format: 'text', filterable: true },
                    { key: 'crops', label: 'Cultivos', format: 'array', filterable: true },
                    { key: 'subscription_status', label: 'Suscripci√≥n', format: 'status', filterable: true },
                    { key: 'subscription_amount', label: 'Monto (cada 5 meses)', format: 'currency', filterable: false },
                    { key: 'created_at', label: 'Fecha de Registro', format: 'date', filterable: true }
                ],
                actions: {
                    edit: true,
                    delete: true
                }
            });
        }
        
        function showActiveSubscribers() {
            const users = getAllUsers();
            const activeUsers = users.filter(u => u.subscription_status === 'active');
            showDataViewerWithFilters({
                title: '‚úÖ Suscriptores Activos',
                data: activeUsers,
                previousView: showActiveSubscribers,
                previousViewParams: [],
                columns: [
                    { key: 'name', label: 'Nombre', format: 'text', filterable: true },
                    { key: 'email', label: 'Email', format: 'text', filterable: true },
                    { key: 'phone', label: 'Tel√©fono', format: 'text', filterable: true },
                    { key: 'location', label: 'Ubicaci√≥n', format: 'location', filterable: true },
                    { key: 'profession', label: 'Profesi√≥n', format: 'text', filterable: true },
                    { key: 'crops', label: 'Cultivos', format: 'array', filterable: true },
                    { key: 'projects_count', label: 'Proyectos', format: 'text', filterable: true },
                    { key: 'subscription_amount', label: 'Monto', format: 'currency', filterable: false },
                    { key: 'last_payment_date', label: '√öltimo Pago', format: 'date', filterable: true },
                    { key: 'next_payment_date', label: 'Pr√≥ximo Pago', format: 'date', filterable: true },
                    { key: 'created_at', label: 'Fecha de Registro', format: 'date', filterable: true }
                ],
                actions: {
                    edit: true,
                    delete: true
                }
            });
        }
        
        function showPendingSubscribers() {
            const users = getAllUsers();
            const pendingUsers = users.filter(u => u.subscription_status === 'pending');
            showDataViewerWithFilters({
                title: '‚è≥ Suscripciones Pendientes',
                data: pendingUsers,
                previousView: showPendingSubscribers,
                previousViewParams: [],
                columns: [
                    { key: 'name', label: 'Nombre', format: 'text', filterable: true },
                    { key: 'email', label: 'Email', format: 'text', filterable: true },
                    { key: 'phone', label: 'Tel√©fono', format: 'text', filterable: true },
                    { key: 'location', label: 'Ubicaci√≥n', format: 'location', filterable: true },
                    { key: 'profession', label: 'Profesi√≥n', format: 'text', filterable: true },
                    { key: 'crops', label: 'Cultivos', format: 'array', filterable: true },
                    { key: 'projects_count', label: 'Proyectos', format: 'text', filterable: true },
                    { key: 'subscription_amount', label: 'Monto', format: 'currency', filterable: false },
                    { key: 'created_at', label: 'Fecha de Registro', format: 'date', filterable: true }
                ],
                actions: {
                    edit: true,
                    delete: true
                }
            });
        }
        
        function showSubscriptionsOverview() {
            const users = getAllUsers();
            const overview = {
                total: users.length,
                active: users.filter(u => u.subscription_status === 'active').length,
                pending: users.filter(u => u.subscription_status === 'pending').length,
                cancelled: users.filter(u => u.subscription_status === 'cancelled').length,
                expired: users.filter(u => u.subscription_status === 'expired').length,
                totalRevenuePerCycle: users
                    .filter(u => u.subscription_status === 'active')
                    .reduce((sum, u) => sum + (parseFloat(u.subscription_amount) || 0), 0)
            };
            const CICLOS_POR_ANIO = 12 / 5;
            const equivAnual = overview.totalRevenuePerCycle * CICLOS_POR_ANIO;
            
            const html = `
                <div style="padding: 24px;">
                    <h2 style="margin: 0 0 24px 0; color: #1e293b; font-size: 24px;">üí≥ Resumen de Suscripciones (cada 5 meses)</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                        <div style="background: #f8fafc; padding: 20px; border-radius: 8px; border-left: 4px solid #60a5fa;">
                            <div style="font-size: 32px; font-weight: bold; color: #1e293b;">${overview.total}</div>
                            <div style="color: #64748b; margin-top: 8px;">Total Suscriptores</div>
                        </div>
                        <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; border-left: 4px solid #10b981;">
                            <div style="font-size: 32px; font-weight: bold; color: #1e293b;">${overview.active}</div>
                            <div style="color: #64748b; margin-top: 8px;">‚úÖ Activas</div>
                        </div>
                        <div style="background: #fef3c7; padding: 20px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                            <div style="font-size: 32px; font-weight: bold; color: #1e293b;">${overview.pending}</div>
                            <div style="color: #64748b; margin-top: 8px;">‚è≥ Pendientes</div>
                        </div>
                        <div style="background: #fef2f2; padding: 20px; border-radius: 8px; border-left: 4px solid #ef4444;">
                            <div style="font-size: 32px; font-weight: bold; color: #1e293b;">${overview.cancelled}</div>
                            <div style="color: #64748b; margin-top: 8px;">‚ùå Canceladas</div>
                        </div>
                        <div style="background: #f3f4f6; padding: 20px; border-radius: 8px; border-left: 4px solid #6b7280;">
                            <div style="font-size: 32px; font-weight: bold; color: #1e293b;">${overview.expired}</div>
                            <div style="color: #64748b; margin-top: 8px;">‚è∞ Expiradas</div>
                        </div>
                        <div style="background: #eff6ff; padding: 20px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                            <div style="font-size: 32px; font-weight: bold; color: #1e293b;">$${overview.totalRevenuePerCycle.toFixed(2)} USD</div>
                            <div style="color: #64748b; margin-top: 8px;">üí∞ Por ciclo (cada 5 meses)</div>
                            <div style="color: #94a3b8; font-size: 13px; margin-top: 4px;">Equiv. anual: $${equivAnual.toFixed(2)} USD</div>
                        </div>
                    </div>
                    <button onclick="closeDataViewer()" style="padding: 12px 24px; background: #60a5fa; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Cerrar</button>
                </div>
            `;
            
            const modal = document.getElementById('dataViewerModal');
            const content = document.getElementById('dataViewerContent');
            if (modal && content) {
                content.innerHTML = html;
                modal.style.display = 'flex';
                if (fertiChartIds && typeof renderAdminFertirriegoCharts === 'function') {
                    const tryRender = () => {
                        const macroEl = document.getElementById(fertiChartIds.macroWrapId) || document.getElementById(fertiChartIds.macroId) || content.querySelector('[id^="adminFertiMacroChartWrap_"]');
                        const microEl = document.getElementById(fertiChartIds.microWrapId) || document.getElementById(fertiChartIds.microId) || content.querySelector('[id^="adminFertiMicroChartWrap_"]');
                        renderAdminFertirriegoCharts(fertirriegoProgram, fertiChartIds, project, { macroEl, microEl });
                    };
                    tryRender();
                    requestAnimationFrame(tryRender);
                    setTimeout(tryRender, 50);
                    setTimeout(tryRender, 200);
                }
            }
        }
        
        function showExpiredSubscriptions() {
            const users = getAllUsers();
            const expiredUsers = users.filter(u => u.subscription_status === 'expired');
            showDataViewerWithFilters({
                title: '‚è∞ Suscripciones Expiradas (cada 5 meses)',
                data: expiredUsers,
                columns: [
                    { key: 'name', label: 'Nombre', format: 'text', filterable: true },
                    { key: 'email', label: 'Email', format: 'text', filterable: true },
                    { key: 'phone', label: 'Tel√©fono', format: 'text', filterable: true },
                    { key: 'subscription_amount', label: 'Monto (cada 5 meses)', format: 'currency', filterable: false },
                    { key: '_expired_at', label: 'Fecha de Expiraci√≥n', format: 'date', filterable: true },
                    { key: 'created_at', label: 'Fecha de Registro', format: 'date', filterable: true }
                ],
                actions: {
                    edit: true,
                    delete: true
                }
            });
        }
        
        function showCancelledSubscriptions() {
            const users = getAllUsers();
            const cancelledUsers = users.filter(u => u.subscription_status === 'cancelled');
            showDataViewerWithFilters({
                title: '‚ùå Suscripciones Canceladas (cada 5 meses)',
                data: cancelledUsers,
                columns: [
                    { key: 'name', label: 'Nombre', format: 'text', filterable: true },
                    { key: 'email', label: 'Email', format: 'text', filterable: true },
                    { key: 'phone', label: 'Tel√©fono', format: 'text', filterable: true },
                    { key: 'subscription_amount', label: 'Monto (cada 5 meses)', format: 'currency', filterable: false },
                    { key: '_cancelled_at', label: 'Fecha de Cancelaci√≥n', format: 'date', filterable: true },
                    { key: 'created_at', label: 'Fecha de Registro', format: 'date', filterable: true }
                ],
                actions: {
                    edit: true,
                    delete: true
                }
            });
        }
        
        function showSubscriptionRevenue() {
            const users = getAllUsers();
            const activeUsers = users.filter(u => u.subscription_status === 'active');
            // Suscripci√≥n cada 5 meses: el monto guardado es por ciclo (5 meses). Equivalente anual = monto * (12/5).
            const CICLOS_POR_ANIO = 12 / 5;
            const totalPorCiclo = activeUsers.reduce((sum, u) => sum + (parseFloat(u.subscription_amount) || 0), 0);
            const totalEquivalenteAnual = totalPorCiclo * CICLOS_POR_ANIO;
            
            const revenueData = activeUsers.map(u => {
                const amount = parseFloat(u.subscription_amount) || 0;
                const lastD = u.last_payment_date;
                const nextD = u.next_payment_date;
                return {
                    name: u.name,
                    email: u.email,
                    cycle_amount: amount,
                    equivalent_annual: amount * CICLOS_POR_ANIO,
                    last_payment: (lastD && !isNaN(new Date(lastD).getTime())) ? lastD : null,
                    next_payment: (nextD && !isNaN(new Date(nextD).getTime())) ? nextD : null
                };
            });
            
            showDataViewerWithFilters({
                title: 'üí∞ Ingresos por Suscripci√≥n (cada 5 meses)',
                data: revenueData,
                columns: [
                    { key: 'name', label: 'Nombre', format: 'text', filterable: true },
                    { key: 'email', label: 'Email', format: 'text', filterable: true },
                    { key: 'cycle_amount', label: 'Cada 5 meses', format: 'currency', filterable: false },
                    { key: 'equivalent_annual', label: 'Equiv. anual', format: 'currency', filterable: false },
                    { key: 'last_payment', label: '√öltimo Pago', format: 'date', filterable: true },
                    { key: 'next_payment', label: 'Pr√≥ximo Pago', format: 'date', filterable: true }
                ],
                actions: {
                    edit: false,
                    delete: false
                }
            });
        }
    </script>
    
    <!-- Modal para visualizar/editar datos -->
    <div id="dataViewerModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; overflow-y: auto;">
        <div class="modal-content" style="background: white; margin: 20px auto; max-width: 95%; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <div id="dataViewerContent"></div>
        </div>
    </div>
    
    <!-- Modal para editar usuario -->
    <div id="editUserModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001; overflow-y: auto;">
        <div class="modal-content" style="background: white; margin: 20px auto; max-width: 700px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); padding: 24px;">
            <div id="editUserContent"></div>
        </div>
    </div>
    
    <!-- Modal para editar proyecto -->
    <div id="editProjectModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10002; overflow-y: auto;">
        <div class="modal-content" style="background: white; margin: 20px auto; max-width: 700px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); padding: 24px;">
            <div id="editProjectContent"></div>
        </div>
    </div>
    
    <script>
        // Paginaci√≥n: m√°ximo filas por p√°gina para no sobrecargar con cientos de usuarios/mensajes
        const DATA_VIEWER_PAGE_SIZE = 200;
        function goToDataViewerPage(pageNum) {
            var state = window._dataViewerState;
            if (!state || !state.data || !state.config) return;
            var total = state.data.length;
            var pageSize = state.pageSize || DATA_VIEWER_PAGE_SIZE;
            var totalPages = Math.max(1, Math.ceil(total / pageSize));
            var page = Math.max(1, Math.min(pageNum, totalPages));
            state.page = page;
            var start = (page - 1) * pageSize;
            var slice = state.data.slice(start, start + pageSize);
            var tbody = document.getElementById('dataTableBody');
            var paginationEl = document.getElementById('dataViewerPagination');
            if (!tbody || !paginationEl) return;
            var config = state.config;
            var rowsHtml = slice.map(function(item, i) { return buildDataViewerRow(item, start + i, config); }).join('');
            tbody.innerHTML = rowsHtml;
            var end = Math.min(start + pageSize, total);
            paginationEl.innerHTML = 'Mostrando ' + (start + 1) + '-' + end + ' de ' + total +
                ' &nbsp;|&nbsp; <button type="button" onclick="goToDataViewerPage(1)"' + (page === 1 ? ' disabled' : '') + ' style="margin:0 4px;padding:6px 10px;border-radius:6px;border:1px solid #e2e8f0;background:#fff;cursor:pointer;">Primera</button>' +
                ' <button type="button" onclick="goToDataViewerPage(' + (page - 1) + ')"' + (page === 1 ? ' disabled' : '') + ' style="margin:0 4px;padding:6px 10px;border-radius:6px;border:1px solid #e2e8f0;background:#fff;cursor:pointer;">Anterior</button>' +
                ' <span style="margin:0 8px;">P√°gina ' + page + ' de ' + totalPages + '</span>' +
                ' <button type="button" onclick="goToDataViewerPage(' + (page + 1) + ')"' + (page === totalPages ? ' disabled' : '') + ' style="margin:0 4px;padding:6px 10px;border-radius:6px;border:1px solid #e2e8f0;background:#fff;cursor:pointer;">Siguiente</button>' +
                ' <button type="button" onclick="goToDataViewerPage(' + totalPages + ')"' + (page === totalPages ? ' disabled' : '') + ' style="margin:0 4px;padding:6px 10px;border-radius:6px;border:1px solid #e2e8f0;background:#fff;cursor:pointer;">√öltima</button>';
        }
        function buildDataViewerRow(item, index, config) {
            var html = '<tr data-index="' + index + '" style="border-bottom: 1px solid #e5e7eb;">';
            config.columns.forEach(function(col) {
                var value = item[col.key];
                var displayValue = '';
                if (col.format === 'location') {
                    // Ubicaci√≥n del usuario (registro: localidad, estado/provincia, pa√≠s). No confundir con ubicaci√≥n del proyecto.
                    if (typeof value === 'string' && value.trim()) {
                        displayValue = value.trim();
                    } else if (value && typeof value === 'object') {
                        var parts = [value.city, value.state, value.country].filter(Boolean);
                        if (parts.length === 0) parts = [value.locality, value.state_province, value.country].filter(Boolean);
                        if (parts.length === 0 && value.postal) parts.push(value.postal);
                        displayValue = parts.length ? parts.join(', ') : 'No especificado';
                    } else {
                        displayValue = 'No especificado';
                    }
                } else if (col.format === 'array' && Array.isArray(value)) {
                    var items = value.filter(Boolean);
                    displayValue = items.length === 0 ? 'Ninguno' : (items.length <= 2 ? items.join(', ') : items.slice(0, 2).join(', ') + ' +' + (items.length - 2));
                } else if (col.format === 'date' && value) {
                    try { displayValue = new Date(value).toLocaleDateString('es-MX'); } catch (e) { displayValue = value; }
                } else if (col.format === 'status') {
                    var statusMap = { 'active': '‚úÖ Activa', 'cancelled': '‚ùå Cancelada', 'expired': '‚è∞ Expirada', 'pending': '‚è≥ Pendiente', 'inactive': '‚ùå Inactiva', 'suspended': '‚è∏Ô∏è Suspendida', 'unknown': '‚ùì Desconocido' };
                    displayValue = statusMap[value] || value;
                } else if (col.format === 'currency') {
                    var amount = parseFloat(value || 0);
                    displayValue = amount === 0 ? 'Sin suscripci√≥n' : ('$' + amount.toFixed(2) + ' USD');
                } else if (col.format === 'password') {
                    if (value && String(value).trim()) {
                        displayValue = value;
                    } else {
                        var isUuid = item.id && /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(String(item.id));
                        displayValue = isUuid ? '‚Äî (asignar en Editar)' : 'Sin contrase√±a';
                    }
                } else if (col.key === 'active_sections_count') {
                    displayValue = (parseInt(value, 10) || 0).toString();
                    var sw = item.section_weights;
                    if (sw && typeof sw === 'object' && config.isProject) {
                        var labels = { 0: '‚Äî', 1: 'bajo', 2: 'medio', 3: 'alto' };
                        var parts = [];
                        Object.keys(sw).forEach(function(k) { if (sw[k] > 0) parts.push(k + ': ' + (labels[sw[k]] || sw[k])); });
                        if (parts.length) tooltip = ' title="Uso real por secci√≥n: ' + (parts.join(' | ').replace(/"/g, '&quot;')) + '"';
                        displayValue = displayValue + ' üìä';
                    }
                } else if (col.key === 'projects_count') { displayValue = (parseInt(value, 10) || 0).toString();
                } else { displayValue = value || 'N/A'; }
                var tooltip = (col.format === 'array' && Array.isArray(value) && value.length > 0) ? ' title="' + (value.join(', ').replace(/"/g, '&quot;')) + '"' : '';
                if (col.format === 'password' && (!value || !String(value).trim())) {
                    tooltip = ' title="La contrase√±a se guarda al registrarse. Si no aparece, asigna una en Editar usuario."';
                }
                var cellContent = (displayValue + '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                var cellStyle = 'padding: 12px; color: #374151; font-size: 14px; max-width: 280px;';
                if (col.key === 'content') {
                    var hasFull = item.content_full != null && item.content_full !== '';
                    cellContent = '<div style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-bottom:4px;">' + cellContent + '</div>';
                    if (hasFull || (item.content != null && item.content !== '')) {
                        cellContent += '<a href="#" onclick="showFullContentModal(' + index + '); return false;" style="font-size:12px;color:#2563eb;white-space:nowrap;">Ver completo</a>';
                    }
                    cellStyle += ' white-space: normal;';
                } else {
                    cellStyle += ' white-space: nowrap; overflow: hidden; text-overflow: ellipsis;';
                }
                html += '<td style="' + cellStyle + '" data-key="' + col.key + '"' + tooltip + '>' + cellContent + '</td>';
            });
            if (config.actions && (config.actions.edit || config.actions.delete)) {
                var isProject = config.isProject === true;
                var itemId = isProject ? (item.id || index) : (item.id || item.userId || index);
                html += '<td style="padding: 12px; text-align: center;"><div style="display: flex; gap: 8px; justify-content: center;">';
                if (config.actions.edit) {
                    if (isProject) {
                        var safeId = (itemId + '').replace(/\\/g, '\\\\').replace(/'/g, "\\'");
                        var viewProjCall = config.previousViewForProject ? ('viewProjectDetailsWithReturn(\'' + safeId + '\', \'' + (config.previousViewForProject + '').replace(/'/g, "\\'") + '\')') : ('viewProjectDetails(\'' + safeId + '\')');
                        html += '<button onclick="' + viewProjCall + '" style="background: #10b981; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">üëÅÔ∏è Ver</button><button onclick="editProject(\'' + safeId + '\')" style="background: #60a5fa; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">‚úèÔ∏è Editar</button>';
                    } else {
                        var prevCall = config.previousView ? ('viewUserDetails(\'' + itemId + '\', ' + (config.previousView.name || 'null') + ', ' + JSON.stringify(config.previousViewParams || []) + ')') : ('viewUserDetails(\'' + itemId + '\')');
                        html += '<button onclick="' + prevCall + '" style="background: #10b981; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">üëÅÔ∏è Ver</button><button onclick="editUser(\'' + itemId + '\')" style="background: #60a5fa; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">‚úèÔ∏è Editar</button>';
                    }
                }
                if (config.actions.delete) {
                    if (isProject) {
                        if (item._isOrphan) html += '<button onclick="assignProjectToUser(\'' + itemId + '\')" style="background: #8b5cf6; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">üîó Asignar</button>';
                        html += '<button onclick="deleteProject(\'' + itemId + '\')" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">üóëÔ∏è Eliminar</button>';
                    } else {
                        html += '<button onclick="deleteUser(\'' + itemId + '\')" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">üóëÔ∏è Eliminar</button>';
                    }
                }
                html += '</div></td>';
            }
            html += '</tr>';
            return html;
        }

        // Funci√≥n para mostrar datos en tabla con filtros
        function showDataViewerWithFilters(config) {
            // Guardar vista anterior si se proporciona en la configuraci√≥n
            if (config.previousView) {
                setPreviousView(config.previousView, config.previousViewParams || []);
            }
            const modal = document.getElementById('dataViewerModal');
            const content = document.getElementById('dataViewerContent');
            
            if (!modal || !content) {
                console.error('Modal de visualizaci√≥n no encontrado');
                return;
            }

            var usePagination = config.data.length > DATA_VIEWER_PAGE_SIZE;
            window._dataViewerState = { data: config.data, config: config, page: 1, pageSize: DATA_VIEWER_PAGE_SIZE };
            var dataToShow = usePagination ? config.data.slice(0, DATA_VIEWER_PAGE_SIZE) : config.data;
            
            // Construir HTML de la tabla con filtros
            let html = `
                <div style="padding: 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0; color: #1e293b; font-size: 24px;">${config.title}</h2>
                        <button onclick="closeDataViewer()" style="background: none; border: none; font-size: 24px; color: #64748b; cursor: pointer; padding: 4px 12px;">√ó</button>
                    </div>
                    
                    <div style="margin-bottom: 20px; padding: 16px; background: #f8fafc; border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
            `;
            
            // Agregar filtros por columna
            config.columns.forEach(col => {
                if (col.filterable) {
                    html += `
                        <div>
                            <label style="display: block; font-size: 12px; color: #64748b; margin-bottom: 4px; font-weight: 500;">${col.label}</label>
                            <input type="text" 
                                   id="filter-${col.key}" 
                                   placeholder="Filtrar ${col.label}..." 
                                   onkeyup="filterTable('${col.key}', this.value)"
                                   style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                        </div>
                    `;
                }
            });
            
            html += `
                        </div>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table id="dataTable" style="width: 100%; border-collapse: collapse; background: white;">
                            <thead>
                                <tr style="background: #f8fafc; border-bottom: 2px solid #e5e7eb;">
            `;
            
            // Encabezados de columnas
            config.columns.forEach(col => {
                html += `<th style="padding: 12px; text-align: left; font-weight: 600; color: #1e293b; font-size: 14px;">${col.label}</th>`;
            });
            
            if (config.actions && config.actions.edit) {
                html += `<th style="padding: 12px; text-align: center; font-weight: 600; color: #1e293b; font-size: 14px;">Acciones</th>`;
            }
            
            html += `
                                </tr>
                            </thead>
                            <tbody id="dataTableBody">
            `;
            
            // Filas de datos (solo una p√°gina si hay muchas para no sobrecargar)
            dataToShow.forEach((item, index) => {
                html += buildDataViewerRow(item, index, config);
            });
            
            var total = config.data.length;
            var totalPages = Math.max(1, Math.ceil(total / DATA_VIEWER_PAGE_SIZE));
            var paginationHtml = usePagination
                ? ('<div id="dataViewerPagination" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb; text-align: center; color: #64748b; font-size: 14px;">' +
                    'Mostrando 1-' + Math.min(DATA_VIEWER_PAGE_SIZE, total) + ' de ' + total +
                    ' &nbsp;|&nbsp; <button type="button" onclick="goToDataViewerPage(1)" disabled style="margin:0 4px;padding:6px 10px;border-radius:6px;border:1px solid #e2e8f0;background:#fff;cursor:pointer;">Primera</button>' +
                    ' <button type="button" onclick="goToDataViewerPage(1)" disabled style="margin:0 4px;padding:6px 10px;border-radius:6px;border:1px solid #e2e8f0;background:#fff;cursor:pointer;">Anterior</button>' +
                    ' <span style="margin:0 8px;">P√°gina 1 de ' + totalPages + '</span>' +
                    ' <button type="button" onclick="goToDataViewerPage(2)"' + (totalPages <= 1 ? ' disabled' : '') + ' style="margin:0 4px;padding:6px 10px;border-radius:6px;border:1px solid #e2e8f0;background:#fff;cursor:pointer;">Siguiente</button>' +
                    ' <button type="button" onclick="goToDataViewerPage(' + totalPages + ')"' + (totalPages <= 1 ? ' disabled' : '') + ' style="margin:0 4px;padding:6px 10px;border-radius:6px;border:1px solid #e2e8f0;background:#fff;cursor:pointer;">√öltima</button>' +
                    '</div>')
                : ('<div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid #e5e7eb; text-align: center; color: #64748b; font-size: 14px;">Total: ' + total + ' registros</div>');
            
            html += `
                            </tbody>
                        </table>
                    </div>
                    ` + paginationHtml + `
                </div>
            `;
            
            content.innerHTML = html;
            modal.style.display = 'flex';
        }
        window.showDataViewerWithFilters = showDataViewerWithFilters;
        
        // üîô SISTEMA DE NAVEGACI√ìN HACIA ATR√ÅS
        let navigationHistory = {
            previousView: null,
            previousViewParams: null
        };
        
        // Variable temporal para guardar contexto durante la generaci√≥n de HTML
        let tempNavigationContext = null;
        
        function setPreviousView(viewFunction, params) {
            navigationHistory.previousView = viewFunction;
            navigationHistory.previousViewParams = params;
        }
        
        function goBack() {
            if (navigationHistory.previousView) {
                const func = navigationHistory.previousView;
                const params = navigationHistory.previousViewParams;
                if (typeof func === 'function') {
                    if (Array.isArray(params)) {
                        func(...params);
                    } else if (params) {
                        func(params);
                    } else {
                        func();
                    }
                }
            } else {
                // Si no hay vista anterior, cerrar el modal
                closeDataViewer();
            }
        }
        window.goBack = goBack;
        
        function closeDataViewer() {
            const modal = document.getElementById('dataViewerModal');
            if (modal) {
                modal.style.display = 'none';
            }
            // Limpiar historial al cerrar completamente
            navigationHistory.previousView = null;
            navigationHistory.previousViewParams = null;
        }
        window.closeDataViewer = closeDataViewer;

        /** Modal para ver el contenido completo de un mensaje (ej. en Todas las Conversaciones) */
        function showFullContentModal(rowIndex) {
            var state = window._dataViewerState;
            if (!state || !state.data || rowIndex == null || rowIndex < 0 || rowIndex >= state.data.length) return;
            var item = state.data[rowIndex];
            var fullText = (item && item.content_full != null) ? String(item.content_full) : (item && item.content != null) ? String(item.content) : '‚Äî';
            fullText = fullText.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>');
            var overlay = document.createElement('div');
            overlay.id = 'fullContentModalOverlay';
            overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:11000;display:flex;align-items:center;justify-content:center;padding:20px;';
            overlay.innerHTML = '<div style="background:#fff;border-radius:12px;max-width:560px;width:100%;max-height:80vh;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.2);display:flex;flex-direction:column;">' +
                '<div style="padding:16px 20px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">' +
                '<h3 style="margin:0;font-size:18px;color:#1e293b;">Contenido del mensaje</h3>' +
                '<button type="button" onclick="document.getElementById(\'fullContentModalOverlay\').remove()" style="background:none;border:none;font-size:24px;color:#64748b;cursor:pointer;padding:0 8px;">√ó</button></div>' +
                '<div style="padding:20px;overflow-y:auto;flex:1;font-size:14px;line-height:1.6;color:#374151;white-space:pre-wrap;word-break:break-word;">' + fullText + '</div>' +
                '<div style="padding:12px 20px;border-top:1px solid #e5e7eb;text-align:right;">' +
                '<button type="button" onclick="document.getElementById(\'fullContentModalOverlay\').remove()" style="padding:8px 20px;background:#3b82f6;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:500;">Cerrar</button></div></div>';
            overlay.addEventListener('click', function(e) { if (e.target === overlay) overlay.remove(); });
            document.body.appendChild(overlay);
        }
        window.showFullContentModal = showFullContentModal;
        
        // Funci√≥n para mostrar HTML personalizado en el visor de datos
        function showDataInViewer(htmlContent) {
            const modal = document.getElementById('dataViewerModal');
            const content = document.getElementById('dataViewerContent');
            
            if (!modal || !content) {
                console.error('‚ùå Modal de visualizaci√≥n no encontrado');
                alert('Error: No se puede mostrar la informaci√≥n. Por favor, recarga la p√°gina.');
                return;
            }
            
            // Envolver el contenido con un bot√≥n de cerrar
            const wrappedHtml = `
                <div style="padding: 24px; max-height: 85vh; overflow-y: auto;">
                    ${htmlContent}
                    <div style="display: flex; justify-content: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                        <button onclick="closeDataViewer()" style="padding: 12px 32px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
                            Cerrar
                        </button>
                    </div>
                </div>
            `;
            
            content.innerHTML = wrappedHtml;
            modal.style.display = 'flex';
            
            console.log('‚úÖ Datos mostrados en el visor');
        }
        window.showDataInViewer = showDataInViewer;
        
        function filterTable(columnKey, searchValue) {
            const tbody = document.getElementById('dataTableBody');
            if (!tbody) return;
            
            const rows = tbody.querySelectorAll('tr');
            const searchLower = searchValue.toLowerCase();
            
            rows.forEach(row => {
                const cell = row.querySelector(`td[data-key="${columnKey}"]`);
                if (cell) {
                    const cellText = cell.textContent.toLowerCase();
                    if (cellText.includes(searchLower)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                }
            });
        }
        window.filterTable = filterTable;
        
        // Funci√≥n para editar usuario
        function editUser(userId) {
            const users = getAllUsers();
            const user = users.find(u => (u.id === userId) || (u.userId === userId));
            
            if (!user) {
                alert('Usuario no encontrado');
                return;
            }
            
            const modal = document.getElementById('editUserModal');
            const content = document.getElementById('editUserContent');
            
            if (!modal || !content) {
                alert('Modal de edici√≥n no encontrado');
                return;
            }
            
            // üîê Verificar si es usuario administrador
            const isAdminUser = user.email === 'admin@nutriplantpro.com' || user.isAdmin === true;
            
            // Normalizar ubicaci√≥n: puede venir como string "Ciudad, Estado, Pa√≠s" o objeto con city/state/country o locality/state_province
            let location = user.location || {};
            if (typeof location === 'string' && location.trim()) {
                const parts = location.split(',').map(function(p) { return p.trim(); }).filter(Boolean);
                location = {
                    city: parts[0] || '',
                    state: parts[1] || '',
                    country: parts[2] || '',
                    postal: ''
                };
            } else if (location && typeof location === 'object') {
                location = {
                    country: location.country || '',
                    state: location.state || location.state_province || '',
                    city: location.city || location.locality || '',
                    postal: location.postal || location.postal_code || ''
                };
            } else {
                location = { country: '', state: '', city: '', postal: '' };
            }
            
            // Construir formulario de edici√≥n
            const crops = Array.isArray(user.crops) ? user.crops : [];
            const allCrops = ['Aguacate', 'Tomate', 'Pimiento', 'Pepino', 'Fresa', 'Lechuga', 'C√≠tricos', 'Uva', 'Ma√≠z', 'Otro'];
            
            let html = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h2 style="margin: 0; color: #1e293b; font-size: 24px;">‚úèÔ∏è Editar Usuario</h2>
                    <button onclick="closeEditUserModal()" style="background: none; border: none; font-size: 24px; color: #64748b; cursor: pointer; padding: 4px 12px;">√ó</button>
                </div>
                
                <form id="editUserForm" onsubmit="saveUserChanges(event, '${userId}')">
                    <div style="display: grid; gap: 16px;">
                        <!-- Nombre -->
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #374151;">Nombre Completo *</label>
                            <input type="text" id="edit-user-name" value="${escapeHtml(user.name || '')}" required 
                                   style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                        </div>
                        
                        <!-- Email -->
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #374151;">Correo Electr√≥nico *</label>
                            <input type="email" id="edit-user-email" value="${escapeHtml(user.email || '')}" required 
                                   style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                        </div>
                        
                        <!-- Tel√©fono -->
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #374151;">Tel√©fono</label>
                            <input type="tel" id="edit-user-phone" value="${escapeHtml(user.phone || '')}" 
                                   style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                        </div>
                        
                        <!-- Ubicaci√≥n -->
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #374151;">Ubicaci√≥n</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                                <input type="text" id="edit-user-country" placeholder="Pa√≠s" value="${escapeHtml(location.country || '')}" 
                                       style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                                <input type="text" id="edit-user-state" placeholder="Estado/Provincia" value="${escapeHtml(location.state || '')}" 
                                       style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                            </div>
                            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 12px;">
                                <input type="text" id="edit-user-city" placeholder="Ciudad" value="${escapeHtml(location.city || '')}" 
                                       style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                                <input type="text" id="edit-user-postal" placeholder="C√≥digo Postal" value="${escapeHtml(location.postal || '')}" 
                                       style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                            </div>
                        </div>
                        
                        <!-- Profesi√≥n -->
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #374151;">Profesi√≥n</label>
                            <select id="edit-user-profession" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                                <option value="">Selecciona una profesi√≥n</option>
                                <option value="Agr√≥nomo" ${user.profession === 'Agr√≥nomo' ? 'selected' : ''}>Agr√≥nomo</option>
                                <option value="Ingeniero Agr√≥nomo" ${user.profession === 'Ingeniero Agr√≥nomo' ? 'selected' : ''}>Ingeniero Agr√≥nomo</option>
                                <option value="T√©cnico Agr√≠cola" ${user.profession === 'T√©cnico Agr√≠cola' ? 'selected' : ''}>T√©cnico Agr√≠cola</option>
                                <option value="Productor" ${user.profession === 'Productor' ? 'selected' : ''}>Productor</option>
                                <option value="Asesor" ${user.profession === 'Asesor' ? 'selected' : ''}>Asesor</option>
                                <option value="Investigador" ${user.profession === 'Investigador' ? 'selected' : ''}>Investigador</option>
                                <option value="Estudiante" ${user.profession === 'Estudiante' ? 'selected' : ''}>Estudiante</option>
                                <option value="Otro" ${user.profession === 'Otro' ? 'selected' : ''}>Otro</option>
                            </select>
                        </div>
                        
                        <!-- Cultivos -->
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #374151;">Cultivos de Inter√©s</label>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; padding: 12px; background: #f8fafc; border-radius: 8px;">
            `;
            
            allCrops.forEach(crop => {
                const isChecked = crops.includes(crop);
                const emoji = {
                    'Aguacate': 'ü•ë',
                    'Tomate': 'üçÖ',
                    'Pimiento': 'üå∂Ô∏è',
                    'Pepino': 'ü•í',
                    'Fresa': 'üçì',
                    'Lechuga': 'ü•¨',
                    'C√≠tricos': 'üçä',
                    'Uva': 'üçá',
                    'Ma√≠z': 'üåΩ',
                    'Otro': 'üåæ'
                }[crop] || 'üåæ';
                
                html += `
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; border-radius: 6px; transition: background 0.2s;" 
                           onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='transparent'">
                        <input type="checkbox" name="edit-user-crops" value="${crop}" ${isChecked ? 'checked' : ''} 
                               style="width: 18px; height: 18px; cursor: pointer;">
                        <span>${emoji} ${crop}</span>
                    </label>
                `;
            });
            
            html += `
                            </div>
                        </div>
                        
                        <!-- Contrase√±a (vista actual + opci√≥n de establecer una nueva) -->
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #374151;">Contrase√±a actual (solo vista)</label>
                            <div style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; background: #f9fafb; color: #374151;">
                                ${(user.password && String(user.password).trim()) ? escapeHtml(String(user.password)) : '‚Äî No guardada en panel'}
                            </div>
                            ${/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(userId) ? `
                            <label style="display: block; margin-top: 12px; margin-bottom: 6px; font-weight: 500; color: #374151;">Nueva contrase√±a (opcional)</label>
                            <input type="password" id="edit-user-new-password" placeholder="Dejar vac√≠o para no cambiar" autocomplete="new-password" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                            <small style="color: #64748b; font-size: 12px; margin-top: 4px; display: block;">Si escribes una contrase√±a aqu√≠ y guardas, se actualizar√° en la nube y el usuario podr√° entrar con ella (√∫til si olvid√≥ su contrase√±a).</small>
                            ` : '<small style="color: #64748b; font-size: 12px; margin-top: 4px; display: block;">El usuario la cambia desde NutriPlant (Iniciar sesi√≥n ‚Üí ¬øOlvidaste tu contrase√±a?).</small>'}
                        </div>
                        
                        <!-- Estado de Suscripci√≥n -->
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #374151;">
                                Estado de Suscripci√≥n
                                ${isAdminUser ? '<span style="color: #ef4444; font-size: 12px; margin-left: 8px;">(Protegido - Administrador)</span>' : ''}
                            </label>
                            <select id="edit-user-subscription-status" 
                                    ${isAdminUser ? 'disabled' : ''}
                                    style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; ${isAdminUser ? 'background: #f3f4f6; cursor: not-allowed;' : ''}">
                                <option value="pending" ${user.subscription_status === 'pending' ? 'selected' : ''}>‚è≥ Pendiente</option>
                                <option value="active" ${user.subscription_status === 'active' ? 'selected' : ''}>‚úÖ Activa</option>
                                <option value="cancelled" ${user.subscription_status === 'cancelled' ? 'selected' : ''}>‚ùå Cancelada</option>
                                <option value="expired" ${user.subscription_status === 'expired' ? 'selected' : ''}>‚è∞ Expirada</option>
                                <option value="suspended" ${user.subscription_status === 'suspended' ? 'selected' : ''}>‚è∏Ô∏è Suspendida</option>
                            </select>
                            ${isAdminUser ? '<small style="color: #ef4444; font-size: 12px; margin-top: 4px; display: block;">üîí Esta cuenta siempre est√° activa (cuenta del administrador).</small>' : '<small style="color: #0ea5e9; font-size: 12px; margin-top: 4px; display: block;">üí° Puedes activar manualmente la suscripci√≥n (ej. pago por transferencia o excepci√≥n) eligiendo <strong>‚úÖ Activa</strong>. El usuario tendr√° acceso sin pasar por PayPal.</small>'}
                        </div>
                        
                        <!-- Monto de Suscripci√≥n (solo lectura) -->
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #374151;">Monto de Suscripci√≥n</label>
                            <div style="padding: 10px; background: ${isAdminUser ? '#fef2f2' : '#f8fafc'}; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; color: #374151;">
                                ${isAdminUser ? '<strong style="color: #ef4444;">Sin suscripci√≥n</strong> (Cuenta del Administrador)' : `$${(user.subscription_amount || (window.NUTRIPLANT_CONFIG ? window.NUTRIPLANT_CONFIG.getDefaultSubscriptionAmount() : 49.00)).toFixed(2)} USD (${window.NUTRIPLANT_CONFIG && window.NUTRIPLANT_CONFIG.getSubscriptionPeriodLabel ? window.NUTRIPLANT_CONFIG.getSubscriptionPeriodLabel() : 'cada 5 meses'})`}
                            </div>
                            <small style="color: #64748b; font-size: 12px; margin-top: 4px; display: block;">
                                ${isAdminUser ? 'Esta es una cuenta protegida del sistema.' : 'Los cambios de precio se gestionan a trav√©s de PayPal.'}
                            </small>
                        </div>
                        
                        <!-- L√≠mite de Chat IA (control de consumo) -->
                        <div style="padding: 12px; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #0c4a6e;">üí¨ Chat con IA</label>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; cursor: pointer;">
                                <input type="checkbox" id="edit-user-chat-blocked" ${(user.chat_blocked === true) ? 'checked' : ''} 
                                       style="width: 18px; height: 18px; cursor: pointer;">
                                <span>Bloquear chat con la IA para este usuario</span>
                            </label>
                            <div>
                                <label style="display: block; margin-bottom: 4px; font-weight: 500; color: #374151;">L√≠mite mensual de interacciones</label>
                                <input type="number" id="edit-user-chat-limit-monthly" min="-1" step="1" placeholder="Vac√≠o = sin l√≠mite" value="${(user.chat_limit_monthly == null || user.chat_limit_monthly === '' || user.chat_limit_monthly === -1) ? '' : Number(user.chat_limit_monthly)}" 
                                       style="width: 140px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                                <small style="display: block; color: #64748b; font-size: 12px; margin-top: 6px; line-height: 1.4;">
                                    <strong>Resumen:</strong> <strong>Vac√≠o</strong> = sin l√≠mite (tope ~1 USD/mes). <strong>0</strong> = sin chats este mes (casi como bloquear). <strong>N√∫mero</strong> (ej. 1) = tope en USD/mes. Bloquear = no puede usar el chat.
                                </small>
                                <div style="margin-top: 10px; padding: 8px; background: #f8fafc; border-radius: 6px; font-size: 13px; color: #475569;">
                                    <strong>Uso este mes:</strong> ${(user.chat_usage_current_month != null && user.chat_usage_current_month !== '') ? Number(user.chat_usage_current_month).toFixed(4) + ' USD' : '0 USD'}
                                    ${(user.chat_usage_month) ? ' ¬∑ Mes: ' + user.chat_usage_month : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px; margin-top: 24px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                        <button type="button" onclick="closeEditUserModal()" 
                                style="flex: 1; padding: 12px; background: #e5e7eb; color: #374151; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            Cancelar
                        </button>
                        <button type="submit" 
                                style="flex: 1; padding: 12px; background: #60a5fa; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            Guardar Cambios
                        </button>
                    </div>
                </form>
            `;
            
            content.innerHTML = html;
            modal.style.display = 'flex';
        }
        window.editUser = editUser;
        
        function closeEditUserModal() {
            const modal = document.getElementById('editUserModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        window.closeEditUserModal = closeEditUserModal;
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // üöÄ CR√çTICO: Funciones helper para convertir valores de √ìxido a Elemental (para panel de admin)
        // Factores de conversi√≥n (IGUAL QUE EN LOS M√ìDULOS PRINCIPALES)
        const ADMIN_CONVERSION_FACTORS = {
            P2O5_TO_P: 2.291,
            K2O_TO_K: 1.204,
            CaO_TO_Ca: 1.399,
            MgO_TO_Mg: 1.658,
            SiO2_TO_Si: 2.139
        };
        
        // Funci√≥n para obtener la etiqueta del nutriente seg√∫n el modo
        function getAdminNutrientLabel(nutrient, isElementalMode) {
            const oxidePretty = {
                'P2O5': 'P‚ÇÇO‚ÇÖ',
                'K2O': 'K‚ÇÇO',
                'SO4': 'SO‚ÇÑ',
                'SO3': 'SO‚ÇÉ',
                'SiO2': 'SiO‚ÇÇ',
                'N_NO3': 'N-NO‚ÇÉ‚Åª',
                'N_NH4': 'N-NH‚ÇÑ‚Å∫'
            };
            if (!isElementalMode) return oxidePretty[nutrient] || nutrient;
            const labels = {
                'P2O5': 'P',
                'K2O': 'K',
                'CaO': 'Ca',
                'MgO': 'Mg',
                'SiO2': 'Si'
            };
            return labels[nutrient] || (oxidePretty[nutrient] || nutrient);
        }
        
        // Funci√≥n para convertir un valor de √ìxido a Elemental
        function convertAdminOxideToElemental(nutrient, oxideValue) {
            if (typeof oxideValue !== 'number' || oxideValue === 0) return oxideValue;
            const factors = {
                'P2O5': ADMIN_CONVERSION_FACTORS.P2O5_TO_P,
                'K2O': ADMIN_CONVERSION_FACTORS.K2O_TO_K,
                'CaO': ADMIN_CONVERSION_FACTORS.CaO_TO_Ca,
                'MgO': ADMIN_CONVERSION_FACTORS.MgO_TO_Mg,
                'SiO2': ADMIN_CONVERSION_FACTORS.SiO2_TO_Si
            };
            const factor = factors[nutrient];
            if (factor) {
                return parseFloat((oxideValue / factor).toFixed(2));
            }
            return oxideValue;
        }

        // Funci√≥n para convertir un valor Elemental a √ìxido
        function convertAdminElementalToOxide(nutrient, elementalValue) {
            if (typeof elementalValue !== 'number' || elementalValue === 0) return elementalValue;
            const factors = {
                'P2O5': ADMIN_CONVERSION_FACTORS.P2O5_TO_P,
                'K2O': ADMIN_CONVERSION_FACTORS.K2O_TO_K,
                'CaO': ADMIN_CONVERSION_FACTORS.CaO_TO_Ca,
                'MgO': ADMIN_CONVERSION_FACTORS.MgO_TO_Mg,
                'SiO2': ADMIN_CONVERSION_FACTORS.SiO2_TO_Si
            };
            const factor = factors[nutrient];
            if (factor) {
                return parseFloat((elementalValue * factor).toFixed(2));
            }
            return elementalValue;
        }

        function formatAdminValue(nutrient, value) {
            const v = typeof value === 'number' ? value : parseFloat(value);
            if (isNaN(v)) return '0.00';
            const micro = ['Fe','Mn','B','Zn','Cu','Mo','Si','SiO2'];
            const decimals = micro.includes(nutrient) ? 3 : 2;
            return v.toFixed(decimals);
        }

        // Hidropon√≠a (admin): etiquetas y constantes para meq/ppm/%
        const HYDRO_MEQ_NUTRIENTS = ['N_NH4','N_NO3','P','S','K','Ca','Mg'];
        const HYDRO_ANIONS = ['N_NO3','P','S'];
        const HYDRO_CATIONS_TRIANGLE = ['K','Ca','Mg'];
        const HYDRO_MICROS = ['Fe','Mn','B','Zn','Cu','Mo'];
        const HYDRO_PPM_NUTRIENTS = ['N_NH4','N_NO3','P','S','K','Ca','Mg','Fe','Mn','B','Zn','Cu','Mo'];
        const HYDRO_EQ_WEIGHTS = { N_NO3: 14, N_NH4: 14, P: 31, K: 39.1, Ca: 20.04, Mg: 12.15, S: 16.03 };
        function adminHydroLabel(n) {
            const labels = { N_NH4: 'N-NH‚ÇÑ‚Å∫', N_NO3: 'N-NO‚ÇÉ‚Åª', P: 'P-H‚ÇÇPO‚ÇÑ‚Åª', S: 'S-SO‚ÇÑ¬≤‚Åª', K: 'K‚Å∫', Ca: 'Ca¬≤‚Å∫', Mg: 'Mg¬≤‚Å∫', Fe: 'Fe', Mn: 'Mn', B: 'B', Zn: 'Zn', Cu: 'Cu', Mo: 'Mo' };
            return labels[n] || n;
        }
        // SVG de tri√°ngulo hidropon√≠a con la misma estructura visual del dashboard
        function adminBuildHydroTriangleSvg(pNO3, pH2PO4, pSO4, pK, pCa, pMg) {
            const width = 460, height = 400, pad = 44;
            const base = width - 2 * pad;
            const triHeight = base * Math.sqrt(3) / 2;
            const lerp = (a, b, t) => ({ x: a.x + (b.x - a.x) * t, y: a.y + (b.y - a.y) * t });
            const vTop = { x: width / 2, y: pad };
            const vLeft = { x: pad, y: pad + triHeight };
            const vRight = { x: width - pad, y: pad + triHeight };
            const anionZone = [[20,10,70],[28.75,1.25,70],[80,1.25,18.75],[80,10,10]];
            const cationZone = [[10,62.5,27.5],[32.5,62.5,5],[65,30,5],[65,22.5,12.5],[37.5,22.5,40],[10,50,40]];
            const baryToXY = (vA, vB, vC, pA, pB, pC) => ({ x: (vA.x * pA + vB.x * pB + vC.x * pC) / 100, y: (vA.y * pA + vB.y * pB + vC.y * pC) / 100 });
            const toXYCat = (k, ca, mg) => baryToXY(vTop, vLeft, vRight, k, ca, mg);
            const toXYAn = (no3, h2po4, so4) => baryToXY(vTop, vLeft, vRight, no3, h2po4, so4);
            const normalize = (a, b, c) => {
                let pa = Math.max(0, Math.min(100, a)), pb = Math.max(0, Math.min(100, b)), pc = Math.max(0, Math.min(100, c));
                const sum = pa + pb + pc;
                if (sum > 0 && Math.abs(sum - 100) > 0.01) { pa = (pa / sum) * 100; pb = (pb / sum) * 100; pc = (pc / sum) * 100; }
                return [pa, pb, pc];
            };
            const pointInPolygon = (px, py, verts) => {
                let inside = false;
                for (let i = 0, j = verts.length - 1; i < verts.length; j = i++) {
                    const xi = verts[i].x, yi = verts[i].y, xj = verts[j].x, yj = verts[j].y;
                    if (((yi > py) !== (yj > py)) && (px < (xj - xi) * (py - yi) / (yj - yi) + xi)) inside = !inside;
                }
                return inside;
            };
            const clipPolygonByLine = (pts, ax, ay, bx, by, keepSide) => {
                const cross = (px, py) => (bx - ax) * (py - ay) - (by - ay) * (px - ax);
                const keep = keepSide || ((c) => c <= 0);
                const out = [];
                for (let i = 0; i < pts.length; i++) {
                    const cur = pts[i], next = pts[(i + 1) % pts.length];
                    const cCur = cross(cur.x, cur.y), cNext = cross(next.x, next.y);
                    if (keep(cCur)) {
                        if (keep(cNext)) out.push(next);
                        else {
                            const denom = cCur - cNext;
                            if (Math.abs(denom) > 1e-12) {
                                const t = cCur / denom;
                                out.push({ x: cur.x + t * (next.x - cur.x), y: cur.y + t * (next.y - cur.y) });
                            }
                        }
                    } else if (keep(cNext)) {
                        const denom = cCur - cNext;
                        if (Math.abs(denom) > 1e-12) {
                            const t = cCur / denom;
                            out.push({ x: cur.x + t * (next.x - cur.x), y: cur.y + t * (next.y - cur.y) });
                        }
                        out.push(next);
                    }
                }
                return out;
            };
            const polyMixed = (pts, fillColor, strokeColor, strokeWidth, dashedFn) => {
                if (!pts || pts.length < 3) return '';
                const points = pts.map(p => `${p.x},${p.y}`).join(' ');
                let out = `<polygon points="${points}" fill="${fillColor}" stroke="none" />`;
                for (let i = 0; i < pts.length; i++) {
                    const a = pts[i], b = pts[(i + 1) % pts.length];
                    const dashed = dashedFn ? dashedFn(a, b, i, pts) : i % 2 === 1;
                    out += `<line x1="${a.x}" y1="${a.y}" x2="${b.x}" y2="${b.y}" stroke="${strokeColor}" stroke-width="${strokeWidth || 2}" ${dashed ? 'stroke-dasharray="5,4"' : ''} />`;
                }
                return out;
            };

            let grid = '';
            for (let i = 1; i <= 9; i++) {
                const t = i / 10;
                grid += `<line x1="${vTop.x + (vLeft.x - vTop.x) * t}" y1="${vTop.y + (vLeft.y - vTop.y) * t}" x2="${vTop.x + (vRight.x - vTop.x) * t}" y2="${vTop.y + (vRight.y - vTop.y) * t}" stroke="#93c5fd" stroke-width="0.6" />`;
                grid += `<line x1="${vLeft.x + (vRight.x - vLeft.x) * t}" y1="${vLeft.y + (vRight.y - vLeft.y) * t}" x2="${vLeft.x + (vTop.x - vLeft.x) * t}" y2="${vLeft.y + (vTop.y - vLeft.y) * t}" stroke="#93c5fd" stroke-width="0.6" />`;
                grid += `<line x1="${vRight.x + (vTop.x - vRight.x) * t}" y1="${vRight.y + (vTop.y - vRight.y) * t}" x2="${vRight.x + (vLeft.x - vRight.x) * t}" y2="${vRight.y + (vLeft.y - vRight.y) * t}" stroke="#93c5fd" stroke-width="0.6" />`;
            }

            const catZonePtsFull = cationZone.map(([k, ca, mg]) => toXYCat(k, ca, mg));
            const cutStart = toXYCat(10, 50, 40);
            const norm = (a, b, c) => { const s = a + b + c; return s > 0 ? [a / s * 100, b / s * 100, c / s * 100] : [a, b, c]; };
            const [k65, ca25, mg15] = norm(65, 25, 15);
            const cutEnd = toXYCat(k65, ca25, mg15);
            const cutLine = `<line x1="${cutStart.x}" y1="${cutStart.y}" x2="${cutEnd.x}" y2="${cutEnd.y}" stroke="#b91c1c" stroke-width="1.5" stroke-dasharray="6,4" />`;
            let catZonePts = catZonePtsFull;
            if (catZonePtsFull.length >= 3) {
                const cross = (px, py) => (cutEnd.x - cutStart.x) * (py - cutStart.y) - (cutEnd.y - cutStart.y) * (px - cutStart.x);
                const keepSign = Math.sign(cross(vLeft.x, vLeft.y)) || 1;
                catZonePts = clipPolygonByLine(catZonePtsFull, cutStart.x, cutStart.y, cutEnd.x, cutEnd.y, (c) => c * keepSign >= 0);
            }
            const catMaxY = catZonePts.length ? Math.max(...catZonePts.map(p => p.y)) : 0;
            const catPoly = polyMixed(catZonePts, 'rgba(185,28,28,0.28)', '#b91c1c', 2, (a, b, i) => {
                const isBottom = catMaxY > 0 && Math.abs(a.y - catMaxY) < 2 && Math.abs(b.y - catMaxY) < 2;
                if (isBottom) return false;
                return i % 2 === 1;
            });
            const anZonePts = anionZone.map(([no3, h2po4, so4]) => toXYAn(no3, h2po4, so4));
            const anPoly = polyMixed(anZonePts, 'rgba(234,179,8,0.35)', '#ca8a04', 2);

            const [nNO3, nH2PO4, nSO4] = normalize(pNO3, pH2PO4, pSO4);
            const [nK, nCa, nMg] = normalize(pK, pCa, pMg);
            const anPoint = toXYAn(nNO3, nH2PO4, nSO4);
            const catPoint = toXYCat(nK, nCa, nMg);
            const anInside = anZonePts.length >= 3 && pointInPolygon(anPoint.x, anPoint.y, anZonePts);
            const catInside = catZonePts.length >= 3 && pointInPolygon(catPoint.x, catPoint.y, catZonePts);

            let ticks = '';
            for (let i = 1; i <= 9; i++) {
                const v = i * 10;
                const basePos = lerp(vLeft, vRight, 1 - i / 10);
                const leftPos = lerp(vTop, vLeft, 1 - i / 10);
                const rightPos = lerp(vTop, vRight, i / 10);
                ticks += `<text x="${basePos.x}" y="${basePos.y + 14}" text-anchor="middle" font-size="10" fill="#64748b">${v}</text>`;
                ticks += `<text x="${leftPos.x - 8}" y="${leftPos.y + 2}" text-anchor="end" font-size="10" fill="#64748b">${v}</text>`;
                ticks += `<text x="${rightPos.x + 8}" y="${rightPos.y + 2}" text-anchor="start" font-size="10" fill="#64748b">${v}</text>`;
            }
            ticks += `<text x="${vTop.x}" y="${vTop.y - 10}" text-anchor="middle" font-size="11" fill="#64748b">100</text>`;
            ticks += `<text x="${vLeft.x - 10}" y="${vLeft.y + 4}" text-anchor="end" font-size="10" fill="#64748b">100</text>`;
            ticks += `<text x="${vRight.x + 10}" y="${vRight.y + 4}" text-anchor="start" font-size="10" fill="#64748b">100</text>`;

            return `<svg viewBox="0 0 ${width} ${height}" width="100%" height="${height}" style="background:#fff;border-radius:8px;">
                ${grid}
                ${anPoly}
                ${catPoly}
                ${cutLine}
                <polygon points="${vTop.x},${vTop.y} ${vRight.x},${vRight.y} ${vLeft.x},${vLeft.y}" fill="none" stroke="#2563eb" stroke-width="2" />
                <circle cx="${catPoint.x}" cy="${catPoint.y}" r="6" fill="${catInside ? '#ef4444' : '#b91c1c'}" stroke="#7f1d1d" stroke-width="1.2" />
                <circle cx="${anPoint.x}" cy="${anPoint.y}" r="6" fill="${anInside ? '#eab308' : '#b45309'}" stroke="#92400e" stroke-width="1.2" />
                ${ticks}
                <text x="${lerp(vTop, vLeft, 0.5).x - 26}" y="${lerp(vTop, vLeft, 0.5).y}" text-anchor="end" font-size="11" font-weight="bold" fill="#334155">Mg¬≤‚Å∫ / SO‚ÇÑ¬≤‚Åª</text>
                <text x="${lerp(vTop, vRight, 0.5).x + 26}" y="${lerp(vTop, vRight, 0.5).y}" text-anchor="start" font-size="11" font-weight="bold" fill="#334155">Ca¬≤‚Å∫ / H‚ÇÇPO‚ÇÑ‚Åª</text>
                <text x="${lerp(vLeft, vRight, 0.5).x}" y="${lerp(vLeft, vRight, 0.5).y + 30}" text-anchor="middle" font-size="11" font-weight="bold" fill="#334155">K‚Å∫ / NO‚ÇÉ‚Åª</text>
            </svg>`;
        }
        function adminHydroComputeCE(meq) {
            if (!meq) return 0;
            const sum = (parseFloat(meq.N_NO3)||0)+(parseFloat(meq.N_NH4)||0)+(parseFloat(meq.P)||0)+(parseFloat(meq.K)||0)+(parseFloat(meq.Ca)||0)+(parseFloat(meq.Mg)||0)+(parseFloat(meq.S)||0);
            return (sum/20) || 0;
        }
        function adminHydroMacroPpm(meq) {
            const p = {};
            if (!meq) return p;
            p.N_NO3 = (parseFloat(meq.N_NO3)||0)*HYDRO_EQ_WEIGHTS.N_NO3;
            p.N_NH4 = (parseFloat(meq.N_NH4)||0)*HYDRO_EQ_WEIGHTS.N_NH4;
            ['P','K','Ca','Mg','S'].forEach(n => { p[n] = (parseFloat(meq[n])||0)*(HYDRO_EQ_WEIGHTS[n]||0); });
            return p;
        }
        const ADMIN_HYDRO_OXIDE_TO_ELEMENTAL = { P2O5_TO_P: 2.291, K2O_TO_K: 1.204, CaO_TO_Ca: 1.399, MgO_TO_Mg: 1.658 };
        function adminHydroMatToElemental(mat) {
            if (!mat) return {};
            const c = ADMIN_HYDRO_OXIDE_TO_ELEMENTAL;
            const P = (parseFloat(mat.P2O5)||0)/c.P2O5_TO_P || parseFloat(mat.P)||0;
            const K = (parseFloat(mat.K2O)||0)/c.K2O_TO_K || parseFloat(mat.K)||0;
            const Ca = (parseFloat(mat.CaO)||0)/c.CaO_TO_Ca || parseFloat(mat.Ca)||0;
            const Mg = (parseFloat(mat.MgO)||0)/c.MgO_TO_Mg || parseFloat(mat.Mg)||0;
            const S = parseFloat(mat.S)||0; const SO4 = parseFloat(mat.SO4)||0;
            const S_ele = S > 0 ? S : (SO4 > 0 ? SO4/3 : 0);
            return { N_NH4: parseFloat(mat.N_NH4)||0, N_NO3: parseFloat(mat.N_NO3)||0, P, S: S_ele, K, Ca, Mg, Fe: parseFloat(mat.Fe)||0, Mn: parseFloat(mat.Mn)||0, B: parseFloat(mat.B)||0, Zn: parseFloat(mat.Zn)||0, Cu: parseFloat(mat.Cu)||0, Mo: parseFloat(mat.Mo)||0, unit: mat.unit || '', density: parseFloat(mat.density)||0 };
        }
        function adminGetHydroMaterialsElemental(project) {
            const list = [];
            (ADMIN_FERT_SOLUBLES_DB || []).forEach(m => {
                const el = adminHydroMatToElemental(m);
                list.push({ id: m.id, name: m.name || m.id, ...el });
            });
            const custom = project?.hidroponia?.customMaterials?.items || project?.sections?.hidroponia?.customMaterials?.items || [];
            if (Array.isArray(custom)) custom.forEach(m => { if (m && (m.id || m.name)) list.push({ id: m.id || m.name, name: m.name || m.id, N_NH4: parseFloat(m.N_NH4)||0, N_NO3: parseFloat(m.N_NO3)||0, P: parseFloat(m.P)||0, S: parseFloat(m.S)||0, K: parseFloat(m.K)||0, Ca: parseFloat(m.Ca)||0, Mg: parseFloat(m.Mg)||0, Fe: parseFloat(m.Fe)||0, Mn: parseFloat(m.Mn)||0, B: parseFloat(m.B)||0, Zn: parseFloat(m.Zn)||0, Cu: parseFloat(m.Cu)||0, Mo: parseFloat(m.Mo)||0, unit: m.unit || '', density: parseFloat(m.density)||0 }); });
            return list;
        }
        function adminHydroComputeDoseAndKg(f, hydroVolM3, materialsElemental) {
            const mat = materialsElemental.find(m => m.id === f.materialId) || {};
            const unit = String(mat.unit || '').toUpperCase();
            const density = parseFloat(mat.density) || 0;
            const isLiquid = unit === 'L' && density > 0;
            const vol = hydroVolM3 > 0 ? hydroVolM3 : 100;
            let dose = f.dose != null ? parseFloat(f.dose) : NaN;
            if ((!isFinite(dose) || dose <= 0) && isLiquid && f && f.calcMode === 'product') {
                const productL = parseFloat(f.productTotalL) || 0;
                const kgEq = productL * density;
                if (vol > 0 && kgEq > 0) dose = (kgEq * 1000) / vol;
            }
            if (!isFinite(dose) && f.materialId && f.element && (f.targetPpm != null || f.targetPpm === 0)) {
                const elemPct = parseFloat(mat[f.element]) || 0;
                const targetPpm = parseFloat(f.targetPpm) || 0;
                dose = elemPct > 0 ? (targetPpm * 100 / elemPct) : NaN;
            }
            const kg = (isFinite(dose) && dose > 0 && vol > 0) ? (dose * vol / 1000) : NaN;
            if (isLiquid) {
                const totalL = (f && f.calcMode === 'product' && (parseFloat(f.productTotalL) || 0) > 0)
                    ? (parseFloat(f.productTotalL) || 0)
                    : (isFinite(kg) && kg > 0 ? (kg / density) : NaN);
                return { dose, kg, totalValue: totalL, totalUnit: 'L', isLiquid };
            }
            return { dose, kg, totalValue: kg, totalUnit: 'kg', isLiquid };
        }
        function adminHydroContributions(f, materialsElemental) {
            if (f.contributions && typeof f.contributions === 'object') {
                const c = {};
                HYDRO_PPM_NUTRIENTS.forEach(n => { c[n] = parseFloat(f.contributions[n]) || 0; });
                return c;
            }
            const mat = materialsElemental.find(m => m.id === f.materialId);
            if (!mat) return null;
            const dose = f.dose != null ? parseFloat(f.dose) : adminHydroComputeDoseAndKg(f, 100, materialsElemental).dose;
            if (isNaN(dose) || dose <= 0) return null;
            const c = {};
            HYDRO_PPM_NUTRIENTS.forEach(n => { c[n] = dose * (parseFloat(mat[n]) || 0) / 100; });
            return c;
        }

        function adminSafeId(raw) {
            const safe = String(raw || '').replace(/[^a-zA-Z0-9_-]/g, '_');
            return /^[a-zA-Z]/.test(safe) ? safe : `p_${safe}`;
        }

        // ===== Fertirriego: materiales y totales (Admin) =====
        const ADMIN_FERT_SOLUBLES_DB = [
            // Nitrogenados
            { id: 'fosfonitrato_33_03_00', name: 'Fosfonitrato', N_NO3: 30, N_NH4: 3, P2O5: 3 },
            { id: 'sulfato_amonio_soluble', name: 'Sulfato de Amonio Soluble', N_NO3: 0, N_NH4: 21, SO4: 60, S: 0 },
            // Fosfatos
            { id: 'map', name: 'MAP', N_NO3: 0, N_NH4: 12, P2O5: 61 },
            { id: 'mkp', name: 'MKP', N_NO3: 0, N_NH4: 0, P2O5: 52, K2O: 34 },
            // Potasio y mezclas
            { id: 'nks', name: 'NKS', N_NO3: 12, N_NH4: 0, K2O: 46, SO4: 3.6, S: 0 },
            { id: 'nk_mg', name: 'NK+Mg', N_NO3: 13.0, N_NH4: 0, K2O: 46, MgO: 2 },
            { id: 'sop', name: 'SOP', N_NO3: 0, N_NH4: 0, K2O: 50, SO4: 45, S: 0 },
            { id: 'kcl_soluble', name: 'KCl Soluble', N_NO3: 0, N_NH4: 0, K2O: 60 },
            // Calcio y Magnesio
            { id: 'nitrato_calcio_granular', name: 'Nitrato de Calcio', N_NO3: 14.4, N_NH4: 1.1, CaO: 26 },
            { id: 'nitrato_calcio_cristal', name: 'Nitrato de Calcio Cristal', N_NO3: 12, N_NH4: 0, CaO: 23, MgO: 0.5 },
            { id: 'nitrato_magnesio', name: 'Nitrato de Magnesio', N_NO3: 10.8, N_NH4: 0, MgO: 15 },
            { id: 'sulfato_magnesio', name: 'Sulfato de Magnesio', N_NO3: 0, N_NH4: 0, MgO: 16, SO4: 13, S: 0 },
            // √Åcidos
            { id: 'acido_sulfurico_98', name: '√Åcido Sulf√∫rico 98%', SO4: 96, S: 0, unit: 'L', density: 1.84 },
            { id: 'acido_fosforico_75', name: '√Åcido Fosf√≥rico 75%', P2O5: 54, unit: 'L', density: 1.57 },
            { id: 'acido_fosforico_85', name: '√Åcido Fosf√≥rico 85%', P2O5: 61, unit: 'L', density: 1.685 },
            { id: 'acido_nitrico_55', name: '√Åcido N√≠trico 55%', N_NO3: 12.2, unit: 'L', density: 1.33 },
            // Complejos NPK con micros
            { id: 'triple_19_me', name: 'Triple 19 +Me', N_NO3: 9.4, N_NH4: 9.7, P2O5: 19, K2O: 19, SO4: 3.9, Fe: 0.10, Mn: 0.05, B: 0.02, Zn: 0.015, Cu: 0.011, Mo: 0.007 },
            { id: 'npk_12_43_12_me', name: '12-43-12 +Me', N_NO3: 3.5, N_NH4: 8.5, P2O5: 43, K2O: 12, SO4: 0, MgO: 0, Fe: 0.05, Mn: 0.02, B: 0.01, Zn: 0.01, Cu: 0.005, Mo: 0.003 },
            { id: 'npk_10_10_43_me', name: '10-10-43 +Me', N_NO3: 10, N_NH4: 0, P2O5: 10, K2O: 43, SO4: 0, MgO: 0, Fe: 0.05, Mn: 0.02, B: 0.01, Zn: 0.01, Cu: 0.005, Mo: 0.003 },
            // Micros
            { id: 'mix_micros_edta', name: 'Mix Micros EDTA', Fe: 6, Mn: 4, Zn: 2, Cu: 1, B: 1 },
            { id: 'quelato_fe', name: 'Fe EDTA', Fe: 13 },
            { id: 'fe_dtpa', name: 'Fe DTPA', Fe: 11 },
            { id: 'fe_eddha', name: 'Fe EDDHA', Fe: 6 },
            { id: 'quelato_mn', name: 'Mn EDTA', Mn: 13 },
            { id: 'quelato_zn', name: 'Zn EDTA', Zn: 13 },
            { id: 'quelato_cu', name: 'Cu EDTA', Cu: 14 },
            { id: 'acido_borico', name: '√Åcido B√≥rico', B: 17, N_NO3: 0, N_NH4: 0 },
            { id: 'molibdato_sodio', name: 'Molibdato de Sodio', Mo: 39 }
        ];

        function adminGetFertiMaterials(project) {
            const list = [...ADMIN_FERT_SOLUBLES_DB];
            const fromProject =
                project?.sections?.fertirriego?.customMaterials?.items ||
                project?.fertirriego?.customMaterials?.items ||
                project?.fertiCustomMaterials?.items ||
                project?.fertirriegoCustomMaterials?.items ||
                [];
            if (Array.isArray(fromProject)) {
                fromProject.forEach(mat => {
                    if (mat && (mat.id || mat.name)) list.push(mat);
                });
            }
            return list;
        }

        function adminComputeFertiContrib(amountInput, material) {
            const mat = material || {};
            const amountNum = parseFloat(amountInput) || 0;
            const productKg = (mat.unit === 'L' && parseFloat(mat.density)) ? amountNum * parseFloat(mat.density) : amountNum;
            const contrib = {};
            ['N_NO3','N_NH4','P2O5','K2O','CaO','MgO','S','SO4','Fe','Mn','B','Zn','Cu','Mo','SiO2'].forEach(n => {
                contrib[n] = productKg * ((parseFloat(mat[n]) || 0) / 100);
            });
            contrib.P = contrib.P2O5 / ADMIN_CONVERSION_FACTORS.P2O5_TO_P;
            contrib.K = contrib.K2O / ADMIN_CONVERSION_FACTORS.K2O_TO_K;
            contrib.Ca = contrib.CaO / ADMIN_CONVERSION_FACTORS.CaO_TO_Ca;
            contrib.Mg = contrib.MgO / ADMIN_CONVERSION_FACTORS.MgO_TO_Mg;
            contrib.Si = contrib.SiO2 / ADMIN_CONVERSION_FACTORS.SiO2_TO_Si;
            return contrib;
        }

        function adminEnsureFertiTotals(program, project) {
            if (!program || !Array.isArray(program.weeks) || !Array.isArray(program.columns)) return;
            const materials = adminGetFertiMaterials(project);
            const byId = new Map(materials.map(m => [m.id, m]));
            program.weeks.forEach(week => {
                const totals = { N_NO3:0,N_NH4:0,P:0,P2O5:0,K:0,K2O:0,Ca:0,CaO:0,Mg:0,MgO:0,S:0,SO4:0,Fe:0,Mn:0,B:0,Zn:0,Cu:0,Mo:0,Si:0,SiO2:0 };
                if (!week.kgByCol) week.kgByCol = {};
                program.columns.forEach(col => {
                    const kg = week.kgByCol[col.id] || 0;
                    const mat = byId.get(col.materialId) || {};
                    const contrib = adminComputeFertiContrib(kg, mat);
                    Object.keys(totals).forEach(n => { totals[n] += parseFloat(contrib[n] || 0); });
                });
                week.totals = totals;
            });
        }

        // ===== Gr√°ficas de Fertirriego (Admin) =====
        function loadAdminChartJs(callback) {
            if (window.Chart) { callback(); return; }
            const s = document.createElement('script');
            s.src = 'https://cdn.jsdelivr.net/npm/chart.js';
            s.onload = callback;
            document.head.appendChild(s);
        }

        function buildAdminSvgChart(containerEl, labels, datasets) {
            if (!containerEl) return;
            const width = 600;
            const height = 180;
            const padL = 40, padR = 10, padT = 10, padB = 30;
            const innerW = width - padL - padR;
            const innerH = height - padT - padB;
            const allValues = datasets.flatMap(d => d.data.map(v => parseFloat(v) || 0));
            const maxVal = Math.max(1, ...allValues);
            const xStep = labels.length > 1 ? innerW / (labels.length - 1) : 0;
            const xAt = (i) => padL + (labels.length > 1 ? i * xStep : innerW / 2);
            const yAt = (v) => padT + (1 - (v / maxVal)) * innerH;
            const gridLines = 4;
            let svg = `<svg viewBox="0 0 ${width} ${height}" width="100%" height="${height}" style="display:block;background:#fff;border-radius:6px;">`;
            for (let i = 0; i <= gridLines; i++) {
                const y = padT + (innerH * i / gridLines);
                const value = (maxVal * (1 - i / gridLines)).toFixed(1);
                svg += `<line x1="${padL}" y1="${y}" x2="${width - padR}" y2="${y}" stroke="#e5e7eb" stroke-width="1" />`;
                svg += `<text x="${padL - 6}" y="${y + 4}" text-anchor="end" font-size="10" fill="#6b7280">${value}</text>`;
            }
            svg += `<line x1="${padL}" y1="${padT}" x2="${padL}" y2="${height - padB}" stroke="#cbd5e1" stroke-width="1" />`;
            svg += `<line x1="${padL}" y1="${height - padB}" x2="${width - padR}" y2="${height - padB}" stroke="#cbd5e1" stroke-width="1" />`;
            labels.forEach((lbl, i) => {
                const x = xAt(i);
                svg += `<text x="${x}" y="${height - 10}" text-anchor="middle" font-size="10" fill="#6b7280">${lbl}</text>`;
            });
            datasets.forEach(ds => {
                const points = ds.data.map((v, i) => `${xAt(i)},${yAt(parseFloat(v) || 0)}`).join(' ');
                svg += `<polyline fill="none" stroke="${ds.color}" stroke-width="2" points="${points}" />`;
                ds.data.forEach((v, i) => {
                    const x = xAt(i);
                    const y = yAt(parseFloat(v) || 0);
                    svg += `<circle cx="${x}" cy="${y}" r="2.5" fill="${ds.color}" />`;
                });
            });
            svg += `</svg>`;
            const legend = `
                <div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:6px;font-size:12px;color:#334155;">
                    ${datasets.map(d => `<span style="display:flex;align-items:center;gap:6px;"><span style="width:10px;height:10px;border-radius:50%;background:${d.color};display:inline-block;"></span>${d.label}</span>`).join('')}
                </div>
            `;
            containerEl.innerHTML = legend + svg;
        }

        function renderAdminFertirriegoCharts(program, chartIds, project, chartTargets) {
            try {
                if (!program || !Array.isArray(program.weeks)) return;
                const macroContainer = chartTargets?.macroEl || (chartIds ? document.getElementById(chartIds.macroId) : null);
                const microContainer = chartTargets?.microEl || (chartIds ? document.getElementById(chartIds.microId) : null);
                if (!macroContainer || !microContainer) return;

            const weeks = program.weeks || [];
            const timeUnit = program.timeUnit === 'mes' ? 'mes' : 'semana';
            const labels = weeks.map((w, i) => `${timeUnit === 'mes' ? 'Mes' : 'Semana'} ${i + 1}`);
            const hasTotals = weeks.some(w => w && w.totals);
            if (!hasTotals) {
                adminEnsureFertiTotals(program, project);
            }

            const mk = (n) => program.weeks.map(w => parseFloat(w?.totals?.[n] || 0));
            let macros = {
                N_NO3: mk('N_NO3'),
                N_NH4: mk('N_NH4'),
                P2O5: mk('P2O5'),
                K2O: mk('K2O'),
                CaO: mk('CaO'),
                MgO: mk('MgO'),
                SO4: mk('SO4')
            };
            const micros = { Fe: mk('Fe'), Mn: mk('Mn'), B: mk('B'), Zn: mk('Zn'), Cu: mk('Cu'), Mo: mk('Mo') };

            const macroColors = {
                N_NO3: '#1f77b4', N_NH4: '#2ca02c', P2O5: '#ff7f0e', K2O: '#98df8a', CaO: '#9467bd', MgO: '#17becf', SO4: '#8c564b'
            };
            const microColors = { Fe: '#1f77b4', Mn: '#2ca02c', B: '#ff7f0e', Zn: '#9467bd', Cu: '#8c564b', Mo: '#e377c2' };

            const programIsElemental = program.mode === true;
            let macroLabels = { P2O5: 'P‚ÇÇO‚ÇÖ', K2O: 'K‚ÇÇO', CaO: 'CaO', MgO: 'MgO', SO4: 'SO‚ÇÑ' };
            if (programIsElemental) {
                macros = {
                    N_NO3: macros.N_NO3,
                    N_NH4: macros.N_NH4,
                    P2O5: macros.P2O5.map(v => convertAdminOxideToElemental('P2O5', v)),
                    K2O: macros.K2O.map(v => convertAdminOxideToElemental('K2O', v)),
                    CaO: macros.CaO.map(v => convertAdminOxideToElemental('CaO', v)),
                    MgO: macros.MgO.map(v => convertAdminOxideToElemental('MgO', v)),
                    SO4: macros.SO4
                };
                macroLabels = { P2O5: 'P', K2O: 'K', CaO: 'Ca', MgO: 'Mg', SO4: 'SO‚ÇÑ' };
            }

            const macroDatasets = [
                { label: 'N-NO‚ÇÉ‚Åª', data: macros.N_NO3, color: macroColors.N_NO3 },
                { label: 'N-NH‚ÇÑ‚Å∫', data: macros.N_NH4, color: macroColors.N_NH4 },
                { label: macroLabels.P2O5, data: macros.P2O5, color: macroColors.P2O5 },
                { label: macroLabels.K2O, data: macros.K2O, color: macroColors.K2O },
                { label: macroLabels.CaO, data: macros.CaO, color: macroColors.CaO },
                { label: macroLabels.MgO, data: macros.MgO, color: macroColors.MgO },
                { label: macroLabels.SO4, data: macros.SO4, color: macroColors.SO4 }
            ];
            const microDatasets = [
                { label: 'Fe', data: micros.Fe, color: microColors.Fe },
                { label: 'Mn', data: micros.Mn, color: microColors.Mn },
                { label: 'B', data: micros.B, color: microColors.B },
                { label: 'Zn', data: micros.Zn, color: microColors.Zn },
                { label: 'Cu', data: micros.Cu, color: microColors.Cu },
                { label: 'Mo', data: micros.Mo, color: microColors.Mo }
            ];
                buildAdminSvgChart(macroContainer, labels, macroDatasets);
                buildAdminSvgChart(microContainer, labels, microDatasets);
            } catch (e) {
                console.warn('‚ö†Ô∏è Error renderizando gr√°ficas de Fertirriego (admin):', e);
            }
        }

        function buildRealRequirementOxide(granularRequirements) {
            const nutrients = ['N','P2O5','K2O','CaO','MgO','S','SO4','Fe','Mn','B','Zn','Cu','Mo','SiO2'];
            const req = {};
            if (!granularRequirements) return req;
            const isElemental = granularRequirements.isElementalMode === true;
            const adjustment = granularRequirements.adjustment || {};
            const efficiency = granularRequirements.efficiency || {};
            nutrients.forEach(n => {
                let adjOxide = adjustment[n] || 0;
                if (isElemental) {
                    adjOxide = convertAdminElementalToOxide(n, adjOxide);
                }
                const eff = efficiency[n] || 85;
                const divisor = eff > 0 ? eff / 100 : 1;
                req[n] = adjOxide / divisor;
            });
            return req;
        }
        
        // Funci√≥n para convertir un objeto de valores de √ìxido a Elemental
        function convertAdminValuesToElemental(values, isElementalMode) {
            if (!isElementalMode || !values || typeof values !== 'object') return values;
            const converted = {};
            Object.keys(values).forEach(key => {
                converted[key] = convertAdminOxideToElemental(key, values[key]);
            });
            return converted;
        }
        
        async function saveUserChanges(e, userId) {
            e.preventDefault();
            
            // üîí CR√çTICO: Obtener usuario directamente del localStorage para tener la versi√≥n m√°s actual
            const userKey = `nutriplant_user_${userId}`;
            const userValue = localStorage.getItem(userKey);
            
            if (!userValue) {
                alert('‚ùå Usuario no encontrado');
                return;
            }
            
            let existingUser;
            try {
                existingUser = JSON.parse(userValue);
            } catch (e) {
                alert('‚ùå Error al cargar el usuario');
                console.error('Error parseando usuario:', e);
                return;
            }
            
            // üîí VALIDACI√ìN: Asegurar que el usuario tiene un ID v√°lido
            if (!existingUser.id || existingUser.id !== userId) {
                console.warn('‚ö†Ô∏è ID del usuario no coincide, corrigiendo...');
                existingUser.id = userId;
                existingUser.userId = userId;
            }
            
            // üîê PROTECCI√ìN: Verificar si es usuario administrador
            const isAdminUser = existingUser.email === 'admin@nutriplantpro.com' || existingUser.isAdmin === true;
            
            // üîí PRESERVAR: Crear copia de datos cr√≠ticos ANTES de actualizar
            const preservedData = {
                userId: existingUser.userId || userId,
                id: existingUser.id || userId,
                created_at: existingUser.created_at,
                last_login: existingUser.last_login, // Preservar √∫ltimo acceso
                subscription_activated_at: existingUser.subscription_activated_at,
                _cancelled_at: existingUser._cancelled_at,
                _expired_at: existingUser._expired_at,
                _pending_at: existingUser._pending_at,
                last_payment_date: existingUser.last_payment_date,
                next_payment_date: existingUser.next_payment_date,
                paypal_subscription_id: existingUser.paypal_subscription_id,
                isAdmin: isAdminUser,
                projects: Array.isArray(existingUser.projects) ? [...existingUser.projects] : [],
                chat_usage_current_month: existingUser.chat_usage_current_month,
                chat_usage_month: existingUser.chat_usage_month
            };
            
            if (preservedData.projects.length > 0) {
                console.log(`‚úÖ Preservando ${preservedData.projects.length} proyecto(s) del usuario: ${preservedData.projects.join(', ')}`);
            }
            
            // Obtener valores del formulario
            const formData = {
                name: document.getElementById('edit-user-name').value.trim(),
                email: document.getElementById('edit-user-email').value.trim(),
                phone: document.getElementById('edit-user-phone').value.trim(),
                location: {
                    country: document.getElementById('edit-user-country').value.trim(),
                    state: document.getElementById('edit-user-state').value.trim(),
                    city: document.getElementById('edit-user-city').value.trim(),
                    postal: document.getElementById('edit-user-postal').value.trim()
                },
                profession: document.getElementById('edit-user-profession').value,
                crops: Array.from(document.querySelectorAll('input[name="edit-user-crops"]:checked')).map(cb => cb.value),
                // Para admin: siempre activo y sin suscripci√≥n
                subscription_status: isAdminUser ? 'active' : document.getElementById('edit-user-subscription-status').value,
                subscription_amount: isAdminUser ? 0 : (existingUser.subscription_amount || (window.NUTRIPLANT_CONFIG ? window.NUTRIPLANT_CONFIG.getDefaultSubscriptionAmount() : 49.00)),
                chat_blocked: document.getElementById('edit-user-chat-blocked').checked,
                chat_limit_monthly: (function() { var v = document.getElementById('edit-user-chat-limit-monthly').value; if (v === '' || v === null) return -1; var n = parseInt(v, 10); return isNaN(n) ? -1 : Math.max(-1, n); })()
            };
            
            // Contrase√±a: si el admin escribi√≥ una nueva (campo opcional), se usar√° y se actualizar√° en Supabase.
            var newPasswordEl = document.getElementById('edit-user-new-password');
            const newPassword = (newPasswordEl && newPasswordEl.value && String(newPasswordEl.value).trim()) ? String(newPasswordEl.value).trim() : '';
            formData.password = newPassword ? newPassword : (existingUser.password || (isAdminUser ? 'npja1502' : ''));
            
            // üîí CREAR OBJETO ACTUALIZADO: Usar spread operator para preservar TODOS los campos existentes
            const updatedUser = {
                ...existingUser, // üîí CR√çTICO: Esto preserva TODOS los campos no editables
                // Actualizar solo los campos editables del formulario
                ...formData,
                // üîí FORZAR PRESERVACI√ìN: Asegurar que los datos cr√≠ticos no se pierdan
                ...preservedData
            };
            
            // üîÑ Guardar usuario actualizado (userKey ya est√° definido arriba)
            const newEmailKey = `nutriplant_user_email_${updatedUser.email.toLowerCase()}`;
            const oldEmailKey = existingUser.email ? `nutriplant_user_email_${existingUser.email.toLowerCase()}` : null;
            
            // üîí VALIDACI√ìN FINAL: Verificar que los datos cr√≠ticos se preservaron
            if (!updatedUser.id || updatedUser.id !== userId) {
                console.error('‚ùå ERROR: ID del usuario se perdi√≥ durante la actualizaci√≥n');
                updatedUser.id = userId;
                updatedUser.userId = userId;
            }
            if (!Array.isArray(updatedUser.projects)) {
                console.warn('‚ö†Ô∏è Projects no es un array, restaurando...');
                updatedUser.projects = preservedData.projects;
            }
            if (!updatedUser.projects || updatedUser.projects.length !== preservedData.projects.length) {
                console.warn(`‚ö†Ô∏è N√∫mero de proyectos cambi√≥ (${preservedData.projects.length} ‚Üí ${updatedUser.projects.length}), restaurando...`);
                updatedUser.projects = preservedData.projects;
            }
            
            // Si el admin define o cambia el l√≠mite mensual de chat (> 0), reiniciar contador desde este momento (mes en curso). -1 o vac√≠o = sin l√≠mite.
            const newLimit = updatedUser.chat_limit_monthly === -1 || updatedUser.chat_limit_monthly == null || updatedUser.chat_limit_monthly === '' ? -1 : Math.max(-1, parseInt(updatedUser.chat_limit_monthly, 10) || -1);
            if (newLimit > 0) {
                const now = new Date();
                const currentMonth = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
                updatedUser.chat_usage_current_month = 0;
                updatedUser.chat_usage_month = currentMonth;
            }
            
            // Guardar usuario actualizado con todos los campos
            try {
            localStorage.setItem(userKey, JSON.stringify(updatedUser));
                console.log(`‚úÖ Usuario "${userId}" actualizado correctamente. Proyectos preservados: ${updatedUser.projects.length}`);
            } catch (e) {
                console.error('‚ùå Error al guardar usuario:', e);
                alert('‚ùå Error al guardar el usuario. Por favor, intenta nuevamente.');
                return;
            }
            
            // üü¢ Sincronizar SIEMPRE en nube (profiles) por ID y, si hace falta, fallback por email.
            let cloudSyncMessage = '';
            const isSupabaseUserId = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(String(userId));
            if (window.getSupabaseClient) {
                const client = window.getSupabaseClient();
                if (client) {
                    try {
                        const loc = updatedUser.location && typeof updatedUser.location === 'object'
                            ? [updatedUser.location.city, updatedUser.location.state, updatedUser.location.country].filter(Boolean).join(', ')
                            : (updatedUser.location || '');
                        const payload = {
                            name: updatedUser.name || null,
                            email: updatedUser.email || null,
                            phone: updatedUser.phone || null,
                            profession: updatedUser.profession || null,
                            location: loc || null,
                            crops: Array.isArray(updatedUser.crops) ? updatedUser.crops : null,
                            subscription_status: updatedUser.subscription_status || null,
                            subscription_amount: updatedUser.subscription_amount != null ? Number(updatedUser.subscription_amount) : null,
                            chat_blocked: updatedUser.chat_blocked === true,
                            chat_limit_monthly: (updatedUser.chat_limit_monthly == null || updatedUser.chat_limit_monthly === '' || updatedUser.chat_limit_monthly === -1) ? null : Number(updatedUser.chat_limit_monthly),
                            chat_usage_current_month: updatedUser.chat_usage_current_month != null ? Number(updatedUser.chat_usage_current_month) : null,
                            chat_usage_month: updatedUser.chat_usage_month || null,
                            updated_at: new Date().toISOString()
                        };
                        if (newPassword) payload.password_plain = newPassword;
                        let error = null;
                        let matched = 0;

                        // 1) Intentar por ID (si es UUID)
                        if (isSupabaseUserId) {
                            const byId = await client.from('profiles').update(payload).eq('id', userId).select('id');
                            error = byId.error || null;
                            matched = Array.isArray(byId.data) ? byId.data.length : 0;

                            // Compatibilidad de esquema: algunos proyectos no tienen columna `crops` en profiles.
                            if (error && /crops/i.test(error.message || '') && /column/i.test(error.message || '')) {
                                console.warn('‚ö†Ô∏è profiles.crops no existe en este proyecto. Reintentando sin crops...');
                                const fallbackPayload = { ...payload };
                                delete fallbackPayload.crops;
                                const retry = await client.from('profiles').update(fallbackPayload).eq('id', userId).select('id');
                                error = retry.error || null;
                                matched = Array.isArray(retry.data) ? retry.data.length : 0;
                            }
                            if (error && /password_plain/i.test(error.message || '') && /column/i.test(error.message || '')) {
                                const fallbackPayload = { ...payload };
                                delete fallbackPayload.password_plain;
                                const retry2 = await client.from('profiles').update(fallbackPayload).eq('id', userId).select('id');
                                error = retry2.error || null;
                                matched = Array.isArray(retry2.data) ? retry2.data.length : 0;
                            }
                        }

                        // 2) Fallback por email (cuando ID no es UUID o no encontr√≥ fila por ID)
                        if ((!isSupabaseUserId || matched === 0) && updatedUser.email) {
                            const byEmail = await client
                                .from('profiles')
                                .update(payload)
                                .ilike('email', String(updatedUser.email))
                                .select('id');
                            error = byEmail.error || null;
                            matched = Array.isArray(byEmail.data) ? byEmail.data.length : 0;

                            if (error && /crops/i.test(error.message || '') && /column/i.test(error.message || '')) {
                                const fallbackPayload = { ...payload };
                                delete fallbackPayload.crops;
                                const retryByEmail = await client
                                    .from('profiles')
                                    .update(fallbackPayload)
                                    .ilike('email', String(updatedUser.email))
                                    .select('id');
                                error = retryByEmail.error || null;
                                matched = Array.isArray(retryByEmail.data) ? retryByEmail.data.length : 0;
                            }
                            if (error && /password_plain/i.test(error.message || '') && /column/i.test(error.message || '')) {
                                const fallbackPayload = { ...payload };
                                delete fallbackPayload.password_plain;
                                const retryByEmail2 = await client.from('profiles').update(fallbackPayload).ilike('email', String(updatedUser.email)).select('id');
                                error = retryByEmail2.error || null;
                                matched = Array.isArray(retryByEmail2.data) ? retryByEmail2.data.length : 0;
                            }
                        }

                        if (error) {
                            console.warn('‚ö†Ô∏è Error actualizando perfil en Supabase:', error.message);
                            cloudSyncMessage = '\n\n‚ö†Ô∏è Se guard√≥ localmente, pero fall√≥ guardar en la nube: ' + (error.message || 'error desconocido');
                        } else if (!matched) {
                            cloudSyncMessage = '\n\n‚ö†Ô∏è Se guard√≥ localmente, pero no se encontr√≥ el perfil en la nube para actualizar.';
                        } else {
                            console.log('‚òÅÔ∏è Perfil actualizado en la nube');
                        }

                        // Si es usuario Supabase y el admin puso una contrase√±a nueva, actualizarla en Auth
                        if (isSupabaseUserId && newPassword) {
                            try {
                                const params = new URLSearchParams(window.location.search);
                                const adminKey = params.get('k') || (typeof ADMIN_ACCESS_KEY !== 'undefined' ? ADMIN_ACCESS_KEY : '');
                                const base = window.location.origin;
                                const resPwd = await fetch(base + '/api/admin/update-user-password', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        admin_key: adminKey,
                                        user_id: userId,
                                        new_password: newPassword
                                    })
                                });
                                const jsonPwd = await resPwd.json().catch(function() { return {}; });
                                if (!resPwd.ok) {
                                    console.warn('‚ö†Ô∏è No se pudo actualizar la contrase√±a en Supabase Auth:', jsonPwd.error || resPwd.status);
                                    cloudSyncMessage += '\n\nüîí La contrase√±a no se actualiz√≥ en Supabase Auth. El usuario NO podr√° entrar con la nueva. Revisa: 1) Servidor corriendo (python server.py), 2) supabase-server-config.json con la clave service_role. Error: ' + (jsonPwd.error || resPwd.status);
                                    window._adminPasswordUpdateFailed = true;
                                } else {
                                    console.log('‚òÅÔ∏è Contrase√±a actualizada en Supabase Auth.');
                                }
                            } catch (err) {
                                console.warn('‚ö†Ô∏è Llamada a actualizar contrase√±a en Auth:', err);
                                cloudSyncMessage += '\n\nüîí No se pudo actualizar la contrase√±a en la nube (error de red o servidor). ¬øTienes el servidor corriendo (python server.py) y supabase-server-config.json configurado?';
                                window._adminPasswordUpdateFailed = true;
                            }
                        }

                        // Si es usuario Supabase y cambi√≥ el email, actualizar tambi√©n Auth para que pueda entrar con el nuevo correo
                        if (isSupabaseUserId && existingUser.email !== updatedUser.email && updatedUser.email) {
                            try {
                                const params = new URLSearchParams(window.location.search);
                                const adminKey = params.get('k') || (typeof ADMIN_ACCESS_KEY !== 'undefined' ? ADMIN_ACCESS_KEY : '');
                                const base = window.location.origin;
                                const res = await fetch(base + '/api/admin/update-user-email', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        admin_key: adminKey,
                                        user_id: userId,
                                        new_email: updatedUser.email
                                    })
                                });
                                const json = await res.json().catch(function() { return {}; });
                                if (!res.ok) {
                                    console.warn('‚ö†Ô∏è No se pudo actualizar el email en Supabase Auth:', json.error || res.status);
                                    cloudSyncMessage += '\n\nüìß El correo en el perfil se actualiz√≥, pero no se pudo actualizar el correo de acceso (Supabase Auth). El usuario seguir√° entrando con el correo anterior. Para cambiarlo: Supabase ‚Üí SQL Editor ‚Üí UPDATE auth.users SET email = \'nuevo@email.com\' WHERE id = \'...\';';
                                } else {
                                    console.log('‚òÅÔ∏è Email actualizado en Supabase Auth; el usuario podr√° entrar con el nuevo correo.');
                                }
                            } catch (err) {
                                console.warn('‚ö†Ô∏è Llamada a actualizar email en Auth:', err);
                                cloudSyncMessage += '\n\nüìß No se pudo actualizar el correo de acceso en el servidor. Si hace falta, c√°mbialo en Supabase ‚Üí SQL Editor (auth.users).';
                            }
                        }

                        // Si es usuario Supabase y el admin puso una contrase√±a nueva, actualizar tambi√©n en Auth (para que pueda entrar)
                        if (isSupabaseUserId && newPassword) {
                            try {
                                const params = new URLSearchParams(window.location.search);
                                const adminKey = params.get('k') || (typeof ADMIN_ACCESS_KEY !== 'undefined' ? ADMIN_ACCESS_KEY : '');
                                const base = window.location.origin;
                                const res = await fetch(base + '/api/admin/update-user-password', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        admin_key: adminKey,
                                        user_id: userId,
                                        new_password: newPassword
                                    })
                                });
                                const json = await res.json().catch(function() { return {}; });
                                if (!res.ok) {
                                    console.warn('‚ö†Ô∏è No se pudo actualizar la contrase√±a en Supabase Auth:', json.error || res.status);
                                    cloudSyncMessage += '\n\nüîí La contrase√±a se guard√≥ en el panel, pero no se pudo actualizar en la nube. El usuario no podr√° entrar con la nueva hasta que configures supabase-server-config.json o uses "¬øOlvidaste tu contrase√±a?" desde la app.';
                                } else {
                                    console.log('‚òÅÔ∏è Contrase√±a actualizada en Supabase Auth; el usuario podr√° entrar con la nueva.');
                                }
                            } catch (err) {
                                console.warn('‚ö†Ô∏è Llamada a actualizar contrase√±a en Auth:', err);
                                cloudSyncMessage += '\n\nüîí No se pudo actualizar la contrase√±a en el servidor. Revisa que el servidor tenga supabase-server-config.json configurado.';
                            }
                        }
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Supabase update profile:', e);
                        cloudSyncMessage = '\n\n‚ö†Ô∏è Se guard√≥ localmente, pero hubo error de conexi√≥n con la nube.';
                    }
                }
            }
            
            // Actualizar referencia de email (nuevo email)
            localStorage.setItem(newEmailKey, updatedUser.userId);
            
            // Si el email cambi√≥, eliminar la referencia antigua
            if (oldEmailKey && existingUser.email !== updatedUser.email) {
                localStorage.removeItem(oldEmailKey);
                console.log(`‚úÖ Referencia de email antigua eliminada: ${oldEmailKey}`);
            }
            
            // üîí Si se cambi√≥ la contrase√±a, invalidar sesiones activas del usuario
            if (newPassword) {
                // Buscar y limpiar sesiones activas del usuario si est√° logueado
                const authKey = localStorage.getItem('np_user');
                if (authKey) {
                    try {
                        const session = JSON.parse(authKey);
                        if (session.userId === updatedUser.userId) {
                            // Si el usuario est√° logueado, cerrar su sesi√≥n
                            localStorage.removeItem('np_user');
                            localStorage.removeItem('nutriplant_user_id');
                            console.log('‚ö†Ô∏è Sesi√≥n del usuario cerrada debido a cambio de contrase√±a');
                        }
                    } catch (e) {
                        // Ignorar errores de parseo
                    }
                }
            }
            
            // üîí Si se cambi√≥ el email, tambi√©n invalidar sesiones
            if (existingUser.email !== updatedUser.email) {
                const authKey = localStorage.getItem('np_user');
                if (authKey) {
                    try {
                        const session = JSON.parse(authKey);
                        if (session.userId === updatedUser.userId || session.email === existingUser.email) {
                            localStorage.removeItem('np_user');
                            localStorage.removeItem('nutriplant_user_id');
                            console.log('‚ö†Ô∏è Sesi√≥n del usuario cerrada debido a cambio de email');
                        }
                    } catch (e) {
                        // Ignorar errores de parseo
                    }
                }
            }
            
            console.log(`‚úÖ Usuario actualizado: ${updatedUser.name} (${updatedUser.email})`);
            if (newPassword) {
                console.log('üîí Nueva contrase√±a guardada');
            }
            if (existingUser.email !== updatedUser.email) {
                console.log(`üìß Email actualizado: ${existingUser.email} ‚Üí ${updatedUser.email}`);
            }
            
            // Invalidar cach√© del admin para que la UI no muestre datos antiguos (especialmente admin)
            try { if (window._adminCloudCache) window._adminCloudCache = null; } catch (e) {}

            if (window._adminPasswordUpdateFailed) {
                alert('‚ö†Ô∏è Contrase√±a en el panel y en profiles se guard√≥, pero NO se pudo actualizar en Supabase Auth.\n\nEl usuario NO podr√° entrar con la nueva contrase√±a hasta que lo arregles.\n\nRevisa:\n1) Que el servidor est√© corriendo: python server.py\n2) Que exista supabase-server-config.json con SUPABASE_URL y SUPABASE_SERVICE_ROLE_KEY\n3) La consola del navegador (F12) para m√°s detalle.');
                window._adminPasswordUpdateFailed = false;
            }
            alert('‚úÖ Usuario actualizado exitosamente.\n\n' + 
                  (newPassword ? 'üîí Nueva contrase√±a guardada. El usuario deber√° iniciar sesi√≥n nuevamente.\n\n' : '') +
                  (existingUser.email !== updatedUser.email ? `üìß Email actualizado: ${existingUser.email} ‚Üí ${updatedUser.email}\n\n` : '') +
                  'Los cambios son efectivos inmediatamente.' + cloudSyncMessage);
            
            closeEditUserModal();
            closeDataViewer();
            
            // Refrescar la vista de usuarios
            setTimeout(() => {
                showAllUsers();
            }, 300);
        }
        window.saveUserChanges = saveUserChanges;
        
        // üìã FUNCIONES PARA EDITAR Y ELIMINAR PROYECTOS
        function editProject(projectId) {
            let project = null;
            const projectKey = `nutriplant_project_${projectId}`;
            const projectValue = localStorage.getItem(projectKey);
            if (projectValue) {
                try {
                    project = JSON.parse(projectValue);
                } catch (e) {
                    alert('Error al cargar el proyecto');
                    return;
                }
            }
            // Si no est√° en localStorage, intentar desde la nube (cach√© del admin)
            if (!project && window._adminCloudCache && Array.isArray(window._adminCloudCache.projects)) {
                const cloudRow = window._adminCloudCache.projects.find(p => p.id === projectId);
                if (cloudRow) {
                    project = {
                        id: cloudRow.id,
                        user_id: cloudRow.user_id,
                        userId: cloudRow.user_id,
                        name: cloudRow.name || cloudRow.title,
                        title: cloudRow.title || cloudRow.name,
                        ...(cloudRow.data || {}),
                        created_at: cloudRow.created_at,
                        updated_at: cloudRow.updated_at
                    };
                }
            }
            if (!project) {
                alert('Proyecto no encontrado');
                return;
            }
            
            const modal = document.getElementById('editProjectModal');
            const content = document.getElementById('editProjectContent');
            
            if (!modal || !content) {
                alert('Modal de edici√≥n no encontrado');
                return;
            }
            
            // Lista de unidades de rendimiento (alineada a Nuevo Proyecto)
            const unidadesRendimientoBase = ['t/ha', 'kg/ha'];
            const unidadesRendimiento = [
                project.unidadRendimiento,
                ...unidadesRendimientoBase
            ].filter(Boolean).filter((value, index, self) => self.indexOf(value) === index);
            
            let html = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h2 style="margin: 0; color: #1e293b; font-size: 24px;">‚úèÔ∏è Editar Proyecto</h2>
                    <button onclick="closeEditProjectModal()" style="background: none; border: none; font-size: 24px; color: #64748b; cursor: pointer; padding: 4px 12px;">√ó</button>
                </div>
                
                <form id="editProjectForm" onsubmit="saveProjectChanges(event, '${projectId}')">
                    <div style="display: grid; gap: 16px;">
                        <!-- ID (solo lectura) -->
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #374151;">ID del Proyecto</label>
                            <div style="padding: 10px; background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; color: #64748b;">
                                ${escapeHtml(projectId)}
                            </div>
                            <small style="color: #64748b; font-size: 12px; margin-top: 4px; display: block;">El ID no se puede modificar.</small>
                        </div>
                        
                        <!-- Nombre -->
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #374151;">T√≠tulo del proyecto *</label>
                            <input type="text" id="edit-project-name" value="${escapeHtml(project.name || project.title || '')}" required 
                                   style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                        </div>
                        
                        <!-- Sector -->
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #374151;">Campo / Sector / Finca</label>
                            <input type="text" id="edit-project-sector" value="${escapeHtml(project.campoOsector || '')}" 
                                   placeholder="Lote 3 / Finca San Jos√©"
                                   style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                        </div>
                        
                        <!-- Cultivo -->
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #374151;">Cultivo</label>
                            <input type="text" id="edit-project-crop" value="${escapeHtml(project.crop_type || project.cultivo || '')}" 
                                   placeholder="Aguacate / Lim√≥n / ..."
                                   style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                        </div>
                        
                        <!-- Variedad -->
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #374151;">Variedad</label>
                            <input type="text" id="edit-project-variedad" value="${escapeHtml(project.variedad || project.variety || '')}" 
                                   placeholder="Ej. Hass, Mendez, etc."
                                   style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                        </div>
                        
                        <!-- Rendimiento esperado -->
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 12px;">
                        <div>
                                <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #374151;">Rendimiento esperado</label>
                                <input type="number" id="edit-project-rendimiento" value="${project.rendimientoEsperado !== null && project.rendimientoEsperado !== undefined ? project.rendimientoEsperado : ''}" 
                                       step="0.01" min="0" placeholder="Ej: 12"
                                   style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #374151;">Unidad</label>
                                <select id="edit-project-unidad-rendimiento" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
            `;
            
            unidadesRendimiento.forEach(unidad => {
                const selected = (project.unidadRendimiento === unidad) ? 'selected' : '';
                html += `<option value="${unidad}" ${selected}>${unidad}</option>`;
            });
            
            html += `
                                </select>
                            </div>
                        </div>
                        
                        <!-- Fechas (solo lectura) -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div>
                                <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #374151;">Fecha de Creaci√≥n</label>
                                <div style="padding: 10px; background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; color: #64748b;">
                                    ${project.created_at ? new Date(project.created_at).toLocaleDateString('es-MX') : 'N/A'}
                                </div>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #374151;">√öltima Actualizaci√≥n</label>
                                <div style="padding: 10px; background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; color: #64748b;">
                                    ${project.updated_at ? new Date(project.updated_at).toLocaleDateString('es-MX') : 'N/A'}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px; margin-top: 24px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                        <button type="button" onclick="closeEditProjectModal()" 
                                style="flex: 1; padding: 12px; background: #e5e7eb; color: #374151; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            Cancelar
                        </button>
                        <button type="submit" 
                                style="flex: 1; padding: 12px; background: #60a5fa; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            Guardar Cambios
                        </button>
                    </div>
                </form>
            `;
            
            content.innerHTML = html;
            modal.style.display = 'flex';
        }
        window.editProject = editProject;
        
        function closeEditProjectModal() {
            const modal = document.getElementById('editProjectModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        window.closeEditProjectModal = closeEditProjectModal;
        
        async function saveProjectChanges(e, projectId) {
            e.preventDefault();
            
            const projectKey = `nutriplant_project_${projectId}`;
            let projectValue = localStorage.getItem(projectKey);
            let project = null;
            let fromCloudOnly = false;
            
            if (projectValue) {
                try {
                    project = JSON.parse(projectValue);
                } catch (e) {
                    alert('‚ùå Error al cargar el proyecto');
                    return;
                }
            } else if (window._adminCloudCache && Array.isArray(window._adminCloudCache.projects)) {
                const cloudRow = window._adminCloudCache.projects.find(p => p.id === projectId);
                if (cloudRow) {
                    project = {
                        id: cloudRow.id,
                        user_id: cloudRow.user_id,
                        userId: cloudRow.user_id,
                        name: cloudRow.name || cloudRow.title,
                        title: cloudRow.title || cloudRow.name,
                        ...(cloudRow.data || {}),
                        created_at: cloudRow.created_at,
                        updated_at: cloudRow.updated_at
                    };
                    fromCloudOnly = true;
                }
            }
            
            if (!project) {
                alert('‚ùå Proyecto no encontrado');
                return;
            }
            
            // üîí VALIDACI√ìN: Asegurar que el proyecto tiene un ID v√°lido
            if (!project.id || project.id !== projectId) {
                console.warn('‚ö†Ô∏è ID del proyecto no coincide, corrigiendo...');
                project.id = projectId;
            }
            
            // Obtener valores editables (solo los campos de la tarjeta del proyecto)
            const name = document.getElementById('edit-project-name').value.trim();
            const sector = document.getElementById('edit-project-sector').value.trim();
            const crop = document.getElementById('edit-project-crop').value.trim();
            const variedad = document.getElementById('edit-project-variedad').value.trim();
            const rendimiento = document.getElementById('edit-project-rendimiento').value.trim();
            const unidadRendimiento = document.getElementById('edit-project-unidad-rendimiento').value.trim();
            
            // üîí PRESERVAR: Crear copia profunda de los datos cr√≠ticos antes de actualizar
            const preservedData = {
                id: project.id,
                code: project.code || project.id,
                created_at: project.created_at,
                createdAt: project.createdAt || project.created_at,
                // Preservar location completa (incluye pol√≠gono)
                location: project.location ? JSON.parse(JSON.stringify(project.location)) : {},
                // Preservar sections completa
                sections: project.sections ? JSON.parse(JSON.stringify(project.sections)) : {},
                // Preservar chat_history
                chat_history: Array.isArray(project.chat_history) ? [...project.chat_history] : [],
                // Preservar informaci√≥n del usuario
                user_id: project.user_id,
                userId: project.userId,
                user_name: project.user_name,
                user_email: project.user_email
            };
            
            // üîí CREAR OBJETO ACTUALIZADO: Usar spread operator para preservar TODOS los campos existentes
            const updatedProject = {
                ...project, // üîí CR√çTICO: Esto preserva TODOS los campos no editables
                // Actualizar solo los campos editables (los de la tarjeta del proyecto)
                name: name,
                title: name, // Mantener compatibilidad
                campoOsector: sector || null,
                crop_type: crop || null,
                cultivo: crop || null, // Mantener compatibilidad
                variedad: variedad || '',
                variety: variedad || '', // Mantener compatibilidad
                rendimientoEsperado: rendimiento ? parseFloat(rendimiento) : null,
                unidadRendimiento: unidadRendimiento || "t/ha",
                // Actualizar fecha de modificaci√≥n
                updated_at: new Date().toISOString(),
                updatedAt: new Date().toISOString(), // Mantener compatibilidad
                // üîí FORZAR PRESERVACI√ìN: Asegurar que los datos cr√≠ticos no se pierdan
                ...preservedData
            };
            
            // üîí VALIDACI√ìN FINAL: Verificar que los datos cr√≠ticos se preservaron
            if (!updatedProject.id || updatedProject.id !== projectId) {
                console.error('‚ùå ERROR: ID del proyecto se perdi√≥ durante la actualizaci√≥n');
                updatedProject.id = projectId;
            }
            if (!updatedProject.location || typeof updatedProject.location !== 'object') {
                console.warn('‚ö†Ô∏è Location no v√°lida, restaurando...');
                updatedProject.location = project.location || {};
            }
            if (!updatedProject.sections || typeof updatedProject.sections !== 'object') {
                console.warn('‚ö†Ô∏è Sections no v√°lida, restaurando...');
            updatedProject.sections = project.sections || {};
            }
            
            // Guardar en localStorage (solo si no es solo-nube)
            if (!fromCloudOnly) {
                try {
                    localStorage.setItem(projectKey, JSON.stringify(updatedProject));
                    console.log(`‚úÖ Proyecto "${projectId}" actualizado en este dispositivo.`);
                } catch (e) {
                    console.error('‚ùå Error al guardar proyecto:', e);
                    alert('‚ùå Error al guardar el proyecto. Por favor, intenta nuevamente.');
                    return;
                }
            }
            
            // üü¢ Sincronizar con Supabase (admin puede editar cualquier proyecto)
            const uid = updatedProject.user_id || updatedProject.userId;
            if (uid && window.getSupabaseClient) {
                const client = window.getSupabaseClient();
                if (client) {
                    try {
                        const row = {
                            id: updatedProject.id,
                            user_id: uid,
                            name: updatedProject.name || updatedProject.title || 'Sin nombre',
                            title: updatedProject.title || updatedProject.name || '',
                            data: updatedProject,
                            updated_at: new Date().toISOString()
                        };
                        const { error } = await client.from('projects').upsert(row, { onConflict: 'id' });
                        if (error) console.warn('‚ö†Ô∏è Error actualizando proyecto en Supabase:', error.message);
                        else console.log('‚òÅÔ∏è Proyecto actualizado en la nube');
                    } catch (e) { console.warn('‚ö†Ô∏è Supabase update project:', e); }
                }
            }
            
            alert('‚úÖ Proyecto actualizado exitosamente' + (fromCloudOnly ? ' en la nube.' : ''));
            closeEditProjectModal();
            closeDataViewer();
            
            // Refrescar la vista de proyectos
            setTimeout(() => {
                showAllProjects();
            }, 300);
        }
        window.saveProjectChanges = saveProjectChanges;
        
        async function deleteProject(projectId) {
            if (!projectId) {
                alert('‚ùå Error: ID de proyecto no v√°lido');
                console.error('deleteProject: projectId es', projectId);
                return;
            }
            
            if (!confirm(`¬øEst√°s seguro de que deseas eliminar el proyecto "${projectId}"?\n\nEsta acci√≥n no se puede deshacer.`)) {
                return;
            }
            
            // üîç BUSCAR PROYECTO EN TODOS LOS FORMATOS POSIBLES
            let projectKey = null;
            let projectValue = null;
            
            // Formato 1: nutriplant_project_${id} (formato nuevo)
            const key1 = `nutriplant_project_${projectId}`;
            if (localStorage.getItem(key1)) {
                projectKey = key1;
                projectValue = localStorage.getItem(key1);
                console.log('‚úÖ Proyecto encontrado con formato nuevo:', projectKey);
            }
            
            // Formato 2: nutriplant-project-${id} (formato legacy)
            if (!projectValue) {
                const key2 = `nutriplant-project-${projectId}`;
                if (localStorage.getItem(key2)) {
                    projectKey = key2;
                    projectValue = localStorage.getItem(key2);
                    console.log('‚úÖ Proyecto encontrado con formato legacy:', projectKey);
                }
            }
            
            // Formato 3: Buscar en todas las claves por ID del objeto
            if (!projectValue) {
                console.log('‚ö†Ô∏è No se encontr√≥ con claves est√°ndar, buscando en todas las claves...');
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    // Buscar tanto formato nuevo como legacy
                    const isProjectKey = key && (
                        key.startsWith('nutriplant_project_') || 
                        key.startsWith('nutriplant-project-')
                    );
                    
                    if (isProjectKey) {
                        try {
                            const value = localStorage.getItem(key);
                            if (value && (value.startsWith('{') || value.startsWith('['))) {
                                const project = JSON.parse(value);
                                if (project && typeof project === 'object') {
                                    // Comparar ID del objeto o ID extra√≠do de la clave
                                    const projectIdFromKey = key.replace(/^nutriplant[-_]project[-_]/, '');
                                    const projectIdInObject = project.id || projectIdFromKey;
                                    
                                    // Verificar si coincide con el ID buscado
                                    if (projectIdInObject === projectId || projectIdFromKey === projectId) {
                                    projectKey = key;
                                    projectValue = value;
                                        console.log('‚úÖ Proyecto encontrado por ID en objeto. Clave:', projectKey, 'ID en objeto:', projectIdInObject);
                                    break;
                                    }
                                }
                            }
                        } catch (e) {
                            console.warn('‚ö†Ô∏è Error parseando proyecto:', key, e);
                            continue;
                        }
                    }
                }
            }
            
            if (!projectValue || !projectKey) {
                // Proyecto solo en la nube: intentar borrar solo en Supabase (primero reportes, luego proyecto)
                if (window.getSupabaseClient) {
                    const client = window.getSupabaseClient();
                    if (client) {
                        try {
                            await client.from('reports').delete().eq('project_id', projectId);
                            const { error } = await client.from('projects').delete().eq('id', projectId);
                            if (!error) {
                                if (window._adminCloudCache && Array.isArray(window._adminCloudCache.projects)) {
                                    window._adminCloudCache.projects = window._adminCloudCache.projects.filter(function(p) { return p.id !== projectId; });
                                }
                                alert('‚úÖ Proyecto eliminado de la nube.');
                                closeDataViewer();
                                loadAdminStats();
                                setTimeout(() => { showAllProjects(); }, 300);
                                return;
                            }
                        } catch (e) { console.warn('Supabase delete:', e); }
                    }
                }
                alert(`‚ùå Proyecto no encontrado con ID: "${projectId}"\n\nVerifica que el proyecto exista.`);
                console.error('deleteProject: Proyecto no encontrado. ID:', projectId);
                return;
            }
            
            try {
                // Obtener el ID real del proyecto (puede ser del objeto o de la clave)
                let actualProjectId = projectId;
                try {
                    const project = JSON.parse(projectValue);
                    if (project && project.id) {
                        actualProjectId = project.id;
                    } else {
                        // Si no tiene ID en el objeto, usar el de la clave
                        actualProjectId = projectKey.replace(/^nutriplant[-_]project[-_]/, '');
                    }
                } catch (e) {
                    // Si no se puede parsear, usar el ID de la clave
                    actualProjectId = projectKey.replace(/^nutriplant[-_]project[-_]/, '');
                }
                
                console.log('üîç ID del proyecto a eliminar:', actualProjectId, '(buscado:', projectId, ')');
                
                // üü¢ Eliminar tambi√©n en la nube (Supabase): primero reportes del proyecto, luego el proyecto
                if (window.getSupabaseClient) {
                    const client = window.getSupabaseClient();
                    if (client) {
                        try {
                            await client.from('reports').delete().eq('project_id', actualProjectId);
                            const { error } = await client.from('projects').delete().eq('id', actualProjectId);
                            if (error) console.warn('‚ö†Ô∏è Error al eliminar proyecto en Supabase:', error.message);
                            else console.log('‚úÖ Proyecto y reportes eliminados de la nube:', actualProjectId);
                        } catch (e) { console.warn('‚ö†Ô∏è Supabase delete project:', e); }
                    }
                }
                // Quitar de la cach√© del admin para que la lista "Todos los Proyectos" se actualice al instante
                if (window._adminCloudCache && Array.isArray(window._adminCloudCache.projects)) {
                    window._adminCloudCache.projects = window._adminCloudCache.projects.filter(function(p) { return p.id !== actualProjectId && p.id !== projectId; });
                }
                
                // Preservar historial de chat del proyecto en el usuario (chat sin proyecto)
                try {
                    const projectObj = JSON.parse(projectValue);
                    const uid = projectObj && (projectObj.user_id || projectObj.userId);
                    if (uid && projectObj.chat_history && Array.isArray(projectObj.chat_history) && projectObj.chat_history.length > 0) {
                        const userKey = 'nutriplant_user_' + uid;
                        const userRaw = localStorage.getItem(userKey);
                        if (userRaw) {
                            const user = JSON.parse(userRaw);
                            user.chat_history_sin_proyecto = user.chat_history_sin_proyecto || [];
                            user.chat_history_sin_proyecto = user.chat_history_sin_proyecto.concat(projectObj.chat_history);
                            localStorage.setItem(userKey, JSON.stringify(user));
                            console.log('üí¨ Historial del chat del proyecto movido al chat sin proyecto del usuario (' + projectObj.chat_history.length + ' mensajes)');
                        }
                    }
                } catch (e) {
                    console.warn('‚ö†Ô∏è No se pudo preservar historial del chat:', e.message);
                }
                
                // Eliminar proyecto de localStorage
                localStorage.removeItem(projectKey);
                console.log('‚úÖ Proyecto eliminado de localStorage:', projectKey);
                
                // Tambi√©n eliminar de las listas de proyectos de usuarios
                // Buscar tanto por el ID original como por el ID real
                let removedFromUsers = 0;
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('nutriplant_user_') && !key.includes('_email_') && !key.includes('_project_')) {
                        try {
                            const value = localStorage.getItem(key);
                            if (value && value.startsWith('{')) {
                                const user = JSON.parse(value);
                                if (user && user.projects && Array.isArray(user.projects)) {
                                    let modified = false;
                                    
                                    // Buscar y eliminar por ID original
                                    let index = user.projects.indexOf(projectId);
                                    if (index > -1) {
                                        user.projects.splice(index, 1);
                                        modified = true;
                                        console.log('‚úÖ Proyecto eliminado de usuario (por ID original):', key);
                                    }
                                    
                                    // Buscar y eliminar por ID real (si es diferente)
                                    if (actualProjectId !== projectId) {
                                        index = user.projects.indexOf(actualProjectId);
                                        if (index > -1) {
                                            user.projects.splice(index, 1);
                                            modified = true;
                                            console.log('‚úÖ Proyecto eliminado de usuario (por ID real):', key);
                                        }
                                    }
                                    
                                    // Buscar por ID extra√≠do de la clave (por si acaso)
                                    const keyId = projectKey.replace(/^nutriplant[-_]project[-_]/, '');
                                    if (keyId !== projectId && keyId !== actualProjectId) {
                                        index = user.projects.indexOf(keyId);
                                        if (index > -1) {
                                            user.projects.splice(index, 1);
                                            modified = true;
                                            console.log('‚úÖ Proyecto eliminado de usuario (por ID de clave):', key);
                                        }
                                    }
                                    
                                    if (modified) {
                                        localStorage.setItem(key, JSON.stringify(user));
                                        removedFromUsers++;
                                    }
                                }
                            }
                        } catch (e) {
                            console.warn('‚ö†Ô∏è Error procesando usuario:', key, e);
                            continue;
                        }
                    }
                }
                
                console.log(`‚úÖ Proyecto eliminado de ${removedFromUsers} usuario(s)`);
                
                alert('‚úÖ Proyecto eliminado exitosamente');
                closeDataViewer();
                
                // Actualizar estad√≠sticas del dashboard
                loadAdminStats();
                
                // Refrescar la vista de proyectos
                setTimeout(() => {
                    showAllProjects();
                }, 300);
            } catch (error) {
                console.error('‚ùå Error al eliminar proyecto:', error);
                alert(`‚ùå Error al eliminar el proyecto: ${error.message}`);
            }
        }
        window.deleteProject = deleteProject;
        
        function findProjectById(projectId) {
            const keyNew = `nutriplant_project_${projectId}`;
            const keyLegacy = `nutriplant-project-${projectId}`;
            let projectValue = localStorage.getItem(keyNew) || localStorage.getItem(keyLegacy);
            let projectKey = localStorage.getItem(keyNew) ? keyNew : (localStorage.getItem(keyLegacy) ? keyLegacy : null);
            
            if (!projectValue) {
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.startsWith('nutriplant_project_') || key.startsWith('nutriplant-project-'))) {
                        try {
                            const value = localStorage.getItem(key);
                            if (value && value.startsWith('{')) {
                                const project = JSON.parse(value);
                                if (project && project.id === projectId) {
                                    projectKey = key;
                                    projectValue = value;
                                    break;
                                }
                            }
                        } catch (e) {
                            continue;
                        }
                    }
                }
            }
            
            // Proyecto creado en otro equipo: solo est√° en la nube (Supabase)
            const cloudList = (window._adminCloudCache && Array.isArray(window._adminCloudCache.projects)) ? window._adminCloudCache.projects : [];
            const cloudProj = cloudList.find(function(p) { return p && (String(p.id) === String(projectId)); });

            if (projectValue && projectKey) {
                try {
                    const project = JSON.parse(projectValue);
                    // Si local viene "vac√≠o" (sin secciones reales), preferir versi√≥n de nube.
                    // Esto pasa cuando hay una copia local incompleta del mismo id.
                    const localHasData =
                        !!(project && typeof project === 'object' && (
                            (project.data && typeof project.data === 'object' && Object.keys(project.data).length > 0) ||
                            (project.sections && typeof project.sections === 'object' && Object.keys(project.sections).length > 0) ||
                            project.location || project.amendments || project.granular || project.fertirriego || project.hidroponia || project.vpdAnalysis
                        ));
                    if (!localHasData && cloudProj) return { project: cloudProj, projectKey: null };
                    return { project, projectKey };
                } catch (e) {
                    if (cloudProj) return { project: cloudProj, projectKey: null };
                    return null;
                }
            }

            if (cloudProj) {
                return { project: cloudProj, projectKey: null };
            }
            return null;
        }
        
        function findUserByEmail(email) {
            const normalizedEmail = (email || '').trim().toLowerCase();
            if (!normalizedEmail) return null;
            
            const emailKey = `nutriplant_user_email_${normalizedEmail}`;
            const userId = localStorage.getItem(emailKey);
            if (userId) {
                const userValue = localStorage.getItem(`nutriplant_user_${userId}`);
                if (userValue && userValue.startsWith('{')) {
                    try {
                        const user = JSON.parse(userValue);
                        return { userId, user };
                    } catch (e) {
                        return null;
                    }
                }
            }
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('nutriplant_user_') && !key.includes('_email_') && !key.includes('_project_')) {
                    try {
                        const value = localStorage.getItem(key);
                        if (value && value.startsWith('{')) {
                            const user = JSON.parse(value);
                            if (user && user.email && user.email.toLowerCase() === normalizedEmail) {
                                const foundUserId = key.replace('nutriplant_user_', '');
                                return { userId: foundUserId, user };
                            }
                        }
                    } catch (e) {
                        continue;
                    }
                }
            }
            
            return null;
        }
        
        /** Buscar usuario por email: primero localStorage, luego lista de la nube (Supabase) */
        function findUserByEmailOrCloud(email) {
            const rec = findUserByEmail(email);
            if (rec && rec.user) return rec;
            const emailLc = (email || '').trim().toLowerCase();
            if (!emailLc) return null;
            var cloudUsers = (window._adminCloudCache && window._adminCloudCache.users) || [];
            var u = cloudUsers.find(function(x) { return (x.email || '').toLowerCase() === emailLc; });
            if (u && (u.id || u.userId)) {
                return { userId: u.id || u.userId, user: u };
            }
            return null;
        }

        async function assignProjectToUser(projectId) {
            const projectRecord = findProjectById(projectId);
            if (!projectRecord) {
                alert('‚ùå Proyecto no encontrado');
                return;
            }
            
            const email = prompt('Correo del usuario al que deseas asignar este proyecto (debe ser un usuario que est√© en Supabase / en la lista de usuarios):');
            if (!email) return;
            
            const userRecord = findUserByEmailOrCloud(email);
            if (!userRecord || !userRecord.user) {
                alert('‚ùå Usuario no encontrado. Escribe el correo de un usuario que aparezca en "Todos los usuarios" (p. ej. en Supabase).');
                return;
            }
            
            const { project, projectKey } = projectRecord;
            const { userId, user } = userRecord;
            const actualProjectId = project.id || projectId;
            project.id = actualProjectId;
            
            // Actualizar propietario del proyecto
            project.user_id = userId;
            project.userId = userId;
            project.user_name = user.name || user.email || '';
            project.user_email = user.email || email;
            project.updated_at = new Date().toISOString();
            project.updatedAt = project.updated_at;
            
            // Limpiar flags de hu√©rfano
            delete project.orphaned_at;
            delete project.orphaned_by;
            delete project.orphaned_reason;
            delete project._isOrphan;
            
            // Guardar proyecto
            try {
                localStorage.setItem(projectKey, JSON.stringify(project));
            } catch (e) {
                alert('‚ùå Error al guardar el proyecto');
                console.error(e);
                return;
            }
            
            // Agregar proyecto al usuario
            if (!user.projects || !Array.isArray(user.projects)) {
                user.projects = [];
            }
            if (!user.projects.includes(actualProjectId)) {
                user.projects.push(actualProjectId);
            }
            
            try {
                localStorage.setItem(`nutriplant_user_${userId}`, JSON.stringify(user));
            } catch (e) {
                alert('‚ùå Error al guardar el usuario');
                console.error(e);
                return;
            }

            // üü¢ Sincronizar reasignaci√≥n en Supabase para que quede reflejado en otros dispositivos
            let cloudMsg = '';
            if (window.getSupabaseClient) {
                const client = window.getSupabaseClient();
                if (client) {
                    try {
                        const updated_at = new Date().toISOString();
                        // 1) Intentar solo actualizar user_id (si el proyecto ya existe en la nube)
                        const { data: updatedRows, error: updateError } = await client
                            .from('projects')
                            .update({ user_id: userId, updated_at: updated_at })
                            .eq('id', actualProjectId)
                            .select('id');
                        if (!updateError && updatedRows && updatedRows.length > 0) {
                            cloudMsg = '\n\n‚òÅÔ∏è Proyecto asignado en la nube.';
                        } else {
                            // 2) Si no exist√≠a o fall√≥, hacer upsert con datos m√≠nimos
                            const row = {
                                id: actualProjectId,
                                user_id: userId,
                                name: project.name || project.title || 'Sin nombre',
                                title: project.title || project.name || '',
                                data: project,
                                updated_at: updated_at
                            };
                            const { error: projectError } = await client.from('projects').upsert(row, { onConflict: 'id' });
                            if (projectError) {
                                console.warn('‚ö†Ô∏è Error reasignando proyecto en Supabase:', projectError.message);
                                cloudMsg = '\n\n‚ö†Ô∏è Se asign√≥ localmente, pero fall√≥ sincronizar en la nube: ' + (projectError.message || projectError.code || '');
                            } else {
                                cloudMsg = '\n\n‚òÅÔ∏è Proyecto y reportes quedaron asignados en la nube.';
                            }
                        }
                        if (cloudMsg.indexOf('‚òÅÔ∏è') !== -1) {
                            const { error: reportsError } = await client.from('reports').update({ user_id: userId }).eq('project_id', actualProjectId);
                            if (reportsError) console.warn('‚ö†Ô∏è Reportes del proyecto no se reasignaron en nube:', reportsError.message);
                            if (window._adminCloudCache) window._adminCloudCache.projects = null;
                            if (window._adminCloudCache && window._adminCloudCache.reports) window._adminCloudCache.reports = null;
                        }
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Supabase assign project:', e);
                        cloudMsg = '\n\n‚ö†Ô∏è Se asign√≥ localmente, pero fall√≥ sincronizar en la nube: ' + (e.message || String(e));
                    }
                }
            }

            alert(`‚úÖ Proyecto asignado a ${user.name || user.email}${cloudMsg}`);
            closeDataViewer();
            loadAdminStats();
            setTimeout(() => {
                showAllProjects();
            }, 300);
        }
        window.assignProjectToUser = assignProjectToUser;
        
        async function deleteUser(userId) {
            const userKey = `nutriplant_user_${userId}`;
            let userValue = localStorage.getItem(userKey);
            let user = null;
            
            if (userValue) {
                try {
                    user = JSON.parse(userValue);
                } catch (e) {
                    alert('Error al cargar el usuario');
                    return;
                }
            } else {
                // Usuario solo en la nube (nunca entr√≥ en este navegador): obtener de la lista
                const allUsers = getAllUsers();
                user = allUsers.find(u => (u.id || u.userId) === userId);
            }
            
            if (!user) {
                alert('Usuario no encontrado');
                return;
            }
            
            // üîê PROTECCI√ìN: No permitir eliminar el usuario administrador
            const isAdminUser = user.email === 'admin@nutriplantpro.com' || user.isAdmin === true;
            if (isAdminUser) {
                alert('üîí ERROR: No se puede eliminar la cuenta de Administrador.\n\nEsta es una cuenta protegida del sistema.');
                return;
            }
            
            const isSupabaseUser = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(String(userId));
            const msgCloud = isSupabaseUser ? '\n\nTambi√©n se eliminar√° de la nube (Supabase): perfil y sus proyectos.' : '';
            if (!confirm(`¬øEst√°s seguro de que deseas eliminar el usuario "${user.name || user.email}"?\n\nSus proyectos en este navegador quedar√°n como hu√©rfanos (podr√°s recuperarlos si hace falta).${msgCloud}\n\nEsta acci√≥n no se puede deshacer.`)) {
                return;
            }
            
            let authDeleted = false;
            let authDeleteError = null;
            // üü¢ Borrar en Supabase Authentication (un solo clic)
            if (isSupabaseUser) {
                const params = new URLSearchParams(window.location.search);
                const adminKey = params.get('k') || (typeof ADMIN_ACCESS_KEY !== 'undefined' ? ADMIN_ACCESS_KEY : '');
                const base = window.location.origin;
                if (!base || base === 'null' || base.startsWith('file://')) {
                    authDeleteError = 'Abre el panel de admin desde el servidor (ej. http://localhost:8000/admin/?k=...) y con el servidor corriendo (python server.py). No lo abras como archivo.';
                } else {
                    try {
                        const res = await fetch(base + '/api/admin/delete-user', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ admin_key: adminKey, user_id: userId })
                        });
                        const json = await res.json().catch(function() { return {}; });
                        if (res.ok && json.ok) {
                            authDeleted = true;
                        } else {
                            authDeleteError = json.error || ('HTTP ' + res.status);
                            if (typeof authDeleteError === 'string' && authDeleteError.indexOf('Ruta no encontrada: /api/admin/delete-user') !== -1) {
                                authDeleteError = 'El servidor no tiene el endpoint nuevo. Reinicia con: python3 server.py';
                            }
                        }
                    } catch (e) {
                        authDeleteError = (e.message || String(e)) + '. ¬øEst√° corriendo el servidor? (python server.py)';
                    }
                }
            }
            
            // üü¢ Eliminar perfil en la nube si es usuario de Supabase (proyectos por CASCADE)
            if (isSupabaseUser && window.getSupabaseClient) {
                const client = window.getSupabaseClient();
                if (client) {
                    try {
                        const { error: delError } = await client.from('profiles').delete().eq('id', userId);
                        if (delError) {
                            console.warn('Error al eliminar usuario en Supabase:', delError);
                            if (!authDeleted) alert('‚úÖ Usuario eliminado en este dispositivo.\n\n‚ö†Ô∏è No se pudo eliminar en la nube: ' + (delError.message || 'revisa pol√≠ticas RLS. Ejecuta supabase-admin-delete-user.sql en Supabase.'));
                        }
                    } catch (e) {
                        console.warn('Error eliminando en Supabase:', e);
                        if (!authDeleted) alert('‚úÖ Usuario eliminado en este dispositivo.\n\n‚ö†Ô∏è Error al sincronizar con la nube: ' + (e.message || ''));
                    }
                }
            }
            
            // Eliminar referencias de email en localStorage
            if (user.email) {
                localStorage.removeItem(`nutriplant_user_email_${user.email}`);
            }
            
            // Marcar proyectos del usuario como hu√©rfanos en localStorage (NO se borran)
            if (user.projects && Array.isArray(user.projects)) {
                user.projects.forEach(projectId => {
                    const keyNew = `nutriplant_project_${projectId}`;
                    const keyLegacy = `nutriplant-project-${projectId}`;
                    const projectValue = localStorage.getItem(keyNew) || localStorage.getItem(keyLegacy);
                    const projectKey = localStorage.getItem(keyNew) ? keyNew : keyLegacy;
                    if (projectValue && projectKey) {
                        try {
                            const project = JSON.parse(projectValue);
                            project.orphaned_at = new Date().toISOString();
                            project.orphaned_by = userId;
                            project.orphaned_reason = 'user_deleted';
                            localStorage.setItem(projectKey, JSON.stringify(project));
                        } catch (e) {
                            console.warn('‚ö†Ô∏è Error marcando proyecto hu√©rfano:', projectId, e.message);
                        }
                    }
                });
            }
            
            // Eliminar usuario de localStorage
            localStorage.removeItem(userKey);
            
            if (isSupabaseUser) {
                if (authDeleted) {
                    alert('‚úÖ Usuario eliminado (perfil, proyectos y cuenta en Supabase Authentication).');
                } else {
                    let msg = '‚úÖ Usuario eliminado en este dispositivo (y perfil en la nube si se pudo).\n\n‚ö†Ô∏è No se borr√≥ en Supabase Authentication.';
                    if (authDeleteError) msg += '\n\nMotivo: ' + authDeleteError;
                    msg += '\n\nüí° Para poder usar ese correo de nuevo, b√≥rralo tambi√©n en Supabase: Authentication ‚Üí Users ‚Üí buscar el usuario ‚Üí Delete user.';
                    alert(msg);
                }
            } else {
                alert('‚úÖ Usuario eliminado exitosamente.\n\nSus proyectos quedaron guardados como hu√©rfanos.');
            }
            closeDataViewer();
            // Invalidar cach√© de usuarios para que showAllUsers vuelva a cargar desde la nube y la lista se actualice sin recargar la p√°gina
            if (window._adminCloudCache) window._adminCloudCache.users = null;
            loadAdminStats();
            setTimeout(() => { showAllUsers(); }, 300);
        }
        window.deleteUser = deleteUser;
        
        // üëÅÔ∏è FUNCI√ìN PARA VER DETALLES COMPLETOS DEL PROYECTO
        /** Abre detalle del proyecto y deja registrada la vista a la que volver con el bot√≥n ‚Üê (ej. Todos los Proyectos). */
        function viewProjectDetailsWithReturn(projectId, returnViewName) {
            var fn = typeof returnViewName === 'function' ? returnViewName : (window[returnViewName]);
            var params = (window._dataViewerState && window._dataViewerState.config && window._dataViewerState.config.previousViewParamsForProject) ? window._dataViewerState.config.previousViewParamsForProject : [];
            if (typeof fn === 'function') setPreviousView(fn, params || []);
            viewProjectDetails(projectId);
        }
        window.viewProjectDetailsWithReturn = viewProjectDetailsWithReturn;

        function viewProjectDetails(projectId, fromView = null, fromViewParams = null) {
            // Guardar vista anterior si se proporciona
            if (fromView) {
                setPreviousView(typeof fromView === 'function' ? fromView : window[fromView], fromViewParams || []);
            }
            const projectRecord = findProjectById(projectId);
            if (!projectRecord) {
                alert('‚ùå Proyecto no encontrado');
                return;
            }
            // Proyectos desde la nube tienen { id, name, data, ... }; los datos reales est√°n en data. Unificar para que la vista vea sections, hidroponia, etc.
            let project = projectRecord.project;
            let cloudData = null;
            if (project && project.data && typeof project.data === 'object') cloudData = project.data;
            else if (project && typeof project.data === 'string') {
                try { cloudData = JSON.parse(project.data); } catch (e) { cloudData = null; }
            }
            if (projectRecord.projectKey === null && project && cloudData && typeof cloudData === 'object') {
                const d = cloudData;
                project = {
                    ...d,
                    id: project.id,
                    name: project.name || d.name || d.title,
                    title: project.title || d.title,
                    created_at: project.created_at || d.created_at,
                    updated_at: project.updated_at || d.updated_at,
                    user_id: project.user_id || d.user_id,
                    userId: project.user_id || d.user_id || d.userId
                };
            }
            function resolveProjectOwnerUserId(projectRef) {
                if (projectRef && (projectRef.user_id || projectRef.userId)) {
                    return String(projectRef.user_id || projectRef.userId);
                }
                try {
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (!key || !key.startsWith('nutriplant_user_')) continue;
                        const raw = localStorage.getItem(key);
                        if (!raw || !raw.startsWith('{')) continue;
                        const user = JSON.parse(raw);
                        const projects = Array.isArray(user.projects) ? user.projects : [];
                        if (projects.includes(projectId)) {
                            return String(user.id || key.replace('nutriplant_user_', ''));
                        }
                    }
                } catch (e) {
                    console.warn('‚ö†Ô∏è No se pudo resolver userId del proyecto:', e);
                }
                return null;
            }

            const reportOwnerUserId = resolveProjectOwnerUserId(project);
            const reportsStorageKey = reportOwnerUserId ? `nutriplant_reports_${reportOwnerUserId}_${projectId}` : null;
            let generatedReports = [];
            // Primero: reportes desde la nube (tabla reports)
            const cloudReports = (window._adminCloudCache && window._adminCloudCache.reports) || [];
            const cloudForProject = cloudReports.filter(function(r) {
                return r && (String(r.user_id) === String(reportOwnerUserId)) && (String(r.project_id) === String(projectId));
            });
            cloudForProject.forEach(function(row) {
                var report = (row.data && typeof row.data === 'object') ? row.data : {};
                if (row.id && !report.id) report.id = row.id;
                if (row.created_at && !report.timestamp) report.timestamp = row.created_at;
                generatedReports.push(report);
            });
            var cloudIds = new Set(generatedReports.map(function(r) { return r && r.id; }).filter(Boolean));
            // Segundo: reportes en localStorage que no est√©n ya en nube (para no duplicar)
            if (reportsStorageKey) {
                try {
                    const rawReports = localStorage.getItem(reportsStorageKey);
                    if (rawReports) {
                        const parsed = JSON.parse(rawReports);
                        if (Array.isArray(parsed)) {
                            parsed.forEach(function(r) {
                                if (r && r.id && !cloudIds.has(r.id)) {
                                    generatedReports.push(r);
                                    cloudIds.add(r.id);
                                }
                            });
                        }
                    }
                } catch (e) {
                    console.warn('‚ö†Ô∏è No se pudieron cargar reportes generados para admin:', e);
                }
            }
            generatedReports.sort((a, b) => {
                const da = new Date(a?.timestamp || a?.createdAt || a?.date || 0).getTime();
                const db = new Date(b?.timestamp || b?.createdAt || b?.date || 0).getTime();
                return db - da;
            });
            
            // Construir HTML con todas las secciones
            let html = `
                <div style="padding: 24px; max-height: 90vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            ${navigationHistory.previousView ? `
                                <button onclick="goBack()" 
                                        style="background: #f3f4f6; border: none; font-size: 20px; color: #374151; cursor: pointer; padding: 6px 12px; border-radius: 6px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" 
                                        onmouseover="this.style.background='#e5e7eb'; this.style.color='#1f2937';" 
                                        onmouseout="this.style.background='#f3f4f6'; this.style.color='#374151';"
                                        title="Volver atr√°s">
                                    ‚Üê
                                </button>
                            ` : ''}
                        <h2 style="margin: 0; color: #1e293b; font-size: 24px;">üìã Detalles del Proyecto: ${escapeHtml(project.name || 'Sin nombre')}</h2>
                        </div>
                        <button onclick="closeDataViewer()" 
                                style="background: none; border: none; font-size: 24px; color: #64748b; cursor: pointer; padding: 4px 12px; transition: all 0.2s;" 
                                onmouseover="this.style.color='#ef4444'; this.style.background='#fef2f2'; this.style.borderRadius='6px';" 
                                onmouseout="this.style.color='#64748b'; this.style.background='none';"
                                title="Cerrar y volver al panel principal">
                            √ó
                        </button>
                    </div>
                    
                    <div style="display: grid; gap: 20px;">
                        <!-- Informaci√≥n B√°sica -->
                        <div style="background: #f8fafc; padding: 20px; border-radius: 8px; border-left: 4px solid #60a5fa;">
                            <h3 style="margin: 0 0 16px 0; color: #1e293b; font-size: 18px;">üìå Informaci√≥n B√°sica</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                                <div><strong>ID:</strong> ${escapeHtml(project.id || 'N/A')}</div>
                                <div><strong>Nombre:</strong> ${escapeHtml(project.name || 'Sin nombre')}</div>
                                <div><strong>Cultivo:</strong> ${escapeHtml(project.crop_type || 'N/A')}</div>
                                <div><strong>Variedad:</strong> ${escapeHtml(project.variedad || 'N/A')}</div>
                                <div><strong>Creado:</strong> ${project.created_at ? new Date(project.created_at).toLocaleString('es-MX') : 'N/A'}</div>
                                <div><strong>Actualizado:</strong> ${project.updated_at ? new Date(project.updated_at).toLocaleString('es-MX') : 'N/A'}</div>
                            </div>
                        </div>
                        
                        <!-- Uso real por secci√≥n (peso: bajo / medio / alto) -->
                        <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; border-left: 4px solid #16a34a;">
                            <h3 style="margin: 0 0 12px 0; color: #1e293b; font-size: 18px;">üìä Uso real por secci√≥n</h3>
                            <p style="margin: 0 0 12px 0; color: #64748b; font-size: 13px;">Nivel de uso de cada secci√≥n del proyecto (no solo si tiene un valor m√≠nimo).</p>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px;">
                                ${(function() {
                                    var sw = getSectionWeights(project, { reportCount: generatedReports.length });
                                    var labels = { 0: '‚Äî', 1: 'Bajo', 2: 'Medio', 3: 'Alto' };
                                    var colors = { 0: '#e5e7eb', 1: '#fef3c7', 2: '#93c5fd', 3: '#86efac' };
                                    var parts = [];
                                    Object.keys(sw).forEach(function(k) {
                                        var lv = sw[k];
                                        parts.push('<div style="padding: 6px 10px; border-radius: 6px; background: ' + (colors[lv] || '#f1f5f9') + '; font-size: 12px;"><strong>' + k + '</strong>: ' + (labels[lv] || lv) + '</div>');
                                    });
                                    return parts.join('');
                                })()}
                            </div>
                        </div>
            `;

            // Resumen del chat IA (este proyecto)
            const chatHist = Array.isArray(project.chat_history) ? project.chat_history : [];
            const chatInteractions = chatHist.filter(function (m) { return m && (m.sender === 'user' || m.type === 'user'); }).length;
            const chatCostEst = (chatInteractions * 0.001).toFixed(4);
            html += `
                <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; border-left: 4px solid #0ea5e9;">
                    <h3 style="margin: 0 0 16px 0; color: #1e293b; font-size: 18px;">üí¨ Resumen del chat IA</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px;">
                        <div><strong style="color: #0c4a6e;">Mensajes totales:</strong><br><span style="color: #0369a1; font-size: 16px; font-weight: 600;">${chatHist.length}</span></div>
                        <div><strong style="color: #0c4a6e;">Interacciones IA:</strong><br><span style="color: #0369a1; font-size: 16px; font-weight: 600;">${chatInteractions}</span></div>
                        <div><strong style="color: #0c4a6e;">Costo est. (USD):</strong><br><span style="color: #0369a1; font-size: 16px; font-weight: 600;">$${chatCostEst}</span></div>
                    </div>
                    ${chatHist.length === 0 ? '<p style="color: #64748b; font-size: 14px; margin: 12px 0 0 0;">A√∫n no hay mensajes en el chat de este proyecto.</p>' : ''}
                </div>
            `;

            html += `
                <div style="background: #eef2ff; padding: 20px; border-radius: 8px; border-left: 4px solid #6366f1;">
                    <h3 style="margin: 0 0 16px 0; color: #1e293b; font-size: 18px;">üìÑ Reportes Generados (${generatedReports.length})</h3>
                    ${generatedReports.length
                        ? generatedReports.map((r, idx) => {
                            const reportName = r?.project?.name || r?.projectName || project.name || `Reporte ${idx + 1}`;
                            const rawDate = r?.timestamp || r?.createdAt || r?.date || '';
                            const dateText = rawDate ? new Date(rawDate).toLocaleString('es-MX') : 'Fecha no disponible';
                            const sections = Array.isArray(r?.selectedSections) ? r.selectedSections : [];
                            const sectionLabelMap = {
                                location: 'Ubicaci√≥n',
                                amendments: 'Enmiendas',
                                granular: 'Nutrici√≥n Granular',
                                fertigation: 'Fertirriego',
                                hidroponia: 'Hidropon√≠a',
                                vpd: 'D√©ficit de Presi√≥n de Vapor'
                            };
                            const sectionsText = sections.length
                                ? sections.map(s => sectionLabelMap[s] || s).join(', ')
                                : 'Secciones no especificadas';
                            return `
                                <div style="background: #fff; border: 1px solid #c7d2fe; border-radius: 8px; padding: 12px; margin-bottom: 10px;">
                                    <div style="display:flex;justify-content:space-between;gap:12px;align-items:flex-start;flex-wrap:wrap;">
                                        <div>
                                            <div style="font-weight:700;color:#3730a3;">${escapeHtml(reportName)}</div>
                                            <div style="font-size:12px;color:#64748b;margin-top:4px;">${escapeHtml(dateText)}</div>
                                            <div style="font-size:12px;color:#334155;margin-top:6px;"><strong>Secciones:</strong> ${escapeHtml(sectionsText)}</div>
                                            ${r?.reportHTML
                                                ? '<div style="font-size:11px;color:#059669;margin-top:4px;">HTML de reporte disponible para abrir/imprimir</div>'
                                                : '<div style="font-size:11px;color:#b45309;margin-top:4px;">Reporte antiguo (sin HTML guardado)</div>'}
                                        </div>
                                        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
                                            <button onclick="openProjectSavedReport('${encodeURIComponent(reportOwnerUserId || '')}', '${encodeURIComponent(projectId)}', '${encodeURIComponent(String(r?.id || ''))}')"
                                                    style="background:#4f46e5;color:white;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;"
                                                    title="Abrir e imprimir reporte">
                                                üñ®Ô∏è Abrir/Imprimir
                                            </button>
                                            <span style="font-size:11px;color:#6366f1;background:#eef2ff;border:1px solid #c7d2fe;padding:2px 8px;border-radius:999px;">Guardado en usuario/proyecto</span>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')
                        : '<p style="color:#64748b;font-style:italic;margin:0;">No hay reportes generados guardados para este proyecto.</p>'}
                </div>
            `;
            
            // Secci√≥n: UBICACI√ìN (SIEMPRE mostrar)
            const location = project.location || project.sections?.ubicacion || null;
            const hasLocationData = location && typeof location === 'object' && (location.polygon || location.coordinates);
            const hasPolygon = hasLocationData && location.polygon && Array.isArray(location.polygon) && location.polygon.length >= 3;
            
                html += `
                    <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; border-left: 4px solid #10b981;">
                    <h3 style="margin: 0 0 16px 0; color: #1e293b; font-size: 18px;">
                        üìç Ubicaci√≥n
                        ${!hasLocationData ? '<span style="color: #64748b; font-size: 14px; font-weight: normal; margin-left: 8px;">(Sin datos)</span>' : ''}
                    </h3>
                    ${hasLocationData 
                        ? (hasPolygon 
                            ? `
                                <div style="background: white; padding: 16px; border-radius: 6px;">
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 16px;">
                                        ${location.areaHectares !== undefined && location.areaHectares !== null 
                                            ? `<div><strong style="color: #1e293b;">√Årea:</strong><br><span style="color: #10b981; font-size: 16px; font-weight: 600;">${typeof location.areaHectares === 'number' ? location.areaHectares.toFixed(2) : location.areaHectares} ha</span></div>` 
                                            : ''}
                                        ${location.perimeter !== undefined && location.perimeter !== null 
                                            ? `<div><strong style="color: #1e293b;">Per√≠metro:</strong><br><span style="color: #64748b; font-size: 14px;">${typeof location.perimeter === 'number' ? (location.perimeter / 1000).toFixed(2) + ' km' : location.perimeterDisplay || location.perimeter}</span></div>` 
                                            : ''}
                                        ${location.polygon && location.polygon.length 
                                            ? `<div><strong style="color: #1e293b;">V√©rtices:</strong><br><span style="color: #64748b; font-size: 14px;">${location.polygon.length} puntos</span></div>` 
                                            : ''}
                                        ${location.center && location.center.lat && location.center.lng 
                                            ? `<div><strong style="color: #1e293b;">Centro:</strong><br><span style="color: #64748b; font-size: 12px; font-family: monospace;">${location.center.lat.toFixed(6)}, ${location.center.lng.toFixed(6)}</span></div>` 
                                            : ''}
                    </div>
                                    <button onclick="showMapModalForProject('${project.id}')" 
                                            style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s;"
                                            onmouseover="this.style.background='#059669'; this.style.transform='translateY(-1px)';"
                                            onmouseout="this.style.background='#10b981'; this.style.transform='translateY(0)';">
                                        üó∫Ô∏è Ver en Mapa
                                    </button>
                                </div>
                            `
                            : `<pre style="background: white; padding: 12px; border-radius: 6px; overflow-x: auto; font-size: 12px; max-height: 300px; overflow-y: auto;">${JSON.stringify(location, null, 2)}</pre>`
                        )
                        : '<p style="color: #94a3b8; font-style: italic; margin: 0;">Esta secci√≥n a√∫n no ha sido configurada en el proyecto.</p>'
                    }
                </div>
            `;
            
            // Secci√≥n: ENMIENDAS (SIEMPRE mostrar)
            const enmiendas = project.sections?.enmiendas || project.amendments || null;
            const enmiendasResults = enmiendas?.results || {};
            const hasEnmiendasData = enmiendas && typeof enmiendas === 'object' && (
                (enmiendas.selected?.length > 0) ||
                (enmiendasResults.detailedHTML && String(enmiendasResults.detailedHTML).trim() !== '') ||
                (enmiendasResults.type && enmiendasResults.type !== '-' && String(enmiendasResults.type).trim() !== '') ||
                (enmiendasResults.amount != null && enmiendasResults.amount !== '-' && String(enmiendasResults.amount).trim() !== '')
            );
            
            // Obtener datos de an√°lisis de suelo (initial, properties, adjustments) para mostrar dentro de Enmiendas
            const soilAnalysis = project.sections?.analisis || project.soilAnalysis || null;
            const hasSoilData = soilAnalysis && typeof soilAnalysis === 'object' && (
                (soilAnalysis.initial && Object.keys(soilAnalysis.initial).length > 0) ||
                (soilAnalysis.properties && Object.keys(soilAnalysis.properties).length > 0) ||
                (soilAnalysis.adjustments && Object.keys(soilAnalysis.adjustments).length > 0)
            );
            
            // Verificar si hay HTML detallado guardado (contiene toda la informaci√≥n formateada)
            const detailedHTML = enmiendas?.results?.detailedHTML || null;
            
                html += `
                    <div style="background: #fef3c7; padding: 20px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                    <h3 style="margin: 0 0 16px 0; color: #1e293b; font-size: 18px;">
                        üöú Enmiendas
                        ${!hasEnmiendasData && !hasSoilData ? '<span style="color: #64748b; font-size: 14px; font-weight: normal; margin-left: 8px;">(Sin datos)</span>' : ''}
                    </h3>
            `;
            
            // Mostrar datos de an√°lisis de suelo si existen (ANTES de los resultados de enmiendas)
            if (hasSoilData) {
                html += `
                    <div style="background: #fff5f5; padding: 16px; border-radius: 6px; margin-bottom: 16px; border: 1px solid #fed7d7;">
                        <h4 style="margin: 0 0 12px 0; color: #1e293b; font-size: 16px; font-weight: 600;">üî¨ Datos de An√°lisis de Suelo (para c√°lculo de enmiendas)</h4>
                `;
                
                // Elementos Iniciales
                if (soilAnalysis.initial && Object.keys(soilAnalysis.initial).some(key => soilAnalysis.initial[key] !== 0 && soilAnalysis.initial[key] !== null && soilAnalysis.initial[key] !== undefined)) {
                    html += `
                        <div style="margin-bottom: 12px;">
                            <strong style="color: #1e293b; font-size: 14px;">Elementos Iniciales (meq/100g):</strong>
                            <div style="background: white; padding: 10px; border-radius: 4px; margin-top: 6px; font-size: 13px; display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px;">
                                ${soilAnalysis.initial.k !== undefined && soilAnalysis.initial.k !== null ? `<div><strong>K:</strong> ${soilAnalysis.initial.k}</div>` : ''}
                                ${soilAnalysis.initial.ca !== undefined && soilAnalysis.initial.ca !== null ? `<div><strong>Ca:</strong> ${soilAnalysis.initial.ca}</div>` : ''}
                                ${soilAnalysis.initial.mg !== undefined && soilAnalysis.initial.mg !== null ? `<div><strong>Mg:</strong> ${soilAnalysis.initial.mg}</div>` : ''}
                                ${soilAnalysis.initial.h !== undefined && soilAnalysis.initial.h !== null ? `<div><strong>H:</strong> ${soilAnalysis.initial.h}</div>` : ''}
                                ${soilAnalysis.initial.na !== undefined && soilAnalysis.initial.na !== null ? `<div><strong>Na:</strong> ${soilAnalysis.initial.na}</div>` : ''}
                                ${soilAnalysis.initial.al !== undefined && soilAnalysis.initial.al !== null ? `<div><strong>Al:</strong> ${soilAnalysis.initial.al}</div>` : ''}
                                ${soilAnalysis.initial.cic !== undefined && soilAnalysis.initial.cic !== null ? `<div><strong>CIC:</strong> ${soilAnalysis.initial.cic}</div>` : ''}
                            </div>
                    </div>
                `;
            }
            
                // Propiedades
                if (soilAnalysis.properties && Object.keys(soilAnalysis.properties).some(key => soilAnalysis.properties[key] !== 0 && soilAnalysis.properties[key] !== null && soilAnalysis.properties[key] !== undefined)) {
                html += `
                        <div style="margin-bottom: 12px;">
                            <strong style="color: #1e293b; font-size: 14px;">Propiedades del Suelo:</strong>
                            <div style="background: white; padding: 10px; border-radius: 4px; margin-top: 6px; font-size: 13px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 8px;">
                                ${soilAnalysis.properties.ph !== undefined && soilAnalysis.properties.ph !== null && soilAnalysis.properties.ph !== 0 ? `<div><strong>pH:</strong> ${soilAnalysis.properties.ph}</div>` : ''}
                                ${soilAnalysis.properties.density !== undefined && soilAnalysis.properties.density !== null && soilAnalysis.properties.density !== 0 ? `<div><strong>Densidad:</strong> ${soilAnalysis.properties.density} g/cm¬≥</div>` : ''}
                                ${soilAnalysis.properties.depth !== undefined && soilAnalysis.properties.depth !== null && soilAnalysis.properties.depth !== 0 ? `<div><strong>Profundidad:</strong> ${soilAnalysis.properties.depth} cm</div>` : ''}
                            </div>
                    </div>
                `;
            }
            
                // Ajustes
                if (soilAnalysis.adjustments && Object.keys(soilAnalysis.adjustments).some(key => soilAnalysis.adjustments[key] !== 0 && soilAnalysis.adjustments[key] !== null && soilAnalysis.adjustments[key] !== undefined)) {
                html += `
                        <div style="margin-bottom: 12px;">
                            <strong style="color: #1e293b; font-size: 14px;">Ajustes Requeridos (meq/100g):</strong>
                            <div style="background: white; padding: 10px; border-radius: 4px; margin-top: 6px; font-size: 13px; display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px;">
                                ${soilAnalysis.adjustments.k !== undefined && soilAnalysis.adjustments.k !== null && soilAnalysis.adjustments.k !== 0 ? `<div><strong>K:</strong> ${soilAnalysis.adjustments.k > 0 ? '+' : ''}${soilAnalysis.adjustments.k}</div>` : ''}
                                ${soilAnalysis.adjustments.ca !== undefined && soilAnalysis.adjustments.ca !== null && soilAnalysis.adjustments.ca !== 0 ? `<div><strong>Ca:</strong> ${soilAnalysis.adjustments.ca > 0 ? '+' : ''}${soilAnalysis.adjustments.ca}</div>` : ''}
                                ${soilAnalysis.adjustments.mg !== undefined && soilAnalysis.adjustments.mg !== null && soilAnalysis.adjustments.mg !== 0 ? `<div><strong>Mg:</strong> ${soilAnalysis.adjustments.mg > 0 ? '+' : ''}${soilAnalysis.adjustments.mg}</div>` : ''}
                                ${soilAnalysis.adjustments.h !== undefined && soilAnalysis.adjustments.h !== null && soilAnalysis.adjustments.h !== 0 ? `<div><strong>H:</strong> ${soilAnalysis.adjustments.h > 0 ? '+' : ''}${soilAnalysis.adjustments.h}</div>` : ''}
                                ${soilAnalysis.adjustments.na !== undefined && soilAnalysis.adjustments.na !== null && soilAnalysis.adjustments.na !== 0 ? `<div><strong>Na:</strong> ${soilAnalysis.adjustments.na > 0 ? '+' : ''}${soilAnalysis.adjustments.na}</div>` : ''}
                                ${soilAnalysis.adjustments.al !== undefined && soilAnalysis.adjustments.al !== null && soilAnalysis.adjustments.al !== 0 ? `<div><strong>Al:</strong> ${soilAnalysis.adjustments.al > 0 ? '+' : ''}${soilAnalysis.adjustments.al}</div>` : ''}
                            </div>
                    </div>
                `;
            }
            
                html += `</div>`;
            }
            
            // Mostrar resultados del c√°lculo de enmiendas
                html += `
                    ${hasEnmiendasData 
                        ? (detailedHTML && detailedHTML.trim() 
                            ? `<div style="background: white; padding: 16px; border-radius: 6px; max-height: 500px; overflow-y: auto; font-size: 14px;">${detailedHTML}</div>`
                            : `<pre style="background: white; padding: 12px; border-radius: 6px; overflow-x: auto; font-size: 12px; max-height: 300px; overflow-y: auto;">${JSON.stringify(enmiendas, null, 2)}</pre>`)
                        : (!hasSoilData 
                            ? '<p style="color: #94a3b8; font-style: italic; margin: 0;">Esta secci√≥n a√∫n no ha sido configurada en el proyecto.</p>' 
                            : '<p style="color: #64748b; font-style: italic; margin: 0; padding: 12px; background: #f8fafc; border-radius: 6px;">No se ha generado ninguna enmienda en este proyecto. Los datos de an√°lisis de suelo est√°n guardados; el usuario puede generar la enmienda desde la calculadora en la plataforma.</p>')
                    }
                    </div>
                `;
            
            // Secci√≥n: NUTRICI√ìN GRANULAR (SIEMPRE mostrar)
            const granular = project.sections?.programa_granular || project.granular || project.granularRequirements || null;
            const granularRequirements = granular?.requirements || null;
            const granularProgram = granular?.program || null;
            const hasRequirements = granularRequirements && typeof granularRequirements === 'object' && (
                granularRequirements.cropType || 
                (granularRequirements.targetYield && granularRequirements.targetYield > 0) ||
                (granularRequirements.adjustment && Object.keys(granularRequirements.adjustment).length > 0) ||
                (granularRequirements.efficiency && Object.keys(granularRequirements.efficiency).length > 0)
            );
            const hasProgram = granularProgram && typeof granularProgram === 'object' && Object.keys(granularProgram).length > 0;
            const hasGranularData = hasRequirements || hasProgram;
            
                html += `
                    <div style="background: #eff6ff; padding: 20px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                    <h3 style="margin: 0 0 16px 0; color: #1e293b; font-size: 18px;">
                        üìä Nutrici√≥n Granular
                        ${!hasGranularData ? '<span style="color: #64748b; font-size: 14px; font-weight: normal; margin-left: 8px;">(Sin datos)</span>' : ''}
                    </h3>
            `;
            
            // PRIMERO: Mostrar Requerimientos
            if (hasRequirements) {
                // üöÄ CR√çTICO: Leer el modo guardado (√ìxido/Elemental)
                const isElementalMode = granularRequirements.isElementalMode === true;
                
                // Calcular valores para mostrar
                const nutrients = ['N','P2O5','K2O','CaO','MgO','S','SO4','Fe','Mn','B','Zn','Cu','Mo','SiO2'];
                const cropType = granularRequirements.cropType || '';
                const targetYield = granularRequirements.targetYield || 0;
                
                // Extracci√≥n por tonelada (de extractionOverrides o defaults)
                const extractionPerTon = {};
                const extractionOverrides = granularRequirements.extractionOverrides || {};
                const defaultExtraction = {
                    'maiz': { N: 18, P2O5: 4, K2O: 16, CaO: 2, MgO: 1, S: 0, SO4: 6, Fe: 0.08, Mn: 0.07, B: 0.05, Zn: 0.175, Cu: 0.01, Mo: 0.05, SiO2: 0 },
                    'aguacate': { N: 9, P2O5: 4, K2O: 16, CaO: 8, MgO: 4, S: 0, SO4: 10, Fe: 0.08, Mn: 0.07, B: 0.05, Zn: 0.175, Cu: 0.01, Mo: 0.05, SiO2: 0 },
                    'cana': { N: 1.81, P2O5: 0.36, K2O: 2.11, CaO: 0.91, MgO: 0.42, S: 0, SO4: 1.50, Fe: 0.0375, Mn: 0.0155, B: 0.00074, Zn: 0.0062, Cu: 0.0022, Mo: 0.0, SiO2: 0 },
                    'limon': { N: 10, P2O5: 3.5, K2O: 18, CaO: 12, MgO: 3, S: 0, SO4: 7.5, Fe: 0.08, Mn: 0.07, B: 0.05, Zn: 0.15, Cu: 0.015, Mo: 0.03, SiO2: 0 },
                    'banano': { N: 4, P2O5: 1.2, K2O: 12, CaO: 0.8, MgO: 0.5, S: 0, SO4: 0.9, Fe: 0.015, Mn: 0.012, B: 0.008, Zn: 0.03, Cu: 0.002, Mo: 0.005, SiO2: 0 },
                    'trigo': { N: 25, P2O5: 10, K2O: 18, CaO: 3, MgO: 2, S: 0, SO4: 12, Fe: 0.15, Mn: 0.12, B: 0.08, Zn: 0.25, Cu: 0.02, Mo: 0.06, SiO2: 0 },
                    'sorgo': { N: 35, P2O5: 12, K2O: 25, CaO: 4, MgO: 3, S: 0, SO4: 15, Fe: 0.2, Mn: 0.15, B: 0.1, Zn: 0.35, Cu: 0.025, Mo: 0.08, SiO2: 0 },
                    'arroz': { N: 15, P2O5: 6, K2O: 12, CaO: 1.5, MgO: 1, S: 0, SO4: 6, Fe: 0.1, Mn: 0.08, B: 0.06, Zn: 0.2, Cu: 0.015, Mo: 0.04, SiO2: 0 },
                    'cebada': { N: 20, P2O5: 8, K2O: 15, CaO: 2.5, MgO: 1.5, S: 0, SO4: 10.5, Fe: 0.12, Mn: 0.1, B: 0.07, Zn: 0.22, Cu: 0.018, Mo: 0.05, SiO2: 0 }
                };
                // Usar extractionOverrides si existen, sino usar defaults
                const baseExtraction = extractionOverrides[cropType] || defaultExtraction[cropType] || {};
                nutrients.forEach(n => {
                    extractionPerTon[n] = baseExtraction[n] !== undefined ? baseExtraction[n] : 0;
                });
                
                // üöÄ CR√çTICO: Convertir valores a Elemental si es necesario
                if (isElementalMode) {
                    nutrients.forEach(n => {
                        extractionPerTon[n] = convertAdminOxideToElemental(n, extractionPerTon[n]);
                    });
                }
                
                // Extracci√≥n total (extracci√≥n por tonelada * rendimiento objetivo)
                const totalExtraction = {};
                nutrients.forEach(n => {
                    const value = extractionPerTon[n] * targetYield;
                    totalExtraction[n] = typeof value === 'number' ? value.toFixed(2) : value;
                });
                
                // Requerimiento real (ajuste / (eficiencia/100))
                const realRequirement = {};
                const realRequirementOxide = {};
                const adjustment = granularRequirements.adjustment || {};
                const efficiency = granularRequirements.efficiency || {};
                nutrients.forEach(n => {
                    let adjOxide = adjustment[n] || 0;
                    // Si los ajustes se guardaron en Elemental, convertir a √ìxido para base
                    if (isElementalMode) {
                        adjOxide = convertAdminElementalToOxide(n, adjOxide);
                    }
                    const eff = efficiency[n] || 85;
                    const divisor = eff > 0 ? eff / 100 : 1;
                    const rrOx = (adjOxide / divisor);
                    realRequirementOxide[n] = rrOx;
                    realRequirement[n] = rrOx.toFixed(2);
                });
                
                // üöÄ CR√çTICO: Convertir totalExtraction y realRequirement a Elemental si es necesario
                if (isElementalMode) {
                    nutrients.forEach(n => {
                        if (totalExtraction[n]) {
                            totalExtraction[n] = convertAdminOxideToElemental(n, parseFloat(totalExtraction[n])).toFixed(2);
                        }
                        if (realRequirement[n]) {
                            realRequirement[n] = convertAdminOxideToElemental(n, parseFloat(realRequirement[n])).toFixed(2);
                        }
                    });
                }
                
                html += `
                    <div style="background: white; padding: 16px; border-radius: 6px; margin-bottom: 16px; border: 1px solid #bfdbfe;">
                        <h4 style="margin: 0 0 12px 0; color: #1e293b; font-size: 16px; font-weight: 600;">üìã Requerimiento Nutricional ${isElementalMode ? '<span style="color: #10b981; font-size: 14px; font-weight: normal;">(Modo Elemental)</span>' : '<span style="color: #64748b; font-size: 14px; font-weight: normal;">(Modo √ìxido)</span>'}</h4>
                        <div style="display: grid; gap: 12px;">
                            ${granularRequirements.cropType ? `<div><strong>Cultivo:</strong> ${escapeHtml(granularRequirements.cropType)}</div>` : ''}
                            ${granularRequirements.targetYield ? `<div><strong>Rendimiento Objetivo:</strong> ${granularRequirements.targetYield} ton/ha</div>` : ''}
                `;
                
                // Mostrar Extracci√≥n por tonelada
                html += `
                    <div style="margin-top: 8px;">
                        <strong style="color: #1e293b; font-size: 14px;">Extracci√≥n por Tonelada (kg/ton):</strong>
                        <div style="background: #f8fafc; padding: 10px; border-radius: 4px; margin-top: 6px; font-size: 13px; display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px;">
                            ${nutrients.filter(n => extractionPerTon[n] !== undefined && extractionPerTon[n] !== null).map(n => {
                                const label = getAdminNutrientLabel(n, isElementalMode);
                                const value = typeof extractionPerTon[n] === 'number' ? extractionPerTon[n].toFixed(2) : extractionPerTon[n];
                                return `<div><strong>${label}:</strong> ${value}</div>`;
                            }).join('')}
                        </div>
                    </div>
                `;
                
                // Mostrar Extracci√≥n total
                html += `
                    <div style="margin-top: 8px;">
                        <strong style="color: #1e293b; font-size: 14px;">Extracci√≥n Total (kg/ha):</strong>
                        <div style="background: #f8fafc; padding: 10px; border-radius: 4px; margin-top: 6px; font-size: 13px; display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px;">
                            ${nutrients.filter(n => totalExtraction[n] && parseFloat(totalExtraction[n]) !== 0).map(n => {
                                const label = getAdminNutrientLabel(n, isElementalMode);
                                return `<div><strong>${label}:</strong> ${totalExtraction[n]}</div>`;
                            }).join('')}
                        </div>
                    </div>
                `;
                
                // Mostrar Ajustes si existen
                if (granularRequirements.adjustment && Object.keys(granularRequirements.adjustment).length > 0) {
                    html += `
                        <div style="margin-top: 8px;">
                            <strong style="color: #1e293b; font-size: 14px;">Ajuste por Niveles en Suelo (kg/ha):</strong>
                            <div style="background: #f8fafc; padding: 10px; border-radius: 4px; margin-top: 6px; font-size: 13px; display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px;">
                                ${Object.entries(granularRequirements.adjustment).filter(([k, v]) => v !== 0 && v !== null && v !== undefined).map(([key, value]) => {
                                    let adjValue = typeof value === 'number' ? value : parseFloat(value) || 0;
                                    // üöÄ CR√çTICO: Convertir ajuste a Elemental si es necesario
                                    if (isElementalMode) {
                                        adjValue = convertAdminOxideToElemental(key, adjValue);
                                    }
                                    const label = getAdminNutrientLabel(key, isElementalMode);
                                    return `<div><strong>${label}:</strong> ${adjValue.toFixed(2)}</div>`;
                                }).join('')}
                            </div>
                    </div>
                `;
            }
            
                // Mostrar Eficiencias si existen
                if (granularRequirements.efficiency && Object.keys(granularRequirements.efficiency).length > 0) {
                html += `
                        <div style="margin-top: 8px;">
                            <strong style="color: #1e293b; font-size: 14px;">Eficiencia (%):</strong>
                            <div style="background: #f8fafc; padding: 10px; border-radius: 4px; margin-top: 6px; font-size: 13px; display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px;">
                                ${Object.entries(granularRequirements.efficiency).filter(([k, v]) => v !== 0 && v !== null && v !== undefined).map(([key, value]) => `<div><strong>${key}:</strong> ${typeof value === 'number' ? value.toFixed(1) : value}%</div>`).join('')}
                            </div>
                    </div>
                `;
            }
            
                // Mostrar Requerimiento Real
                html += `
                    <div style="margin-top: 8px;">
                        <strong style="color: #1e293b; font-size: 14px;">Requerimiento Real (kg/ha):</strong>
                        <div style="background: #f8fafc; padding: 10px; border-radius: 4px; margin-top: 6px; font-size: 13px; display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px;">
                            ${nutrients.filter(n => realRequirement[n] && parseFloat(realRequirement[n]) !== 0).map(n => {
                                const label = getAdminNutrientLabel(n, isElementalMode);
                                return `<div><strong>${label}:</strong> ${realRequirement[n]}</div>`;
                            }).join('')}
                        </div>
                    </div>
                `;
                
                html += `</div></div>`;
            }
            
            // SEGUNDO: Mostrar Programa
            if (hasProgram) {
                const programIsElemental = granularProgram.mode === true;
                const nutrients = ['N','P2O5','K2O','CaO','MgO','S','SO4','Fe','Mn','B','Zn','Cu','Mo','SiO2'];
                const programTotalsOxide = { N: 0, P2O5: 0, K2O: 0, CaO: 0, MgO: 0, S: 0, SO4: 0, Fe: 0, Mn: 0, B: 0, Zn: 0, Cu: 0, Mo: 0, SiO2: 0 };
                if (granularProgram.applications && Array.isArray(granularProgram.applications)) {
                    granularProgram.applications.forEach(app => {
                        if (app && app.results && typeof app.results === 'object') {
                            nutrients.forEach(n => {
                                programTotalsOxide[n] += parseFloat(app.results[n]) || 0;
                            });
                        } else if (app && app.materials && Array.isArray(app.materials)) {
                            const comp = { N: 0, P2O5: 0, K2O: 0, CaO: 0, MgO: 0, S: 0, SO4: 0, Fe: 0, Mn: 0, B: 0, Zn: 0, Cu: 0, Mo: 0, SiO2: 0 };
                            app.materials.forEach(mat => {
                                nutrients.forEach(n => {
                                    comp[n] += parseFloat(mat[n]) || 0;
                                });
                            });
                            const dose = parseFloat(app.doseKgHa) || 0;
                            nutrients.forEach(n => {
                                programTotalsOxide[n] += (comp[n] * dose) / 100;
                            });
                        }
                    });
                }
                const programReqOxide = buildRealRequirementOxide(granularRequirements);
                const programSummary = { aportado: {}, requerido: {}, diferencia: {} };
                nutrients.forEach(n => {
                    const aport = programTotalsOxide[n] || 0;
                    const req = programReqOxide[n] || 0;
                    const diff = aport - req;
                    const display = (val) => {
                        let v = val;
                        if (programIsElemental) {
                            v = convertAdminOxideToElemental(n, v);
                        }
                        return v;
                    };
                    programSummary.aportado[n] = display(aport);
                    programSummary.requerido[n] = display(req);
                    programSummary.diferencia[n] = display(diff);
                });
                html += `
                    <div style="background: white; padding: 16px; border-radius: 6px; border: 1px solid #bfdbfe;">
                        <h4 style="margin: 0 0 12px 0; color: #1e293b; font-size: 16px; font-weight: 600;">üå± Programa Granular ${programIsElemental ? '<span style="color: #10b981; font-size: 14px; font-weight: normal;">(Modo Elemental)</span>' : '<span style="color: #64748b; font-size: 14px; font-weight: normal;">(Modo √ìxido)</span>'}</h4>
                `;
                
                html += `
                    <div style="margin-bottom: 14px;">
                        <strong style="color: #1e293b; font-size: 14px;">Aporte Total (kg/ha):</strong>
                        <div style="background: #f8fafc; padding: 10px; border-radius: 4px; margin-top: 6px; font-size: 13px; display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px;">
                            ${nutrients.map(n => {
                                const label = getAdminNutrientLabel(n, programIsElemental);
                                return `<div><strong>${label}:</strong> ${formatAdminValue(n, programSummary.aportado[n])}</div>`;
                            }).join('')}
                        </div>
                    </div>
                    <div style="margin-bottom: 14px;">
                        <strong style="color: #1e293b; font-size: 14px;">Requerimiento Real (kg/ha):</strong>
                        <div style="background: #f8fafc; padding: 10px; border-radius: 4px; margin-top: 6px; font-size: 13px; display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px;">
                            ${nutrients.map(n => {
                                const label = getAdminNutrientLabel(n, programIsElemental);
                                return `<div><strong>${label}:</strong> ${formatAdminValue(n, programSummary.requerido[n])}</div>`;
                            }).join('')}
                        </div>
                    </div>
                    <div style="margin-bottom: 8px;">
                        <strong style="color: #1e293b; font-size: 14px;">Diferencia (Aporte - Requerimiento) (kg/ha):</strong>
                        <div style="background: #f8fafc; padding: 10px; border-radius: 4px; margin-top: 6px; font-size: 13px; display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px;">
                            ${nutrients.map(n => {
                                const label = getAdminNutrientLabel(n, programIsElemental);
                                return `<div><strong>${label}:</strong> ${formatAdminValue(n, programSummary.diferencia[n])}</div>`;
                            }).join('')}
                        </div>
                    </div>
                `;
                
                // Formatear aplicaciones en tablas
                if (granularProgram.applications && Array.isArray(granularProgram.applications) && granularProgram.applications.length > 0) {
                    granularProgram.applications.forEach((app, idx) => {
                        html += `
                            <div style="margin-bottom: ${idx < granularProgram.applications.length - 1 ? '20px' : '0'}; border: 1px solid #e2e8f0; border-radius: 6px; padding: 12px; background: #f8fafc;">
                                <div style="font-weight: 600; color: #1e293b; margin-bottom: 8px; font-size: 14px;">${escapeHtml(app.title || `Aplicaci√≥n ${app.number || idx + 1}`)}</div>
                                ${app.doseKgHa ? `<div style="color: #64748b; font-size: 13px; margin-bottom: 10px;"><strong>Dosis:</strong> ${parseFloat(app.doseKgHa).toFixed(2)} kg/ha</div>` : ''}
                        `;
                        
                        if (app.materials && Array.isArray(app.materials) && app.materials.length > 0) {
                            const granularCustomItems = project?.sections?.programa_granular?.customMaterials?.items || project?.granular?.customMaterials?.items || [];
                            const granularCustomById = new Map((Array.isArray(granularCustomItems) ? granularCustomItems : []).filter(m => m && (m.id || m.name)).map(m => [m.id || m.name, m]));
                            function adminGranularMatName(mat) {
                                const name = (mat.name || mat.label) ? String(mat.name || mat.label).trim() : '';
                                if (name && !name.startsWith('custom_')) return name;
                                const custom = granularCustomById.get(mat.id || mat.materialId || mat.name);
                                if (custom && (custom.name || custom.label)) return String(custom.name || custom.label).trim();
                                return 'Personalizado';
                            }
                            const programTotals = { N: 0, P2O5: 0, K2O: 0, CaO: 0, MgO: 0, S: 0, SO4: 0, Fe: 0, Mn: 0, B: 0, Zn: 0, Cu: 0, Mo: 0, SiO2: 0 };
                            let totalPercent = 0;
                            app.materials.forEach(mat => {
                                totalPercent += parseFloat(mat.percentage) || 0;
                                programTotals.N += parseFloat(mat.N) || 0;
                                programTotals.P2O5 += parseFloat(mat.P2O5) || 0;
                                programTotals.K2O += parseFloat(mat.K2O) || 0;
                                programTotals.CaO += parseFloat(mat.CaO) || 0;
                                programTotals.MgO += parseFloat(mat.MgO) || 0;
                                programTotals.S += parseFloat(mat.S) || 0;
                                programTotals.SO4 += parseFloat(mat.SO4) || 0;
                                programTotals.Fe += parseFloat(mat.Fe) || 0;
                                programTotals.Mn += parseFloat(mat.Mn) || 0;
                                programTotals.B += parseFloat(mat.B) || 0;
                                programTotals.Zn += parseFloat(mat.Zn) || 0;
                                programTotals.Cu += parseFloat(mat.Cu) || 0;
                                programTotals.Mo += parseFloat(mat.Mo) || 0;
                                programTotals.SiO2 += parseFloat(mat.SiO2) || 0;
                            });
                            html += `
                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                                        <thead>
                                            <tr style="background: #e2e8f0;">
                                                <th style="padding: 8px; text-align: left; border: 1px solid #cbd5e1;">Material</th>
                                                <th style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">%</th>
                                                <th style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">N</th>
                                                <th style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">${getAdminNutrientLabel('P2O5', programIsElemental)}</th>
                                                <th style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">${getAdminNutrientLabel('K2O', programIsElemental)}</th>
                                                <th style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">${getAdminNutrientLabel('CaO', programIsElemental)}</th>
                                                <th style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">${getAdminNutrientLabel('MgO', programIsElemental)}</th>
                                                <th style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">S</th>
                                                <th style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">${getAdminNutrientLabel('SO4', programIsElemental)}</th>
                                                <th style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">Fe</th>
                                                <th style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">Mn</th>
                                                <th style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">B</th>
                                                <th style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">Zn</th>
                                                <th style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">Cu</th>
                                                <th style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">Mo</th>
                                                <th style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">${getAdminNutrientLabel('SiO2', programIsElemental)}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                            `;
                            
                            app.materials.forEach((mat, matIdx) => {
                                const n = parseFloat(mat.N) || 0;
                                const p2o5 = parseFloat(mat.P2O5) || 0;
                                const k2o = parseFloat(mat.K2O) || 0;
                                const cao = parseFloat(mat.CaO) || 0;
                                const mgo = parseFloat(mat.MgO) || 0;
                                const s = parseFloat(mat.S) || 0;
                                const so4 = parseFloat(mat.SO4) || 0;
                                const fe = parseFloat(mat.Fe) || 0;
                                const mn = parseFloat(mat.Mn) || 0;
                                const b = parseFloat(mat.B) || 0;
                                const zn = parseFloat(mat.Zn) || 0;
                                const cu = parseFloat(mat.Cu) || 0;
                                const mo = parseFloat(mat.Mo) || 0;
                                const siO2 = parseFloat(mat.SiO2) || 0;
                                html += `
                                    <tr style="${matIdx % 2 === 0 ? 'background: white;' : 'background: #f8fafc;'}">
                                        <td style="padding: 8px; border: 1px solid #cbd5e1;">${escapeHtml(adminGranularMatName(mat))}</td>
                                        <td style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">${mat.percentage || 0}%</td>
                                        <td style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">${n.toFixed(2)}</td>
                                        <td style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">${(programIsElemental ? convertAdminOxideToElemental('P2O5', p2o5) : p2o5).toFixed(2)}</td>
                                        <td style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">${(programIsElemental ? convertAdminOxideToElemental('K2O', k2o) : k2o).toFixed(2)}</td>
                                        <td style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">${(programIsElemental ? convertAdminOxideToElemental('CaO', cao) : cao).toFixed(2)}</td>
                                        <td style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">${(programIsElemental ? convertAdminOxideToElemental('MgO', mgo) : mgo).toFixed(2)}</td>
                                        <td style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">${s.toFixed(2)}</td>
                                        <td style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">${so4.toFixed(2)}</td>
                                        <td style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">${fe.toFixed(3)}</td>
                                        <td style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">${mn.toFixed(3)}</td>
                                        <td style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">${b.toFixed(3)}</td>
                                        <td style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">${zn.toFixed(3)}</td>
                                        <td style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">${cu.toFixed(3)}</td>
                                        <td style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">${mo.toFixed(3)}</td>
                                        <td style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">${(programIsElemental ? convertAdminOxideToElemental('SiO2', siO2) : siO2).toFixed(2)}</td>
                                    </tr>
                                `;
                            });
                            
                            html += `
                                        <tr style="background: #f1f5f9; font-weight: 600;">
                                            <td style="padding: 8px; border: 1px solid #cbd5e1;">TOTAL</td>
                                            <td style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">${totalPercent.toFixed(2)}%</td>
                                            <td style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">${programTotals.N.toFixed(2)}</td>
                                            <td style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">${(programIsElemental ? convertAdminOxideToElemental('P2O5', programTotals.P2O5) : programTotals.P2O5).toFixed(2)}</td>
                                            <td style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">${(programIsElemental ? convertAdminOxideToElemental('K2O', programTotals.K2O) : programTotals.K2O).toFixed(2)}</td>
                                            <td style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">${(programIsElemental ? convertAdminOxideToElemental('CaO', programTotals.CaO) : programTotals.CaO).toFixed(2)}</td>
                                            <td style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">${(programIsElemental ? convertAdminOxideToElemental('MgO', programTotals.MgO) : programTotals.MgO).toFixed(2)}</td>
                                            <td style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">${programTotals.S.toFixed(2)}</td>
                                            <td style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">${programTotals.SO4.toFixed(2)}</td>
                                            <td style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">${programTotals.Fe.toFixed(3)}</td>
                                            <td style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">${programTotals.Mn.toFixed(3)}</td>
                                            <td style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">${programTotals.B.toFixed(3)}</td>
                                            <td style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">${programTotals.Zn.toFixed(3)}</td>
                                            <td style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">${programTotals.Cu.toFixed(3)}</td>
                                            <td style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">${programTotals.Mo.toFixed(3)}</td>
                                            <td style="padding: 8px; text-align: center; border: 1px solid #cbd5e1;">${(programIsElemental ? convertAdminOxideToElemental('SiO2', programTotals.SiO2) : programTotals.SiO2).toFixed(2)}</td>
                                        </tr>
                                        </tbody>
                                    </table>
                    </div>
                `;
                        } else {
                            html += `<div style="color: #94a3b8; font-style: italic; padding: 8px;">Sin materiales</div>`;
                        }
                        
                        html += `</div>`;
                    });
                } else {
                    html += `<div style="color: #94a3b8; font-style: italic; padding: 8px;">Sin aplicaciones guardadas en el programa.</div>`;
                }
                
                html += `</div>`;
            }
            
            if (!hasGranularData) {
                html += '<p style="color: #94a3b8; font-style: italic; margin: 0;">Esta secci√≥n a√∫n no ha sido configurada en el proyecto.</p>';
            }
            
            html += `</div>`;
            
            // Secci√≥n: FERTIRRIEGO (SIEMPRE mostrar)
            const fertirriegoRoot = project.sections?.fertirriego || project.fertirriego || null;
            const fertirriegoRequirements = (
                fertirriegoRoot?.requirements ||
                project.fertirriegoRequirements ||
                (project.fertirriego && project.fertirriego.cropType ? project.fertirriego : null)
            );
            const fertirriegoProgram = (
                fertirriegoRoot?.program ||
                project.fertirriegoProgram ||
                (project.fertirriego && Array.isArray(project.fertirriego.weeks) ? project.fertirriego : null)
            );
            const hasFertirriegoRequirements = fertirriegoRequirements && typeof fertirriegoRequirements === 'object' && (
                fertirriegoRequirements.cropType || 
                (fertirriegoRequirements.targetYield && fertirriegoRequirements.targetYield > 0) ||
                (fertirriegoRequirements.adjustment && Object.keys(fertirriegoRequirements.adjustment).length > 0) ||
                (fertirriegoRequirements.efficiency && Object.keys(fertirriegoRequirements.efficiency).length > 0)
            );
            const hasFertirriegoProgram = fertirriegoProgram && typeof fertirriegoProgram === 'object' && Object.keys(fertirriegoProgram).length > 0;
            const hasFertirriegoData = hasFertirriegoRequirements || hasFertirriegoProgram;
            
                html += `
                <div style="background: #ecfdf5; padding: 20px; border-radius: 8px; border-left: 4px solid #10b981;">
                    <h3 style="margin: 0 0 16px 0; color: #1e293b; font-size: 18px;">
                        üíß Fertirriego
                        ${!hasFertirriegoData ? '<span style="color: #64748b; font-size: 14px; font-weight: normal; margin-left: 8px;">(Sin datos)</span>' : ''}
                    </h3>
            `;
            
            // PRIMERO: Mostrar Requerimientos
            if (hasFertirriegoRequirements) {
                // üöÄ CR√çTICO: Leer el modo guardado (√ìxido/Elemental)
                const isElementalMode = fertirriegoRequirements.isElementalMode === true;
                
                // Calcular valores para mostrar
                const nutrients = ['N','P2O5','K2O','CaO','MgO','S','SO4','Fe','Mn','B','Zn','Cu','Mo','SiO2'];
                const cropType = fertirriegoRequirements.cropType || '';
                const targetYield = fertirriegoRequirements.targetYield || 0;
                
                // Extracci√≥n por tonelada (de extractionOverrides o defaults)
                const extractionPerTon = {};
                const extractionOverrides = fertirriegoRequirements.extractionOverrides || {};
                const defaultExtraction = {
                    'aguacate': { N: 9, P2O5: 4, K2O: 16, CaO: 8, MgO: 4, S: 0, SO4: 10, Fe: 0.08, Mn: 0.07, B: 0.05, Zn: 0.175, Cu: 0.01, Mo: 0.05, SiO2: 0 },
                    'fresa': { N: 6, P2O5: 2, K2O: 10, CaO: 3, MgO: 2, S: 0, SO4: 6, Fe: 0.05, Mn: 0.04, B: 0.03, Zn: 0.08, Cu: 0.006, Mo: 0.02, SiO2: 0 },
                    'frambuesa': { N: 7, P2O5: 2.5, K2O: 11, CaO: 4, MgO: 2.5, S: 0, SO4: 7.5, Fe: 0.06, Mn: 0.05, B: 0.035, Zn: 0.1, Cu: 0.007, Mo: 0.025, SiO2: 0 },
                    'tomate': { N: 5, P2O5: 2, K2O: 8, CaO: 4, MgO: 2, S: 0, SO4: 4.5, Fe: 0.06, Mn: 0.05, B: 0.03, Zn: 0.12, Cu: 0.006, Mo: 0.02, SiO2: 0 },
                    'chile': { N: 6.5, P2O5: 2.5, K2O: 9, CaO: 4.5, MgO: 2.2, S: 0, SO4: 6, Fe: 0.065, Mn: 0.055, B: 0.035, Zn: 0.14, Cu: 0.007, Mo: 0.03, SiO2: 0 },
                    'sandia': { N: 3.5, P2O5: 1.5, K2O: 5, CaO: 2, MgO: 1, S: 0, SO4: 3, Fe: 0.04, Mn: 0.03, B: 0.02, Zn: 0.08, Cu: 0.005, Mo: 0.015, SiO2: 0 },
                    'melon': { N: 4, P2O5: 1.8, K2O: 6, CaO: 2.5, MgO: 1.2, S: 0, SO4: 3.6, Fe: 0.045, Mn: 0.035, B: 0.025, Zn: 0.1, Cu: 0.006, Mo: 0.02, SiO2: 0 },
                    'banano': { N: 4, P2O5: 1.2, K2O: 12, CaO: 0.8, MgO: 0.5, S: 0, SO4: 0.9, Fe: 0.015, Mn: 0.012, B: 0.008, Zn: 0.03, Cu: 0.002, Mo: 0.005, SiO2: 0 },
                    'papaya': { N: 4.5, P2O5: 1.5, K2O: 7, CaO: 3, MgO: 1.5, S: 0, SO4: 4.5, Fe: 0.05, Mn: 0.04, B: 0.03, Zn: 0.1, Cu: 0.006, Mo: 0.02, SiO2: 0 },
                    'pepino': { N: 4, P2O5: 1.5, K2O: 6, CaO: 3, MgO: 1.5, S: 0, SO4: 3, Fe: 0.05, Mn: 0.04, B: 0.025, Zn: 0.1, Cu: 0.005, Mo: 0.02, SiO2: 0 },
                    'lechuga': { N: 3, P2O5: 1, K2O: 4, CaO: 2, MgO: 1, S: 0, SO4: 2.4, Fe: 0.04, Mn: 0.03, B: 0.02, Zn: 0.08, Cu: 0.005, Mo: 0.015, SiO2: 0 },
                    'cebolla': { N: 2.5, P2O5: 1, K2O: 3.5, CaO: 1.5, MgO: 0.8, S: 0, SO4: 4.5, Fe: 0.04, Mn: 0.03, B: 0.02, Zn: 0.08, Cu: 0.005, Mo: 0.015, SiO2: 0 },
                    'maiz': { N: 18, P2O5: 4, K2O: 16, CaO: 2, MgO: 1, S: 0, SO4: 6, Fe: 0.08, Mn: 0.07, B: 0.05, Zn: 0.175, Cu: 0.01, Mo: 0.05, SiO2: 0 },
                    'cana': { N: 1.81, P2O5: 0.36, K2O: 2.11, CaO: 0.91, MgO: 0.42, S: 0, SO4: 1.50, Fe: 0.0375, Mn: 0.0155, B: 0.00074, Zn: 0.0062, Cu: 0.0022, Mo: 0.0, SiO2: 0 },
                    'arandano': { N: 8, P2O5: 3, K2O: 12, CaO: 4, MgO: 2.5, S: 0, SO4: 6, Fe: 0.07, Mn: 0.06, B: 0.04, Zn: 0.12, Cu: 0.008, Mo: 0.025, SiO2: 0 },
                    'limon': { N: 10, P2O5: 3.5, K2O: 18, CaO: 12, MgO: 3, S: 0, SO4: 7.5, Fe: 0.08, Mn: 0.07, B: 0.05, Zn: 0.15, Cu: 0.015, Mo: 0.03, SiO2: 0 },
                    'pimiento': { N: 5.5, P2O5: 2.2, K2O: 8.5, CaO: 4.5, MgO: 2, S: 0, SO4: 6, Fe: 0.065, Mn: 0.055, B: 0.035, Zn: 0.13, Cu: 0.007, Mo: 0.025, SiO2: 0 }
                };
                // Usar extractionOverrides si existen, sino usar defaults
                const baseExtraction = extractionOverrides[cropType] || defaultExtraction[cropType] || {};
                nutrients.forEach(n => {
                    extractionPerTon[n] = baseExtraction[n] !== undefined ? baseExtraction[n] : 0;
                });
                
                // üöÄ CR√çTICO: Convertir valores a Elemental si es necesario
                if (isElementalMode) {
                    nutrients.forEach(n => {
                        extractionPerTon[n] = convertAdminOxideToElemental(n, extractionPerTon[n]);
                    });
                }
                
                // Extracci√≥n total (extracci√≥n por tonelada * rendimiento objetivo)
                const totalExtraction = {};
                nutrients.forEach(n => {
                    const value = extractionPerTon[n] * targetYield;
                    totalExtraction[n] = typeof value === 'number' ? value.toFixed(2) : value;
                });
                
                // Requerimiento real (ajuste / (eficiencia/100))
                const realRequirement = {};
                const adjustment = fertirriegoRequirements.adjustment || {};
                const efficiency = fertirriegoRequirements.efficiency || {};
                nutrients.forEach(n => {
                    let adj = adjustment[n] || 0;
                    // üöÄ CR√çTICO: Convertir ajuste a Elemental si es necesario
                    if (isElementalMode) {
                        adj = convertAdminOxideToElemental(n, adj);
                    }
                    const eff = efficiency[n] || 85;
                    const divisor = eff > 0 ? eff / 100 : 1;
                    realRequirement[n] = (adj / divisor).toFixed(2);
                });
                
                // üöÄ CR√çTICO: Convertir totalExtraction y realRequirement a Elemental si es necesario
                if (isElementalMode) {
                    nutrients.forEach(n => {
                        if (totalExtraction[n]) {
                            totalExtraction[n] = convertAdminOxideToElemental(n, parseFloat(totalExtraction[n])).toFixed(2);
                        }
                        if (realRequirement[n]) {
                            realRequirement[n] = convertAdminOxideToElemental(n, parseFloat(realRequirement[n])).toFixed(2);
                        }
                    });
                }
                
                html += `
                    <div style="background: white; padding: 16px; border-radius: 6px; margin-bottom: 16px; border: 1px solid #86efac;">
                        <h4 style="margin: 0 0 12px 0; color: #1e293b; font-size: 16px; font-weight: 600;">üìã Requerimiento Nutricional ${isElementalMode ? '<span style="color: #10b981; font-size: 14px; font-weight: normal;">(Modo Elemental)</span>' : '<span style="color: #64748b; font-size: 14px; font-weight: normal;">(Modo √ìxido)</span>'}</h4>
                        <div style="display: grid; gap: 12px;">
                            ${fertirriegoRequirements.cropType ? `<div><strong>Cultivo:</strong> ${escapeHtml(fertirriegoRequirements.cropType)}</div>` : ''}
                            ${fertirriegoRequirements.targetYield ? `<div><strong>Rendimiento Objetivo:</strong> ${fertirriegoRequirements.targetYield} ton/ha</div>` : ''}
                `;
                
                const adjustmentOxide = {};
                const adjustmentDisplay = {};
                const efficiencyDisplay = {};
                const realRequirementDisplay = {};
                const extractionPerTonDisplay = {};
                const totalExtractionDisplay = {};
                nutrients.forEach(n => {
                    const adjOx = parseFloat(adjustment[n]) || 0;
                    adjustmentOxide[n] = adjOx;
                    adjustmentDisplay[n] = isElementalMode ? convertAdminOxideToElemental(n, adjOx) : adjOx;
                    const eff = parseFloat(efficiency[n]);
                    efficiencyDisplay[n] = !isNaN(eff) ? eff : 85;
                    const divisor = efficiencyDisplay[n] > 0 ? efficiencyDisplay[n] / 100 : 1;
                    const realOx = adjOx / divisor;
                    realRequirementDisplay[n] = isElementalMode ? convertAdminOxideToElemental(n, realOx) : realOx;
                    const extOx = extractionPerTon[n] || 0;
                    extractionPerTonDisplay[n] = isElementalMode ? convertAdminOxideToElemental(n, extOx) : extOx;
                    const totalOx = extOx * targetYield;
                    totalExtractionDisplay[n] = isElementalMode ? convertAdminOxideToElemental(n, totalOx) : totalOx;
                });

                // Mostrar Extracci√≥n por tonelada
                html += `
                    <div style="margin-top: 8px;">
                        <strong style="color: #1e293b; font-size: 14px;">Extracci√≥n por Tonelada (kg/ton):</strong>
                        <div style="background: #f8fafc; padding: 10px; border-radius: 4px; margin-top: 6px; font-size: 13px; display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px;">
                            ${nutrients.map(n => {
                                const label = getAdminNutrientLabel(n, isElementalMode);
                                return `<div><strong>${label}:</strong> ${formatAdminValue(n, extractionPerTonDisplay[n])}</div>`;
                            }).join('')}
                        </div>
                    </div>
                `;

                // Mostrar Extracci√≥n total
                html += `
                    <div style="margin-top: 8px;">
                        <strong style="color: #1e293b; font-size: 14px;">Extracci√≥n Total (kg/ha):</strong>
                        <div style="background: #f8fafc; padding: 10px; border-radius: 4px; margin-top: 6px; font-size: 13px; display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px;">
                            ${nutrients.map(n => {
                                const label = getAdminNutrientLabel(n, isElementalMode);
                                return `<div><strong>${label}:</strong> ${formatAdminValue(n, totalExtractionDisplay[n])}</div>`;
                            }).join('')}
                        </div>
                    </div>
                `;

                // Mostrar Ajustes (completo)
                html += `
                    <div style="margin-top: 8px;">
                        <strong style="color: #1e293b; font-size: 14px;">Ajuste por Niveles en Suelo (kg/ha):</strong>
                        <div style="background: #f8fafc; padding: 10px; border-radius: 4px; margin-top: 6px; font-size: 13px; display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px;">
                            ${nutrients.map(n => {
                                const label = getAdminNutrientLabel(n, isElementalMode);
                                return `<div><strong>${label}:</strong> ${formatAdminValue(n, adjustmentDisplay[n])}</div>`;
                            }).join('')}
                        </div>
                    </div>
                `;

                // Mostrar Eficiencias (completo)
                html += `
                    <div style="margin-top: 8px;">
                        <strong style="color: #1e293b; font-size: 14px;">Eficiencia (%):</strong>
                        <div style="background: #f8fafc; padding: 10px; border-radius: 4px; margin-top: 6px; font-size: 13px; display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px;">
                            ${nutrients.map(n => {
                                const label = getAdminNutrientLabel(n, isElementalMode);
                                return `<div><strong>${label}:</strong> ${efficiencyDisplay[n].toFixed(1)}%</div>`;
                            }).join('')}
                        </div>
                    </div>
                `;

                // Mostrar Requerimiento Real
                html += `
                    <div style="margin-top: 8px;">
                        <strong style="color: #1e293b; font-size: 14px;">Requerimiento Real (kg/ha):</strong>
                        <div style="background: #f8fafc; padding: 10px; border-radius: 4px; margin-top: 6px; font-size: 13px; display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px;">
                            ${nutrients.map(n => {
                                const label = getAdminNutrientLabel(n, isElementalMode);
                                return `<div><strong>${label}:</strong> ${formatAdminValue(n, realRequirementDisplay[n])}</div>`;
                            }).join('')}
                        </div>
                    </div>
                `;
                
                html += `</div></div>`;
            }
            
            // SEGUNDO: Mostrar Programa
            let fertiChartIds = null;
            if (hasFertirriegoProgram) {
                const safeProjectId = adminSafeId(project.id);
                const chartMacroId = `adminFertiMacroChart_${safeProjectId}`;
                const chartMicroId = `adminFertiMicroChart_${safeProjectId}`;
                const chartMacroWrapId = `adminFertiMacroChartWrap_${safeProjectId}`;
                const chartMicroWrapId = `adminFertiMicroChartWrap_${safeProjectId}`;
                fertiChartIds = { macroId: chartMacroId, microId: chartMicroId, macroWrapId: chartMacroWrapId, microWrapId: chartMicroWrapId };
                const progColumns = Array.isArray(fertirriegoProgram.columns) ? fertirriegoProgram.columns : [];
                const weeks = Array.isArray(fertirriegoProgram.weeks) ? fertirriegoProgram.weeks : [];
                const materials = adminGetFertiMaterials(project);
                const byId = new Map(materials.map(m => [m.id, m]));
                const customItems = project?.sections?.fertirriego?.customMaterials?.items || project?.fertirriego?.customMaterials?.items || project?.fertiCustomMaterials?.items || project?.fertirriegoCustomMaterials?.items || [];
                const customById = new Map((Array.isArray(customItems) ? customItems : []).filter(m => m && m.id).map(m => [m.id, m]));
                function adminFertiColumnName(c) {
                    const explicit = (c && (c.name || c.label)) ? String(c.name || c.label).trim() : '';
                    if (explicit) return explicit;
                    const mat = byId.get(c.materialId) || customById.get(c.materialId);
                    const name = (mat && (mat.name || mat.label)) ? String(mat.name || mat.label).trim() : '';
                    if (name) return name;
                    if (c.materialId && String(c.materialId).startsWith('custom_')) return 'Personalizado';
                    return c.materialId || 'Sin material';
                }
                const columnNames = progColumns.map(c => adminFertiColumnName(c));
                const macroNutrients = ['N_NO3','N_NH4','P2O5','K2O','CaO','MgO','S','SO4'];
                const microNutrients = ['Fe','Mn','B','Zn','Cu','Mo','SiO2'];
                const hasDoseInColumn = (c) => weeks.some(w => (parseFloat(w?.kgByCol?.[c?.id]) || 0) > 0);
                const hasMacroContribution = (c) => {
                    const mat = byId.get(c.materialId) || customById.get(c.materialId) || {};
                    const hasFromCatalog = macroNutrients.some(n => (parseFloat(mat[n]) || 0) > 0);
                    if (hasFromCatalog) return true;
                    if ((c?.materialId && String(c.materialId).startsWith('custom_')) || hasDoseInColumn(c)) return true;
                    return false;
                };
                const hasMicroContribution = (c) => {
                    const mat = byId.get(c.materialId) || customById.get(c.materialId) || {};
                    const hasFromCatalog = microNutrients.some(n => (parseFloat(mat[n]) || 0) > 0);
                    if (hasFromCatalog) return true;
                    if ((c?.materialId && String(c.materialId).startsWith('custom_')) || hasDoseInColumn(c)) return true;
                    return false;
                };
                const macroProgColumns = progColumns.filter(hasMacroContribution);
                const macroColumnNames = macroProgColumns.map(c => adminFertiColumnName(c));
                const microProgColumns = progColumns.filter(hasMicroContribution);
                const microColumnNames = microProgColumns.map(c => adminFertiColumnName(c));
                const programIsElemental = fertirriegoProgram.mode === true;
                adminEnsureFertiTotals(fertirriegoProgram, project);
                const summaryNutrients = ['N','P2O5','K2O','CaO','MgO','S','SO4','Fe','Mn','B','Zn','Cu','Mo','SiO2'];
                const totalAporteOxide = { N: 0, P2O5: 0, K2O: 0, CaO: 0, MgO: 0, S: 0, SO4: 0, Fe: 0, Mn: 0, B: 0, Zn: 0, Cu: 0, Mo: 0, SiO2: 0 };
                weeks.forEach(w => {
                    totalAporteOxide.N += (parseFloat(w?.totals?.N_NO3) || 0) + (parseFloat(w?.totals?.N_NH4) || 0);
                    totalAporteOxide.P2O5 += parseFloat(w?.totals?.P2O5) || 0;
                    totalAporteOxide.K2O += parseFloat(w?.totals?.K2O) || 0;
                    totalAporteOxide.CaO += parseFloat(w?.totals?.CaO) || 0;
                    totalAporteOxide.MgO += parseFloat(w?.totals?.MgO) || 0;
                    totalAporteOxide.S += parseFloat(w?.totals?.S) || 0;
                    totalAporteOxide.SO4 += parseFloat(w?.totals?.SO4) || 0;
                    totalAporteOxide.Fe += parseFloat(w?.totals?.Fe) || 0;
                    totalAporteOxide.Mn += parseFloat(w?.totals?.Mn) || 0;
                    totalAporteOxide.B += parseFloat(w?.totals?.B) || 0;
                    totalAporteOxide.Zn += parseFloat(w?.totals?.Zn) || 0;
                    totalAporteOxide.Cu += parseFloat(w?.totals?.Cu) || 0;
                    totalAporteOxide.Mo += parseFloat(w?.totals?.Mo) || 0;
                    totalAporteOxide.SiO2 += parseFloat(w?.totals?.SiO2) || 0;
                });
                const reqOxide = {};
                const fertiReq = fertirriegoRequirements || {};
                const fertiReqIsElemental = fertiReq.isElementalMode === true;
                const adj = fertiReq.adjustment || {};
                const eff = fertiReq.efficiency || {};
                summaryNutrients.forEach(n => {
                    let adjVal = parseFloat(adj[n]) || 0;
                    if (fertiReqIsElemental) {
                        adjVal = convertAdminElementalToOxide(n, adjVal);
                    }
                    const effVal = parseFloat(eff[n]);
                    const effPct = !isNaN(effVal) ? effVal : 85;
                    const divisor = effPct > 0 ? effPct / 100 : 1;
                    reqOxide[n] = adjVal / divisor;
                });
                const waterOx = fertirriegoProgram.waterContribution || {};
                const summary = { aportado: {}, requerido: {}, aportadoAgua: {}, totalWithWater: {}, diferencia: {} };
                const display = (n, val) => {
                    if (!programIsElemental) return val;
                    return convertAdminOxideToElemental(n, val);
                };
                summaryNutrients.forEach(n => {
                    const aportOx = totalAporteOxide[n] || 0;
                    const reqOx = reqOxide[n] || 0;
                    const waterVal = parseFloat(waterOx[n]) || 0;
                    const totalOx = aportOx + waterVal;
                    const diffOx = totalOx - reqOx;
                    summary.aportado[n] = display(n, aportOx);
                    summary.requerido[n] = display(n, reqOx);
                    summary.aportadoAgua[n] = display(n, waterVal);
                    summary.totalWithWater[n] = display(n, totalOx);
                    summary.diferencia[n] = display(n, diffOx);
                });
                const totalDose = weeks.reduce((acc, w) => {
                    if (w && w.kgByCol) {
                        Object.values(w.kgByCol).forEach(v => { acc += parseFloat(v || 0); });
                    }
                    return acc;
                }, 0);
                const macroFertColTotals = macroProgColumns.map(c => weeks.reduce((acc, w) => acc + (parseFloat(w?.kgByCol?.[c.id]) || 0), 0));
                const microFertColTotals = microProgColumns.map(c => weeks.reduce((acc, w) => acc + (parseFloat(w?.kgByCol?.[c.id]) || 0), 0));
                const macroCols = ['N_NO3','N_NH4','P2O5','K2O','CaO','MgO','S','SO4'];
                const microCols = ['Fe','Mn','B','Zn','Cu','Mo','SiO2'];
                const dividerBorder = 'border-left:3px solid #64748b;';
                const macroLabel = (n) => {
                    if (n === 'N_NO3') return 'N-NO‚ÇÉ‚Åª';
                    if (n === 'N_NH4') return 'N-NH‚ÇÑ‚Å∫';
                    return getAdminNutrientLabel(n, programIsElemental);
                };
                const microLabel = (n) => getAdminNutrientLabel(n, programIsElemental);
                const displayMacro = (n, v) => {
                    let val = parseFloat(v || 0);
                    if (programIsElemental && ['P2O5','K2O','CaO','MgO'].includes(n)) {
                        val = convertAdminOxideToElemental(n, val);
                    }
                    return formatAdminValue(n, val);
                };
                const displayMicro = (n, v) => {
                    let val = parseFloat(v || 0);
                    if (programIsElemental && n === 'SiO2') {
                        val = convertAdminOxideToElemental(n, val);
                    }
                    return formatAdminValue(n, val);
                };
                const macroRows = weeks.map((w, idx) => `
                    <tr style="${idx % 2 === 0 ? 'background:#fff;' : 'background:#f8fafc;'}">
                        <td style="padding:8px;border:1px solid #e2e8f0;">${escapeHtml(w?.stage || '')}</td>
                        <td style="padding:8px;border:1px solid #e2e8f0;text-align:center;">${idx + 1}</td>
                        ${macroProgColumns.map((c, i) => `<td style="padding:8px;border:1px solid #e2e8f0;text-align:right;">${formatAdminValue('N', w?.kgByCol?.[c.id] || 0)}</td>`).join('')}
                        ${macroCols.map((n, i) => `<td style="padding:8px;border:1px solid #e2e8f0;${i === 0 ? dividerBorder : ''}text-align:right;">${displayMacro(n, w?.totals?.[n])}</td>`).join('')}
                    </tr>
                `).join('');
                const microRows = weeks.map((w, idx) => `
                    <tr style="${idx % 2 === 0 ? 'background:#fff;' : 'background:#f8fafc;'}">
                        <td style="padding:8px;border:1px solid #e2e8f0;">${escapeHtml(w?.stage || '')}</td>
                        <td style="padding:8px;border:1px solid #e2e8f0;text-align:center;">${idx + 1}</td>
                        ${microProgColumns.map((c, i) => `<td style="padding:8px;border:1px solid #e2e8f0;text-align:right;">${formatAdminValue('N', w?.kgByCol?.[c.id] || 0)}</td>`).join('')}
                        ${microCols.map((n, i) => `<td style="padding:8px;border:1px solid #e2e8f0;${i === 0 ? dividerBorder : ''}text-align:right;">${displayMicro(n, w?.totals?.[n])}</td>`).join('')}
                    </tr>
                `).join('');
                const macroTotals = macroCols.map(n => weeks.reduce((acc, w) => acc + (parseFloat(w?.totals?.[n]) || 0), 0));
                const microTotals = microCols.map(n => weeks.reduce((acc, w) => acc + (parseFloat(w?.totals?.[n]) || 0), 0));
                const macroTotalsRow = `
                    <tr style="background:#f1f5f9;font-weight:600;">
                        <td style="padding:8px;border:1px solid #e2e8f0;">TOTAL</td>
                        <td style="padding:8px;border:1px solid #e2e8f0;"></td>
                        ${macroFertColTotals.map(v => `<td style="padding:8px;border:1px solid #e2e8f0;text-align:right;">${formatAdminValue('N', v)}</td>`).join('')}
                        ${macroCols.map((n, i) => `<td style="padding:8px;border:1px solid #e2e8f0;${i === 0 ? dividerBorder : ''}text-align:right;">${displayMacro(n, macroTotals[i])}</td>`).join('')}
                    </tr>
                `;
                const microTotalsRow = `
                    <tr style="background:#f1f5f9;font-weight:600;">
                        <td style="padding:8px;border:1px solid #e2e8f0;">TOTAL</td>
                        <td style="padding:8px;border:1px solid #e2e8f0;"></td>
                        ${microFertColTotals.map(v => `<td style="padding:8px;border:1px solid #e2e8f0;text-align:right;">${formatAdminValue('N', v)}</td>`).join('')}
                        ${microCols.map((n, i) => `<td style="padding:8px;border:1px solid #e2e8f0;${i === 0 ? dividerBorder : ''}text-align:right;">${displayMicro(n, microTotals[i])}</td>`).join('')}
                    </tr>
                `;
                html += `
                    <div style="background: white; padding: 16px; border-radius: 6px; border: 1px solid #86efac;">
                        <h4 style="margin: 0 0 12px 0; color: #1e293b; font-size: 16px; font-weight: 600;">üíß Programa de Fertirriego</h4>
                        <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:12px;margin-bottom:12px;">
                            <div style="font-weight:600;color:#1e293b;margin-bottom:8px;">üìä Resumen Total del Ciclo</div>
                            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:8px;margin-bottom:10px;">
                                <div><strong>Semanas:</strong> ${weeks.length}</div>
                                <div><strong>Dosis Total Kg/Ha:</strong> ${formatAdminValue('N', totalDose)}</div>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color:#1e293b;font-size:13px;">üí° Aporte del programa de nutrici√≥n (Kg/Ha):</strong>
                                <div style="background:#fff;padding:8px;border-radius:6px;margin-top:6px;font-size:12px;display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:6px;">
                                    ${summaryNutrients.map(n => {
                                        const label = getAdminNutrientLabel(n, programIsElemental);
                                        return `<div><strong>${label}:</strong> ${formatAdminValue(n, summary.aportado[n])}</div>`;
                                    }).join('')}
                                </div>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color:#0369a1;font-size:13px;">üíß Aporte por agua (Kg/Ha):</strong>
                                <div style="background:#fff;padding:8px;border-radius:6px;margin-top:6px;font-size:12px;display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:6px;">
                                    ${summaryNutrients.map(n => {
                                        const label = getAdminNutrientLabel(n, programIsElemental);
                                        return `<div><strong>${label}:</strong> <span style="color:#0369a1;font-weight:600;">${formatAdminValue(n, summary.aportadoAgua[n])}</span></div>`;
                                    }).join('')}
                                </div>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color:#0369a1;font-size:13px;">üì¶ Aporte total (programa + agua) (Kg/Ha):</strong>
                                <div style="background:#fff;padding:8px;border-radius:6px;margin-top:6px;font-size:12px;display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:6px;">
                                    ${summaryNutrients.map(n => {
                                        const label = getAdminNutrientLabel(n, programIsElemental);
                                        return `<div><strong>${label}:</strong> ${formatAdminValue(n, summary.totalWithWater[n])}</div>`;
                                    }).join('')}
                                </div>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color:#1e293b;font-size:13px;">üéØ Requerimiento Real (Kg/Ha):</strong>
                                <div style="background:#fff;padding:8px;border-radius:6px;margin-top:6px;font-size:12px;display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:6px;">
                                    ${summaryNutrients.map(n => {
                                        const label = getAdminNutrientLabel(n, programIsElemental);
                                        return `<div><strong>${label}:</strong> ${formatAdminValue(n, summary.requerido[n])}</div>`;
                                    }).join('')}
                                </div>
                            </div>
                            <div>
                                <strong style="color:#1e293b;font-size:13px;">‚ûñ Diferencia (Aporte total - Requerimiento) (Kg/Ha):</strong>
                                <div style="background:#fff;padding:8px;border-radius:6px;margin-top:6px;font-size:12px;display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:6px;">
                                    ${summaryNutrients.map(n => {
                                        const label = getAdminNutrientLabel(n, programIsElemental);
                                        return `<div><strong>${label}:</strong> ${formatAdminValue(n, summary.diferencia[n])}</div>`;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                        <div style="display:grid; gap:6px; margin-bottom: 10px; font-size: 13px; color:#475569;">
                            <div><strong>Semanas:</strong> ${Array.isArray(fertirriegoProgram.weeks) ? fertirriegoProgram.weeks.length : 0}</div>
                            <div><strong>Unidad:</strong> ${fertirriegoProgram.timeUnit === 'mes' ? 'Mes' : 'Semana'}</div>
                            <div><strong>Fertilizantes:</strong> ${columnNames.length ? columnNames.map(n => `<span style="display:inline-block;background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe;border-radius:999px;padding:2px 8px;margin:2px 4px 0 0;">${escapeHtml(n)}</span>`).join('') : '<span style="color:#94a3b8;">Sin columnas</span>'}</div>
                        </div>
                        <div style="margin-bottom:12px;">
                            <div style="font-weight:600;color:#1e293b;margin-bottom:6px;">Programa ${fertirriegoProgram.timeUnit === 'mes' ? 'Mensual' : 'Semanal'} - Macros</div>
                            <div style="overflow-x:auto;">
                                <table style="width:100%;border-collapse:collapse;font-size:12px;">
                                    <thead>
                                        <tr style="background:#e2e8f0;">
                                            <th style="padding:8px;border:1px solid #cbd5e1;text-align:left;">Etapa</th>
                                            <th style="padding:8px;border:1px solid #cbd5e1;text-align:center;">#</th>
                                            ${macroColumnNames.map((name) => `<th style="padding:8px;border:1px solid #cbd5e1;text-align:center;">${escapeHtml(name || '')}</th>`).join('')}
                                            ${macroCols.map((n, i) => `<th style="padding:8px;border:1px solid #cbd5e1;${i === 0 ? dividerBorder : ''}text-align:center;">${macroLabel(n)}</th>`).join('')}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${macroRows}
                                        ${macroTotalsRow}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div style="margin-bottom:12px;">
                            <div style="font-weight:600;color:#1e293b;margin-bottom:6px;">Programa ${fertirriegoProgram.timeUnit === 'mes' ? 'Mensual' : 'Semanal'} - Micros</div>
                            <div style="overflow-x:auto;">
                                <table style="width:100%;border-collapse:collapse;font-size:12px;">
                                    <thead>
                                        <tr style="background:#e2e8f0;">
                                            <th style="padding:8px;border:1px solid #cbd5e1;text-align:left;">Etapa</th>
                                            <th style="padding:8px;border:1px solid #cbd5e1;text-align:center;">#</th>
                                            ${microColumnNames.map((name) => `<th style="padding:8px;border:1px solid #cbd5e1;text-align:center;">${escapeHtml(name || '')}</th>`).join('')}
                                            ${microCols.map((n, i) => `<th style="padding:8px;border:1px solid #cbd5e1;${i === 0 ? dividerBorder : ''}text-align:center;">${microLabel(n)}</th>`).join('')}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${microRows}
                                        ${microTotalsRow}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 12px;">
                            <div style="flex: 1; min-width: 320px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 12px;">
                                <div style="font-weight: 600; color: #1e293b; margin-bottom: 8px;">Macronutrientes</div>
                                <div id="${chartMacroWrapId}" style="width:100%;min-height:200px;color:#94a3b8;font-style:italic;">Cargando gr√°fica...</div>
                            </div>
                            <div style="flex: 1; min-width: 320px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 12px;">
                                <div style="font-weight: 600; color: #1e293b; margin-bottom: 8px;">Micronutrientes</div>
                                <div id="${chartMicroWrapId}" style="width:100%;min-height:200px;color:#94a3b8;font-style:italic;">Cargando gr√°fica...</div>
                            </div>
                        </div>
                        <details>
                            <summary style="cursor: pointer; font-weight: 600; color: #1e293b; font-size: 14px; margin-bottom: 8px;">Ver datos del programa (JSON)</summary>
                            <pre style="background: #f8fafc; padding: 12px; border-radius: 6px; overflow-x: auto; font-size: 12px; max-height: 300px; overflow-y: auto; margin: 0;">${JSON.stringify(fertirriegoProgram, null, 2)}</pre>
                        </details>
                    </div>
                `;
            }
            
            if (!hasFertirriegoData) {
                html += '<p style="color: #94a3b8; font-style: italic; margin: 0;">Esta secci√≥n a√∫n no ha sido configurada en el proyecto.</p>';
            }
            
            html += `</div>`;
            
            // Secci√≥n: HIDROPON√çA (soluciones nutritivas meq ‚Üí % ‚Üí ppm ‚Üí c√°lculo fertilizantes)
            // projectStorage guarda en project.hidroponia; tambi√©n puede estar en project.sections.hidroponia o project.hydroponics
            const hidroponia = project.hidroponia || project.sections?.hidroponia || project.hydroponics || null;
            const hasHidroponiaData = hidroponia && typeof hidroponia === 'object' && Object.keys(hidroponia).length > 0;
            const hydroStages = (hasHidroponiaData && Array.isArray(hidroponia.stages)) ? hidroponia.stages : [];
            const hydroActiveStage = (hasHidroponiaData && hydroStages.length > 0)
                ? (hydroStages.find(s => (hidroponia.activeStageId && s?.id === hidroponia.activeStageId)) || hydroStages[0])
                : null;
            const hydroFerts = (hasHidroponiaData && Array.isArray(hidroponia.fertilizers)) ? hidroponia.fertilizers : [];
            const hydroVolM3 = hasHidroponiaData ? (parseFloat(hidroponia.volumeWaterM3) || 100) : 100;
            const hydroTankL = hasHidroponiaData ? (parseFloat(hidroponia.tankVolumeL) || 1000) : 1000;
            const hydroInjRate = hasHidroponiaData ? (parseFloat(hidroponia.injectionRateLperM3) || 10) : 10;
            html += `
                <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; border-left: 4px solid #0ea5e9;">
                    <h3 style="margin: 0 0 16px 0; color: #1e293b; font-size: 18px;">
                        üå± Hidropon√≠a
                        ${!hasHidroponiaData ? '<span style="color: #64748b; font-size: 14px; font-weight: normal; margin-left: 8px;">(Sin datos)</span>' : ''}
                    </h3>
            `;
            if (hasHidroponiaData && hydroStages.length > 0) {
                if (hydroActiveStage) {
                    const activeMeq = hydroActiveStage.meq || {};
                    const nNo3 = parseFloat(activeMeq.N_NO3) || 0;
                    const nNh4 = parseFloat(activeMeq.N_NH4) || 0;
                    const nTotal = nNo3 + nNh4;
                    const pctNo3 = nTotal > 0 ? (nNo3 / nTotal) * 100 : 0;
                    const pctNh4 = nTotal > 0 ? (nNh4 / nTotal) * 100 : 0;
                    html += `
                        <div style="margin-bottom: 12px; padding: 8px 10px; border-radius: 8px; border: 1px solid #bae6fd; background: #f0f9ff; color: #0f172a; font-size: 13px;">
                            <strong>${escapeHtml(hydroActiveStage.name || 'Etapa')}:</strong>
                            Suma de N (meq/L): <strong>${nTotal.toFixed(2)}</strong> ¬∑
                            % Nitrato: <strong>${pctNo3.toFixed(1)}%</strong> ¬∑
                            % Amonio: <strong>${pctNh4.toFixed(1)}%</strong>
                        </div>
                    `;
                }
                const meqRows = hydroStages.map(stage => {
                    const meq = stage.meq || {};
                    const ce = adminHydroComputeCE(meq).toFixed(2);
                    const cells = HYDRO_MEQ_NUTRIENTS.map(n => `<td style="padding:6px 8px;border:1px solid #e2e8f0;text-align:right;">${(parseFloat(meq[n]) || 0).toFixed(1)}</td>`).join('');
                    return `<tr><td style="padding:6px 8px;border:1px solid #e2e8f0;">${escapeHtml(stage.name || '')}</td><td style="padding:6px 8px;border:1px solid #e2e8f0;text-align:right;">${ce}</td>${cells}</tr>`;
                }).join('');
                const meqHeader = HYDRO_MEQ_NUTRIENTS.map(n => `<th style="padding:6px 8px;border:1px solid #cbd5e1;text-align:center;">${adminHydroLabel(n)} (meq/L)</th>`).join('');
                const pctHeader = HYDRO_MEQ_NUTRIENTS.map(n => `<th style="padding:6px 8px;border:1px solid #cbd5e1;text-align:center;">${adminHydroLabel(n)} % meq</th>`).join('');
                html += `
                    <div style="margin-bottom: 16px;">
                        <strong style="color: #1e293b; font-size: 14px;">üß™ Soluci√≥n nutritiva por etapa (meq/L)</strong>
                        <div style="overflow-x: auto; margin-top: 8px;">
                            <table style="width:100%; border-collapse: collapse; font-size: 13px;">
                                <thead><tr style="background:#e0f2fe;"><th style="padding:6px 8px;border:1px solid #cbd5e1;">Etapa</th><th style="padding:6px 8px;border:1px solid #cbd5e1;">CE (dS/m)</th>${meqHeader}</tr></thead>
                                <tbody>${meqRows}</tbody>
                            </table>
                        </div>
                    </div>
                `;
                const pctRows = hydroStages.map(stage => {
                    const meq = stage.meq || {};
                    const sumAnions = HYDRO_ANIONS.reduce((acc, n) => acc + (parseFloat(meq[n]) || 0), 0);
                    const sumKCaMg = HYDRO_CATIONS_TRIANGLE.reduce((acc, n) => acc + (parseFloat(meq[n]) || 0), 0);
                    const totalCations = sumKCaMg + (parseFloat(meq.N_NH4) || 0);
                    const pct = {};
                    HYDRO_MEQ_NUTRIENTS.forEach(n => {
                        const val = parseFloat(meq[n]) || 0;
                        if (HYDRO_ANIONS.includes(n)) pct[n] = sumAnions > 0 ? (val / sumAnions) * 100 : 0;
                        else if (HYDRO_CATIONS_TRIANGLE.includes(n)) pct[n] = sumKCaMg > 0 ? (val / sumKCaMg) * 100 : 0;
                        else pct[n] = totalCations > 0 ? (val / totalCations) * 100 : 0;
                    });
                    const cells = HYDRO_MEQ_NUTRIENTS.map(n => `<td style="padding:6px 8px;border:1px solid #e2e8f0;text-align:right;">${pct[n].toFixed(1)}</td>`).join('');
                    return `<tr><td style="padding:6px 8px;border:1px solid #e2e8f0;">${escapeHtml(stage.name || '')}</td>${cells}</tr>`;
                }).join('');
                html += `
                    <div style="margin-bottom: 16px;">
                        <strong style="color: #1e293b; font-size: 14px;">üìä Peso en % de meq (aniones y cationes K+Ca+Mg)</strong>
                        <p style="margin:4px 0 8px 0;color:#64748b;font-size:12px;">Aniones: % sobre total N-NO‚ÇÉ‚Åª+P-H‚ÇÇPO‚ÇÑ‚Åª+S-SO‚ÇÑ¬≤‚Åª. Cationes K‚Å∫, Ca¬≤‚Å∫, Mg¬≤‚Å∫: % sobre K+Ca+Mg (sin amonio). N-NH‚ÇÑ‚Å∫: % sobre total cationes.</p>
                        <div style="overflow-x: auto; margin-top: 8px;">
                            <table style="width:100%; border-collapse: collapse; font-size: 13px;">
                                <thead><tr style="background:#e0f2fe;"><th style="padding:6px 8px;border:1px solid #cbd5e1;">Etapa</th>${pctHeader}</tr></thead>
                                <tbody>${pctRows}</tbody>
                            </table>
                        </div>
                    </div>
                `;
                if (hydroActiveStage) {
                    const meq = hydroActiveStage.meq || {};
                    const sumAn = HYDRO_ANIONS.reduce((acc, n) => acc + (parseFloat(meq[n]) || 0), 0);
                    const sumKCM = HYDRO_CATIONS_TRIANGLE.reduce((acc, n) => acc + (parseFloat(meq[n]) || 0), 0);
                    const pNO3 = sumAn > 0 ? ((parseFloat(meq.N_NO3) || 0) / sumAn) * 100 : 33.3;
                    const pH2PO4 = sumAn > 0 ? ((parseFloat(meq.P) || 0) / sumAn) * 100 : 33.3;
                    const pSO4 = sumAn > 0 ? ((parseFloat(meq.S) || 0) / sumAn) * 100 : 33.3;
                    const pK = sumKCM > 0 ? ((parseFloat(meq.K) || 0) / sumKCM) * 100 : 33.3;
                    const pCa = sumKCM > 0 ? ((parseFloat(meq.Ca) || 0) / sumKCM) * 100 : 33.3;
                    const pMg = sumKCM > 0 ? ((parseFloat(meq.Mg) || 0) / sumKCM) * 100 : 33.3;
                    const triSvg = adminBuildHydroTriangleSvg(pNO3, pH2PO4, pSO4, pK, pCa, pMg);
                    html += '<div style="margin-bottom: 16px;"><strong style="color: #1e293b; font-size: 14px;">üìê Diagrama ternario (% aniones y cationes)</strong><p style="margin:4px 0 8px 0;color:#64748b;font-size:12px;">Punto amarillo: aniones. Punto rojo: cationes K‚Å∫, Ca¬≤‚Å∫, Mg¬≤‚Å∫. Zonas: rangos de equilibrio.</p>'+triSvg+'</div>';
                }
                const ppmRows = hydroStages.map(stage => {
                    const meq = stage.meq || {};
                    const macroPpm = adminHydroMacroPpm(meq);
                    const ppm = stage.ppm || {};
                    const macroCells = HYDRO_MEQ_NUTRIENTS.map(n => `<td style="padding:6px 8px;border:1px solid #e2e8f0;text-align:right;">${(macroPpm[n] != null ? macroPpm[n] : (parseFloat(ppm[n]) || 0)).toFixed(1)}</td>`).join('');
                    const microCells = HYDRO_MICROS.map(n => `<td style="padding:6px 8px;border:1px solid #e2e8f0;text-align:right;">${(parseFloat(ppm[n]) || 0).toFixed(2)}</td>`).join('');
                    return `<tr><td style="padding:6px 8px;border:1px solid #e2e8f0;">${escapeHtml(stage.name || '')}</td>${macroCells}${microCells}</tr>`;
                }).join('');
                const ppmHeaderMacro = HYDRO_MEQ_NUTRIENTS.map(n => `<th style="padding:6px 8px;border:1px solid #cbd5e1;">${adminHydroLabel(n)} ppm</th>`).join('');
                const ppmHeaderMicro = HYDRO_MICROS.map(n => `<th style="padding:6px 8px;border:1px solid #cbd5e1;">${adminHydroLabel(n)} ppm</th>`).join('');
                html += `
                    <div style="margin-bottom: 16px;">
                        <strong style="color: #1e293b; font-size: 14px;">üìê Soluci√≥n nutritiva por etapa (ppm)</strong>
                        <div style="overflow-x: auto; margin-top: 8px;">
                            <table style="width:100%; border-collapse: collapse; font-size: 13px;">
                                <thead><tr style="background:#e0f2fe;"><th style="padding:6px 8px;border:1px solid #cbd5e1;">Etapa</th>${ppmHeaderMacro}${ppmHeaderMicro}</tr></thead>
                                <tbody>${ppmRows}</tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            if (hasHidroponiaData && (hydroVolM3 > 0 || hydroFerts.length > 0)) {
                const concentradoL = hydroVolM3 * hydroInjRate;
                const recargas = hydroTankL > 0 ? Math.ceil(concentradoL / hydroTankL) : 0;
                const recargasText = recargas <= 1 ? '1 recarga (el tanque alcanza).' : recargas + ' recargas de tanque necesarias.';
                const hydroRatio = hydroInjRate > 0 ? Math.round(1000 / hydroInjRate) : 100;
                html += `
                    <div style="margin-bottom: 16px;">
                        <strong style="color: #1e293b; font-size: 14px;">üì¶ C√°lculo por volumen de agua</strong>
                        <div style="background: #fff; padding: 10px; border-radius: 6px; border: 1px solid #bae6fd; margin-top: 6px; font-size: 13px; display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px;">
                            <div><strong>Volumen de agua (m¬≥):</strong> ${hydroVolM3}</div>
                            <div><strong>Volumen del tanque (L):</strong> ${hydroTankL}</div>
                            <div><strong>Tasa de inyecci√≥n (L/m¬≥):</strong> ${hydroInjRate}</div>
                            <div><strong>Relaci√≥n de inyecci√≥n:</strong> 1:${hydroRatio}</div>
                        </div>
                        <div style="margin-top: 10px; padding: 8px 12px; background: #f0f9ff; border-radius: 8px; border: 1px solid #bae6fd; font-size: 13px;">
                            <strong>Volumen de concentrado necesario:</strong> ${concentradoL.toFixed(1)} L (${hydroVolM3} m¬≥ √ó ${hydroInjRate} L/m¬≥). <span style="color:#64748b;">Con tanque de ${hydroTankL} L:</span> ${recargasText}
                        </div>
                    </div>
                `;
                const adminHydroMats = typeof adminGetHydroMaterialsElemental === 'function' ? adminGetHydroMaterialsElemental(project) : [];
                const customItems = (hasHidroponiaData && hidroponia.customMaterials && Array.isArray(hidroponia.customMaterials.items)) ? hidroponia.customMaterials.items : (project?.sections?.hidroponia?.customMaterials?.items || project?.hidroponia?.customMaterials?.items || []);
                function adminHydroFertName(f) {
                    if (f.name && String(f.name).trim()) return f.name;
                    const custom = customItems.find(m => (m.id || '') === (f.materialId || '') || (m.id || '') === String(f.materialId));
                    if (custom && (custom.name || custom.label)) return String(custom.name || custom.label).trim();
                    const mat = adminHydroMats.find(m => m.id === f.materialId);
                    if (mat && (mat.name || mat.label)) return String(mat.name || mat.label).trim();
                    if (f.materialId && String(f.materialId).startsWith('custom_')) return 'Personalizado';
                    return f.materialId || '‚Äî';
                }
                if (hydroFerts.length > 0) {
                    const contribHeaderCells = HYDRO_PPM_NUTRIENTS.map(n => `<th style="padding:6px 8px;border:1px solid #cbd5e1;text-align:center;">${adminHydroLabel(n)}</th>`).join('');
                    const fertRows = hydroFerts.map(f => {
                        const name = adminHydroFertName(f);
                        const tank = f.tank || 'A';
                        const totals = typeof adminHydroComputeDoseAndKg === 'function' ? adminHydroComputeDoseAndKg(f, hydroVolM3, adminHydroMats) : { dose: f.dose != null ? parseFloat(f.dose) : NaN, totalValue: NaN, totalUnit: 'kg' };
                        const dose = isFinite(totals.dose) ? totals.dose.toFixed(1) : '‚Äî';
                        const totalProduct = (isFinite(totals.totalValue) && totals.totalValue > 0) ? `${totals.totalValue.toFixed(2)} ${totals.totalUnit}` : '‚Äî';
                        const contrib = typeof adminHydroContributions === 'function' ? adminHydroContributions(f, adminHydroMats) : null;
                        const contribCells = HYDRO_PPM_NUTRIENTS.map(n => {
                            const v = contrib && (contrib[n] != null) ? parseFloat(contrib[n]) : 0;
                            const txt = v > 0 ? v.toFixed(2) : '';
                            return `<td style="padding:6px 8px;border:1px solid #e2e8f0;text-align:right;">${txt}</td>`;
                        }).join('');
                        return `<tr><td style="padding:6px 8px;border:1px solid #e2e8f0;">${escapeHtml(name)}</td><td style="padding:6px 8px;border:1px solid #e2e8f0;">Tanque ${escapeHtml(tank)}</td><td style="padding:6px 8px;border:1px solid #e2e8f0;text-align:right;">${dose}</td>${contribCells}<td style="padding:6px 8px;border:1px solid #e2e8f0;text-align:right;">${totalProduct}</td></tr>`;
                    }).join('');
                    html += `
                        <div style="margin-bottom: 16px;">
                            <strong style="color: #1e293b; font-size: 14px;">üßÆ Fertilizantes</strong>
                            <p style="margin:4px 0 8px 0;color:#64748b;font-size:12px;">Aporte en ppm de cada elemento en la soluci√≥n final. En "Total producto", s√≥lidos en kg y l√≠quidos (√°cidos) en L.</p>
                            <div style="overflow-x: auto; margin-top: 8px;">
                                <table style="width:100%; border-collapse: collapse; font-size: 13px;">
                                    <thead><tr style="background:#e0f2fe;"><th style="padding:6px 8px;border:1px solid #cbd5e1;">Fertilizante</th><th style="padding:6px 8px;border:1px solid #cbd5e1;">Tanque</th><th style="padding:6px 8px;border:1px solid #cbd5e1;">Dosis (ppm)</th>${contribHeaderCells}<th style="padding:6px 8px;border:1px solid #cbd5e1;">Total producto</th></tr></thead>
                                    <tbody>${fertRows}</tbody>
                                </table>
                            </div>
                        </div>
                    `;
                    // Por tanque (A, B, C...): total kg y por recarga si aplica
                    const HYDRO_TANQUES_ADMIN = ['A','B','C','D','E'];
                    const byTank = {};
                    HYDRO_TANQUES_ADMIN.forEach(tq => { byTank[tq] = { totalKg: 0, totalL: 0, items: [] }; });
                    hydroFerts.forEach(f => {
                        const totals = typeof adminHydroComputeDoseAndKg === 'function' ? adminHydroComputeDoseAndKg(f, hydroVolM3, adminHydroMats) : { totalValue: NaN, totalUnit: 'kg', kg: NaN };
                        if (!isFinite(totals.totalValue) || totals.totalValue <= 0) return;
                        const tank = f.tank || 'A';
                        if (!HYDRO_TANQUES_ADMIN.includes(tank)) return;
                        const name = adminHydroFertName(f);
                        if (totals.totalUnit === 'L') byTank[tank].totalL += totals.totalValue;
                        else byTank[tank].totalKg += totals.totalValue;
                        byTank[tank].items.push({ name, value: totals.totalValue, unit: totals.totalUnit, kg: totals.kg });
                    });
                    const tankBlocksHtml = HYDRO_TANQUES_ADMIN.map(tq => {
                        const data = byTank[tq];
                        if ((data.totalKg <= 0) && (data.totalL <= 0)) return '';
                        const totalParts = [];
                        if (data.totalKg > 0) totalParts.push(`${data.totalKg.toFixed(2)} kg`);
                        if (data.totalL > 0) totalParts.push(`${data.totalL.toFixed(2)} L`);
                        const perRecParts = [];
                        if (data.totalKg > 0) perRecParts.push(`${(recargas > 0 ? data.totalKg / recargas : data.totalKg).toFixed(2)} kg`);
                        if (data.totalL > 0) perRecParts.push(`${(recargas > 0 ? data.totalL / recargas : data.totalL).toFixed(2)} L`);
                        const totalLine = recargas > 1
                            ? `${totalParts.join(' + ')} total <span style="color:#64748b;font-size:12px;">(${perRecParts.join(' + ')} por recarga si son ${recargas} recargas)</span>`
                            : `${totalParts.join(' + ')} total <span style="color:#64748b;font-size:12px;">(${perRecParts.join(' + ')} por recarga)</span>`;
                        const itemsHtml = data.items.map(i => {
                            const pr = recargas > 0 ? (i.value / (recargas || 1)) : i.value;
                            const eq = i.unit === 'L' && isFinite(i.kg) && i.kg > 0 ? ` <span style="color:#64748b;">(‚âà ${i.kg.toFixed(2)} kg eq)</span>` : '';
                            return `<span style="display:block;font-size:12px;">${escapeHtml(i.name)}: ${i.value.toFixed(2)} ${i.unit}${eq} <span style="color:#64748b;">(${pr.toFixed(2)} ${i.unit} por recarga)</span></span>`;
                        }).join('');
                        return `<div style="background:#fff;padding:10px;border-radius:6px;border:1px solid #e2e8f0;margin-bottom:8px;"><strong>Tanque ${tq}:</strong> ${totalLine}<div style="margin-top:6px;">${itemsHtml}</div></div>`;
                    }).filter(Boolean).join('');
                    if (tankBlocksHtml) {
                        html += `<div style="margin-bottom: 16px;"><strong style="color: #1e293b; font-size: 14px;">üìã Por tanque (A, B, C‚Ä¶)</strong><p style="margin:6px 0 8px 0;color:#64748b;font-size:12px;">Las cantidades son el total para todo el volumen de agua indicado (s√≥lidos en kg y l√≠quidos en L). Si hay varias recargas, en cada llenada se usa la cantidad ¬´por recarga¬ª.</p><div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px;">${tankBlocksHtml}</div></div>`;
                    }
                }
                let hydroTotalsPpm = hasHidroponiaData && hidroponia.fertilizerTotalsPpm && typeof hidroponia.fertilizerTotalsPpm === 'object' ? hidroponia.fertilizerTotalsPpm : null;
                if (!hydroTotalsPpm && hydroFerts.length > 0 && typeof adminHydroContributions === 'function') {
                    const computed = {};
                    HYDRO_PPM_NUTRIENTS.forEach(n => { computed[n] = 0; });
                    hydroFerts.forEach(f => {
                        const c = adminHydroContributions(f, adminHydroMats);
                        if (c) HYDRO_PPM_NUTRIENTS.forEach(n => { computed[n] += c[n] || 0; });
                    });
                    hydroTotalsPpm = computed;
                }
                if (hydroTotalsPpm) {
                    const totalCells = HYDRO_PPM_NUTRIENTS.map(n => {
                        const v = parseFloat(hydroTotalsPpm[n]) || 0;
                        return `<td style="padding:6px 8px;border:1px solid #e2e8f0;text-align:center;background:#f0f9ff;"><span style="color:#0369a1;font-weight:600;">${adminHydroLabel(n)}</span><br><span style="font-weight:600;">${v.toFixed(2)}</span> ppm</td>`;
                    }).join('');
                    const totalHeaderCells = HYDRO_PPM_NUTRIENTS.map(n => `<th style="padding:6px 8px;border:1px solid #cbd5e1;text-align:center;">${adminHydroLabel(n)} ppm</th>`).join('');
                    html += `
                        <div style="margin-bottom: 0;">
                            <strong style="color: #1e293b; font-size: 14px;">üìä PPM aportadas totales</strong>
                            <div style="overflow-x: auto; margin-top: 8px;">
                                <table style="width:100%; border-collapse: collapse; font-size: 13px;">
                                    <thead><tr style="background:#e0f2fe;">${totalHeaderCells}</tr></thead>
                                    <tbody><tr>${totalCells}</tr></tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }
            }
            if (!hasHidroponiaData) {
                html += '<p style="color: #94a3b8; font-style: italic; margin: 0;">Esta secci√≥n a√∫n no ha sido configurada en el proyecto.</p>';
            }
            html += `</div>`;
            
            // ========== AN√ÅLISIS (mismo orden que las pesta√±as; cada uno abrir/minimizar; cada reporte despliega su info) ==========
            const formatAnalysisItemInfo = (obj) => {
                if (!obj || typeof obj !== 'object') return '';
                if (typeof window.NutriPlantRenderAnalysisReport === 'function')
                    return window.NutriPlantRenderAnalysisReport(obj, { escapeHtml });
                return '<div class="admin-analysis-data-wrap"><p class="admin-analysis-empty" style="color:#64748b; font-size: 12px; margin: 0;">Sin datos adicionales.</p></div>';
            };
            const renderAnalysisSection = (title, icon, list, colorLeft) => {
                const arr = Array.isArray(list) ? list : [];
                const hasData = arr.length > 0;
                const countLabel = hasData ? ` (${arr.length} ${arr.length === 1 ? 'reporte' : 'reportes'})` : '';
                const accentBorder = colorLeft === 'suelo' ? '#eab308' : colorLeft === 'solucion' ? '#3b82f6' : colorLeft === 'pasta' ? '#a855f7' : colorLeft === 'agua' ? '#06b6d4' : colorLeft === 'foliar' ? '#22c55e' : '#f97316';
                let inner = '';
                if (hasData) {
                    inner = '<div class="admin-reports-list">' + arr.map((a, i) => {
                        const name = a.title || a.name || (a.meta && a.meta.title) || `Reporte ${i + 1}`;
                        const date = a.date || (a.meta && a.meta.date) || (a.calculatedAt && new Date(a.calculatedAt).toLocaleDateString('es-MX')) || '';
                        const infoHtml = formatAnalysisItemInfo(a);
                        return `<details class="admin-report-item">
                            <summary style="list-style: none; display: flex; align-items: center; gap: 6px;">
                                <span class="admin-analysis-chevron" style="font-size: 10px;">‚ñ∂</span>
                                <strong>${escapeHtml(String(name))}</strong>${date ? ' <span style="color:#64748b;">' + escapeHtml(String(date)) + '</span>' : ''}
                            </summary>
                            <div class="admin-report-inner">
                                ${infoHtml}
                                <details class="admin-json-toggle"><summary>Ver JSON de este reporte</summary><pre>${escapeHtml(JSON.stringify(a, null, 2))}</pre></details>
                            </div>
                        </details>`;
                    }).join('') + '</div>';
                    inner += '<details class="admin-json-toggle" style="margin-top: 16px;"><summary>Ver datos (JSON) de todos</summary><pre style="max-height: 250px;">' + escapeHtml(JSON.stringify(list, null, 2)) + '</pre></details>';
                } else {
                    inner = '<p style="color: #94a3b8; font-style: italic; margin: 0;">Sin datos en este proyecto.</p>';
                }
                return `<details class="admin-analysis-block" style="border-left: 4px solid ${accentBorder};">
                    <summary style="list-style: none; display: flex; align-items: center; gap: 8px;">
                        <span class="admin-analysis-chevron" style="user-select: none;">‚ñ∂</span>
                        <span>${icon} ${title}${!hasData ? ' <span style="color: #64748b; font-size: 0.9em; font-weight: normal;">(Sin datos)</span>' : countLabel}</span>
                    </summary>
                    <div class="admin-analysis-body">
                        ${inner}
                    </div>
                </details>`;
            };
            
            html += renderAnalysisSection('An√°lisis de Suelo', 'üü´', project.soilAnalyses, 'suelo');
            html += renderAnalysisSection('Soluci√≥n Nutritiva', 'üß™üíß', project.solucionNutritivaAnalyses, 'solucion');
            html += renderAnalysisSection('Extracto de Pasta', 'üß™üìã', project.extractoPastaAnalyses, 'pasta');
            html += renderAnalysisSection('An√°lisis de Agua', 'üíßüî¨', project.aguaAnalyses, 'agua');
            html += renderAnalysisSection('An√°lisis Foliar', 'üçÉüîç', project.foliarAnalyses, 'foliar');
            html += renderAnalysisSection('An√°lisis de Fruta', 'üçéüî¨', project.frutaAnalyses, 'fruta');
            
            // Secci√≥n: D√âFICIT DE PRESI√ìN DE VAPOR (VPD) - mismo orden que pesta√±as
            const vpdAnalysis = project.sections?.vpd || project.vpdAnalysis || null;
            const hasVPDData = vpdAnalysis && typeof vpdAnalysis === 'object' && (
                (vpdAnalysis.environmental && (vpdAnalysis.environmental.vpd !== null && vpdAnalysis.environmental.vpd !== undefined)) ||
                (vpdAnalysis.advanced && (vpdAnalysis.advanced.vpd !== null && vpdAnalysis.advanced.vpd !== undefined)) ||
                (vpdAnalysis.history && Array.isArray(vpdAnalysis.history) && vpdAnalysis.history.length > 0)
            );
                html += `
                <div style="background: #fef3c7; padding: 20px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                    <h3 style="margin: 0 0 16px 0; color: #1e293b; font-size: 18px;">
                        üå°Ô∏è D√©ficit de Presi√≥n de Vapor (VPD)
                        ${!hasVPDData ? '<span style="color: #64748b; font-size: 14px; font-weight: normal; margin-left: 8px;">(Sin datos)</span>' : ''}
                    </h3>
                    ${hasVPDData 
                        ? `<div style="background: white; padding: 16px; border-radius: 6px;">
                            ${vpdAnalysis.environmental && vpdAnalysis.environmental.vpd !== null && vpdAnalysis.environmental.vpd !== undefined ? `
                                <div style="margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid #e5e7eb;">
                                    <h4 style="margin: 0 0 12px 0; color: #1e293b; font-size: 16px;">üìä Calculadora Ambiental</h4>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; font-size: 14px;">
                                        <div><strong>Temperatura:</strong> ${vpdAnalysis.environmental.temperature !== null ? vpdAnalysis.environmental.temperature + ' ¬∞C' : 'N/A'}</div>
                                        <div><strong>Humedad Relativa:</strong> ${vpdAnalysis.environmental.humidity !== null ? vpdAnalysis.environmental.humidity + ' %' : 'N/A'}</div>
                                        <div><strong>VPD:</strong> <span style="color: #059669; font-weight: 600;">${vpdAnalysis.environmental.vpd !== null ? vpdAnalysis.environmental.vpd.toFixed(2) + ' kPa' : 'N/A'}</span></div>
                                        <div><strong>HD:</strong> ${vpdAnalysis.environmental.hd !== null ? vpdAnalysis.environmental.hd.toFixed(2) + ' g/m¬≥' : 'N/A'}</div>
                                        ${vpdAnalysis.environmental.calculatedAt ? `<div><strong>Calculado:</strong> ${new Date(vpdAnalysis.environmental.calculatedAt).toLocaleString('es-MX')}</div>` : ''}
                                        ${vpdAnalysis.environmental.source ? `<div><strong>Fuente:</strong> ${vpdAnalysis.environmental.source === 'api' ? 'API Meteorol√≥gica' : 'Manual'}</div>` : ''}
                    </div>
                                </div>
                            ` : ''}
                            ${vpdAnalysis.advanced && vpdAnalysis.advanced.vpd !== null && vpdAnalysis.advanced.vpd !== undefined ? `
                                <div style="margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid #e5e7eb;">
                                    <h4 style="margin: 0 0 12px 0; color: #1e293b; font-size: 16px;">üî¨ Calculadora Avanzada</h4>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; font-size: 14px;">
                                        <div><strong>Temperatura Aire:</strong> ${vpdAnalysis.advanced.airTemperature !== null ? vpdAnalysis.advanced.airTemperature + ' ¬∞C' : 'N/A'}</div>
                                        <div><strong>Humedad Relativa:</strong> ${vpdAnalysis.advanced.airHumidity !== null ? vpdAnalysis.advanced.airHumidity + ' %' : 'N/A'}</div>
                                        ${vpdAnalysis.advanced.mode === 'leaf' ? `<div><strong>Temperatura Hoja:</strong> ${vpdAnalysis.advanced.leafTemperature !== null ? vpdAnalysis.advanced.leafTemperature + ' ¬∞C' : 'N/A'}</div>` : ''}
                                        ${vpdAnalysis.advanced.mode === 'radiation' ? `<div><strong>Radiaci√≥n Solar:</strong> ${vpdAnalysis.advanced.solarRadiation !== null ? vpdAnalysis.advanced.solarRadiation + ' W/m¬≤' : 'N/A'}</div>` : ''}
                                        ${vpdAnalysis.advanced.calculatedLeafTemp !== null ? `<div><strong>Temp. Hoja Calculada:</strong> ${vpdAnalysis.advanced.calculatedLeafTemp.toFixed(2)} ¬∞C</div>` : ''}
                                        <div><strong>VPD:</strong> <span style="color: #059669; font-weight: 600;">${vpdAnalysis.advanced.vpd !== null ? vpdAnalysis.advanced.vpd.toFixed(2) + ' kPa' : 'N/A'}</span></div>
                                        <div><strong>HD:</strong> ${vpdAnalysis.advanced.hd !== null ? vpdAnalysis.advanced.hd.toFixed(2) + ' g/m¬≥' : 'N/A'}</div>
                                        ${vpdAnalysis.advanced.calculatedAt ? `<div><strong>Calculado:</strong> ${new Date(vpdAnalysis.advanced.calculatedAt).toLocaleString('es-MX')}</div>` : ''}
                                    </div>
                                </div>
                            ` : ''}
                            ${vpdAnalysis.history && Array.isArray(vpdAnalysis.history) && vpdAnalysis.history.length > 0 ? `
                                <div>
                                    <h4 style="margin: 0 0 12px 0; color: #1e293b; font-size: 16px;">üìú Historial de C√°lculos (${vpdAnalysis.history.length})</h4>
                                    <div style="max-height: 300px; overflow-y: auto;">
                                        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                            <thead>
                                                <tr style="background: #f3f4f6; border-bottom: 2px solid #d1d5db;">
                                                    <th style="padding: 8px; text-align: left;">Tipo</th>
                                                    <th style="padding: 8px; text-align: right;">VPD (kPa)</th>
                                                    <th style="padding: 8px; text-align: right;">HD (g/m¬≥)</th>
                                                    <th style="padding: 8px; text-align: left;">Fecha/Hora</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${vpdAnalysis.history.slice().reverse().slice(0, 20).map(calc => `
                                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                                        <td style="padding: 8px;">${calc.type === 'environmental' ? 'üìä Ambiental' : 'üî¨ Avanzada'}</td>
                                                        <td style="padding: 8px; text-align: right; font-weight: 600; color: #059669;">${calc.vpd !== null && calc.vpd !== undefined ? calc.vpd.toFixed(2) : 'N/A'}</td>
                                                        <td style="padding: 8px; text-align: right;">${calc.hd !== null && calc.hd !== undefined ? calc.hd.toFixed(2) : 'N/A'}</td>
                                                        <td style="padding: 8px;">${calc.timestamp ? new Date(calc.timestamp).toLocaleString('es-MX') : 'N/A'}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            ` : ''}
                        </div>`
                        : '<p style="color: #94a3b8; font-style: italic; margin: 0;">Esta secci√≥n a√∫n no ha sido configurada en el proyecto.</p>'
                    }
                </div>
            `;
            
            // Historial de Chat
            if (project.chat_history && Array.isArray(project.chat_history) && project.chat_history.length > 0) {
                html += `
                    <div style="background: #f3f4f6; padding: 20px; border-radius: 8px; border-left: 4px solid #6b7280;">
                        <h3 style="margin: 0 0 16px 0; color: #1e293b; font-size: 18px;">üí¨ Historial de Chat (${project.chat_history.length} mensajes)</h3>
                        <div style="max-height: 300px; overflow-y: auto;">
                `;
                const chatReversed = [...project.chat_history].reverse();
                chatReversed.slice(0, 10).forEach((msg, idx) => {
                    html += `
                        <div style="background: white; padding: 8px; margin-bottom: 8px; border-radius: 4px; font-size: 12px;">
                            <strong>${msg.sender || 'unknown'}:</strong> ${escapeHtml((msg.content || '').substring(0, 100))}${(msg.content || '').length > 100 ? '...' : ''}
                        </div>
                    `;
                });
                if (project.chat_history.length > 10) {
                    html += `<div style="text-align: center; color: #64748b; font-size: 12px;">... y ${project.chat_history.length - 10} mensajes m√°s (m√°s recientes arriba)</div>`;
                }
                html += `</div></div>`;
            }
            
            // Datos completos en JSON (colapsable)
            html += `
                        <details style="background: #f9fafb; padding: 20px; border-radius: 8px; border-left: 4px solid #9ca3af;">
                            <summary style="cursor: pointer; font-weight: 600; color: #1e293b; font-size: 16px; margin-bottom: 12px;">üìÑ Ver Datos Completos (JSON)</summary>
                            <pre style="background: white; padding: 12px; border-radius: 6px; overflow-x: auto; font-size: 11px; max-height: 400px; overflow-y: auto;">${JSON.stringify(project, null, 2)}</pre>
                        </details>
                    </div>
                    
                    <div style="display: flex; gap: 12px; margin-top: 24px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                        <button onclick="closeDataViewer()" 
                                style="flex: 1; padding: 12px; background: #e5e7eb; color: #374151; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            Cerrar
                        </button>
                        <button onclick="editProject('${projectId}'); closeDataViewer();" 
                                style="flex: 1; padding: 12px; background: #60a5fa; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            ‚úèÔ∏è Editar Proyecto
                        </button>
                    </div>
                </div>
            `;
            
            const modal = document.getElementById('dataViewerModal');
            const content = document.getElementById('dataViewerContent');
            if (modal && content) {
                content.innerHTML = html;
                modal.style.display = 'flex';
                if (fertiChartIds && typeof renderAdminFertirriegoCharts === 'function') {
                    const tryRender = () => {
                        const macroEl = document.getElementById(fertiChartIds.macroWrapId) || document.getElementById(fertiChartIds.macroId) || content.querySelector('[id^="adminFertiMacroChartWrap_"]');
                        const microEl = document.getElementById(fertiChartIds.microWrapId) || document.getElementById(fertiChartIds.microId) || content.querySelector('[id^="adminFertiMicroChartWrap_"]');
                        renderAdminFertirriegoCharts(fertirriegoProgram, fertiChartIds, project, { macroEl, microEl });
                    };
                    tryRender();
                    requestAnimationFrame(tryRender);
                    setTimeout(tryRender, 50);
                    setTimeout(tryRender, 200);
                }
            }
        }
        window.viewProjectDetails = viewProjectDetails;

        window.openProjectSavedReport = function(encodedUserId, encodedProjectId, encodedReportId) {
            const userId = decodeURIComponent(String(encodedUserId || ''));
            const projectId = decodeURIComponent(String(encodedProjectId || ''));
            const reportId = decodeURIComponent(String(encodedReportId || ''));
            if (!userId || !projectId || !reportId) {
                alert('‚ùå No se pudo identificar el reporte seleccionado.');
                return;
            }

            let report = null;
            // Primero buscar en reportes de la nube (cargados en admin)
            const cloudReports = (window._adminCloudCache && window._adminCloudCache.reports) || [];
            const cloudRow = cloudReports.find(function(r) {
                return r && String(r.user_id) === String(userId) && String(r.project_id) === String(projectId) && String(r.id) === String(reportId);
            });
            if (cloudRow && cloudRow.data && typeof cloudRow.data === 'object') {
                report = cloudRow.data;
            }
            // Si no est√° en nube, buscar en localStorage
            if (!report) {
                const key = `nutriplant_reports_${userId}_${projectId}`;
                try {
                    const raw = localStorage.getItem(key);
                    const reports = raw ? JSON.parse(raw) : [];
                    report = Array.isArray(reports) ? reports.find(r => r && String(r.id) === reportId) : null;
                } catch (e) {
                    console.error('‚ùå Error leyendo reportes guardados:', e);
                }
            }
            if (!report) {
                alert('‚ùå Reporte no encontrado (ni en nube ni en almacenamiento local).');
                return;
            }

            const reportHTML = typeof report.reportHTML === 'string' ? report.reportHTML.trim() : '';
            if (!reportHTML) {
                alert('‚ö†Ô∏è Este reporte fue generado antes de guardar HTML en historial. Genera nuevamente el reporte desde el panel de usuario para abrirlo/imprimirlo desde admin.');
                return;
            }

            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                alert('‚ùå Tu navegador bloque√≥ la ventana emergente. Habilita pop-ups para imprimir.');
                return;
            }

            printWindow.document.open();
            printWindow.document.write(reportHTML);
            printWindow.document.close();
            printWindow.focus();
            printWindow.onload = function() {
                setTimeout(function() {
                    printWindow.print();
                }, 300);
            };
        };
        
        // Orden de aportes como en el panel del usuario (Fertirriego, Granular, Cultivos, Enmiendas)
        var ADMIN_FERTI_ORDER = ['N_NO3','N_NH4','P2O5','K2O','CaO','MgO','S','SO4','Fe','Mn','B','Zn','Cu','Mo','SiO2'];
        var ADMIN_HYDRO_ORDER = ['N_NH4','N_NO3','P','S','K','Ca','Mg','Fe','Mn','B','Zn','Cu','Mo'];
        var ADMIN_EXTRACTION_ORDER = ['N','P2O5','K2O','CaO','MgO','S','SO4','Fe','Mn','B','Zn','Cu','Mo','SiO2'];
        var ADMIN_GRANULAR_ORDER = ['N','P2O5','K2O','CaO','MgO','S','SO4','Fe','Mn','B','Zn','Cu','Mo','SiO2'];
        var ADMIN_AMENDMENT_ORDER = ['formula','formula_quimica','peso_molecular','molecular_weight','k','ca','mg','so4','co3','h2o','si'];

        // Formatear composici√≥n (nutrientes, extracci√≥n, etc.) como tabla legible, con orden fijo si se pasa keyOrder
        function formatComposition(obj, skipKeys, keyOrder, extractionOrder) {
            if (!obj || typeof obj !== 'object') return '<p style="margin:0;font-size:12px;color:#64748b;">‚Äî</p>';
            var skip = skipKeys || ['name','id','source'];
            var rows = [];
            var seen = {};
            function addRow(k, v, prefix) {
                var key = (prefix ? prefix + '.' : '') + k;
                if (seen[key]) return;
                seen[key] = true;
                var val = typeof v === 'object' ? JSON.stringify(v) : v;
                rows.push({ k: key, v: val });
            }
            function addKeys(o, prefix, order) {
                if (!o || typeof o !== 'object') return;
                if (order && Array.isArray(order)) {
                    order.forEach(function(k) {
                        if (skip.indexOf(k) !== -1) return;
                        var v = o[k];
                        if (k === 'extraction' && typeof v === 'object') {
                            addKeys(v, prefix ? prefix + '.extracci√≥n' : 'extracci√≥n', extractionOrder || ADMIN_EXTRACTION_ORDER);
                            return;
                        }
                        if (v !== null && v !== undefined && v !== '' && ((typeof v === 'number' && !isNaN(v)) || (typeof v === 'string' && v !== ''))) addRow(k, v, prefix);
                    });
                    Object.keys(o).forEach(function(k) {
                        if (order.indexOf(k) !== -1 || skip.indexOf(k) !== -1) return;
                        var v = o[k];
                        if (k === 'extraction' && typeof v === 'object') return;
                        if (v !== null && v !== undefined && v !== '' && ((typeof v === 'number' && !isNaN(v)) || (typeof v === 'string' && v !== ''))) addRow(k, v, prefix);
                    });
                } else {
                    Object.keys(o).forEach(function(k) {
                        if (skip.indexOf(k) !== -1) return;
                        var v = o[k];
                        if (k === 'extraction' && typeof v === 'object') {
                            addKeys(v, prefix ? prefix + '.extracci√≥n' : 'extracci√≥n', extractionOrder || ADMIN_EXTRACTION_ORDER);
                            return;
                        }
                        if (v !== null && v !== undefined && v !== '' && ((typeof v === 'number' && !isNaN(v)) || (typeof v === 'string' && v !== ''))) addRow(k, v, prefix);
                    });
                }
            }
            addKeys(obj, '', keyOrder);
            if (rows.length === 0) return '<p style="margin:0;font-size:12px;color:#64748b;">Sin datos de composici√≥n</p>';
            // Si todas las claves comparten el prefijo "extracci√≥n.", usarlo como t√≠tulo y mostrar solo el elemento en cada columna
            var prefix = 'extracci√≥n.';
            var allHavePrefix = rows.length > 0 && rows.every(function(r) { return r.k.indexOf(prefix) === 0; });
            var titleHtml = allHavePrefix ? '<p style="margin:0 0 6px 0;font-size:12px;font-weight:600;color:#475569;">Extracci√≥n</p>' : '';
            var headerLabel = function(k) {
                if (allHavePrefix && k.indexOf(prefix) === 0) return k.slice(prefix.length);
                return k;
            };
            // Tabla horizontal: una fila de encabezados (nutrientes) y una fila de valores
            var t = '<div style="overflow-x:auto;margin-top:8px;">' + titleHtml + '<table style="font-size:11px;border-collapse:collapse;min-width:100%;"><thead><tr>';
            rows.forEach(function(r) {
                t += '<th style="padding:6px 8px;background:#f1f5f9;color:#475569;border:1px solid #e2e8f0;white-space:nowrap;">' + escapeHtml(headerLabel(r.k)) + '</th>';
            });
            t += '</tr></thead><tbody><tr>';
            rows.forEach(function(r) {
                t += '<td style="padding:6px 8px;border:1px solid #e2e8f0;text-align:center;font-weight:500;">' + escapeHtml(String(r.v)) + '</td>';
            });
            t += '</tr></tbody></table></div>';
            return t;
        }

        // Construir HTML de la secci√≥n de cat√°logos del usuario (desde nube), con composici√≥n desplegable por √≠tem
        function buildUserCatalogsSection(userId, user) {
            var cloudUser = (window._adminCloudCache && Array.isArray(window._adminCloudCache.users))
                ? window._adminCloudCache.users.find(function(u) { return (u.id || u.userId) === userId; })
                : null;
            var u = cloudUser || user;
            if (!u) return '<p style="color:#64748b;">Cargar desde nube para ver cat√°logos.</p>';
            var html = '';

            function listWithComposition(items, getComposition) {
                if (!items || items.length === 0) return '<p style="margin:0;color:#64748b;font-size:13px;">Ninguno</p>';
                return items.map(function(x, i) {
                    var name = escapeHtml(x.name || x.id || '‚Äî');
                    var comp = (getComposition && getComposition(x)) || formatComposition(x);
                    return '<details style="background:#f8fafc;padding:10px;border-radius:6px;margin-bottom:6px;border:1px solid #e2e8f0;"><summary style="cursor:pointer;font-weight:500;">' + name + '</summary>' + comp + '</details>';
                }).join('');
            }
            function listObjWithComposition(obj, getComposition) {
                if (!obj || typeof obj !== 'object') return '<p style="margin:0;color:#64748b;font-size:13px;">Ninguno</p>';
                var keys = Object.keys(obj);
                if (keys.length === 0) return '<p style="margin:0;color:#64748b;font-size:13px;">Ninguno</p>';
                return keys.map(function(k) {
                    var v = obj[k];
                    var name = escapeHtml((v && (v.name || v.id)) ? (v.name || v.id) : k);
                    var comp = (getComposition && getComposition(k, v)) || formatComposition(v);
                    return '<details style="background:#f8fafc;padding:10px;border-radius:6px;margin-bottom:6px;border:1px solid #e2e8f0;"><summary style="cursor:pointer;font-weight:500;">' + name + '</summary>' + comp + '</details>';
                }).join('');
            }

            // Fertirriego ‚Äì fertilizantes (orden: N_NO3, N_NH4, P2O5, K2O, CaO, MgO, S, SO4, Fe, Mn, B, Zn, Cu, Mo, SiO2)
            var fertiItems = (u.custom_ferti_materials && u.custom_ferti_materials.items) ? u.custom_ferti_materials.items : (Array.isArray(u.custom_ferti_materials) ? u.custom_ferti_materials : []);
            html += '<details style="background:#fff;padding:12px;border-radius:6px;border:1px solid #e5e7eb;"><summary style="cursor:pointer;font-weight:500;">üå± Fertilizantes (Fertirriego)</summary><div style="margin-top:8px;">' + listWithComposition(fertiItems, function(x) { return formatComposition(x, null, ADMIN_FERTI_ORDER); }) + '</div></details>';

            // Hidropon√≠a ‚Äì fertilizantes (orden: N_NH4, N_NO3, P, S, K, Ca, Mg, Fe, Mn, B, Zn, Cu, Mo)
            var hydroItems = (u.custom_hydro_materials && u.custom_hydro_materials.items) ? u.custom_hydro_materials.items : (Array.isArray(u.custom_hydro_materials) ? u.custom_hydro_materials : []);
            html += '<details style="background:#fff;padding:12px;border-radius:6px;border:1px solid #e5e7eb;"><summary style="cursor:pointer;font-weight:500;">üíß Fertilizantes (Hidropon√≠a)</summary><div style="margin-top:8px;">' + listWithComposition(hydroItems, function(x) { return formatComposition(x, null, ADMIN_HYDRO_ORDER); }) + '</div></details>';

            // Nutrici√≥n granular ‚Äì materias primas (orden: N, P2O5, K2O, CaO, MgO, S, SO4, Fe, Mn, B, Zn, Cu, Mo, SiO2)
            var granMat = (u.custom_granular_materials && typeof u.custom_granular_materials === 'object') ? u.custom_granular_materials : {};
            html += '<details style="background:#fff;padding:12px;border-radius:6px;border:1px solid #e5e7eb;"><summary style="cursor:pointer;font-weight:500;">üì¶ Materias primas (Nutrici√≥n granular)</summary><div style="margin-top:8px;">' + listObjWithComposition(granMat, function(k, v) { return formatComposition(v, null, ADMIN_GRANULAR_ORDER); }) + '</div></details>';

            // Fertirriego ‚Äì cultivos (extracci√≥n en orden: N, P2O5, K2O, CaO, MgO, S, SO4, Fe, Mn, B, Zn, Cu, Mo, SiO2)
            var fertiCrops = (u.custom_ferti_crops && typeof u.custom_ferti_crops === 'object') ? u.custom_ferti_crops : {};
            html += '<details style="background:#fff;padding:12px;border-radius:6px;border:1px solid #e5e7eb;"><summary style="cursor:pointer;font-weight:500;">üåæ Cultivos personalizados (Fertirriego)</summary><div style="margin-top:8px;">' + listObjWithComposition(fertiCrops, function(k, v) { return formatComposition(v, ['name','id','source'], ['extraction'], ADMIN_EXTRACTION_ORDER); }) + '</div></details>';

            // Nutrici√≥n granular ‚Äì cultivos (mismo orden de extracci√≥n)
            var granCrops = (u.custom_granular_crops && typeof u.custom_granular_crops === 'object') ? u.custom_granular_crops : {};
            html += '<details style="background:#fff;padding:12px;border-radius:6px;border:1px solid #e5e7eb;"><summary style="cursor:pointer;font-weight:500;">üåæ Cultivos personalizados (Nutrici√≥n granular)</summary><div style="margin-top:8px;">' + listObjWithComposition(granCrops, function(k, v) { return formatComposition(v, ['name','id','source'], ['extraction'], ADMIN_EXTRACTION_ORDER); }) + '</div></details>';

            // Enmiendas (orden: F√≥rmula, Peso Molecular, %K, %Ca, %Mg, %SO‚ÇÑ, %CO‚ÇÉ, %H‚ÇÇO, %Si)
            var amendments = Array.isArray(u.custom_amendments) ? u.custom_amendments : (u.custom_amendments && typeof u.custom_amendments === 'object' ? Object.values(u.custom_amendments) : []);
            html += '<details style="background:#fff;padding:12px;border-radius:6px;border:1px solid #e5e7eb;"><summary style="cursor:pointer;font-weight:500;">üß™ Enmiendas personalizadas</summary><div style="margin-top:8px;">' + listWithComposition(amendments, function(x) { return formatComposition(x, ['name','id','source'], ADMIN_AMENDMENT_ORDER); }) + '</div></details>';

            return html || '<p style="color:#64748b;">Sin cat√°logos en la nube.</p>';
        }

        // üë§ FUNCI√ìN PARA VER DETALLES COMPLETOS DEL USUARIO Y SUS PROYECTOS
        async function viewUserDetails(userId, fromView = null, fromViewParams = null) {
            // Guardar vista anterior si se proporciona (nombre de funci√≥n o funci√≥n)
            if (fromView) {
                var fn = typeof fromView === 'function' ? fromView : window[fromView];
                if (typeof fn === 'function') setPreviousView(fn, fromViewParams || []);
            }
            
            // Guardar el contexto actual en variable temporal para usarlo en el HTML
            // Guardamos el nombre de la funci√≥n como string para poder serializarlo
            tempNavigationContext = {
                previousViewName: navigationHistory.previousView ? (navigationHistory.previousView.name || null) : null,
                previousViewParams: navigationHistory.previousViewParams || []
            };
            
            // Obtener informaci√≥n del usuario (prioridad: getAllUsers que fusiona localStorage + Supabase)
            let user = null;
            const allUsers = getAllUsers();
            user = allUsers.find(u => (u.id || u.userId) === userId);
            if (!user) {
                const userKey = `nutriplant_user_${userId}`;
                const userValue = localStorage.getItem(userKey);
                if (userValue && (userValue.startsWith('{') || userValue.startsWith('['))) {
                    try { user = JSON.parse(userValue); } catch (e) {}
                }
            }
            if (!user && window._adminCloudCache && Array.isArray(window._adminCloudCache.users)) {
                user = window._adminCloudCache.users.find(u => (u.id || u.userId) === userId);
            }
            if (!user) {
                alert('‚ùå Usuario no encontrado');
                return;
            }
            user = { ...user, chat_history_sin_proyecto: user.chat_history_sin_proyecto || [] };
            
            // Refrescar fechas de suscripci√≥n directamente desde Supabase para evitar N/A por cach√© local.
            try {
                const userIdText = String(user.id || user.userId || userId || '');
                const isUuid = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(userIdText);
                if (isUuid && window.getSupabaseClient) {
                    const client = window.getSupabaseClient();
                    if (client) {
                        const { data: freshProfile, error: freshErr } = await client
                            .from('profiles')
                            .select('subscription_activated_at, last_payment_date, next_payment_date, paypal_subscription_id, subscription_amount, subscription_status')
                            .eq('id', userIdText)
                            .maybeSingle();
                        if (!freshErr && freshProfile) {
                            user = {
                                ...user,
                                subscription_activated_at: freshProfile.subscription_activated_at || user.subscription_activated_at || null,
                                last_payment_date: freshProfile.last_payment_date || user.last_payment_date || null,
                                next_payment_date: freshProfile.next_payment_date || user.next_payment_date || null,
                                paypal_subscription_id: freshProfile.paypal_subscription_id || user.paypal_subscription_id || null,
                                subscription_status: freshProfile.subscription_status || user.subscription_status,
                                subscription_amount: freshProfile.subscription_amount ?? user.subscription_amount
                            };
                        }
                    }
                }
            } catch (e) {
                console.warn('‚ö†Ô∏è No se pudo refrescar perfil desde Supabase en detalle de usuario:', e);
            }
            
            // Obtener proyectos del usuario (email por si userId no coincide con la clave en localStorage)
            const userProjects = getUserProjects(userId, user.email);
            // Resumen chat IA por usuario (suma de todos sus proyectos)
            let userChatMessages = 0, userChatInteractions = 0;
            userProjects.forEach(function (p) {
                const hist = Array.isArray(p.chat_history) ? p.chat_history : [];
                userChatMessages += hist.length;
                hist.forEach(function (m) { if (m && (m.sender === 'user' || m.type === 'user')) userChatInteractions++; });
            });
            var sinProyecto = Array.isArray(user.chat_history_sin_proyecto) ? user.chat_history_sin_proyecto : [];
            userChatMessages += sinProyecto.length;
            sinProyecto.forEach(function (m) { if (m && (m.sender === 'user' || m.type === 'user')) userChatInteractions++; });
            const userChatCost = (userChatInteractions * 0.001).toFixed(4);
            
            // Fechas de pago para mostrar (o fallback desde activaci√≥n)
            const lastPaymentDisplay = user.last_payment_date ? new Date(user.last_payment_date).toLocaleDateString('es-MX') : (user.subscription_activated_at ? new Date(user.subscription_activated_at).toLocaleDateString('es-MX') + ' (activaci√≥n)' : 'N/A');
            let nextPaymentDisplay = user.next_payment_date ? new Date(user.next_payment_date).toLocaleDateString('es-MX') : 'N/A';
            if (nextPaymentDisplay === 'N/A' && user.subscription_activated_at) {
              const d = new Date(user.subscription_activated_at);
              d.setMonth(d.getMonth() + 5);
              nextPaymentDisplay = d.toLocaleDateString('es-MX') + ' (aprox. 5 meses)';
            }
            // Construir HTML con toda la informaci√≥n
            let html = `
                <div style="padding: 24px; max-height: 90vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            ${navigationHistory.previousView ? `
                                <button onclick="goBack()" 
                                        style="background: #f3f4f6; border: none; font-size: 20px; color: #374151; cursor: pointer; padding: 6px 12px; border-radius: 6px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" 
                                        onmouseover="this.style.background='#e5e7eb'; this.style.color='#1f2937';" 
                                        onmouseout="this.style.background='#f3f4f6'; this.style.color='#374151';"
                                        title="Volver atr√°s">
                                    ‚Üê
                                </button>
                            ` : ''}
                        <h2 style="margin: 0; color: #1e293b; font-size: 24px;">üë§ Detalles del Usuario: ${escapeHtml(user.name || user.email || 'Sin nombre')}</h2>
                        </div>
                        <button onclick="closeDataViewer()" 
                                style="background: none; border: none; font-size: 24px; color: #64748b; cursor: pointer; padding: 4px 12px; transition: all 0.2s;" 
                                onmouseover="this.style.color='#ef4444'; this.style.background='#fef2f2'; this.style.borderRadius='6px';" 
                                onmouseout="this.style.color='#64748b'; this.style.background='none';"
                                title="Cerrar y volver al panel principal">
                            √ó
                        </button>
                    </div>
                    
                    <div style="display: grid; gap: 20px;">
                        <!-- Informaci√≥n Personal -->
                        <div style="background: #f8fafc; padding: 20px; border-radius: 8px; border-left: 4px solid #60a5fa;">
                            <h3 style="margin: 0 0 16px 0; color: #1e293b; font-size: 18px;">üìã Informaci√≥n Personal</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                                <div><strong>ID:</strong> ${escapeHtml(user.id || userId)}</div>
                                <div><strong>Nombre:</strong> ${escapeHtml(user.name || 'N/A')}</div>
                                <div><strong>Email:</strong> ${escapeHtml(user.email || 'N/A')}</div>
                                <div><strong>Contrase√±a:</strong> ${escapeHtml(user.password || (/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(userId) ? 'üîí No guardada (registro anterior)' : 'Sin contrase√±a'))}</div>
                                <div><strong>Tel√©fono:</strong> ${escapeHtml(user.phone || 'N/A')}</div>
                                <div><strong>Ubicaci√≥n:</strong> ${user.location ? (typeof user.location === 'object' ? [user.location.city, user.location.state, user.location.country].filter(Boolean).join(', ') : user.location) : 'N/A'}</div>
                                <div><strong>Profesi√≥n:</strong> ${escapeHtml(user.profession || 'N/A')}</div>
                                <div><strong>Cultivos:</strong> ${user.crops && Array.isArray(user.crops) ? user.crops.join(', ') : (user.crops || 'N/A')}</div>
                                <div><strong>Fecha de Registro:</strong> ${user.created_at ? new Date(user.created_at).toLocaleString('es-MX') : 'N/A'}</div>
                                <div><strong>√öltimo Acceso:</strong> ${user.last_login ? new Date(user.last_login).toLocaleString('es-MX') : 'N/A'}</div>
                            </div>
                        </div>
                        
                        <!-- Informaci√≥n de Suscripci√≥n -->
                        <div style="background: ${user.subscription_status === 'active' ? '#f0fdf4' : user.subscription_status === 'expired' ? '#fef2f2' : '#fef3c7'}; padding: 20px; border-radius: 8px; border-left: 4px solid ${user.subscription_status === 'active' ? '#10b981' : user.subscription_status === 'expired' ? '#ef4444' : '#f59e0b'};">
                            <h3 style="margin: 0 0 16px 0; color: #1e293b; font-size: 18px;">üí≥ Informaci√≥n de Suscripci√≥n</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                                <div><strong>Estado:</strong> ${user.subscription_status === 'active' ? '‚úÖ Activa' : user.subscription_status === 'expired' ? '‚è∞ Expirada' : user.subscription_status === 'cancelled' ? '‚ùå Cancelada' : user.subscription_status === 'pending' ? '‚è≥ Pendiente' : user.subscription_status === 'inactive' ? '‚ùå Inactiva' : '‚ùì Desconocido'}</div>
                                <div><strong>Monto:</strong> ${user.subscription_amount != null && user.subscription_amount !== '' && parseFloat(user.subscription_amount) > 0 ? `$${parseFloat(user.subscription_amount).toFixed(2)} USD` : 'Sin suscripci√≥n'}</div>
                                <div><strong>√öltimo Pago:</strong> ${lastPaymentDisplay}</div>
                                <div><strong>Pr√≥ximo Pago:</strong> ${nextPaymentDisplay}</div>
                            </div>
                        </div>
                        
                        <!-- Resumen del chat IA (por usuario, acumulado total de todos sus proyectos) -->
                        <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; border-left: 4px solid #0ea5e9;">
                            <h3 style="margin: 0 0 16px 0; color: #1e293b; font-size: 18px;">üí¨ Resumen del chat IA</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px;">
                                <div><strong style="color: #0c4a6e;">Mensajes totales:</strong><br><span style="color: #0369a1; font-size: 16px; font-weight: 600;">${userChatMessages}</span></div>
                                <div><strong style="color: #0c4a6e;">Interacciones IA:</strong><br><span style="color: #0369a1; font-size: 16px; font-weight: 600;">${userChatInteractions}</span></div>
                                <div><strong style="color: #0c4a6e;">Costo est. total (USD):</strong><br><span style="color: #0369a1; font-size: 16px; font-weight: 600;">$${userChatCost}</span></div>
                            </div>
                            ${userChatMessages === 0 ? '<p style="color: #64748b; font-size: 14px; margin: 12px 0 0 0;">Este usuario a√∫n no tiene mensajes en el chat (ni en proyectos ni en chat sin proyecto).</p>' : ''}
                        </div>
                        
                        <!-- Cat√°logos guardados en la nube (desplegable) -->
                        <div style="background: #f5f3ff; padding: 20px; border-radius: 8px; border-left: 4px solid #8b5cf6;">
                            <details style="margin: 0;">
                                <summary style="cursor: pointer; font-weight: 600; color: #1e293b; font-size: 18px;">üìö Cat√°logos guardados en la nube</summary>
                                <div style="margin-top: 16px; display: grid; gap: 12px;">
                                    ${buildUserCatalogsSection(userId, user)}
                                </div>
                            </details>
                        </div>
                        
                        <!-- Proyectos del Usuario -->
                        <div style="background: #eff6ff; padding: 20px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                            <h3 style="margin: 0 0 16px 0; color: #1e293b; font-size: 18px;">üìÅ Proyectos del Usuario (${userProjects.length})</h3>
                            <button type="button" onclick="(async function(){ if (typeof window.nutriplantAdminLoadFromCloud === 'function') { await window.nutriplantAdminLoadFromCloud(); viewUserDetails('${userId}', ${tempNavigationContext.previousViewName ? tempNavigationContext.previousViewName : 'null'}, ${JSON.stringify(tempNavigationContext.previousViewParams || [])}); } })();" style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">üîÑ Refrescar desde nube</button>
            `;
            
            if (userProjects.length === 0) {
                var isUuidUser = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(userId);
                html += `
                    <div style="background: white; padding: 16px; border-radius: 6px; text-align: center; color: #64748b;">
                        <p style="margin: 0;">${isUuidUser ? 'No hay proyectos cargados para este usuario. Pulse <strong>Refrescar desde nube</strong> arriba (despu√©s de que el usuario haya abierto el dashboard para sincronizar).' : 'Este usuario a√∫n no tiene proyectos registrados.'}</p>
                    </div>
                `;
            } else {
                html += `
                    <div style="display: grid; gap: 12px;">
                `;
                
                userProjects.forEach((project, index) => {
                    // üìç OBTENER COORDENADAS DEL POL√çGONO: Del primer punto del pol√≠gono si existe
                    let locationText = 'No especificado';
                    if (project.location && typeof project.location === 'object') {
                        if (project.location.polygon && Array.isArray(project.location.polygon) && project.location.polygon.length > 0) {
                            const firstPoint = project.location.polygon[0];
                            if (Array.isArray(firstPoint) && firstPoint.length >= 2) {
                                // Formato: lat, lng (coordenadas del pol√≠gono)
                                locationText = `${firstPoint[0].toFixed(6)}, ${firstPoint[1].toFixed(6)}`;
                            }
                        }
                    }
                    
                    html += `
                        <div style="background: white; padding: 16px; border-radius: 6px; border: 1px solid #e5e7eb;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                <div style="flex: 1;">
                                    <h4 style="margin: 0 0 8px 0; color: #1e293b; font-size: 16px;">${escapeHtml(project.name || 'Sin nombre')}</h4>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 8px; font-size: 13px; color: #64748b;">
                                        <div><strong>Cultivo:</strong> ${escapeHtml(project.crop_type || 'N/A')}</div>
                                        <div><strong>Ubicaci√≥n:</strong> <span style="font-family: monospace; font-size: 12px;">${escapeHtml(locationText)}</span></div>
                                        <div><strong>Mensajes Chat:</strong> ${project.chat_messages || 0}</div>
                                        <div><strong>Creado:</strong> ${project.created_at ? new Date(project.created_at).toLocaleDateString('es-MX') : 'N/A'}</div>
                                        <div><strong>Actualizado:</strong> ${project.updated_at ? new Date(project.updated_at).toLocaleDateString('es-MX') : 'N/A'}</div>
                                    </div>
                                    ${project.sections && project.sections.length > 0 ? `
                                        <div style="margin-top: 8px; font-size: 12px; color: #64748b;">
                                            <strong>Secciones con datos:</strong> ${project.sections.join(', ')}
                                        </div>
                                    ` : ''}
                                </div>
                                <div style="display: flex; gap: 8px; margin-left: 16px;">
                                    <button onclick="viewProjectDetails('${project.id}', function() { viewUserDetails('${userId}', ${tempNavigationContext.previousViewName ? tempNavigationContext.previousViewName : 'null'}, ${JSON.stringify(tempNavigationContext.previousViewParams)}); }, []);" 
                                            style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500; white-space: nowrap;">
                                        üëÅÔ∏è Ver Detalles
                                    </button>
                                    <button onclick="editProject('${project.id}'); closeDataViewer();" 
                                            style="background: #60a5fa; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500; white-space: nowrap;">
                                        ‚úèÔ∏è Editar
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            }
            
            html += `</div>`;
            
            // Datos completos en JSON (colapsable)
            html += `
                        <details style="background: #f9fafb; padding: 20px; border-radius: 8px; border-left: 4px solid #9ca3af;">
                            <summary style="cursor: pointer; font-weight: 600; color: #1e293b; font-size: 16px; margin-bottom: 12px;">üìÑ Ver Datos Completos del Usuario (JSON)</summary>
                            <pre style="background: white; padding: 12px; border-radius: 6px; overflow-x: auto; font-size: 11px; max-height: 400px; overflow-y: auto;">${JSON.stringify(user, null, 2)}</pre>
                        </details>
                    </div>
                    
                    <div style="display: flex; gap: 12px; margin-top: 24px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                        <button onclick="closeDataViewer()" 
                                style="flex: 1; padding: 12px; background: #e5e7eb; color: #374151; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            Cerrar
                        </button>
                        <button onclick="editUser('${userId}'); closeDataViewer();" 
                                style="flex: 1; padding: 12px; background: #60a5fa; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            ‚úèÔ∏è Editar Usuario
                        </button>
                    </div>
                </div>
            `;
            
            const modal = document.getElementById('dataViewerModal');
            const content = document.getElementById('dataViewerContent');
            if (modal && content) {
                content.innerHTML = html;
                modal.style.display = 'flex';
            }
        }
        window.viewUserDetails = viewUserDetails;
        // Funci√≥n auxiliar para obtener datos del proyecto y mostrar el mapa
        function showMapModalForProject(projectId) {
            // Buscar primero con la misma l√≥gica robusta usada en detalles (nube + local)
            let projectData = null;
            try {
                const projectRecord = findProjectById(projectId);
                if (projectRecord && projectRecord.project) {
                    projectData = projectRecord.project;
                }
            } catch (e) {
                console.error('Error al resolver proyecto:', e);
            }

            if (!projectData) {
                alert('No se encontraron datos del proyecto');
                return;
            }

            // Soportar estructura local (top-level) y nube (project.data)
            const sourceProject = (projectData.data && typeof projectData.data === 'object')
                ? { ...projectData.data, id: projectData.id || projectData.data.id, title: projectData.title || projectData.data.title, name: projectData.name || projectData.data.name }
                : projectData;
            const locationData = sourceProject.location || sourceProject.sections?.ubicacion || sourceProject.sections?.location || null;
            if (!locationData) {
                alert('El proyecto no tiene datos de ubicaci√≥n');
                return;
            }
            
            showMapModal(projectId, locationData);
        }
        window.showMapModalForProject = showMapModalForProject;
        
        // Funci√≥n para mostrar el mapa con pol√≠gono (carga Leaflet din√°micamente)
        function showMapModal(projectId, locationData) {
            // Crear modal para el mapa
            let mapModal = document.getElementById('mapModal');
            if (!mapModal) {
                mapModal = document.createElement('div');
                mapModal.id = 'mapModal';
                mapModal.style.cssText = `
                    display: none;
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.7);
                    z-index: 10000;
                    justify-content: center;
                    align-items: center;
                `;
                document.body.appendChild(mapModal);
            }
            
            const polygon = locationData.polygon;
            const center = locationData.center || (polygon && polygon.length > 0 ? { lat: polygon[0][0], lng: polygon[0][1] } : { lat: 19.4326, lng: -99.1332 });
            
            mapModal.innerHTML = `
                <div style="background: white; border-radius: 12px; width: 90%; max-width: 900px; max-height: 85vh; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <div style="padding: 20px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; color: #1e293b; font-size: 20px;">üó∫Ô∏è Ubicaci√≥n del Proyecto</h2>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <button id="mapViewToggleBtn" onclick="toggleMapView()" 
                                    style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s; display: flex; align-items: center; gap: 6px;"
                                    onmouseover="this.style.background='#059669'; this.style.transform='translateY(-1px)';"
                                    onmouseout="this.style.background='#10b981'; this.style.transform='translateY(0)';"
                                    title="Cambiar vista del mapa">
                                <span id="mapViewIcon">üõ∞Ô∏è</span>
                                <span id="mapViewText">Vista Satelital</span>
                            </button>
                            <button onclick="closeMapModal()" style="background: none; border: none; font-size: 28px; color: #64748b; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 6px; transition: all 0.2s;"
                                    onmouseover="this.style.background='#fef2f2'; this.style.color='#ef4444';"
                                    onmouseout="this.style.background='none'; this.style.color='#64748b';"
                                    title="Cerrar">
                                √ó
                            </button>
                        </div>
                    </div>
                    <div id="mapContainer" style="flex: 1; min-height: 500px; border-radius: 0 0 12px 12px; position: relative;">
                        <div id="mapLoading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #64748b;">
                            <div style="font-size: 16px; margin-bottom: 12px;">Cargando mapa...</div>
                            <div style="width: 40px; height: 40px; border: 4px solid #e5e7eb; border-top-color: #10b981; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                        </div>
                    </div>
                </div>
                <style>
                    @keyframes spin {
                        to { transform: rotate(360deg); }
                    }
                </style>
            `;
            
            mapModal.style.display = 'flex';
            
            // Cargar Leaflet solo cuando se necesite
            if (!window.L) {
                // Cargar CSS de Leaflet
                const leafletCSS = document.createElement('link');
                leafletCSS.rel = 'stylesheet';
                leafletCSS.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
                leafletCSS.integrity = 'sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=';
                leafletCSS.crossOrigin = '';
                document.head.appendChild(leafletCSS);
                
                // Cargar JavaScript de Leaflet
                const leafletJS = document.createElement('script');
                leafletJS.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
                leafletJS.integrity = 'sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=';
                leafletJS.crossOrigin = '';
                leafletJS.onload = function() {
                    initializeMap(projectId, locationData, center, polygon);
                };
                document.head.appendChild(leafletJS);
            } else {
                // Si Leaflet ya est√° cargado, inicializar mapa inmediatamente
                setTimeout(() => initializeMap(projectId, locationData, center, polygon), 100);
            }
        }
        window.showMapModal = showMapModal;
        
        // Variables globales para el mapa y las capas
        let currentMap = null;
        let currentPolygonLayer = null;
        let currentMarker = null;
        let streetLayer = null;
        let satelliteLayer = null;
        let isSatelliteView = false;
        
        function initializeMap(projectId, locationData, center, polygon) {
            const mapContainer = document.getElementById('mapContainer');
            const mapLoading = document.getElementById('mapLoading');
            
            if (!mapContainer || !window.L) {
                console.error('Error: No se pudo inicializar el mapa');
                return;
            }
            
            // Eliminar mensaje de carga
            if (mapLoading) mapLoading.remove();
            
            // Limpiar contenedor
            mapContainer.innerHTML = '';
            
            // Crear mapa centrado
            currentMap = L.map(mapContainer, {
                zoomControl: true,
                attributionControl: true
            }).setView([center.lat, center.lng], 13);
            
            // Crear capas de tiles
            streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            });
            
            satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '¬© Esri, Maxar, GeoEye, Earthstar Geographics, CNES/Airbus DS, USDA, USGS, AeroGRID, IGN, IGP, and the GIS User Community',
                maxZoom: 19
            });
            
            // Agregar capa inicial (vista normal/calle)
            streetLayer.addTo(currentMap);
            isSatelliteView = false;
            updateMapViewButton();
            
            // Agregar pol√≠gono si existe
            if (polygon && Array.isArray(polygon) && polygon.length >= 3) {
                // Convertir coordenadas al formato [lat, lng] que Leaflet espera
                const latLngs = polygon.map(coord => {
                    // Asegurar que sea [lat, lng]
                    if (Array.isArray(coord) && coord.length >= 2) {
                        return [coord[0], coord[1]];
                    }
                    return null;
                }).filter(Boolean);
                
                if (latLngs.length >= 3) {
                    // Crear pol√≠gono con estilo
                    currentPolygonLayer = L.polygon(latLngs, {
                        color: '#10b981',
                        fillColor: '#10b981',
                        fillOpacity: 0.3,
                        weight: 3
                    }).addTo(currentMap);
                    
                    // Ajustar vista al pol√≠gono
                    currentMap.fitBounds(currentPolygonLayer.getBounds(), { padding: [50, 50] });
                    
                    // Agregar popup con informaci√≥n
                    const areaText = locationData.areaHectares ? `${locationData.areaHectares.toFixed(2)} ha` : 'N/A';
                    currentPolygonLayer.bindPopup(`
                        <div style="padding: 8px;">
                            <strong>Proyecto:</strong> ${locationData.projectName || projectId}<br>
                            <strong>√Årea:</strong> ${areaText}<br>
                            <strong>V√©rtices:</strong> ${polygon.length} puntos
                        </div>
                    `).openPopup();
                    
                    // Agregar marcador en el centro
                    if (center && center.lat && center.lng) {
                        currentMarker = L.marker([center.lat, center.lng], {
                            icon: L.icon({
                                iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
                                iconSize: [25, 41],
                                iconAnchor: [12, 41],
                                popupAnchor: [1, -34]
                            })
                        }).addTo(currentMap).bindPopup(`<strong>Centro del Pol√≠gono</strong><br>${center.lat.toFixed(6)}, ${center.lng.toFixed(6)}`);
                    }
                }
            } else {
                // Si no hay pol√≠gono, solo mostrar marcador en el centro
                if (center && center.lat && center.lng) {
                    currentMarker = L.marker([center.lat, center.lng], {
                        icon: L.icon({
                            iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41]
                        })
                    }).addTo(currentMap).bindPopup(`<strong>Ubicaci√≥n</strong><br>${center.lat.toFixed(6)}, ${center.lng.toFixed(6)}`);
                    currentMap.setView([center.lat, center.lng], 15);
                }
            }
        }
        
        // Funci√≥n para cambiar entre vista satelital y normal
        function toggleMapView() {
            if (!currentMap || !streetLayer || !satelliteLayer) {
                return;
            }
            
            // Cambiar entre vistas
            if (isSatelliteView) {
                // Cambiar a vista normal (calle)
                currentMap.removeLayer(satelliteLayer);
                streetLayer.addTo(currentMap);
                isSatelliteView = false;
            } else {
                // Cambiar a vista satelital
                currentMap.removeLayer(streetLayer);
                satelliteLayer.addTo(currentMap);
                isSatelliteView = true;
            }
            
            updateMapViewButton();
        }
        window.toggleMapView = toggleMapView;
        
        // Funci√≥n para actualizar el bot√≥n de cambio de vista
        function updateMapViewButton() {
            const btn = document.getElementById('mapViewToggleBtn');
            const icon = document.getElementById('mapViewIcon');
            const text = document.getElementById('mapViewText');
            
            if (btn && icon && text) {
                if (isSatelliteView) {
                    icon.textContent = 'üó∫Ô∏è';
                    text.textContent = 'Vista Normal';
                } else {
                    icon.textContent = 'üõ∞Ô∏è';
                    text.textContent = 'Vista Satelital';
                }
            }
        }
        
        function closeMapModal() {
            const mapModal = document.getElementById('mapModal');
            if (mapModal) {
                mapModal.style.display = 'none';
                // Limpiar mapa al cerrar para liberar recursos
                const mapContainer = document.getElementById('mapContainer');
                if (mapContainer && window.L && currentMap) {
                    // Eliminar todas las capas y el mapa
                    if (streetLayer) currentMap.removeLayer(streetLayer);
                    if (satelliteLayer) currentMap.removeLayer(satelliteLayer);
                    if (currentPolygonLayer) currentMap.removeLayer(currentPolygonLayer);
                    if (currentMarker) currentMap.removeLayer(currentMarker);
                    currentMap.remove();
                    mapContainer.innerHTML = '';
                    // Resetear variables
                    currentMap = null;
                    currentPolygonLayer = null;
                    currentMarker = null;
                    streetLayer = null;
                    satelliteLayer = null;
                    isSatelliteView = false;
                }
            }
        }
        window.closeMapModal = closeMapModal;
        
        // ========== MAPA GLOBAL: todos los pol√≠gonos de todos los usuarios ==========
        let globalMapInstance = null;
        let globalMapStreetLayer = null;
        let globalMapSatelliteLayer = null;
        let globalMapPolygonLayers = [];
        let globalMapMarkerCluster = null;
        let globalMapSatelliteView = false;
        
        function showGlobalMap() {
            // En admin preferimos fuente nube para consistencia entre dispositivos.
            // Si no hay cache nube disponible, usamos fallback local.
            const cloudProjects = (window._adminCloudCache && Array.isArray(window._adminCloudCache.projects))
                ? window._adminCloudCache.projects
                : [];
            const projects = cloudProjects.length ? cloudProjects.slice() : getAllProjects();
            const normalizeObject = (value) => {
                if (!value) return null;
                if (typeof value === 'string') {
                    try { return JSON.parse(value); } catch (e) { return null; }
                }
                return typeof value === 'object' ? value : null;
            };
            const normalizePolygon = (polygonRaw) => {
                let polygon = polygonRaw;
                if (typeof polygon === 'string') {
                    try { polygon = JSON.parse(polygon); } catch (e) { return []; }
                }
                if (!Array.isArray(polygon)) return [];
                return polygon.map(coord => {
                    if (Array.isArray(coord) && coord.length >= 2) {
                        const lat = Number(coord[0]);
                        const lng = Number(coord[1]);
                        return (Number.isFinite(lat) && Number.isFinite(lng)) ? [lat, lng] : null;
                    }
                    if (coord && typeof coord === 'object') {
                        const lat = Number(coord.lat ?? coord.latitude);
                        const lng = Number(coord.lng ?? coord.lon ?? coord.longitude);
                        return (Number.isFinite(lat) && Number.isFinite(lng)) ? [lat, lng] : null;
                    }
                    return null;
                }).filter(Boolean);
            };
            const resolveLocation = (projectSummary) => {
                let loc = normalizeObject(
                    projectSummary.location ||
                    projectSummary.data?.location ||
                    projectSummary.sections?.ubicacion ||
                    projectSummary.sections?.location ||
                    projectSummary.data?.sections?.ubicacion ||
                    projectSummary.data?.sections?.location ||
                    null
                );
                // getAllProjects() devuelve resumen; para mapa global necesitamos leer el proyecto completo
                if ((!loc || !loc.polygon) && projectSummary.id) {
                    try {
                        const raw = localStorage.getItem(`nutriplant_project_${projectSummary.id}`);
                        if (raw) {
                            const fullProject = JSON.parse(raw);
                            const fullLocation = normalizeObject(fullProject?.location || fullProject?.sections?.ubicacion || fullProject?.sections?.location || null);
                            if (fullLocation) loc = fullLocation;
                            if (fullProject && typeof fullProject === 'object') projectSummary._fullProjectForMap = fullProject;
                        }
                    } catch (e) {
                        console.warn('‚ö†Ô∏è No se pudo resolver ubicaci√≥n completa para mapa global:', projectSummary.id, e);
                    }
                }
                return loc || {};
            };
            const withPolygon = projects.map(project => {
                const loc = resolveLocation(project);
                const latLngs = normalizePolygon(loc.polygon);
                return { project, loc, latLngs };
            }).filter(item => item.latLngs.length >= 3);
            
            let globalMapModal = document.getElementById('globalMapModal');
            if (!globalMapModal) {
                globalMapModal = document.createElement('div');
                globalMapModal.id = 'globalMapModal';
                globalMapModal.style.cssText = 'display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.75); z-index:10000; justify-content:center; align-items:center;';
                globalMapModal.addEventListener('click', function(e) {
                    const btn = e.target.closest('.global-map-open-project');
                    if (btn) {
                        const id = btn.getAttribute('data-project-id');
                        if (id) {
                            closeGlobalMapModal();
                            viewProjectDetails(id, 'showAllProjects', []);
                        }
                    }
                });
                document.body.appendChild(globalMapModal);
            }
            
            const count = withPolygon.length;
            globalMapModal.innerHTML = `
                <div style="background: white; border-radius: 12px; width: 95%; height: 92vh; max-width: 1400px; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <div style="padding: 16px 20px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                        <div>
                            <h2 style="margin: 0; color: #1e293b; font-size: 20px;">üó∫Ô∏è Mapa global</h2>
                            <p style="margin: 4px 0 0 0; color: #64748b; font-size: 14px;">${count} proyecto(s) con ubicaci√≥n. Desde lejos ver√°s banderitas/agrupaciones; al acercar, pol√≠gonos. Clic en uno para ver resumen.</p>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <button id="globalMapViewToggleBtn" onclick="toggleGlobalMapView()" style="background: #10b981; color: white; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">
                                <span id="globalMapViewIcon">üõ∞Ô∏è</span> <span id="globalMapViewText">Vista Satelital</span>
                            </button>
                            <button onclick="closeGlobalMapModal()" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;" title="Cerrar">‚úï Cerrar</button>
                        </div>
                    </div>
                    <div id="globalMapContainer" style="flex: 1; min-height: 400px; border-radius: 0 0 12px 12px; position: relative;">
                        <div id="globalMapLoading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #64748b;">
                            <div style="font-size: 16px; margin-bottom: 12px;">Cargando mapa...</div>
                            <div style="width: 40px; height: 40px; border: 4px solid #e5e7eb; border-top-color: #10b981; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                        </div>
                    </div>
                </div>
                <style id="globalMapClusterStyles">
                    /* Dise√±o PRO: globo con n√∫mero bien visible sobre el mapa */
                    #globalMapContainer .marker-cluster {
                        background: linear-gradient(145deg, #ffffff 0%, #f1f5f9 100%) !important;
                        border: 2px solid #0ea5e9 !important;
                        border-radius: 50% !important;
                        box-shadow: 0 4px 14px rgba(0,0,0,0.2), 0 2px 6px rgba(14,165,233,0.25), inset 0 1px 0 rgba(255,255,255,0.9) !important;
                        opacity: 1 !important;
                    }
                    #globalMapContainer .marker-cluster div {
                        background: transparent !important;
                        color: #0f172a !important;
                        font-weight: 800 !important;
                        font-size: 15px !important;
                        line-height: 1 !important;
                        text-align: center !important;
                        text-shadow: 0 1px 0 rgba(255,255,255,0.8), 0 1px 2px rgba(0,0,0,0.15) !important;
                        letter-spacing: -0.02em !important;
                        margin: 0 !important;
                        width: 100% !important;
                        height: 100% !important;
                        display: flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                        border: none !important;
                        border-radius: 50% !important;
                    }
                    #globalMapContainer .marker-cluster-small,
                    #globalMapContainer .marker-cluster-medium,
                    #globalMapContainer .marker-cluster-large {
                        background: linear-gradient(145deg, #ffffff 0%, #f1f5f9 100%) !important;
                        border: 2px solid #0ea5e9 !important;
                        border-radius: 50% !important;
                        box-shadow: 0 4px 14px rgba(0,0,0,0.2), 0 2px 6px rgba(14,165,233,0.25), inset 0 1px 0 rgba(255,255,255,0.9) !important;
                    }
                    #globalMapContainer .marker-cluster-small div,
                    #globalMapContainer .marker-cluster-medium div,
                    #globalMapContainer .marker-cluster-large div {
                        background: transparent !important;
                        color: #0f172a !important;
                        font-weight: 800 !important;
                        text-shadow: 0 1px 0 rgba(255,255,255,0.8), 0 1px 2px rgba(0,0,0,0.15) !important;
                    }
                </style>
            `;
            globalMapModal.style.display = 'flex';
            
            function initGlobalMap() {
                const container = document.getElementById('globalMapContainer');
                const loading = document.getElementById('globalMapLoading');
                if (!container || !window.L) return;
                if (loading) loading.remove();
                container.innerHTML = '';
                
                const center = [19.4326, -99.1332];
                let zoom = 3;
                globalMapInstance = L.map(container, { zoomControl: true, attributionControl: true }).setView(center, zoom);
                
                globalMapStreetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap',
                    maxZoom: 19
                });
                globalMapSatelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: '¬© Esri',
                    maxZoom: 19
                });
                globalMapStreetLayer.addTo(globalMapInstance);
                globalMapSatelliteView = false;
                updateGlobalMapViewButton();
                
                const allBounds = [];
                globalMapPolygonLayers = [];
                
                // Centroid de un pol√≠gono [ [lat,lng], ... ]
                function polygonCentroid(latLngs) {
                    if (!latLngs || latLngs.length === 0) return null;
                    let lat = 0, lng = 0, n = latLngs.length;
                    for (let i = 0; i < n; i++) {
                        lat += latLngs[i][0];
                        lng += latLngs[i][1];
                    }
                    return [lat / n, lng / n];
                }
                
                const defaultIcon = L.icon({
                    iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
                    iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
                    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                });
                
                const markerClusterGroup = window.L.markerClusterGroup ? new L.markerClusterGroup({
                    maxClusterRadius: 50,
                    spiderfyOnMaxZoom: true,
                    showCoverageOnHover: false
                }) : null;
                
                withPolygon.forEach(({ project, loc, latLngs }) => {
                    const layer = L.polygon(latLngs, {
                        color: '#0ea5e9',
                        fillColor: '#0ea5e9',
                        fillOpacity: 0.25,
                        weight: 2
                    });
                    layer.getBounds && allBounds.push(layer.getBounds());
                    
                    const fullProject = project._fullProjectForMap || {};
                    const userName = project.user_name || fullProject.user_name || fullProject.userName || project.userName || fullProject.user_email || fullProject.userEmail || project.user_email || project.userEmail || 'Sin usuario';
                    const projectName = (project.title || project.name || project.nombre || fullProject.title || fullProject.name || 'Sin nombre');
                    const crop = project.crop_type || project.cultivo || fullProject.crop_type || fullProject.cultivo || 'N/A';
                    const variety = project.variedad || project.variety || fullProject.variedad || fullProject.variety || '';
                    const areaNum = Number(loc.areaHectares ?? loc.area ?? NaN);
                    const areaText = Number.isFinite(areaNum) ? `${areaNum.toFixed(2)} ha` : 'N/A';
                    const projectId = project.id || fullProject.id || '';
                    
                    const popupHtml = `
                        <div style="min-width: 220px; padding: 4px;">
                            <strong style="color: #1e293b;">üë§ Usuario:</strong> ${escapeHtml(String(userName))}<br>
                            <strong style="color: #1e293b;">üìã Proyecto:</strong> ${escapeHtml(projectName)}<br>
                            <strong style="color: #1e293b;">üå± Cultivo:</strong> ${escapeHtml(String(crop))}${variety ? ' / ' + escapeHtml(String(variety)) : ''}<br>
                            <strong style="color: #1e293b;">üìê √Årea:</strong> ${escapeHtml(areaText)}<br>
                            <strong style="color: #1e293b;">üÜî ID:</strong> <code style="font-size: 11px;">${escapeHtml(projectId)}</code><br>
                            <button type="button" class="global-map-open-project" data-project-id="${escapeHtml(projectId).replace(/"/g, '&quot;')}" style="margin-top: 8px; background: #10b981; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">Ver detalle del proyecto</button>
                        </div>
                    `;
                    layer.bindPopup(popupHtml);
                    layer.addTo(globalMapInstance);
                    globalMapPolygonLayers.push(layer);
                    
                    const center = polygonCentroid(latLngs);
                    if (center) {
                        const marker = L.marker(center, { icon: defaultIcon }).bindPopup(popupHtml);
                        if (markerClusterGroup) {
                            markerClusterGroup.addLayer(marker);
                        } else {
                            marker.addTo(globalMapInstance);
                        }
                    }
                });
                
                if (markerClusterGroup && markerClusterGroup.getLayers().length > 0) {
                    globalMapInstance.addLayer(markerClusterGroup);
                    globalMapMarkerCluster = markerClusterGroup;
                }
                
                if (allBounds.length > 0) {
                    try {
                        const bounds = allBounds[0].clone();
                        for (let i = 1; i < allBounds.length; i++) bounds.extend(allBounds[i]);
                        globalMapInstance.fitBounds(bounds, { padding: [40, 40], maxZoom: 15 });
                    } catch (e) {
                        console.warn('fitBounds global map:', e);
                    }
                }
            }
            
            function loadMarkerClusterThenInit() {
                if (window.L && window.L.markerClusterGroup) {
                    setTimeout(initGlobalMap, 100);
                    return;
                }
                if (!window.L) return;
                const mccss = document.createElement('link');
                mccss.rel = 'stylesheet';
                mccss.href = 'https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css';
                document.head.appendChild(mccss);
                const mcjs = document.createElement('script');
                mcjs.src = 'https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js';
                mcjs.onload = () => setTimeout(initGlobalMap, 100);
                document.head.appendChild(mcjs);
            }
            if (!window.L) {
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
                document.head.appendChild(link);
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
                script.onload = loadMarkerClusterThenInit;
                document.head.appendChild(script);
            } else {
                loadMarkerClusterThenInit();
            }
        }
        window.showGlobalMap = showGlobalMap;
        
        function toggleGlobalMapView() {
            if (!globalMapInstance || !globalMapStreetLayer || !globalMapSatelliteLayer) return;
            if (globalMapSatelliteView) {
                globalMapInstance.removeLayer(globalMapSatelliteLayer);
                globalMapStreetLayer.addTo(globalMapInstance);
                globalMapSatelliteView = false;
            } else {
                globalMapInstance.removeLayer(globalMapStreetLayer);
                globalMapSatelliteLayer.addTo(globalMapInstance);
                globalMapSatelliteView = true;
            }
            updateGlobalMapViewButton();
        }
        window.toggleGlobalMapView = toggleGlobalMapView;
        
        function updateGlobalMapViewButton() {
            const icon = document.getElementById('globalMapViewIcon');
            const text = document.getElementById('globalMapViewText');
            if (icon && text) {
                if (globalMapSatelliteView) {
                    icon.textContent = 'üó∫Ô∏è';
                    text.textContent = 'Vista Normal';
                } else {
                    icon.textContent = 'üõ∞Ô∏è';
                    text.textContent = 'Vista Satelital';
                }
            }
        }
        
        function closeGlobalMapModal() {
            const modal = document.getElementById('globalMapModal');
            if (modal) modal.style.display = 'none';
            if (globalMapInstance) {
                if (globalMapMarkerCluster) {
                    try { globalMapInstance.removeLayer(globalMapMarkerCluster); } catch (e) {}
                    globalMapMarkerCluster = null;
                }
                if (globalMapPolygonLayers.length) {
                    globalMapPolygonLayers.forEach(l => { try { globalMapInstance.removeLayer(l); } catch (e) {} });
                    globalMapPolygonLayers = [];
                }
                if (globalMapStreetLayer) try { globalMapInstance.removeLayer(globalMapStreetLayer); } catch (e) {}
                if (globalMapSatelliteLayer) try { globalMapInstance.removeLayer(globalMapSatelliteLayer); } catch (e) {}
                globalMapInstance.remove();
                const container = document.getElementById('globalMapContainer');
                if (container) container.innerHTML = '';
                globalMapInstance = null;
                globalMapStreetLayer = null;
                globalMapSatelliteLayer = null;
            }
        }
        window.closeGlobalMapModal = closeGlobalMapModal;

        // ========== MAPA DE CONEXIONES: ubicaciones desde donde entran al panel (por IP) ==========
        let connMapInstance = null;
        let connMapStreetLayer = null;
        let connMapSatelliteLayer = null;
        let connMapMarkerCluster = null;
        let connMapSatelliteView = false;

        function showConnectionsMap() {
            var visits = (window._adminCloudCache && Array.isArray(window._adminCloudCache.dashboardVisits)) ? window._adminCloudCache.dashboardVisits : [];
            var users = getAllUsers();
            var byId = {};
            users.forEach(function(u) { byId[u.id || u.userId] = u; });
            var withCoords = visits.filter(function(v) {
                var lat = v && (v.lat != null) ? parseFloat(v.lat) : NaN;
                var lng = v && (v.lng != null) ? parseFloat(v.lng) : NaN;
                return Number.isFinite(lat) && Number.isFinite(lng) && lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180;
            });
            withCoords.sort(function(a, b) {
                var ta = (a.visited_at ? new Date(a.visited_at).getTime() : 0);
                var tb = (b.visited_at ? new Date(b.visited_at).getTime() : 0);
                return tb - ta;
            });
            var count = withCoords.length;
            var modal = document.getElementById('connMapModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'connMapModal';
                modal.style.cssText = 'display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.75); z-index:10000; justify-content:center; align-items:center;';
                document.body.appendChild(modal);
            }
            modal.innerHTML = '<div style="background: white; border-radius: 12px; width: 95%; height: 92vh; max-width: 1400px; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">' +
                '<div style="padding: 16px 20px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">' +
                '<div><h2 style="margin: 0; color: #1e293b; font-size: 20px;">üó∫Ô∏è Mapa de conexiones</h2>' +
                '<p style="margin: 4px 0 0 0; color: #64748b; font-size: 14px;">' + count + ' conexi√≥n(es) con ubicaci√≥n aproximada (por IP). Desde lejos ver√°s agrupaciones; al acercar, detalle. Clic en un punto para ver resumen.</p></div>' +
                '<div style="display: flex; align-items: center; gap: 10px;">' +
                '<button id="connMapViewToggleBtn" onclick="toggleConnectionsMapView()" style="background: #10b981; color: white; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;"><span id="connMapViewIcon">üõ∞Ô∏è</span> <span id="connMapViewText">Vista Satelital</span></button>' +
                '<button onclick="closeConnectionsMapModal()" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;" title="Cerrar">‚úï Cerrar</button></div></div>' +
                '<div id="connMapContainer" style="flex: 1; min-height: 400px; border-radius: 0 0 12px 12px; position: relative;">' +
                '<div id="connMapLoading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #64748b;">Cargando mapa...</div></div></div>' +
                '<style>#connMapContainer .marker-cluster{background:linear-gradient(145deg,#fff 0%,#f1f5f9 100%)!important;border:2px solid #f59e0b!important;border-radius:50%!important;box-shadow:0 4px 14px rgba(0,0,0,0.2)!important;}#connMapContainer .marker-cluster div{background:transparent!important;color:#0f172a!important;font-weight:800!important;font-size:15px!important;}</style>';
            modal.style.display = 'flex';
            if (count === 0) {
                var loadEl = document.getElementById('connMapLoading');
                if (loadEl) loadEl.remove();
                var c = document.getElementById('connMapContainer');
                if (c) c.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#64748b;font-size:16px;">No hay conexiones con ubicaci√≥n registrada a√∫n. Las nuevas entradas al panel guardar√°n lat/lng aproximado por IP.</div>';
                return;
            }

            function initConnMap() {
                var container = document.getElementById('connMapContainer');
                var loading = document.getElementById('connMapLoading');
                if (!container) return;
                if (loading) loading.remove();
                container.innerHTML = '';
                if (!window.L) return;
                var center = [19.4326, -99.1332];
                var zoom = 3;
                connMapInstance = L.map(container, { zoomControl: true, attributionControl: true }).setView(center, zoom);
                connMapStreetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap', maxZoom: 19 });
                connMapSatelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '¬© Esri', maxZoom: 19 });
                connMapStreetLayer.addTo(connMapInstance);
                connMapSatelliteView = false;
                updateConnMapViewButton();
                var allBounds = [];
                var defaultIcon = L.icon({
                    iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
                    iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
                    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                    iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
                });
                var clusterGroup = window.L.markerClusterGroup ? new L.markerClusterGroup({ maxClusterRadius: 50, spiderfyOnMaxZoom: true, showCoverageOnHover: false }) : null;
                var rounded = {};
                withCoords.forEach(function(v) {
                    var lat = parseFloat(v.lat);
                    var lng = parseFloat(v.lng);
                    var key = lat.toFixed(2) + '|' + lng.toFixed(2);
                    if (!rounded[key]) rounded[key] = { lat: lat, lng: lng, visits: [] };
                    rounded[key].visits.push(v);
                });
                Object.keys(rounded).forEach(function(key) {
                    var g = rounded[key];
                    var lat = g.lat, lng = g.lng;
                    var list = g.visits.slice(0, 15);
                    var userLabels = [];
                    var seen = {};
                    list.forEach(function(v) {
                        var uid = v.user_id;
                        if (seen[uid]) return;
                        seen[uid] = true;
                        var u = byId[uid];
                        var name = (u && (u.name || u.full_name || u.fullName)) ? String(u.name || u.full_name || u.fullName).trim() : '';
                        var email = (u && u.email) ? u.email : (uid || '‚Äî');
                        var label = name ? (name + ' ¬∑ ' + email) : email;
                        userLabels.push(label);
                    });
                    var lastDate = list.length && list[0].visited_at ? new Date(list[0].visited_at).toLocaleString('es-MX') : '‚Äî';
                    var usersLine = (userLabels.slice(0, 5).join(', ') || '‚Äî') + (userLabels.length > 5 ? ' y m√°s' : '');
                    var popupHtml = '<div style="min-width:200px;padding:6px;"><strong>Conexiones desde aqu√≠:</strong> ' + g.visits.length + '<br><strong>Usuarios:</strong> ' + usersLine + '<br><strong>√öltima:</strong> ' + lastDate + '</div>';
                    var marker = L.marker([lat, lng], { icon: defaultIcon }).bindPopup(popupHtml);
                    allBounds.push([lat, lng]);
                    if (clusterGroup) clusterGroup.addLayer(marker); else marker.addTo(connMapInstance);
                });
                if (clusterGroup && clusterGroup.getLayers().length > 0) {
                    connMapInstance.addLayer(clusterGroup);
                    connMapMarkerCluster = clusterGroup;
                }
                if (allBounds.length > 0) {
                    try {
                        var b = L.latLngBounds(allBounds);
                        connMapInstance.fitBounds(b, { padding: [40, 40], maxZoom: 15 });
                    } catch (e) {}
                }
            }
            function loadLeafletThenConnMap() {
                if (window.L && window.L.markerClusterGroup) { setTimeout(initConnMap, 100); return; }
                if (!window.L) return;
                var mccss = document.createElement('link');
                mccss.rel = 'stylesheet';
                mccss.href = 'https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css';
                document.head.appendChild(mccss);
                var mcjs = document.createElement('script');
                mcjs.src = 'https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js';
                mcjs.onload = function() { setTimeout(initConnMap, 100); };
                document.head.appendChild(mcjs);
            }
            if (!window.L) {
                var link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
                document.head.appendChild(link);
                var script = document.createElement('script');
                script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
                script.onload = loadLeafletThenConnMap;
                document.head.appendChild(script);
            } else {
                loadLeafletThenConnMap();
            }
        }
        window.showConnectionsMap = showConnectionsMap;

        function toggleConnectionsMapView() {
            if (!connMapInstance || !connMapStreetLayer || !connMapSatelliteLayer) return;
            if (connMapSatelliteView) {
                connMapInstance.removeLayer(connMapSatelliteLayer);
                connMapStreetLayer.addTo(connMapInstance);
                connMapSatelliteView = false;
            } else {
                connMapInstance.removeLayer(connMapStreetLayer);
                connMapSatelliteLayer.addTo(connMapInstance);
                connMapSatelliteView = true;
            }
            updateConnMapViewButton();
        }
        window.toggleConnectionsMapView = toggleConnectionsMapView;

        function updateConnMapViewButton() {
            var icon = document.getElementById('connMapViewIcon');
            var text = document.getElementById('connMapViewText');
            if (icon && text) {
                icon.textContent = connMapSatelliteView ? 'üó∫Ô∏è' : 'üõ∞Ô∏è';
                text.textContent = connMapSatelliteView ? 'Vista Normal' : 'Vista Satelital';
            }
        }

        function closeConnectionsMapModal() {
            var modal = document.getElementById('connMapModal');
            if (modal) modal.style.display = 'none';
            if (connMapInstance) {
                if (connMapMarkerCluster) { try { connMapInstance.removeLayer(connMapMarkerCluster); } catch (e) {} }
                connMapMarkerCluster = null;
                if (connMapStreetLayer) try { connMapInstance.removeLayer(connMapStreetLayer); } catch (e) {};
                if (connMapSatelliteLayer) try { connMapInstance.removeLayer(connMapSatelliteLayer); } catch (e) {};
                connMapInstance.remove();
                var container = document.getElementById('connMapContainer');
                if (container) container.innerHTML = '';
                connMapInstance = null;
                connMapStreetLayer = null;
                connMapSatelliteLayer = null;
            }
        }
        window.closeConnectionsMapModal = closeConnectionsMapModal;
        
    </script>
    <script src="../apply-no-traducir.js"></script>
</body>
</html>
