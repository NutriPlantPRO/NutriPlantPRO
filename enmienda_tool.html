<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora de Enmiendas</title>
  <style>
/* ===== ENMIENDA SECTION STYLING ===== */
.enmienda-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

.enmienda-header {
  margin-bottom: 30px;
  text-align: center;
}

.enmienda-header h2 {
  color: #1f2937;
  margin-bottom: 1rem;
  font-size: 1.75rem;
  line-height: 1.4;
  font-weight: 700;
}

.enmienda-content {
  display: flex;
  flex-direction: column;
  gap: 15px; /* Reducido de 25px a 15px */
}



  </style>
</head>
<body>

      <div class="enmienda-container">
        <div class="enmienda-header">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 class="text-2xl font-bold text-gray-800 mb-0">üöú Calculadora de Enmiendas (ajuste de CIC del suelo)</h2>
          </div>
          <div class="ideal-ranges">
            <h3>üìä Rangos Ideales de Cationes:</h3>
            <div class="ranges-grid">
              <div class="range-item good">K‚Å∫: 3-7%</div>
              <div class="range-item good">Ca¬≤‚Å∫: 65-75%</div>
              <div class="range-item good">Mg¬≤‚Å∫: 10-15%</div>
              <div class="range-item warning">H‚Å∫: 0-10%</div>
              <div class="range-item warning">Na‚Å∫: 0-1%</div>
              <div class="range-item warning">Al¬≥‚Å∫: 0-1%</div>
            </div>
          </div>
        </div>

        <div class="enmienda-content">
          <!-- An√°lisis de Suelo Inicial -->
          <div class="ideal-ranges">
            <h3>üìä An√°lisis de Suelo Inicial (meq/100g de suelo)</h3>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <div></div>
              <div class="total-display">
                <label>CIC Total:</label>
                <input type="number" id="cic-total" step="0.01" value="0.00" class="total-input" readonly>
              </div>
            </div>
            <div class="analysis-grid">
              <div class="analysis-item cation-good">
                <label>K‚Å∫:</label>
                <input type="number" id="k-initial" step="0.01" value="0.00" class="analysis-input">
                <div class="percent-display" id="k-percent">0.0%</div>
                <div class="status-icon" id="k-status">-</div>
              </div>
              <div class="analysis-item cation-good">
                <label>Ca¬≤‚Å∫:</label>
                <input type="number" id="ca-initial" step="0.01" value="0.00" class="analysis-input">
                <div class="percent-display" id="ca-percent">0.0%</div>
                <div class="status-icon" id="ca-status">-</div>
              </div>
              <div class="analysis-item cation-good">
                <label>Mg¬≤‚Å∫:</label>
                <input type="number" id="mg-initial" step="0.01" value="0.00" class="analysis-input">
                <div class="percent-display" id="mg-percent">0.0%</div>
                <div class="status-icon" id="mg-status">-</div>
              </div>
              <div class="analysis-item cation-acid">
                <label>H‚Å∫:</label>
                <input type="number" id="h-initial" step="0.01" value="0.00" class="analysis-input">
                <div class="percent-display" id="h-percent">0.0%</div>
                <div class="status-icon" id="h-status">-</div>
              </div>
              <div class="analysis-item cation-salt">
                <label>Na‚Å∫:</label>
                <input type="number" id="na-initial" step="0.01" value="0.00" class="analysis-input">
                <div class="percent-display" id="na-percent">0.0%</div>
                <div class="status-icon" id="na-status">-</div>
              </div>
              <div class="analysis-item cation-toxic">
                <label>Al¬≥‚Å∫:</label>
                <input type="number" id="al-initial" step="0.01" value="0.00" class="analysis-input">
                <div class="percent-display" id="al-percent">0.0%</div>
                <div class="status-icon" id="al-status">-</div>
              </div>
            </div>
          </div>

          <!-- Propiedades del Suelo -->
          <div class="ideal-ranges">
            <h3>üå± Propiedades del Suelo</h3>
            <div class="properties-grid">
              <div class="property-item">
                <label>Densidad aparente (g/cm¬≥):</label>
                <input type="number" id="soil-density" step="0.01" value="1.1" class="property-input">
              </div>
              <div class="property-item">
                <label>Profundidad (cm):</label>
                <input type="number" id="soil-depth" step="1" value="30" class="property-input">
              </div>
              <div class="property-item">
                <label>pH del suelo:</label>
                <div class="ph-input-container">
                  <input type="number" id="soil-ph" step="0.1" placeholder="Ingrese pH" min="4.0" max="9.0" class="property-input" title="pH del suelo (4.0 - 9.0)" onchange="updatePHIndicator()">
                  <div id="ph-indicator" class="ph-indicator">‚ö™ Ingrese pH</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Objetivos de Ajuste -->
          <div class="ideal-ranges target-section">
            <h3>üéØ Meq/100g a ajustar en CIC</h3>
            <div class="target-grid">
              <div class="target-item cation-good">
                <label>K‚Å∫ (meq a ajustar):</label>
                <input type="number" id="k-target" step="0.01" value="0.00" class="target-input">
              </div>
              <div class="target-item cation-good">
                <label>Ca¬≤‚Å∫ (meq a ajustar):</label>
                <input type="number" id="ca-target" step="0.01" value="0.00" class="target-input">
              </div>
              <div class="target-item cation-good">
                <label>Mg¬≤‚Å∫ (meq a ajustar):</label>
                <input type="number" id="mg-target" step="0.01" value="0.00" class="target-input">
              </div>
              <div class="target-item cation-acid">
                <label>H‚Å∫ (meq a ajustar):</label>
                <input type="number" id="h-target" step="0.01" value="0.00" class="target-input">
              </div>
              <div class="target-item cation-salt">
                <label>Na‚Å∫ (meq a ajustar):</label>
                <input type="number" id="na-target" step="0.01" value="0.00" class="target-input">
              </div>
              <div class="target-item cation-toxic">
                <label>Al¬≥‚Å∫ (meq a ajustar):</label>
                <input type="number" id="al-target" step="0.01" value="0.00" class="target-input">
              </div>
            </div>
          </div>

          <!-- Enmiendas Disponibles -->
          <div class="amendments-section">
            <h3 class="section-title">üß™ Enmiendas Disponibles</h3>
            <div class="amendments-table-container">
              <table class="amendments-table">
    <thead>
      <tr>
        <th>Enmienda</th>
        <th>F√≥rmula</th>
        <th>Peso Molecular</th>
        <th>%K</th>
        <th>%Ca</th>
        <th>%Mg</th>
        <th>%SO‚ÇÑ</th>
        <th>%CO‚ÇÉ</th>
        <th>%H‚ÇÇO</th>
        <th>%Si</th>
        <th>Acciones</th>
      </tr>
    </thead>
                <tbody id="amendments-table-body">
                  <!-- Enmiendas se cargar√°n din√°micamente -->
                </tbody>
              </table>
            </div>
            
          </div>

          <!-- Bot√≥n de C√°lculo -->
          <div class="calculation-actions">
            <div class="soil-reach-card">
              <label for="soil-reach-percent">Suelo explorado por ra√≠ces (%)</label>
              <div class="soil-reach-input">
                <input type="number" id="soil-reach-percent" min="10" max="100" step="1" value="100">
                <span>%</span>
              </div>
            </div>
            <button id="calculate-amendment" class="btn-calculate" onclick="calculateAmendment()">üßÆ Calcular Enmienda</button>
            <button id="reset-amendment" class="btn-reset" onclick="resetAmendmentForm()">üîÑ Reiniciar</button>
          </div>

          <!-- Resultados -->
          <div id="amendment-results" class="results-section" style="display: none;">
            <h3 class="section-title">üìã Resultados del C√°lculo</h3>
            <div class="results-grid">
              <div class="result-item">
                <label>Enmienda recomendada:</label>
                <span id="amendment-type" class="result-value">-</span>
              </div>
              <div class="result-item">
                <label>Cantidad (Kg/Ha):</label>
                <span id="amendment-amount" class="result-value">-</span>
              </div>
              <div class="result-item">
                <label>Ca a aportar (Kg/Ha):</label>
                <span id="ca-contribution" class="result-value">-</span>
              </div>
              <div class="result-item">
                <label>Na a remover (Kg/Ha):</label>
                <span id="na-removal" class="result-value">-</span>
              </div>
            </div>
            
            <!-- Botones de Acci√≥n -->
            <div class="report-actions" style="margin-top: 20px; text-align: center;">
              <button id="saveAmendmentDataBtn" class="btn btn-secondary" onclick="saveProject()" style="margin-right: 10px;">
                üíæ Guardar Datos
              </button>
              <button id="showProjectCardBtn" class="btn btn-secondary" onclick="showProjectCard()" style="margin-right: 10px;">
                üÉè Ver Tarjeta
              </button>
              <button id="generateReportBtn" class="btn btn-primary btn-lg" onclick="openReportModal()">
                üìÑ Generar Reporte PDF
              </button>
            </div>
          </div>

        </div>
      </div>
    

<script>
function formatNumber(number, decimals = 2) {
  if (isNaN(number) || number === null || number === undefined) {
    return '0.00';
  }
  
  const num = parseFloat(number);
  return num.toLocaleString('en-US', {
    minimumFractionDigits: decimals,
    maximumFractionDigits: decimals
  });
}

function updatePHIndicator() {
  const phInput = document.getElementById('soil-ph');
  const phIndicator = document.getElementById('ph-indicator');
  
  if (!phInput || !phIndicator) return;
  
  const ph = parseFloat(phInput.value);
  
  if (isNaN(ph) || phInput.value === '') {
    phIndicator.innerHTML = '‚ö™ Ingrese pH';
    phIndicator.className = 'ph-indicator ph-empty';
  } else if (ph < 5.5) {
    phIndicator.innerHTML = 'üî¥ √Åcido';
    phIndicator.className = 'ph-indicator ph-acid';
  } else if (ph < 6.0) {
    phIndicator.innerHTML = 'üü° Ligeramente √°cido';
    phIndicator.className = 'ph-indicator ph-slightly-acid';
  } else if (ph >= 6.0 && ph <= 7.5) {
    phIndicator.innerHTML = 'üü¢ Neutro';
    phIndicator.className = 'ph-indicator ph-neutral';
  } else if (ph > 7.5) {
    phIndicator.innerHTML = 'üîµ Alcalino';
    phIndicator.className = 'ph-indicator ph-alkaline';
  }
}

function normalizeSoilReachPercent(inputEl, { mutate = true }

function getSoilReachPercent({ mutate = true }

function updateSoilReachAdjustment({ mutate = true }

function initializeEnmiendaCalculator() {
  console.log('üîß Inicializando calculadora de enmiendas...');
  console.log('üîç Buscando botones en el DOM...');
  const calculateBtn = document.getElementById('calculate-amendment');
  const resetBtn = document.getElementById('reset-amendment');
  const resultsSectionInit = document.getElementById('amendment-results');
  const soilReachInput = document.getElementById('soil-reach-percent');
  // Ocultar resultados al iniciar, a menos que haya resultados guardados visibles
  try {
    const hasSavedVisible = !!(currentProject && currentProject.amendments && currentProject.amendments.results && (currentProject.amendments.results.isVisible || currentProject.amendments.results.detailedHTML));
    if (resultsSectionInit && !hasSavedVisible) {
      resultsSectionInit.style.display = 'none';
    }
  } catch {}
  
  console.log('Bot√≥n calcular encontrado:', calculateBtn);
  console.log('Bot√≥n reset encontrado:', resetBtn);
  
  
  if (calculateBtn) {
    calculateBtn.addEventListener('click', function() {
      console.log('üéØ Bot√≥n calcular presionado!');
      calculateAmendment();
    });
    console.log('‚úÖ Event listener agregado al bot√≥n calcular');
    
  } else {
    console.log('‚ùå Bot√≥n calcular NO encontrado');
  }
  
  if (resetBtn) {
    resetBtn.addEventListener('click', resetAmendmentForm);
  }

  if (soilReachInput) {
    soilReachInput.addEventListener('input', () => {
      updateSoilReachAdjustment({ mutate: false });
    });
    soilReachInput.addEventListener('change', () => {
      normalizeSoilReachPercent(soilReachInput, { mutate: true });
      updateSoilReachAdjustment({ mutate: true });
    });
    soilReachInput.addEventListener('blur', () => {
      normalizeSoilReachPercent(soilReachInput, { mutate: true });
      updateSoilReachAdjustment({ mutate: true });
    });
  }
  
  // Auto-calcular CIC cuando cambien los valores
  const inputs = ['k-initial', 'ca-initial', 'mg-initial', 'h-initial', 'na-initial', 'al-initial'];
  inputs.forEach(id => {
    const input = document.getElementById(id);
    if (input) {
      input.addEventListener('input', calculateCIC);
      input.addEventListener('input', calculateAutomaticAdjustments);
    }
  });
  
  // Auto-calcular ajustes cuando cambie el CIC total
  const cicTotalInput = document.getElementById('cic-total');
  if (cicTotalInput) {
    cicTotalInput.addEventListener('input', calculateAutomaticAdjustments);
  }

  // Auto-calcular Total % cuando cambien los objetivos
  const targetInputs = ['k-target', 'ca-target', 'mg-target', 'h-target', 'na-target', 'al-target'];
  targetInputs.forEach(id => {
    const input = document.getElementById(id);
    if (input) {
      input.addEventListener('input', calculateTotalPercent);
    }
  });
}

function calculateCIC() {
  const k = parseFloat(document.getElementById('k-initial')?.value || 0);
  const ca = parseFloat(document.getElementById('ca-initial')?.value || 0);
  const mg = parseFloat(document.getElementById('mg-initial')?.value || 0);
  const h = parseFloat(document.getElementById('h-initial')?.value || 0);
  const na = parseFloat(document.getElementById('na-initial')?.value || 0);
  const al = parseFloat(document.getElementById('al-initial')?.value || 0);
  
  const cic = k + ca + mg + h + na + al;
  const cicInput = document.getElementById('cic-total');
  if (cicInput) {
    cicInput.value = cic.toFixed(2);
  }
  
  // Calcular porcentajes de cada cati√≥n
  calculateCationPercentages(cic);
  
  // Actualizar iconos de estado
  updateCationStatusIcons();
  
  // Recalcular porcentajes objetivo si hay meq definidos
  const kMeq = parseFloat(document.getElementById('k-target')?.value || 0);
  const caMeq = parseFloat(document.getElementById('ca-target')?.value || 0);
  const mgMeq = parseFloat(document.getElementById('mg-target')?.value || 0);
  const hMeq = parseFloat(document.getElementById('h-target')?.value || 0);
  const naMeq = parseFloat(document.getElementById('na-target')?.value || 0);
  const alMeq = parseFloat(document.getElementById('al-target')?.value || 0);
  
  if (kMeq > 0 || caMeq > 0 || mgMeq > 0 || hMeq > 0 || naMeq > 0 || alMeq > 0) {
    calculateTargetPercentages(kMeq, caMeq, mgMeq, hMeq, naMeq, alMeq, cic);
  }
}

function calculateCationPercentages(cic) {
  if (cic === 0) return;
  
  const cations = [
    { id: 'k-percent', value: parseFloat(document.getElementById('k-initial')?.value || 0) },
    { id: 'ca-percent', value: parseFloat(document.getElementById('ca-initial')?.value || 0) },
    { id: 'mg-percent', value: parseFloat(document.getElementById('mg-initial')?.value || 0) },
    { id: 'h-percent', value: parseFloat(document.getElementById('h-initial')?.value || 0) },
    { id: 'na-percent', value: parseFloat(document.getElementById('na-initial')?.value || 0) },
    { id: 'al-percent', value: parseFloat(document.getElementById('al-initial')?.value || 0) }
  ];
  
  cations.forEach(cation => {
    const percent = (cation.value / cic) * 100;
    const element = document.getElementById(cation.id);
    if (element) {
      element.textContent = percent.toFixed(1) + '%';
    }
  });
}

function updateCationStatusIcons() {
  const k = parseFloat(document.getElementById('k-initial')?.value || 0);
  const ca = parseFloat(document.getElementById('ca-initial')?.value || 0);
  const mg = parseFloat(document.getElementById('mg-initial')?.value || 0);
  const h = parseFloat(document.getElementById('h-initial')?.value || 0);
  const na = parseFloat(document.getElementById('na-initial')?.value || 0);
  const al = parseFloat(document.getElementById('al-initial')?.value || 0);
  const cic = k + ca + mg + h + na + al;
  
  if (cic === 0) return;
  
  // Calcular porcentajes
  const kPercent = (k / cic) * 100;
  const caPercent = (ca / cic) * 100;
  const mgPercent = (mg / cic) * 100;
  const hPercent = (h / cic) * 100;
  const naPercent = (na / cic) * 100;
  const alPercent = (al / cic) * 100;
  
  // Actualizar iconos de estado
  updateStatusIcon('k-status', kPercent, 3, 7);
  updateStatusIcon('ca-status', caPercent, 65, 75);
  updateStatusIcon('mg-status', mgPercent, 10, 15);
  updateStatusIcon('h-status', hPercent, 0, 10);
  updateStatusIcon('na-status', naPercent, 0, 1);
  updateStatusIcon('al-status', alPercent, 0, 1);
}

function updateStatusIcon(elementId, percent, minRange, maxRange) {
  const element = document.getElementById(elementId);
  if (!element) return;
  
  // Si no hay datos (CIC = 0), mostrar gui√≥n
  if (isNaN(percent) || percent === 0) {
    element.textContent = '-';
    return;
  }
  
  if (percent >= minRange && percent <= maxRange) {
    element.textContent = '‚úÖ';
  } else if (percent > maxRange) {
    element.textContent = '‚ö†Ô∏è';
  } else {
    element.textContent = '‚ùå';
  }
}

function calculateTotalPercent() {
  const k = parseFloat(document.getElementById('k-target')?.value || 0);
  const ca = parseFloat(document.getElementById('ca-target')?.value || 0);
  const mg = parseFloat(document.getElementById('mg-target')?.value || 0);
  const h = parseFloat(document.getElementById('h-target')?.value || 0);
  const na = parseFloat(document.getElementById('na-target')?.value || 0);
  const al = parseFloat(document.getElementById('al-target')?.value || 0);
  
  const totalMeq = k + ca + mg + h + na + al;
  const cic = parseFloat(document.getElementById('cic-total')?.value || 0);
  
  // Calcular porcentajes basados en los meq objetivo
  calculateTargetPercentages(k, ca, mg, h, na, al, cic);
  
  // Mostrar total de meq en lugar de porcentaje
  const totalInput = document.getElementById('total-percent');
  if (totalInput) {
    totalInput.value = totalMeq.toFixed(2);
    
    // Cambiar color seg√∫n si la suma de meq es igual al CIC
    if (Math.abs(totalMeq - cic) < 0.1) {
      totalInput.style.borderColor = '#10b981';
      totalInput.style.background = '#f0fdf4';
      totalInput.style.color = '#059669';
    } else {
      totalInput.style.borderColor = '#ef4444';
      totalInput.style.background = '#fef2f2';
      totalInput.style.color = '#dc2626';
    }
  }
}

function calculateTargetPercentages(kMeq, caMeq, mgMeq, hMeq, naMeq, alMeq, cic) {
  if (cic === 0) return;
  
  const targetPercentages = [
    { id: 'k-target-percent', meq: kMeq, percent: (kMeq / cic) * 100 },
    { id: 'ca-target-percent', meq: caMeq, percent: (caMeq / cic) * 100 },
    { id: 'mg-target-percent', meq: mgMeq, percent: (mgMeq / cic) * 100 },
    { id: 'h-target-percent', meq: hMeq, percent: (hMeq / cic) * 100 },
    { id: 'na-target-percent', meq: naMeq, percent: (naMeq / cic) * 100 },
    { id: 'al-target-percent', meq: alMeq, percent: (alMeq / cic) * 100 }
  ];
  
  targetPercentages.forEach(item => {
    const element = document.getElementById(item.id);
    if (element) {
      element.textContent = item.percent.toFixed(1) + '%';
    }
  });
}

function calculateAutomaticAdjustments() {
  if (skipAutomaticAdjustments) {
    console.log('‚è≠Ô∏è Saltando rec√°lculo autom√°tico (modificando concentraci√≥n)');
    return;
  }
  
  console.log('üéØ Recalculando ajustes autom√°ticos...');
  
  // Verificar si los elementos existen antes de leerlos
  const cicTotalElement = document.getElementById('cic-total');
  const kInitialElement = document.getElementById('k-initial');
  const caInitialElement = document.getElementById('ca-initial');
  const mgInitialElement = document.getElementById('mg-initial');
  const hInitialElement = document.getElementById('h-initial');
  const naInitialElement = document.getElementById('na-initial');
  const alInitialElement = document.getElementById('al-initial');
  
  // Si no existen los elementos, salir silenciosamente (no estamos en an√°lisis de suelo)
  if (!cicTotalElement || !kInitialElement || !caInitialElement || !mgInitialElement || !hInitialElement || !naInitialElement || !alInitialElement) {
    console.log('‚è≠Ô∏è No estamos en la secci√≥n de an√°lisis de suelo, saltando rec√°lculo');
    return;
  }
  
  // Obtener valores del an√°lisis inicial (solo si los elementos existen)
  const cicTotal = parseFloat(cicTotalElement.value) || 0;
  const kInitial = parseFloat(kInitialElement.value) || 0;
  const caInitial = parseFloat(caInitialElement.value) || 0;
  const mgInitial = parseFloat(mgInitialElement.value) || 0;
  const hInitial = parseFloat(hInitialElement.value) || 0;
  const naInitial = parseFloat(naInitialElement.value) || 0;
  const alInitial = parseFloat(alInitialElement.value) || 0;
  
  console.log('üìä Valores iniciales:', { cicTotal, kInitial, caInitial, mgInitial, hInitial, naInitial, alInitial });
  
  if (cicTotal === 0) {
    // Si no hay CIC, limpiar los campos de ajuste
    clearAdjustmentFields();
    return;
  }
  
  // Calcular valores ideales directamente (sin balance i√≥nico complejo)
  const idealValues = calculateIdealValues(cicTotal);
  
  console.log('üéØ Valores ideales calculados:', idealValues);
  
  // Calcular ajustes necesarios (diferencia entre ideal y actual)
  const adjustments = {
    k: idealValues.k - kInitial,
    ca: idealValues.ca - caInitial,
    mg: idealValues.mg - mgInitial,
    h: idealValues.h - hInitial, // Ideal = 0
    na: idealValues.na - naInitial, // Ideal = 0
    al: idealValues.al - alInitial // Ideal = 0
  };
  
  console.log('üìä Ajustes calculados:', adjustments);
  
  // Aplicar los ajustes a los campos de objetivo
  applyAdjustmentsToFields(adjustments);
  
  console.log('‚úÖ Ajustes aplicados a los campos');
}

function calculateIdealValues(cic) {
  return {
    k: Math.round((cic * 0.05) * 100) / 100,   // 5% del CIC
    ca: Math.round((cic * 0.75) * 100) / 100,  // 75% del CIC (ideal)
    mg: Math.round((cic * 0.15) * 100) / 100,  // 15% del CIC (ideal)
    h: 0,   // Ideal = 0
    na: 0,  // Ideal = 0
    al: 0   // Ideal = 0
  };
}

function calculateBalancedAdjustments(cic, kInitial, caInitial, mgInitial, hInitial, naInitial, alInitial) {
  // Calcular valores ideales para los cationes buenos
  const idealValues = calculateIdealValues(cic);
  
  // Calcular total de cationes malos que necesitan ser desplazados
  const badCations = hInitial + naInitial + alInitial;
  
  // Evaluar d√©ficits y excesos de cationes buenos
  const kDeficit = Math.max(0, idealValues.k - kInitial); // Solo si falta K
  const caDeficit = Math.max(0, idealValues.ca - caInitial); // Solo si falta Ca
  const mgDeficit = Math.max(0, idealValues.mg - mgInitial); // Solo si falta Mg
  
  // Evaluar si los cationes est√°n en niveles adecuados (no tocar si est√°n altos o cerca del ideal)
  const kIsHigh = kInitial >= idealValues.k; // K est√° alto o en ideal
  const caIsHigh = caInitial >= idealValues.ca; // Ca est√° alto o en ideal
  const mgIsHigh = mgInitial >= idealValues.mg; // Mg est√° alto o en ideal
  
  // Calcular total de meq necesarios para ajustes
  const totalNeeded = badCations + kDeficit + caDeficit + mgDeficit;
  
  if (totalNeeded === 0) {
    // Si no hay cationes malos ni d√©ficits, usar valores ideales normales
    return idealValues;
  }
  
  // Distribuir el total necesario entre los cationes que necesitan ajuste
  let kFinal = kInitial;
  let caFinal = caInitial;
  let mgFinal = mgInitial;
  
  // Si hay cationes malos, distribuirlos entre los cationes que necesitan ajuste
  if (badCations > 0) {
    const cationsToAdjust = [];
    
    // Solo incluir cationes que necesitan ajuste Y no est√°n altos
    if (kDeficit > 0 && !kIsHigh) cationsToAdjust.push('k');
    if (caDeficit > 0 && !caIsHigh) cationsToAdjust.push('ca');
    if (mgDeficit > 0 && !mgIsHigh) cationsToAdjust.push('mg');
    
    if (cationsToAdjust.length > 0) {
      // Distribuir cationes malos entre los que necesitan ajuste
      const badCationsPerCation = badCations / cationsToAdjust.length;
      
      if (cationsToAdjust.includes('k')) {
        kFinal = Math.round((kInitial + kDeficit + badCationsPerCation) * 100) / 100;
      }
      if (cationsToAdjust.includes('ca')) {
        caFinal = Math.round((caInitial + caDeficit + badCationsPerCation) * 100) / 100;
      }
      if (cationsToAdjust.includes('mg')) {
        mgFinal = Math.round((mgInitial + mgDeficit + badCationsPerCation) * 100) / 100;
      }
    } else {
      // Si no hay cationes que necesiten ajuste, todo va al Ca
      caFinal = Math.round((caInitial + badCations) * 100) / 100;
    }
  } else {
    // Solo ajustar d√©ficits sin cationes malos
    if (!kIsHigh) kFinal = Math.round((kInitial + kDeficit) * 100) / 100;
    if (!caIsHigh) caFinal = Math.round((caInitial + caDeficit) * 100) / 100;
    if (!mgIsHigh) mgFinal = Math.round((mgInitial + mgDeficit) * 100) / 100;
  }
  
  // Verificar que no excedamos el CIC total disponible
  const totalCations = kFinal + caFinal + mgFinal;
  if (totalCations > cic) {
    // Si excedemos el CIC, ajustar proporcionalmente
    const scaleFactor = cic / totalCations;
    kFinal = Math.round((kFinal * scaleFactor) * 100) / 100;
    caFinal = Math.round((caFinal * scaleFactor) * 100) / 100;
    mgFinal = Math.round((mgFinal * scaleFactor) * 100) / 100;
  }
  
  return {
    k: kFinal,
    ca: caFinal,
    mg: mgFinal,
    h: 0,   // Ideal = 0
    na: 0,  // Ideal = 0
    al: 0   // Ideal = 0
  };
}

function applyAdjustmentsToFields(adjustments) {
  document.getElementById('k-target').value = adjustments.k.toFixed(2);
  document.getElementById('ca-target').value = adjustments.ca.toFixed(2);
  document.getElementById('mg-target').value = adjustments.mg.toFixed(2);
  document.getElementById('h-target').value = adjustments.h.toFixed(2);
  document.getElementById('na-target').value = adjustments.na.toFixed(2);
  document.getElementById('al-target').value = adjustments.al.toFixed(2);
  
  // Aplicar colores de atenci√≥n
  applyAttentionColors(adjustments);
}

function applyAttentionColors(adjustments) {
  // Obtener valores del an√°lisis inicial para calcular porcentajes
  const cicTotal = parseFloat(document.getElementById('cic-total').value) || 0;
  const kInitial = parseFloat(document.getElementById('k-initial').value) || 0;
  const caInitial = parseFloat(document.getElementById('ca-initial').value) || 0;
  const mgInitial = parseFloat(document.getElementById('mg-initial').value) || 0;
  const hInitial = parseFloat(document.getElementById('h-initial').value) || 0;
  const naInitial = parseFloat(document.getElementById('na-initial').value) || 0;
  const alInitial = parseFloat(document.getElementById('al-initial').value) || 0;
  
  // Calcular porcentajes actuales
  const kPercent = cicTotal > 0 ? (kInitial / cicTotal) * 100 : 0;
  const caPercent = cicTotal > 0 ? (caInitial / cicTotal) * 100 : 0;
  const mgPercent = cicTotal > 0 ? (mgInitial / cicTotal) * 100 : 0;
  const hPercent = cicTotal > 0 ? (hInitial / cicTotal) * 100 : 0;
  const naPercent = cicTotal > 0 ? (naInitial / cicTotal) * 100 : 0;
  const alPercent = cicTotal > 0 ? (alInitial / cicTotal) * 100 : 0;
  
  // Obtener todos los valores absolutos
  const values = [
    { id: 'k-target', value: Math.abs(adjustments.k), cation: 'K', percent: kPercent },
    { id: 'ca-target', value: Math.abs(adjustments.ca), cation: 'Ca', percent: caPercent },
    { id: 'mg-target', value: Math.abs(adjustments.mg), cation: 'Mg', percent: mgPercent },
    { id: 'h-target', value: Math.abs(adjustments.h), cation: 'H', percent: hPercent },
    { id: 'na-target', value: Math.abs(adjustments.na), cation: 'Na', percent: naPercent },
    { id: 'al-target', value: Math.abs(adjustments.al), cation: 'Al', percent: alPercent }
  ];
  
  // Encontrar el valor m√°ximo
  const maxValue = Math.max(...values.map(v => v.value));
  
  // Determinar qu√© cationes necesitan atenci√≥n
  const attentionCations = values.filter(v => {
    // Criterio general
    const generalCriteria = v.value >= 1.0 || (v.value >= 0.5 && v.value === maxValue);
    
    // Criterio especial para K: si est√° muy por debajo o muy por encima del ideal
    const kSpecialCriteria = v.cation === 'K' && (v.percent < 3.0 || v.percent > 8.0);
    
    // Criterio especial para Ca: si est√° muy por debajo o muy por encima del ideal
    const caSpecialCriteria = v.cation === 'Ca' && (v.percent < 65.0 || v.percent > 78.0);
    
    // Criterio especial para Mg: si est√° muy por debajo o muy por encima del ideal
    const mgSpecialCriteria = v.cation === 'Mg' && (v.percent < 10.0 || v.percent > 17.0);
    
    // Criterio especial para H: si est√° por encima del 10%
    const hSpecialCriteria = v.cation === 'H' && v.percent > 10.0;
    
    // Criterio especial para Na: si est√° por encima del 1%
    const naSpecialCriteria = v.cation === 'Na' && v.percent > 1.0;
    
    // Criterio especial para Al: si est√° por encima del 1%
    const alSpecialCriteria = v.cation === 'Al' && v.percent > 1.0;
    
    return generalCriteria || kSpecialCriteria || caSpecialCriteria || mgSpecialCriteria || hSpecialCriteria || naSpecialCriteria || alSpecialCriteria;
  });
  
  // Aplicar colores
  values.forEach(v => {
    const element = document.getElementById(v.id);
    if (element) {
      if (attentionCations.some(ac => ac.id === v.id)) {
        // Rojo para atenci√≥n
        element.style.color = '#dc2626';
        element.style.fontWeight = '700';
      } else {
        // Color normal
        element.style.color = '#374151';
        element.style.fontWeight = '400';
      }
    }
  });
}

function clearAdjustmentFields() {
  document.getElementById('k-target').value = '0.00';
  document.getElementById('ca-target').value = '0.00';
  document.getElementById('mg-target').value = '0.00';
  document.getElementById('h-target').value = '0.00';
  document.getElementById('na-target').value = '0.00';
  document.getElementById('al-target').value = '0.00';
  
  // Resetear colores
  const targetInputs = ['k-target', 'ca-target', 'mg-target', 'h-target', 'na-target', 'al-target'];
  targetInputs.forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      element.style.color = '#374151';
      element.style.fontWeight = '400';
    }
  });
}

function clearAttentionColors() {
  const cations = ['k', 'ca', 'mg', 'h', 'na', 'al'];
  
  cations.forEach(cation => {
    // Limpiar colores de inputs iniciales
    const initialInput = document.getElementById(`${cation}-initial`);
    if (initialInput) {
      initialInput.style.color = '';
      initialInput.style.backgroundColor = '';
    }
    
    // Limpiar colores de inputs objetivo
    const targetInput = document.getElementById(`${cation}-target`);
    if (targetInput) {
      targetInput.style.color = '';
      targetInput.style.backgroundColor = '';
    }
    
    // Limpiar colores de labels
    const initialLabel = document.querySelector(`label[for="${cation}-initial"]`);
    if (initialLabel) {
      initialLabel.style.color = '';
    }
    
    const targetLabel = document.querySelector(`label[for="${cation}-target"]`);
    if (targetLabel) {
      targetLabel.style.color = '';
    }
  });
}

function convertKgHaToMeq(kgHa, pesoMolecular) {
  // Obtener valores del formulario
  const densidadAparente = parseFloat(document.getElementById('soil-density')?.value || 1.1);
  const profundidad = parseFloat(document.getElementById('soil-depth')?.value || 30) / 100; // convertir cm a m
  
  // Conversi√≥n inversa: kg/ha ‚Üí meq/100g
  // Factor: kgHa / (pesoMolecular √ó 10 √ó (100 √ó 100 √ó profundidadEnMetros √ó densidadAparente) / 1,000)
  return kgHa / (pesoMolecular * 10 * (100 * 100 * profundidad * densidadAparente) / 1000);
}

function convertMeqToKgHa(meq, pesoEquivalente) {
  // Obtener valores del formulario
  const densidadAparente = parseFloat(document.getElementById('soil-density')?.value || 1.1);
  const profundidad = parseFloat(document.getElementById('soil-depth')?.value || 30) / 100; // convertir cm a m
  
  // F√≥rmula correcta: meq √ó pesoEquivalente √ó 10 √ó (100 √ó 100 √ó profundidadEnMetros √ó densidadAparente) / 1,000
  return meq * pesoEquivalente * 10 * (100 * 100 * profundidad * densidadAparente) / 1000;
}

function calcularEstrategiaEnmiendas(enmiendasSeleccionadas, necesidades) {
  const estrategia = [];
  let caRestante = necesidades.ca;
  let mgRestante = necesidades.mg;
  let kRestante = necesidades.k;
  let so4Necesario = necesidades.so4;
  
  console.log('üß™ An√°lisis inicial:', {
    pH: necesidades.pH,
    ca: caRestante,
    mg: mgRestante,
    k: kRestante,
    so4: so4Necesario
  });
  
  console.log('üîç VALORES DE NECESIDADES RECIBIDOS:');
  console.log(`  - necesidades.ca: ${necesidades.ca}`);
  console.log(`  - necesidades.mg: ${necesidades.mg}`);
  console.log(`  - necesidades.k: ${necesidades.k}`);
  
  console.log('üîç COMPARACI√ìN DIRECTA:');
  console.log(`  - caRestante > mgRestante: ${caRestante > mgRestante}`);
  console.log(`  - mgRestante > caRestante: ${mgRestante > caRestante}`);
  console.log(`  - Diferencia: Ca=${caRestante}, Mg=${mgRestante}, Diferencia=${Math.abs(caRestante - mgRestante)}`);
  
  
  
  // 0Ô∏è‚É£ PRIORIDAD M√ÅXIMA: Enmiendas personalizadas con M√öLTIPLES elementos (K, Ca, Mg)
  const enmiendasMultiElemento = enmiendasSeleccionadas.filter(a => {
    const tieneK = (a.composition?.k || a.k || 0) > 0;
    const tieneCa = (a.composition?.ca || a.ca || 0) > 0;
    const tieneMg = (a.composition?.mg || a.mg || 0) > 0;
    const elementosCount = (tieneK ? 1 : 0) + (tieneCa ? 1 : 0) + (tieneMg ? 1 : 0);
    return elementosCount >= 2; // Tiene al menos 2 de los 3 elementos
  });
  
  if (enmiendasMultiElemento.length > 0 && (kRestante > 0 || caRestante > 0 || mgRestante > 0)) {
    // Usar la primera enmienda multi-elemento encontrada
    const multiAmendment = enmiendasMultiElemento[0];
    
    // Identificar qu√© elementos faltan y cu√°l es el M√ÅS limitante
    const elementosDisponibles = [];
    if (kRestante > 0) elementosDisponibles.push({ elemento: 'K', meq: kRestante });
    if (caRestante > 0) elementosDisponibles.push({ elemento: 'Ca', meq: caRestante });
    if (mgRestante > 0) elementosDisponibles.push({ elemento: 'Mg', meq: mgRestante });
    
    // Encontrar el elemento con MAYOR deficiencia (el m√°s limitante)
    const elementoLimitante = elementosDisponibles.reduce((max, actual) => 
      actual.meq > max.meq ? actual : max
    );
    
    console.log('üîç ENMIENDA MULTI-ELEMENTO DETECTADA:', multiAmendment.name);
    console.log('üîç ELEMENTO M√ÅS LIMITANTE:');
    console.log(`  - Elementos disponibles: ${elementosDisponibles.map(e => `${e.elemento}: ${e.meq} meq`).join(', ')}`);
    console.log(`  - Elemento M√ÅS limitante: ${elementoLimitante.elemento} (${elementoLimitante.meq} meq)`);
    
    // Obtener concentraciones de la enmienda multi-elemento
    const kPercent = multiAmendment.composition?.k || multiAmendment.k || 0;
    const caPercent = multiAmendment.composition?.ca || multiAmendment.ca || 0;
    const mgPercent = multiAmendment.composition?.mg || multiAmendment.mg || 0;
    
    // Calcular dosis necesaria para cada elemento
    let kAmount = 0, caAmount = 0, mgAmount = 0;
    
    if (kRestante > 0 && kPercent > 0) {
      const kKgHaNeeded = convertMeqToKgHa(kRestante, 39.1);
      kAmount = kKgHaNeeded / (kPercent / 100);
    }
    if (caRestante > 0 && caPercent > 0) {
      const caKgHaNeeded = convertMeqToKgHa(caRestante, 20.04);
      caAmount = caKgHaNeeded / (caPercent / 100);
    }
    if (mgRestante > 0 && mgPercent > 0) {
      const mgKgHaNeeded = convertMeqToKgHa(mgRestante, 12.15);
      mgAmount = mgKgHaNeeded / (mgPercent / 100);
    }
    
    // USAR LA DOSIS DEL ELEMENTO M√ÅS LIMITANTE
    let dosisMulti = 0;
    if (elementoLimitante.elemento === 'K') {
      dosisMulti = kAmount;
    } else if (elementoLimitante.elemento === 'Ca') {
      dosisMulti = caAmount;
    } else if (elementoLimitante.elemento === 'Mg') {
      dosisMulti = mgAmount;
    }
    
    console.log('üîç C√ÅLCULO DE DOSIS BASADO EN ELEMENTO M√ÅS LIMITANTE:');
    console.log(`  - kAmount: ${kAmount.toFixed(2)} kg/ha (para ${kRestante} meq K)`);
    console.log(`  - caAmount: ${caAmount.toFixed(2)} kg/ha (para ${caRestante} meq Ca)`);
    console.log(`  - mgAmount: ${mgAmount.toFixed(2)} kg/ha (para ${mgRestante} meq Mg)`);
    console.log(`  - dosisMulti: ${dosisMulti.toFixed(2)} kg/ha`);
    console.log(`  - Usando: ${elementoLimitante.elemento}Amount (elemento M√ÅS limitante)`);
    
    estrategia.push({
      tipo: multiAmendment.id,
      dosis: dosisMulti,
      razon: `Enmienda multi-elemento - Elemento limitante: ${elementoLimitante.elemento} (${kPercent}% K, ${caPercent}% Ca, ${mgPercent}% Mg)`,
      elementoLimitante: elementoLimitante
    });
    
    // Recalcular necesidades restantes
    const kAportado = dosisMulti * (kPercent / 100);
    const caAportado = dosisMulti * (caPercent / 100);
    const mgAportado = dosisMulti * (mgPercent / 100);
    
    if (kPercent > 0) kRestante = Math.max(0, kRestante - convertKgHaToMeq(kAportado, 39.1));
    if (caPercent > 0) caRestante = Math.max(0, caRestante - convertKgHaToMeq(caAportado, 20.04));
    if (mgPercent > 0) mgRestante = Math.max(0, mgRestante - convertKgHaToMeq(mgAportado, 12.15));
    
    console.log(`üéØ Enmienda multi-elemento aplicada - Elemento limitante: ${elementoLimitante.elemento}`);
  }
  
  // 1Ô∏è‚É£ PRIORIDAD: Cal Dolom√≠tica si necesitas Ca + Mg simult√°neamente
  const tieneDolomita = enmiendasSeleccionadas.find(a => a.id === 'dolomite');
  if (tieneDolomita && caRestante > 0 && mgRestante > 0) {
    const caKgHaNeeded = convertMeqToKgHa(caRestante, 20.04);
    const mgKgHaNeeded = convertMeqToKgHa(mgRestante, 12.15);
    
    // El elemento limitante es el que M√ÅS FALTA (mayor deficiencia en meq)
    // Comparar K, Ca Y Mg para encontrar el m√°s limitante
    const elementosDisponibles = [];
    if (kRestante > 0) elementosDisponibles.push({ elemento: 'K', meq: kRestante });
    if (caRestante > 0) elementosDisponibles.push({ elemento: 'Ca', meq: caRestante });
    if (mgRestante > 0) elementosDisponibles.push({ elemento: 'Mg', meq: mgRestante });
    
    // Encontrar el elemento con MAYOR deficiencia (el m√°s limitante)
    const elementoLimitante = elementosDisponibles.reduce((max, actual) => 
      actual.meq > max.meq ? actual : max
    );
    
    console.log('üîç ELEMENTO M√ÅS LIMITANTE:');
    console.log(`  - Elementos disponibles: ${elementosDisponibles.map(e => `${e.elemento}: ${e.meq} meq`).join(', ')}`);
    console.log(`  - Elemento M√ÅS limitante: ${elementoLimitante.elemento} (${elementoLimitante.meq} meq)`);
    
    // Calcular cu√°nta enmienda necesitar√≠amos para cada elemento
    // Usar porcentajes actuales de la enmienda (no fijos)
    const dolomiteAmendment = enmiendasSeleccionadas.find(a => a.id === 'dolomite');
    const caPercent = dolomiteAmendment?.composition?.ca || dolomiteAmendment?.ca || 21.7;
    const mgPercent = dolomiteAmendment?.composition?.mg || dolomiteAmendment?.mg || 13.2;
    
    const caAmount = caKgHaNeeded / (caPercent / 100);
    const mgAmount = mgKgHaNeeded / (mgPercent / 100);
    
    // Calcular cantidad para K si est√° disponible
    let kAmount = 0;
    if (kRestante > 0) {
      const kPercent = dolomiteAmendment?.composition?.k || dolomiteAmendment?.k || 0;
      if (kPercent > 0) {
        const kKgHaNeeded = convertMeqToKgHa(kRestante, 39.1);
        kAmount = kKgHaNeeded / (kPercent / 100);
      }
    }
    
    // Usar la cantidad del elemento M√ÅS LIMITANTE (el que m√°s falta)
    let dosisDolomita = 0;
    if (elementoLimitante.elemento === 'Ca') {
      dosisDolomita = caAmount;
    } else if (elementoLimitante.elemento === 'Mg') {
      dosisDolomita = mgAmount;
    } else if (elementoLimitante.elemento === 'K') {
      dosisDolomita = kAmount;
    }
    
    console.log('üîç C√ÅLCULO DE DOSIS BASADO EN ELEMENTO M√ÅS LIMITANTE:');
    console.log(`  - caAmount: ${caAmount.toFixed(2)} kg/ha (para ${caRestante} meq Ca)`);
    console.log(`  - mgAmount: ${mgAmount.toFixed(2)} kg/ha (para ${mgRestante} meq Mg)`);
    console.log(`  - kAmount: ${kAmount.toFixed(2)} kg/ha (para ${kRestante} meq K)`);
    console.log(`  - dosisDolomita: ${dosisDolomita.toFixed(2)} kg/ha`);
    console.log(`  - Usando: ${elementoLimitante.elemento}Amount (elemento M√ÅS limitante)`);
    
    // Verificar si pH es alto para mostrar advertencia
    const advertenciaPH = necesidades.pH >= 7;
    const razon = advertenciaPH 
      ? `‚ö†Ô∏è ADVERTENCIA: pH ${necesidades.pH} - Cal Dolom√≠tica NO recomendada (alcalinizar√≠a m√°s) - Elemento limitante: ${elementoLimitante.elemento}`
      : `Elemento limitante: ${elementoLimitante.elemento} - Cal Dolom√≠tica optimizada`;
    
    estrategia.push({
      tipo: 'dolomite',
      dosis: dosisDolomita,
      razon: razon,
      elementoLimitante: elementoLimitante,
      advertencia: advertenciaPH
    });
    
    // Recalcular necesidades restantes usando porcentajes DIN√ÅMICOS
    const caAportado = dosisDolomita * (caPercent / 100);
    const mgAportado = dosisDolomita * (mgPercent / 100);
    caRestante = Math.max(0, caRestante - convertKgHaToMeq(caAportado, 20.04));
    mgRestante = Math.max(0, mgRestante - convertKgHaToMeq(mgAportado, 12.15));
    
    console.log(`üéØ Cal Dolom√≠tica aplicada - Elemento limitante: ${elementoLimitante}${advertenciaPH ? ' (CON ADVERTENCIA pH)' : ''}`);
  }
  
  // 2Ô∏è‚É£ CALCIO RESTANTE: Decisi√≥n basada en pH
  const tieneYeso = enmiendasSeleccionadas.find(a => a.id === 'gypsum');
  const tieneCalAgricola = enmiendasSeleccionadas.find(a => a.id === 'lime');
  
  if (caRestante > 0) {
    // YESO: Permite en cualquier pH (no acidifica ni alcaliniza)
    if (tieneYeso) {
      const caKgHaNeeded = convertMeqToKgHa(caRestante, 20.04);
      // üîß USAR CONCENTRACI√ìN DIN√ÅMICA (editada o por defecto)
      const yesoAmendment = enmiendasSeleccionadas.find(a => a.id === 'gypsum');
      const caPercent = yesoAmendment?.composition?.ca || yesoAmendment?.ca || 23.3;
      const dosisYeso = caKgHaNeeded / (caPercent / 100);
      
      console.log(`üîç YESO - Ca requerido: ${caKgHaNeeded.toFixed(2)} kg/ha, Concentraci√≥n Ca: ${caPercent}%, Dosis: ${dosisYeso.toFixed(2)} kg/ha`);
      
      estrategia.push({
        tipo: 'gypsum',
        dosis: dosisYeso,
        razon: `Yeso para Ca (${caPercent}% Ca) - No afecta pH`
      });
      
      caRestante = 0;
    } 
    // CAL AGR√çCOLA: Solo si pH < 7 (no alcalinizar m√°s)
    else if (tieneCalAgricola && necesidades.pH < 7) {
      const caKgHaNeeded = convertMeqToKgHa(caRestante, 20.04);
      // üîß USAR CONCENTRACI√ìN DIN√ÅMICA (editada o por defecto)
      const limeAmendment = enmiendasSeleccionadas.find(a => a.id === 'lime');
      const caPercent = limeAmendment?.composition?.ca || limeAmendment?.ca || 40.0;
      const dosisCalAgricola = caKgHaNeeded / (caPercent / 100);
      
      console.log(`üîç CAL AGR√çCOLA - Ca requerido: ${caKgHaNeeded.toFixed(2)} kg/ha, Concentraci√≥n Ca: ${caPercent}%, Dosis: ${dosisCalAgricola.toFixed(2)} kg/ha`);
      
      estrategia.push({
        tipo: 'lime',
        dosis: dosisCalAgricola,
        razon: `Cal Agr√≠cola para Ca (${caPercent}% Ca) y elevar pH`
      });
      
      caRestante = 0;
    }
    // ADVERTENCIA: Cal Agr√≠cola con pH ‚â• 7
    else if (tieneCalAgricola && necesidades.pH >= 7) {
      const caKgHaNeeded = convertMeqToKgHa(caRestante, 20.04);
      // üîß USAR CONCENTRACI√ìN DIN√ÅMICA (editada o por defecto)
      const limeAmendment = enmiendasSeleccionadas.find(a => a.id === 'lime');
      const caPercent = limeAmendment?.composition?.ca || limeAmendment?.ca || 40.0;
      const dosisCalAgricola = caKgHaNeeded / (caPercent / 100);
      
      estrategia.push({
        tipo: 'lime',
        dosis: dosisCalAgricola,
        razon: `‚ö†Ô∏è ADVERTENCIA: pH ${necesidades.pH} - Cal Agr√≠cola NO recomendada (alcalinizar√≠a m√°s)`,
        advertencia: true
      });
      
      console.log(`‚ö†Ô∏è Cal Agr√≠cola calculada pero NO recomendada (pH ${necesidades.pH})`);
    }
    
    // 2Ô∏è‚É£.1 CALCIO RESTANTE - ENMIENDAS PERSONALIZADAS (solo si no se us√≥ antes)
    if (caRestante > 0) {
      const enmiendasConCa = enmiendasSeleccionadas.filter(a => 
        a.id !== 'gypsum' && a.id !== 'lime' && a.id !== 'dolomite' && 
        (a.composition?.ca > 0 || a.ca > 0) &&
        !estrategia.some(e => e.tipo === a.id) // Evitar duplicados
      );
      
      enmiendasConCa.forEach(enmienda => {
        const caPercent = enmienda.composition?.ca || enmienda.ca || 0;
        if (caPercent > 0) {
          const caKgHaNeeded = convertMeqToKgHa(caRestante, 20.04);
          const dosisEnmienda = caKgHaNeeded / (caPercent / 100);
          
          estrategia.push({
            tipo: enmienda.id,
            dosis: dosisEnmienda,
            razon: `Calcio adicional requerido (${caPercent}% Ca)`
          });
          
          caRestante = 0;
          console.log(`‚úÖ ${enmienda.name} seleccionado para Ca (${caPercent}%)`);
        }
      });
    }
  }
  
  // 3Ô∏è‚É£ MAGNESIO RESTANTE
  const tieneMgSO4 = enmiendasSeleccionadas.find(a => a.id === 'mgso4-mono');
  if (mgRestante > 0 && tieneMgSO4) {
    const mgKgHaNeeded = convertMeqToKgHa(mgRestante, 12.15);
    // üîß USAR CONCENTRACI√ìN DIN√ÅMICA (editada o por defecto)
    const mgso4Amendment = enmiendasSeleccionadas.find(a => a.id === 'mgso4-mono');
    const mgPercent = mgso4Amendment?.composition?.mg || mgso4Amendment?.mg || 17.0;
    const dosisMgSO4 = mgKgHaNeeded / (mgPercent / 100);
    
    console.log(`üîç MgSO‚ÇÑ - Mg requerido: ${mgKgHaNeeded.toFixed(2)} kg/ha, Concentraci√≥n Mg: ${mgPercent}%, Dosis: ${dosisMgSO4.toFixed(2)} kg/ha`);
    
    estrategia.push({
      tipo: 'mgso4-mono',
      dosis: dosisMgSO4,
      razon: `Magnesio adicional requerido (${mgPercent}% Mg)`
    });
    
    mgRestante = 0;
    console.log('‚úÖ MgSO‚ÇÑ seleccionado para Mg');
  }
  
  // 3Ô∏è‚É£.1 MAGNESIO RESTANTE - ENMIENDAS PERSONALIZADAS (solo si no se us√≥ antes)
  if (mgRestante > 0) {
    const enmiendasConMg = enmiendasSeleccionadas.filter(a => 
      a.id !== 'mgso4-mono' && a.id !== 'dolomite' && 
      (a.composition?.mg > 0 || a.mg > 0) &&
      !estrategia.some(e => e.tipo === a.id) // Evitar duplicados
    );
    
    enmiendasConMg.forEach(enmienda => {
      const mgPercent = enmienda.composition?.mg || enmienda.mg || 0;
      if (mgPercent > 0) {
        const mgKgHaNeeded = convertMeqToKgHa(mgRestante, 12.15);
        const dosisEnmienda = mgKgHaNeeded / (mgPercent / 100);
        
        estrategia.push({
          tipo: enmienda.id,
          dosis: dosisEnmienda,
          razon: `Magnesio adicional requerido (${mgPercent}% Mg)`
        });
        
        mgRestante = 0;
        console.log(`‚úÖ ${enmienda.name} seleccionado para Mg (${mgPercent}%)`);
      }
    });
  }
  
  // 4Ô∏è‚É£ POTASIO
  const tieneSOP = enmiendasSeleccionadas.find(a => a.id === 'sop-granular');
  if (kRestante > 0 && tieneSOP) {
    const kKgHaNeeded = convertMeqToKgHa(kRestante, 39.1);
    // üîß USAR CONCENTRACI√ìN DIN√ÅMICA (editada o por defecto)
    const sopAmendment = enmiendasSeleccionadas.find(a => a.id === 'sop-granular');
    const kPercent = sopAmendment?.composition?.k || sopAmendment?.k || 41.5;
    const dosisSOP = kKgHaNeeded / (kPercent / 100);
    
    console.log(`üîç SOP - K requerido: ${kKgHaNeeded.toFixed(2)} kg/ha, Concentraci√≥n K: ${kPercent}%, Dosis: ${dosisSOP.toFixed(2)} kg/ha`);
    
    estrategia.push({
      tipo: 'sop-granular',
      dosis: dosisSOP,
      razon: `Potasio requerido (${kPercent}% K)`
    });
    
    kRestante = 0;
    console.log('‚úÖ SOP seleccionado para K');
  }
  
  // 4Ô∏è‚É£.1 POTASIO - ENMIENDAS PERSONALIZADAS (solo si no se us√≥ antes)
  if (kRestante > 0) {
    const enmiendasConK = enmiendasSeleccionadas.filter(a => 
      a.id !== 'sop-granular' && 
      (a.composition?.k > 0 || a.k > 0) &&
      !estrategia.some(e => e.tipo === a.id) // Evitar duplicados
    );
    
    enmiendasConK.forEach(enmienda => {
      const kPercent = enmienda.composition?.k || enmienda.k || 0;
      if (kPercent > 0) {
        const kKgHaNeeded = convertMeqToKgHa(kRestante, 39.1);
        const dosisEnmienda = kKgHaNeeded / (kPercent / 100);
        
        estrategia.push({
          tipo: enmienda.id,
          dosis: dosisEnmienda,
          razon: `Potasio adicional requerido (${kPercent}% K)`
        });
        
        kRestante = 0;
        console.log(`‚úÖ ${enmienda.name} seleccionado para K (${kPercent}%)`);
      }
    });
  }
  
  // 5Ô∏è‚É£ SO‚ÇÑ PARA DESPLAZAR Na‚Å∫ (si no se cubri√≥ con otras enmiendas)
  const so4YaAportado = estrategia.reduce((total, e) => {
    // üîß USAR CONCENTRACIONES DIN√ÅMICAS para calcular aportes
    const enmienda = enmiendasSeleccionadas.find(a => a.id === e.tipo);
    if (enmienda) {
      const so4Percent = enmienda.composition?.so4 || enmienda.so4 || 
                         (e.tipo === 'gypsum' ? 55.8 : 
                          e.tipo === 'sop-granular' ? 54.1 : 
                          e.tipo === 'mgso4-mono' ? 69 : 0);
      return total + (e.dosis * (so4Percent / 100));
    }
    
    return total;
  }, 0);
  
  const so4Restante = Math.max(0, so4Necesario - so4YaAportado);
  if (so4Restante > 0 && tieneYeso) {
    // üîß USAR CONCENTRACI√ìN DIN√ÅMICA
    const yesoAmendment = enmiendasSeleccionadas.find(a => a.id === 'gypsum');
    const so4Percent = yesoAmendment?.composition?.so4 || yesoAmendment?.so4 || 55.8;
    const dosisYesoAdicional = so4Restante / (so4Percent / 100);
    
    estrategia.push({
      tipo: 'gypsum',
      dosis: dosisYesoAdicional,
      razon: 'SO‚ÇÑ adicional para desplazar Na‚Å∫'
    });
    
    console.log('‚úÖ Yeso adicional para SO‚ÇÑ');
  }
  
  console.log('üéØ Estrategia final:', estrategia);
  return estrategia;
}

function calculateAmendment() {
  console.log('üßÆ Funci√≥n calculateAmendment ejecut√°ndose...');
  console.log('üîç DEBUGGING: Verificando enmiendas seleccionadas...');
  
  // Obtener valores del an√°lisis inicial
  const kInitial = parseFloat(document.getElementById('k-initial')?.value || 0);
  const caInitial = parseFloat(document.getElementById('ca-initial')?.value || 0);
  const mgInitial = parseFloat(document.getElementById('mg-initial')?.value || 0);
  const hInitial = parseFloat(document.getElementById('h-initial')?.value || 0);
  const naInitial = parseFloat(document.getElementById('na-initial')?.value || 0);
  const alInitial = parseFloat(document.getElementById('al-initial')?.value || 0);
  const cicTotal = parseFloat(document.getElementById('cic-total')?.value || 0);
  
  // Obtener objetivos
  const kTarget = parseFloat(document.getElementById('k-target')?.value || 0);
  const caTarget = parseFloat(document.getElementById('ca-target')?.value || 0);
  const mgTarget = parseFloat(document.getElementById('mg-target')?.value || 0);
  const hTarget = parseFloat(document.getElementById('h-target')?.value || 0);
  const naTarget = parseFloat(document.getElementById('na-target')?.value || 0);
  const alTarget = parseFloat(document.getElementById('al-target')?.value || 0);
  
  // Obtener propiedades del suelo
  const soilDensity = parseFloat(document.getElementById('soil-density')?.value || 1.4);
  const soilDepth = parseFloat(document.getElementById('soil-depth')?.value || 30);
  
  // Obtener enmiendas seleccionadas
  const selectedAmendments = getSelectedAmendments();
  console.log('üîç DEBUGGING: Enmiendas seleccionadas:', selectedAmendments);
  
  // Verificar que hay enmiendas seleccionadas
  if (selectedAmendments.length === 0) {
    console.log('No hay enmiendas seleccionadas');
    alert('Por favor selecciona al menos una enmienda antes de calcular');
    return;
  }
  
  // Validaci√≥n removida - el usuario puede ajustar libremente los valores objetivo
  
  
  // Los valores objetivo son los meq de ajuste necesarios (ya calculados)
  const kDiff = kTarget;  // Meq de ajuste para K
  const caDiff = caTarget; // Meq de ajuste para Ca
  const mgDiff = mgTarget; // Meq de ajuste para Mg
  const hDiff = hTarget;   // Meq de ajuste para H
  const naDiff = naTarget; // Meq de ajuste para Na
  const alDiff = alTarget; // Meq de ajuste para Al
  
  console.log('üîç VALORES DE LOS CAMPOS (meq a ajustar):');
  console.log(`  - kTarget: ${kTarget}`);
  console.log(`  - caTarget: ${caTarget}`);
  console.log(`  - mgTarget: ${mgTarget}`);
  console.log(`  - hTarget: ${hTarget}`);
  console.log(`  - naTarget: ${naTarget}`);
  console.log(`  - alTarget: ${alTarget}`);
  
  
  // Convertir a meq/kg
  const kMeqKg = kDiff * 10;
  const caMeqKg = caDiff * 10;
  const mgMeqKg = mgDiff * 10;
  const hMeqKg = hDiff * 10;
  const naMeqKg = naDiff * 10;
  const alMeqKg = alDiff * 10;
  
  // Convertir a ppm (mg/kg)
  const kPpm = kMeqKg * 39.1; // Peso at√≥mico del K
  const caPpm = caMeqKg * 20.04; // Peso at√≥mico del Ca
  const mgPpm = mgMeqKg * 12.15; // Peso at√≥mico del Mg
  const hPpm = hMeqKg * 1.008; // Peso at√≥mico del H
  const naPpm = naMeqKg * 23; // Peso at√≥mico del Na
  const alPpm = alMeqKg * 8.99; // Peso at√≥mico del Al
  
  // Calcular volumen de suelo por hect√°rea (m¬≥)
  const soilVolume = soilDepth / 100; // m¬≥ por m¬≤
  const soilVolumeHa = soilVolume * 10000; // m¬≥ por hect√°rea
  
  // Calcular peso del suelo por hect√°rea (kg)
  const soilWeightHa = soilVolumeHa * soilDensity * 1000; // kg/ha
  
  // Calcular kg/ha de cada elemento
  const kKgHa = (kPpm * soilWeightHa) / 1000000;
  const caKgHa = (caPpm * soilWeightHa) / 1000000;
  const mgKgHa = (mgPpm * soilWeightHa) / 1000000;
  const hKgHa = (hPpm * soilWeightHa) / 1000000;
  const naKgHa = (naPpm * soilWeightHa) / 1000000;
  const alKgHa = (alPpm * soilWeightHa) / 1000000;
  
  // Calcular necesidades totales (en meq, no en kg/ha)
  const totalCaNeeded = caDiff > 0 ? Math.abs(caDiff) : 0;
  const totalMgNeeded = mgDiff > 0 ? Math.abs(mgDiff) : 0;
  const totalKNeeded = kDiff > 0 ? Math.abs(kDiff) : 0;
  const totalNaToRemove = naDiff < 0 ? Math.abs(naDiff) : 0;
  
  console.log('üîç C√ÅLCULO DE NECESIDADES TOTALES:');
  console.log(`  - totalCaNeeded: ${totalCaNeeded} (de caDiff: ${caDiff})`);
  console.log(`  - totalMgNeeded: ${totalMgNeeded} (de mgDiff: ${mgDiff})`);
  console.log(`  - totalKNeeded: ${totalKNeeded} (de kDiff: ${kDiff})`);
  
  // Calcular aportes de todas las enmiendas seleccionadas
  let totalCaContribution = 0;
  let totalMgContribution = 0;
  let totalKContribution = 0;
  let totalSiContribution = 0;
  let totalNaRemoval = 0;
  let amendmentDetails = [];
  
  // NUEVA L√ìGICA INTELIGENTE: Priorizaci√≥n basada en pH y sinergia
  const soilPH = parseFloat(document.getElementById('soil-ph')?.value || 7);
  console.log('üß™ pH del suelo:', soilPH);
  
  // Calcular necesidades restantes despu√©s de cada enmienda
  let caRemaining = totalCaNeeded;
  let mgRemaining = totalMgNeeded;
  let kRemaining = totalKNeeded;
  let so4Needed = totalNaToRemove; // SO‚ÇÑ para desplazar Na‚Å∫
  
  // ALGORITMO INTELIGENTE DE PRIORIZACI√ìN
  const amendmentStrategy = calcularEstrategiaEnmiendas(selectedAmendments, {
    ca: caRemaining,
    mg: mgRemaining,
    k: kRemaining,
    so4: so4Needed,
    pH: soilPH
  });
  
  console.log('üéØ Estrategia calculada:', amendmentStrategy);
  
  
  // FILTRAR ENMIENDAS CON UMBRAL M√çNIMO OPERATIVO (100 kg/ha)
  const umbralMinimoOperativo = 100; // kg/ha
  const estrategiaFiltrada = amendmentStrategy.filter(strategy => {
    if (strategy.dosis >= umbralMinimoOperativo) {
      return true;
    } else {
      console.log(`‚ö†Ô∏è ${strategy.tipo}: ${strategy.dosis.toFixed(2)} kg/ha - Cantidad menor al umbral m√≠nimo (${umbralMinimoOperativo} kg/ha)`);
      return false;
    }
  });
  
  console.log('üéØ Estrategia filtrada (umbral m√≠nimo 100 kg/ha):', estrategiaFiltrada);
  
  estrategiaFiltrada.forEach(strategy => {
    const amendment = selectedAmendments.find(a => a.id === strategy.tipo);
    if (!amendment) return;
    
    // USAR la cantidad calculada por la estrategia inteligente (elemento limitante)
    let amendmentAmount = strategy.dosis;
    
    console.log(`‚úÖ Usando cantidad de estrategia inteligente: ${amendmentAmount.toFixed(2)} kg/ha`);
    console.log(`‚úÖ Elemento limitante: ${strategy.elementoLimitante?.elemento || 'No definido'}`);
    let caContribution = 0;
    let mgContribution = 0;
    let kContribution = 0;
    let so4Contribution = 0;
    let siContribution = 0;
    let naRemoval = 0;
    
    // DIAGN√ìSTICO COMPLETO
    console.log(`üîç DIAGN√ìSTICO COMPLETO para ${amendment.name}:`);
    console.log(`üîç amendment.id:`, amendment.id);
    console.log(`üîç amendment.ca:`, amendment.ca, typeof amendment.ca);
    console.log(`üîç amendment.mg:`, amendment.mg, typeof amendment.mg);
    console.log(`üîç amendment.k:`, amendment.k, typeof amendment.k);
    console.log(`üîç amendment.so4:`, amendment.so4, typeof amendment.so4);
    console.log(`üîç amendment.si:`, amendment.si, typeof amendment.si);
    console.log(`üîç amendment completo:`, amendment);
    
    // Usar valores reales (leer de composition O directamente)
    const caPercent = amendment.composition?.ca || amendment.ca || 0;
    const mgPercent = amendment.composition?.mg || amendment.mg || (amendment.id === 'dolomite' ? 13.2 : amendment.id === 'mgso4-mono' ? 17 : 0);
    const kPercent = amendment.composition?.k || amendment.k || (amendment.id === 'sop-granular' ? 41.5 : 0);
    const so4Percent = amendment.composition?.so4 || amendment.so4 || (amendment.id === 'gypsum' ? 55.8 : amendment.id === 'sop-granular' ? 54.1 : amendment.id === 'mgso4-mono' ? 69 : 0);
    const siPercent = amendment.composition?.si || amendment.si || 0;
    
    caContribution = amendmentAmount * (caPercent / 100);
    mgContribution = amendmentAmount * (mgPercent / 100);
    kContribution = amendmentAmount * (kPercent / 100);
    so4Contribution = amendmentAmount * (so4Percent / 100);
    siContribution = amendmentAmount * (siPercent / 100);
    
    console.log(`üßÆ Aportes calculados:`, {
      ca: `${caPercent}% ‚Üí ${caContribution.toFixed(2)} kg/ha`,
      mg: `${mgPercent}% ‚Üí ${mgContribution.toFixed(2)} kg/ha`,
      k: `${kPercent}% ‚Üí ${kContribution.toFixed(2)} kg/ha`,
      so4: `${so4Percent}% ‚Üí ${so4Contribution.toFixed(2)} kg/ha`,
      si: `${siPercent}% ‚Üí ${siContribution.toFixed(2)} kg/ha`
    });
    // El switch ya no es necesario - todos usan la misma l√≥gica
    
    // Acumular contribuciones
    totalCaContribution += caContribution;
    totalMgContribution += mgContribution;
    totalKContribution += kContribution;
    totalSiContribution += siContribution;
    totalNaRemoval += naRemoval;
    
    // Guardar detalles de esta enmienda
    if (amendmentAmount > 0) {
      amendmentDetails.push({
        name: amendment.name,
        amount: amendmentAmount,
        ca: caContribution,
        mg: mgContribution,
        k: kContribution,
        so4: so4Contribution,
        si: siContribution,
        naRemoval: naRemoval,
        razon: strategy.razon,
        elementoLimitante: strategy.elementoLimitante,
        advertencia: strategy.advertencia || false
      });
    }
  });
  
  // Mostrar resultados combinados
  showCombinedAmendmentResults(amendmentDetails, totalCaContribution, totalMgContribution, totalKContribution, totalSiContribution, totalNaRemoval);
}

function showCombinedAmendmentResults(amendmentDetails, totalCa, totalMg, totalK, totalSi, totalNaRemoval) {
  const resultsSection = document.getElementById('amendment-results');
  if (!resultsSection) {
    console.error('No se encontr√≥ la secci√≥n amendment-results');
    return;
  }

  // Cache de resultados base (sin ajuste) para recalcular sin ejecutar todo el c√°lculo
  window.lastAmendmentCalc = {
    details: Array.isArray(amendmentDetails) ? amendmentDetails : [],
    totals: { totalCa, totalMg, totalK, totalSi, totalNaRemoval }
  };
  try {
    if (currentProject && currentProject.amendments && currentProject.amendments.results) {
      currentProject.amendments.results.rawDetails = window.lastAmendmentCalc.details;
      currentProject.amendments.results.rawTotals = window.lastAmendmentCalc.totals;
    }
  } catch {}

  const reachPercent = getSoilReachPercent();
  const reachFactor = reachPercent / 100;
  const adjustedDetails = (window.lastAmendmentCalc.details || []).map(item => ({
    ...item,
    amount: (item.amount || 0) * reachFactor,
    ca: (item.ca || 0) * reachFactor,
    mg: (item.mg || 0) * reachFactor,
    k: (item.k || 0) * reachFactor,
    so4: (item.so4 || 0) * reachFactor,
    si: (item.si || 0) * reachFactor,
    naRemoval: (item.naRemoval || 0) * reachFactor
  }));
  
  let html = `
    <div style="position: relative;">
      <h3>üìä Resultados del C√°lculo de Enmiendas</h3>
      <div style="position: absolute; top: -30px; right: 15px; opacity: 0.25; z-index: 1; pointer-events: none;">
        <img src="assets/NutriPlant_PRO_blue.png" alt="NutriPlant PRO" style="width: 160px; height: auto; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));">
      </div>
    </div>
  `;
  
  if (adjustedDetails.length === 0) {
    html += '<p>No se requieren enmiendas con las seleccionadas actuales.</p>';
  } else {
    // Calcular totales reales de todos los nutrientes
    let totalKReal = 0, totalCaReal = 0, totalMgReal = 0, totalSo4Real = 0, totalSiReal = 0;
    
    adjustedDetails.forEach(amendment => {
      totalKReal += amendment.k || 0;
      totalCaReal += amendment.ca || 0;
      totalMgReal += amendment.mg || 0;
      totalSo4Real += amendment.so4 || 0;
      totalSiReal += amendment.si || 0;
    });
    
    html += '<div class="amendment-summary">';
    html += '<h4>üéØ Aportes Totales:</h4>';
    html += '<ul>';
    if (totalKReal > 0) html += `<li><strong>Potasio (K‚Å∫):</strong> ${formatNumber(totalKReal)} kg/ha</li>`;
    if (totalCaReal > 0) html += `<li><strong>Calcio (Ca¬≤‚Å∫):</strong> ${formatNumber(totalCaReal)} kg/ha</li>`;
    if (totalMgReal > 0) html += `<li><strong>Magnesio (Mg¬≤‚Å∫):</strong> ${formatNumber(totalMgReal)} kg/ha</li>`;
    if (totalSo4Real > 0) html += `<li><strong>Sulfato (SO‚ÇÑ¬≤‚Åª):</strong> ${formatNumber(totalSo4Real)} kg/ha</li>`;
    if (totalSiReal > 0) html += `<li><strong>Silicio (Si):</strong> ${formatNumber(totalSiReal)} kg/ha</li>`;
    html += '</ul>';
    html += `<div style="font-size: 12px; color: #64748b; margin-top: 6px;">% del volumen de suelo explorado por ra√≠ces (${formatNumber(reachPercent, 0)}%).</div>`;
    html += '</div>';
    
    html += '<div class="amendment-details">';
    html += '<h4>üìã Detalles por Enmienda:</h4>';
    html += '<table class="results-table">';
    html += '<thead><tr><th>Enmienda</th><th>Cantidad (kg/ha)</th><th>K‚Å∫ (kg/ha)</th><th>Ca¬≤‚Å∫ (kg/ha)</th><th>Mg¬≤‚Å∫ (kg/ha)</th><th>SO‚ÇÑ¬≤‚Åª (kg/ha)</th><th>Si (kg/ha)</th></tr></thead>';
    html += '<tbody>';
    
    adjustedDetails.forEach(amendment => {
      html += '<tr>';
      if (amendment.advertencia) {
        html += `<td style="color: #dc2626; font-weight: bold;">‚ö†Ô∏è ${amendment.name}</td>`;
      } else {
      html += `<td>${amendment.name}</td>`;
      }
      html += `<td>${formatNumber(amendment.amount)}</td>`;
      html += `<td>${amendment.k > 0 ? formatNumber(amendment.k) : '-'}</td>`;
      html += `<td>${amendment.ca > 0 ? formatNumber(amendment.ca) : '-'}</td>`;
      html += `<td>${amendment.mg > 0 ? formatNumber(amendment.mg) : '-'}</td>`;
      html += `<td>${amendment.so4 > 0 ? formatNumber(amendment.so4) : '-'}</td>`;
      html += `<td>${amendment.si > 0 ? formatNumber(amendment.si) : '-'}</td>`;
      html += '</tr>';
    });
    
    html += '</tbody></table>';
    html += '</div>';
    
  }
  
  resultsSection.innerHTML = html;
  resultsSection.style.display = 'block';
  
  // REMOVIDO: Guardado autom√°tico eliminado
}

function updateAmendmentCalculation() {
  // Si ya hay resultados mostrados, recalcular autom√°ticamente
  const resultsSection = document.getElementById('amendment-results');
  if (resultsSection && resultsSection.style.display !== 'none') {
    calculateAmendment();
  }
  
  // NO recalcular ajustes autom√°ticos cuando cambian las enmiendas
  // Los valores de ajuste deben mantenerse fijos hasta que el usuario los modifique
}

function toggleAmendmentSelection(amendmentId) {
  console.log('üîÑ Alternando selecci√≥n de enmienda:', amendmentId);
  
  const button = document.getElementById(`btn-select-${amendmentId}`);
  if (!button) return;
  
  // Alternar estado
  const isSelected = button.classList.contains('selected');
  
  if (isSelected) {
    // Deseleccionar
    button.classList.remove('selected');
    button.textContent = 'Seleccionar';
    button.style.backgroundColor = '';
    button.style.color = '';
  } else {
    // Seleccionar
    button.classList.add('selected');
    button.textContent = 'Seleccionado';
    button.style.backgroundColor = '#10b981'; // Verde
    button.style.color = 'white';
  }
  
  // REMOVIDO: Guardado autom√°tico eliminado
  
  // REMOVIDO: C√°lculo autom√°tico eliminado - solo calcular cuando se presione el bot√≥n
}

const amendmentsDatabase = [
  {
    id: 'gypsum',
    name: 'Yeso Agr√≠cola',
    formula: 'CaSO‚ÇÑ¬∑2H‚ÇÇO',
    molecularWeight: 172.2,
    ca: 23.3,
    mg: 0,
    k: 0,
    so4: 55.8,
    co3: 0,
    h2o: 20.9,
    type: 'sulfate'
  }

function saveCustomAmendmentsToStorage() {
  try {
    // Obtener userId del usuario actual
    const userId = localStorage.getItem('nutriplant_user_id');
    if (!userId) {
      console.warn('‚ö†Ô∏è No hay usuario logueado - enmiendas no se guardar√°n');
      return;
    }
    
    // Filtrar solo enmiendas personalizadas
    const customAmendments = amendmentsDatabase.filter(a => a.type === 'custom');
    
    // 1Ô∏è‚É£ GUARDAR POR USUARIO (SIEMPRE, aislado por usuario)
    const userKey = `nutriplant_custom_amendments_${userId}`;
    localStorage.setItem(userKey, JSON.stringify(customAmendments));
    console.log(`‚úÖ ${customAmendments.length} enmienda(s) personalizada(s) guardadas para usuario: ${userId}`);
    
    // 2Ô∏è‚É£ TAMBI√âN guardar por proyecto si hay uno activo (opcional, para compatibilidad)
    const projectId = localStorage.getItem('currentProjectId');
    if (projectId) {
      const projectKey = `nutriplant_custom_amendments_${projectId}`;
      localStorage.setItem(projectKey, JSON.stringify(customAmendments));
      console.log(`‚úÖ Tambi√©n guardadas para proyecto: ${projectId}`);
    }
  } catch (error) {
    console.error('‚ùå Error guardando enmiendas personalizadas:', error);
  }
}

function loadCustomAmendmentsFromStorage() {
  try {
    // Obtener userId del usuario actual
    const userId = localStorage.getItem('nutriplant_user_id');
    if (!userId) {
      console.log('‚ÑπÔ∏è No hay usuario logueado - no se cargan enmiendas personalizadas');
      return;
    }
    
    let savedAmendments = null;
    let source = '';
    
    // PRIORIDAD 1: Cargar espec√≠ficas del proyecto si hay uno activo
    const projectId = localStorage.getItem('currentProjectId');
    if (projectId) {
      const projectKey = `nutriplant_custom_amendments_${projectId}`;
      savedAmendments = localStorage.getItem(projectKey);
      if (savedAmendments) {
        source = `proyecto ${projectId}`;
      }
    }
    
    // PRIORIDAD 2: Cargar del usuario si no hay proyecto o no tiene enmiendas
    if (!savedAmendments) {
      const userKey = `nutriplant_custom_amendments_${userId}`;
      savedAmendments = localStorage.getItem(userKey);
      if (savedAmendments) {
        source = `usuario ${userId}`;
      }
    }
    
    if (savedAmendments) {
      const customAmendments = JSON.parse(savedAmendments);
      
      // Eliminar enmiendas personalizadas anteriores del database
      const predefinedOnly = amendmentsDatabase.filter(a => a.type !== 'custom');
      amendmentsDatabase.length = 0;
      amendmentsDatabase.push(...predefinedOnly);
      
      // Agregar las guardadas
      amendmentsDatabase.push(...customAmendments);
      
      console.log(`‚úÖ ${customAmendments.length} enmienda(s) personalizada(s) cargadas desde ${source}`);
    } else {
      console.log('‚ÑπÔ∏è No hay enmiendas personalizadas guardadas para este usuario');
    }
  } catch (error) {
    console.error('‚ùå Error cargando enmiendas personalizadas:', error);
  }
}

function saveAmendmentEditsToStorage(amendmentId, composition) {
  try {
    // Obtener userId del usuario actual
    const userId = localStorage.getItem('nutriplant_user_id');
    if (!userId) {
      console.warn('‚ö†Ô∏è No hay usuario logueado - ediciones no se guardar√°n');
      return;
    }
    
    // 1Ô∏è‚É£ GUARDAR POR USUARIO (SIEMPRE, aislado por usuario)
    const userKey = `nutriplant_amendment_edits_${userId}`;
    let userEdits = {};
    const savedUserEdits = localStorage.getItem(userKey);
    if (savedUserEdits) {
      userEdits = JSON.parse(savedUserEdits);
    }
    userEdits[amendmentId] = composition;
    localStorage.setItem(userKey, JSON.stringify(userEdits));
    console.log(`‚úÖ Edici√≥n de enmienda ${amendmentId} guardada para usuario: ${userId}`);
    
    // 2Ô∏è‚É£ TAMBI√âN guardar por proyecto si hay uno activo (opcional, para compatibilidad)
    const projectId = localStorage.getItem('currentProjectId');
    if (projectId) {
      const projectKey = `nutriplant_amendment_edits_${projectId}`;
      let projectEdits = {};
      const savedProjectEdits = localStorage.getItem(projectKey);
      if (savedProjectEdits) {
        projectEdits = JSON.parse(savedProjectEdits);
      }
      projectEdits[amendmentId] = composition;
      localStorage.setItem(projectKey, JSON.stringify(projectEdits));
      console.log(`‚úÖ Edici√≥n tambi√©n guardada para proyecto: ${projectId}`);
    }
  } catch (error) {
    console.error('‚ùå Error guardando ediciones de enmiendas:', error);
  }
}

function loadAmendmentEditsFromStorage() {
  try {
    // Obtener userId del usuario actual
    const userId = localStorage.getItem('nutriplant_user_id');
    if (!userId) {
      console.log('‚ÑπÔ∏è No hay usuario logueado - no se cargan ediciones de enmiendas');
      return;
    }
    
    let savedEdits = null;
    
    // PRIORIDAD 1: Cargar espec√≠ficas del proyecto si hay uno activo
    const projectId = localStorage.getItem('currentProjectId');
    if (projectId) {
      const projectKey = `nutriplant_amendment_edits_${projectId}`;
      savedEdits = localStorage.getItem(projectKey);
      if (savedEdits) {
        console.log(`üìÇ Cargando ediciones del proyecto: ${projectId}`);
      }
    }
    
    // PRIORIDAD 2: Cargar del usuario si no hay proyecto o no tiene ediciones
    if (!savedEdits) {
      const userKey = `nutriplant_amendment_edits_${userId}`;
      savedEdits = localStorage.getItem(userKey);
      if (savedEdits) {
        console.log(`üìÇ Cargando ediciones del usuario: ${userId}`);
      }
    }
    
    if (savedEdits) {
      const edits = JSON.parse(savedEdits);
      
      // Aplicar ediciones a las enmiendas predefinidas
      Object.keys(edits).forEach(amendmentId => {
        const amendment = amendmentsDatabase.find(a => a.id === amendmentId);
        if (amendment) {
          amendment.composition = edits[amendmentId];
          // Tambi√©n actualizar valores directos
          if (edits[amendmentId].k !== undefined) amendment.k = edits[amendmentId].k;
          if (edits[amendmentId].ca !== undefined) amendment.ca = edits[amendmentId].ca;
          if (edits[amendmentId].mg !== undefined) amendment.mg = edits[amendmentId].mg;
          if (edits[amendmentId].so4 !== undefined) amendment.so4 = edits[amendmentId].so4;
          if (edits[amendmentId].co3 !== undefined) amendment.co3 = edits[amendmentId].co3;
          if (edits[amendmentId].h2o !== undefined) amendment.h2o = edits[amendmentId].h2o;
          if (edits[amendmentId].si !== undefined) amendment.si = edits[amendmentId].si;
        }
      });
      
      console.log(`‚úÖ Ediciones de enmiendas aplicadas`);
    }
  } catch (error) {
    console.error('‚ùå Error cargando ediciones de enmiendas:', error);
  }
}

function loadAmendmentsTable() {
  console.log('=== INICIANDO CARGA DE TABLA ===');
  
  // üìÇ CARGAR ENMIENDAS PERSONALIZADAS Y EDICIONES DESDE LOCALSTORAGE
  loadCustomAmendmentsFromStorage();
  loadAmendmentEditsFromStorage();
  
  const tbody = document.getElementById('amendments-table-body');
  console.log('Elemento tbody:', tbody);
  
  if (!tbody) {
    console.log('‚ùå Tabla de enmiendas no encontrada');
    console.log('Elementos disponibles:', document.querySelectorAll('tbody'));
    return;
  }
  
  console.log('‚úÖ Tabla encontrada, cargando enmiendas...');
  tbody.innerHTML = '';
  
  // Mostrar todas las enmiendas disponibles (incluyendo personalizadas)
  const availableAmendments = amendmentsDatabase;
  console.log('Enmiendas en base de datos:', availableAmendments.length);
  console.log('Base de datos:', amendmentsDatabase);
  
  // 1Ô∏è‚É£ Mostrar las enmiendas predefinidas primero
  const predefinedAmendments = amendmentsDatabase.filter(amendment => 
    ['gypsum', 'lime', 'dolomite', 'sop-granular', 'mgso4-mono'].includes(amendment.id)
  );
  
  console.log('Enmiendas predefinidas encontradas:', predefinedAmendments.length);
  console.log('Enmiendas predefinidas:', predefinedAmendments);
  
  predefinedAmendments.forEach((amendment, index) => {
    console.log(`Procesando enmienda ${index + 1}:`, amendment.name);
    const row = document.createElement('tr');
    row.className = 'amendment-row';
    row.innerHTML = `
      <td>${amendment.name}</td>
      <td>${amendment.formula}</td>
      <td>${amendment.molecularWeight}</td>
      <td>${amendment.k > 0 ? amendment.k + '%' : '-'}</td>
      <td>${amendment.ca > 0 ? amendment.ca + '%' : '-'}</td>
      <td>${amendment.mg > 0 ? amendment.mg + '%' : '-'}</td>
      <td>${amendment.so4 > 0 ? amendment.so4 + '%' : '-'}</td>
      <td>${amendment.co3 > 0 ? amendment.co3 + '%' : '-'}</td>
      <td>${amendment.h2o > 0 ? amendment.h2o + '%' : '-'}</td>
      <td>${amendment.si > 0 ? amendment.si + '%' : '-'}</td>
      <td>
        <button class="btn-select-amendment" id="btn-select-${amendment.id}" onclick="toggleAmendmentSelection('${amendment.id}')">
          Seleccionar
        </button>
        <button class="btn-edit-amendment" onclick="editAmendment('${amendment.id}')" title="Editar composici√≥n">
          ‚úèÔ∏è
        </button>
      </td>
    `;
    tbody.appendChild(row);
  });
  
  // Mostrar enmiendas personalizadas
  const customAmendments = amendmentsDatabase.filter(amendment => amendment.type === 'custom');
  console.log(`üìã Enmiendas personalizadas a mostrar: ${customAmendments.length}`);
  console.log('üìã Enmiendas personalizadas:', customAmendments);
  
  customAmendments.forEach((amendment, index) => {
    console.log(`Procesando enmienda personalizada ${index + 1}:`, amendment.name);
    const row = document.createElement('tr');
    row.className = 'amendment-row';
    row.innerHTML = `
      <td>${amendment.name}</td>
      <td>${amendment.formula}</td>
      <td>${amendment.molecularWeight}</td>
      <td>${amendment.k > 0 ? amendment.k + '%' : '-'}</td>
      <td>${amendment.ca > 0 ? amendment.ca + '%' : '-'}</td>
      <td>${amendment.mg > 0 ? amendment.mg + '%' : '-'}</td>
      <td>${amendment.so4 > 0 ? amendment.so4 + '%' : '-'}</td>
      <td>${amendment.co3 > 0 ? amendment.co3 + '%' : '-'}</td>
      <td>${amendment.h2o > 0 ? amendment.h2o + '%' : '-'}</td>
      <td>${amendment.si > 0 ? amendment.si + '%' : '-'}</td>
      <td>
        <button id="btn-select-${amendment.id}" class="btn-select-amendment" onclick="toggleAmendmentSelection('${amendment.id}')">
          Seleccionar
        </button>
        <button class="btn-edit-amendment" onclick="editAmendment('${amendment.id}')" title="Editar composici√≥n">
          ‚úèÔ∏è
        </button>
        <button class="btn-delete-amendment-small" onclick="deleteAmendment('${amendment.id}')" title="Eliminar enmienda personalizada">
          üóëÔ∏è
        </button>
      </td>
    `;
    tbody.appendChild(row);
  });
  
  // Agregar fila en blanco para nueva enmienda
  const newRow = document.createElement('tr');
  newRow.id = 'new-amendment-row';
  newRow.innerHTML = `
    <td><input type="text" id="new-amendment-name" placeholder="Nombre de la enmienda" class="amendment-input"></td>
    <td><input type="text" id="new-amendment-formula" placeholder="F√≥rmula qu√≠mica" class="amendment-input"></td>
    <td><input type="number" id="new-amendment-molecular" placeholder="Peso molecular" class="amendment-input" step="0.01"></td>
    <td><input type="number" id="new-amendment-k" placeholder="%K" class="amendment-input" step="0.01" min="0" max="100"></td>
    <td><input type="number" id="new-amendment-ca" placeholder="%Ca" class="amendment-input" step="0.01" min="0" max="100"></td>
    <td><input type="number" id="new-amendment-mg" placeholder="%Mg" class="amendment-input" step="0.01" min="0" max="100"></td>
    <td><input type="number" id="new-amendment-so4" placeholder="%SO‚ÇÑ" class="amendment-input" step="0.01" min="0" max="100"></td>
    <td><input type="number" id="new-amendment-co3" placeholder="%CO‚ÇÉ" class="amendment-input" step="0.01" min="0" max="100"></td>
    <td><input type="number" id="new-amendment-h2o" placeholder="%H‚ÇÇO" class="amendment-input" step="0.01" min="0" max="100"></td>
    <td><input type="number" id="new-amendment-si" placeholder="%Si" class="amendment-input" step="0.01" min="0" max="100"></td>
    <td>
      <button class="btn-save-amendment-small" onclick="saveNewAmendment()">üíæ</button>
      <button class="btn-cancel-amendment-small" onclick="clearNewAmendmentRow()">‚ùå</button>
    </td>
  `;
  tbody.appendChild(newRow);
  
  console.log('=== TABLA CARGADA COMPLETAMENTE ===');
  console.log('Total de filas en tbody:', tbody.children.length);
}

function updateSelectionIndicator() {
  const count = selectedAmendments.length;
  console.log(`Enmiendas seleccionadas: ${count}`);
  
  // Actualizar el t√≠tulo de la secci√≥n
  const sectionTitle = document.querySelector('.amendments-section h3');
  if (sectionTitle) {
    if (count > 0) {
      sectionTitle.innerHTML = `üß™ Enmiendas Disponibles <span class="selection-count">(${count} seleccionada${count > 1 ? 's' : ''})</span>`;
    } else {
      sectionTitle.innerHTML = 'üß™ Enmiendas Disponibles';
    }
  }
}

function saveNewAmendment() {
  const name = document.getElementById('new-amendment-name').value.trim();
  const formula = document.getElementById('new-amendment-formula').value.trim();
  const molecularWeight = parseFloat(document.getElementById('new-amendment-molecular').value);
  
  if (!name || !formula || isNaN(molecularWeight)) {
    showMessage('‚ùå Por favor completa al menos: Nombre, F√≥rmula y Peso Molecular', 'error');
    return;
  }
  
  const ca = parseFloat(document.getElementById('new-amendment-ca').value) || 0;
  const mg = parseFloat(document.getElementById('new-amendment-mg').value) || 0;
  const k = parseFloat(document.getElementById('new-amendment-k').value) || 0;
  const so4 = parseFloat(document.getElementById('new-amendment-so4').value) || 0;
  const co3 = parseFloat(document.getElementById('new-amendment-co3').value) || 0;
  const h2o = parseFloat(document.getElementById('new-amendment-h2o').value) || 0;
  const si = parseFloat(document.getElementById('new-amendment-si').value) || 0;
  
  const newAmendment = {
    id: 'custom-' + Date.now(),
    name: name,
    formula: formula,
    molecularWeight: molecularWeight,
    ca: ca,
    mg: mg,
    k: k,
    so4: so4,
    co3: co3,
    h2o: h2o,
    si: si,
    type: 'custom'
  };
  
  amendmentsDatabase.push(newAmendment);
  
  // üíæ GUARDAR EN LOCALSTORAGE (por proyecto)
  saveCustomAmendmentsToStorage();
  
  // Agregar la nueva enmienda al selector
  const select = document.getElementById('amendment-type-select');
  if (select) {
    const option = document.createElement('option');
    option.value = newAmendment.id;
    option.textContent = `${newAmendment.name} (${newAmendment.formula})`;
    select.appendChild(option);
  }
  
  // Limpiar los campos de la fila en blanco
  clearNewAmendmentRow();
  
  // Recargar la tabla
  loadAmendmentsTable();
  showMessage(`‚úÖ Enmienda "${name}" guardada exitosamente`, 'success');
  console.log('‚úÖ Enmienda personalizada guardada en localStorage');
}

function clearNewAmendmentRow() {
  document.getElementById('new-amendment-name').value = '';
  document.getElementById('new-amendment-formula').value = '';
  document.getElementById('new-amendment-molecular').value = '';
  document.getElementById('new-amendment-ca').value = '';
  document.getElementById('new-amendment-mg').value = '';
  document.getElementById('new-amendment-k').value = '';
  document.getElementById('new-amendment-so4').value = '';
  document.getElementById('new-amendment-co3').value = '';
  document.getElementById('new-amendment-h2o').value = '';
  document.getElementById('new-amendment-si').value = '';
}

function deleteAmendment(amendmentId) {
  const amendment = amendmentsDatabase.find(a => a.id === amendmentId);
  if (!amendment || amendment.type !== 'custom') {
    showMessage('‚ùå Solo se pueden eliminar enmiendas personalizadas', 'error');
    return;
  }
  
  if (confirm(`¬øEst√°s seguro de que quieres eliminar "${amendment.name}"?`)) {
    // Eliminar de la base de datos
    const index = amendmentsDatabase.findIndex(a => a.id === amendmentId);
    amendmentsDatabase.splice(index, 1);
    
    // üíæ GUARDAR EN LOCALSTORAGE
    saveCustomAmendmentsToStorage();
    
    // Eliminar del selector
    const select = document.getElementById('amendment-type-select');
    if (select) {
      const option = select.querySelector(`option[value="${amendmentId}"]`);
      if (option) {
        option.remove();
      }
    }
    
    // Recargar la tabla
    loadAmendmentsTable();
    showMessage(`‚úÖ Enmienda "${amendment.name}" eliminada`, 'success');
    console.log('‚úÖ Enmienda personalizada eliminada de localStorage');
  }
}

function saveAmendmentEditsToStorage(amendmentId, composition) {
  try {
    // Obtener userId del usuario actual
    const userId = localStorage.getItem('nutriplant_user_id');
    if (!userId) {
      console.warn('‚ö†Ô∏è No hay usuario logueado - ediciones no se guardar√°n');
      return;
    }
    
    // 1Ô∏è‚É£ GUARDAR POR USUARIO (SIEMPRE, aislado por usuario)
    const userKey = `nutriplant_amendment_edits_${userId}`;
    let userEdits = {};
    const savedUserEdits = localStorage.getItem(userKey);
    if (savedUserEdits) {
      userEdits = JSON.parse(savedUserEdits);
    }
    userEdits[amendmentId] = composition;
    localStorage.setItem(userKey, JSON.stringify(userEdits));
    console.log(`‚úÖ Edici√≥n de enmienda ${amendmentId} guardada para usuario: ${userId}`);
    
    // 2Ô∏è‚É£ TAMBI√âN guardar por proyecto si hay uno activo (opcional, para compatibilidad)
    const projectId = localStorage.getItem('currentProjectId');
    if (projectId) {
      const projectKey = `nutriplant_amendment_edits_${projectId}`;
      let projectEdits = {};
      const savedProjectEdits = localStorage.getItem(projectKey);
      if (savedProjectEdits) {
        projectEdits = JSON.parse(savedProjectEdits);
      }
      projectEdits[amendmentId] = composition;
      localStorage.setItem(projectKey, JSON.stringify(projectEdits));
      console.log(`‚úÖ Edici√≥n tambi√©n guardada para proyecto: ${projectId}`);
    }
  } catch (error) {
    console.error('‚ùå Error guardando ediciones de enmiendas:', error);
  }
}

function getSelectedAmendments() {
  console.log('üîç getSelectedAmendments - INICIANDO');
  const selected = [];
  const selectedButtons = document.querySelectorAll('.btn-select-amendment.selected');
  
  console.log(`üîç Botones seleccionados encontrados: ${selectedButtons.length}`);
  
  selectedButtons.forEach(button => {
    const amendmentId = button.id.replace('btn-select-', '');
    console.log(`üîç Procesando enmienda ID: ${amendmentId}`);
    
    // LEER VALORES REALES DE LA TABLA DOM (como las enmiendas nuevas)
    const row = button.closest('tr');
    if (row) {
      const cells = row.querySelectorAll('td');
      if (cells.length >= 8) {
        const name = cells[0].textContent.trim();
        const formula = cells[1].textContent.trim();
        const molecularWeight = parseFloat(cells[2].textContent.trim()) || 0;
        const k = cells[3].textContent.trim() === '-' ? 0 : parseFloat(cells[3].textContent.trim()) || 0;
        const ca = cells[4].textContent.trim() === '-' ? 0 : parseFloat(cells[4].textContent.trim()) || 0;
        const mg = cells[5].textContent.trim() === '-' ? 0 : parseFloat(cells[5].textContent.trim()) || 0;
        const so4 = cells[6].textContent.trim() === '-' ? 0 : parseFloat(cells[6].textContent.trim()) || 0;
        const co3 = cells[7].textContent.trim() === '-' ? 0 : parseFloat(cells[7].textContent.trim()) || 0;
        const h2o = cells[8]?.textContent.trim() === '-' ? 0 : parseFloat(cells[8]?.textContent.trim()) || 0;
        const si = cells[9]?.textContent.trim() === '-' ? 0 : parseFloat(cells[9]?.textContent.trim()) || 0;
        
        console.log(`üîç Enmienda encontrada: ${name}`);
        console.log(`üîç Valores REALES de la tabla:`, {
          ca: ca,
          mg: mg,
          k: k,
          so4: so4,
          co3: co3,
          h2o: h2o,
          si: si
        });
        console.log(`üîç Texto completo de la celda Ca: "${cells[4].textContent}"`);
        console.log(`üîç Texto despu√©s de trim: "${cells[4].textContent.trim()}"`);
        console.log(`üîç Valor parseFloat: ${parseFloat(cells[4].textContent.trim())}`);
        
      selected.push({
        id: amendmentId,
          name: name,
          formula: formula,
          molecularWeight: molecularWeight,
        composition: {
            k: k,
            ca: ca,
            mg: mg,
            so4: so4,
            co3: co3,
            h2o: h2o,
            si: si
          }
        });
      }
    } else {
      console.warn(`‚ùå No se pudo encontrar la fila para ${amendmentId}`);
    }
  });
  
  console.log(`üîç Enmiendas seleccionadas finales:`, selected);
  return selected;
}

window.showMessage = function(message, type = 'success') {
  // Crear elemento de mensaje
  const messageDiv = document.createElement('div');
  messageDiv.className = `save-message save-message-${type}`;
  messageDiv.textContent = message;
  
  // Estilos seg√∫n el tipo
  const bgColor = type === 'success' ? '#10b981' : type === 'warning' ? '#f59e0b' : type === 'error' ? '#ef4444' : '#3b82f6';
  
  messageDiv.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: ${bgColor};
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 10000;
    font-weight: 500;
    animation: slideIn 0.3s ease;
    max-width: 400px;
  `;
  
  // Agregar al DOM
  document.body.appendChild(messageDiv);
  
  // Remover despu√©s de 3 segundos
  setTimeout(() => {
    messageDiv.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => {
      if (messageDiv.parentNode) {
        messageDiv.parentNode.removeChild(messageDiv);
      }
    }, 300);
  }, 3000);
}

// Inicializaci√≥n standalone
document.addEventListener('DOMContentLoaded', () => {
  try { loadAmendmentsTable(); } catch (e) { console.warn('loadAmendmentsTable', e); }
  try { initializeEnmiendaCalculator(); } catch (e) { console.warn('initializeEnmiendaCalculator', e); }
  try { calculateCIC(); } catch (e) { console.warn('calculateCIC', e); }
  try { updatePHIndicator(); } catch (e) { console.warn('updatePHIndicator', e); }
});
</script>
</body>
</html>
